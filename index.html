
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geometric M√∂bius Shell Sieve</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1f3a;--bg2:#252d4a;--acc:#0084d1;--acc2:#ff4081;--acc3:#26c485;--txt:#fff;--txt2:#b0b8d8;--plot:rgba(10,14,39,0.8)}
body.light{--bg:#f5f7fa;--bg2:#fff;--acc:#0066cc;--acc2:#d32f2f;--acc3:#388e3c;--txt:#1a1a1a;--txt2:#4a5568;--plot:rgba(245,247,250,0.95)}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,var(--bg),#1a2a4a);color:var(--txt);line-height:1.6}
header{background:var(--bg2);border-bottom:2px solid var(--acc);padding:1rem 2rem}
h1{font-size:1.8rem;color:var(--acc)}
.hdr{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.container{max-width:1800px;margin:0 auto;padding:0 1rem 2rem}
.snav{background:var(--bg2);padding:1rem;border-radius:8px;margin-bottom:1.5rem;display:flex;gap:.5rem;flex-wrap:wrap}
.nbtn{background:rgba(0,217,255,.1);color:var(--acc);border:2px solid var(--acc);padding:.7rem 1.2rem;border-radius:4px;cursor:pointer;font-weight:600;font-size:.95rem}
.nbtn:hover,.nbtn.active{background:var(--acc);color:var(--bg)}
.sec{display:none}.sec.active{display:block}
.tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;border-bottom:2px solid rgba(0,217,255,.2);flex-wrap:wrap}
.tbtn{background:transparent;color:var(--txt2);border:none;padding:.7rem 1.2rem;cursor:pointer;font-size:.95rem;border-bottom:3px solid transparent}
.tbtn:hover{color:var(--acc)}.tbtn.active{color:var(--acc);border-bottom-color:var(--acc)}
.tab{display:none}.tab.active{display:block}
.ctrl{background:var(--bg2);padding:1rem;border-radius:8px;margin-bottom:1rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.8rem}
.cg{display:flex;flex-direction:column}
.cg label{color:var(--acc);margin-bottom:.3rem;font-weight:600;font-size:.85rem;display:flex;align-items:center;gap:.3rem}
.tip{width:16px;height:16px;background:var(--acc);color:var(--bg);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:bold;cursor:help}
.cg input,.cg select{background:var(--bg);color:var(--txt);border:2px solid var(--acc);padding:.5rem;border-radius:4px}
.sig{display:flex;gap:.4rem;align-items:center}
.sig input[type="range"]{flex:1}.sig input[type="number"]{width:70px}
button{background:var(--acc2);color:#fff;border:none;padding:.6rem 1rem;border-radius:4px;cursor:pointer;font-weight:600;margin-right:.4rem;margin-bottom:.5rem}
button:hover{background:var(--acc)}
button.s{background:var(--acc3);color:#000}
.bg{display:flex;flex-wrap:wrap;margin-bottom:1rem}
.viz{background:var(--bg2);border-radius:8px;padding:1rem;margin-bottom:1rem;border:1px solid rgba(0,217,255,.2)}
.viz h3{color:var(--acc);margin-bottom:.8rem;font-size:1.1rem}
canvas{display:block;border:2px solid var(--acc);border-radius:6px;width:100%;max-width:800px;height:auto;margin:0 auto .8rem;cursor:crosshair}
.pc{width:100%;height:400px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:1200px){.g2{grid-template-columns:1fr}}
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:.5rem;margin-top:.5rem}
.sb{background:rgba(0,217,255,.1);border:1px solid var(--acc);padding:.5rem;border-radius:4px;text-align:center}
.sl{color:var(--txt2);font-size:.75rem}.sv{color:var(--acc);font-size:1.1rem;font-weight:700;font-family:monospace}
table{width:100%;border-collapse:collapse;font-size:.85rem;margin-top:.8rem}
th,td{padding:.5rem;text-align:left;border-bottom:1px solid rgba(0,217,255,.2)}
th{color:var(--acc);background:rgba(0,217,255,.1)}
.al{background:rgba(0,217,255,.05);padding:.8rem;border-radius:4px;margin-top:.8rem;border:1px solid rgba(0,217,255,.2)}
.al h4{color:var(--acc);margin-bottom:.5rem;font-size:.95rem}
.lg{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem}
.li{background:var(--bg);padding:.5rem;border-radius:4px;border-left:4px solid var(--acc);font-size:.75rem}
.li strong{color:var(--acc);display:block}.li .v{color:var(--txt2);font-family:monospace}
.ts{background:var(--bg2);padding:2rem;border-radius:8px;margin-bottom:1.5rem;border-left:4px solid var(--acc2)}
.ts h2{color:var(--acc);margin:1.5rem 0 1rem;font-size:1.5rem}.ts h2:first-child{margin-top:0}
.ts h3{color:var(--acc2);margin:1rem 0 .5rem;font-size:1.2rem}
.ts p,.ts li{color:var(--txt2);margin-bottom:.8rem;line-height:1.8}
.ts ul{margin-left:2rem}
.fm{background:rgba(0,0,0,.4);padding:1rem;font-family:monospace;margin:1rem 0;border-left:3px solid var(--acc2);border-radius:4px;overflow-x:auto}
body.light .fm{background:rgba(0,0,0,.08)}
.rs{background:var(--bg2);padding:1.5rem;border-radius:8px;margin-bottom:1.5rem;border-left:4px solid var(--acc)}
.rs h3{color:var(--acc);margin-bottom:.8rem;font-size:1.15rem}
.rs h4{color:var(--acc2);margin:1rem 0 .5rem}
.rs p,.rs li{color:var(--txt2);margin-bottom:.6rem;line-height:1.7}
.rs ul,.rs ol{margin-left:1.5rem}
.fb{background:rgba(0,217,255,.08);padding:1rem;border-radius:4px;margin:.8rem 0;border:1px solid rgba(0,217,255,.3);border-left:4px solid var(--acc2)}
.fb strong{color:var(--acc)}
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.mc{background:var(--bg2);padding:2rem;border:2px solid var(--acc);border-radius:8px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
.mc h2{color:var(--acc);margin-bottom:1rem}
.ds{background:rgba(0,217,255,.1);padding:1rem;border-radius:4px;margin:.5rem 0;border-left:3px solid var(--acc)}
.dr{display:flex;justify-content:space-between;padding:.3rem 0;font-family:monospace}
.dl{color:var(--acc2);font-weight:600}.dv{color:var(--acc);font-weight:700}
.mx{color:var(--acc);float:right;font-size:2rem;cursor:pointer}
.prec{display:flex;align-items:center;gap:.5rem}
.prec label{color:var(--acc);font-weight:600}
.prec select{background:var(--bg);color:var(--acc);border:1px solid var(--acc);padding:.4rem}
.thm{background:var(--bg2);color:var(--acc);border:2px solid var(--acc);padding:.6rem .9rem;border-radius:4px;font-size:1.2rem;cursor:pointer;min-width:44px}
footer{text-align:center;padding:2rem;color:var(--txt2);border-top:1px solid rgba(0,217,255,.2);margin-top:2rem}
</style>
</head>
<body>
<header>
<div class="hdr">
<h1>Geometric M√∂bius Shell Sieve: Complete Research Platform</h1>
<div style="display:flex;gap:1rem;align-items:center">
<button class="thm" onclick="toggleTheme()" title="Toggle Theme" id="thm">D</button>
<div class="prec"><label>Precision:</label><select id="prec" onchange="P=+this.value">
<option value="2">2</option><option value="4" selected>4</option><option value="6">6</option><option value="8">8</option><option value="10">10</option><option value="12">12</option><option value="14">14</option><option value="16">16</option>
</select></div>
</div>
</div>
</header>
<div class="container">
<div class="snav">
<button class="nbtn active" onclick="showSec('theory',this)">Theory</button>
<button class="nbtn" onclick="showSec('tools',this)">Interactive Tools</button>
<button class="nbtn" onclick="showSec('ref',this)">Reference</button>
</div>

<div id="theory" class="sec active">
<div class="ts">
<h2>Geometric M√∂bius Shell Sieve for Primitive Lattice Points</h2>
<h3>Introduction</h3>
<p>The problem of counting primitive lattice points (points with gcd = 1) in a scaled convex body is fundamental in analytic number theory. This platform presents the Geometric M√∂bius Shell Sieve‚Äîa dimension-universal approach that reveals the sieve mechanism geometrically through multi-scale decomposition.</p>
<h3>Main Theorem</h3>
<div class="fm">N_K(R) = [Vol(K) / Œ∂(n)] ¬∑ R^n + O(R^(n-1))</div>
<p>For n ‚â• 3 and K a bounded convex body with piecewise C¬π boundary:</p>
<ul>
<li><strong>N_K(R):</strong> Count of primitive lattice points in RK</li>
<li><strong>Vol(K):</strong> Volume of the convex body K</li>
<li><strong>Œ∂(n):</strong> Riemann zeta function at n</li>
<li><strong>R^n:</strong> Scaling factor (volume order)</li>
<li><strong>O(R^(n-1)):</strong> Error term (surface area order)</li>
</ul>
<h3>M√∂bius Decomposition</h3>
<div class="fm">N_K(R) = Œ£_{k=1}^‚àû Œº(k) ¬∑ L_K(R/k)</div>
<p>The core identity uses inclusion-exclusion via the M√∂bius function:</p>
<ul>
<li>Œº(k) provides alternating signs for sieve layers</li>
<li>L_K(r) counts all lattice points in ball of radius r</li>
<li>Each divisor k defines a shell at scale R/k</li>
<li>M√∂bius signs cancel non-primitive contributions exactly (in volume)</li>
</ul>
<h3>Volume Contribution (Exact)</h3>
<div class="fm">Œ£_{k=1}^‚àû Œº(k) ¬∑ Vol(K_{R/k}) = [Vol(K) / Œ∂(n)] ¬∑ R^n</div>
<p>This remarkable identity follows from the Dirichlet series: Œ£ Œº(k)/k^n = 1/Œ∂(n).</p>
<h3>Primitive Density: 1/Œ∂(n)</h3>
<div class="fm">P_n = 1 / Œ∂(n) = probability that random n-tuple is primitive</div>
<ul>
<li>n=2 (pairs): 1/Œ∂(2) ‚âà 0.60793 (‚âà61% of integer pairs coprime)</li>
<li>n=3 (triples): 1/Œ∂(3) ‚âà 0.83191 (‚âà83% coprime)</li>
<li>n=4: 1/Œ∂(4) ‚âà 0.92391 (‚âà92% coprime)</li>
<li>n=5: 1/Œ∂(5) ‚âà 0.96449 (‚âà96% coprime)</li>
<li>n=6: 1/Œ∂(6) ‚âà 0.98296 (‚âà98% coprime)</li>
<li>n=7: 1/Œ∂(7) ‚âà 0.99171 (‚âà99% coprime)</li>
</ul>
<h3>Error Term Analysis</h3>
<div class="fm">|Error| = O(R^(n-1))</div>
<p>The error arises entirely from lattice points clustered near boundaries. As dimension increases, error becomes negligible for large R.</p>
<h3>Key Insights</h3>
<ul>
<li><strong>Œ∂(n)^(-1) Density:</strong> The inverse zeta function emerges as the natural density of primitive integers.</li>
<li><strong>Shape Independence:</strong> The leading term depends only on Vol(K) and Œ∂(n), not boundary details.</li>
<li><strong>Multi-Scale Sieve:</strong> The M√∂bius cts as a geometric filter.</li>
<li><strong>Dimension Universal:</strong> The formula holds for all dimensions n ‚â• 3.</li>
<li><strong>GCD Multiplication Table:</strong> The 2D lattice within a circle is fundamentally a bounded GCD multiplication table. Each point (x,y) represents an entry where gcd(x,y) determines the "cell value". The primitive points (GCD=1) correspond to coprime pairs‚Äîthe units in the multiplicative structure.</li>
<li><strong>Four-Quadrant Symmetry:</strong> The lattice exhibits 4-fold rotational symmetry, mirroring the structure of modular arithmetic tables when viewed as rings.</li>
</ul>
<h3>Riemann Zeta Function Reference</h3>
<table><tr><th>n</th><th>Œ∂(n)</th><th>Œ∂(n)^(-1)</th><th>Interpretation</th></tr>
<tr><td>2</td><td>œÄ¬≤/6 ‚âà 1.6449</td><td>‚âà 0.6079</td><td>‚âà61% of integer pairs coprime</td></tr>
<tr><td>3</td><td>‚âà 1.2021</td><td>‚âà 0.8319</td><td>‚âà83% of triples coprime</td></tr>
<tr><td>4</td><td>œÄ‚Å¥/90 ‚âà 1.0823</td><td>‚âà 0.9239</td><td>‚âà92% of 4-tuples coprime</td></tr></table>
<h3>M√∂bius Function Œº(n)</h3>
<ul>
<li>Œº(1) = 1 (base case)</li>
<li>Œº(n) = 0 if n has a squared prime factor</li>
<li>Œº(n) = (-1)^k if n is product of k distinct primes</li>
</ul>
<p>Examples: Œº(2) = -1, Œº(3) = -1, Œº(4) = 0, Œº(6) = 1, Œº(30) = -1</p>
<h3>Connections to Deep Mathematics</h3>
<ul>
<li><strong>Diophantine Approximation:</strong> Farey sequences and continued fractions</li>
<li><strong>Analytic Number Theory:</strong> Dirichlet series and Euler products</li>
<li><strong>Geometry of Numbers:</strong> Minkowski's theory of lattices</li>
<li><strong>Harmonic Analysis:</strong> Fourier analysis on lattices</li>
</ul>
</div>
</div>

<div id="tools" class="sec">
<div class="tabs">
<button class="tbtn active" onclick="showTab('t2d',this)">2D Lattice</button>
<button class="tbtn" onclick="showTab('t3d',this)">3D Ball</button>
<button class="tbtn" onclick="showTab('tmob',this)">M√∂bius Œº(n)</button>
<button class="tbtn" onclick="showTab('tmod',this)">Modular 2œÄr/M</button>
<button class="tbtn" onclick="showTab('tcayley',this)">Cayley ‚Ñç</button>
<button class="tbtn" onclick="showTab('tfarey',this)">Farey</button>
<button class="tbtn" onclick="showTab('tprim',this)">Primitive Roots</button>
<button class="tbtn" onclick="showTab('terr',this)">Error</button>
<button class="tbtn" onclick="showTab('tdim',this)">Dims</button>
<button class="tbtn" onclick="showTab('tsh',this)">Shells</button>
<button class="tbtn" onclick="showTab('tgcd',this)">GCD</button>
<button class="tbtn" onclick="showTab('tgaus',this)">Gaussian</button>
<button class="tbtn" onclick="showTab('tcirc',this)">Circle</button>
<button class="tbtn" onclick="showTab('tdens',this)">Density 1/Œ∂</button>
<button class="tbtn" onclick="showTab('tdir',this)">Dirichlet œá</button>
</div>

<div id="t2d" class="tab active">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Scaling parameter">?</span></label><div class="sig"><input type="range" id="r2d" min="1" max="100" step=".5" value="4" oninput="document.getElementById('r2dv').value=this.value;draw2D()"><input type="number" id="r2dv" value="4" min="1" step=".5" onchange="document.getElementById('r2d').value=Math.min(100,this.value);draw2D()"></div></div>
<div class="cg"><label>Shape <span class="tip" title="Circle or square">?</span></label><select id="sh2d" onchange="draw2D()"><option value="circle">Circle</option><option value="square">Square</option><option value="both">Square + Circle</option></select></div>
<div class="cg"><label>Color Scheme <span class="tip" title="Coloring method">?</span></label><select id="col2d" onchange="draw2D()"><option value="gcd">By GCD (Recommended)</option><option value="dist">By Distance</option><option value="prim">Primitive vs Non</option><option value="rainbow">Rainbow (Cyclic)</option><option value="quadres">Quadratic Residues</option><option value="primality">Primality (x¬∑y)</option><option value="moddist">Modular Distance</option><option value="symmetry">Symmetry Pattern</option><option value="heatmap">Heatmap (Density)</option><option value="divisibility">Divisibility</option><option value="discrete">Discrete GCD</option><option value="fire">Fire Gradient</option><option value="plasma">Plasma</option><option value="viridis">Viridis</option><option value="ocean">Ocean</option></select></div>
<div class="cg"><label>Point Labels <span class="tip" title="Label display">?</span></label><select id="lbl2d" onchange="draw2D()"><option value="none">None</option><option value="coords">Coordinates</option><option value="gcd">GCD Values</option></select></div>
<div class="cg"><label>Point Size</label><input type="range" id="ptSz2d" min="0.5" max="10" value="4" step="0.5" onchange="draw2D()"></div>
<div class="cg"><label>Zoom <span class="tip" title="Zoom level">?</span></label><div class="sig"><input type="range" id="zm2d" min=".5" max="3" step=".1" value="1" oninput="draw2D();document.getElementById('zm2dv').textContent=this.value+'x'"><span id="zm2dv" style="color:var(--txt2);min-width:40px">1x</span></div></div>
<div class="cg"><label>Label Size <span class="tip" title="Label font size">?</span></label><div class="sig"><input type="range" id="lblsz2d" min="6" max="16" step="1" value="8" oninput="draw2D();document.getElementById('lblszv').textContent=this.value+'px'"><span id="lblszv" style="color:var(--txt2);min-width:40px">8px</span></div></div>
<div class="cg"><label>Connections <span class="tip" title="Draw lines between related points">?</span></label><select id="conn2d" onchange="draw2D()"><option value="none">None</option><option value="gcd1">GCD=1 Network</option><option value="same">Same GCD</option><option value="radial">Radial from Origin</option><option value="diagonal">Diagonal Lines</option></select></div>
<div class="cg"><label>Line Opacity</label><input type="range" id="connOp2d" min="0.1" max="1" step="0.1" value="0.3" onchange="draw2D()"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Smith Chart Transform</strong> <span class="tip" title="Œì = (z-1)/(z+1) conformal mapping">?</span></label></div>
<div class="cg"><label>Enable Smith Chart</label><input type="checkbox" id="smith2d" onchange="draw2D()"></div>
<div class="cg"><label>Phase Shift Œ±</label><div class="sig"><input type="range" id="smithA2d" min="0" max="360" value="90" oninput="document.getElementById('smithA2dV').textContent=this.value+'¬∞';draw2D()"><span id="smithA2dV" style="color:var(--txt2)">90¬∞</span></div></div>
<div class="cg"><label>Radius Scale</label><select id="smithR2d" onchange="draw2D()"><option value="unit">Unit (R=1)</option><option value="index">By Index</option><option value="dist">By Distance</option></select></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="smithGrid2d" onchange="draw2D()"> Grid</label><label><input type="checkbox" id="smithCircR2d" onchange="draw2D()"> Const-R</label><label><input type="checkbox" id="smithArcX2d" onchange="draw2D()"> Const-X</label></div>
</div>
<div class="bg"><button onclick="screenshot2D()">Screenshot</button><button onclick="exp2D()">PNG Export</button><button class="s" onclick="csv2D()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>2D Lattice Points Visualization (Click any point for details)</h3><canvas id="c2d" width="800" height="800"></canvas><div class="al" id="al2d"></div><div class="sg" id="st2d"></div></div>
<div class="viz"><h3>Live Statistics Dashboard</h3><div id="stats2dLive" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">2D Lattice & Basel Problem Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Coprime Probability:</strong> P(gcd(x,y)=1) = 6/œÄ¬≤ ‚âà 60.79%</div>
<div><strong>Basel Problem:</strong> Œ∂(2) = Œ£1/n¬≤ = œÄ¬≤/6 ‚âà 1.6449</div>
<div><strong>Euler Product:</strong> Œ∂(2) = Œ†(1-p‚Åª¬≤)‚Åª¬π over primes p</div>
<div><strong>Visible Points:</strong> Point (x,y) visible from origin iff gcd(x,y)=1</div>
<div><strong>Asymptotic:</strong> #{primitive in B_R} ~ œÄR¬≤/Œ∂(2) as R‚Üí‚àû</div>
<div><strong>Smith Chart:</strong> w = (1+e^iŒ∏)/(1-e^iŒ∏) = i¬∑cot(Œ∏/2)</div>
</div>
</div>
</div>

<div id="t3d" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Ball radius">?</span></label><div class="sig"><input type="range" id="r3d" min="1" max="30" step=".5" value="4" oninput="document.getElementById('r3dv').value=this.value;draw3D()"><input type="number" id="r3dv" value="4" min="1" step=".5" onchange="document.getElementById('r3d').value=Math.min(30,this.value);draw3D()"></div></div>
<div class="cg"><label>X Rotation <span class="tip" title="Rotation around X axis">?</span></label><div class="sig"><input type="number" id="rotX" value="0" min="0" max="360" step="1" style="width:60px" onchange="rx=this.value*Math.PI/180;draw3D()"><span style="color:var(--txt2)">¬∞</span><input type="range" id="rotXr" min="0" max="360" value="0" oninput="document.getElementById('rotX').value=this.value;rx=this.value*Math.PI/180;draw3D()"></div></div>
<div class="cg"><label>Y Rotation <span class="tip" title="Rotation around Y axis">?</span></label><div class="sig"><input type="number" id="rotY" value="0" min="0" max="360" step="1" style="width:60px" onchange="ry=this.value*Math.PI/180;draw3D()"><span style="color:var(--txt2)">¬∞</span><input type="range" id="rotYr" min="0" max="360" value="0" oninput="document.getElementById('rotY').value=this.value;ry=this.value*Math.PI/180;draw3D()"></div></div>
<div class="cg"><label>Z Rotation <span class="tip" title="Rotation around Z axis">?</span></label><div class="sig"><input type="number" id="rotZ" value="0" min="0" max="360" step="1" style="width:60px" onchange="rz=this.value*Math.PI/180;draw3D()"><span style="color:var(--txt2)">¬∞</span><input type="range" id="rotZr" min="0" max="360" value="0" oninput="document.getElementById('rotZ').value=this.value;rz=this.value*Math.PI/180;draw3D()"></div></div>
<div class="cg"><label>Zoom <span class="tip" title="Zoom level">?</span></label><div class="sig"><input type="range" id="zm3d" min=".2" max="5" step=".1" value="1" oninput="draw3D();document.getElementById('zmv').textContent=this.value+'x'"><span id="zmv" style="color:var(--txt2);min-width:40px">1x</span></div></div>
<div class="cg"><label>Point Size <span class="tip" title="Point radius">?</span></label><div class="sig"><input type="range" id="ps3d" min=".02" max=".5" step=".01" value=".12" oninput="draw3D();document.getElementById('psv').textContent=this.value"><span id="psv" style="color:var(--txt2);min-width:40px">.12</span></div></div>
<div class="cg"><label>Color Scheme <span class="tip" title="Color by">?</span></label><select id="col3d" onchange="draw3D()"><option value="gcd">By GCD</option><option value="dist">By Distance</option><option value="prim">Primitive vs Non</option><option value="rainbow">Rainbow (Cyclic)</option><option value="quadres">Quadratic Residues</option><option value="primality">Primality (x¬∑y¬∑z)</option><option value="moddist">Modular Distance</option><option value="symmetry">Symmetry Pattern</option><option value="heatmap">Heatmap (Density)</option><option value="divisibility">Divisibility</option><option value="discrete">Discrete GCD</option><option value="fire">Fire Gradient</option><option value="plasma">Plasma</option><option value="viridis">Viridis</option><option value="ocean">Ocean</option></select></div>
<div class="cg"><label>View Mode <span class="tip" title="Normal or inverted">?</span></label><select id="vm3d" onchange="draw3D()"><option value="normal">Normal</option><option value="inv">Inverted (Flip)</option></select></div>
<div class="cg"><label>Label Size <span class="tip" title="Info label size">?</span></label><div class="sig"><input type="range" id="lblsz3d" min="8" max="18" step="1" value="11" oninput="document.getElementById('lblsz3dv').textContent=this.value+'px'"><span id="lblsz3dv" style="color:var(--txt2);min-width:40px">11px</span></div></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Screenshot Options</strong></label></div>
<div class="cg"><label>Resolution</label><select id="ss3dRes"><option value="1">Standard (1x)</option><option value="2" selected>High (2x)</option><option value="4">4K (4x)</option></select></div>
<div class="cg"><label>Background</label><select id="ss3dBg"><option value="theme">Theme Default</option><option value="black">Black</option><option value="white">White</option><option value="transparent">Transparent</option></select></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="ss3dTitle" checked> Title</label><label><input type="checkbox" id="ss3dLegend" checked> Legend</label><label><input type="checkbox" id="ss3dStats" checked> Stats</label></div>
<div class="cg"><label>Title Text</label><input type="text" id="ss3dTitleTxt" value="Geometric M√∂bius Shell Sieve - 3D Ball" style="width:100%"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Smith Chart Transform</strong> <span class="tip" title="Œì = (z-1)/(z+1) conformal mapping to unit disk">?</span></label></div>
<div class="cg"><label>Enable Smith Chart</label><input type="checkbox" id="smith3d" onchange="draw3D()"></div>
<div class="cg"><label>Phase Shift Œ±</label><div class="sig"><input type="range" id="smithA3d" min="0" max="360" value="90" oninput="document.getElementById('smithA3dV').textContent=this.value+'¬∞';draw3D()"><span id="smithA3dV" style="color:var(--txt2)">90¬∞</span></div></div>
<div class="cg"><label>Radius Scale</label><select id="smithR3d" onchange="draw3D()"><option value="unit">Unit (R=1)</option><option value="index">By Index</option><option value="dist">By Distance</option></select></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="smithGrid3d" onchange="draw3D()"> Grid</label><label><input type="checkbox" id="smithCircR3d" onchange="draw3D()"> Const-R</label><label><input type="checkbox" id="smithArcX3d" onchange="draw3D()"> Const-X</label></div>
</div>
<div class="bg"><button onclick="screenshot3D()">Screenshot</button><button onclick="screenshot3D4K()">4K Export</button><button onclick="anim3d=!anim3d">Auto Rotate</button><button class="s" onclick="rx=0;ry=0;rz=0;panX=0;panY=0;document.getElementById('zm3d').value=1;document.getElementById('zmv').textContent='1x';document.getElementById('rotX').value=0;document.getElementById('rotY').value=0;document.getElementById('rotZ').value=0;document.getElementById('rotXr').value=0;document.getElementById('rotYr').value=0;document.getElementById('rotZr').value=0;draw3D()">Reset View</button><button class="s" onclick="csv3D()">Export Points</button></div>
<div class="g2">
<div class="viz"><h3>3D Ball Visualization (Drag to rotate | Scroll to zoom | Right-click to pan)</h3><canvas id="c3d" width="700" height="700"></canvas><div class="al" id="al3d"></div><div class="sg" id="st3d"></div></div>
<div class="viz"><h3>Live Statistics Dashboard</h3><div id="stats3dLive" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(0,217,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">3D Lattice & Ap√©ry's Constant Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Coprime Probability:</strong> P(gcd(x,y,z)=1) = 1/Œ∂(3) ‚âà 83.19%</div>
<div><strong>Ap√©ry's Constant:</strong> Œ∂(3) = Œ£1/n¬≥ ‚âà 1.2021 (irrational)</div>
<div><strong>Euler Product:</strong> Œ∂(3) = Œ†(1-p‚Åª¬≥)‚Åª¬π over primes</div>
<div><strong>Ball Volume:</strong> V‚ÇÉ = (4/3)œÄR¬≥</div>
<div><strong>Asymptotic:</strong> #{primitive in B_R} ~ (4/3)œÄR¬≥/Œ∂(3)</div>
<div><strong>Visibility:</strong> Point (x,y,z) visible iff gcd(x,y,z)=1</div>
</div>
</div>
<p style="color:var(--txt2);font-size:.9rem;padding:1rem;background:rgba(0,217,255,.05);border-radius:4px"><strong>Controls:</strong> Left-drag to rotate | Scroll to zoom | Right-drag to pan | Inverted flips inner‚Üîouter</p>
</div>

<div id="tmob" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Compute Œº(n) for n ‚â§ N">?</span></label><div class="sig"><input type="range" id="mobN" min="10" max="500" step="10" value="100" oninput="document.getElementById('mobNv').value=this.value"><input type="number" id="mobNv" value="100" min="2" max="2000" onchange="document.getElementById('mobN').value=Math.min(500,this.value)"></div></div>
<div class="cg"><label>Visualization</label><select id="mobViz" onchange="drawMobius()">
<option value="strip">Œº(n) Strip Chart</option>
<option value="mertens">Mertens M(x)</option>
<option value="cumsum">Cumulative Œ£Œº(n)/n</option>
<option value="spiral">Ulam-like Spiral</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="mobCol" onchange="drawMobius()">
<option value="classic">Classic (Red/Gray/Blue)</option>
<option value="prime">Prime Factor Count</option>
<option value="sqfree">Squarefree Highlight</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="mobPtSz" min="2" max="15" value="6" onchange="drawMobius()"></div>
</div>
<div class="bg"><button onclick="drawMobius()">Compute</button><button onclick="screenshotMob()">Screenshot</button><button class="s" onclick="csvMob()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>M√∂bius Function Œº(n) ‚Äî The Heart of the Sieve</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Œº(n) = (-1)^k if n = p‚ÇÅp‚ÇÇ...p‚Çñ (k distinct primes), 0 if n has squared factor. Core identity: Œ£_{d|n} Œº(d) = [n=1]</p>
<canvas id="cmob" width="800" height="500"></canvas><div class="al" id="almob"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="mobLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Distribution</h3><div class="pc" id="pmobDist"></div></div>
</div>
<div class="viz"><h3>M√∂bius Data Table (Click rows)</h3><div style="max-height:300px;overflow-y:auto"><table id="tmobT"><tr><th>n</th><th>Œº(n)</th><th>M(n)</th><th>Factorization</th><th>Squarefree</th></tr></table></div></div>
<div style="padding:1rem;background:rgba(150,100,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Key Identities</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>M√∂bius Inversion:</strong> If g(n) = Œ£_{d|n} f(d), then f(n) = Œ£_{d|n} Œº(d)g(n/d)</div>
<div><strong>Euler Product:</strong> 1/Œ∂(s) = Œ£ Œº(n)/nÀ¢ = Œ†(1 - p‚ÅªÀ¢)</div>
<div><strong>Totient Connection:</strong> œÜ(n) = n ¬∑ Œ£_{d|n} Œº(d)/d</div>
<div><strong>Mertens Bound:</strong> |M(x)| = |Œ£_{n‚â§x} Œº(n)| = O(x^¬Ω) (RH equivalent)</div>
</div>
</div>
</div>

<div id="tcayley" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Lattice boundary">?</span></label><div class="sig"><input type="range" id="rcay" min="1" max="50" step=".5" value="6" oninput="document.getElementById('rcayv').value=this.value;drawCayley()"><input type="number" id="rcayv" value="6" min="1" step=".5" onchange="document.getElementById('rcay').value=Math.min(50,this.value);drawCayley()"></div></div>
<div class="cg"><label>View Range <span class="tip" title="Upper half-plane extent">?</span></label><input type="number" id="cayRange" value="4" min="1" max="20" step=".5" onchange="drawCayley()"></div>
<div class="cg"><label>Point Size</label><input type="range" id="caySz" min="1" max="10" value="3" onchange="drawCayley()"></div>
<div class="cg"><label>Color Scheme</label><select id="colCay" onchange="drawCayley()"><option value="gcd">By GCD</option><option value="prim">Primitive (Gold)</option><option value="imag">By Im(w)</option><option value="arg">By Arg(z)</option><option value="farey">Farey Level</option><option value="fire">Fire Gradient</option><option value="plasma">Plasma</option><option value="viridis">Viridis</option></select></div>
<div class="cg"><label>Filter</label><select id="cayFilt" onchange="drawCayley()"><option value="all">All Points</option><option value="prim">Primitive Only</option><option value="gcd2">GCD ‚â§ 2</option><option value="gcd3">GCD ‚â§ 3</option></select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="cayGrid" checked onchange="drawCayley()"> Grid</label>
<label><input type="checkbox" id="cayGeo" onchange="drawCayley()"> Geodesics</label>
<label><input type="checkbox" id="cayFord" onchange="drawCayley()"> Ford Circles</label>
<label><input type="checkbox" id="cayFarey" onchange="drawCayley()"> Farey Arcs</label>
<label><input type="checkbox" id="cayFund" onchange="drawCayley()"> Fundamental Domain</label>
<label><input type="checkbox" id="cayHoro" onchange="drawCayley()"> Horocycles</label>
</div></div>
<div class="cg"><label>Ford Depth</label><input type="number" id="cayFordQ" value="8" min="1" max="20" onchange="drawCayley()"></div>
<div class="cg"><label>Labels</label><select id="cayLbl" onchange="drawCayley()"><option value="none">None</option><option value="xy">Original (x,y)</option><option value="w">Cayley w</option><option value="frac">Fraction p/q</option></select></div>
</div>
<div class="bg"><button onclick="drawCayley()">Redraw</button><button onclick="screenshotCayley()">Screenshot</button><button class="s" onclick="csvCayley()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Cayley Transform: ùîª ‚Üí ‚Ñç Upper Half-Plane</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">w = i(1+z)/(1-z) maps unit disk to ‚Ñç. PSL(2,‚Ñ§) acts by M√∂bius transformations. Geodesics are semicircles ‚ä• to ‚Ñù.</p>
<canvas id="ccay" width="850" height="550"></canvas><div class="al" id="alcay"></div><div class="sg" id="stcay"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="cayLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Im(w) Distribution</h3><div class="pc" id="pcayDist"></div></div>
</div>
<div style="padding:1rem;background:rgba(0,217,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Hyperbolic Geometry & Modular Group</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Cayley Transform:</strong> w = i(1+z)/(1-z) maps ùîª ‚Üí ‚Ñç</div>
<div><strong>Hyperbolic Metric:</strong> ds¬≤ = (dx¬≤ + dy¬≤)/y¬≤</div>
<div><strong>Geodesics:</strong> Vertical lines and semicircles ‚ä• ‚Ñù</div>
<div><strong>PSL(2,‚Ñ§):</strong> Generated by T: z‚Ü¶z+1 and S: z‚Ü¶-1/z</div>
<div><strong>Ford Circles:</strong> C(p/q) has center (p/q, 1/2q¬≤) and radius 1/2q¬≤</div>
<div><strong>Farey Neighbors:</strong> p/q, r/s are neighbors iff |ps-qr|=1</div>
</div>
</div>
</div>

<div id="tprim" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus M <span class="tip" title="Ring ‚Ñ§/M‚Ñ§">?</span></label><div class="sig"><input type="range" id="mprim" min="2" max="500" step="1" value="17" oninput="document.getElementById('mprimv').value=this.value;drawPrimRoot()"><input type="number" id="mprimv" value="17" min="2" onchange="document.getElementById('mprim').value=Math.min(500,this.value);drawPrimRoot()"></div></div>
<div class="cg"><label>Generator g <span class="tip" title="Primitive root candidate">?</span></label><div class="sig"><input type="number" id="gprim" value="3" min="1" max="500"><button onclick="drawPrimRoot()">Use</button><button onclick="findPrimRoot()">Find Smallest</button><button onclick="findAllPrimRoots()">Find All</button></div></div>
<div class="cg"><label>Point Size</label><input type="range" id="primPtSz" min="2" max="12" value="5" onchange="drawPrimRoot()"></div>
<div class="cg"><label>Color By</label><select id="colPrim" onchange="drawPrimRoot()"><option value="order">Element Order</option><option value="power">Power Index</option><option value="unit">Unit vs Non-Unit</option><option value="quadres">Quadratic Residue</option><option value="generator">Generator Orbit</option><option value="discrete">Discrete Log</option></select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="primSeq" checked onchange="drawPrimRoot()"> Power Sequence</label>
<label><input type="checkbox" id="primOrd" onchange="drawPrimRoot()"> Show Orders</label>
<label><input type="checkbox" id="primSubgrp" onchange="drawPrimRoot()"> Subgroups</label>
<label><input type="checkbox" id="primQR" onchange="drawPrimRoot()"> QR Highlight</label>
<label><input type="checkbox" id="primCosets" onchange="drawPrimRoot()"> Cosets</label>
</div></div>
<div class="cg"><label>Labels</label><select id="primLbl" onchange="drawPrimRoot()"><option value="none">None</option><option value="value">Value k</option><option value="order">Order</option><option value="dlog">Discrete Log</option></select></div>
<div class="cg"><label>Quick M</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="setM(7)">7</button><button onclick="setM(11)">11</button><button onclick="setM(13)">13</button><button onclick="setM(17)">17</button><button onclick="setM(23)">23</button><button onclick="setM(31)">31</button><button onclick="setM(37)">37</button><button onclick="setM(41)">41</button><button onclick="setM(97)">97</button>
</div></div>
</div>
<div class="bg"><button onclick="drawPrimRoot()">Analyze</button><button onclick="animatePowerSeq()">Animate</button><button onclick="screenshotPrim()">Screenshot</button><button class="s" onclick="csvPrim()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Cyclic Group (‚Ñ§/M‚Ñ§)√ó</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">g is a primitive root ‚ü∫ ord(g) = œÜ(M) ‚ü∫ ‚ü®g‚ü© = (‚Ñ§/M‚Ñ§)√ó</p>
<canvas id="cprim" width="700" height="700"></canvas><div class="al" id="alprim"></div><div class="sg" id="stprim"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="primLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Order Distribution</h3><div class="pc" id="pprimord"></div>
<h3 style="margin-top:1rem">Power Sequence g‚Åø mod M</h3><div class="pc" id="pprimseq"></div></div>
</div>
<div class="viz"><h3>Element Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tprimT"><tr><th>k</th><th>ord(k)</th><th>Unit?</th><th>Prim Root?</th><th>QR?</th><th>Disc Log</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Primitive Root Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Definition:</strong> g is primitive root mod M ‚ü∫ ord(g) = œÜ(M)</div>
<div><strong>Existence:</strong> Prim roots exist for M = 1,2,4,p·µè,2p·µè (p odd prime)</div>
<div><strong>Count:</strong> If exists, exactly œÜ(œÜ(M)) primitive roots</div>
<div><strong>Discrete Log:</strong> If g prim root, every unit k = g‚Å± for unique i</div>
<div><strong>Quadratic Residues:</strong> QR ‚ü∫ k = g¬≤‚Å± ‚ü∫ k^(œÜ(M)/2) ‚â° 1</div>
<div><strong>Subgroups:</strong> For each d|œÜ(M), unique subgroup of order d</div>
</div>
</div>
</div>

<div id="tfarey" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Denominator Q <span class="tip" title="Farey sequence F_Q">?</span></label><div class="sig"><input type="range" id="fareyQ" min="2" max="50" value="8" oninput="document.getElementById('fareyQv').value=this.value;drawFarey()"><input type="number" id="fareyQv" value="8" min="2" max="100" onchange="document.getElementById('fareyQ').value=Math.min(50,this.value);drawFarey()"></div></div>
<div class="cg"><label>Visualization</label><select id="fareyViz" onchange="drawFarey()">
<option value="sequence">Farey Sequence (Line)</option>
<option value="tree">Stern-Brocot Tree</option>
<option value="ford">Ford Circles</option>
<option value="arc">Farey Arcs (Geodesics)</option>
<option value="spiral">Farey Spiral</option>
</select></div>
<div class="cg"><label>Color By</label><select id="fareyCol" onchange="drawFarey()">
<option value="denom">By Denominator q</option>
<option value="level">By Farey Level</option>
<option value="depth">By Tree Depth</option>
<option value="parent">By Parent</option>
<option value="rainbow">Rainbow</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="fareySz" min="2" max="12" value="5" onchange="drawFarey()"></div>
</div>
<div class="ctrl">
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="fareyLabels" checked onchange="drawFarey()"> Fraction Labels</label>
<label><input type="checkbox" id="fareyMediant" onchange="drawFarey()"> Mediant Lines</label>
<label><input type="checkbox" id="fareyNeighbor" onchange="drawFarey()"> Neighbor Arcs</label>
<label><input type="checkbox" id="fareyGrid" checked onchange="drawFarey()"> Grid</label>
<label><input type="checkbox" id="fareyCircles" onchange="drawFarey()"> Tangent Circles</label>
</div></div>
<div class="cg"><label>Quick Q</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="setFareyQ(3)">F‚ÇÉ</button><button onclick="setFareyQ(5)">F‚ÇÖ</button><button onclick="setFareyQ(7)">F‚Çá</button><button onclick="setFareyQ(10)">F‚ÇÅ‚ÇÄ</button><button onclick="setFareyQ(15)">F‚ÇÅ‚ÇÖ</button><button onclick="setFareyQ(20)">F‚ÇÇ‚ÇÄ</button><button onclick="setFareyQ(30)">F‚ÇÉ‚ÇÄ</button>
</div></div>
<div class="cg"><label>Highlight p/q</label><div class="sig"><input type="number" id="fareyP" value="0" min="0" style="width:50px">/<input type="number" id="fareyQh" value="1" min="1" style="width:50px"><button onclick="highlightFraction()">Find</button></div></div>
</div>
<div class="bg"><button onclick="drawFarey()">Redraw</button><button onclick="screenshotFarey()">Screenshot</button><button class="s" onclick="csvFarey()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Farey Sequence F<sub id="fareyQdisp">8</sub></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">F_Q = {p/q : 0‚â§p‚â§q‚â§Q, gcd(p,q)=1} ordered by value. Neighbors satisfy |ps-qr|=1.</p>
<canvas id="cfarey" width="850" height="550"></canvas><div class="al" id="alfarey"></div><div class="sg" id="stfarey"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="fareyLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">|F_Q| Growth</h3><div class="pc" id="pfareyGrowth"></div>
<h3 style="margin-top:1rem">Denominator Distribution</h3><div class="pc" id="pfareyDenom"></div></div>
</div>
<div class="viz"><h3>Farey Sequence Table (Click rows)</h3>
<div style="max-height:250px;overflow-y:auto">
<table id="tfareyT"><tr><th>Index</th><th>p/q</th><th>Value</th><th>Level</th><th>Left Neighbor</th><th>Right Neighbor</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Farey Sequence Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Definition:</strong> F_Q = {p/q : 0‚â§p‚â§q‚â§Q, gcd(p,q)=1}</div>
<div><strong>Size:</strong> |F_Q| = 1 + Œ£œÜ(k) for k=1..Q ‚âà 3Q¬≤/œÄ¬≤</div>
<div><strong>Neighbor Property:</strong> p/q, r/s neighbors ‚ü∫ |ps-qr|=1</div>
<div><strong>Mediant:</strong> Between p/q, r/s insert (p+r)/(q+s)</div>
<div><strong>Ford Circles:</strong> C(p/q) has center (p/q, 1/2q¬≤), radius 1/2q¬≤</div>
<div><strong>Tangency:</strong> C(p/q), C(r/s) tangent ‚ü∫ |ps-qr|=1</div>
</div>
</div>
</div>

<div id="tmod" class="tab">
<div class="ctrl">
<div class="cg"><label>Min Modulus <span class="tip" title="Inner ring">?</span></label><input type="number" id="modMin" value="1" min="1" max="100" onchange="drawModRings()"></div>
<div class="cg"><label>Max Modulus <span class="tip" title="Outer ring">?</span></label><input type="number" id="modMax" value="12" min="2" max="200" onchange="drawModRings()"></div>
<div class="cg"><label>Ring Spacing <span class="tip" title="How rings are spaced">?</span></label><select id="modSpace" onchange="drawModRings()"><option value="uniform">Uniform</option><option value="linear">Linear (c¬∑m)</option><option value="sqrt">Square Root (‚àöm)</option><option value="log">Logarithmic</option><option value="phi">Totient œÜ(m)</option></select></div>
<div class="cg"><label>Color Scheme</label><select id="modCol" onchange="drawModRings()"><option value="rainbow">Rainbow (Angular)</option><option value="gcd">By GCD (Gold=1)</option><option value="gcd_per_mod">GCD=1: Per Modulus</option><option value="gcd_spectrum">GCD=1: Spectral</option><option value="spf">Smallest Prime Factor</option><option value="ring">By Ring</option><option value="residue">By Residue Value</option><option value="prime">Prime vs Composite</option></select></div>
<div class="cg"><label>Phase Œ± <span class="tip" title="Global rotation">?</span></label><div class="sig"><input type="range" id="modPhase" min="0" max="360" value="0" oninput="document.getElementById('modPhaseV').textContent=this.value+'¬∞';document.getElementById('modPhaseNum').value=this.value;drawModRings()"><input type="number" id="modPhaseNum" value="0" min="0" max="360" step="1" style="width:60px" onchange="document.getElementById('modPhase').value=this.value;document.getElementById('modPhaseV').textContent=this.value+'¬∞';drawModRings()"><span id="modPhaseV" style="color:var(--txt2)">0¬∞</span></div></div>
<div class="cg"><label>Phase as r/m <span class="tip" title="Enter fraction for precise rotation">?</span></label><div class="sig"><input type="number" id="phaseR" value="0" min="0" style="width:50px">/&nbsp;<input type="number" id="phaseM" value="1" min="1" style="width:50px"><button onclick="const r=+document.getElementById('phaseR').value,m=+document.getElementById('phaseM').value;if(m>0){const deg=360*r/m;document.getElementById('modPhase').value=deg%360;document.getElementById('modPhaseNum').value=(deg%360).toFixed(2);document.getElementById('modPhaseV').textContent=(deg%360).toFixed(2)+'¬∞';drawModRings();}">Set</button></div></div>
<div class="cg"><label style="display:flex;gap:.3rem;flex-wrap:wrap"><button onclick="setPhase(0)">0¬∞</button><button onclick="setPhase(45)">45¬∞</button><button onclick="setPhase(90)">90¬∞</button><button onclick="setPhase(120)">120¬∞</button><button onclick="setPhase(180)">180¬∞</button><button onclick="setPhase(270)">270¬∞</button></label></div>
<div class="cg"><label>Point Size</label><input type="range" id="modPtSz" min="0.5" max="12" value="5" step="0.5" onchange="drawModRings()"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Per-Ring Rotation</strong> <span class="tip" title="Each ring rotates by index √ó increment">?</span></label></div>
<div class="cg"><label>Ring Increment <span id="ringIncV" style="color:var(--txt2)">0¬∞</span></label><div class="sig"><input type="range" id="ringInc" min="0" max="90" value="0" step="0.5" oninput="document.getElementById('ringIncV').textContent=this.value+'¬∞';document.getElementById('ringIncNum').value=this.value;drawModRings()"><input type="number" id="ringIncNum" value="0" min="0" max="360" step="0.5" style="width:60px" onchange="document.getElementById('ringInc').value=Math.min(90,this.value);document.getElementById('ringIncV').textContent=this.value+'¬∞';drawModRings()"></div></div>
<div class="cg"><label>Increment as r/m</label><div class="sig"><input type="number" id="ringIncR" value="0" min="0" style="width:50px">/&nbsp;<input type="number" id="ringIncM" value="1" min="1" style="width:50px"><button onclick="const r=+document.getElementById('ringIncR').value,m=+document.getElementById('ringIncM').value;if(m>0){const deg=360*r/m;document.getElementById('ringInc').value=Math.min(90,deg);document.getElementById('ringIncNum').value=deg.toFixed(4);document.getElementById('ringIncV').textContent=deg.toFixed(2)+'¬∞';drawModRings();}">Set</button></div></div>
<div class="cg"><label style="display:flex;gap:.3rem;flex-wrap:wrap"><button onclick="setRingInc(0)">0¬∞</button><button onclick="setRingInc(1)">1¬∞</button><button onclick="setRingInc(5)">5¬∞</button><button onclick="setRingInc(10)">10¬∞</button><button onclick="setRingInc(15)">15¬∞</button><button onclick="setRingInc(30)">30¬∞</button></label></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Gap Connections</strong> <span class="tip" title="Connect r‚Üír+g within ring (GCD=1 only)">?</span></label></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="gap2" onchange="drawModRings()"> Gap 2</label><label><input type="checkbox" id="gap4" onchange="drawModRings()"> Gap 4</label><label><input type="checkbox" id="gap6" onchange="drawModRings()"> Gap 6</label><label><input type="checkbox" id="gap8" onchange="drawModRings()"> Gap 8</label><label><input type="checkbox" id="gap10" onchange="drawModRings()"> Gap 10</label></div>
<div class="cg"><label>Gap Line Thickness <span id="gapThickV" style="color:var(--txt2)">0.3</span></label><input type="range" id="gapThick" min="0" max="1" step="0.01" value="0.3" oninput="document.getElementById('gapThickV').textContent=this.value;drawModRings()"></div>
<div class="cg"><label><strong>Lift Lines</strong></label></div>
<div class="cg"><label>Direct Lifts <span class="tip" title="r ‚Üí r across consecutive rings">?</span></label><input type="checkbox" id="modDirect" onchange="drawModRings()"></div>
<div class="cg"><label>Lift Line Thickness <span id="liftThickV" style="color:var(--txt2)">0.5</span></label><input type="range" id="liftThick" min="0" max="1" step="0.01" value="0.5" oninput="document.getElementById('liftThickV').textContent=this.value;drawModRings()"></div>
<div class="cg"><label>Show Only GCD=1</label><input type="checkbox" id="modGcd1" onchange="drawModRings()"></div>
<div class="cg"><label>Highlight Unit Circle</label><input type="checkbox" id="modUnit" checked onchange="drawModRings()"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Smith Chart Transform</strong> <span class="tip" title="Œì = (z-1)/(z+1) conformal mapping">?</span></label></div>
<div class="cg"><label>Enable Smith Chart</label><input type="checkbox" id="smithMod" onchange="drawModRings()"></div>
<div class="cg"><label>Phase Shift Œ±</label><div class="sig"><input type="range" id="smithAMod" min="0" max="360" value="90" oninput="document.getElementById('smithAModV').textContent=this.value+'¬∞';drawModRings()"><span id="smithAModV" style="color:var(--txt2)">90¬∞</span></div></div>
<div class="cg"><label>Radius Scale</label><select id="smithRMod" onchange="drawModRings()"><option value="unit">Unit (R=1)</option><option value="scaled" selected>Scaled by Index</option><option value="modulus">By Modulus</option></select></div>
<div class="cg"><label>Zoom <span id="smithZoomV" style="color:var(--txt2)">1.0x</span></label><input type="range" id="smithZoom" min="0.1" max="3" step="0.05" value="1" oninput="document.getElementById('smithZoomV').textContent=this.value+'x';drawModRings()"></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="smithGridMod" checked onchange="drawModRings()"> Grid</label><label><input type="checkbox" id="smithCircRMod" checked onchange="drawModRings()"> Const-R</label><label><input type="checkbox" id="smithArcXMod" checked onchange="drawModRings()"> Const-X</label></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Point Labels</strong></label></div>
<div class="cg"><label>Label Mode</label><select id="modLabel" onchange="drawModRings()"><option value="none">None</option><option value="r">Residue r</option><option value="rm">r/M Fraction</option><option value="deg">Degree Œ∏¬∞</option><option value="gcd">GCD Value</option></select></div>
<div class="cg"><label>Label Size</label><input type="range" id="modLblSz" min="6" max="14" value="8" step="1" onchange="drawModRings()"></div>
</div>
<div class="bg"><button onclick="drawModRings()">Redraw</button><button onclick="screenshotMod()">Screenshot</button><button class="s" onclick="csvMod()">CSV Export</button></div>
<div class="viz"><h3>Modular Ring System: Œ∏ = 2œÄr/M</h3><p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Concentric rings show residue classes. Gold points have GCD(r,M)=1 (Dirichlet character support œá(r)‚â†0). Direct lifts connect same residue across moduli.</p><canvas id="cmod" width="800" height="800"></canvas><div class="al" id="almod"></div><div class="sg" id="stmod"></div></div>
<div class="g2">
<div class="viz"><h3>Totient Density œÜ(M)/M</h3><div class="pc" id="pmodphi"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="modLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(150,100,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Modular Arithmetic & Totient Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Euler's Totient:</strong> œÜ(M) = #{r : 1‚â§r‚â§M, gcd(r,M)=1}</div>
<div><strong>Product Formula:</strong> œÜ(M) = M¬∑Œ†(1-1/p) for p|M</div>
<div><strong>Totient Density:</strong> œÜ(M)/M ‚Üí 0 as M‚Üí‚àû (highly composite)</div>
<div><strong>Unit Group:</strong> (‚Ñ§/M‚Ñ§)* has order œÜ(M)</div>
<div><strong>Dirichlet Characters:</strong> œá: (‚Ñ§/M‚Ñ§)* ‚Üí ‚ÑÇ*, œá(r)‚â†0 iff gcd(r,M)=1</div>
<div><strong>Direct Lift:</strong> r mod M lifts to r mod kM for k‚àà‚Ñ§‚Å∫</div>
</div>
</div>
</div>

<div id="terr" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Radius <span class="tip" title="Upper limit for R">?</span></label><div class="sig"><input type="range" id="errR" min="5" max="100" value="25" oninput="document.getElementById('errRv').value=this.value"><input type="number" id="errRv" value="25" min="2" max="200" onchange="document.getElementById('errR').value=Math.min(100,this.value)"></div></div>
<div class="cg"><label>Shape</label><select id="errSh"><option value="circle">Circle</option><option value="square">Square</option></select></div>
<div class="cg"><label>Step Size</label><select id="errStep"><option value="0.5">0.5</option><option value="1" selected>1</option><option value="2">2</option></select></div>
<div class="cg"><label>Error Exponent Œ∏</label><div class="sig"><input type="range" id="errTheta" min="0.3" max="1" step="0.05" value="0.5" oninput="document.getElementById('errThetaV').textContent=this.value"><span id="errThetaV" style="color:var(--txt2)">0.5</span></div></div>
</div>
<div class="ctrl">
<div class="cg"><label>Analysis</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="errBounds" checked> Show Bounds</label>
<label><input type="checkbox" id="errSmooth"> Smoothed</label>
<label><input type="checkbox" id="errLog"> Log Scale</label>
</div></div>
<div class="cg"><label>Compare</label><select id="errCompare"><option value="none">None</option><option value="primitive">Primitive Count</option><option value="both">Both</option></select></div>
</div>
<div class="bg"><button onclick="runErrNew()">Analyze</button><button onclick="runErrConvergence()">Convergence Study</button><button onclick="screenshotErr()">Screenshot</button><button class="s" onclick="csvErr()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Theory vs Actual Count</h3><div class="pc" id="pe1"></div><div class="al" id="ale1"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="errLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Absolute Error |Actual - Theory|</h3><div class="pc" id="pe2"></div><div class="al" id="ale2"></div></div>
<div class="viz"><h3>Relative Error %</h3><div class="pc" id="pe3"></div><div class="al" id="ale3"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Normalized Error / R^Œ∏</h3><div class="pc" id="pe4"></div><div class="al" id="ale4"></div></div>
<div class="viz"><h3>Error Distribution</h3><div class="pc" id="peHist"></div></div>
</div>
<div class="viz"><h3>Error Analysis Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="te"><tr><th>R</th><th>Theory</th><th>Actual</th><th>Primitive</th><th>Error</th><th>|Error|/‚àöR</th><th>Rel %</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,0,110,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Error Analysis Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Circle:</strong> N(R) = œÄR¬≤ + O(R^Œ∏), best Œ∏ ‚âà 0.63</div>
<div><strong>Square:</strong> N(R) = (2R+1)¬≤ exactly for integers</div>
<div><strong>Primitive (Circle):</strong> P(R) = œÄR¬≤/Œ∂(2) + O(R¬∑log R)</div>
<div><strong>Primitive (Square):</strong> P(R) = (2R+1)¬≤/Œ∂(2) + O(R¬∑log R)</div>
<div><strong>RMS Error:</strong> ‚àö(Œ£(err¬≤)/n) measures typical deviation</div>
<div><strong>Boundary Effect:</strong> Error grows with perimeter O(R)</div>
</div>
</div>
</div>

<div id="tdim" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Dimension <span class="tip" title="Compute up to this dimension">?</span></label><div class="sig"><input type="range" id="dimMax" min="3" max="30" step="1" value="12" oninput="document.getElementById('dimMaxV').value=this.value"><input type="number" id="dimMaxV" value="12" min="2" max="50" onchange="document.getElementById('dimMax').value=Math.min(30,this.value)"></div></div>
<div class="cg"><label>Radius R <span class="tip" title="Ball radius (lower for high dims)">?</span></label><div class="sig"><input type="range" id="rdim" min="1" max="20" step=".5" value="5" oninput="document.getElementById('rdimv').value=this.value"><input type="number" id="rdimv" value="5" min="1" max="50" onchange="document.getElementById('rdim').value=Math.min(20,this.value)"></div></div>
<div class="cg"><label>Compute Mode</label><select id="dimMode">
<option value="theory">Theory Only (fast)</option>
<option value="hybrid">Hybrid (compute ‚â§5D)</option>
<option value="full">Full Compute (slow)</option>
</select></div>
</div>
<div class="bg"><button onclick="runDimNew()">Compute All Dimensions</button><button onclick="screenshotDim()">Screenshot</button><button class="s" onclick="csvDim()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Œ∂(n) Convergence to 1</h3><div class="pc" id="pdimZeta"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="dimLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>1/Œ∂(n) Coprime Density</h3><div class="pc" id="pdimDens"></div></div>
<div class="viz"><h3>Volume of n-Ball</h3><div class="pc" id="pdimVol"></div></div>
</div>
<div class="viz"><h3>Dimension Analysis (Click rows)</h3><div style="max-height:350px;overflow-y:auto"><table id="tdimT"><tr><th>n</th><th>Vol(B‚Åø)</th><th>Œ∂(n)</th><th>1/Œ∂(n)</th><th>Computed</th><th>Error</th><th>Method</th></tr></table></div></div>
<div style="padding:1rem;background:rgba(255,140,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Dimension Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Volume Formula:</strong> Vol(B‚Åø) = œÄ‚Åø/¬≤/Œì(n/2+1)</div>
<div><strong>Coprime Density:</strong> P(gcd=1) = 1/Œ∂(n) ‚Üí 1 as n‚Üí‚àû</div>
<div><strong>Œ∂(n) values:</strong> Œ∂(2)=œÄ¬≤/6, Œ∂(4)=œÄ‚Å¥/90, Œ∂(2k)=rational√óœÄ¬≤·µè</div>
<div><strong>Ap√©ry:</strong> Œ∂(3)‚âà1.202 is irrational (proved 1978)</div>
<div><strong>Peak Volume:</strong> n-ball volume peaks near n‚âà5 for R=1</div>
<div><strong>High Dimensions:</strong> Volume concentrates near surface as n‚Üí‚àû</div>
</div>
</div>
</div>

<div id="tsh" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Region radius">?</span></label><div class="sig"><input type="range" id="rsh" min="1" max="50" value="10" oninput="document.getElementById('rshv').value=this.value;runShNew()"><input type="number" id="rshv" value="10" min="1" max="100" onchange="document.getElementById('rsh').value=Math.min(50,this.value);runShNew()"></div></div>
<div class="cg"><label>Max k <span class="tip" title="Maximum shell divisor">?</span></label><div class="sig"><input type="range" id="shK" min="5" max="50" value="15" oninput="document.getElementById('shKv').value=this.value;runShNew()"><input type="number" id="shKv" value="15" min="1" max="100" onchange="document.getElementById('shK').value=Math.min(50,this.value);runShNew()"></div></div>
<div class="cg"><label>Shape</label><select id="shShape" onchange="runShNew()"><option value="circle">Circle</option><option value="square">Square</option></select></div>
<div class="cg"><label>Display</label><select id="shDisplay" onchange="runShNew()"><option value="contrib">Contributions Œº(k)¬∑L(R/k)</option><option value="cumul">Cumulative Sum</option><option value="both">Both</option></select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Highlight</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="shSquarefree" checked onchange="runShNew()"> Squarefree Only</label>
<label><input type="checkbox" id="shPrimes" onchange="runShNew()"> Mark Primes</label>
<label><input type="checkbox" id="shShowZero" onchange="runShNew()"> Show Œº=0</label>
</div></div>
<div class="cg"><label>Color Mode</label><select id="shColor" onchange="runShNew()"><option value="sign">By Sign (¬±)</option><option value="mobius">By Œº(k)</option><option value="magnitude">By |Contribution|</option></select></div>
</div>
<div class="bg"><button onclick="runShNew()">Analyze Shells</button><button onclick="animateShells()">Animate</button><button onclick="screenshotSh()">Screenshot</button><button class="s" onclick="csvSh()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>M√∂bius Shell Contributions</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Primitive count P(R) = Œ£ Œº(k)¬∑L(R/k) where L counts all lattice points</p>
<div class="pc" id="psh"></div><div class="al" id="alsh"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="shLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Cumulative Sum Convergence</h3><div class="pc" id="pshCum"></div></div>
<div class="viz"><h3>Contribution Magnitude |Œº(k)¬∑L(R/k)|</h3><div class="pc" id="pshMag"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>M√∂bius Function Œº(k)</h3><div class="pc" id="pshMob"></div></div>
<div class="viz"><h3>Shell Size L(R/k)</h3><div class="pc" id="pshL"></div></div>
</div>
<div class="viz"><h3>Shell Decomposition Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tshT"><tr><th>k</th><th>Œº(k)</th><th>L(R/k)</th><th>Contribution</th><th>Cumulative</th><th>% of Total</th><th>Squarefree?</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">M√∂bius Shell Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>M√∂bius Inversion:</strong> P(R) = Œ£_{k=1}^‚àû Œº(k)¬∑L(R/k)</div>
<div><strong>Œº(k) values:</strong> Œº(1)=1, Œº(p)=‚àí1, Œº(p¬≤)=0, Œº(pq)=1</div>
<div><strong>Convergence:</strong> Sum truncates when R/k < 1</div>
<div><strong>Cancellation:</strong> Positive & negative terms cancel to give P(R)</div>
<div><strong>Main Term:</strong> k=1 gives L(R) (all points)</div>
<div><strong>First Correction:</strong> k=2 removes even-gcd points</div>
</div>
</div>
</div>
</div>

<div id="tgcd" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Region radius">?</span></label><div class="sig"><input type="range" id="rgcd" min="1" max="100" value="15" oninput="document.getElementById('rgcdv').value=this.value"><input type="number" id="rgcdv" value="15" min="1" onchange="document.getElementById('rgcd').value=Math.min(100,this.value)"></div></div>
<div class="cg"><label>Shape</label><select id="gcdShape" onchange="runGCD()"><option value="circle">Circle (x¬≤+y¬≤‚â§R¬≤)</option><option value="square">Square (|x|,|y|‚â§R)</option></select></div>
<div class="cg"><label>Analysis Mode</label><select id="gcdMode"><option value="full">Full Distribution</option><option value="avg">Average GCD Study</option><option value="coprime">Coprime Focus</option></select></div>
<div class="cg"><label>Top N GCDs</label><input type="number" id="gcdTopN" value="20" min="5" max="50"></div>
</div>
<div class="bg"><button onclick="runGCD()">Analyze GCD</button><button onclick="runGCDConvergence()">Convergence Study</button><button onclick="screenshotGCD()">Screenshot</button><button class="s" onclick="csvGCD()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>GCD Frequency Distribution</h3><div class="pc" id="pgcd1"></div><div class="al" id="algcd1"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="gcdLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Cumulative Distribution</h3><div class="pc" id="pgcd2"></div><div class="al" id="algcd2"></div></div>
<div class="viz"><h3>GCD vs Theory</h3><div class="pc" id="pgcd3"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Squarefree Analysis</h3><div class="pc" id="pgcdSF"></div></div>
<div class="viz"><h3>Divisibility Patterns</h3><div class="pc" id="pgcdDiv"></div></div>
</div>
<div class="viz"><h3>GCD Distribution Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tgcdT"><tr><th>GCD</th><th>Count</th><th>Percent</th><th>Cumulative</th><th>Theory</th><th>Squarefree?</th><th>Factorization</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,217,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">GCD Distribution Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>P(gcd=1):</strong> 1/Œ∂(2) = 6/œÄ¬≤ ‚âà 60.79%</div>
<div><strong>P(gcd=k):</strong> 1/(k¬≤¬∑Œ∂(2)) for coprime scaling</div>
<div><strong>Average GCD:</strong> Grows like ‚àö(log R) asymptotically</div>
<div><strong>Squarefree Density:</strong> 6/œÄ¬≤ ‚âà 60.79%</div>
<div><strong>M√∂bius Connection:</strong> Œ£Œº(d) over d|gcd encodes coprimality</div>
<div><strong>Expected GCD=k:</strong> ‚âà N¬∑Œº(k)/k¬≤ where N = total points</div>
</div>
</div>
</div>

<div id="tgaus" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="|a+bi| ‚â§ R">?</span></label><div class="sig"><input type="range" id="rgaus" min="1" max="50" step=".5" value="8" oninput="document.getElementById('rgausv').value=this.value;drawGaus()"><input type="number" id="rgausv" value="8" min="1" step=".5" onchange="document.getElementById('rgaus').value=Math.min(50,this.value);drawGaus()"></div></div>
<div class="cg"><label>Zoom <span class="tip" title="Zoom level">?</span></label><div class="sig"><input type="range" id="zmgaus" min=".5" max="3" step=".1" value="1" oninput="drawGaus();document.getElementById('zmgausv').textContent=this.value+'x'"><span id="zmgausv" style="color:var(--txt2);min-width:40px">1x</span></div></div>
<div class="cg"><label>Point Size</label><input type="range" id="ptszgaus" min="1" max="10" step="0.5" value="3" onchange="drawGaus()"></div>
<div class="cg"><label>Color Scheme</label><select id="colGaus" onchange="drawGaus()">
<option value="gcd">By GCD (Primitive=Gold)</option>
<option value="gprime">Gaussian Primes (Green)</option>
<option value="norm">By Norm (Rainbow)</option>
<option value="arg">By Argument Œ∏</option>
<option value="quadrant">By Quadrant</option>
<option value="parity">By Parity (a+b mod 2)</option>
<option value="sum2sq">Sum of Two Squares</option>
</select></div>
<div class="cg"><label>Filter</label><select id="filtGaus" onchange="drawGaus()">
<option value="all">All Points</option>
<option value="prim">Primitive Only (GCD=1)</option>
<option value="gprime">Gaussian Primes Only</option>
<option value="units">Exclude Units (¬±1, ¬±i)</option>
</select></div>
<div class="cg"><label>Labels</label><select id="lblGaus" onchange="drawGaus()">
<option value="none">None</option>
<option value="val">a + bi</option>
<option value="norm">|z|¬≤</option>
<option value="arg">Œ∏¬∞</option>
</select></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="gausNormC" onchange="drawGaus()"> Norm Circles</label>
<label><input type="checkbox" id="gausAxes" checked onchange="drawGaus()"> Axes</label>
<label><input type="checkbox" id="gausGrid" checked onchange="drawGaus()"> Grid</label>
<label><input type="checkbox" id="gausUnits" onchange="drawGaus()"> Highlight Units</label></div>
<div class="cg"><label><input type="checkbox" id="gausAssoc" onchange="drawGaus()"> Show Associates</label>
<label><input type="checkbox" id="gausConj" onchange="drawGaus()"> Connect Conjugates</label></div>
</div>
<div class="bg"><button onclick="screenshotGaus()">Screenshot</button><button onclick="drawGaus()">Analyze</button><button class="s" onclick="expGaus()">PNG Export</button><button class="s" onclick="csvGaus()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Complex Plane ‚Ñ§[i] (Click points)</h3><canvas id="cgaus" width="700" height="700"></canvas><div class="al" id="algaus1"></div></div>
<div class="viz"><h3>Live Statistics Dashboard</h3><div id="gausLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Norm Distribution</h3><div class="pc" id="pgaus"></div><div class="al" id="algaus2"></div></div>
</div>
<div class="sg" id="stgaus"></div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Gaussian Integers ‚Ñ§[i] Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Norm:</strong> N(a+bi) = a¬≤ + b¬≤ (multiplicative)</div>
<div><strong>Units:</strong> ¬±1, ¬±i (exactly 4 elements)</div>
<div><strong>Gaussian Primes:</strong> N(z) prime, OR z=p with p‚â°3 (mod 4)</div>
<div><strong>Fermat's Theorem:</strong> p=2 or p‚â°1(mod 4) ‚ü∫ p=a¬≤+b¬≤</div>
<div><strong>GCD in ‚Ñ§[i]:</strong> Euclidean algorithm works (UFD)</div>
<div><strong>Sum of Two Squares:</strong> n = Œ£r‚ÇÇ(k) counts representations</div>
</div>
</div>
</div>

<div id="tcirc" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Radius <span class="tip" title="Upper limit for analysis">?</span></label><div class="sig"><input type="range" id="circR" min="5" max="100" value="25" oninput="document.getElementById('circRv').value=this.value"><input type="number" id="circRv" value="25" min="2" max="200" onchange="document.getElementById('circR').value=Math.min(100,this.value)"></div></div>
<div class="cg"><label>Step Size</label><select id="circStep"><option value="0.5">0.5</option><option value="1" selected>1</option><option value="2">2</option></select></div>
<div class="cg"><label>Visualization R</label><input type="number" id="circVizR" value="10" min="2" max="30"></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="circBounds" checked> Error Bounds</label>
<label><input type="checkbox" id="circPrim"> Primitive Only</label>
</div></div>
</div>
<div class="bg"><button onclick="runCircNew()">Analyze</button><button onclick="drawCircleViz()">Visualize</button><button onclick="screenshotCirc()">Screenshot</button><button class="s" onclick="csvCirc()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Gauss Circle Visualization</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Lattice points inside circle of radius R. Count ‚âà œÄR¬≤ with error O(R^Œ∏).</p>
<canvas id="ccirc" width="600" height="600"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="circLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Error Function r(R) = N(R) - œÄR¬≤</h3><div class="pc" id="pc2"></div><div class="al" id="alc2"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Lattice Count vs œÄR¬≤</h3><div class="pc" id="pc1"></div><div class="al" id="alc1"></div></div>
<div class="viz"><h3>Normalized Error r(R)/R^Œ∏</h3><div class="pc" id="pc3"></div><div class="al" id="alc3"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Error Magnitude |r(R)|</h3><div class="pc" id="pcircAbs"></div></div>
<div class="viz"><h3>Running Average of r(R)/‚àöR</h3><div class="pc" id="pcircAvg"></div></div>
</div>
<div class="viz"><h3>Circle Problem Data (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tcircT"><tr><th>R</th><th>N(R)</th><th>œÄR¬≤</th><th>r(R)</th><th>r(R)/‚àöR</th><th>|r(R)|/R^0.5</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,100,150,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Gauss Circle Problem Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Count Formula:</strong> N(R) = #{(x,y)‚àà‚Ñ§¬≤ : x¬≤+y¬≤‚â§R¬≤}</div>
<div><strong>Main Term:</strong> N(R) = œÄR¬≤ + r(R)</div>
<div><strong>Gauss Bound:</strong> |r(R)| = O(R) (trivial)</div>
<div><strong>Best Known:</strong> |r(R)| = O(R^(131/208)) ‚âà O(R^0.63)</div>
<div><strong>Hardy Conjecture:</strong> r(R) = O(R^(1/2+Œµ)) for all Œµ>0</div>
<div><strong>Omega Result:</strong> r(R) = Œ©(R^(1/2)(log R)^(1/4))</div>
</div>
</div>
</div>

<div id="tdens" class="tab">
<div class="ctrl">
<div class="cg"><label>Fixed Radius R <span class="tip" title="Ball radius for sampling">?</span></label><div class="sig"><input type="range" id="densR" min="3" max="30" value="12" oninput="document.getElementById('densRv').textContent=this.value"><span id="densRv" style="color:var(--txt2)">12</span></div></div>
<div class="cg"><label>Max Dimension <span class="tip" title="Compute up to this dimension">?</span></label><div class="sig"><input type="range" id="densMaxK" min="3" max="20" value="10" oninput="document.getElementById('densMaxKv').textContent=this.value"><span id="densMaxKv" style="color:var(--txt2)">10</span></div></div>
<div class="cg"><label>Compute Mode</label><select id="densMode">
<option value="hybrid">Hybrid (exact for k‚â§4)</option>
<option value="theory">Theory Only (fast)</option>
<option value="sample">Monte Carlo Sample</option>
</select></div>
<div class="cg"><label>Sample Size</label><input type="number" id="densSample" value="10000" min="1000" max="100000" step="1000"></div>
</div>
<div class="bg"><button onclick="runDensNew()">Compute All</button><button onclick="runConvergence()">Convergence Test</button><button onclick="screenshotDens()">Screenshot</button><button class="s" onclick="csvDens()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>1/Œ∂(k) Density Convergence</h3><div class="pc" id="pdens1"></div><div class="al" id="aldens1"></div></div>
<div class="viz"><h3>Œ∂(k) ‚Üí 1 as k ‚Üí ‚àû</h3><div class="pc" id="pdensZeta"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Relative Error % by Dimension</h3><div class="pc" id="pdens2"></div><div class="al" id="aldens2"></div></div>
<div class="viz"><h3>Euler Product Verification</h3><div class="pc" id="pdensEuler"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Live Statistics</h3><div id="densLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
<div class="viz"><h3>Convergence to Limit</h3><div class="pc" id="pdensConv"></div></div>
</div>
<div class="viz"><h3>Comprehensive Density Table (Click rows)</h3>
<div style="max-height:350px;overflow-y:auto">
<table id="tdensT"><tr><th>k</th><th>Œ∂(k)</th><th>1/Œ∂(k)</th><th>Empirical</th><th>Total</th><th>Primitive</th><th>Abs Err</th><th>Rel Err %</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,140,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Zeta Function & Primitive Density Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Riemann Zeta:</strong> Œ∂(s) = Œ£ n‚ÅªÀ¢ = Œ†(1-p‚ÅªÀ¢)‚Åª¬π</div>
<div><strong>Coprime Density:</strong> P(gcd(x‚ÇÅ,...,x‚Çñ)=1) = 1/Œ∂(k)</div>
<div><strong>Basel Problem:</strong> Œ∂(2) = œÄ¬≤/6 ‚âà 1.6449</div>
<div><strong>Ap√©ry's Constant:</strong> Œ∂(3) ‚âà 1.2021 (irrational)</div>
<div><strong>Even Values:</strong> Œ∂(2n) = (-1)‚Åø‚Å∫¬π B‚ÇÇ‚Çô(2œÄ)¬≤‚Åø/(2(2n)!)</div>
<div><strong>Limit:</strong> lim_{k‚Üí‚àû} Œ∂(k) = 1, so P(coprime) ‚Üí 1</div>
</div>
</div>
</div>
</div>

<div id="tdir" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus M <span class="tip" title="Character modulus">?</span></label><div class="sig"><input type="range" id="dirM" min="2" max="100" value="12" oninput="document.getElementById('dirMv').value=this.value;drawDirichlet()"><input type="number" id="dirMv" value="12" min="2" max="500" onchange="document.getElementById('dirM').value=Math.min(100,this.value);drawDirichlet()"></div></div>
<div class="cg"><label>Character Index <span class="tip" title="Which character (1 to œÜ(M))">?</span></label><div class="sig"><input type="range" id="dirIdx" min="0" max="10" value="0" oninput="document.getElementById('dirIdxV').textContent=this.value;drawDirichlet()"><span id="dirIdxV" style="color:var(--txt2)">0</span> <span id="dirIdxLabel" style="color:#ffd700;font-size:.8rem">(Principal œá‚ÇÄ)</span></div></div>
<div class="cg"><label>Visualization</label><select id="dirViz" onchange="drawDirichlet()">
<option value="circle">Unit Circle (œá values)</option>
<option value="support">Support vs Vanishing</option>
<option value="residues">Residue Classes</option>
<option value="table">Character Table</option>
<option value="lfunction">L-function Partial Sums</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="dirCol" onchange="drawDirichlet()">
<option value="arg">By Argument (Phase)</option>
<option value="support">Support (Gold) / Zero (Gray)</option>
<option value="real">Real Part</option>
<option value="order">By Order of œá(r)</option>
</select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="dirLabels" checked onchange="drawDirichlet()"> Labels</label>
<label><input type="checkbox" id="dirGrid" checked onchange="drawDirichlet()"> Unit Circle</label>
<label><input type="checkbox" id="dirRays" onchange="drawDirichlet()"> Arg Rays</label>
<label><input type="checkbox" id="dirConnect" onchange="drawDirichlet()"> Connect Values</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="dirPtSz" min="3" max="15" value="8" onchange="drawDirichlet()"></div>
<div class="cg"><label>L-function Terms</label><input type="number" id="dirLterms" value="100" min="10" max="1000" step="10" onchange="drawDirichlet()"></div>
</div>
<div class="bg"><button onclick="drawDirichlet()">Compute</button><button onclick="showAllChars()">All Characters</button><button onclick="screenshotDir()">Screenshot</button><button class="s" onclick="csvDir()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Dirichlet Character œá mod <span id="dirMdisp">12</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">œá(r) ‚â† 0 (gold) when gcd(r,M)=1. œá(r) = 0 (gray) when gcd(r,M) > 1. Characters map units to roots of unity.</p>
<canvas id="cdir" width="750" height="550"></canvas><div class="al" id="aldir"></div></div>
<div class="viz"><h3>Live Statistics</h3><div id="dirLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Character Value Distribution</h3><div class="pc" id="pdirDist"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>L(s,œá) Partial Sums</h3><div class="pc" id="pdirL"></div></div>
<div class="viz"><h3>Character Orthogonality</h3><div class="pc" id="pdirOrtho"></div></div>
</div>
<div class="viz"><h3>Character Table mod M (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tdirT"><tr><th>r</th><th>gcd(r,M)</th><th>œá(r)</th><th>|œá(r)|</th><th>arg(œá(r))</th><th>Support?</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Dirichlet Character Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Definition:</strong> œá: ‚Ñ§ ‚Üí ‚ÑÇ, completely multiplicative, periodic mod M</div>
<div><strong>Support:</strong> œá(r) ‚â† 0 iff gcd(r,M) = 1 (œÜ(M) values)</div>
<div><strong>Vanishing:</strong> œá(r) = 0 when gcd(r,M) > 1</div>
<div><strong>Principal œá‚ÇÄ:</strong> œá‚ÇÄ(r) = 1 if gcd(r,M)=1, else 0</div>
<div><strong>Character Count:</strong> Exactly œÜ(M) characters mod M</div>
<div><strong>L-function:</strong> L(s,œá) = Œ£ œá(n)/nÀ¢ = Œ†(1-œá(p)p‚ÅªÀ¢)‚Åª¬π</div>
<div><strong>Orthogonality:</strong> Œ£·µ£ œá(r)œáÃÑ'(r) = œÜ(M)¬∑Œ¥_{œá,œá'}</div>
<div><strong>Dirichlet's Theorem:</strong> Primes ‚â° a (mod M) infinite if gcd(a,M)=1</div>
</div>
</div>
</div>

<div id="ref" class="sec">
<div class="rs"><h3>Complete Feature Overview</h3><p>This comprehensive research platform integrates 9 interactive visualization tools with full mathematical verification and automatic statistical legends.</p></div>
<div class="rs"><h3>Automatic Legend System</h3><p>Each visualization displays color-coordinated legends showing:</p><ul><li><strong>Count:</strong> Total and primitive point counts</li><li><strong>Relation to 1/Œ∂(k):</strong> Empirical density vs theory</li><li><strong>Absolute Error:</strong> Numerical difference</li><li><strong>Relative Error:</strong> Percentage deviation</li><li><strong>Color Coordination:</strong> Matches visualization colors</li></ul></div>
<div class="rs"><h3>Interactive Tools (9 Tabs)</h3>
<h4>Core Visualizations</h4>
<div class="fb"><strong>2D Explorer</strong> - Lattice points in circle/square with GCD coloring, distance gradient, or primitive status. Click any point for full analysis.</div>
<div class="fb"><strong>3D Ball</strong> - Three-dimensional visualization with drag rotation. Shows primitive density in 3D space.</div>
<div class="fb"><strong>Error Analysis</strong> - Four plots: theory vs actual, absolute error, relative error %, boundary term comparison.</div>
<h4>Dimensional Analysis</h4>
<div class="fb"><strong>Dimensions</strong> - Computes primitive density for k=2-7 showing convergence to 1/Œ∂(k).</div>
<div class="fb"><strong>Primitive Density 1/Œ∂(k)</strong> - Empirically verifies the fundamental formula.</div>
<h4>Advanced Number Theory</h4>
<div class="fb"><strong>GCD Metrics</strong> - Statistical analysis: mean/median/mode, squarefree breakdown.</div>
<div class="fb"><strong>Gaussian Integers ‚Ñ§[i]</strong> - Complex plane visualization with norm distribution.</div>
<div class="fb"><strong>Circle Problem</strong> - Dirichlet's classical problem with r(R) = Count - œÄ¬∑R¬≤.</div>
<div class="fb"><strong>Shells</strong> - M√∂bius decomposition showing divisor contributions.</div>
</div>
<div class="rs"><h3>Coloring Schemes (2D & 3D)</h3>
<h4>By GCD (Recommended)</h4><p style="color:var(--acc);font-weight:600">Cyan = GCD:1 (Primitive) | Blue = GCD:2 | Purple = GCD:3 | Pink = Other</p>
<p style="color:var(--txt2)">Colors points by their GCD value, revealing the shell structure of the M√∂bius sieve. Primitive points (GCD=1) form the outer layer.</p>
<h4>By Distance</h4><p style="color:var(--acc);font-weight:600">Gradient from near (blue) to far (red) from origin</p>
<p style="color:var(--txt2)">HSL gradient based on Euclidean distance from origin. Visualizes radial distribution.</p>
<h4>Primitive vs Non</h4><p style="color:var(--acc);font-weight:600">Cyan = Primitive (GCD=1) | Red = Non-Primitive (GCD>1)</p>
<p style="color:var(--txt2)">Binary coloring highlighting the fundamental primitive/non-primitive distinction.</p>
<h4>Rainbow (Cyclic)</h4><p style="color:var(--acc);font-weight:600">Full spectrum based on angular position</p>
<p style="color:var(--txt2)">Colors by angle from origin (atan2). Reveals rotational patterns in the lattice. The lattice is essentially a bounded GCD multiplication table.</p>
<h4>Quadratic Residues</h4><p style="color:var(--acc);font-weight:600">Gold = Quadratic residue | Purple = Non-residue</p>
<p style="color:var(--txt2)">Colors based on whether x¬≤+y¬≤ (mod R) is a perfect square. Connects to quadratic forms and Fermat's theorem on sums of squares.</p>
<h4>Primality (Product)</h4><p style="color:var(--acc);font-weight:600">Green = |x¬∑y| prime | Pink = Composite | Blue = 0 or 1</p>
<p style="color:var(--txt2)">Highlights points where the product of coordinates is prime. Reveals prime-generating patterns.</p>
<h4>Modular Distance</h4><p style="color:var(--acc);font-weight:600">Spectrum by min(|x|,|y|)</p>
<p style="color:var(--txt2)">Colors by the minimum absolute coordinate value. Shows proximity to axes.</p>
<h4>Symmetry Pattern</h4><p style="color:var(--acc);font-weight:600">Gold = Diagonal (|x|=|y|) | Spectrum by asymmetry</p>
<p style="color:var(--txt2)">Highlights points along diagonals and colors others by deviation from diagonal symmetry.</p>
<h4>Heatmap (Density)</h4><p style="color:var(--acc);font-weight:600">Dark Blue ‚Üí Cyan ‚Üí Yellow ‚Üí Red by distance</p>
<p style="color:var(--txt2)">Classic thermal gradient visualization of radial distance.</p>
<h4>Divisibility</h4><p style="color:var(--acc);font-weight:600">Hue by divisor count of GCD</p>
<p style="color:var(--txt2)">Colors based on how many divisors the GCD has. Highly composite GCDs have distinct colors.</p>
<h4>Discrete GCD</h4><p style="color:var(--acc);font-weight:600">20 distinct colors cycling through GCD values</p>
<p style="color:var(--txt2)">Maximum contrast coloring for distinguishing individual GCD values.</p>
<h4>Fire Gradient</h4><p style="color:var(--acc);font-weight:600">Black ‚Üí Red ‚Üí Orange ‚Üí Yellow by distance</p>
<p style="color:var(--txt2)">Thermal gradient emphasizing radial density. Points near origin are dark, outer points glow hot.</p>
<h4>Plasma</h4><p style="color:var(--acc);font-weight:600">Purple ‚Üí Pink ‚Üí Yellow scientific colormap</p>
<p style="color:var(--txt2)">Perceptually uniform gradient from matplotlib. Excellent for revealing subtle density variations.</p>
<h4>Viridis</h4><p style="color:var(--acc);font-weight:600">Purple ‚Üí Green ‚Üí Yellow scientific colormap</p>
<p style="color:var(--txt2)">Perceptually uniform and colorblind-friendly. Standard for scientific visualization.</p>
<h4>Ocean</h4><p style="color:var(--acc);font-weight:600">Deep Blue ‚Üí Cyan by distance</p>
<p style="color:var(--txt2)">Cool tones gradient emphasizing depth perception.</p>
</div>
<div class="rs"><h3>New Tabs: Cayley Transform & Primitive Roots</h3>
<h4>Cayley ‚Ñç (Upper Half-Plane)</h4>
<p style="color:var(--txt2)">The Cayley transform w = i(1+z)/(1-z) maps the unit disk to the upper half-plane ‚Ñç. This conformal mapping is fundamental to hyperbolic geometry and modular forms. Primitive lattice points (GCD=1) transform to create patterns related to Ford circles and Farey sequences.</p>
<div class="fb"><strong>Ford Circles:</strong> For rational p/q, the Ford circle has center (p/q, 1/(2q¬≤)) and radius 1/(2q¬≤). Adjacent Farey fractions have tangent Ford circles.</div>
<div class="fb"><strong>Geodesics:</strong> In ‚Ñç, hyperbolic geodesics are semicircles perpendicular to the real axis. The modular group PSL(2,‚Ñ§) acts by isometries.</div>
<h4>Primitive Roots</h4>
<p style="color:var(--txt2)">An element g ‚àà (‚Ñ§/M‚Ñ§)√ó is a primitive root if its multiplicative order equals œÜ(M). When primitive roots exist, the unit group is cyclic: (‚Ñ§/M‚Ñ§)√ó ‚âÖ ‚Ñ§/œÜ(M)‚Ñ§.</p>
<div class="fb"><strong>Existence:</strong> Primitive roots exist mod M iff M ‚àà {1, 2, 4, p^k, 2p^k} where p is odd prime.</div>
<div class="fb"><strong>Power Sequence:</strong> g^n mod M for n=0,1,...,œÜ(M)-1 cycles through all units exactly once.</div>
</div>
<div class="rs"><h3>New Tab: Modular Rings 2œÄr/M</h3>
<p style="color:var(--txt2)">Concentric ring visualization showing residue classes at angular positions Œ∏ = 2œÄr/M. This is the geometric foundation for understanding Dirichlet characters and the Generalized Riemann Hypothesis.</p>
<h4>Ring Spacing Options</h4>
<div class="fb"><strong>Uniform:</strong> Equal spacing between rings regardless of modulus value.</div>
<div class="fb"><strong>Linear (c¬∑m):</strong> Ring radius proportional to modulus. Outer rings are larger moduli.</div>
<div class="fb"><strong>Square Root (‚àöm):</strong> Compressed outer rings. Better for large modulus ranges.</div>
<div class="fb"><strong>Logarithmic:</strong> Even more compression. Good for M=1 to M=100+.</div>
<div class="fb"><strong>Totient œÜ(m):</strong> Radius proportional to number of coprime residues. Reveals totient structure.</div>
<h4>Connection Lines</h4>
<div class="fb"><strong>Direct Lifts:</strong> r ‚Üí r across consecutive rings. Shows how residues persist across moduli.</div>
<div class="fb"><strong>Gap-g Lines:</strong> r ‚Üí r+g within same ring. Gap 2 = twin primes, Gap 6 = sexy primes.</div>
<h4>Color Schemes</h4>
<div class="fb"><strong>By GCD:</strong> Gold for GCD(r,M)=1 (Dirichlet character support œá(r)‚â†0), gray otherwise.</div>
<div class="fb"><strong>Rainbow:</strong> Hue by angular position 2œÄr/M.</div>
<div class="fb"><strong>By Ring:</strong> Each modulus gets unique color.</div>
<div class="fb"><strong>Prime vs Composite:</strong> Green for prime residues, pink for composite.</div>
</div>
<div class="rs"><h3>Smith Chart / Cayley Transform</h3>
<p style="color:var(--txt2)">Conformal mapping Œì = (z-1)/(z+1) from impedance plane to unit disk. Available in 2D, 3D, and Modular Rings tabs.</p>
<h4>Transform Formula</h4>
<div class="fb"><strong>Input:</strong> z = R¬∑e^(iŒ∏) where Œ∏ = angle + Œ± (phase shift)</div>
<div class="fb"><strong>Output:</strong> Œì = (z-1)/(z+1) maps to unit disk</div>
<div class="fb"><strong>Real Part:</strong> Re(Œì) = (AC + B¬≤)/(C¬≤ + B¬≤) where A = R¬∑cos(Œ∏)-1, B = R¬∑sin(Œ∏), C = R¬∑cos(Œ∏)+1</div>
<div class="fb"><strong>Imaginary Part:</strong> Im(Œì) = B(C-A)/(C¬≤ + B¬≤)</div>
<div class="fb"><strong>Special Case R=1:</strong> Œì(Œ∏) = i¬∑tan(Œ∏/2) (pure imaginary axis)</div>
<h4>Controls</h4>
<div class="fb"><strong>Phase Shift Œ±:</strong> Global rotation of all angles (0¬∞-360¬∞). Default 90¬∞ aligns with standard Smith chart.</div>
<div class="fb"><strong>Radius Scale:</strong> Unit (all R=1), By Index (spreads points), By Distance/Modulus (varies R).</div>
<div class="fb"><strong>Grid:</strong> Shows unit circle and axes.</div>
<div class="fb"><strong>Const-R Circles:</strong> Circles of constant resistance (real part).</div>
<div class="fb"><strong>Const-X Arcs:</strong> Arcs of constant reactance (imaginary part).</div>
<h4>Mathematical Significance</h4>
<div class="fb"><strong>Conformal:</strong> Preserves angles between curves.</div>
<div class="fb"><strong>M√∂bius Transform:</strong> Special case mapping circles to circles.</div>
<div class="fb"><strong>RF Engineering:</strong> Standard tool for impedance matching and transmission line analysis.</div>
<div class="fb"><strong>Number Theory:</strong> Maps residue angles to patterns revealing arithmetic structure.</div>
</div>
<div class="rs"><h3>2D Connection Lines</h3>
<p style="color:var(--txt2)">Connect lattice points to reveal structural patterns:</p>
<div class="fb"><strong>GCD=1 Network:</strong> Links between primitive points within distance 2.</div>
<div class="fb"><strong>Same GCD:</strong> Points with equal GCD values connected.</div>
<div class="fb"><strong>Radial:</strong> Lines from origin to all primitive points.</div>
<div class="fb"><strong>Diagonal:</strong> Connects points on x=¬±y lines.</div>
</div>
<div class="rs"><h3>Enhanced 3D Screenshot</h3>
<p style="color:var(--txt2)">Professional export options for publications and presentations:</p>
<div class="fb"><strong>Resolution:</strong> 1x Standard, 2x High, 4x for 4K output.</div>
<div class="fb"><strong>Background:</strong> Theme default, black, white, or transparent.</div>
<div class="fb"><strong>Options:</strong> Include/exclude title, legend, statistics panel.</div>
<div class="fb"><strong>Custom Title:</strong> Set your own title text for the export.</div>
</div>
<div class="rs"><h3>Point Labeling Options</h3><ul><li><strong>None</strong> - Clean visualization</li><li><strong>Coordinates</strong> - Shows (x,y) above each point</li><li><strong>GCD Values</strong> - Displays GCD number</li></ul></div>
<div class="rs"><h3>Precision Control (2-16 Decimal Places)</h3><p>Use the dropdown in the header. 2-4 for quick analysis, 6-8 for verification, 10+ for research.</p></div>
<div class="rs"><h3>Mathematical Functions Verified</h3><ul><li><strong>GCD</strong> - Euclidean algorithm</li><li><strong>M√∂bius Function</strong> - Squarefree check via prime factorization</li><li><strong>Riemann Zeta</strong> - Dirichlet series, 150 terms</li><li><strong>Volume</strong> - Exact formulas for B_n, n=2-7</li><li><strong>Enumeration</strong> - Exhaustive for n‚â§3</li></ul></div>
<div class="rs"><h3>Quick Start Guide</h3><ol><li>Read <strong>Theory</strong> tab</li><li>Try <strong>2D Explorer</strong> - adjust radius, change colors, click points</li><li>Explore <strong>3D Ball</strong> - drag to rotate</li><li>Check <strong>Primitive Density 1/Œ∂(k)</strong></li><li>Use <strong>GCD Metrics</strong></li><li>Check <strong>Gaussian Integers</strong></li><li>Analyze <strong>Circle Problem</strong></li><li>Run <strong>Error Analysis</strong></li><li>Examine <strong>Shells</strong></li></ol></div>
</div>
</div>

<div id="modal" class="modal" onclick="this.classList.remove('active')">
<div class="mc" onclick="event.stopPropagation()">
<span class="mx" onclick="document.getElementById('modal').classList.remove('active')">&times;</span>
<h2 id="mtitle">Analysis</h2>
<div id="mbody"></div>
</div>
</div>

<footer>
<div style="margin-bottom:1rem"><strong style="color:var(--acc)">By Wessen Getachew</strong> ¬∑ <a href="https://twitter.com/7dview" target="_blank" style="color:var(--acc2)">@7dview</a></div>
<div style="display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:1rem">
<a href="https://wessengetachew.github.io/Farey/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Farey Triangle</a>
<a href="https://wessengetachew.github.io/1-2/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">1/Œ∂(2) Explorer</a>
<a href="https://wessengetachew.github.io/Primes/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Prime Explorer</a>
<a href="https://wessengetachew.github.io/Composite/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Composite Analysis</a>
<a href="https://wessengetachew.github.io/GCD/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">GCD Explorer</a>
<a href="https://wessengetachew.github.io/Reduced/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Reduced Residues</a>
<a href="https://wessengetachew.github.io/Infinitemoduli/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Modular Arithmetic</a>
<a href="https://wessengetachew.github.io/finite/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Finite Fields</a>
</div>
<div style="color:var(--txt2);font-size:.85rem">A philosophical exploration of optimal prime sieves through geometric visualization</div>
</footer>

<script>
let P=4,D={},rx=0,ry=0,rz=0,panX=0,panY=0,anim3d=false,pts2d=[],pts3d=[],gausP=[];
const fmt=n=>{if(n===0)return'0';if(n==null||isNaN(n)||!isFinite(n))return'‚Äî';return parseFloat(n).toFixed(P);};
const gcd=(a,b)=>{a=Math.abs(Math.round(a));b=Math.abs(Math.round(b));while(b)[a,b]=[b,a%b];return a||1;};
const gcdM=(...n)=>n.reduce((a,b)=>gcd(a,b));
const mob=n=>{if(n===1)return 1;let pf=0,t=n;for(let i=2;i*i<=n;i++){if(n%i===0){if(t%(i*i)===0)return 0;pf++;while(t%i===0)t/=i;}}if(t>1)pf++;return pf%2===0?1:-1;};
const zeta=(n,t=150)=>{let s=0;for(let k=1;k<=t;k++)s+=1/Math.pow(k,n);return s;};
const vol=n=>[0,2,Math.PI,4*Math.PI/3,Math.PI**2/2,8*Math.PI**2/15,Math.PI**3/6,16*Math.PI**3/105][n]||0;
const theory=(R,n)=>(vol(n)/zeta(n))*Math.pow(R,n);
const sqfree=n=>{for(let i=2;i*i<=n;i++)if(n%(i*i)===0)return false;return true;};
const isDark=()=>!document.body.classList.contains('light');
const plo=()=>({plot_bgcolor:isDark()?'rgba(10,14,39,0.8)':'rgba(245,247,250,0.95)',paper_bgcolor:isDark()?'rgba(10,14,39,0.8)':'rgba(245,247,250,0.95)',font:{color:isDark()?'#e0e0ff':'#1a1a1a'},margin:{l:50,r:30,t:30,b:40}});
const canvBg=()=>isDark()?'#0a0e27':'#f5f7fa';
const gridC=()=>isDark()?'rgba(0,217,255,0.12)':'rgba(0,102,204,0.15)';
const bordC=()=>isDark()?'rgba(0,217,255,0.5)':'rgba(0,102,204,0.6)';
function toggleTheme(){document.body.classList.toggle('light');document.getElementById('thm').textContent=isDark()?'D':'L';draw2D();if(document.getElementById('t3d').classList.contains('active'))draw3D();}
function showSec(id,btn){document.querySelectorAll('.sec').forEach(s=>s.classList.remove('active'));document.querySelectorAll('.snav .nbtn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active');btn.classList.add('active');}
function showTab(id,btn){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tabs .tbtn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active');btn.classList.add('active');if(id==='t3d')draw3D();if(id==='tcayley')drawCayley();if(id==='tfarey')drawFarey();if(id==='tprim')drawPrimRoot();if(id==='tmod')drawModRings();if(id==='tgaus')drawGaus();if(id==='tmob')drawMobius();if(id==='tdim')runDimNew();}
function legend(id,title,data){const d=document.getElementById(id);if(!d)return;d.innerHTML=`<h4>${title}</h4><div class="lg">${data.map(([l,v,c])=>`<div class="li" style="border-left-color:${c}"><strong>${l}</strong><span class="v">${fmt(v)}</span></div>`).join('')}</div>`;}
function modal(title,data){document.getElementById('mtitle').textContent=title;document.getElementById('mbody').innerHTML=data.map(([l,v])=>`<div class="ds"><div class="dr"><span class="dl">${l}:</span><span class="dv">${typeof v==='number'?fmt(v):v}</span></div></div>`).join('');document.getElementById('modal').classList.add('active');}
function dl(c,f){const a=document.createElement('a');a.href='data:text/csv,'+encodeURIComponent(c);a.download=f;a.click();}
function enum2D(R,sh){const pts=[],m=Math.ceil(R)+1;for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++){const inCirc=x*x+y*y<=R*R,inSq=Math.abs(x)<=R&&Math.abs(y)<=R;const inR=sh==='circle'?inCirc:sh==='square'?inSq:inSq;if(inR){const g=gcdM(x,y);pts.push({x,y,g,p:g===1,inCircle:inCirc});}}return pts;}
function enum3D(R){const pts=[],m=Math.ceil(R)+1;for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){const g=gcdM(x,y,z);pts.push({x,y,z,g,p:g===1});}return pts;}

function smithTransform(r,theta,alpha){
const th=theta+alpha*Math.PI/180;
const A=r*Math.cos(th)-1,B=r*Math.sin(th),C=r*Math.cos(th)+1;
const denom=C*C+B*B;
if(denom<1e-10)return{x:0,y:0};
const re=(A*C+B*B)/denom,im=B*(C-A)/denom;
return{x:re,y:im};}

function smithTransformUnit(theta){return{x:0,y:Math.tan(theta/2)};}

function drawSmithGrid(ctx,cx,cy,rad,showGrid,showConstR,showConstX){
if(showGrid){ctx.strokeStyle=isDark()?'rgba(100,150,200,0.3)':'rgba(50,100,150,0.3)';ctx.lineWidth=0.5;
ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();
ctx.strokeStyle=isDark()?'rgba(255,255,255,0.4)':'rgba(0,0,0,0.4)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(cx-rad,cy);ctx.lineTo(cx+rad,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,cy-rad);ctx.lineTo(cx,cy+rad);ctx.stroke();}
if(showConstR){ctx.strokeStyle='rgba(100,150,200,0.25)';ctx.lineWidth=0.5;
const rVals=[0.2,0.5,1,2,5];
rVals.forEach(r=>{const center=r/(1+r),radius=1/(1+r);ctx.beginPath();ctx.arc(cx+center*rad,cy,radius*rad,0,2*Math.PI);ctx.stroke();});}
if(showConstX){ctx.strokeStyle='rgba(150,100,200,0.25)';ctx.lineWidth=0.5;
const xVals=[-2,-1,-0.5,0.5,1,2];
xVals.forEach(x=>{if(Math.abs(x)<0.01)return;const centerY=1/x,radius=1/Math.abs(x);ctx.beginPath();ctx.arc(cx+rad,cy-centerY*rad,radius*rad,x>0?Math.PI:0,x>0?0:Math.PI,x>0);ctx.stroke();});}}

function draw2D(){
const c=document.getElementById('c2d'),ctx=c.getContext('2d'),R=+document.getElementById('r2dv').value||+document.getElementById('r2d').value,sh=document.getElementById('sh2d').value,col=document.getElementById('col2d').value,lbl=document.getElementById('lbl2d').value,zm=+document.getElementById('zm2d').value,lblsz=+document.getElementById('lblsz2d').value,ptSz=+document.getElementById('ptSz2d').value;
const smithEnabled=document.getElementById('smith2d').checked,smithAlpha=+document.getElementById('smithA2d').value,smithRMode=document.getElementById('smithR2d').value;
const smithGrid=document.getElementById('smithGrid2d').checked,smithConstR=document.getElementById('smithCircR2d').checked,smithConstX=document.getElementById('smithArcX2d').checked;
const cx=c.width/2,cy=c.height/2,sc=(c.width/2)/(R*1.15)*zm,smithRad=(c.width/2-40)*zm;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
if(smithEnabled){drawSmithGrid(ctx,cx,cy,smithRad,smithGrid,smithConstR,smithConstX);ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,smithRad,0,2*Math.PI);ctx.stroke();}
else{ctx.strokeStyle=gridC();ctx.lineWidth=1;for(let i=-Math.ceil(R);i<=Math.ceil(R);i++){ctx.beginPath();ctx.moveTo(cx+i*sc,0);ctx.lineTo(cx+i*sc,c.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,cy+i*sc);ctx.lineTo(c.width,cy+i*sc);ctx.stroke();}ctx.strokeStyle=bordC();ctx.lineWidth=2;if(sh==='circle'){ctx.beginPath();ctx.arc(cx,cy,R*sc,0,2*Math.PI);ctx.stroke();}else if(sh==='square'){ctx.strokeRect(cx-R*sc,cy-R*sc,2*R*sc,2*R*sc);}else if(sh==='both'){ctx.strokeRect(cx-R*sc,cy-R*sc,2*R*sc,2*R*sc);ctx.strokeStyle='rgba(255,136,0,0.8)';ctx.beginPath();ctx.arc(cx,cy,R*sc,0,2*Math.PI);ctx.stroke();}}
pts2d=enum2D(R,sh);
const conn=document.getElementById('conn2d').value,connOp=+document.getElementById('connOp2d').value;
if(conn!=='none'&&!smithEnabled){ctx.lineWidth=1;const primPts=pts2d.filter(p=>p.p);
if(conn==='gcd1'){ctx.strokeStyle=`rgba(0,217,255,${connOp})`;for(let i=0;i<primPts.length;i++)for(let j=i+1;j<primPts.length;j++){const p1=primPts[i],p2=primPts[j],d=Math.hypot(p1.x-p2.x,p1.y-p2.y);if(d<=2){ctx.beginPath();ctx.moveTo(cx+p1.x*sc,cy-p1.y*sc);ctx.lineTo(cx+p2.x*sc,cy-p2.y*sc);ctx.stroke();}}}
else if(conn==='same'){const byGcd={};pts2d.forEach(p=>{if(!byGcd[p.g])byGcd[p.g]=[];byGcd[p.g].push(p);});Object.keys(byGcd).forEach(g=>{const ps=byGcd[g];ctx.strokeStyle=`hsla(${g*60},100%,50%,${connOp})`;for(let i=0;i<ps.length;i++)for(let j=i+1;j<ps.length;j++){const p1=ps[i],p2=ps[j],d=Math.hypot(p1.x-p2.x,p1.y-p2.y);if(d<=2){ctx.beginPath();ctx.moveTo(cx+p1.x*sc,cy-p1.y*sc);ctx.lineTo(cx+p2.x*sc,cy-p2.y*sc);ctx.stroke();}}});}
else if(conn==='radial'){ctx.strokeStyle=`rgba(255,215,0,${connOp})`;for(const p of primPts){ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+p.x*sc,cy-p.y*sc);ctx.stroke();}}
else if(conn==='diagonal'){ctx.strokeStyle=`rgba(150,100,255,${connOp})`;const diag=pts2d.filter(p=>Math.abs(p.x)===Math.abs(p.y));for(let i=0;i<diag.length;i++)for(let j=i+1;j<diag.length;j++){const p1=diag[i],p2=diag[j];if(Math.abs(p1.x-p2.x)<=2){ctx.beginPath();ctx.moveTo(cx+p1.x*sc,cy-p1.y*sc);ctx.lineTo(cx+p2.x*sc,cy-p2.y*sc);ctx.stroke();}}}}
let prim=0,inCircCount=0,outCircCount=0;const gcds=pts2d.map(p=>p.g);
for(let idx=0;idx<pts2d.length;idx++){const pt=pts2d[idx];if(pt.p)prim++;if(sh==='both'){if(pt.inCircle)inCircCount++;else outCircCount++;}
let px,py;
if(smithEnabled){const theta=Math.atan2(pt.y,pt.x);const dist=Math.sqrt(pt.x*pt.x+pt.y*pt.y);let r=1;if(smithRMode==='index')r=1+(idx/pts2d.length)*2;else if(smithRMode==='dist')r=0.5+dist/(R*2);const sm=smithTransform(r,theta,smithAlpha);px=cx+sm.x*smithRad;py=cy-sm.y*smithRad;}
else{px=cx+pt.x*sc;py=cy-pt.y*sc;}
let clr;if(col==='gcd')clr={1:'#00d9ff',2:'#64c8ff',3:'#9664ff'}[pt.g]||'#ff6496';
else if(col==='dist'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`hsl(${Math.floor((1-d)*240)},100%,50%)`;}
else if(col==='prim')clr=pt.p?'#00d9ff':'#ff6496';
else if(col==='rainbow'){const ang=Math.atan2(pt.y,pt.x);clr=`hsl(${Math.floor((ang+Math.PI)/(2*Math.PI)*360)},100%,50%)`;}
else if(col==='quadres'){const n2=(pt.x*pt.x+pt.y*pt.y)%Math.max(2,Math.ceil(R)),isQR=n2===0||[...Array(Math.ceil(R))].some((_,i)=>(i*i)%Math.max(2,Math.ceil(R))===n2);clr=isQR?'#ffd700':'#9664ff';}
else if(col==='primality'){const prod=Math.abs(pt.x*pt.y),isPr=prod>1&&[...Array(Math.floor(Math.sqrt(prod))+1)].every((_,i)=>i<2||prod%i!==0);clr=prod<=1?'#64c8ff':isPr?'#00ff88':'#ff6496';}
else if(col==='moddist'){const md=Math.min(Math.abs(pt.x),Math.abs(pt.y));clr=`hsl(${Math.floor(md/R*300)},100%,50%)`;}
else if(col==='symmetry'){const sym=Math.abs(Math.abs(pt.x)-Math.abs(pt.y));clr=sym===0?'#ffd700':`hsl(${Math.floor(sym/R*240)},80%,50%)`;}
else if(col==='heatmap'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=d<.25?'#00008b':d<.5?'#00d9ff':d<.75?'#ffff00':'#ff0000';}
else if(col==='divisibility'){const dc=[...Array(pt.g)].filter((_,i)=>i>0&&pt.g%i===0).length+1;clr=`hsl(${dc*40},100%,50%)`;}
else if(col==='discrete'){const cols=['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000075','#808080'];clr=cols[(pt.g-1)%cols.length];}
else if(col==='fire'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=d<.33?`rgb(${Math.floor(d*3*255)},0,0)`:d<.66?`rgb(255,${Math.floor((d-.33)*3*255)},0)`:`rgb(255,${Math.floor(128+(d-.66)*3*127)},${Math.floor((d-.66)*3*255)})`;}
else if(col==='plasma'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`rgb(${Math.floor(13+d*230)},${Math.floor(8+d*92+Math.sin(d*Math.PI)*100)},${Math.floor(135+d*80-d*d*150)})`;}
else if(col==='viridis'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`rgb(${Math.floor(68+d*187)},${Math.floor(1+d*206)},${Math.floor(84-d*50+d*d*100)})`;}
else if(col==='ocean'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`rgb(${Math.floor(d*100)},${Math.floor(50+d*150)},${Math.floor(100+d*155)})`;}
else clr=pt.p?'#00d9ff':'#ff6496';
if(sh==='both'&&!pt.inCircle){clr=isDark()?'rgba(255,100,150,0.4)':'rgba(200,50,100,0.4)';}
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(px,py,ptSz,0,2*Math.PI);ctx.fill();
if(lbl==='coords'){ctx.fillStyle=isDark()?'rgba(0,217,255,0.9)':'rgba(0,102,204,0.9)';ctx.font=`bold ${lblsz}px Arial`;ctx.textAlign='center';ctx.fillText(`(${pt.x},${pt.y})`,px,py-7*zm);}
else if(lbl==='gcd'){ctx.fillStyle=isDark()?'rgba(0,217,255,0.9)':'rgba(0,102,204,0.9)';ctx.font=`bold ${lblsz}px Arial`;ctx.textAlign='center';ctx.fillText(pt.g,px,py-7*zm);}}
if(smithEnabled){ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';ctx.fillText('Smith Chart: Œì = (z-1)/(z+1)',10,20);ctx.fillText(`Œ± = ${smithAlpha}¬∞`,10,35);}
const tot=pts2d.length,th=theory(R,2),err=Math.abs(prim-th),relE=th>0?err/th*100:0,z2=zeta(2);
if(sh==='both'){legend('al2d','Square + Circle Comparison',[['In Circle',inCircCount,'#ff8c00'],['Outside',outCircCount,'#9664ff'],['Circle Ratio',fmt(100*inCircCount/tot)+'%','#ff8c00']]);
document.getElementById('st2d').innerHTML='';}
else{legend('al2d',smithEnabled?'Smith Chart':'2D Lattice',[['1/Œ∂(2) Pred',fmt(tot/z2),'#9664ff'],['Theory',fmt(th),'#ff8c00'],['Error',fmt(err),'#ff006e']]);
document.getElementById('st2d').innerHTML='';}
const gcdDist={};gcds.forEach(g=>{gcdDist[g]=(gcdDist[g]||0)+1;});const gcdKeys=Object.keys(gcdDist).sort((a,b)=>+a-+b);
const baselRatio=z2>0?(prim/tot)/(1/z2):0;
document.getElementById('stats2dLive').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00d9ff">${R}</div><div style="font-size:.75rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#ffd700">${tot}</div><div style="font-size:.75rem;color:var(--txt2)">TOTAL POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00ff88">${prim}</div><div style="font-size:.75rem;color:var(--txt2)">PRIMITIVE</div></div>
</div>
${sh==='both'?`<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Square vs Circle Comparison</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>In Circle:</span><span style="color:#ff8c00;font-weight:bold">${inCircCount}</span>
<span>Outside Circle:</span><span style="color:#9664ff;font-weight:bold">${outCircCount}</span>
<span>Circle Ratio:</span><span style="color:#ff8c00">${fmt(100*inCircCount/tot)}%</span>
<span>œÄ/4 ‚âà:</span><span style="color:#9664ff">${fmt(Math.PI/4*100)}%</span>
<span>Difference:</span><span style="color:${Math.abs(inCircCount/tot-Math.PI/4)<0.05?'#00ff88':'#ff6496'}">${fmt(Math.abs(100*inCircCount/tot-Math.PI/4*100))}%</span>
</div>
</div>`:''}
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Shape:</span><span style="color:var(--txt)">${sh==='circle'?'Circle':sh==='square'?'Square':'Both'}</span>
<span>Color Mode:</span><span style="color:var(--txt)">${col}</span>
<span>Zoom Level:</span><span style="color:var(--txt)">${zm}x</span>
<span>Point Size:</span><span style="color:var(--txt)">${ptSz}px</span>
${smithEnabled?`<span>Smith Chart:</span><span style="color:#00ff88">ON (Œ±=${smithAlpha}¬∞)</span>`:`<span>Smith Chart:</span><span style="color:#ff6496">OFF</span>`}
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Basel Problem Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Coprime Density:</span><span style="color:#ffd700;font-weight:bold">${fmt(100*prim/tot)}%</span>
<span>Basel Limit (6/œÄ¬≤):</span><span style="color:#9664ff">${fmt(100/z2)}%</span>
<span>Ratio to Basel:</span><span style="color:${baselRatio>0.95&&baselRatio<1.05?'#00ff88':'#ff8c00'}">${fmt(baselRatio*100)}%</span>
<span>Predicted Count:</span><span style="color:#9664ff">${fmt(tot/z2)}</span>
<span>Theory (2D):</span><span style="color:#ff8c00">${fmt(th)}</span>
<span>Abs Error:</span><span style="color:${err<5?'#00ff88':'#ff6496'}">${fmt(err)}</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">GCD Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Min GCD:</span><span style="color:var(--txt)">${Math.min(...gcds)}</span>
<span>Max GCD:</span><span style="color:var(--txt)">${Math.max(...gcds)}</span>
<span>Avg GCD:</span><span style="color:var(--txt)">${fmt(gcds.reduce((a,b)=>a+b,0)/tot)}</span>
<span>Unique GCDs:</span><span style="color:var(--txt)">${gcdKeys.length}</span>
</div>
<div style="margin-top:8px;font-size:.75rem">
${gcdKeys.slice(0,6).map(g=>`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:${+g===1?'#ffd700':+g===2?'#00d9ff':'#9664ff'};color:#000;font-weight:bold">GCD=${g}: ${gcdDist[g]}</span>`).join('')}
${gcdKeys.length>6?'<span style="color:var(--txt2)">...</span>':''}
</div>
</div>
<div>
<strong style="color:var(--acc)">Quick Properties</strong>
<div style="margin-top:6px;font-size:.8rem;line-height:1.6">
‚Ä¢ Area covered: ${sh==='circle'?`œÄR¬≤ ‚âà ${fmt(Math.PI*R*R)}`:`(2R+1)¬≤ = ${(2*Math.ceil(R)+1)**2}`}<br>
‚Ä¢ Points per unit area: ${fmt(tot/(sh==='circle'?Math.PI*R*R:(2*R+1)**2))}<br>
‚Ä¢ Primitive per unit: ${fmt(prim/(sh==='circle'?Math.PI*R*R:(2*R+1)**2))}<br>
‚Ä¢ Œ∂(2) = œÄ¬≤/6 ‚âà ${fmt(z2)}
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);for(let idx=0;idx<pts2d.length;idx++){const pt=pts2d[idx];let px,py;if(smithEnabled){const theta=Math.atan2(pt.y,pt.x);const dist=Math.sqrt(pt.x*pt.x+pt.y*pt.y);let r=1;if(smithRMode==='index')r=1+(idx/pts2d.length)*2;else if(smithRMode==='dist')r=0.5+dist/(R*2);const sm=smithTransform(r,theta,smithAlpha);px=cx+sm.x*smithRad;py=cy-sm.y*smithRad;}else{px=cx+pt.x*sc;py=cy-pt.y*sc;}if(Math.hypot(mx-px,my-py)<12){const theta=Math.atan2(pt.y,pt.x);const sm=smithEnabled?smithTransform(1,theta,smithAlpha):{x:0,y:0};modal('2D Point Analysis',[['Coordinates',`(${pt.x}, ${pt.y})`],['GCD(x,y)',pt.g],['Primitive',pt.p?'Yes':'No'],['Distance',Math.sqrt(pt.x*pt.x+pt.y*pt.y)],['Œ∏ (radians)',theta.toFixed(4)],smithEnabled?['Œì (Smith)',`${sm.x.toFixed(4)} + ${sm.y.toFixed(4)}i`]:['Norm',pt.x*pt.x+pt.y*pt.y]]);break;}}};}
function exp2D(){const c=document.getElementById('c2d');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='mobius_2d.png';a.click();});}
function csv2D(){let s='x,y,gcd,primitive\n';for(const p of pts2d)s+=`${p.x},${p.y},${p.g},${p.p}\n`;dl(s,'mobius_2d.csv');}

// Comprehensive screenshot helper
function extractDashboardData(dashId){
const dash=document.getElementById(dashId);if(!dash)return{cards:[],sections:[]};
const cards=[],sections=[];
dash.querySelectorAll('[style*="grid-template-columns:repeat(3"]>div').forEach(card=>{
const val=card.querySelector('div:first-child');
const lbl=card.querySelector('div:last-child');
if(val&&lbl)cards.push({value:val.textContent,label:lbl.textContent,color:val.style.color||'#00d9ff'});
});
dash.querySelectorAll('[style*="border-bottom"]').forEach(sec=>{
const title=sec.querySelector('strong');
const items=[];
sec.querySelectorAll('[style*="grid-template-columns:1fr 1fr"]>span').forEach((span,i,arr)=>{
if(i%2===0&&arr[i+1])items.push({key:span.textContent,val:arr[i+1].textContent,color:arr[i+1].style.color||'inherit'});
});
if(title)sections.push({title:title.textContent,items});
});
return{cards,sections};
}

function renderDashboard(ctx,data,x,y,w,isDk){
let cy=y;const pad=15,colW=w/3-pad;
// Cards
if(data.cards.length>0){
data.cards.forEach((card,i)=>{
const cx=x+i*(colW+pad);
ctx.fillStyle=isDk?'#1a1f35':'#f0f0f0';
ctx.fillRect(cx,cy,colW,55);
ctx.fillStyle=card.color;ctx.font='bold 20px Segoe UI';ctx.textAlign='center';
ctx.fillText(card.value,cx+colW/2,cy+28);
ctx.fillStyle=isDk?'#8090b0':'#666';ctx.font='10px Segoe UI';
ctx.fillText(card.label,cx+colW/2,cy+45);
});
cy+=70;
}
ctx.textAlign='left';
// Sections
data.sections.forEach(sec=>{
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 12px Segoe UI';
ctx.fillText(sec.title,x,cy);cy+=18;
const cols=2,itemW=w/cols;
sec.items.forEach((item,i)=>{
const ix=x+(i%cols)*itemW,iy=cy+Math.floor(i/cols)*16;
ctx.fillStyle=isDk?'#8090b0':'#555';ctx.font='11px Segoe UI';
ctx.fillText(item.key,ix,iy);
ctx.fillStyle=item.color!=='inherit'?item.color:(isDk?'#e0e0e0':'#222');
ctx.fillText(item.val,ix+95,iy);
});
cy+=Math.ceil(sec.items.length/cols)*16+15;
});
return cy;
}

async function screenshot2D(){
const c=document.getElementById('c2d'),dashData=extractDashboardData('stats2dLive');
const R=document.getElementById('r2dv').value,sh=document.getElementById('sh2d').value;
const scale=2,pad=30,dashH=280;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
// Title
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`2D Lattice Points ‚Äî R=${R}, Shape: ${sh}`,out.width/scale/2,pad);
// Canvas
ctx.drawImage(c,pad,pad+25,c.width,c.height);
// Dashboard
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
// Footer
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='mobius_2d_complete.png';a.click();},'image/png',1.0);}

async function screenshot3D(){
const c=document.getElementById('c3d'),dashData=extractDashboardData('stats3dLive');
const R=document.getElementById('r3dv').value;
const scale=2,pad=30,dashH=300;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`3D Ball Lattice Points ‚Äî R=${R}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='mobius_3d_complete.png';a.click();},'image/png',1.0);}

async function screenshotGaus(){
const c=document.getElementById('cgaus'),dashData=extractDashboardData('gausLiveStats');
const R=document.getElementById('rgausv').value,col=document.getElementById('colGaus').value;
const scale=2,pad=30,dashH=320;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Gaussian Integers ‚Ñ§[i] ‚Äî R=${R}, Color: ${col}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='gaussian_complete.png';a.click();},'image/png',1.0);}

function draw3D(){
const c=document.getElementById('c3d'),ctx=c.getContext('2d'),R=+document.getElementById('r3dv').value||+document.getElementById('r3d').value,col=document.getElementById('col3d').value,vm=document.getElementById('vm3d').value,zm=+document.getElementById('zm3d').value,ps=+document.getElementById('ps3d').value;
const smithEnabled=document.getElementById('smith3d').checked,smithAlpha=+document.getElementById('smithA3d').value,smithRMode=document.getElementById('smithR3d').value;
const smithGrid=document.getElementById('smithGrid3d').checked,smithConstR=document.getElementById('smithCircR3d').checked,smithConstX=document.getElementById('smithArcX3d').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cxS=c.width/2,cyS=c.height/2,smithRad=(c.width/2-40)*zm;
if(smithEnabled){drawSmithGrid(ctx,cxS,cyS,smithRad,smithGrid,smithConstR,smithConstX);ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cxS,cyS,smithRad,0,2*Math.PI);ctx.stroke();}
let rawPts=enum3D(R);
if(vm==='inv')rawPts=rawPts.map(pt=>{const n=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z);if(n>.1){const s=R*R/(n*n);return{x:pt.x*s,y:pt.y*s,z:pt.z*s,g:pt.g,p:pt.p};}return pt;});
const proj=rawPts.map((pt,idx)=>{let x=pt.x,y=pt.y,z=pt.z;
let y1=y*Math.cos(rx)-z*Math.sin(rx),z1=y*Math.sin(rx)+z*Math.cos(rx);y=y1;z=z1;
let x2=x*Math.cos(ry)+z*Math.sin(ry),z2=-x*Math.sin(ry)+z*Math.cos(ry);x=x2;z=z2;
let x3=x*Math.cos(rz)-y*Math.sin(rz),y3=x*Math.sin(rz)+y*Math.cos(rz);x=x3;y=y3;
let px,py;
if(smithEnabled){const theta=Math.atan2(y,x);const dist3d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z);let r=1;if(smithRMode==='index')r=1+(idx/rawPts.length)*2;else if(smithRMode==='dist')r=0.5+dist3d/(R*2);const sm=smithTransform(r,theta,smithAlpha);px=cxS+sm.x*smithRad;py=cyS-sm.y*smithRad;}
else{const fov=500,sc=fov/(z+fov/2);px=c.width/2+(x*sc*zm*15)+panX;py=c.height/2-(y*sc*zm*15)+panY;}
let clr;if(col==='gcd')clr={1:'#00d9ff',2:'#64c8ff',3:'#9664ff'}[pt.g]||'#ff6496';
else if(col==='dist'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`hsl(${Math.floor((1-d)*240)},100%,50%)`;}
else if(col==='prim')clr=pt.p?'#00d9ff':'#ff6496';
else if(col==='rainbow'){const ang=Math.atan2(pt.y,pt.x);clr=`hsl(${Math.floor((ang+Math.PI)/(2*Math.PI)*360)},100%,50%)`;}
else if(col==='quadres'){const n2=(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)%Math.max(2,Math.ceil(R)),isQR=n2===0||[...Array(Math.ceil(R))].some((_,i)=>(i*i)%Math.max(2,Math.ceil(R))===n2);clr=isQR?'#ffd700':'#9664ff';}
else if(col==='primality'){const prod=Math.abs(pt.x*pt.y*pt.z),isPr=prod>1&&[...Array(Math.floor(Math.sqrt(prod))+1)].every((_,i)=>i<2||prod%i!==0);clr=prod<=1?'#64c8ff':isPr?'#00ff88':'#ff6496';}
else if(col==='moddist'){const md=Math.min(Math.abs(pt.x),Math.abs(pt.y),Math.abs(pt.z));clr=`hsl(${Math.floor(md/R*300)},100%,50%)`;}
else if(col==='symmetry'){const vals=[Math.abs(pt.x),Math.abs(pt.y),Math.abs(pt.z)].sort((a,b)=>a-b),sym=vals[2]-vals[0];clr=sym===0?'#ffd700':`hsl(${Math.floor(sym/R*240)},80%,50%)`;}
else if(col==='heatmap'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=d<.25?'#00008b':d<.5?'#00d9ff':d<.75?'#ffff00':'#ff0000';}
else if(col==='divisibility'){const dc=[...Array(pt.g)].filter((_,i)=>i>0&&pt.g%i===0).length+1;clr=`hsl(${dc*40},100%,50%)`;}
else if(col==='discrete'){const cols=['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000075','#808080'];clr=cols[(pt.g-1)%cols.length];}
else if(col==='fire'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=d<.33?`rgb(${Math.floor(d*3*255)},0,0)`:d<.66?`rgb(255,${Math.floor((d-.33)*3*255)},0)`:`rgb(255,${Math.floor(128+(d-.66)*3*127)},${Math.floor((d-.66)*3*255)})`;}
else if(col==='plasma'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`rgb(${Math.floor(13+d*230)},${Math.floor(8+d*92+Math.sin(d*Math.PI)*100)},${Math.floor(135+d*80-d*d*150)})`;}
else if(col==='viridis'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`rgb(${Math.floor(68+d*187)},${Math.floor(1+d*206)},${Math.floor(84-d*50+d*d*100)})`;}
else if(col==='ocean'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`rgb(${Math.floor(d*100)},${Math.floor(50+d*150)},${Math.floor(100+d*155)})`;}
else clr=pt.p?'#00d9ff':'#ff6496';
const fov=500,sc=fov/(z+fov/2);
return{px,py,z,clr,sc:smithEnabled?1:sc*zm,g:pt.g,p:pt.p,ox:pt.x,oy:pt.y,oz:pt.z};});
proj.sort((a,b)=>a.z-b.z);
if(!smithEnabled){ctx.strokeStyle=gridC();ctx.lineWidth=1;
const seg=12;for(let lat=0;lat<seg;lat++)for(let lng=0;lng<seg;lng++){const lat1=(lat/seg)*Math.PI,lng1=(lng/seg)*2*Math.PI,lng2=((lng+1)/seg)*2*Math.PI;
const x1=R*Math.sin(lat1)*Math.cos(lng1),y1=R*Math.cos(lat1),z1=R*Math.sin(lat1)*Math.sin(lng1);
const x2=R*Math.sin(lat1)*Math.cos(lng2),y2=R*Math.cos(lat1),z2=R*Math.sin(lat1)*Math.sin(lng2);
const rot1=(p)=>{let x=p.x,y=p.y,z=p.z;let y1=y*Math.cos(rx)-z*Math.sin(rx),z1=y*Math.sin(rx)+z*Math.cos(rx);y=y1;z=z1;let x2=x*Math.cos(ry)+z*Math.sin(ry),z2=-x*Math.sin(ry)+z*Math.cos(ry);x=x2;z=z2;let x3=x*Math.cos(rz)-y*Math.sin(rz),y3=x*Math.sin(rz)+y*Math.cos(rz);return{x:x3,y:y3,z};};
const pr1=rot1({x:x1,y:y1,z:z1}),pr2=rot1({x:x2,y:y2,z:z2});
const fov=500,sc1=fov/(pr1.z+fov/2),sc2=fov/(pr2.z+fov/2);
const px1=c.width/2+pr1.x*sc1*zm*15+panX,py1=c.height/2-pr1.y*sc1*zm*15+panY;
const px2=c.width/2+pr2.x*sc2*zm*15+panX,py2=c.height/2-pr2.y*sc2*zm*15+panY;
ctx.beginPath();ctx.moveTo(px1,py1);ctx.lineTo(px2,py2);ctx.stroke();}}
for(const p of proj){ctx.fillStyle=p.clr;ctx.beginPath();ctx.arc(p.px,p.py,Math.max(1,ps*p.sc*10),0,2*Math.PI);ctx.fill();}
if(smithEnabled){ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';ctx.fillText('Smith Chart: Œì = (z-1)/(z+1)',10,20);ctx.fillText(`Œ± = ${smithAlpha}¬∞`,10,35);}
pts3d=proj;
const tot=rawPts.length,prim=rawPts.filter(p=>p.p).length,th=theory(R,3),z3=zeta(3);
legend('al3d',`${smithEnabled?'Smith Chart':'3D Ball'} ${vm==='inv'?'(Inverted)':''}`,[['1/Œ∂(3) Pred',fmt(tot/z3),'#9664ff'],['Theory',fmt(th),'#ff8c00']]);
document.getElementById('st3d').innerHTML='';
const gcd3dDist={};rawPts.forEach(p=>{gcd3dDist[p.g]=(gcd3dDist[p.g]||0)+1;});const gcd3dKeys=Object.keys(gcd3dDist).sort((a,b)=>+a-+b);
const basel3dRatio=z3>0?(prim/tot)/(1/z3):0;
const rotXdeg=Math.round(rx*180/Math.PI)%360,rotYdeg=Math.round(ry*180/Math.PI)%360,rotZdeg=Math.round(rz*180/Math.PI)%360;
document.getElementById('stats3dLive').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00d9ff">${R}</div><div style="font-size:.75rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#ffd700">${tot}</div><div style="font-size:.75rem;color:var(--txt2)">TOTAL POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00ff88">${prim}</div><div style="font-size:.75rem;color:var(--txt2)">PRIMITIVE</div></div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">View Settings</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>X-Rotation:</span><span style="color:#ff6496;font-weight:bold">${rotXdeg}¬∞</span>
<span>Y-Rotation:</span><span style="color:#00d9ff;font-weight:bold">${rotYdeg}¬∞</span>
<span>Z-Rotation:</span><span style="color:#ffd700;font-weight:bold">${rotZdeg}¬∞</span>
<span>Zoom Level:</span><span style="color:var(--txt)">${zm}x</span>
<span>View Mode:</span><span style="color:${vm==='inv'?'#ff8c00':'#00ff88'}">${vm==='inv'?'INVERTED':'Normal'}</span>
<span>Auto-Rotate:</span><span style="color:${anim3d?'#00ff88':'#ff6496'}">${anim3d?'ON':'OFF'}</span>
${smithEnabled?`<span>Smith Chart:</span><span style="color:#00ff88">ON (Œ±=${smithAlpha}¬∞)</span>`:`<span>Smith Chart:</span><span style="color:#ff6496">OFF</span>`}
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Basel Problem Analysis (3D)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Coprime Density:</span><span style="color:#ffd700;font-weight:bold">${fmt(100*prim/tot)}%</span>
<span>Basel Limit (1/Œ∂(3)):</span><span style="color:#9664ff">${fmt(100/z3)}%</span>
<span>Ratio to Basel:</span><span style="color:${basel3dRatio>0.9&&basel3dRatio<1.1?'#00ff88':'#ff8c00'}">${fmt(basel3dRatio*100)}%</span>
<span>Predicted Count:</span><span style="color:#9664ff">${fmt(tot/z3)}</span>
<span>Theory (3D):</span><span style="color:#ff8c00">${fmt(th)}</span>
<span>Abs Error:</span><span style="color:${Math.abs(prim-th)<10?'#00ff88':'#ff6496'}">${fmt(Math.abs(prim-th))}</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">GCD Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Min GCD:</span><span style="color:var(--txt)">${Math.min(...rawPts.map(p=>p.g))}</span>
<span>Max GCD:</span><span style="color:var(--txt)">${Math.max(...rawPts.map(p=>p.g))}</span>
<span>Unique GCDs:</span><span style="color:var(--txt)">${gcd3dKeys.length}</span>
</div>
<div style="margin-top:8px;font-size:.75rem">
${gcd3dKeys.slice(0,6).map(g=>`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:${+g===1?'#ffd700':+g===2?'#00d9ff':'#9664ff'};color:#000;font-weight:bold">GCD=${g}: ${gcd3dDist[g]}</span>`).join('')}
${gcd3dKeys.length>6?'<span style="color:var(--txt2)">...</span>':''}
</div>
</div>
<div>
<strong style="color:var(--acc)">Quick Properties</strong>
<div style="margin-top:6px;font-size:.8rem;line-height:1.6">
‚Ä¢ Volume: (4/3)œÄR¬≥ ‚âà ${fmt(4/3*Math.PI*R*R*R)}<br>
‚Ä¢ Points per unit vol: ${fmt(tot/(4/3*Math.PI*R*R*R))}<br>
‚Ä¢ Œ∂(3) ‚âà ${fmt(z3)} (Ap√©ry's constant)<br>
‚Ä¢ 1/Œ∂(3) ‚âà ${fmt(1/z3)} (coprime prob)
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);for(const p of[...proj].reverse())if(Math.hypot(mx-p.px,my-p.py)<10){const theta=Math.atan2(p.oy,p.ox);const sm=smithEnabled?smithTransform(1,theta,smithAlpha):{x:0,y:0};modal('3D Point Analysis',[['Position',`(${fmt(p.ox)}, ${fmt(p.oy)}, ${fmt(p.oz)})`],['GCD',p.g],['Primitive',p.p?'Yes':'No'],['Distance',Math.sqrt(p.ox*p.ox+p.oy*p.oy+p.oz*p.oz)],smithEnabled?['Œì (Smith)',`${sm.x.toFixed(4)} + ${sm.y.toFixed(4)}i`]:['Z-depth',p.z]]);break;}};}
let drag=false,rmd=false,lx,ly;
function syncRotInputs(){document.getElementById('rotX').value=Math.round(rx*180/Math.PI)%360;document.getElementById('rotY').value=Math.round(ry*180/Math.PI)%360;document.getElementById('rotZ').value=Math.round(rz*180/Math.PI)%360;document.getElementById('rotXr').value=Math.round(rx*180/Math.PI)%360;document.getElementById('rotYr').value=Math.round(ry*180/Math.PI)%360;document.getElementById('rotZr').value=Math.round(rz*180/Math.PI)%360;}
document.getElementById('c3d').onmousedown=e=>{if(e.button===0){drag=true;}else if(e.button===2){rmd=true;}lx=e.clientX;ly=e.clientY;e.preventDefault();};
document.getElementById('c3d').oncontextmenu=e=>e.preventDefault();
document.onmousemove=e=>{if(drag){ry+=(e.clientX-lx)*.01;rx+=(e.clientY-ly)*.01;lx=e.clientX;ly=e.clientY;syncRotInputs();draw3D();}else if(rmd){panX+=(e.clientX-lx);panY+=(e.clientY-ly);lx=e.clientX;ly=e.clientY;draw3D();}};
document.onmouseup=()=>{drag=false;rmd=false;};
document.getElementById('c3d').onwheel=e=>{const z=document.getElementById('zm3d');z.value=Math.max(.2,Math.min(5,+z.value+(e.deltaY>0?-.1:.1)));document.getElementById('zmv').textContent=z.value+'x';draw3D();e.preventDefault();};
setInterval(()=>{if(anim3d){ry+=.015;syncRotInputs();draw3D();}},50);
function csv3D(){let s='x,y,z,gcd,primitive\n';for(const p of enum3D(+document.getElementById('r3dv').value||+document.getElementById('r3d').value))s+=`${p.x},${p.y},${p.z},${p.g},${p.p}\n`;dl(s,'mobius_3d.csv');}

function runErr(){runErrNew();}

function runErrNew(){
const maxR=+document.getElementById('errRv').value||+document.getElementById('errR').value;
const sh=document.getElementById('errSh').value;
const step=+document.getElementById('errStep').value;
const theta=+document.getElementById('errTheta').value;
const showBounds=document.getElementById('errBounds').checked;
const useLog=document.getElementById('errLog').checked;
const compare=document.getElementById('errCompare').value;

const rs=[],totals=[],prims=[],ths=[],primThs=[],errs=[],normErrs=[],relEs=[];
D.err=[];

for(let r=step;r<=maxR;r+=step){
const pts=enum2D(r,sh);
const total=pts.length;
const prim=pts.filter(x=>x.p).length;
const th=sh==='circle'?Math.PI*r*r:(2*Math.floor(r)+1)**2;
const primTh=th/zeta(2);
const err=total-th;
const primErr=prim-primTh;
const normErr=r>0?err/Math.pow(r,theta):0;

rs.push(r);
totals.push(total);
prims.push(prim);
ths.push(th);
primThs.push(primTh);
errs.push(err);
normErrs.push(normErr);
relEs.push(th>0?Math.abs(err)/th*100:0);
D.err.push({r,total,prim,th,primTh,err,primErr,normErr,relE:th>0?Math.abs(err)/th*100:0,sqrtR:Math.abs(err)/Math.sqrt(r)});}

// Statistics
const meanErr=errs.reduce((a,b)=>a+b,0)/errs.length;
const rmsErr=Math.sqrt(errs.reduce((a,b)=>a+b*b,0)/errs.length);
const maxAbsErr=Math.max(...errs.map(Math.abs));
const minAbsErr=Math.min(...errs.map(Math.abs));

// Chart 1: Theory vs Actual
const traces1=[
{x:rs,y:ths,name:`Theory ${sh==='circle'?'œÄR¬≤':'(2R+1)¬≤'}`,mode:'lines',line:{color:'#ff8c00',width:3}},
{x:rs,y:totals,name:'Actual Total',mode:'markers',marker:{color:'#00d9ff',size:5}}
];
if(compare==='primitive'||compare==='both'){
traces1.push({x:rs,y:primThs,name:'Prim Theory',mode:'lines',line:{color:'#00ff88',width:2,dash:'dash'}});
traces1.push({x:rs,y:prims,name:'Primitive',mode:'markers',marker:{color:'#ffd700',size:4}});}
Plotly.newPlot('pe1',traces1,{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'Count',type:useLog?'log':'linear'}});
legend('ale1','Count Comparison',[['Max Total',Math.max(...totals),'#00d9ff'],['Max Prim',Math.max(...prims),'#ffd700']]);

// Chart 2: Absolute Error
const traces2=[{x:rs,y:errs,name:'Error',mode:'lines+markers',line:{color:'#ff006e',width:2},marker:{size:4}}];
if(showBounds){
traces2.push({x:rs,y:rs.map(r=>Math.sqrt(r)*2),name:'O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});
traces2.push({x:rs,y:rs.map(r=>-Math.sqrt(r)*2),name:'-O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});}
Plotly.newPlot('pe2',traces2,{...plo(),xaxis:{title:'R'},yaxis:{title:'Error N(R)-œÄR¬≤'}});
legend('ale2','Absolute Error',[['Max',fmt(maxAbsErr),'#ff006e'],['RMS',fmt(rmsErr),'#ff8c00']]);

// Chart 3: Relative Error %
Plotly.newPlot('pe3',[{x:rs,y:relEs,mode:'lines+markers',line:{color:'#00ff88',width:2},marker:{size:3}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'|Error|/Theory %',type:useLog?'log':'linear'}});
legend('ale3','Relative Error',[['Max %',fmt(Math.max(...relEs)),'#ff006e'],['Min %',fmt(Math.min(...relEs)),'#00ff88']]);

// Chart 4: Normalized Error
Plotly.newPlot('pe4',[
{x:rs,y:normErrs,name:`Error/R^${theta}`,mode:'lines+markers',line:{color:'#9664ff',width:2},marker:{size:3}},
{x:rs,y:rs.map(()=>0),mode:'lines',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'R'},yaxis:{title:`Error / R^${theta}`}});
legend('ale4','Normalized',[['Œ∏ =',theta,'#9664ff'],['Bounded?',Math.max(...normErrs.map(Math.abs))<10?'Yes':'No','#00ff88']]);

// Chart 5: Error histogram
const errBins=[],binSize=Math.max(1,Math.ceil(maxAbsErr/10));
for(let b=-10;b<=10;b++){const lo=b*binSize,hi=(b+1)*binSize;
errBins.push({bin:`${lo}`,count:errs.filter(e=>e>=lo&&e<hi).length});}
Plotly.newPlot('peHist',[{x:errBins.map(b=>b.bin),y:errBins.map(b=>b.count),type:'bar',marker:{color:errBins.map(b=>+b.bin>=0?'#00d9ff':'#ff006e')}}],{...plo(),xaxis:{title:'Error Range'},yaxis:{title:'Frequency'}});

// Live stats
document.getElementById('errLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxR}</div><div style="font-size:.7rem;color:var(--txt2)">MAX R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${D.err.length}</div><div style="font-size:.7rem;color:var(--txt2)">DATA POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${sh}</div><div style="font-size:.7rem;color:var(--txt2)">SHAPE</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Mean Error:</span><span style="color:#00d9ff">${fmt(meanErr)}</span>
<span>RMS Error:</span><span style="color:#ff8c00">${fmt(rmsErr)}</span>
<span>Max |Error|:</span><span style="color:#ff006e">${fmt(maxAbsErr)}</span>
<span>Min |Error|:</span><span style="color:#00ff88">${fmt(minAbsErr)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Normalized Analysis (Œ∏=${theta})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max |Err|/R^Œ∏:</span><span style="color:#9664ff">${fmt(Math.max(...normErrs.map(Math.abs)))}</span>
<span>Avg |Err|/‚àöR:</span><span style="color:#ffd700">${fmt(D.err.reduce((a,d)=>a+d.sqrtR,0)/D.err.length)}</span>
<span>Bounded:</span><span style="color:${Math.max(...normErrs.map(Math.abs))<20?'#00ff88':'#ff6496'}">${Math.max(...normErrs.map(Math.abs))<20?'Likely':'Unclear'}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Primitive Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Final Prim Count:</span><span style="color:#ffd700">${prims[prims.length-1]}</span>
<span>Theory P(R)/Œ∂(2):</span><span style="color:#ff8c00">${fmt(primThs[primThs.length-1])}</span>
<span>Prim Density:</span><span style="color:#00ff88">${fmt(100*prims[prims.length-1]/totals[totals.length-1])}%</span>
<span>6/œÄ¬≤ theory:</span><span style="color:#9664ff">${fmt(100/zeta(2))}%</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Observations</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Error oscillates around 0 (unbiased)<br>
‚Ä¢ |Error| grows roughly as O(R^0.5)<br>
‚Ä¢ Best known: O(R^0.63)<br>
‚Ä¢ Conjecture: O(R^0.5+Œµ)
</div>
</div>`;

// Table
document.getElementById('te').innerHTML='<tr><th>R</th><th>Theory</th><th>Actual</th><th>Primitive</th><th>Error</th><th>|Err|/‚àöR</th><th>Rel %</th></tr>'+
D.err.map(d=>`<tr onclick="modal('R=${d.r}',[['Total',${d.total}],['Primitive',${d.prim}],['Theory',${fmt(d.th)}],['Error',${fmt(d.err)}],['|Error|/‚àöR',${fmt(d.sqrtR)}],['Rel Error %',${fmt(d.relE)}]])" style="cursor:pointer;color:${Math.abs(d.err)<Math.sqrt(d.r)*2?'#00ff88':'inherit'}"><td>${fmt(d.r)}</td><td>${fmt(d.th)}</td><td>${d.total}</td><td>${d.prim}</td><td>${fmt(d.err)}</td><td>${fmt(d.sqrtR)}</td><td>${fmt(d.relE)}</td></tr>`).join('');}

function runErrConvergence(){
const Rs=[5,10,15,20,30,40,50,75,100];
const sqrtNorm=[];
for(const R of Rs){
const pts=enum2D(R,'circle');
const th=Math.PI*R*R;
const err=pts.length-th;
sqrtNorm.push({R,err,norm:Math.abs(err)/Math.sqrt(R)});}
Plotly.newPlot('pe4',[{x:Rs,y:sqrtNorm.map(d=>d.norm),mode:'lines+markers',line:{color:'#9664ff',width:2}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'|Error|/‚àöR'}});
legend('ale4','Convergence',[['Trend','~constant?','#9664ff']]);}

function csvErr(){let s='R,Theory,Total,Primitive,Error,NormErr,RelError%,SqrtR\n';for(const d of D.err)s+=`${d.r},${d.th},${d.total},${d.prim},${d.err},${d.normErr},${d.relE},${d.sqrtR}\n`;dl(s,'error.csv');}

function runDim(){const R=+document.getElementById('rdim').value;D.dim=[];for(let n=2;n<=7;n++){const v=vol(n),z=zeta(n),th=theory(R,n),prim=Math.round(th),err=Math.abs(prim-th);D.dim.push({n,v,z,th,prim,err});}
document.getElementById('tdimT').innerHTML='<tr><th>n</th><th>Vol(B_n)</th><th>Œ∂(n)</th><th>Theory</th><th>Computed</th><th>Error</th></tr>'+D.dim.map(d=>`<tr onclick="modal('Dimension ${d.n}',[['Volume',${d.v}],['Œ∂(${d.n})',${d.z}],['1/Œ∂(${d.n})',${1/d.z}],['Theory',${d.th}]])" style="cursor:pointer"><td>${d.n}</td><td>${fmt(d.v)}</td><td>${fmt(d.z)}</td><td>${fmt(d.th)}</td><td>${d.prim}</td><td>${fmt(d.err)}</td></tr>`).join('');
legend('aldim','Primitive Density 1/Œ∂(k)',D.dim.map(d=>[`n=${d.n}`,1/d.z,`hsl(${d.n*50},100%,50%)`]));}
function csvDim(){let s='n,Vol,Zeta,Theory,Computed,Error\n';for(const d of D.dim)s+=`${d.n},${d.v},${d.z},${d.th},${d.prim},${d.err}\n`;dl(s,'dimensions.csv');}

// M√∂bius function - heart of the sieve
function mobius(n){if(n===1)return 1;let cnt=0;for(let p=2;p*p<=n;p++){if(n%p===0){cnt++;n/=p;if(n%p===0)return 0;}}if(n>1)cnt++;return cnt%2===0?1:-1;}
function factorize(n){if(n===1)return '1';const f=[];for(let p=2;p*p<=n;p++){let e=0;while(n%p===0){e++;n/=p;}if(e>0)f.push(e>1?`${p}^${e}`:p);}if(n>1)f.push(n);return f.join('¬∑');}
function mertens(N){let m=0;for(let n=1;n<=N;n++)m+=mobius(n);return m;}

let mobData=[];
function drawMobius(){
const N=+document.getElementById('mobNv').value||+document.getElementById('mobN').value;
const viz=document.getElementById('mobViz').value,col=document.getElementById('mobCol').value;
const ptSz=+document.getElementById('mobPtSz').value;
const c=document.getElementById('cmob'),ctx=c.getContext('2d');
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
mobData=[];let M=0,sum1=0,cnt1=0,cnt0=0,cntM1=0;
for(let n=1;n<=N;n++){const mu=mobius(n);M+=mu;sum1+=mu/n;const sf=mu!==0;
if(mu===1)cnt1++;else if(mu===0)cnt0++;else cntM1++;
mobData.push({n,mu,M,sum1,sf,fac:factorize(n)});}
const cx=c.width/2,cy=c.height/2;
if(viz==='strip'){
const w=c.width-80,h=c.height-60,cols=Math.ceil(Math.sqrt(N*1.5)),rows=Math.ceil(N/cols);
const dx=w/cols,dy=h/rows;
ctx.font='bold 14px Segoe UI';ctx.fillStyle=isDark()?'#ffd700':'#cc8800';
ctx.fillText('Œº(n): Red=-1, Gray=0, Blue=+1',40,25);
for(let i=0;i<mobData.length;i++){const d=mobData[i],x=40+(i%cols)*dx,y=50+Math.floor(i/cols)*dy;
let clr;if(col==='classic')clr=d.mu===1?'#4ECDC4':d.mu===-1?'#FF6B6B':'#555';
else if(col==='prime'){const pf=factorize(d.n).split('¬∑').length;clr=d.mu===0?'#333':`hsl(${pf*60},80%,55%)`;}
else clr=d.sf?'#ffd700':'#333';
ctx.fillStyle=clr;ctx.fillRect(x,y,dx-1,dy-1);}}
else if(viz==='mertens'){
const maxM=Math.max(...mobData.map(d=>Math.abs(d.M)));
const w=c.width-80,h=c.height-80,scX=w/N,scY=(h/2)/(maxM||1);
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(40,cy);ctx.lineTo(c.width-40,cy);ctx.stroke();
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('M(x) = Œ£Œº(n) for n‚â§x',50,30);
ctx.fillText('0',25,cy+4);ctx.fillText(maxM+'',15,55);ctx.fillText(-maxM+'',15,c.height-45);
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
mobData.forEach((d,i)=>{const x=40+d.n*scX,y=cy-d.M*scY;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();
ctx.strokeStyle='rgba(255,100,100,0.5)';ctx.lineWidth=1;
ctx.beginPath();mobData.forEach((d,i)=>{const x=40+d.n*scX,bound=Math.sqrt(d.n);ctx.moveTo(x,cy-bound*scY);ctx.lineTo(x,cy+bound*scY);});ctx.stroke();}
else if(viz==='cumsum'){
const w=c.width-80,h=c.height-80,scX=w/N;
const vals=mobData.map(d=>d.sum1),minV=Math.min(...vals),maxV=Math.max(...vals);
const scY=h/(maxV-minV||1);
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('Œ£Œº(n)/n ‚Üí 0 as N‚Üí‚àû (equivalent to PNT)',50,30);
ctx.strokeStyle=gridC();ctx.beginPath();ctx.moveTo(40,c.height-40-(0-minV)*scY);ctx.lineTo(c.width-40,c.height-40-(0-minV)*scY);ctx.stroke();
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=2;
mobData.forEach((d,i)=>{const x=40+d.n*scX,y=c.height-40-(d.sum1-minV)*scY;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();}
else if(viz==='spiral'){
const maxR=Math.min(c.width,c.height)/2-30;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('Ulam-like spiral: Œº(n) values',50,30);
for(let i=0;i<mobData.length;i++){const d=mobData[i],ang=Math.sqrt(d.n)*2.4,r=Math.sqrt(d.n)/Math.sqrt(N)*maxR;
const x=cx+r*Math.cos(ang),y=cy+r*Math.sin(ang);
let clr=d.mu===1?'#4ECDC4':d.mu===-1?'#FF6B6B':'#333';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,ptSz/2,0,2*Math.PI);ctx.fill();}}
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='strip'){const w=c.width-80,cols=Math.ceil(Math.sqrt(N*1.5)),dx=w/cols,dy=(c.height-60)/Math.ceil(N/cols);
const col=Math.floor((mx-40)/dx),row=Math.floor((my-50)/dy),idx=row*cols+col;
if(idx>=0&&idx<mobData.length){const d=mobData[idx];modal('M√∂bius Analysis',[['n',d.n],['Œº(n)',d.mu],['M(n)',d.M],['Œ£Œº(k)/k',fmt(d.sum1)],['Factorization',d.fac],['Squarefree',d.sf?'Yes':'No']]);}}};
const sqfreeC=mobData.filter(d=>d.sf).length;
legend('almob','M√∂bius Statistics',[['Œ£Œº(n)/n',fmt(sum1),'#00ff88'],['M(N)',M,'#00d9ff']]);
Plotly.newPlot('pmobDist',[{x:['Œº=1','Œº=0','Œº=-1'],y:[cnt1,cnt0,cntM1],type:'bar',marker:{color:['#4ECDC4','#555','#FF6B6B']}}],{...plo(),xaxis:{title:'Œº(n) value'},yaxis:{title:'Count'}});
document.getElementById('mobLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#4ECDC4">${cnt1}</div><div style="font-size:.7rem;color:var(--txt2)">Œº(n)=+1</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#555">${cnt0}</div><div style="font-size:.7rem;color:var(--txt2)">Œº(n)=0</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#FF6B6B">${cntM1}</div><div style="font-size:.7rem;color:var(--txt2)">Œº(n)=-1</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>N:</span><span style="color:#ffd700;font-weight:bold">${N}</span>
<span>Mertens M(N):</span><span style="color:#00d9ff;font-weight:bold">${M}</span>
<span>Œ£Œº(n)/n:</span><span style="color:#00ff88;font-weight:bold">${fmt(sum1)}</span>
<span>|M(N)|/‚àöN:</span><span style="color:${Math.abs(M)/Math.sqrt(N)<1?'#00ff88':'#ff8c00'}">${fmt(Math.abs(M)/Math.sqrt(N))}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Squarefree Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Squarefree count:</span><span style="color:#ffd700">${sqfreeC}</span>
<span>Squarefree %:</span><span style="color:#00ff88">${fmt(100*sqfreeC/N)}%</span>
<span>Theory 6/œÄ¬≤:</span><span style="color:#9664ff">${fmt(600/Math.PI/Math.PI)}%</span>
<span>Non-squarefree:</span><span style="color:#ff6496">${cnt0}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Riemann Hypothesis Connection</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ RH ‚ü∫ M(x) = O(x^(¬Ω+Œµ)) for all Œµ>0<br>
‚Ä¢ Current bound: |M(N)|/‚àöN = ${fmt(Math.abs(M)/Math.sqrt(N))}<br>
‚Ä¢ Mertens conjecture |M(x)|<‚àöx is FALSE<br>
‚Ä¢ First counterexample: x ‚âà 10^16
</div>
</div>`;
document.getElementById('tmobT').innerHTML='<tr><th>n</th><th>Œº(n)</th><th>M(n)</th><th>Factorization</th><th>Squarefree</th></tr>'+
mobData.slice(0,100).map(d=>`<tr onclick="modal('n=${d.n}',[['Œº(${d.n})',${d.mu}],['M(${d.n})',${d.M}],['Factorization','${d.fac}'],['Squarefree','${d.sf?'Yes':'No'}']])" style="cursor:pointer;color:${d.mu===1?'#4ECDC4':d.mu===-1?'#FF6B6B':'#666'}"><td>${d.n}</td><td>${d.mu}</td><td>${d.M}</td><td>${d.fac}</td><td>${d.sf?'Yes':'No'}</td></tr>`).join('');}
function csvMob(){let s='n,mu,M,sumMuOverN,factorization,squarefree\n';for(const d of mobData)s+=`${d.n},${d.mu},${d.M},${d.sum1},"${d.fac}",${d.sf}\n`;dl(s,'mobius.csv');}
async function screenshotMob(){
const c=document.getElementById('cmob'),dashData=extractDashboardData('mobLiveStats');
const N=document.getElementById('mobNv').value,viz=document.getElementById('mobViz').value;
const scale=2,pad=30,dashH=300;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M√∂bius Function Œº(n) ‚Äî N=${N}, Mode: ${viz}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='mobius_function_complete.png';a.click();},'image/png',1.0);}

// Upgraded Dimension function
function gamma(n){if(n===1)return 1;if(n===0.5)return Math.sqrt(Math.PI);return(n-1)*gamma(n-1);}
function ballVol(n){return Math.pow(Math.PI,n/2)/gamma(n/2+1);}

function runDimNew(){
const maxD=+document.getElementById('dimMaxV').value||+document.getElementById('dimMax').value;
const R=+document.getElementById('rdimv').value||+document.getElementById('rdim').value;
const mode=document.getElementById('dimMode').value;
D.dim=[];const ns=[],zs=[],invZs=[],vols=[],comps=[];
let exactCount=0;

for(let n=2;n<=maxD;n++){
const v=ballVol(n),z=zeta(n),invZ=1/z,th=v*Math.pow(R,n)*invZ;
let computed=Math.round(th),err=0,method='theory';
if(mode==='full'||(mode==='hybrid'&&n<=5)){
if(n===2){let tot=0,prim=0;for(let x=-Math.ceil(R);x<=Math.ceil(R);x++)for(let y=-Math.ceil(R);y<=Math.ceil(R);y++)if(x*x+y*y<=R*R){tot++;if(gcdM(x,y)===1)prim++;}computed=prim;err=Math.abs(prim-th);method='exact';exactCount++;}
else if(n===3){let tot=0,prim=0;const m=Math.ceil(R);for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){tot++;if(gcdM(x,y,z)===1)prim++;}computed=prim;err=Math.abs(prim-th);method='exact';exactCount++;}
else if(n<=5&&R<=8){let tot=0,prim=0;const m=Math.min(Math.ceil(R),5);
(function en(dim,coords){if(coords.length===n){const s=coords.reduce((a,x)=>a+x*x,0);if(s<=R*R){tot++;if(gcdM(...coords)===1)prim++;}return;}for(let i=-m;i<=m;i++)en(dim,[...coords,i]);})(n,[]);
computed=prim;err=Math.abs(prim-th);method='exact';exactCount++;}}
ns.push(n);zs.push(z);invZs.push(invZ);vols.push(v*Math.pow(R,n));comps.push(computed);
D.dim.push({n,v,z,invZ,th,computed,err,method,volRn:v*Math.pow(R,n)});}

// Chart 1: Œ∂(n) convergence
Plotly.newPlot('pdimZeta',[
{x:ns,y:zs,mode:'lines+markers',name:'Œ∂(n)',line:{color:'#ff8c00',width:2},marker:{size:6}},
{x:ns,y:ns.map(()=>1),mode:'lines',name:'Limit=1',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'Dimension n'},yaxis:{title:'Œ∂(n)',range:[0.9,Math.max(...zs)+0.2]}});

// Chart 2: 1/Œ∂(n) density
Plotly.newPlot('pdimDens',[
{x:ns,y:invZs,mode:'lines+markers',name:'1/Œ∂(n)',line:{color:'#00ff88',width:2},marker:{size:6}},
{x:ns,y:ns.map(()=>1),mode:'lines',name:'Limit=1',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'Dimension n'},yaxis:{title:'1/Œ∂(n) = P(coprime)',range:[0.5,1.05]}});

// Chart 3: Volume
Plotly.newPlot('pdimVol',[
{x:ns,y:vols,mode:'lines+markers',name:'Vol(B‚Åø)¬∑R‚Åø',line:{color:'#9664ff',width:2},marker:{size:6}}
],{...plo(),xaxis:{title:'Dimension n'},yaxis:{title:'Volume¬∑R‚Åø',type:maxD>15?'log':'linear'}});

// Find special values
const maxVolIdx=vols.indexOf(Math.max(...vols));
const z2=zeta(2),z3=zeta(3),z4=zeta(4);

// Live stats
document.getElementById('dimLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxD}</div><div style="font-size:.7rem;color:var(--txt2)">MAX DIM</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${R}</div><div style="font-size:.7rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${mode}</div><div style="font-size:.7rem;color:var(--txt2)">MODE</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Œ∂ Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Œ∂(2) = œÄ¬≤/6:</span><span style="color:#ff8c00">${fmt(z2)}</span>
<span>Œ∂(3) Ap√©ry:</span><span style="color:#00d9ff">${fmt(z3)}</span>
<span>Œ∂(4) = œÄ‚Å¥/90:</span><span style="color:#9664ff">${fmt(z4)}</span>
<span>Œ∂(${maxD}):</span><span style="color:#ffd700">${fmt(zeta(maxD))}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Coprime Densities 1/Œ∂(n)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>1/Œ∂(2) = 6/œÄ¬≤:</span><span style="color:#00ff88">${fmt(1/z2)} (${fmt(100/z2)}%)</span>
<span>1/Œ∂(3):</span><span style="color:#00d9ff">${fmt(1/z3)} (${fmt(100/z3)}%)</span>
<span>1/Œ∂(${maxD}):</span><span style="color:#ffd700">${fmt(1/zeta(maxD))} (${fmt(100/zeta(maxD))}%)</span>
<span>Limit as n‚Üí‚àû:</span><span style="color:#00ff88">1 (100%)</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Volume Analysis (R=${R})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max Vol at n=:</span><span style="color:#9664ff">${ns[maxVolIdx]}</span>
<span>Max Vol value:</span><span style="color:#9664ff">${fmt(vols[maxVolIdx])}</span>
<span>Vol(B¬≤)¬∑R¬≤:</span><span style="color:#00d9ff">${fmt(vols[0])}</span>
<span>Vol(B${maxD})¬∑R^${maxD}:</span><span style="color:#ffd700">${fmt(vols[vols.length-1])}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Computation</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Dimensions:</span><span style="color:var(--txt)">${D.dim.length}</span>
<span>Exact computed:</span><span style="color:#00ff88">${exactCount}</span>
<span>Theory only:</span><span style="color:#ffd700">${D.dim.length-exactCount}</span>
<span>Total primitives:</span><span style="color:#00d9ff">${comps.reduce((a,b)=>a+b,0)}</span>
</div>
</div>`;

// Table
document.getElementById('tdimT').innerHTML='<tr><th>n</th><th>Vol(B‚Åø)</th><th>Œ∂(n)</th><th>1/Œ∂(n)</th><th>Computed</th><th>Error</th><th>Method</th></tr>'+
D.dim.map(d=>`<tr onclick="modal('Dimension ${d.n}',[['Vol(B${d.n})',${d.v}],['Vol√óR^${d.n}',${d.volRn}],['Œ∂(${d.n})',${d.z}],['1/Œ∂(${d.n})',${d.invZ}],['Theory',${d.th}],['Computed',${d.computed}],['Method','${d.method}']])" style="cursor:pointer"><td>${d.n}</td><td>${fmt(d.v)}</td><td>${fmt(d.z)}</td><td>${fmt(d.invZ)}</td><td>${d.computed}</td><td>${fmt(d.err)}</td><td style="color:${d.method==='exact'?'#00ff88':'#ffd700'}">${d.method}</td></tr>`).join('');}


function runSh(){runShNew();}

let shAnimId=null;
function runShNew(){
const R=+document.getElementById('rshv').value||+document.getElementById('rsh').value;
const maxK=+document.getElementById('shKv').value||+document.getElementById('shK').value;
const shape=document.getElementById('shShape').value;
const display=document.getElementById('shDisplay').value;
const colorMode=document.getElementById('shColor').value;
const sfOnly=document.getElementById('shSquarefree').checked;
const markPrimes=document.getElementById('shPrimes').checked;
const showZero=document.getElementById('shShowZero').checked;

const ks=[],cs=[],Ls=[],mus=[];
D.sh=[];
let cum=0,pos=0,neg=0,actualPrim=0;

// Compute actual primitive count for comparison
const pts=enum2D(R,shape);
actualPrim=pts.filter(p=>p.p).length;

for(let k=1;k<=maxK;k++){
if(R/k<0.5)break;
const L=enum2D(R/k,shape).length;
const m=mob(k);
const c=m*L;
cum+=c;
if(c>0)pos+=c;
if(c<0)neg+=c;
const sf=isSquarefree(k);
const isPrime=k>1&&factorizeN(k).indexOf('¬∑')===-1&&factorizeN(k).indexOf('^')===-1;
ks.push(k);
cs.push(c);
Ls.push(L);
mus.push(m);
D.sh.push({k,m,L,c,cum,sf,isPrime,pctTotal:0,fac:factorizeN(k)});}

// Calculate percentages
const absTotal=D.sh.reduce((a,d)=>a+Math.abs(d.c),0);
D.sh.forEach(d=>{d.pctTotal=absTotal>0?100*Math.abs(d.c)/absTotal:0;});

// Filter for display
const filtered=sfOnly?D.sh.filter(d=>d.sf):showZero?D.sh:D.sh.filter(d=>d.m!==0);

// Chart 1: Main contributions
let barColors;
if(colorMode==='sign')barColors=filtered.map(d=>d.c>0?'#00ff88':d.c<0?'#ff006e':'#666');
else if(colorMode==='mobius')barColors=filtered.map(d=>d.m===1?'#00d9ff':d.m===-1?'#ff8c00':'#666');
else barColors=filtered.map(d=>`hsl(${Math.abs(d.c)/Math.max(...cs.map(Math.abs))*240},70%,50%)`);

const traces1=[];
if(display==='contrib'||display==='both'){
traces1.push({x:filtered.map(d=>d.k),y:filtered.map(d=>d.c),name:'Œº(k)¬∑L(R/k)',type:'bar',marker:{color:barColors}});}
if(display==='cumul'||display==='both'){
traces1.push({x:filtered.map(d=>d.k),y:filtered.map(d=>d.cum),name:'Cumulative',mode:'lines+markers',line:{color:'#ffd700',width:2},yaxis:display==='both'?'y2':'y'});}

const layout1={...plo(),xaxis:{title:'Shell k'},yaxis:{title:'Contribution'}};
if(display==='both')layout1.yaxis2={title:'Cumulative',overlaying:'y',side:'right'};
Plotly.newPlot('psh',traces1,layout1);
legend('alsh','Shell Decomposition',[['Positive',pos,'#00ff88'],['Negative',Math.abs(neg),'#ff006e'],['Net (Œ£)',cum,'#ffd700']]);

// Chart 2: Cumulative convergence
Plotly.newPlot('pshCum',[
{x:D.sh.map(d=>d.k),y:D.sh.map(d=>d.cum),name:'Running Sum',mode:'lines+markers',line:{color:'#00d9ff',width:2}},
{x:D.sh.map(d=>d.k),y:D.sh.map(()=>actualPrim),name:'Actual P(R)',mode:'lines',line:{color:'#ffd700',dash:'dash'}}
],{...plo(),xaxis:{title:'Max Shell k'},yaxis:{title:'Œ£Œº(k)¬∑L(R/k)'}});

// Chart 3: Magnitude chart
Plotly.newPlot('pshMag',[{x:D.sh.map(d=>d.k),y:D.sh.map(d=>Math.abs(d.c)),type:'bar',marker:{color:D.sh.map(d=>d.sf?'#00ff88':'#9664ff')}}],{...plo(),xaxis:{title:'k'},yaxis:{title:'|Œº(k)¬∑L(R/k)|'}});

// Chart 4: M√∂bius function
Plotly.newPlot('pshMob',[{x:D.sh.map(d=>d.k),y:D.sh.map(d=>d.m),type:'bar',marker:{color:D.sh.map(d=>d.m===1?'#00d9ff':d.m===-1?'#ff006e':'#666')}}],{...plo(),xaxis:{title:'k'},yaxis:{title:'Œº(k)',range:[-1.5,1.5]}});

// Chart 5: Shell sizes
Plotly.newPlot('pshL',[{x:D.sh.map(d=>d.k),y:D.sh.map(d=>d.L),mode:'lines+markers',line:{color:'#ff8c00',width:2}}],{...plo(),xaxis:{title:'k'},yaxis:{title:'L(R/k)'}});

// Live stats
const nonZeroCount=D.sh.filter(d=>d.m!==0).length;
const sfCount=D.sh.filter(d=>d.sf).length;
const primeCount=D.sh.filter(d=>d.isPrime).length;
const convergenceErr=Math.abs(cum-actualPrim);

document.getElementById('shLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${R}</div><div style="font-size:.7rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${cum}</div><div style="font-size:.7rem;color:var(--txt2)">SHELL SUM</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${actualPrim}</div><div style="font-size:.7rem;color:var(--txt2)">ACTUAL P(R)</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Shape:</span><span style="color:var(--txt)">${shape}</span>
<span>Max k:</span><span style="color:var(--txt)">${maxK}</span>
<span>Active Shells:</span><span style="color:var(--txt)">${D.sh.length}</span>
<span>Non-zero Œº:</span><span style="color:var(--txt)">${nonZeroCount}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Contribution Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Positive sum:</span><span style="color:#00ff88">+${pos}</span>
<span>Negative sum:</span><span style="color:#ff006e">${neg}</span>
<span>Net (M√∂bius):</span><span style="color:#ffd700">${cum}</span>
<span>Actual P(R):</span><span style="color:#00d9ff">${actualPrim}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Convergence</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Error |Œ£ - P(R)|:</span><span style="color:${convergenceErr<5?'#00ff88':'#ff8c00'}">${convergenceErr}</span>
<span>Rel Error:</span><span style="color:var(--txt)">${actualPrim>0?fmt(100*convergenceErr/actualPrim)+'%':'‚Äî'}</span>
<span>k=1 contrib:</span><span style="color:#00d9ff">${D.sh[0]?.c||0}</span>
<span>k=2 contrib:</span><span style="color:#ff006e">${D.sh[1]?.c||0}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Shell Composition</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Squarefree k:</span><span style="color:#00ff88">${sfCount}</span>
<span>Prime k:</span><span style="color:#9664ff">${primeCount}</span>
<span>Œº(k)=0 shells:</span><span style="color:#666">${D.sh.length-nonZeroCount}</span>
<span>Largest |contrib|:</span><span style="color:#ffd700">${Math.max(...D.sh.map(d=>Math.abs(d.c)))}</span>
</div>
</div>`;

// Table
document.getElementById('tshT').innerHTML='<tr><th>k</th><th>Œº(k)</th><th>L(R/k)</th><th>Contribution</th><th>Cumulative</th><th>% of |Total|</th><th>SF?</th></tr>'+
D.sh.map(d=>`<tr onclick="modal('Shell k=${d.k}',[['Œº(${d.k})',${d.m}],['L(R/${d.k})',${d.L}],['Contribution',${d.c}],['Cumulative',${d.cum}],['Factorization','${d.fac}'],['Squarefree',${d.sf}]])" style="cursor:pointer;color:${d.m===0?'#666':d.c>0?'#00ff88':'#ff006e'}"><td>${d.k}${d.isPrime?' ‚òÖ':''}</td><td>${d.m}</td><td>${d.L}</td><td>${d.c>0?'+':''}${d.c}</td><td>${d.cum}</td><td>${fmt(d.pctTotal)}%</td><td>${d.sf?'‚úì':''}</td></tr>`).join('');}

function animateShells(){
const R=+document.getElementById('rshv').value,maxK=+document.getElementById('shKv').value;
if(shAnimId)cancelAnimationFrame(shAnimId);
let step=1;
function frame(){
document.getElementById('shKv').value=step;
document.getElementById('shK').value=Math.min(50,step);
runShNew();
if(step<maxK){step++;shAnimId=setTimeout(()=>requestAnimationFrame(frame),200);}else{shAnimId=null;}}
frame();}

function csvSh(){let s='k,mu,L,Contribution,Cumulative,PctTotal,Squarefree,Factorization\n';for(const d of D.sh)s+=`${d.k},${d.m},${d.L},${d.c},${d.cum},${d.pctTotal},${d.sf},"${d.fac}"\n`;dl(s,'shells.csv');}

function isSquarefree(n){if(n<=1)return n===1;for(let p=2;p*p<=n;p++)if(n%(p*p)===0)return false;return true;}
function factorizeN(n){if(n<=1)return n===1?'1':'0';let s='',m=n;for(let p=2;p*p<=m;p++){let e=0;while(m%p===0){m/=p;e++;}if(e>0)s+=(s?'¬∑':'')+p+(e>1?'^'+e:'');}if(m>1)s+=(s?'¬∑':'')+m;return s||'1';}

function runGCD(){
const R=+document.getElementById('rgcdv').value||+document.getElementById('rgcd').value;
const shape=document.getElementById('gcdShape').value;
const topN=+document.getElementById('gcdTopN').value;
const m=Math.ceil(R)+1,gc={},all=[];

for(let x=-m;x<=m;x++){
for(let y=-m;y<=m;y++){
const inRegion=shape==='circle'?(x*x+y*y<=R*R):(Math.abs(x)<=R&&Math.abs(y)<=R);
if(inRegion){const g=gcdM(x,y);gc[g]=(gc[g]||0)+1;all.push(g);}}}

const sorted=Object.entries(gc).sort((a,b)=>+a[0]-+b[0]);
const tot=all.length;
const gcd1=gc[1]||0;
const z2=zeta(2);

// Compute statistics
const mean=all.reduce((a,b)=>a+b,0)/tot;
const sortedAll=[...all].sort((a,b)=>a-b);
const median=sortedAll[Math.floor(tot/2)];
const mode=sorted.reduce((a,b)=>b[1]>a[1]?b:a)[0];
const maxGcd=Math.max(...all);
const variance=all.reduce((a,b)=>a+(b-mean)**2,0)/tot;
const stddev=Math.sqrt(variance);

// Squarefree analysis
const sfCount=all.filter(g=>isSquarefree(g)).length;
const sfGcds=sorted.filter(([g])=>isSquarefree(+g));

// Prepare data
D.gcd=sorted.map(([g,c])=>{
const pct=100*c/tot;
return{g:+g,count:c,pct,sf:isSquarefree(+g),fac:factorizeN(+g)};});

// Cumulative
let cumul=0;
D.gcd.forEach(d=>{cumul+=d.pct;d.cumul=cumul;});

// Theory: P(gcd=k) ‚âà 1/(k¬≤¬∑Œ∂(2)) for primitive scaling
D.gcd.forEach(d=>{d.theory=100/(d.g*d.g*z2);});

// Charts
const top=D.gcd.slice(0,topN);
Plotly.newPlot('pgcd1',[{x:top.map(d=>d.g),y:top.map(d=>d.count),type:'bar',marker:{color:top.map(d=>d.g===1?'#ffd700':d.sf?'#00d9ff':'#9664ff')}}],{...plo(),xaxis:{title:'GCD'},yaxis:{title:'Count'}});
legend('algcd1','GCD Distribution',[['GCD=1',gcd1,'#ffd700'],['Total',tot,'#00d9ff']]);

// Cumulative chart
Plotly.newPlot('pgcd2',[{x:D.gcd.slice(0,30).map(d=>d.g),y:D.gcd.slice(0,30).map(d=>d.cumul),mode:'lines+markers',line:{color:'#00ff88',width:2}}],{...plo(),xaxis:{title:'GCD ‚â§ k'},yaxis:{title:'Cumulative %',range:[0,105]}});
legend('algcd2','Cumulative',[['50% at GCD‚â§',D.gcd.find(d=>d.cumul>=50)?.g||'‚Äî','#00ff88']]);

// Theory comparison
Plotly.newPlot('pgcd3',[
{x:top.map(d=>d.g),y:top.map(d=>d.pct),name:'Actual %',type:'bar',marker:{color:'#00d9ff'}},
{x:top.map(d=>d.g),y:top.map(d=>d.theory),name:'Theory %',type:'scatter',mode:'markers',marker:{color:'#ff8c00',size:10,symbol:'diamond'}}
],{...plo(),xaxis:{title:'GCD'},yaxis:{title:'Percentage'},barmode:'group'});

// Squarefree chart
const sfData=D.gcd.filter(d=>d.sf).slice(0,15);
const nonSfData=D.gcd.filter(d=>!d.sf).slice(0,10);
Plotly.newPlot('pgcdSF',[
{x:sfData.map(d=>d.g),y:sfData.map(d=>d.count),name:'Squarefree',type:'bar',marker:{color:'#00ff88'}},
{x:nonSfData.map(d=>d.g),y:nonSfData.map(d=>d.count),name:'Non-SF',type:'bar',marker:{color:'#ff6496'}}
],{...plo(),xaxis:{title:'GCD'},yaxis:{title:'Count'},barmode:'group'});

// Divisibility by small primes
const div2=all.filter(g=>g%2===0).length;
const div3=all.filter(g=>g%3===0).length;
const div5=all.filter(g=>g%5===0).length;
const div6=all.filter(g=>g%6===0).length;
Plotly.newPlot('pgcdDiv',[{x:['2|gcd','3|gcd','5|gcd','6|gcd'],y:[div2,div3,div5,div6],type:'bar',marker:{color:['#00d9ff','#ff8c00','#9664ff','#00ff88']}}],{...plo(),yaxis:{title:'Count'}});

// Live stats
document.getElementById('gcdLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${gcd1}</div><div style="font-size:.7rem;color:var(--txt2)">GCD = 1</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${tot}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(100*gcd1/tot)}%</div><div style="font-size:.7rem;color:var(--txt2)">COPRIME %</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius R:</span><span style="color:var(--txt)">${R}</span>
<span>Shape:</span><span style="color:var(--txt)">${shape}</span>
<span>Unique GCDs:</span><span style="color:var(--txt)">${sorted.length}</span>
<span>Max GCD:</span><span style="color:var(--txt)">${maxGcd}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Mean GCD:</span><span style="color:#00d9ff">${fmt(mean)}</span>
<span>Median GCD:</span><span style="color:#ff8c00">${median}</span>
<span>Mode GCD:</span><span style="color:#ffd700">${mode}</span>
<span>Std Dev:</span><span style="color:#9664ff">${fmt(stddev)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Theory Comparison</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Actual P(gcd=1):</span><span style="color:#ffd700">${fmt(100*gcd1/tot)}%</span>
<span>Theory 6/œÄ¬≤:</span><span style="color:#ff8c00">${fmt(100/z2)}%</span>
<span>Error:</span><span style="color:${Math.abs(gcd1/tot-1/z2)<0.02?'#00ff88':'#ff6496'}">${fmt(Math.abs(100*gcd1/tot-100/z2))}%</span>
<span>Ratio:</span><span style="color:#00d9ff">${fmt((gcd1/tot)/(1/z2))}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Squarefree Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>SF GCDs:</span><span style="color:#00ff88">${sfCount} (${fmt(100*sfCount/tot)}%)</span>
<span>Theory 6/œÄ¬≤:</span><span style="color:#ff8c00">${fmt(100/z2)}%</span>
<span>Non-SF GCDs:</span><span style="color:#ff6496">${tot-sfCount}</span>
<span>Unique SF values:</span><span style="color:#9664ff">${sfGcds.length}</span>
</div>
</div>`;

// Table
document.getElementById('tgcdT').innerHTML='<tr><th>GCD</th><th>Count</th><th>Percent</th><th>Cumulative</th><th>Theory</th><th>SF?</th><th>Factors</th></tr>'+
D.gcd.slice(0,50).map(d=>`<tr onclick="modal('GCD ${d.g}',[['Count',${d.count}],['Percent','${fmt(d.pct)}%'],['Cumulative','${fmt(d.cumul)}%'],['Theory','${fmt(d.theory)}%'],['Squarefree',${d.sf}],['Factorization','${d.fac}']])" style="cursor:pointer;color:${d.g===1?'#ffd700':d.sf?'inherit':'#9664ff'}"><td>${d.g}</td><td>${d.count}</td><td>${fmt(d.pct)}%</td><td>${fmt(d.cumul)}%</td><td>${fmt(d.theory)}%</td><td>${d.sf?'‚úì':''}</td><td>${d.fac}</td></tr>`).join('');}

function runGCDConvergence(){
const Rs=[5,10,15,20,25,30,40,50];
const densities=[];
for(const R of Rs){
let tot=0,gcd1=0;const m=Math.ceil(R);
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=R*R){tot++;if(gcdM(x,y)===1)gcd1++;}
densities.push({R,density:gcd1/tot,theory:1/zeta(2)});}
Plotly.newPlot('pgcd3',[
{x:Rs,y:densities.map(d=>d.density*100),name:'Actual',mode:'lines+markers',line:{color:'#00d9ff',width:2}},
{x:Rs,y:densities.map(d=>d.theory*100),name:'6/œÄ¬≤',mode:'lines',line:{color:'#ff8c00',dash:'dash'}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'P(gcd=1) %',range:[58,65]}});}

function csvGCD(){let s='GCD,Count,Percent,Cumulative,Theory,Squarefree,Factorization\n';for(const d of D.gcd)s+=`${d.g},${d.count},${d.pct},${d.cumul},${d.theory},${d.sf},"${d.fac}"\n`;dl(s,'gcd.csv');}

function isGausPrime(a,b){
const n2=a*a+b*b;if(n2===0)return false;if(n2===1)return false;
if(a===0){const bAbs=Math.abs(b);if(bAbs<2)return false;if(bAbs===2)return false;if(bAbs%4===3){for(let i=2;i*i<=bAbs;i++)if(bAbs%i===0)return false;return true;}return false;}
if(b===0){const aAbs=Math.abs(a);if(aAbs<2)return false;if(aAbs===2)return false;if(aAbs%4===3){for(let i=2;i*i<=aAbs;i++)if(aAbs%i===0)return false;return true;}return false;}
for(let i=2;i*i<=n2;i++)if(n2%i===0)return false;return true;
}

function drawGaus(){
const c=document.getElementById('cgaus'),ctx=c.getContext('2d');
const R=+document.getElementById('rgausv').value||+document.getElementById('rgaus').value;
const zm=+document.getElementById('zmgaus').value,ptSz=+document.getElementById('ptszgaus').value;
const col=document.getElementById('colGaus').value,filt=document.getElementById('filtGaus').value;
const lbl=document.getElementById('lblGaus').value;
const showNormC=document.getElementById('gausNormC').checked,showAxes=document.getElementById('gausAxes').checked;
const showGrid=document.getElementById('gausGrid').checked,showUnits=document.getElementById('gausUnits').checked;
const showAssoc=document.getElementById('gausAssoc').checked,showConj=document.getElementById('gausConj').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,sc=(c.width/2)/(R*1.15)*zm,nc={};
gausP=[];let tot=0,prim=0,gprimeC=0;
const quadC={0:0,1:0,2:0,3:0};
for(let a=-Math.ceil(R);a<=Math.ceil(R);a++)for(let b=-Math.ceil(R);b<=Math.ceil(R);b++){
const n2=a*a+b*b;if(Math.sqrt(n2)<=R){
const g=gcdM(a,b),isPrim=g===1,isGP=isGausPrime(a,b);
const arg=Math.atan2(b,a);
const quad=a>=0?(b>=0?0:3):(b>=0?1:2);
const isUnit=(a===1&&b===0)||(a===-1&&b===0)||(a===0&&b===1)||(a===0&&b===-1);
if(filt==='prim'&&!isPrim)continue;
if(filt==='gprime'&&!isGP)continue;
if(filt==='units'&&isUnit)continue;
tot++;if(isPrim)prim++;if(isGP)gprimeC++;
nc[n2]=(nc[n2]||0)+1;quadC[quad]++;
gausP.push({a,b,n2,g,isPrim,isGP,arg,quad,isUnit});}}
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=-Math.ceil(R);i<=Math.ceil(R);i++){ctx.beginPath();ctx.moveTo(cx+i*sc,0);ctx.lineTo(cx+i*sc,c.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,cy-i*sc);ctx.lineTo(c.width,cy-i*sc);ctx.stroke();}}
if(showAxes){ctx.strokeStyle=isDark()?'rgba(255,215,0,0.6)':'rgba(200,150,0,0.6)';ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(0,cy);ctx.lineTo(c.width,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,0);ctx.lineTo(cx,c.height);ctx.stroke();
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 12px Segoe UI';
ctx.fillText('Re',c.width-25,cy-8);ctx.fillText('Im',cx+8,15);}
if(showNormC){ctx.strokeStyle='rgba(150,100,255,0.3)';ctx.lineWidth=1;
for(let n=1;n<=R*R;n++){const r=Math.sqrt(n);if(r<=R){ctx.beginPath();ctx.arc(cx,cy,r*sc,0,2*Math.PI);ctx.stroke();}}}
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,R*sc,0,2*Math.PI);ctx.stroke();
if(showConj){ctx.strokeStyle='rgba(0,217,255,0.15)';ctx.lineWidth=1;
for(const p of gausP){if(p.b>0){ctx.beginPath();ctx.moveTo(cx+p.a*sc,cy-p.b*sc);ctx.lineTo(cx+p.a*sc,cy+p.b*sc);ctx.stroke();}}}
if(showAssoc){ctx.strokeStyle='rgba(255,136,0,0.2)';ctx.lineWidth=1;
for(const p of gausP){if(p.a>0&&p.b>=0){const pts=[[p.a,p.b],[-p.a,p.b],[-p.a,-p.b],[p.a,-p.b],[p.b,p.a],[-p.b,p.a],[-p.b,-p.a],[p.b,-p.a]];
ctx.beginPath();pts.forEach((q,i)=>{if(i===0)ctx.moveTo(cx+q[0]*sc,cy-q[1]*sc);else ctx.lineTo(cx+q[0]*sc,cy-q[1]*sc);});ctx.closePath();ctx.stroke();}}}
for(const p of gausP){
let clr;
if(col==='gcd')clr=p.isPrim?'#ffd700':'#555';
else if(col==='gprime')clr=p.isGP?'#00ff88':p.isPrim?'#ffd700':'#444';
else if(col==='norm')clr=`hsl(${(p.n2/R/R*300)%360},80%,60%)`;
else if(col==='arg')clr=`hsl(${((p.arg+Math.PI)/(2*Math.PI)*360)},85%,55%)`;
else if(col==='quadrant'){const qc=['#FF6B6B','#4ECDC4','#FFE66D','#95E1D3'];clr=qc[p.quad];}
else if(col==='parity')clr=(p.a+p.b)%2===0?'#00d9ff':'#ff6496';
else if(col==='sum2sq')clr=p.n2>0?'#00ff88':'#666';
else clr=p.isPrim?'#00d9ff':'#64c8ff';
if(showUnits&&p.isUnit){ctx.strokeStyle='#ff006e';ctx.lineWidth=3;ctx.beginPath();ctx.arc(cx+p.a*sc,cy-p.b*sc,ptSz+4,0,2*Math.PI);ctx.stroke();}
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(cx+p.a*sc,cy-p.b*sc,p.isGP?ptSz+1:ptSz,0,2*Math.PI);ctx.fill();}
if(lbl!=='none'){ctx.font='9px Segoe UI';ctx.textAlign='center';ctx.fillStyle=isDark()?'rgba(255,255,255,0.8)':'rgba(0,0,0,0.8)';
for(const p of gausP){let t='';if(lbl==='val')t=p.b>=0?`${p.a}+${p.b}i`:`${p.a}${p.b}i`;
else if(lbl==='norm')t=p.n2;else if(lbl==='arg')t=Math.round(p.arg*180/Math.PI)+'¬∞';
ctx.fillText(t,cx+p.a*sc,cy-p.b*sc-ptSz-3);}}
const z2=zeta(2),baselRatio=tot>0?(prim/tot)/(1/z2):0;
const norms=Object.entries(nc).sort((a,b)=>+a[0]-+b[0]).slice(0,25);
const uniqueNorms=Object.keys(nc).length;
const sum2sqCount=Object.keys(nc).filter(n=>+n>0).length;
legend('algaus1','‚Ñ§[i] Theory',[['1/Œ∂(2) Pred',fmt(tot/z2),'#9664ff'],['Basel 6/œÄ¬≤',fmt(100/z2)+'%','#ff8c00']]);
legend('algaus2','Norm Analysis',[['Unique |z|¬≤',uniqueNorms,'#9664ff'],['Max Norm¬≤',Math.max(...gausP.map(p=>p.n2)),'#ff8c00']]);
Plotly.newPlot('pgaus',[{x:norms.map(x=>+x[0]),y:norms.map(x=>x[1]),type:'bar',marker:{color:norms.map((_,i)=>`hsl(${i*12},70%,55%)`)}}],{...plo(),xaxis:{title:'|z|¬≤ (Norm¬≤)'},yaxis:{title:'Count'}});
document.getElementById('stgaus').innerHTML='';
document.getElementById('gausLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${tot}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${prim}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMITIVE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${gprimeC}</div><div style="font-size:.7rem;color:var(--txt2)">GAUSS PRIMES</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius:</span><span style="color:var(--txt)">${R}</span>
<span>Zoom:</span><span style="color:var(--txt)">${zm}x</span>
<span>Color:</span><span style="color:var(--txt)">${col}</span>
<span>Filter:</span><span style="color:var(--txt)">${filt}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Basel Problem (2D)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Prim Density:</span><span style="color:#ffd700;font-weight:bold">${fmt(100*prim/tot)}%</span>
<span>6/œÄ¬≤ ‚âà:</span><span style="color:#9664ff">${fmt(100/z2)}%</span>
<span>Ratio:</span><span style="color:${baselRatio>.95&&baselRatio<1.05?'#00ff88':'#ff8c00'}">${fmt(baselRatio*100)}%</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Quadrant Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span style="color:#FF6B6B">Q1 (a‚â•0,b‚â•0):</span><span>${quadC[0]}</span>
<span style="color:#4ECDC4">Q2 (a<0,b‚â•0):</span><span>${quadC[1]}</span>
<span style="color:#FFE66D">Q3 (a<0,b<0):</span><span>${quadC[2]}</span>
<span style="color:#95E1D3">Q4 (a‚â•0,b<0):</span><span>${quadC[3]}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Norm Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Unique Norms:</span><span style="color:#9664ff">${uniqueNorms}</span>
<span>Max |z|¬≤:</span><span>${Math.max(...gausP.map(p=>p.n2))}</span>
<span>Sum-2-Sq Norms:</span><span style="color:#00ff88">${sum2sqCount}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Gaussian Prime Facts</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ p‚â°1(mod 4): splits as œÄ¬∑œÄÃÑ<br>
‚Ä¢ p‚â°3(mod 4): stays prime in ‚Ñ§[i]<br>
‚Ä¢ 2 = -i(1+i)¬≤ (ramifies)<br>
‚Ä¢ Units: {1, -1, i, -i}
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
for(const p of gausP){const px=cx+p.a*sc,py=cy-p.b*sc;
if(Math.hypot(mx-px,my-py)<12){
const assoc=`¬±${Math.abs(p.a)}¬±${Math.abs(p.b)}i, ¬±${Math.abs(p.b)}¬±${Math.abs(p.a)}i`;
modal('Gaussian Integer Analysis',[
['Value',p.b>=0?`${p.a} + ${p.b}i`:`${p.a} - ${Math.abs(p.b)}i`],
['Norm |z|',fmt(Math.sqrt(p.n2))],
['Norm¬≤ |z|¬≤',p.n2],
['Argument Œ∏',fmt(p.arg*180/Math.PI)+'¬∞'],
['GCD(Re,Im)',p.g],
['Primitive',p.isPrim?'Yes':'No'],
['Gaussian Prime',p.isGP?'Yes':'No'],
['Unit',p.isUnit?'Yes':'No'],
['Quadrant','Q'+(p.quad+1)],
['Associates',assoc]
]);break;}}};}
function expGaus(){const c=document.getElementById('cgaus');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='gaussian.png';a.click();});}
function csvGaus(){let s='Re,Im,Norm2,GCD,Primitive,GaussianPrime,Argument,Quadrant,Unit\n';for(const p of gausP)s+=`${p.a},${p.b},${p.n2},${p.g},${p.isPrim},${p.isGP},${p.arg},${p.quad},${p.isUnit}\n`;dl(s,'gaussian.csv');}

function runCirc(){runCircNew();}

function runCircNew(){
const maxR=+document.getElementById('circRv').value||+document.getElementById('circR').value;
const step=+document.getElementById('circStep').value;
const showBounds=document.getElementById('circBounds').checked;
const primOnly=document.getElementById('circPrim').checked;

const rs=[],cs=[],ps=[],ths=[],es=[],sqrtEs=[],normEs=[];
D.circ=[];

for(let r=step;r<=maxR;r+=step){
let cnt=0,prim=0;
const m=Math.ceil(r)+1;
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=r*r){cnt++;if(gcdM(x,y)===1)prim++;}
const th=Math.PI*r*r,err=cnt-th;
rs.push(r);cs.push(cnt);ps.push(prim);ths.push(th);es.push(err);
sqrtEs.push(r>0?err/Math.sqrt(r):0);
normEs.push(r>0?Math.abs(err)/Math.pow(r,0.5):0);
D.circ.push({r,cnt,prim,th,err,sqrtR:err/Math.sqrt(r),normR:Math.abs(err)/Math.pow(r,0.5),relE:th>0?Math.abs(err)/th*100:0});}

// Statistics
const maxErr=Math.max(...es);
const minErr=Math.min(...es);
const avgErr=es.reduce((a,b)=>a+b,0)/es.length;
const maxNorm=Math.max(...normEs);

// Chart 1: Count vs Theory
Plotly.newPlot('pc1',[
{x:rs,y:ths,name:'œÄR¬≤',mode:'lines',line:{color:'#ff8c00',width:3}},
{x:rs,y:cs,name:'N(R)',mode:'markers',marker:{color:'#00d9ff',size:5}},
{x:rs,y:ps,name:'Primitive',mode:'markers',marker:{color:'#ffd700',size:4,symbol:'diamond'}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'Count'}});
legend('alc1','Lattice Count',[['N(max)',cs[cs.length-1],'#00d9ff'],['œÄR¬≤',fmt(ths[ths.length-1]),'#ff8c00']]);

// Chart 2: Error r(R)
const traces2=[{x:rs,y:es,name:'r(R)=N(R)-œÄR¬≤',mode:'lines+markers',line:{color:'#ff006e',width:2},marker:{size:3}}];
if(showBounds){
traces2.push({x:rs,y:rs.map(r=>2*Math.sqrt(r)),name:'O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});
traces2.push({x:rs,y:rs.map(r=>-2*Math.sqrt(r)),name:'-O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});}
Plotly.newPlot('pc2',traces2,{...plo(),xaxis:{title:'R'},yaxis:{title:'r(R) = N(R) - œÄR¬≤'}});
legend('alc2','Error r(R)',[['Max',fmt(maxErr),'#ff006e'],['Min',fmt(minErr),'#00ff88']]);

// Chart 3: Normalized error
Plotly.newPlot('pc3',[
{x:rs,y:sqrtEs,name:'r(R)/‚àöR',mode:'lines+markers',line:{color:'#9664ff',width:2},marker:{size:3}},
{x:rs,y:rs.map(()=>0),mode:'lines',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'R'},yaxis:{title:'r(R)/‚àöR'}});
legend('alc3','Normalized',[['Max |r|/‚àöR',fmt(maxNorm),'#9664ff']]);

// Chart 4: Absolute error magnitude
Plotly.newPlot('pcircAbs',[{x:rs,y:es.map(Math.abs),mode:'lines+markers',line:{color:'#00ff88',width:2}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'|r(R)|'}});

// Chart 5: Running average
const runAvg=sqrtEs.map((e,i)=>sqrtEs.slice(0,i+1).reduce((a,b)=>a+b,0)/(i+1));
Plotly.newPlot('pcircAvg',[{x:rs,y:runAvg,mode:'lines',line:{color:'#ffd700',width:2}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'Running Avg r(R)/‚àöR'}});

// Live stats
document.getElementById('circLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxR}</div><div style="font-size:.7rem;color:var(--txt2)">MAX R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${cs[cs.length-1]}</div><div style="font-size:.7rem;color:var(--txt2)">N(R)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(ths[ths.length-1])}</div><div style="font-size:.7rem;color:var(--txt2)">œÄR¬≤</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max r(R):</span><span style="color:#ff006e">${fmt(maxErr)}</span>
<span>Min r(R):</span><span style="color:#00ff88">${fmt(minErr)}</span>
<span>Avg r(R):</span><span style="color:#00d9ff">${fmt(avgErr)}</span>
<span>Max |r|/‚àöR:</span><span style="color:#9664ff">${fmt(maxNorm)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Final Values (R=${maxR})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>N(R):</span><span style="color:#00d9ff">${cs[cs.length-1]}</span>
<span>œÄR¬≤:</span><span style="color:#ff8c00">${fmt(ths[ths.length-1])}</span>
<span>r(R):</span><span style="color:${es[es.length-1]>=0?'#00ff88':'#ff006e'}">${fmt(es[es.length-1])}</span>
<span>Primitive:</span><span style="color:#ffd700">${ps[ps.length-1]}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Gauss Circle Bounds</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Trivial: |r(R)| = O(R)<br>
‚Ä¢ Best known: |r(R)| = O(R^0.6298...)<br>
‚Ä¢ Conjectured: |r(R)| = O(R^(1/2+Œµ))<br>
‚Ä¢ Œ©-result: r(R) = Œ©(R^0.5 (log R)^0.25)
</div>
</div>`;

// Table
document.getElementById('tcircT').innerHTML='<tr><th>R</th><th>N(R)</th><th>œÄR¬≤</th><th>r(R)</th><th>r(R)/‚àöR</th><th>|r(R)|/R^0.5</th></tr>'+
D.circ.map(d=>`<tr onclick="modal('R=${d.r}',[['N(R)',${d.cnt}],['œÄR¬≤',${fmt(d.th)}],['r(R)',${fmt(d.err)}],['Primitive',${d.prim}],['r(R)/‚àöR',${fmt(d.sqrtR)}]])" style="cursor:pointer"><td>${fmt(d.r)}</td><td>${d.cnt}</td><td>${fmt(d.th)}</td><td>${fmt(d.err)}</td><td>${fmt(d.sqrtR)}</td><td>${fmt(d.normR)}</td></tr>`).join('');}

function drawCircleViz(){
const R=+document.getElementById('circVizR').value;
const c=document.getElementById('ccirc'),ctx=c.getContext('2d');
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,scale=Math.min(cx,cy-30)/(R+1);
// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=-R;i<=R;i++){ctx.beginPath();ctx.moveTo(cx+i*scale,cy-R*scale);ctx.lineTo(cx+i*scale,cy+R*scale);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx-R*scale,cy+i*scale);ctx.lineTo(cx+R*scale,cy+i*scale);ctx.stroke();}
// Circle
ctx.strokeStyle='#ff8c00';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,R*scale,0,2*Math.PI);ctx.stroke();
// Points
let cnt=0,prim=0;
for(let x=-Math.ceil(R);x<=Math.ceil(R);x++)for(let y=-Math.ceil(R);y<=Math.ceil(R);y++)if(x*x+y*y<=R*R){
cnt++;const isPrim=gcdM(x,y)===1;if(isPrim)prim++;
ctx.fillStyle=isPrim?'#ffd700':'#00d9ff';
ctx.beginPath();ctx.arc(cx+x*scale,cy-y*scale,3,0,2*Math.PI);ctx.fill();}
// Title
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Gauss Circle: R=${R}, N(R)=${cnt}, œÄR¬≤=${fmt(Math.PI*R*R)}, r(R)=${fmt(cnt-Math.PI*R*R)}`,cx,25);
ctx.fillText(`Primitive: ${prim} (${fmt(100*prim/cnt)}%)`,cx,c.height-10);}

function csvCirc(){let s='R,Count,Primitive,Theory,Error,SqrtR,NormR,RelError\n';for(const d of D.circ)s+=`${d.r},${d.cnt},${d.prim},${d.th},${d.err},${d.sqrtR},${d.normR},${d.relE}\n`;dl(s,'circle.csv');}

// Euler product approximation
function eulerProduct(s,maxP){let prod=1;for(let p=2;p<=maxP;p++){let isPrime=true;for(let i=2;i*i<=p;i++)if(p%i===0){isPrime=false;break;}if(isPrime)prod*=1/(1-Math.pow(p,-s));}return prod;}

// Monte Carlo sampling for high dimensions
function monteCarloDensity(k,R,samples){let inside=0,coprime=0;
for(let s=0;s<samples;s++){
const coords=[];for(let i=0;i<k;i++)coords.push(Math.floor(Math.random()*(2*R+1))-R);
const r2=coords.reduce((a,x)=>a+x*x,0);
if(r2<=R*R){inside++;if(gcdM(...coords)===1)coprime++;}}
return{tot:inside,prim:coprime,emp:inside>0?coprime/inside:0};}

function runDensNew(){
const R=+document.getElementById('densR').value;
const maxK=+document.getElementById('densMaxK').value;
const mode=document.getElementById('densMode').value;
const samples=+document.getElementById('densSample').value;
const ks=[],ths=[],emps=[],zetaVals=[],eulerVals=[];
D.dens=[];

for(let k=2;k<=maxK;k++){
let tot=0,prim=0,emp=0;
const z=zeta(k),th=1/z;

if(mode==='theory'){
emp=th;tot=0;prim=0;
}else if(mode==='sample'||k>4){
const mc=monteCarloDensity(k,R,samples);
tot=mc.tot;prim=mc.prim;emp=mc.emp;
}else{
// Exact computation for k<=4
const m=Math.ceil(R);
if(k===2){for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=R*R){tot++;if(gcdM(x,y)===1)prim++;}}
else if(k===3){for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){tot++;if(gcdM(x,y,z)===1)prim++;}}
else if(k===4){const sm=Math.min(6,m);for(let a=-sm;a<=sm;a++)for(let b=-sm;b<=sm;b++)for(let c=-sm;c<=sm;c++)for(let d=-sm;d<=sm;d++)if(a*a+b*b+c*c+d*d<=R*R){tot++;if(gcdM(a,b,c,d)===1)prim++;}}
emp=tot>0?prim/tot:th;}

const euler=eulerProduct(k,100);
ks.push(k);ths.push(th);emps.push(emp);zetaVals.push(z);eulerVals.push(euler);
D.dens.push({k,z,th,emp,tot,prim,err:Math.abs(emp-th),relE:th>0?Math.abs(emp-th)/th*100:0,euler});}

// Chart 1: Density convergence
Plotly.newPlot('pdens1',[
{x:ks,y:ths,name:'Theory 1/Œ∂(k)',mode:'lines+markers',line:{color:'#ff8c00',width:3},marker:{size:8}},
{x:ks,y:emps,name:'Empirical',mode:'markers',marker:{color:'#00d9ff',size:10,symbol:'diamond'}},
{x:ks,y:ks.map(()=>1),name:'Limit (1)',mode:'lines',line:{color:'#666',dash:'dash',width:1}}
],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'P(coprime)',range:[0.5,1.05]}});
legend('aldens1','Density Analysis',[['1/Œ∂(2)',ths[0],'#ff8c00'],['1/Œ∂('+maxK+')',ths[ths.length-1],'#00d9ff']]);

// Chart 2: Zeta convergence to 1
Plotly.newPlot('pdensZeta',[
{x:ks,y:zetaVals,name:'Œ∂(k)',mode:'lines+markers',line:{color:'#9664ff',width:2},marker:{size:6}},
{x:ks,y:ks.map(()=>1),name:'Limit',mode:'lines',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'Œ∂(k)',range:[0.95,Math.max(...zetaVals)+0.1]}});

// Chart 3: Error bars
Plotly.newPlot('pdens2',[{x:ks,y:D.dens.map(d=>d.relE),type:'bar',marker:{color:D.dens.map(d=>d.relE<1?'#00ff88':d.relE<5?'#ffd700':'#ff6496')}}],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'Relative Error %'}});
legend('aldens2','Error Analysis',[['Max Error',fmt(Math.max(...D.dens.map(d=>d.relE)))+'%','#ff6496'],['Min Error',fmt(Math.min(...D.dens.map(d=>d.relE)))+'%','#00ff88']]);

// Chart 4: Euler product verification
Plotly.newPlot('pdensEuler',[
{x:ks,y:zetaVals,name:'Œ∂(k) (Series)',mode:'lines+markers',line:{color:'#ff8c00',width:2}},
{x:ks,y:eulerVals,name:'Euler Product (p‚â§100)',mode:'markers',marker:{color:'#00ff88',size:8,symbol:'cross'}}
],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'Value'}});

// Chart 5: Convergence rate
const convRate=ks.map((k,i)=>i>0?Math.abs(ths[i]-1)/Math.abs(ths[i-1]-1):1);
Plotly.newPlot('pdensConv',[{x:ks.slice(1),y:convRate.slice(1),type:'scatter',mode:'lines+markers',line:{color:'#00d9ff',width:2},marker:{size:6}}],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'|1/Œ∂(k)-1|/|1/Œ∂(k-1)-1|'}});

// Live stats
const avgErr=D.dens.reduce((a,d)=>a+d.relE,0)/D.dens.length;
const totalPts=D.dens.reduce((a,d)=>a+d.tot,0);
const totalPrim=D.dens.reduce((a,d)=>a+d.prim,0);
document.getElementById('densLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxK-1}</div><div style="font-size:.7rem;color:var(--txt2)">DIMENSIONS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${totalPts.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL SAMPLES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${totalPrim.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">COPRIME</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius R:</span><span style="color:var(--txt)">${R}</span>
<span>Max Dimension:</span><span style="color:var(--txt)">${maxK}</span>
<span>Mode:</span><span style="color:var(--txt)">${mode}</span>
<span>Monte Carlo:</span><span style="color:var(--txt)">${samples.toLocaleString()}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Summary</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Avg Error:</span><span style="color:${avgErr<2?'#00ff88':'#ff8c00'}">${fmt(avgErr)}%</span>
<span>Max Error:</span><span style="color:#ff6496">${fmt(Math.max(...D.dens.map(d=>d.relE)))}%</span>
<span>Min Error:</span><span style="color:#00ff88">${fmt(Math.min(...D.dens.map(d=>d.relE)))}%</span>
<span>Best k:</span><span style="color:#ffd700">k=${D.dens.reduce((a,d)=>d.relE<a.relE?d:a).k}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Zeta Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Œ∂(2) = œÄ¬≤/6:</span><span style="color:#9664ff">${fmt(zeta(2))}</span>
<span>Œ∂(3) (Ap√©ry):</span><span style="color:#ff8c00">${fmt(zeta(3))}</span>
<span>Œ∂(4) = œÄ‚Å¥/90:</span><span style="color:#00d9ff">${fmt(zeta(4))}</span>
<span>Œ∂(${maxK}):</span><span style="color:#00ff88">${fmt(zeta(maxK))}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Observations</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ As k‚Üë, Œ∂(k)‚Üí1 exponentially fast<br>
‚Ä¢ P(coprime in k-dim) = 1/Œ∂(k) ‚Üí 1<br>
‚Ä¢ Higher dimensions ‚âà almost always coprime<br>
‚Ä¢ Euler product: Œ∂(s) = Œ†(1-p‚ÅªÀ¢)‚Åª¬π
</div>
</div>`;

// Table
document.getElementById('tdensT').innerHTML='<tr><th>k</th><th>Œ∂(k)</th><th>1/Œ∂(k)</th><th>Empirical</th><th>Total</th><th>Primitive</th><th>Abs Err</th><th>Rel Err %</th></tr>'+
D.dens.map(d=>`<tr onclick="modal('Dimension ${d.k} Analysis',[['Œ∂(${d.k})',${d.z}],['1/Œ∂(${d.k})',${d.th}],['Empirical',${d.emp}],['Total Points',${d.tot}],['Primitive',${d.prim}],['Euler Product',${d.euler}],['Abs Error',${d.err}],['Rel Error %',${d.relE}]])" style="cursor:pointer;color:${d.relE<1?'#00ff88':d.relE<5?'inherit':'#ff6496'}"><td>${d.k}</td><td>${fmt(d.z)}</td><td>${fmt(d.th)}</td><td>${fmt(d.emp)}</td><td>${d.tot}</td><td>${d.prim}</td><td>${fmt(d.err)}</td><td>${fmt(d.relE)}</td></tr>`).join('');}

function runConvergence(){
const Rs=[5,8,10,12,15,20];
const conv2d=[],conv3d=[];
for(const R of Rs){
let tot2=0,prim2=0,tot3=0,prim3=0;
const m=Math.ceil(R);
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=R*R){tot2++;if(gcdM(x,y)===1)prim2++;}
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){tot3++;if(gcdM(x,y,z)===1)prim3++;}
conv2d.push({R,emp:prim2/tot2,th:1/zeta(2),err:Math.abs(prim2/tot2-1/zeta(2))});
conv3d.push({R,emp:prim3/tot3,th:1/zeta(3),err:Math.abs(prim3/tot3-1/zeta(3))});}
Plotly.newPlot('pdensConv',[
{x:Rs,y:conv2d.map(c=>c.err),name:'2D Error',mode:'lines+markers',line:{color:'#00d9ff',width:2}},
{x:Rs,y:conv3d.map(c=>c.err),name:'3D Error',mode:'lines+markers',line:{color:'#ff8c00',width:2}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'|Empirical - Theory|',type:'log'}});}

function runDens(){runDensNew();}
function csvDens(){let s='k,Zeta,InvZeta,Empirical,Total,Primitive,AbsError,RelError,EulerProd\n';for(const d of D.dens)s+=`${d.k},${d.z},${d.th},${d.emp},${d.tot},${d.prim},${d.err},${d.relE},${d.euler}\n`;dl(s,'density.csv');}

async function screenshotPlotly(plotIds,legends,title,filename){
const scale=2,pad=30,gap=20;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:p.offsetWidth,height:p.offsetHeight,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const legEls=legends.map(id=>document.getElementById(id)).filter(l=>l);
const legH=legEls.length?100:0;
const cols=Math.min(2,loaded.length),rows=Math.ceil(loaded.length/cols);
const pw=loaded[0].width/2,ph=loaded[0].height/2;
const out=document.createElement('canvas');
out.width=(pw*cols+gap*(cols-1)+pad*2)*scale;
out.height=(ph*rows+gap*(rows-1)+pad*2+40+legH)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
ctx.fillStyle=canvBg();ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.fillText(title,pad,pad+20);
loaded.forEach((img,i)=>{const col=i%cols,row=Math.floor(i/cols);ctx.drawImage(img,pad+col*(pw+gap),pad+40+row*(ph+gap),pw,ph);});
if(legEls.length){let ly=pad+40+rows*(ph+gap)+10;
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.fillText('Statistics',pad,ly);ly+=20;
ctx.font='12px Segoe UI';let lx=pad;
legEls.forEach(leg=>{leg.querySelectorAll('.li').forEach((li,j)=>{const l=li.querySelector('strong')?.textContent||'',v=li.querySelector('.v')?.textContent||'';
ctx.fillStyle=isDark()?'#b0b8d8':'#4a5568';ctx.fillText(l+': '+v,lx,ly);lx+=160;if(lx>out.width/scale-pad){lx=pad;ly+=18;}});});}
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();},'image/png',1.0);}

async function screenshotErr(){
const dashData=extractDashboardData('errLiveStats');
const maxR=document.getElementById('errRv').value,shape=document.getElementById('errSh').value;
const plotIds=['pe1','pe2','pe3','pe4'];
const scale=2,pad=30,gap=10,dashH=280;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:380,height:220,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=190,ph=110;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph*2+gap+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Error Analysis ‚Äî R‚â§${maxR}, ${shape}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{const col=i%2,row=Math.floor(i/2);ctx.drawImage(img,pad+col*(pw+gap),pad+30+row*(ph+gap),pw,ph);});
const dashY=pad+30+2*(ph+gap)+10;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='error_complete.png';a.click();},'image/png',1.0);}

async function screenshotSh(){
const dashData=extractDashboardData('shLiveStats');
const R=document.getElementById('rshv').value,maxK=document.getElementById('shKv').value;
const plotIds=['psh','pshCum'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M√∂bius Shell Decomposition ‚Äî R=${R}, k‚â§${maxK}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='shells_complete.png';a.click();},'image/png',1.0);}
async function screenshotGCD(){
const dashData=extractDashboardData('gcdLiveStats');
const R=document.getElementById('rgcdv').value,shape=document.getElementById('gcdShape').value;
const plotIds=['pgcd1','pgcd2'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`GCD Distribution Analysis ‚Äî R=${R}, ${shape}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='gcd_complete.png';a.click();},'image/png',1.0);}

async function screenshotCirc(){
const dashData=extractDashboardData('circLiveStats');
const maxR=document.getElementById('circRv').value;
const plotIds=['pc1','pc2'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Gauss Circle Problem ‚Äî R‚â§${maxR}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='circle_complete.png';a.click();},'image/png',1.0);}
async function screenshotDens(){
const dashData=extractDashboardData('densLiveStats');
const R=document.getElementById('densR').value;
const maxK=document.getElementById('densMaxK').value;
const mode=document.getElementById('densMode').value;
const plotIds=['pdens1','pdensZeta','pdens2','pdensEuler'];
const scale=2,pad=30,gap=15;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125,dashH=250;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph*2+gap+dashH+pad*4+50)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Primitive Density 1/Œ∂(k) ‚Äî R=${R}, k=2‚Üí${maxK}, ${mode}`,out.width/scale/2,pad);
// 2x2 grid of charts
loaded.forEach((img,i)=>{const col=i%2,row=Math.floor(i/2);ctx.drawImage(img,pad+col*(pw+gap),pad+35+row*(ph+gap),pw,ph);});
// Dashboard
const dashY=pad+35+2*(ph+gap)+10;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-20);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='density_complete.png';a.click();},'image/png',1.0);}
async function screenshotDim(){
const dashData=extractDashboardData('dimLiveStats');
const maxD=document.getElementById('dimMaxV').value,R=document.getElementById('rdimv').value;
const plotIds=['pdimZeta','pdimDens'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Dimension Analysis ‚Äî n=2‚Üí${maxD}, R=${R}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dimensions_complete.png';a.click();},'image/png',1.0);}

let cayleyPts=[],primRootData={};

function cayley(z){const x=z.x,y=z.y,d=(1-x)*(1-x)+y*y;if(d<1e-10)return{x:0,y:1e6};return{x:-2*y/d,y:(1-x*x-y*y)/d};}
function invCayley(w){const x=w.x,y=w.y,d=x*x+(y+1)*(y+1);if(d<1e-10)return{x:0,y:0};return{x:-2*x/d,y:(x*x+y*y-1)/d};}
function fareyLevel(p,q){if(q===0)return 0;return q;}

function drawCayley(){
const c=document.getElementById('ccay'),ctx=c.getContext('2d');
const R=+document.getElementById('rcayv').value||+document.getElementById('rcay').value;
const range=+document.getElementById('cayRange').value,col=document.getElementById('colCay').value;
const ptSz=+document.getElementById('caySz').value,filt=document.getElementById('cayFilt').value;
const lbl=document.getElementById('cayLbl').value,fordQ=+document.getElementById('cayFordQ').value;
const showGrid=document.getElementById('cayGrid').checked,showGeo=document.getElementById('cayGeo').checked;
const showFord=document.getElementById('cayFord').checked,showFarey=document.getElementById('cayFarey').checked;
const showFund=document.getElementById('cayFund').checked,showHoro=document.getElementById('cayHoro').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const scX=c.width/(2*range),scY=c.height/range,ox=c.width/2,oy=c.height;

// Grid
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=-Math.ceil(range);i<=Math.ceil(range);i++){ctx.beginPath();ctx.moveTo(ox+i*scX,0);ctx.lineTo(ox+i*scX,c.height);ctx.stroke();}
for(let i=0;i<=range;i++){ctx.beginPath();ctx.moveTo(0,oy-i*scY);ctx.lineTo(c.width,oy-i*scY);ctx.stroke();}}

// Fundamental domain of PSL(2,Z)
if(showFund){
ctx.fillStyle='rgba(255,215,0,0.1)';ctx.strokeStyle='rgba(255,215,0,0.6)';ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(ox-0.5*scX,0);ctx.lineTo(ox-0.5*scX,oy-Math.sqrt(0.75)*scY);
ctx.arc(ox,oy,scY,Math.PI*2/3,Math.PI/3,true);
ctx.lineTo(ox+0.5*scX,0);ctx.closePath();ctx.fill();ctx.stroke();
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='11px Segoe UI';
ctx.fillText('‚Ñ±',ox-8,oy-0.5*scY);}

// Horocycles at i, 2i, etc
if(showHoro){ctx.strokeStyle='rgba(0,255,136,0.3)';ctx.lineWidth=1;
for(let h=1;h<=Math.min(5,range);h++){const r=0.5/h*scY;
ctx.beginPath();ctx.arc(ox,oy-h*scY+r,r,0,2*Math.PI);ctx.stroke();}}

// Ford circles
if(showFord){ctx.lineWidth=1;
for(let q=1;q<=fordQ;q++){for(let p=-q*Math.ceil(range);p<=q*Math.ceil(range);p++){
if(gcd(Math.abs(p),q)!==1)continue;
const cx=ox+(p/q)*scX,r=1/(2*q*q)*scY;
if(r<1||cx<-50||cx>c.width+50)continue;
const alpha=Math.max(0.1,0.6-q*0.05);
ctx.strokeStyle=`hsla(${(p+q)*30},70%,60%,${alpha})`;
ctx.beginPath();ctx.arc(cx,oy-r,r,0,2*Math.PI);ctx.stroke();
if(r>8&&lbl==='frac'){ctx.fillStyle=isDark()?'#9664ff':'#6644aa';ctx.font='9px Segoe UI';
ctx.fillText(p+'/'+q,cx-10,oy-2*r-2);}}}}

// Farey arcs (geodesics between Farey neighbors)
if(showFarey){ctx.strokeStyle='rgba(255,100,150,0.4)';ctx.lineWidth=1;
const fareyPairs=[];
for(let q=1;q<=Math.min(fordQ,12);q++){for(let p=0;p<=q;p++){if(gcd(p,q)===1)fareyPairs.push([p,q]);}}
for(let i=0;i<fareyPairs.length;i++){for(let j=i+1;j<fareyPairs.length;j++){
const[p1,q1]=fareyPairs[i],[p2,q2]=fareyPairs[j];
if(Math.abs(p1*q2-p2*q1)===1){
const x1=p1/q1,x2=p2/q2,mid=(x1+x2)/2,r=Math.abs(x2-x1)/2;
if(r*scX>2&&Math.abs(mid)<range){
ctx.beginPath();ctx.arc(ox+mid*scX,oy,r*scX,Math.PI,0,true);ctx.stroke();}}}}}

// Geodesics (semicircles)
if(showGeo){ctx.strokeStyle='rgba(255,136,0,0.25)';ctx.lineWidth=1;
for(let i=1;i<=8;i++){const r=i*0.3*scY;ctx.beginPath();ctx.arc(ox,oy,r,Math.PI,0,true);ctx.stroke();}
for(let x=-3;x<=3;x++){if(x===0)continue;const r=Math.abs(x)*0.5*scX;
ctx.beginPath();ctx.arc(ox+x*0.5*scX,oy,r,Math.PI,0,true);ctx.stroke();}}

// Real axis
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,oy);ctx.lineTo(c.width,oy);ctx.stroke();

// Compute and draw points
cayleyPts=[];const pts=enum2D(R,'circle');let prim=0,maxIm=0,minIm=Infinity;
const imDist={};
for(const pt of pts){
if(pt.x===0&&pt.y===0)continue;
if(filt==='prim'&&!pt.p)continue;
if(filt==='gcd2'&&pt.g>2)continue;
if(filt==='gcd3'&&pt.g>3)continue;
const nrm=Math.sqrt(pt.x*pt.x+pt.y*pt.y);
const zNorm={x:pt.x/(nrm+.01)*.99,y:pt.y/(nrm+.01)*.99};
const w=cayley(zNorm);
if(w.y>0&&w.y<range*2&&Math.abs(w.x)<range*2){
if(pt.p)prim++;
maxIm=Math.max(maxIm,w.y);minIm=Math.min(minIm,w.y);
const imBin=Math.floor(w.y*4)/4;imDist[imBin]=(imDist[imBin]||0)+1;
const px=ox+w.x*scX,py=oy-w.y*scY;
const arg=Math.atan2(pt.y,pt.x);
let clr;
if(col==='gcd')clr=pt.p?'#00d9ff':'#ff6496';
else if(col==='prim')clr=pt.p?'#ffd700':'#555';
else if(col==='imag')clr=`hsl(${Math.floor(w.y/range*240)},80%,55%)`;
else if(col==='arg')clr=`hsl(${Math.floor((arg+Math.PI)/(2*Math.PI)*360)},80%,55%)`;
else if(col==='farey'){const fl=Math.min(nrm,10);clr=`hsl(${fl*25},70%,50%)`;}
else if(col==='fire'){const d=w.y/range;clr=d<.33?`rgb(${Math.floor(d*3*255)},0,0)`:d<.66?`rgb(255,${Math.floor((d-.33)*3*255)},0)`:`rgb(255,200,${Math.floor((d-.66)*3*255)})`;}
else if(col==='plasma'){const d=w.y/range;clr=`rgb(${Math.floor(13+d*230)},${Math.floor(8+d*92+Math.sin(d*Math.PI)*100)},${Math.floor(135+d*80)})`;}
else if(col==='viridis'){const d=w.y/range;clr=`rgb(${Math.floor(68+d*187)},${Math.floor(1+d*206)},${Math.floor(84+d*50)})`;}
else clr=pt.p?'#00d9ff':'#ff6496';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(px,py,ptSz,0,2*Math.PI);ctx.fill();
// Labels
if(lbl==='xy'){ctx.fillStyle=isDark()?'#aaa':'#555';ctx.font='9px Segoe UI';ctx.fillText(`(${pt.x},${pt.y})`,px+ptSz+2,py+3);}
else if(lbl==='w'){ctx.fillStyle=isDark()?'#aaa':'#555';ctx.font='9px Segoe UI';ctx.fillText(`${w.x.toFixed(1)}+${w.y.toFixed(1)}i`,px+ptSz+2,py+3);}
cayleyPts.push({...pt,wx:w.x,wy:w.y,px,py,arg});}}

// Axis labels
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 12px Segoe UI';
ctx.fillText('Re(w)',c.width-50,oy-10);ctx.fillText('Im(w)',ox+5,20);
for(let i=-Math.floor(range);i<=Math.floor(range);i++){if(i!==0){ctx.fillStyle=isDark()?'#888':'#666';ctx.font='10px Segoe UI';ctx.fillText(i+'',ox+i*scX-5,oy+15);}}
for(let i=1;i<=Math.floor(range);i++){ctx.fillStyle=isDark()?'#888':'#666';ctx.font='10px Segoe UI';ctx.fillText(i+'i',ox+8,oy-i*scY+4);}

// Legend and stats
legend('alcay','Cayley ‚Ñç',[]);
document.getElementById('stcay').innerHTML='';

// Live stats
const avgIm=cayleyPts.length>0?cayleyPts.reduce((s,p)=>s+p.wy,0)/cayleyPts.length:0;
const imKeys=Object.keys(imDist).sort((a,b)=>+a-+b);
document.getElementById('cayLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${cayleyPts.length}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${prim}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMITIVE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(100*prim/Math.max(1,cayleyPts.length))}%</div><div style="font-size:.7rem;color:var(--txt2)">DENSITY</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius R:</span><span style="color:var(--txt)">${R}</span>
<span>View Range:</span><span style="color:var(--txt)">${range}</span>
<span>Color:</span><span style="color:var(--txt)">${col}</span>
<span>Filter:</span><span style="color:var(--txt)">${filt}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Im(w) Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Min Im(w):</span><span style="color:#ff6496">${fmt(minIm)}</span>
<span>Max Im(w):</span><span style="color:#00ff88">${fmt(maxIm)}</span>
<span>Avg Im(w):</span><span style="color:#00d9ff">${fmt(avgIm)}</span>
<span>Spread:</span><span style="color:#ffd700">${fmt(maxIm-minIm)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Overlays Active</strong>
<div style="margin-top:5px;font-size:.8rem">
${showGrid?'<span style="color:#00ff88">Grid</span> ':''}${showGeo?'<span style="color:#ff8c00">Geodesics</span> ':''}${showFord?'<span style="color:#9664ff">Ford(q‚â§'+fordQ+')</span> ':''}${showFarey?'<span style="color:#ff6496">Farey</span> ':''}${showFund?'<span style="color:#ffd700">Fund.Dom</span> ':''}${showHoro?'<span style="color:#00ff88">Horocycles</span> ':''}
${!showGrid&&!showGeo&&!showFord&&!showFarey&&!showFund&&!showHoro?'<em>None</em>':''}
</div>
</div>
<div>
<strong style="color:var(--acc)">Hyperbolic Facts</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Hyperbolic area of fund. domain = œÄ/3<br>
‚Ä¢ Ford circles are tangent, never overlap<br>
‚Ä¢ Farey neighbors have |ps-qr|=1<br>
‚Ä¢ Horocycles: circles tangent to ‚Ñù at ‚àû
</div>
</div>`;

// Im(w) distribution chart
Plotly.newPlot('pcayDist',[{x:imKeys.map(k=>+k),y:imKeys.map(k=>imDist[k]),type:'bar',marker:{color:imKeys.map(k=>`hsl(${+k/range*240},70%,55%)`)}}],{...plo(),xaxis:{title:'Im(w)'},yaxis:{title:'Count'},height:200});

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
for(const p of cayleyPts){if(Math.hypot(mx-p.px,my-p.py)<ptSz+5){
const hypDist=Math.log(p.wy);
modal('Cayley Point Analysis',[
['Original (x,y)',`(${p.x}, ${p.y})`],
['Cayley w',`${fmt(p.wx)} + ${fmt(p.wy)}i`],
['|w|',fmt(Math.sqrt(p.wx*p.wx+p.wy*p.wy))],
['Arg(z)',fmt(p.arg*180/Math.PI)+'¬∞'],
['Im(w)',fmt(p.wy)],
['log(Im(w))',fmt(hypDist)],
['GCD',p.g],
['Primitive',p.p?'Yes':'No']
]);break;}}};}

function csvCayley(){let s='x,y,gcd,primitive,Re_w,Im_w,arg\n';for(const p of cayleyPts)s+=`${p.x},${p.y},${p.g},${p.p},${p.wx},${p.wy},${p.arg}\n`;dl(s,'cayley.csv');}

async function screenshotCayley(){
const c=document.getElementById('ccay'),dashData=extractDashboardData('cayLiveStats');
const R=document.getElementById('rcayv').value,range=document.getElementById('cayRange').value;
const col=document.getElementById('colCay').value,filt=document.getElementById('cayFilt').value;
const scale=2,pad=30,dashH=300;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Cayley Transform ùîª‚Üí‚Ñç ‚Äî R=${R}, Range=${range}, ${col}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH-20);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#ffd700':'#cc8800';ctx.font='11px Segoe UI';
ctx.fillText('w = i(1+z)/(1-z) ¬∑ Geodesics = semicircles ‚ä• ‚Ñù ¬∑ Ford circles tangent at rationals',pad+10,out.height/scale-30);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='cayley_complete.png';a.click();},'image/png',1.0);}

function mulOrd(a,m){if(gcd(a,m)!==1)return 0;let ord=1,x=a%m;while(x!==1&&ord<=m){x=(x*a)%m;ord++;}return ord;}

function findPrimRoot(){const M=+document.getElementById('mprimv').value||+document.getElementById('mprim').value,phi=eulerPhi(M);for(let g=2;g<M;g++)if(gcd(g,M)===1&&mulOrd(g,M)===phi){document.getElementById('gprim').value=g;drawPrimRoot();return;}alert('No primitive root exists for M='+M);}

function findAllPrimRoots(){const M=+document.getElementById('mprimv').value,phi=eulerPhi(M);const roots=[];for(let g=1;g<M;g++)if(gcd(g,M)===1&&mulOrd(g,M)===phi)roots.push(g);if(roots.length>0){modal('All Primitive Roots mod '+M,[['Count',roots.length],['œÜ(œÜ(M))',eulerPhi(phi)],['Roots',roots.slice(0,30).join(', ')+(roots.length>30?' ...':'')]]);}else{alert('No primitive roots exist for M='+M);}}

function setM(m){document.getElementById('mprim').value=m;document.getElementById('mprimv').value=m;findPrimRoot();}

function isQuadraticResidue(a,p){if(gcd(a,p)!==1)return false;return modPow(a,(p-1)/2,p)===1;}
function modPow(b,e,m){let r=1;b=b%m;while(e>0){if(e%2===1)r=(r*b)%m;e=Math.floor(e/2);b=(b*b)%m;}return r;}

function eulerPhi(n){let r=n,m=n;for(let p=2;p*p<=m;p++)if(m%p===0){while(m%p===0)m/=p;r-=r/p;}if(m>1)r-=r/m;return Math.round(r);}

function discreteLog(a,g,M,phi){if(gcd(a,M)!==1)return-1;let x=1;for(let i=0;i<phi;i++){if(x===a)return i;x=(x*g)%M;}return-1;}

let primAnimId=null;
function animatePowerSeq(){
const M=+document.getElementById('mprimv').value,g=+document.getElementById('gprim').value,phi=eulerPhi(M);
if(gcd(g,M)!==1||mulOrd(g,M)!==phi){alert('g must be a primitive root');return;}
if(primAnimId)cancelAnimationFrame(primAnimId);
let step=0;const c=document.getElementById('cprim'),ctx=c.getContext('2d');
const cx=c.width/2,cy=c.height/2,rad=Math.min(cx,cy)-80;
function frame(){
drawPrimRoot();ctx.strokeStyle='rgba(255,215,0,0.8)';ctx.lineWidth=3;ctx.beginPath();
let x=1;for(let i=0;i<=step;i++){const ang=2*Math.PI*x/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);x=(x*g)%M;}
ctx.stroke();
if(step<phi){step++;primAnimId=requestAnimationFrame(frame);}else{primAnimId=null;}}
frame();}

function drawPrimRoot(){
const c=document.getElementById('cprim'),ctx=c.getContext('2d');
const M=+document.getElementById('mprimv').value||+document.getElementById('mprim').value;
const g=+document.getElementById('gprim').value,col=document.getElementById('colPrim').value;
const ptSz=+document.getElementById('primPtSz').value,lbl=document.getElementById('primLbl').value;
const showSeq=document.getElementById('primSeq').checked,showOrd=document.getElementById('primOrd').checked;
const showSubgrp=document.getElementById('primSubgrp').checked,showQR=document.getElementById('primQR').checked;
const showCosets=document.getElementById('primCosets').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,rad=Math.min(cx,cy)-80;

// Draw circle
ctx.strokeStyle=gridC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();

const phi=eulerPhi(M),isPrimRoot=gcd(g,M)===1&&mulOrd(g,M)===phi;
const elements=[],orders={},ordCounts={},qrCount=[];
let maxOrd=0;

// Compute discrete logs if g is primitive root
const dlogs={};
if(isPrimRoot){let x=1;for(let i=0;i<phi;i++){dlogs[x]=i;x=(x*g)%M;}}

for(let k=1;k<M;k++){
const ord=mulOrd(k,M);
const isUnit=gcd(k,M)===1;
const isQR=M>2&&isUnit?isQuadraticResidue(k,M):false;
const dlog=isPrimRoot&&isUnit?dlogs[k]:-1;
orders[k]=ord;
if(ord>0)ordCounts[ord]=(ordCounts[ord]||0)+1;
if(ord>maxOrd)maxOrd=ord;
elements.push({k,ord,isUnit,isQR,dlog});}

// Draw subgroup circles
if(showSubgrp&&isPrimRoot){
const divs=[];for(let d=1;d<=phi;d++)if(phi%d===0)divs.push(d);
divs.forEach((d,i)=>{if(d<phi&&d>1){
ctx.strokeStyle=`hsla(${i*60},70%,50%,0.3)`;ctx.lineWidth=1;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.arc(cx,cy,rad*d/phi,0,2*Math.PI);ctx.stroke();ctx.setLineDash([]);}});}

// Highlight quadratic residues arc
if(showQR&&M>2){
ctx.fillStyle='rgba(0,255,136,0.1)';ctx.beginPath();ctx.moveTo(cx,cy);
elements.filter(e=>e.isQR).forEach(e=>{const ang=2*Math.PI*e.k/M-Math.PI/2;ctx.lineTo(cx+rad*Math.cos(ang),cy+rad*Math.sin(ang));});
ctx.closePath();ctx.fill();}

// Draw cosets
if(showCosets&&isPrimRoot){
const H=elements.filter(e=>e.isQR).map(e=>e.k);
ctx.strokeStyle='rgba(150,100,255,0.4)';ctx.lineWidth=1;
H.forEach(h=>{const ang=2*Math.PI*h/M-Math.PI/2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+rad*Math.cos(ang),cy+rad*Math.sin(ang));ctx.stroke();});}

// Draw elements
for(const e of elements){
const ang=2*Math.PI*e.k/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
let clr;
if(col==='order')clr=e.ord===0?'#666':e.ord===phi?'#ffd700':`hsl(${Math.floor(e.ord/maxOrd*300)},100%,50%)`;
else if(col==='power')clr=e.isUnit?'#00d9ff':'#ff6496';
else if(col==='unit')clr=e.isUnit?'#00ff88':'#ff6496';
else if(col==='quadres')clr=e.isQR?'#00ff88':e.isUnit?'#ff8c00':'#666';
else if(col==='generator')clr=e.ord===phi?'#ffd700':e.isUnit?'#00d9ff':'#666';
else if(col==='discrete')clr=e.dlog>=0?`hsl(${e.dlog/phi*360},80%,50%)`:'#666';
else clr=e.isUnit?'#00d9ff':'#ff6496';

ctx.fillStyle=clr;
const sz=e.ord===phi?ptSz+2:ptSz;
ctx.beginPath();ctx.arc(px,py,sz,0,2*Math.PI);ctx.fill();

// Labels
if(lbl!=='none'||(showOrd&&e.ord>0)){
ctx.fillStyle=isDark()?'rgba(255,255,255,0.85)':'rgba(0,0,0,0.85)';ctx.font='10px Arial';ctx.textAlign='center';
let txt='';
if(lbl==='value')txt=e.k;
else if(lbl==='order')txt=e.ord>0?e.ord:'';
else if(lbl==='dlog')txt=e.dlog>=0?e.dlog:'';
else if(showOrd&&e.ord>0)txt=e.ord;
if(txt!=='')ctx.fillText(txt,px,py-ptSz-5);}}

// Power sequence
if(showSeq&&isPrimRoot){
ctx.strokeStyle='rgba(255,215,0,0.6)';ctx.lineWidth=2;ctx.beginPath();
let x=1;for(let i=0;i<=phi;i++){
const ang=2*Math.PI*x/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);x=(x*g)%M;}
ctx.stroke();}

// Title
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M = ${M}, œÜ(M) = ${phi}, g = ${g}`,cx,25);
ctx.fillStyle=isPrimRoot?'#00ff88':'#ff6496';
ctx.fillText(isPrimRoot?'‚úì g is a PRIMITIVE ROOT':'‚úó g is NOT a primitive root',cx,45);

const primRoots=elements.filter(e=>e.ord===phi).map(e=>e.k);
const qrs=elements.filter(e=>e.isQR).length;
const units=elements.filter(e=>e.isUnit).length;

// Legend
legend('alprim','Primitive Roots',[]);
document.getElementById('stprim').innerHTML='';

// Live stats
document.getElementById('primLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${M}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS M</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${phi}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ(M)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${primRoots.length}</div><div style="font-size:.7rem;color:var(--txt2)">PRIM ROOTS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Generator Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>g:</span><span style="color:var(--txt)">${g}</span>
<span>ord(g):</span><span style="color:${mulOrd(g,M)===phi?'#00ff88':'#ff6496'}">${mulOrd(g,M)}</span>
<span>Is Prim Root:</span><span style="color:${isPrimRoot?'#00ff88':'#ff6496'}">${isPrimRoot?'Yes':'No'}</span>
<span>gcd(g,M):</span><span style="color:var(--txt)">${gcd(g,M)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Group Structure</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Units |(‚Ñ§/M‚Ñ§)√ó|:</span><span style="color:#00d9ff">${units}</span>
<span>Quadratic Residues:</span><span style="color:#00ff88">${qrs}</span>
<span>Non-Residues:</span><span style="color:#ff8c00">${units-qrs}</span>
<span>Max Order:</span><span style="color:#ffd700">${maxOrd}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Primitive Roots</strong>
<div style="margin-top:5px;font-size:.8rem">
<span>Count: <strong style="color:#ffd700">${primRoots.length}</strong></span>
<span style="margin-left:10px">œÜ(œÜ(M)): <strong style="color:#9664ff">${eulerPhi(phi)}</strong></span>
<div style="margin-top:5px;color:var(--txt2);word-break:break-all">${primRoots.slice(0,15).join(', ')}${primRoots.length>15?' ...':''}</div>
</div>
</div>
<div>
<strong style="color:var(--acc)">Existence Test</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
Prim roots exist for M = 1,2,4,p·µè,2p·µè<br>
M=${M}: ${primRoots.length>0?'<span style="color:#00ff88">‚úì Has primitive roots</span>':'<span style="color:#ff6496">‚úó No primitive roots</span>'}
</div>
</div>`;

// Order distribution chart
const ordData=Object.entries(ordCounts).sort((a,b)=>+a[0]-+b[0]);
Plotly.newPlot('pprimord',[{x:ordData.map(d=>d[0]),y:ordData.map(d=>d[1]),type:'bar',marker:{color:ordData.map(d=>+d[0]===phi?'#ffd700':'#00d9ff')}}],{...plo(),xaxis:{title:'Order'},yaxis:{title:'Count'},height:200});

// Power sequence plot
if(isPrimRoot){
const seqX=[],seqY=[];let x=1;
for(let i=0;i<=phi;i++){seqX.push(i);seqY.push(x);x=(x*g)%M;}
Plotly.newPlot('pprimseq',[{x:seqX,y:seqY,mode:'lines+markers',line:{color:'#ffd700'},marker:{size:4}}],{...plo(),xaxis:{title:'Power n'},yaxis:{title:'g‚Åø mod M'},height:180});}
else{Plotly.newPlot('pprimseq',[{x:[],y:[]}],{...plo(),height:180,annotations:[{text:'Select a primitive root to see power sequence',showarrow:false,font:{size:12,color:'#888'}}]});}

// Table
document.getElementById('tprimT').innerHTML='<tr><th>k</th><th>ord(k)</th><th>Unit?</th><th>Prim Root?</th><th>QR?</th><th>Disc Log</th></tr>'+
elements.slice(0,100).map(e=>`<tr onclick="modal('Element ${e.k} mod ${M}',[['k',${e.k}],['ord(k)',${e.ord}],['Unit',${e.isUnit}],['Prim Root',${e.ord===phi}],['QR',${e.isQR}],['Discrete Log',${e.dlog}]])" style="cursor:pointer;color:${e.ord===phi?'#ffd700':e.isUnit?'inherit':'#666'}"><td>${e.k}</td><td>${e.ord}</td><td>${e.isUnit?'‚úì':'‚úó'}</td><td>${e.ord===phi?'‚úì':''}</td><td>${e.isQR?'‚úì':''}</td><td>${e.dlog>=0?e.dlog:'‚Äî'}</td></tr>`).join('');

primRootData={M,phi,g,isPrimRoot,elements,primRoots,maxOrd};

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
for(const el of elements){const ang=2*Math.PI*el.k/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
if(Math.hypot(mx-px,my-py)<ptSz+5){
modal('Element Analysis',[['k',el.k],['Order',el.ord],['Unit',el.isUnit?'Yes':'No'],['Primitive Root',el.ord===phi?'Yes':'No'],['Quadratic Residue',el.isQR?'Yes':'No'],['Discrete Log',el.dlog>=0?el.dlog:'N/A']]);break;}}};}

function csvPrim(){let s='k,order,isUnit,isPrimRoot,isQR,discreteLog\n';for(const e of primRootData.elements||[])s+=`${e.k},${e.ord},${e.isUnit},${e.ord===primRootData.phi},${e.isQR},${e.dlog}\n`;dl(s,'primitive_roots.csv');}

// ==================== FAREY SEQUENCES ====================
let fareyData={seq:[],Q:0};

function setFareyQ(q){document.getElementById('fareyQ').value=Math.min(50,q);document.getElementById('fareyQv').value=q;drawFarey();}

function generateFarey(Q){
const seq=[{p:0,q:1,level:1,value:0}];
for(let q=1;q<=Q;q++){for(let p=0;p<=q;p++){if(gcd(p,q)===1&&!(p===0&&q>1)){
seq.push({p,q,level:q,value:p/q});}}}
seq.sort((a,b)=>a.value-b.value);
// Find neighbors
for(let i=0;i<seq.length;i++){
seq[i].idx=i;
seq[i].left=i>0?seq[i-1]:null;
seq[i].right=i<seq.length-1?seq[i+1]:null;}
return seq;}

function fareyLevel(p,q){return q;}

function mediant(a,b){return{p:a.p+b.p,q:a.q+b.q};}

function highlightFraction(){
const p=+document.getElementById('fareyP').value,q=+document.getElementById('fareyQh').value;
if(q<=0||gcd(p,q)!==1){alert('Enter valid coprime p/q');return;}
const found=fareyData.seq.find(f=>f.p===p&&f.q===q);
if(found){
modal(`Fraction ${p}/${q}`,[
['Value',found.value],['Level (first appears)',found.q],['Index',found.idx],
['Left Neighbor',found.left?`${found.left.p}/${found.left.q}`:'‚Äî'],
['Right Neighbor',found.right?`${found.right.p}/${found.right.q}`:'‚Äî'],
['Ford Circle Center',`(${p/q}, ${1/(2*q*q)})`],['Ford Circle Radius',1/(2*q*q)]
]);}else{alert(`${p}/${q} not in F_${fareyData.Q} (need q‚â§${fareyData.Q})`);}drawFarey();}

function drawFarey(){
const c=document.getElementById('cfarey'),ctx=c.getContext('2d');
const Q=+document.getElementById('fareyQv').value||+document.getElementById('fareyQ').value;
const viz=document.getElementById('fareyViz').value,col=document.getElementById('fareyCol').value;
const ptSz=+document.getElementById('fareySz').value;
const showLabels=document.getElementById('fareyLabels').checked;
const showMediant=document.getElementById('fareyMediant').checked;
const showNeighbor=document.getElementById('fareyNeighbor').checked;
const showGrid=document.getElementById('fareyGrid').checked;
const showCircles=document.getElementById('fareyCircles').checked;
const highlightP=+document.getElementById('fareyP').value,highlightQ=+document.getElementById('fareyQh').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('fareyQdisp').textContent=Q;

// Generate Farey sequence
fareyData.seq=generateFarey(Q);
fareyData.Q=Q;
const seq=fareyData.seq;

const pad=50,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='sequence'){
// Line visualization
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){const x=pad+i*w/10;ctx.beginPath();ctx.moveTo(x,pad);ctx.lineTo(x,c.height-pad);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='center';ctx.fillText((i/10).toFixed(1),x,c.height-pad+15);}}
// Real line
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pad,c.height/2);ctx.lineTo(c.width-pad,c.height/2);ctx.stroke();
// Points
seq.forEach((f,i)=>{
const x=pad+f.value*w,y=c.height/2;
let clr;
if(col==='denom')clr=`hsl(${f.q/Q*300},80%,50%)`;
else if(col==='level')clr=`hsl(${f.level/Q*300},80%,50%)`;
else if(col==='depth')clr=`hsl(${Math.log2(f.q+1)/Math.log2(Q+1)*300},80%,50%)`;
else if(col==='parent')clr=f.q<=2?'#ffd700':'#00d9ff';
else clr=`hsl(${i/seq.length*360},80%,50%)`;
if(f.p===highlightP&&f.q===highlightQ)clr='#ff006e';
ctx.fillStyle=clr;
const sz=f.p===highlightP&&f.q===highlightQ?ptSz+4:ptSz;
ctx.beginPath();ctx.arc(x,y,sz,0,2*Math.PI);ctx.fill();
// Labels
if(showLabels&&(f.q<=Math.min(8,Q)||f.p===highlightP&&f.q===highlightQ)){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(`${f.p}/${f.q}`,x,y-ptSz-8);}});}

else if(viz==='ford'){
// Ford circles
const scale=w,ox=pad,oy=c.height-80;
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){const x=ox+i*scale/10;ctx.beginPath();ctx.moveTo(x,50);ctx.lineTo(x,oy);ctx.stroke();}}
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(ox+scale,oy);ctx.stroke();
seq.forEach(f=>{
if(f.q===0)return;
const cx=ox+f.value*scale,r=scale/(2*f.q*f.q);
if(r<1)return;
let clr;
if(col==='denom')clr=`hsla(${f.q/Q*300},70%,50%,0.7)`;
else if(col==='level')clr=`hsla(${f.level/Q*300},70%,50%,0.7)`;
else clr=`hsla(${f.value*360},70%,50%,0.7)`;
if(f.p===highlightP&&f.q===highlightQ)clr='rgba(255,0,110,0.9)';
ctx.strokeStyle=clr;ctx.lineWidth=f.q<=5?2:1;
ctx.beginPath();ctx.arc(cx,oy-r,r,0,2*Math.PI);ctx.stroke();
if(showLabels&&r>10){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(`${f.p}/${f.q}`,cx,oy-2*r-5);}});
// Tangency lines
if(showCircles){ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
for(let i=0;i<seq.length-1;i++){
const a=seq[i],b=seq[i+1];
if(Math.abs(a.p*b.q-b.p*a.q)===1){
const cx1=ox+a.value*scale,r1=scale/(2*a.q*a.q);
const cx2=ox+b.value*scale,r2=scale/(2*b.q*b.q);
ctx.beginPath();ctx.moveTo(cx1,oy-r1);ctx.lineTo(cx2,oy-r2);ctx.stroke();}}}}

else if(viz==='arc'){
// Farey arcs (geodesics in upper half-plane)
const scale=w,ox=pad,oy=c.height-50;
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(ox+scale,oy);ctx.stroke();
// Draw arcs between neighbors
for(let i=0;i<seq.length-1;i++){
const a=seq[i],b=seq[i+1];
const x1=a.value,x2=b.value;
const mid=(x1+x2)/2,r=Math.abs(x2-x1)/2;
let clr;
if(col==='denom')clr=`hsla(${(a.q+b.q)/2/Q*300},70%,50%,0.6)`;
else clr=`hsla(${i/seq.length*360},70%,50%,0.6)`;
ctx.strokeStyle=clr;ctx.lineWidth=1;
ctx.beginPath();ctx.arc(ox+mid*scale,oy,r*scale,Math.PI,0,true);ctx.stroke();}
// Points on real line
seq.forEach(f=>{
const x=ox+f.value*scale;
ctx.fillStyle=f.p===highlightP&&f.q===highlightQ?'#ff006e':'#ffd700';
ctx.beginPath();ctx.arc(x,oy,3,0,2*Math.PI);ctx.fill();
if(showLabels&&f.q<=6){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(`${f.p}/${f.q}`,x,oy+15);}});}

else if(viz==='tree'){
// Stern-Brocot tree visualization
const levels=Math.min(6,Math.ceil(Math.log2(Q)));
ctx.strokeStyle=gridC();ctx.lineWidth=1;
function drawTree(left,right,depth,x,y,w){
if(depth>levels)return;
const m=mediant(left,right);
if(m.q>Q)return;
const mx=x,my=y;
let clr=`hsl(${depth*50},70%,50%)`;
if(m.p===highlightP&&m.q===highlightQ)clr='#ff006e';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(mx,my,ptSz+2-depth*0.3,0,2*Math.PI);ctx.fill();
if(showLabels&&depth<=4){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(`${m.p}/${m.q}`,mx,my-10);}
if(depth<levels){
const nextY=my+60;
// Left child
ctx.strokeStyle='rgba(100,200,255,0.4)';ctx.beginPath();ctx.moveTo(mx,my+ptSz);ctx.lineTo(x-w/4,nextY-ptSz);ctx.stroke();
drawTree(left,m,depth+1,x-w/4,nextY,w/2);
// Right child  
ctx.strokeStyle='rgba(255,140,0,0.4)';ctx.beginPath();ctx.moveTo(mx,my+ptSz);ctx.lineTo(x+w/4,nextY-ptSz);ctx.stroke();
drawTree(m,right,depth+1,x+w/4,nextY,w/2);}}
// Root nodes 0/1 and 1/1
ctx.fillStyle='#ffd700';
ctx.beginPath();ctx.arc(pad+w*0.1,60,8,0,2*Math.PI);ctx.fill();
ctx.beginPath();ctx.arc(pad+w*0.9,60,8,0,2*Math.PI);ctx.fill();
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Arial';ctx.textAlign='center';
ctx.fillText('0/1',pad+w*0.1,45);ctx.fillText('1/1',pad+w*0.9,45);
drawTree({p:0,q:1},{p:1,q:1},1,c.width/2,120,w*0.8);}

else if(viz==='spiral'){
// Farey spiral
const cx=c.width/2,cy=c.height/2,maxR=Math.min(cx,cy)-60;
seq.forEach((f,i)=>{
const theta=f.value*4*Math.PI;
const r=20+i/seq.length*maxR;
const x=cx+r*Math.cos(theta),y=cy+r*Math.sin(theta);
let clr;
if(col==='denom')clr=`hsl(${f.q/Q*300},80%,50%)`;
else clr=`hsl(${i/seq.length*360},80%,50%)`;
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();});}

// Mediant lines
if(showMediant&&viz==='sequence'){
ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
for(let i=0;i<seq.length-1;i++){
const m=mediant(seq[i],seq[i+1]);
if(m.q<=Q){const x=pad+m.p/m.q*w;
ctx.beginPath();ctx.moveTo(x,c.height/2-20);ctx.lineTo(x,c.height/2+20);ctx.stroke();}}}

// Stats
const denomCounts={};seq.forEach(f=>{denomCounts[f.q]=(denomCounts[f.q]||0)+1;});
const denomData=Object.entries(denomCounts).sort((a,b)=>+a[0]-+b[0]);

// Live stats
document.getElementById('fareyLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${Q}</div><div style="font-size:.7rem;color:var(--txt2)">MAX DENOM Q</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${seq.length}</div><div style="font-size:.7rem;color:var(--txt2)">|F_Q|</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(3*Q*Q/(Math.PI*Math.PI))}</div><div style="font-size:.7rem;color:var(--txt2)">THEORY 3Q¬≤/œÄ¬≤</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Sequence Properties</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Actual |F_Q|:</span><span style="color:#00d9ff">${seq.length}</span>
<span>Theory 3Q¬≤/œÄ¬≤:</span><span style="color:#ffd700">${fmt(3*Q*Q/(Math.PI*Math.PI))}</span>
<span>Error:</span><span style="color:#00ff88">${fmt(Math.abs(seq.length-3*Q*Q/(Math.PI*Math.PI)))}</span>
<span>Œ£œÜ(k) for k‚â§Q:</span><span style="color:#9664ff">${seq.length-1}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Visualization</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Mode:</span><span style="color:var(--txt)">${viz}</span>
<span>Color:</span><span style="color:var(--txt)">${col}</span>
<span>Point Size:</span><span style="color:var(--txt)">${ptSz}px</span>
<span>Labels:</span><span style="color:var(--txt)">${showLabels?'On':'Off'}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Key Facts</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Neighbors p/q, r/s satisfy |ps-qr|=1<br>
‚Ä¢ Mediant (p+r)/(q+s) lies between<br>
‚Ä¢ Ford circles tangent ‚ü∫ neighbors<br>
‚Ä¢ |F_Q| = 1 + Œ£œÜ(k) ‚âà 3Q¬≤/œÄ¬≤
</div>
</div>`;

// Growth chart
const growthX=[],growthY=[],growthTh=[];
for(let q=1;q<=Q;q++){growthX.push(q);growthY.push(generateFarey(q).length);growthTh.push(1+3*q*q/(Math.PI*Math.PI));}
Plotly.newPlot('pfareyGrowth',[
{x:growthX,y:growthY,name:'|F_Q|',mode:'lines+markers',line:{color:'#00d9ff',width:2},marker:{size:4}},
{x:growthX,y:growthTh,name:'3Q¬≤/œÄ¬≤',mode:'lines',line:{color:'#ff8c00',dash:'dash'}}
],{...plo(),xaxis:{title:'Q'},yaxis:{title:'|F_Q|'},height:180});

// Denominator distribution
Plotly.newPlot('pfareyDenom',[{x:denomData.map(d=>d[0]),y:denomData.map(d=>d[1]),type:'bar',marker:{color:denomData.map(d=>`hsl(${+d[0]/Q*300},70%,50%)`)}}],{...plo(),xaxis:{title:'Denominator q'},yaxis:{title:'Count œÜ(q)'},height:180});

// Legend and stats bar
legend('alfarey','Farey F_'+Q,[]);
document.getElementById('stfarey').innerHTML='';

// Table
document.getElementById('tfareyT').innerHTML='<tr><th>Index</th><th>p/q</th><th>Value</th><th>Level</th><th>Left</th><th>Right</th></tr>'+
seq.slice(0,80).map(f=>`<tr onclick="modal('${f.p}/${f.q}',[['Value',${f.value}],['First appears in F_',${f.q}],['Index',${f.idx}],['Left','${f.left?f.left.p+'/'+f.left.q:'‚Äî'}'],['Right','${f.right?f.right.p+'/'+f.right.q:'‚Äî'}'],['Ford radius',${1/(2*f.q*f.q)}]])" style="cursor:pointer;color:${f.p===highlightP&&f.q===highlightQ?'#ff006e':'inherit'}"><td>${f.idx}</td><td>${f.p}/${f.q}</td><td>${f.value.toFixed(6)}</td><td>F_${f.q}</td><td>${f.left?f.left.p+'/'+f.left.q:'‚Äî'}</td><td>${f.right?f.right.p+'/'+f.right.q:'‚Äî'}</td></tr>`).join('');

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='sequence'){
const y0=c.height/2;
for(const f of seq){const x=pad+f.value*w;
if(Math.hypot(mx-x,my-y0)<ptSz+5){
modal(`Fraction ${f.p}/${f.q}`,[['Value',f.value],['Level',f.q],['Index',f.idx],['Left',f.left?f.left.p+'/'+f.left.q:'‚Äî'],['Right',f.right?f.right.p+'/'+f.right.q:'‚Äî'],['Ford Center',`(${f.value.toFixed(4)}, ${(1/(2*f.q*f.q)).toFixed(6)})`],['Ford Radius',(1/(2*f.q*f.q)).toFixed(6)]]);break;}}}};}

function csvFarey(){let s='index,p,q,value,level,left_p,left_q,right_p,right_q\n';
for(const f of fareyData.seq)s+=`${f.idx},${f.p},${f.q},${f.value},${f.q},${f.left?f.left.p:''},${f.left?f.left.q:''},${f.right?f.right.p:''},${f.right?f.right.q:''}\n`;
dl(s,'farey.csv');}

async function screenshotFarey(){
const c=document.getElementById('cfarey'),dashData=extractDashboardData('fareyLiveStats');
const Q=document.getElementById('fareyQv').value,viz=document.getElementById('fareyViz').value;
const scale=2,pad=30,dashH=280;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Farey Sequence F_${Q} ‚Äî ${viz} view`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH-20);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='farey_complete.png';a.click();},'image/png',1.0);}

// ==================== END FAREY ====================

async function screenshotPrim(){
const c=document.getElementById('cprim'),dashData=extractDashboardData('primLiveStats');
const M=document.getElementById('mprimv').value;
const scale=2,pad=30,dashH=300;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Primitive Roots & Cyclic Structure (‚Ñ§/${M}‚Ñ§)√ó`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH-20);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='primitive_roots_complete.png';a.click();},'image/png',1.0);}

let modRingData=[];

function setPhase(deg){document.getElementById('modPhase').value=deg;document.getElementById('modPhaseNum').value=deg;document.getElementById('modPhaseV').textContent=deg+'¬∞';drawModRings();}
function setRingInc(deg){document.getElementById('ringInc').value=Math.min(90,deg);document.getElementById('ringIncNum').value=deg;document.getElementById('ringIncV').textContent=deg+'¬∞';drawModRings();}

function drawModRings(){
const c=document.getElementById('cmod'),ctx=c.getContext('2d');
const minM=+document.getElementById('modMin').value,maxM=+document.getElementById('modMax').value;
const spacing=document.getElementById('modSpace').value,col=document.getElementById('modCol').value;
const phase=+document.getElementById('modPhase').value*Math.PI/180,ptSz=+document.getElementById('modPtSz').value;
const ringInc=+document.getElementById('ringIncNum').value*Math.PI/180;
const showDirect=document.getElementById('modDirect').checked,showGcd1=document.getElementById('modGcd1').checked;
const showUnit=document.getElementById('modUnit').checked;
const gapThick=parseFloat(document.getElementById('gapThick').value);
const liftThick=parseFloat(document.getElementById('liftThick').value);
const labelMode=document.getElementById('modLabel').value,labelSz=+document.getElementById('modLblSz').value;
const selectedGaps=[];
if(document.getElementById('gap2').checked)selectedGaps.push(2);
if(document.getElementById('gap4').checked)selectedGaps.push(4);
if(document.getElementById('gap6').checked)selectedGaps.push(6);
if(document.getElementById('gap8').checked)selectedGaps.push(8);
if(document.getElementById('gap10').checked)selectedGaps.push(10);
const smithEnabled=document.getElementById('smithMod').checked,smithAlpha=+document.getElementById('smithAMod').value;
const smithRMode=document.getElementById('smithRMod').value,smithZoom=+document.getElementById('smithZoom').value;
const smithGrid=document.getElementById('smithGridMod').checked,smithConstR=document.getElementById('smithCircRMod').checked,smithConstX=document.getElementById('smithArcXMod').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,maxRad=Math.min(cx,cy)-40;
const smithRad=maxRad*smithZoom;
if(smithEnabled){drawSmithGrid(ctx,cx,cy,smithRad,smithGrid,smithConstR,smithConstX);ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,smithRad,0,2*Math.PI);ctx.stroke();}
const rings=[];for(let m=minM;m<=maxM;m++)rings.push(m);
const getRadius=(m,i)=>{const n=rings.length;if(spacing==='uniform')return maxRad*(i+1)/(n+1);if(spacing==='linear')return maxRad*m/maxM;if(spacing==='sqrt')return maxRad*Math.sqrt(m)/Math.sqrt(maxM);if(spacing==='log')return maxRad*Math.log(m+1)/Math.log(maxM+1);if(spacing==='phi')return maxRad*eulerPhi(m)/eulerPhi(maxM);return maxRad*(i+1)/(n+1);};
const getSmithR=(i,m)=>{if(smithRMode==='unit')return 1;if(smithRMode==='scaled')return 0.5+(i/Math.max(1,rings.length-1))*1.5;if(smithRMode==='modulus')return Math.min(3,Math.log(m+1)/Math.log(10));return 1;};
const spf=(n)=>{if(n<2)return n;for(let p=2;p*p<=n;p++)if(n%p===0)return p;return n;};
const spfColors={2:'#FF6B6B',3:'#4ECDC4',5:'#FFE66D',7:'#95E1D3',11:'#F38181',13:'#AA96DA',17:'#FCBAD3',19:'#A8D8EA',23:'#DFE6E9'};
modRingData=[];let totalPts=0,totalGcd1=0;
if(showUnit&&minM===1&&!smithEnabled){ctx.strokeStyle='rgba(255,215,0,0.8)';ctx.lineWidth=3;ctx.beginPath();ctx.arc(cx,cy,getRadius(1,0),0,2*Math.PI);ctx.stroke();ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(cx,cy,ptSz+2,0,2*Math.PI);ctx.fill();}
for(let i=0;i<rings.length;i++){const m=rings[i];if(m<2)continue;const rad=getRadius(m,i),phi=eulerPhi(m);
if(!smithEnabled){ctx.strokeStyle=gridC();ctx.lineWidth=1;ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();}
const coprimes=[];for(let r=0;r<m;r++)if(gcd(r,m)===1)coprimes.push(r);
const pts=[];for(let r=0;r<m;r++){const g=gcd(r,m),isGcd1=g===1;if(showGcd1&&!isGcd1)continue;
const ang=2*Math.PI*r/m-Math.PI/2+phase+(i*ringInc);
let px,py;
if(smithEnabled){const smR=getSmithR(i,m);const theta=ang+smithAlpha*Math.PI/180;let gamma;if(smithRMode==='unit'){gamma={re:0,im:Math.tan(theta/2)};}else{const A=smR*Math.cos(theta)-1,B=smR*Math.sin(theta),C=smR*Math.cos(theta)+1;const denom=C*C+B*B;gamma=denom<1e-10?{re:0,im:0}:{re:(A*C+B*B)/denom,im:B*(C-A)/denom};}px=cx+gamma.re*smithRad;py=cy-gamma.im*smithRad;}
else{px=cx+rad*Math.cos(ang);py=cy+rad*Math.sin(ang);}
let clr;const angle=r/m;
if(col==='rainbow')clr=`hsl(${Math.floor(angle*360)},75%,65%)`;
else if(col==='gcd')clr=isGcd1?'#ffd700':'#666666';
else if(col==='gcd_per_mod'){if(isGcd1){const modHue=(m*67)%360;clr=`hsl(${modHue},85%,70%)`;}else clr='#666666';}
else if(col==='gcd_spectrum'){if(isGcd1){const density=phi/m;const spectralHue=(density*240+r*15)%360;const sat=60+density*30;clr=`hsl(${spectralHue},${sat}%,65%)`;}else clr='#666666';}
else if(col==='spf'){const pf=spf(r);clr=spfColors[pf]||`hsl(${(pf*37)%360},70%,60%)`;}
else if(col==='ring')clr=`hsl(${Math.floor(i/rings.length*300)},78%,62%)`;
else if(col==='residue')clr=`hsl(${(r*37)%360},80%,70%)`;
else if(col==='prime'){const isPr=r>1&&[...Array(Math.floor(Math.sqrt(r))+1)].every((_,j)=>j<2||r%j!==0);clr=isPr?'#FF6B6B':'#4ECDC4';}
else clr=isGcd1?'#ffd700':'#666666';
pts.push({r,m,g,isGcd1,ang,px,py,clr,rad});totalPts++;if(isGcd1)totalGcd1++;}
for(const pt of pts){ctx.fillStyle=pt.clr;ctx.beginPath();ctx.arc(pt.px,pt.py,pt.isGcd1?ptSz:ptSz*.7,0,2*Math.PI);ctx.fill();}
if(labelMode!=='none'){ctx.font=`${labelSz}px Segoe UI`;ctx.textAlign='center';ctx.textBaseline='bottom';
for(const pt of pts){let lbl='';if(labelMode==='r')lbl=pt.r;else if(labelMode==='rm')lbl=`${pt.r}/${pt.m}`;else if(labelMode==='deg')lbl=Math.round((pt.ang+Math.PI/2)*180/Math.PI)+'¬∞';else if(labelMode==='gcd')lbl=pt.g;ctx.fillStyle=isDark()?'rgba(255,255,255,0.85)':'rgba(0,0,0,0.85)';ctx.fillText(lbl,pt.px,pt.py-ptSz-2);}}
modRingData.push({m,phi,pts,coprimes,index:i});}
const gapLineWidth=0.2+gapThick*2.8;
selectedGaps.forEach((gap,gapIdx)=>{const hue=(gapIdx*360/selectedGaps.length)%360;
for(const ring of modRingData){ring.coprimes.forEach(r=>{const r2=(r+gap)%ring.m;if(ring.coprimes.includes(r2)){const p1=ring.pts.find(p=>p.r===r&&p.isGcd1);const p2=ring.pts.find(p=>p.r===r2&&p.isGcd1);if(p1&&p2){ctx.beginPath();ctx.moveTo(p1.px,p1.py);ctx.lineTo(p2.px,p2.py);ctx.strokeStyle=`hsla(${hue},75%,65%,0.6)`;ctx.lineWidth=gapLineWidth;ctx.stroke();}}});}});
if(showDirect){const liftLineWidth=0.5+liftThick*3.5;ctx.strokeStyle='rgba(255,215,0,0.7)';ctx.lineWidth=liftLineWidth;
for(let i=0;i<modRingData.length-1;i++){const curr=modRingData[i],next=modRingData[i+1];for(const p1 of curr.pts){if(!p1.isGcd1)continue;const p2=next.pts.find(p=>p.r===p1.r&&p.isGcd1);if(p2){ctx.beginPath();ctx.moveTo(p1.px,p1.py);ctx.lineTo(p2.px,p2.py);ctx.stroke();}}}}
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(smithEnabled?`Smith Chart: M=${minM} to ${maxM}, Œ±=${smithAlpha}¬∞, Zoom ${smithZoom}x`:`Modular Rings M=${minM} to ${maxM}`,cx,20);
legend('almod',smithEnabled?'Smith Chart':'Modular Rings',[]);
document.getElementById('stmod').innerHTML='';
const phiData=modRingData.filter(r=>r.m>1).map(r=>({m:r.m,phi:r.phi,density:r.phi/r.m}));
Plotly.newPlot('pmodphi',[{x:phiData.map(d=>d.m),y:phiData.map(d=>d.density),type:'scatter',mode:'lines+markers',name:'œÜ(M)/M',line:{color:'#ffd700'},marker:{color:'#ffd700'}}],{...plo(),xaxis:{title:'Modulus M'},yaxis:{title:'œÜ(M)/M',range:[0,1]}});
const avgDensity=phiData.length>0?phiData.reduce((a,d)=>a+d.density,0)/phiData.length:0;
const minDensity=phiData.length>0?Math.min(...phiData.map(d=>d.density)):0;
const maxDensity=phiData.length>0?Math.max(...phiData.map(d=>d.density)):0;
const gapColors={2:'#FF6B6B',4:'#4ECDC4',6:'#FFE66D',8:'#95E1D3',10:'#F38181'};
let gapHtml=selectedGaps.length>0?selectedGaps.map(g=>`<span style="display:inline-block;padding:2px 8px;margin:2px;border-radius:4px;background:${gapColors[g]||'#888'};color:#000;font-weight:bold">Gap ${g}</span>`).join(''):'<em>None</em>';
const phaseDeg=phase*180/Math.PI,ringIncDeg=ringInc*180/Math.PI;
document.getElementById('modLiveStats').innerHTML=`
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Modulus Range:</span><span style="color:var(--txt)">${minM} ‚Üí ${maxM}</span>
<span>Ring Count:</span><span style="color:var(--txt)">${rings.length}</span>
<span>Spacing:</span><span style="color:var(--txt)">${spacing}</span>
<span>Color Mode:</span><span style="color:var(--txt)">${col}</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Rotation Settings</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Global Phase Œ±:</span><span style="color:#00d9ff;font-weight:bold">${phaseDeg.toFixed(2)}¬∞</span>
<span>Phase as r/m:</span><span style="color:#9664ff">${phaseDeg>0?fmt(phaseDeg/360)+' rev':'0'}</span>
<span>Per-Ring Increment:</span><span style="color:#ffd700;font-weight:bold">${ringIncDeg.toFixed(2)}¬∞</span>
<span>Total Twist:</span><span style="color:#ff8c00">${fmt(ringIncDeg*(rings.length-1))}¬∞</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Statistics</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Total Residues:</span><span style="color:#00d9ff;font-weight:bold">${totalPts}</span>
<span>GCD=1 Count:</span><span style="color:#ffd700;font-weight:bold">${totalGcd1}</span>
<span>Coprime Density:</span><span style="color:#00ff88;font-weight:bold">${fmt(100*totalGcd1/totalPts)}%</span>
<span>Avg œÜ(M)/M:</span><span style="color:#ffd700">${fmt(avgDensity*100)}%</span>
<span>Min œÜ(M)/M:</span><span style="color:#ff6496">${fmt(minDensity*100)}%</span>
<span>Max œÜ(M)/M:</span><span style="color:#00ff88">${fmt(maxDensity*100)}%</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Active Gaps</strong><br>
<div style="margin-top:6px">${gapHtml}</div>
</div>
<div>
<strong style="color:var(--acc)">Connections</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Direct Lifts:</span><span style="color:${showDirect?'#00ff88':'#ff6496'}">${showDirect?'ON':'OFF'}</span>
<span>Smith Chart:</span><span style="color:${smithEnabled?'#00ff88':'#ff6496'}">${smithEnabled?'ON':'OFF'}</span>
${smithEnabled?`<span>Smith Zoom:</span><span style="color:var(--txt)">${smithZoom}x</span>
<span>Phase Œ±:</span><span style="color:var(--txt)">${smithAlpha}¬∞</span>`:''}
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);for(const ring of modRingData)for(const p of ring.pts)if(Math.hypot(mx-p.px,my-p.py)<ptSz+5){const theta=p.ang+smithAlpha*Math.PI/180;const smR=smithEnabled?getSmithR(ring.index,ring.m):1;let gamma;if(smithRMode==='unit')gamma={re:0,im:Math.tan(theta/2)};else{const A=smR*Math.cos(theta)-1,B=smR*Math.sin(theta),C=smR*Math.cos(theta)+1;const denom=C*C+B*B;gamma=denom<1e-10?{re:0,im:0}:{re:(A*C+B*B)/denom,im:B*(C-A)/denom};}modal('Residue Point',[['Residue r',p.r],['Modulus M',p.m],['GCD(r,M)',p.g],['Coprime œá(r)‚â†0',p.isGcd1?'Yes':'No'],['Angle Œ∏',fmt(p.ang*180/Math.PI)+'¬∞'],['œÜ(M)',ring.phi],smithEnabled?['Œì (Smith)',`${gamma.re.toFixed(4)} + ${gamma.im.toFixed(4)}i`]:['Ring Radius',fmt(p.rad)]]);return;}};}


function csvMod(){let s='modulus,residue,gcd,coprime,angle_deg\n';for(const ring of modRingData)for(const p of ring.pts)s+=`${p.m},${p.r},${p.g},${p.isGcd1},${p.ang*180/Math.PI}\n`;dl(s,'modular_rings.csv');}

// Dirichlet Characters
let dirData={M:12,chars:[],current:null};

function getDirichletChars(M){
// Generate all Dirichlet characters mod M
// For simplicity, we compute character values as roots of unity
const phi=eulerPhi(M);
const units=[];
for(let r=1;r<M;r++)if(gcd(r,M)===1)units.push(r);

// Find a generator if exists (primitive root)
let gen=null;
for(const g of units){if(mulOrd(g,M)===phi){gen=g;break;}}

const chars=[];
// Principal character
const chi0={idx:0,name:'œá‚ÇÄ',values:{},order:1};
for(let r=0;r<M;r++)chi0.values[r]=gcd(r,M)===1?{re:1,im:0}:{re:0,im:0};
chars.push(chi0);

// Other characters (if primitive root exists)
if(gen!==null){
for(let k=1;k<phi;k++){
const chi={idx:k,name:`œá_${k}`,values:{},order:phi/gcd(k,phi)};
for(let r=0;r<M;r++){
if(gcd(r,M)>1){chi.values[r]={re:0,im:0};}
else{
// Find discrete log of r base gen
let dlog=0,x=1;
for(let i=0;i<phi;i++){if(x===r){dlog=i;break;}x=(x*gen)%M;}
const ang=2*Math.PI*k*dlog/phi;
chi.values[r]={re:Math.cos(ang),im:Math.sin(ang)};}}
chars.push(chi);}}
else{
// No primitive root - just create principal
for(let k=1;k<Math.min(phi,10);k++){
const chi={idx:k,name:`œá_${k}`,values:{},order:1};
for(let r=0;r<M;r++)chi.values[r]=gcd(r,M)===1?{re:1,im:0}:{re:0,im:0};
chars.push(chi);}}
return chars;}

function drawDirichlet(){
const c=document.getElementById('cdir'),ctx=c.getContext('2d');
const M=+document.getElementById('dirMv').value||+document.getElementById('dirM').value;
const charIdx=+document.getElementById('dirIdx').value;
const viz=document.getElementById('dirViz').value;
const col=document.getElementById('dirCol').value;
const ptSz=+document.getElementById('dirPtSz').value;
const showLabels=document.getElementById('dirLabels').checked;
const showGrid=document.getElementById('dirGrid').checked;
const showRays=document.getElementById('dirRays').checked;
const showConnect=document.getElementById('dirConnect').checked;
const Lterms=+document.getElementById('dirLterms').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('dirMdisp').textContent=M;

// Generate characters
dirData.M=M;
dirData.chars=getDirichletChars(M);
const phi=eulerPhi(M);

// Update slider max
document.getElementById('dirIdx').max=Math.min(dirData.chars.length-1,phi-1);
const chi=dirData.chars[Math.min(charIdx,dirData.chars.length-1)]||dirData.chars[0];
dirData.current=chi;

// Update label
const idxLabel=document.getElementById('dirIdxLabel');
idxLabel.textContent=charIdx===0?'(Principal œá‚ÇÄ)':`(Order ${chi.order})`;

const cx=c.width/2,cy=c.height/2,R=Math.min(cx,cy)-80;
const pad=50,w=c.width-2*pad,h=c.height-2*pad;

// Collect data
const pts=[];
let supportCount=0,zeroCount=0;
for(let r=0;r<M;r++){
const v=chi.values[r];
const isSupport=Math.abs(v.re)>1e-10||Math.abs(v.im)>1e-10;
if(isSupport)supportCount++;else zeroCount++;
const arg=Math.atan2(v.im,v.re);
const mag=Math.sqrt(v.re*v.re+v.im*v.im);
pts.push({r,v,isSupport,arg,mag,gcdVal:gcd(r,M)});}

if(viz==='circle'||viz==='support'){
// Unit circle visualization
if(showGrid){
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,R,0,2*Math.PI);ctx.stroke();
// Axes
ctx.beginPath();ctx.moveTo(cx-R-20,cy);ctx.lineTo(cx+R+20,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,cy-R-20);ctx.lineTo(cx,cy+R+20);ctx.stroke();
// Labels
ctx.fillStyle=isDark()?'#888':'#666';ctx.font='12px Segoe UI';ctx.textAlign='center';
ctx.fillText('Re',cx+R+30,cy+4);ctx.fillText('Im',cx,cy-R-25);
ctx.fillText('1',cx+R+5,cy+15);ctx.fillText('-1',cx-R-10,cy+15);
ctx.fillText('i',cx+10,cy-R+5);ctx.fillText('-i',cx+10,cy+R+15);}

if(showRays){
ctx.strokeStyle='rgba(150,100,255,0.3)';ctx.lineWidth=1;
for(let k=0;k<phi;k++){
const ang=2*Math.PI*k/phi;
ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+R*1.1*Math.cos(ang),cy-R*1.1*Math.sin(ang));ctx.stroke();}}

// Draw character values on unit circle
const drawnPts=[];
for(const p of pts){
let x,y;
if(p.isSupport){
x=cx+R*p.v.re;y=cy-R*p.v.im;
}else{
// Zero values - place at origin or along real axis
x=cx;y=cy;}

let clr;
if(col==='support')clr=p.isSupport?'#ffd700':'#555';
else if(col==='arg')clr=p.isSupport?`hsl(${(p.arg+Math.PI)/(2*Math.PI)*360},80%,55%)`:'#555';
else if(col==='real')clr=p.isSupport?(p.v.re>=0?'#00ff88':'#ff6496'):'#555';
else clr=p.isSupport?`hsl(${chi.order*60},70%,55%)`:'#555';

if(p.isSupport){
ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();
ctx.strokeStyle=isDark()?'#fff':'#000';ctx.lineWidth=1;ctx.stroke();
drawnPts.push({x,y,p});

if(showLabels&&M<=24){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(p.r,x,y-ptSz-5);}}}

if(showConnect&&drawnPts.length>1){
ctx.strokeStyle='rgba(0,217,255,0.4)';ctx.lineWidth=1;ctx.beginPath();
const sorted=[...drawnPts].sort((a,b)=>a.p.r-b.p.r);
ctx.moveTo(sorted[0].x,sorted[0].y);
for(let i=1;i<sorted.length;i++)ctx.lineTo(sorted[i].x,sorted[i].y);
ctx.closePath();ctx.stroke();}

// Show zeros clustered
ctx.fillStyle='#555';ctx.font='11px Segoe UI';ctx.textAlign='center';
const zeros=pts.filter(p=>!p.isSupport);
if(zeros.length>0){
ctx.fillText(`œá(r)=0 for r‚àà{${zeros.slice(0,8).map(p=>p.r).join(',')}}${zeros.length>8?'...':''}`,cx,c.height-30);}}

else if(viz==='residues'){
// Residue class bar visualization
const barW=w/(M+1),barH=h*0.6;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Residue Classes mod ${M}`,cx,pad-10);

for(let r=0;r<M;r++){
const p=pts[r];
const x=pad+(r+0.5)*barW;
const barHeight=p.isSupport?barH:barH*0.2;
const clr=p.isSupport?'#ffd700':'#555';
ctx.fillStyle=clr;
ctx.fillRect(x-barW*0.4,cy+barH/2-barHeight,barW*0.8,barHeight);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';
ctx.fillText(r,x,cy+barH/2+20);
if(p.isSupport&&showLabels){
ctx.fillStyle='#00d9ff';ctx.font='9px Arial';
const vStr=p.v.im===0?p.v.re.toFixed(2):`e^{${(p.arg/Math.PI).toFixed(2)}œÄi}`;
ctx.fillText(p.v.re.toFixed(1),x,cy+barH/2-barHeight-8);}}}

else if(viz==='table'){
// Full character table
const chars=dirData.chars.slice(0,Math.min(10,phi));
const cellW=w/(M+2),cellH=25;
ctx.font='11px Segoe UI';
// Header
ctx.fillStyle='#00d9ff';ctx.textAlign='center';
ctx.fillText('r',pad+cellW/2,pad+cellH/2);
for(let r=0;r<M;r++)ctx.fillText(r,pad+(r+1.5)*cellW,pad+cellH/2);
// Rows for each character
for(let ci=0;ci<chars.length;ci++){
const chi=chars[ci];
const y=pad+(ci+1.5)*cellH;
ctx.fillStyle='#ffd700';ctx.fillText(chi.name,pad+cellW/2,y);
for(let r=0;r<M;r++){
const v=chi.values[r];
const isZ=Math.abs(v.re)<1e-10&&Math.abs(v.im)<1e-10;
ctx.fillStyle=isZ?'#555':Math.abs(v.im)<1e-10?(v.re>0?'#00ff88':'#ff6496'):'#00d9ff';
let txt=isZ?'0':Math.abs(v.im)<1e-10?v.re.toFixed(0):Math.abs(v.re)<1e-10?(v.im>0?'i':'-i'):'œâ';
ctx.fillText(txt,pad+(r+1.5)*cellW,y);}}}

else if(viz==='lfunction'){
// L-function partial sums
const sVals=[1,1.5,2,2.5,3];
const Ldata=[];
for(const s of sVals){
let Lre=0,Lim=0;
for(let n=1;n<=Lterms;n++){
const v=chi.values[n%M];
const coef=Math.pow(n,-s);
Lre+=v.re*coef;Lim+=v.im*coef;}
Ldata.push({s,Lre,Lim,Lmag:Math.sqrt(Lre*Lre+Lim*Lim)});}

Plotly.newPlot('pdirL',[
{x:sVals,y:Ldata.map(d=>d.Lre),name:'Re L(s,œá)',mode:'lines+markers',line:{color:'#00d9ff'}},
{x:sVals,y:Ldata.map(d=>d.Lim),name:'Im L(s,œá)',mode:'lines+markers',line:{color:'#ff8c00'}},
{x:sVals,y:Ldata.map(d=>d.Lmag),name:'|L(s,œá)|',mode:'lines+markers',line:{color:'#00ff88'}}
],{...plo(),xaxis:{title:'s'},yaxis:{title:'L(s,œá)'}});

ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 16px Segoe UI';ctx.textAlign='center';
ctx.fillText(`L(s,œá) = Œ£ œá(n)/nÀ¢  (${Lterms} terms)`,cx,cy-50);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='14px Segoe UI';
ctx.fillText(`L(2,œá) ‚âà ${Ldata[2].Lre.toFixed(4)} + ${Ldata[2].Lim.toFixed(4)}i`,cx,cy);
ctx.fillText(`|L(2,œá)| ‚âà ${Ldata[2].Lmag.toFixed(4)}`,cx,cy+25);}

// Distribution chart
const argBins=[];
for(let k=0;k<8;k++){
const lo=-Math.PI+k*Math.PI/4,hi=lo+Math.PI/4;
const cnt=pts.filter(p=>p.isSupport&&p.arg>=lo&&p.arg<hi).length;
argBins.push({bin:`${(lo/Math.PI*180).toFixed(0)}¬∞`,count:cnt});}
Plotly.newPlot('pdirDist',[{x:argBins.map(b=>b.bin),y:argBins.map(b=>b.count),type:'bar',marker:{color:'#9664ff'}}],{...plo(),xaxis:{title:'Argument'},yaxis:{title:'Count'}});

// Orthogonality check
const orthoData=[];
for(let i=0;i<Math.min(5,dirData.chars.length);i++){
for(let j=i;j<Math.min(5,dirData.chars.length);j++){
let sumRe=0,sumIm=0;
for(let r=0;r<M;r++){
const vi=dirData.chars[i].values[r],vj=dirData.chars[j].values[r];
sumRe+=vi.re*vj.re+vi.im*vj.im;sumIm+=vi.im*vj.re-vi.re*vj.im;}
orthoData.push({i,j,sum:Math.sqrt(sumRe*sumRe+sumIm*sumIm)});}}
Plotly.newPlot('pdirOrtho',[{x:orthoData.map(d=>`œá${d.i}¬∑œáÃÑ${d.j}`),y:orthoData.map(d=>d.sum),type:'bar',marker:{color:orthoData.map(d=>d.i===d.j?'#ffd700':'#555')}}],{...plo(),xaxis:{title:'Character Pair'},yaxis:{title:'|Œ£œá·µ¢œáÃÑ‚±º|'}});

// Legend
legend('aldir','Character Info',[['Support œá‚â†0',supportCount,'#ffd700'],['Zero œá=0',zeroCount,'#555'],['Order',chi.order,'#00d9ff']]);

// Live stats
document.getElementById('dirLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${M}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS M</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${phi}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ(M)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${dirData.chars.length}</div><div style="font-size:.7rem;color:var(--txt2)">CHARACTERS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Current Character œá_${charIdx}</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Order:</span><span style="color:#9664ff">${chi.order}</span>
<span>Support size:</span><span style="color:#ffd700">${supportCount}</span>
<span>Zero count:</span><span style="color:#555">${zeroCount}</span>
<span>Is principal:</span><span style="color:${charIdx===0?'#00ff88':'#ff6496'}">${charIdx===0?'Yes':'No'}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Support (œá(r) ‚â† 0)</strong>
<div style="margin-top:5px;font-size:.8rem;color:var(--txt2)">
r ‚àà {${pts.filter(p=>p.isSupport).slice(0,12).map(p=>p.r).join(', ')}}${supportCount>12?'...':''}
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Vanishing (œá(r) = 0)</strong>
<div style="margin-top:5px;font-size:.8rem;color:#555">
r ‚àà {${pts.filter(p=>!p.isSupport).map(p=>p.r).join(', ')||'‚àÖ'}}
</div>
</div>
<div>
<strong style="color:var(--acc)">Key Properties</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Completely multiplicative: œá(ab)=œá(a)œá(b)<br>
‚Ä¢ œá(1) = 1 always<br>
‚Ä¢ |œá(r)| = 1 when œá(r) ‚â† 0<br>
‚Ä¢ œá(r+M) = œá(r) (periodic)
</div>
</div>`;

// Table
document.getElementById('tdirT').innerHTML='<tr><th>r</th><th>gcd(r,M)</th><th>œá(r)</th><th>|œá(r)|</th><th>arg(œá(r))</th><th>Support?</th></tr>'+
pts.map(p=>`<tr onclick="modal('œá(${p.r})',[['r',${p.r}],['gcd(${p.r},${M})',${p.gcdVal}],['Re œá(r)',${p.v.re.toFixed(6)}],['Im œá(r)',${p.v.im.toFixed(6)}],['|œá(r)|',${p.mag.toFixed(6)}],['arg œá(r)',${(p.arg/Math.PI).toFixed(4)}+'œÄ']])" style="cursor:pointer;color:${p.isSupport?'#ffd700':'#555'}"><td>${p.r}</td><td>${p.gcdVal}</td><td>${p.isSupport?(Math.abs(p.v.im)<1e-6?p.v.re.toFixed(2):`${p.v.re.toFixed(2)}+${p.v.im.toFixed(2)}i`):'0'}</td><td>${p.mag.toFixed(3)}</td><td>${p.isSupport?(p.arg/Math.PI).toFixed(3)+'œÄ':'‚Äî'}</td><td>${p.isSupport?'‚úì':''}</td></tr>`).join('');

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='circle'||viz==='support'){
for(const p of pts){if(!p.isSupport)continue;
const x=cx+R*p.v.re,y=cy-R*p.v.im;
if(Math.hypot(mx-x,my-y)<ptSz+5){
modal(`œá(${p.r})`,[['r',p.r],['gcd(r,M)',p.gcdVal],['œá(r)',`${p.v.re.toFixed(4)}+${p.v.im.toFixed(4)}i`],['|œá(r)|',p.mag.toFixed(6)],['arg(œá(r))',(p.arg/Math.PI).toFixed(4)+'œÄ']]);break;}}}};}

function showAllChars(){
const M=+document.getElementById('dirMv').value;
const chars=getDirichletChars(M);
const rows=chars.slice(0,15).map(chi=>[chi.name,chi.order]);
modal(`All ${chars.length} Characters mod ${M}`,rows);}

function csvDir(){
const M=dirData.M,chi=dirData.current;
let s='r,gcd,re_chi,im_chi,mag,arg,support\n';
for(let r=0;r<M;r++){
const v=chi.values[r];
const mag=Math.sqrt(v.re*v.re+v.im*v.im);
const arg=Math.atan2(v.im,v.re);
s+=`${r},${gcd(r,M)},${v.re},${v.im},${mag},${arg},${mag>0.5?1:0}\n`;}
dl(s,'dirichlet_char.csv');}

async function screenshotDir(){
const c=document.getElementById('cdir'),dashData=extractDashboardData('dirLiveStats');
const M=document.getElementById('dirMv').value,idx=document.getElementById('dirIdx').value;
const scale=2,pad=30,dashH=350;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Dirichlet Character œá_${idx} mod ${M}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dirichlet_char.png';a.click();},'image/png',1.0);}

async function screenshotMod(){
const c=document.getElementById('cmod'),dashData=extractDashboardData('modLiveStats');
const minM=document.getElementById('modMin').value,maxM=document.getElementById('modMax').value;
const scale=2,pad=30,dashH=350;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Modular Ring System Œ∏=2œÄr/M ‚Äî M=${minM}‚Üí${maxM}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('Gold = GCD(r,M)=1 ‚Äî Dirichlet Character Support œá(r)‚â†0',pad+10,out.height/scale-30);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='modular_rings_complete.png';a.click();},'image/png',1.0);}

async function screenshot3D4K(){
const c=document.getElementById('c3d'),dashData=extractDashboardData('stats3dLive');
const res=+document.getElementById('ss3dRes').value||4,bg=document.getElementById('ss3dBg').value;
const showTitle=document.getElementById('ss3dTitle').checked,showLegend=document.getElementById('ss3dLegend').checked,showStats=document.getElementById('ss3dStats').checked;
const titleTxt=document.getElementById('ss3dTitleTxt').value||'3D Visualization';
const pad=60,titleH=showTitle?80:0,legendH=showLegend?80:0,statsH=showStats?250:0;
const out=document.createElement('canvas');out.width=c.width*res;out.height=(c.height+titleH+legendH+statsH+40)*res;
const ctx=out.getContext('2d');ctx.scale(res,res);
const isDk=bg!=='white';
if(bg==='black')ctx.fillStyle='#000';else if(bg==='white')ctx.fillStyle='#fff';else if(bg==='transparent')ctx.fillStyle='transparent';else ctx.fillStyle=canvBg();
ctx.fillRect(0,0,out.width/res,out.height/res);
let yOff=0;
if(showTitle){ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 24px Segoe UI';ctx.textAlign='center';ctx.fillText(titleTxt,c.width/2,pad);ctx.font='14px Segoe UI';ctx.fillStyle=isDk?'#aaa':'#666';ctx.fillText('By Wessen Getachew ¬∑ @7dview',c.width/2,pad+30);yOff=titleH;}
ctx.drawImage(c,0,yOff);yOff+=c.height+20;
if(showStats&&dashData.cards.length>0){
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(20,yOff,c.width-40,statsH-20);
renderDashboard(ctx,dashData,30,yOff+15,c.width-60,isDk);yOff+=statsH;}
if(showLegend){ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='left';ctx.fillText('Legend',pad,yOff+15);ctx.font='11px Segoe UI';const legs=[['GCD=1 (Primitive)','#ffd700'],['GCD=2','#00d9ff'],['GCD=3','#9664ff'],['GCD>3','#ff6496']];let lx=pad+70;legs.forEach(([txt,clr])=>{ctx.fillStyle=clr;ctx.fillRect(lx,yOff+5,12,12);ctx.fillStyle=isDk?'#e0e0ff':'#333';ctx.fillText(txt,lx+16,yOff+15);lx+=130;});}
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',c.width/2,out.height/res-15);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`mobius_3d_${res}x.png`;a.click();},'image/png',1.0);}

draw2D();
</script>
</body>
                                                                                                        </html>
