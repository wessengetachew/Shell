
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geometric M√∂bius Shell Sieve</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1f3a;--bg2:#252d4a;--acc:#0084d1;--acc2:#ff4081;--acc3:#26c485;--txt:#fff;--txt2:#b0b8d8;--plot:rgba(10,14,39,0.8)}
body.light{--bg:#f5f7fa;--bg2:#fff;--acc:#0066cc;--acc2:#d32f2f;--acc3:#388e3c;--txt:#1a1a1a;--txt2:#4a5568;--plot:rgba(245,247,250,0.95)}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,var(--bg),#1a2a4a);color:var(--txt);line-height:1.6}
header{background:var(--bg2);border-bottom:2px solid var(--acc);padding:1rem 2rem}
h1{font-size:1.8rem;color:var(--acc)}
.hdr{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.container{max-width:1800px;margin:0 auto;padding:0 1rem 2rem}
.snav{background:var(--bg2);padding:1rem;border-radius:8px;margin-bottom:1.5rem;display:flex;gap:.5rem;flex-wrap:wrap}
.nbtn{background:rgba(0,217,255,.1);color:var(--acc);border:2px solid var(--acc);padding:.7rem 1.2rem;border-radius:4px;cursor:pointer;font-weight:600;font-size:.95rem}
.nbtn:hover,.nbtn.active{background:var(--acc);color:var(--bg)}
.sec{display:none}.sec.active{display:block}
.tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;border-bottom:2px solid rgba(0,217,255,.2);flex-wrap:wrap}
.tbtn{background:transparent;color:var(--txt2);border:none;padding:.7rem 1.2rem;cursor:pointer;font-size:.95rem;border-bottom:3px solid transparent}
.tbtn:hover{color:var(--acc)}.tbtn.active{color:var(--acc);border-bottom-color:var(--acc)}
.tab{display:none}.tab.active{display:block}
.ctrl{background:var(--bg2);padding:1rem;border-radius:8px;margin-bottom:1rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.8rem}
.cg{display:flex;flex-direction:column}
.cg label{color:var(--acc);margin-bottom:.3rem;font-weight:600;font-size:.85rem;display:flex;align-items:center;gap:.3rem}
.tip{width:16px;height:16px;background:var(--acc);color:var(--bg);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:bold;cursor:help}
.cg input,.cg select{background:var(--bg);color:var(--txt);border:2px solid var(--acc);padding:.5rem;border-radius:4px}
.sig{display:flex;gap:.4rem;align-items:center}
.sig input[type="range"]{flex:1}.sig input[type="number"]{width:70px}
button{background:var(--acc2);color:#fff;border:none;padding:.6rem 1rem;border-radius:4px;cursor:pointer;font-weight:600;margin-right:.4rem;margin-bottom:.5rem}
button:hover{background:var(--acc)}
button.s{background:var(--acc3);color:#000}
.bg{display:flex;flex-wrap:wrap;margin-bottom:1rem}
.viz{background:var(--bg2);border-radius:8px;padding:1rem;margin-bottom:1rem;border:1px solid rgba(0,217,255,.2)}
.viz h3{color:var(--acc);margin-bottom:.8rem;font-size:1.1rem}
canvas{display:block;border:2px solid var(--acc);border-radius:6px;width:100%;max-width:800px;height:auto;margin:0 auto .8rem;cursor:crosshair}
.pc{width:100%;height:400px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:1200px){.g2{grid-template-columns:1fr}}
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:.5rem;margin-top:.5rem}
.sb{background:rgba(0,217,255,.1);border:1px solid var(--acc);padding:.5rem;border-radius:4px;text-align:center}
.sl{color:var(--txt2);font-size:.75rem}.sv{color:var(--acc);font-size:1.1rem;font-weight:700;font-family:monospace}
table{width:100%;border-collapse:collapse;font-size:.85rem;margin-top:.8rem}
th,td{padding:.5rem;text-align:left;border-bottom:1px solid rgba(0,217,255,.2)}
th{color:var(--acc);background:rgba(0,217,255,.1)}
.al{background:rgba(0,217,255,.05);padding:.8rem;border-radius:4px;margin-top:.8rem;border:1px solid rgba(0,217,255,.2)}
.al h4{color:var(--acc);margin-bottom:.5rem;font-size:.95rem}
.lg{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem}
.li{background:var(--bg);padding:.5rem;border-radius:4px;border-left:4px solid var(--acc);font-size:.75rem}
.li strong{color:var(--acc);display:block}.li .v{color:var(--txt2);font-family:monospace}
.ts{background:var(--bg2);padding:2rem;border-radius:8px;margin-bottom:1.5rem;border-left:4px solid var(--acc2)}
.ts h2{color:var(--acc);margin:1.5rem 0 1rem;font-size:1.5rem}.ts h2:first-child{margin-top:0}
.ts h3{color:var(--acc2);margin:1rem 0 .5rem;font-size:1.2rem}
.ts p,.ts li{color:var(--txt2);margin-bottom:.8rem;line-height:1.8}
.ts ul{margin-left:2rem}
.fm{background:rgba(0,0,0,.4);padding:1rem;font-family:monospace;margin:1rem 0;border-left:3px solid var(--acc2);border-radius:4px;overflow-x:auto}
body.light .fm{background:rgba(0,0,0,.08)}
.rs{background:var(--bg2);padding:1.5rem;border-radius:8px;margin-bottom:1.5rem;border-left:4px solid var(--acc)}
.rs h3{color:var(--acc);margin-bottom:.8rem;font-size:1.15rem}
.rs h4{color:var(--acc2);margin:1rem 0 .5rem}
.rs p,.rs li{color:var(--txt2);margin-bottom:.6rem;line-height:1.7}
.rs ul,.rs ol{margin-left:1.5rem}
.fb{background:rgba(0,217,255,.08);padding:1rem;border-radius:4px;margin:.8rem 0;border:1px solid rgba(0,217,255,.3);border-left:4px solid var(--acc2)}
.fb strong{color:var(--acc)}
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.mc{background:var(--bg2);padding:2rem;border:2px solid var(--acc);border-radius:8px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
.mc h2{color:var(--acc);margin-bottom:1rem}
.ds{background:rgba(0,217,255,.1);padding:1rem;border-radius:4px;margin:.5rem 0;border-left:3px solid var(--acc)}
.dr{display:flex;justify-content:space-between;padding:.3rem 0;font-family:monospace}
.dl{color:var(--acc2);font-weight:600}.dv{color:var(--acc);font-weight:700}
.mx{color:var(--acc);float:right;font-size:2rem;cursor:pointer}
.prec{display:flex;align-items:center;gap:.5rem}
.prec label{color:var(--acc);font-weight:600}
.prec select{background:var(--bg);color:var(--acc);border:1px solid var(--acc);padding:.4rem}
.thm{background:var(--bg2);color:var(--acc);border:2px solid var(--acc);padding:.6rem .9rem;border-radius:4px;font-size:1.2rem;cursor:pointer;min-width:44px}
footer{text-align:center;padding:2rem;color:var(--txt2);border-top:1px solid rgba(0,217,255,.2);margin-top:2rem}
</style>
</head>
<body>
<header>
<div class="hdr">
<h1>Geometric M√∂bius Shell Sieve: Complete Research Platform</h1>
<div style="display:flex;gap:1rem;align-items:center">
<button class="thm" onclick="toggleTheme()" title="Toggle Theme" id="thm">D</button>
<div class="prec"><label>Precision:</label><select id="prec" onchange="P=+this.value">
<option value="2">2</option><option value="4" selected>4</option><option value="6">6</option><option value="8">8</option><option value="10">10</option><option value="12">12</option><option value="14">14</option><option value="16">16</option>
</select></div>
</div>
</div>
</header>
<div class="container">
<div class="snav">
<button class="nbtn active" onclick="showSec('theory',this)">Theory</button>
<button class="nbtn" onclick="showSec('tools',this)">Interactive Tools</button>
<button class="nbtn" onclick="showSec('ref',this)">Reference</button>
</div>

<div id="theory" class="sec active">
<div class="ts">
<h2>Geometric M√∂bius Shell Sieve for Primitive Lattice Points</h2>
<h3>Introduction</h3>
<p>The problem of counting primitive lattice points (points with gcd = 1) in a scaled convex body is fundamental in analytic number theory. This platform presents the Geometric M√∂bius Shell Sieve‚Äîa dimension-universal approach that reveals the sieve mechanism geometrically through multi-scale decomposition.</p>
<h3>Main Theorem</h3>
<div class="fm">N_K(R) = [Vol(K) / Œ∂(n)] ¬∑ R^n + O(R^(n-1))</div>
<p>For n ‚â• 3 and K a bounded convex body with piecewise C¬π boundary:</p>
<ul>
<li><strong>N_K(R):</strong> Count of primitive lattice points in RK</li>
<li><strong>Vol(K):</strong> Volume of the convex body K</li>
<li><strong>Œ∂(n):</strong> Riemann zeta function at n</li>
<li><strong>R^n:</strong> Scaling factor (volume order)</li>
<li><strong>O(R^(n-1)):</strong> Error term (surface area order)</li>
</ul>
<h3>M√∂bius Decomposition</h3>
<div class="fm">N_K(R) = Œ£_{k=1}^‚àû Œº(k) ¬∑ L_K(R/k)</div>
<p>The core identity uses inclusion-exclusion via the M√∂bius function:</p>
<ul>
<li>Œº(k) provides alternating signs for sieve layers</li>
<li>L_K(r) counts all lattice points in ball of radius r</li>
<li>Each divisor k defines a shell at scale R/k</li>
<li>M√∂bius signs cancel non-primitive contributions exactly (in volume)</li>
</ul>
<h3>Volume Contribution (Exact)</h3>
<div class="fm">Œ£_{k=1}^‚àû Œº(k) ¬∑ Vol(K_{R/k}) = [Vol(K) / Œ∂(n)] ¬∑ R^n</div>
<p>This remarkable identity follows from the Dirichlet series: Œ£ Œº(k)/k^n = 1/Œ∂(n).</p>
<h3>Primitive Density: 1/Œ∂(n)</h3>
<div class="fm">P_n = 1 / Œ∂(n) = probability that random n-tuple is primitive</div>
<ul>
<li>n=2 (pairs): 1/Œ∂(2) = 0.6079271018540266 (60.79271019% of integer pairs coprime)</li>
<li>n=3 (triples): 1/Œ∂(3) = 0.8319073725807075 (83.19073726% coprime)</li>
<li>n=4: 1/Œ∂(4) = 0.9239393750608806 (92.39393751% coprime)</li>
<li>n=5: 1/Œ∂(5) ‚âà 0.96449 (‚âà96% coprime)</li>
<li>n=6: 1/Œ∂(6) ‚âà 0.98296 (‚âà98% coprime)</li>
<li>n=7: 1/Œ∂(7) ‚âà 0.99171 (‚âà99% coprime)</li>
</ul>
<h3>Error Term Analysis</h3>
<div class="fm">|Error| = O(R^(n-1))</div>
<p>The error arises entirely from lattice points clustered near boundaries. As dimension increases, error becomes negligible for large R.</p>
<h3>Key Insights</h3>
<ul>
<li><strong>Œ∂(n)^(-1) Density:</strong> The inverse zeta function emerges as the natural density of primitive integers.</li>
<li><strong>Shape Independence:</strong> The leading term depends only on Vol(K) and Œ∂(n), not boundary details.</li>
<li><strong>Multi-Scale Sieve:</strong> The M√∂bius inversion acts as a geometric filter.</li>
<li><strong>Dimension Universal:</strong> The formula holds for all dimensions n ‚â• 3.</li>
<li><strong>GCD Multiplication Table:</strong> The 2D lattice within a circle is fundamentally a bounded GCD multiplication table. Each point (x,y) represents an entry where gcd(x,y) determines the "cell value". The primitive points (GCD=1) correspond to coprime pairs‚Äîthe units in the multiplicative structure.</li>
<li><strong>Four-Quadrant Symmetry:</strong> The lattice exhibits 4-fold rotational symmetry, mirroring the structure of modular arithmetic tables when viewed as rings.</li>
</ul>
<h3>M√∂bius Function Œº(n)</h3>
<ul>
<li>Œº(1) = 1 (base case)</li>
<li>Œº(n) = 0 if n has a squared prime factor</li>
<li>Œº(n) = (-1)^k if n is product of k distinct primes</li>
</ul>
<p>Examples: Œº(2) = -1, Œº(3) = -1, Œº(4) = 0, Œº(6) = 1, Œº(30) = -1</p>
<h3>Connections to Deep Mathematics</h3>
<ul>
<li><strong>Diophantine Approximation:</strong> Farey sequences and continued fractions</li>
<li><strong>Analytic Number Theory:</strong> Dirichlet series and Euler products</li>
<li><strong>Geometry of Numbers:</strong> Minkowski's theory of lattices</li>
<li><strong>Harmonic Analysis:</strong> Fourier analysis on lattices</li>
</ul>

<hr style="border:none;border-top:2px solid var(--bord);margin:2rem 0">

<h2>Complete Platform Reference</h2>
<p style="color:var(--txt2);font-style:italic">41 interactive visualization tools spanning 300 years of number theory</p>

<h3>Mathematical Credits (Chronological)</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin:1rem 0">
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #00ff88">
<strong style="color:#00ff88">Leonhard Euler (1707‚Äì1783)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Euler product formula (1737), Basel problem Œ∂(2)=œÄ¬≤/6 (1734), totient function œÜ(n), Euler's criterion for quadratic residues</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">John Farey (1766‚Äì1826)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Farey sequences F_n (1816), mediant property, connection to continued fractions and rational approximation</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #ffd700">
<strong style="color:#ffd700">Carl Friedrich Gauss (1777‚Äì1855)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Gaussian integers ‚Ñ§[i], Circle Problem, prime counting conjecture œÄ(x)~x/ln(x), quadratic reciprocity (1801)</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #ff006e">
<strong style="color:#ff006e">August Ferdinand M√∂bius (1790‚Äì1868)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">M√∂bius function Œº(n) (1832), M√∂bius inversion formula, inclusion-exclusion in number theory</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #9664ff">
<strong style="color:#9664ff">Peter Gustav Lejeune Dirichlet (1805‚Äì1859)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">L-functions, Dirichlet characters, theorem on primes in arithmetic progressions (1837)</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #ff8c00">
<strong style="color:#ff8c00">Arthur Cayley (1821‚Äì1895)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Cayley transform mapping unit disk to upper half-plane, foundations of hyperbolic geometry</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #00ff88">
<strong style="color:#00ff88">Alphonse de Polignac (1826‚Äì1863)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Twin prime conjecture (1849), Polignac's conjecture on prime gaps of any even size</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Bernhard Riemann (1826‚Äì1866)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Zeta function Œ∂(s) (1859), Riemann Hypothesis, explicit formula for œÄ(x), analytic continuation</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #ffd700">
<strong style="color:#ffd700">G.H. Hardy (1877‚Äì1947)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Prime race analysis, circle method, Hardy-Littlewood conjecture on twin primes, work with Ramanujan</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #ff006e">
<strong style="color:#ff006e">Wac≈Çaw Sierpi≈Ñski (1882‚Äì1969)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Sierpi≈Ñski problem (1964): coverage of positive integers by forms 6ab¬±a¬±b</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #9664ff">
<strong style="color:#9664ff">J.E. Littlewood (1885‚Äì1977)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Collaborated with Hardy on prime distribution, circle method, and analytic number theory</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #ff8c00">
<strong style="color:#ff8c00">Viggo Brun (1885‚Äì1978)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Brun sieve (1915), twin prime constant B‚ÇÇ‚âà1.902, proved Œ£(1/p) over twin primes converges</span>
</div>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;border-left:3px solid #00ff88">
<strong style="color:#00ff88">Lester R. Ford (1886‚Äì1967)</strong><br>
<span style="color:var(--txt2);font-size:.9rem">Ford circles (1938), tangency conditions, geometric visualization of Farey sequences</span>
</div>
</div>

<h3>Core Theorems (Chronological)</h3>
<div style="background:var(--bg2);padding:1rem;border-radius:8px;margin:1rem 0">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem">
<div>
<strong style="color:#00ff88">Basel Problem ‚Äî Euler (1734)</strong>
<div class="fm">Œ∂(2) = 1 + 1/4 + 1/9 + ... = œÄ¬≤/6</div>
<span style="color:var(--txt2);font-size:.85rem">First exact value of Œ∂(n), solved 90-year-old problem</span>
</div>
<div>
<strong style="color:#00d9ff">Euler Product ‚Äî Euler (1737)</strong>
<div class="fm">Œ∂(s) = Œ£ n‚ÅªÀ¢ = ‚àè_p (1 - p‚ÅªÀ¢)‚Åª¬π</div>
<span style="color:var(--txt2);font-size:.85rem">Fundamental connection between primes and zeta</span>
</div>
<div>
<strong style="color:#ffd700">M√∂bius Inversion (1832)</strong>
<div class="fm">g(n) = Œ£_{d|n} f(d) ‚ü∫ f(n) = Œ£_{d|n} Œº(d)g(n/d)</div>
<span style="color:var(--txt2);font-size:.85rem">Fundamental sieve identity</span>
</div>
<div>
<strong style="color:#ff006e">Dirichlet's Theorem (1837)</strong>
<div class="fm">œÄ(x;q,a) ~ x/(œÜ(q)¬∑ln x) for gcd(a,q)=1</div>
<span style="color:var(--txt2);font-size:.85rem">Infinitely many primes in each coprime residue class</span>
</div>
<div>
<strong style="color:#9664ff">Riemann Hypothesis (1859)</strong>
<div class="fm">Œ∂(s) = 0 ‚üπ Re(s) = ¬Ω (nontrivial zeros)</div>
<span style="color:var(--txt2);font-size:.85rem">Implies |M(n)| = O(n^(¬Ω+Œµ)), still unproven</span>
</div>
<div>
<strong style="color:#ff8c00">Prime Number Theorem (1896)</strong>
<div class="fm">œÄ(x) ~ x/ln(x) ~ Li(x)</div>
<span style="color:var(--txt2);font-size:.85rem">Hadamard & de la Vall√©e Poussin, independently</span>
</div>
<div>
<strong style="color:#00ff88">Brun's Theorem (1915)</strong>
<div class="fm">B‚ÇÇ = Œ£(1/p + 1/(p+2)) ‚âà 1.902</div>
<span style="color:var(--txt2);font-size:.85rem">Sum over twin primes converges (unlike Œ£1/p)</span>
</div>
<div>
<strong style="color:#00d9ff">Hardy-Littlewood Conjecture (~1923)</strong>
<div class="fm">œÄ‚ÇÇ(x) ~ 2C‚ÇÇ ¬∑ x/(ln x)¬≤</div>
<span style="color:var(--txt2);font-size:.85rem">Twin prime asymptotic, C‚ÇÇ‚âà0.66 (twin prime constant)</span>
</div>
</div>
</div>

<h3>All 23 Tabs ‚Äî Quick Reference</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:1rem;margin:1rem 0">

<div style="background:var(--bg2);padding:1rem;border-radius:8px">
<h4 style="color:var(--acc);margin:0 0 .5rem 0;border-bottom:1px solid var(--bord);padding-bottom:.3rem">‚ë† Lattice & Geometry (Tabs 1‚Äì3)</h4>
<div style="font-size:.85rem;color:var(--txt2);line-height:1.6">
<strong style="color:#00ff88">1. 2D Lattice:</strong> Primitive points in circle/square. Density ‚Üí 6/œÄ¬≤ = 60.79271019%<br>
<strong style="color:#00d9ff">2. 3D Ball:</strong> Primitive points in sphere. Density ‚Üí 1/Œ∂(3) = 83.19073726%<br>
<strong style="color:#ffd700">3. M√∂bius Œº(n):</strong> Sieve function, Mertens M(n), squarefree decomposition
</div>
</div>

<div style="background:var(--bg2);padding:1rem;border-radius:8px">
<h4 style="color:var(--acc);margin:0 0 .5rem 0;border-bottom:1px solid var(--bord);padding-bottom:.3rem">‚ë° Modular Arithmetic (Tabs 4‚Äì7)</h4>
<div style="font-size:.85rem;color:var(--txt2);line-height:1.6">
<strong style="color:#00ff88">4. Modular Rings:</strong> Unit circle at angle 2œÄr/M for coprime residues<br>
<strong style="color:#00d9ff">5. Cayley ‚Ñç:</strong> Transform to hyperbolic half-plane, Ford circles<br>
<strong style="color:#ffd700">6. Farey:</strong> Sequences F_n, mediant property, |F_n| = 1 + Œ£œÜ(k)<br>
<strong style="color:#ff006e">7. Primitive Roots:</strong> Generators of (‚Ñ§/p‚Ñ§)*, order analysis, power sequences
</div>
</div>

<div style="background:var(--bg2);padding:1rem;border-radius:8px">
<h4 style="color:var(--acc);margin:0 0 .5rem 0;border-bottom:1px solid var(--bord);padding-bottom:.3rem">‚ë¢ Analysis & Error (Tabs 8‚Äì10)</h4>
<div style="font-size:.85rem;color:var(--txt2);line-height:1.6">
<strong style="color:#00ff88">8. Error:</strong> Deviation from Vol(K)/Œ∂(n)¬∑R‚Åø, boundary effects<br>
<strong style="color:#00d9ff">9. Dims:</strong> Primitive density 1/Œ∂(n) for dimensions 2‚Äì20<br>
<strong style="color:#ffd700">10. Shells:</strong> M√∂bius shell decomposition, layer-by-layer sieve
</div>
</div>

<div style="background:var(--bg2);padding:1rem;border-radius:8px">
<h4 style="color:var(--acc);margin:0 0 .5rem 0;border-bottom:1px solid var(--bord);padding-bottom:.3rem">‚ë£ Classical Problems (Tabs 11‚Äì14)</h4>
<div style="font-size:.85rem;color:var(--txt2);line-height:1.6">
<strong style="color:#00ff88">11. GCD:</strong> Distribution of gcd(x,y) in lattice, P(gcd=k) = 1/(k¬≤Œ∂(2))<br>
<strong style="color:#00d9ff">12. Gaussian:</strong> ‚Ñ§[i] primes, norm N(a+bi)=a¬≤+b¬≤, splitting behavior<br>
<strong style="color:#ffd700">13. Circle:</strong> Gauss problem N(R)=œÄR¬≤+O(R^Œ∏), Hardy conjecture Œ∏=¬Ω+Œµ<br>
<strong style="color:#ff006e">14. Density:</strong> High-dimensional 1/Œ∂(n) verification, Monte Carlo sampling
</div>
</div>

<div style="background:var(--bg2);padding:1rem;border-radius:8px">
<h4 style="color:var(--acc);margin:0 0 .5rem 0;border-bottom:1px solid var(--bord);padding-bottom:.3rem">‚ë§ Characters & Primes (Tabs 15‚Äì17)</h4>
<div style="font-size:.85rem;color:var(--txt2);line-height:1.6">
<strong style="color:#00ff88">15. Dirichlet œá:</strong> Characters mod q, L-functions, orthogonality relations<br>
<strong style="color:#00d9ff">16. Twin Primes:</strong> Gaps p_{n+1}-p_n=2, Brun constant, Hardy-Littlewood conjecture<br>
<strong style="color:#ffd700">17. œÄ(x):</strong> Prime counting, Li(x) approximation, Riemann's explicit formula
</div>
</div>

<div style="background:var(--bg2);padding:1rem;border-radius:8px">
<h4 style="color:var(--acc);margin:0 0 .5rem 0;border-bottom:1px solid var(--bord);padding-bottom:.3rem">‚ë• Advanced Topics (Tabs 18‚Äì23)</h4>
<div style="font-size:.85rem;color:var(--txt2);line-height:1.6">
<strong style="color:#00ff88">18. Composite:</strong> Channel projection for composite moduli, divisor lattice<br>
<strong style="color:#00d9ff">19. Coprime Pairs:</strong> Density in N√óN grid, RH connection via M(n)/‚àön<br>
<strong style="color:#ffd700">20. Sierpi≈Ñski:</strong> Coverage by 6ab¬±a¬±b, uncovered integers analysis<br>
<strong style="color:#ff006e">21. k-Free:</strong> Squarefree (k=2), cubefree (k=3), density 1/Œ∂(k)<br>
<strong style="color:#9664ff">22. Euler ‚àè:</strong> Product formula Œ∂(s)=‚àè(1-p‚ÅªÀ¢)‚Åª¬π, compute œÄ from Œ∂(2)<br>
<strong style="color:#ff8c00">23. Chord CV:</strong> Primality heuristic via coprime gap uniformity (Getachew 2025)
</div>
</div>
</div>

<h3>Key Formulas by Tab</h3>
<table style="width:100%;font-size:.85rem">
<tr><th>Tab</th><th>Primary Formula</th><th>Key Result</th></tr>
<tr><td>2D Lattice</td><td>N(R) = (6/œÄ¬≤)œÄR¬≤ + O(R)</td><td>60.79271019% primitive</td></tr>
<tr><td>3D Ball</td><td>N(R) = (4œÄ/3Œ∂(3))R¬≥ + O(R¬≤)</td><td>83.19073726% primitive</td></tr>
<tr><td>M√∂bius</td><td>Œº(n) = (-1)^k if squarefree, else 0</td><td>Œ£Œº(d) = [n=1]</td></tr>
<tr><td>Farey</td><td>|F_n| = 1 + Œ£_{k=1}^n œÜ(k)</td><td>~3n¬≤/œÄ¬≤ fractions</td></tr>
<tr><td>Primitive Roots</td><td>ord_p(g) = p-1 ‚ü∫ g primitive</td><td>œÜ(p-1) generators</td></tr>
<tr><td>Circle Problem</td><td>N(R) = œÄR¬≤ + O(R^Œ∏)</td><td>Œ∏ ‚â§ 131/208 ‚âà 0.63</td></tr>
<tr><td>Dirichlet</td><td>L(s,œá) = Œ£ œá(n)n‚ÅªÀ¢</td><td>L(1,œá) ‚â† 0 for œá‚â†œá‚ÇÄ</td></tr>
<tr><td>Twin Primes</td><td>B‚ÇÇ = Œ£(1/p + 1/(p+2))</td><td>B‚ÇÇ ‚âà 1.902160583</td></tr>
<tr><td>œÄ(x)</td><td>œÄ(x) = Li(x) + O(x¬∑e^(-c‚àöln x))</td><td>RH ‚üπ O(‚àöx ln x)</td></tr>
<tr><td>k-Free</td><td>Q_k(N) = N/Œ∂(k) + O(N^(1/k))</td><td>k=2: ~60.79% sqfree</td></tr>
<tr><td>Euler Product</td><td>œÄ = ‚àö(6¬∑‚àè_p(1-p‚Åª¬≤)‚Åª¬π)</td><td>Compute œÄ from primes</td></tr>
<tr><td>Chord CV</td><td>CV = œÉ_L/Œº_L for chord lengths</td><td>Primes: CV‚Üí0, Comp: CV‚âà0.30</td></tr>
</table>

<h3>Riemann Zeta Reference Values</h3>
<table style="font-size:.85rem">
<tr><th>n</th><th>Œ∂(n)</th><th>1/Œ∂(n)</th><th>Closed Form</th><th>Interpretation</th></tr>
<tr><td>2</td><td>1.6449340668</td><td>0.6079271019</td><td>œÄ¬≤/6</td><td>60.79271019% pairs coprime</td></tr>
<tr><td>3</td><td>1.2020569032</td><td>0.8319073726</td><td>Ap√©ry's constant</td><td>83.19073726% triples coprime</td></tr>
<tr><td>4</td><td>1.0823232337</td><td>0.9239393751</td><td>œÄ‚Å¥/90</td><td>92.39393751% 4-tuples coprime</td></tr>
<tr><td>5</td><td>1.0369277551</td><td>0.9643969402</td><td>‚Äî</td><td>96.43969402% 5-tuples coprime</td></tr>
<tr><td>6</td><td>1.0173430620</td><td>0.9829525700</td><td>œÄ‚Å∂/945</td><td>98.29525700% 6-tuples coprime</td></tr>
<tr><td>8</td><td>1.0040773562</td><td>0.9959389757</td><td>œÄ‚Å∏/9450</td><td>99.59389757% 8-tuples coprime</td></tr>
</table>

<h3>Academic References</h3>
<ul style="font-size:.85rem;color:var(--txt2)">
<li>Edwards, H.M. <em>Riemann's Zeta Function</em> (1974) ‚Äî Definitive treatment of Œ∂(s)</li>
<li>Apostol, T.M. <em>Introduction to Analytic Number Theory</em> (1976) ‚Äî Standard graduate text</li>
<li>Hardy, G.H. & Wright, E.M. <em>An Introduction to the Theory of Numbers</em> (6th ed., 2008)</li>
<li>Davenport, H. <em>Multiplicative Number Theory</em> (3rd ed., 2000) ‚Äî Dirichlet L-functions</li>
<li>Titchmarsh, E.C. <em>The Theory of the Riemann Zeta-Function</em> (2nd ed., 1986)</li>
<li>Montgomery, H.L. & Vaughan, R.C. <em>Multiplicative Number Theory I</em> (2007)</li>
<li>Iwaniec, H. & Kowalski, E. <em>Analytic Number Theory</em> (2004) ‚Äî Modern comprehensive reference</li>
<li>OEIS Foundation. <em>The On-Line Encyclopedia of Integer Sequences</em> ‚Äî oeis.org</li>
</ul>

<h3>Platform Features</h3>
<ul style="font-size:.85rem;color:var(--txt2)">
<li><strong>Live Dashboards:</strong> Real-time statistics with color-coded metrics</li>
<li><strong>Theory Panels:</strong> Mathematical context for each visualization</li>
<li><strong>Interactive Charts:</strong> Plotly.js with hover details and zoom</li>
<li><strong>Click Inspector:</strong> Click any point/row for detailed modal</li>
<li><strong>CSV Export:</strong> Download raw data for external analysis</li>
<li><strong>Screenshot:</strong> Capture visualization + dashboard as PNG</li>
<li><strong>Dual Controls:</strong> Slider + numeric input for all parameters</li>
<li><strong>Dark/Light Mode:</strong> Toggle with 'D/L' button</li>
</ul>

<div style="margin-top:2rem;padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;text-align:center">
<strong style="color:#00ff88">Created by Wessen Getachew</strong><br>
<span style="color:var(--txt2);font-size:.85rem">wessengetachew.github.io ‚Äî @7dview</span><br>
<span style="color:var(--txt2);font-size:.8rem;font-style:italic">"Mathematics is the art of giving the same name to different things." ‚Äî Henri Poincar√©</span>
</div>
</div>
</div>

<div id="tools" class="sec">
<div class="tabs">
<button class="tbtn active" onclick="showTab('t2d',this)">2D Lattice</button>
<button class="tbtn" onclick="showTab('t3d',this)">3D Ball</button>
<button class="tbtn" onclick="showTab('tmob',this)">M√∂bius Œº(n)</button>
<button class="tbtn" onclick="showTab('tmod',this)">Modular 2œÄr/M</button>
<button class="tbtn" onclick="showTab('tcayley',this)">Cayley ‚Ñç</button>
<button class="tbtn" onclick="showTab('tfarey',this)">Farey</button>
<button class="tbtn" onclick="showTab('tprim',this)">Primitive Roots</button>
<button class="tbtn" onclick="showTab('terr',this)">Error</button>
<button class="tbtn" onclick="showTab('tdim',this)">Dims</button>
<button class="tbtn" onclick="showTab('tsh',this)">Shells</button>
<button class="tbtn" onclick="showTab('tgcd',this)">GCD</button>
<button class="tbtn" onclick="showTab('tgaus',this)">Gaussian</button>
<button class="tbtn" onclick="showTab('tcirc',this)">Circle</button>
<button class="tbtn" onclick="showTab('tdens',this)">Density 1/Œ∂</button>
<button class="tbtn" onclick="showTab('tdir',this)">Dirichlet œá</button>
<button class="tbtn" onclick="showTab('ttwin',this)">Twin Primes</button>
<button class="tbtn" onclick="showTab('tpi',this)">œÄ(x)</button>
<button class="tbtn" onclick="showTab('tcomp',this)">Composite</button>
<button class="tbtn" onclick="showTab('tcopair',this)">Coprime Pairs</button>
<button class="tbtn" onclick="showTab('tsierp',this)">Sierpi≈Ñski</button>
<button class="tbtn" onclick="showTab('tkfree',this)">k-Free</button>
<button class="tbtn" onclick="showTab('teuler',this)">Euler ‚àè</button>
<button class="tbtn" onclick="showTab('tchord',this)">Chord CV</button>
<button class="tbtn" onclick="showTab('tgold',this)">Goldbach</button>
<button class="tbtn" onclick="showTab('tgap',this)">Prime Gaps</button>
<button class="tbtn" onclick="showTab('tsoph',this)">Sophie Germain</button>
<button class="tbtn" onclick="showTab('tmert',this)">Mertens M(x)</button>
<button class="tbtn" onclick="showTab('tcheb',this)">Chebyshev œà</button>
<button class="tbtn" onclick="showTab('tli',this)">Li(x)</button>
<button class="tbtn" onclick="showTab('tdiv',this)">Divisor d(n)</button>
<button class="tbtn" onclick="showTab('tliou',this)">Liouville Œª</button>
<button class="tbtn" onclick="showTab('tmang',this)">Mangoldt Œõ</button>
<button class="tbtn" onclick="showTab('tram',this)">Ramanujan c_q</button>
<button class="tbtn" onclick="showTab('tulam',this)">Ulam Spiral</button>
<button class="tbtn" onclick="showTab('tsacks',this)">Sacks Spiral</button>
<button class="tbtn" onclick="showTab('thardy',this)">Hardy Z(t)</button>
<button class="tbtn" onclick="showTab('tgram',this)">Gram Points</button>
<button class="tbtn" onclick="showTab('texplicit',this)">Explicit œÄ(x)</button>
<button class="tbtn" onclick="showTab('tzerocount',this)">N(T) Zeros</button>
<button class="tbtn" onclick="showTab('targand',this)">Œ∂(s) Argand</button>
<button class="tbtn" onclick="showTab('tzetareal',this)">Œ∂(s) Real</button>
<button class="tbtn" onclick="showTab('tmontgomery',this)">Montgomery</button>
<button class="tbtn" onclick="showTab('tgue',this)">GUE Stats</button>
<button class="tbtn" onclick="showTab('tprimerace',this)">Prime Races</button>
<button class="tbtn" onclick="showTab('tlfunc',this)">L-functions</button>
<button class="tbtn" onclick="showTab('tlfunczeros',this)">L-func Zeros</button>
<button class="tbtn" onclick="showTab('tquantum',this)">Quantum Orbitals</button>
<button class="tbtn" onclick="showTab('tktuples',this)">Prime k-Tuples</button>
<button class="tbtn" onclick="showTab('tcarmichael',this)">Carmichael</button>
<button class="tbtn" onclick="showTab('tmersenne',this)">Mersenne</button>
<button class="tbtn" onclick="showTab('tcontinued',this)">Continued Fractions</button>
<button class="tbtn" onclick="showTab('tsternbrocot',this)">Stern-Brocot</button>
<button class="tbtn" onclick="showTab('tpythag',this)">Pythagorean</button>
<button class="tbtn" onclick="showTab('tsumsquares',this)">Sum of Squares</button>
<button class="tbtn" onclick="showTab('tquadres',this)">Quadratic Residues</button>
<button class="tbtn" onclick="showTab('tpartition',this)">Partitions p(n)</button>
<button class="tbtn" onclick="showTab('tbernoulli',this)">Bernoulli</button>
<button class="tbtn" onclick="showTab('tfibonacci',this)">Fibonacci</button>
<button class="tbtn" onclick="showTab('tcatalan',this)">Catalan</button>
<button class="tbtn" onclick="showTab('taliquot',this)">Aliquot</button>
<button class="tbtn" onclick="showTab('tcyclotomic',this)">Cyclotomic</button>
<button class="tbtn" onclick="showTab('tcollatz',this)">Collatz</button>
<button class="tbtn" onclick="showTab('thighcomp',this)">Highly Composite</button>
<button class="tbtn" onclick="showTab('tperfect',this)">Perfect Numbers</button>
<button class="tbtn" onclick="showTab('ttaxicab',this)">Taxicab</button>
<button class="tbtn" onclick="showTab('telliptic',this)">Elliptic Curves</button>
</div>

<div id="t2d" class="tab active">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Scaling parameter">?</span></label><div class="sig"><input type="range" id="r2d" min="1" max="200" step=".5" value="4" oninput="document.getElementById('r2dv').value=this.value;draw2DDebounced()"><input type="number" id="r2dv" value="4" min="1" step=".5" max="1000"><button onclick="draw2D()" style="padding:2px 8px;margin-left:4px;border-radius:4px;border:1px solid var(--bord);background:var(--acc);color:#000;cursor:pointer;font-weight:bold">Go</button></div></div>
<div class="cg"><label>Shape <span class="tip" title="Circle or square">?</span></label><select id="sh2d" onchange="draw2D()"><option value="circle">Circle</option><option value="square">Square</option><option value="both">Square + Circle</option></select></div>
<div class="cg"><label>Color Scheme <span class="tip" title="Coloring method">?</span></label><select id="col2d" onchange="draw2D()"><option value="gcd">By GCD (Recommended)</option><option value="dist">By Distance</option><option value="prim">Primitive vs Non</option><option value="rainbow">Rainbow (Cyclic)</option><option value="quadres">Quadratic Residues</option><option value="primality">Primality (x¬∑y)</option><option value="moddist">Modular Distance</option><option value="symmetry">Symmetry Pattern</option><option value="heatmap">Heatmap (Density)</option><option value="divisibility">Divisibility</option><option value="discrete">Discrete GCD</option><option value="fire">Fire Gradient</option><option value="plasma">Plasma</option><option value="viridis">Viridis</option><option value="ocean">Ocean</option></select></div>
<div class="cg"><label>Point Labels <span class="tip" title="Label display">?</span></label><select id="lbl2d" onchange="draw2D()"><option value="none">None</option><option value="coords">Coordinates</option><option value="gcd">GCD Values</option></select></div>
<div class="cg"><label>Point Size</label><input type="range" id="ptSz2d" min="0.5" max="10" value="4" step="0.5" onchange="draw2D()"></div>
<div class="cg"><label>Zoom <span class="tip" title="Zoom level">?</span></label><div class="sig"><input type="range" id="zm2d" min=".5" max="3" step=".1" value="1" oninput="draw2D();document.getElementById('zm2dv').textContent=this.value+'x'"><span id="zm2dv" style="color:var(--txt2);min-width:40px">1x</span></div></div>
<div class="cg"><label>Label Size <span class="tip" title="Label font size">?</span></label><div class="sig"><input type="range" id="lblsz2d" min="6" max="16" step="1" value="8" oninput="draw2D();document.getElementById('lblszv').textContent=this.value+'px'"><span id="lblszv" style="color:var(--txt2);min-width:40px">8px</span></div></div>
<div class="cg"><label>Connections <span class="tip" title="Draw lines between related points">?</span></label><select id="conn2d" onchange="draw2D()"><option value="none">None</option><option value="gcd1">GCD=1 Network</option><option value="same">Same GCD</option><option value="radial">Radial from Origin</option><option value="diagonal">Diagonal Lines</option></select></div>
<div class="cg"><label>Line Opacity</label><input type="range" id="connOp2d" min="0.1" max="1" step="0.1" value="0.3" onchange="draw2D()"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Smith Chart Transform</strong> <span class="tip" title="Œì = (z-1)/(z+1) conformal mapping">?</span></label></div>
<div class="cg"><label>Enable Smith Chart</label><input type="checkbox" id="smith2d" onchange="draw2D()"></div>
<div class="cg"><label>Phase Shift Œ±</label><div class="sig"><input type="range" id="smithA2d" min="0" max="360" value="90" oninput="document.getElementById('smithA2dV').textContent=this.value+'¬∞';draw2D()"><span id="smithA2dV" style="color:var(--txt2)">90¬∞</span></div></div>
<div class="cg"><label>Radius Scale</label><select id="smithR2d" onchange="draw2D()"><option value="unit">Unit (R=1)</option><option value="index">By Index</option><option value="dist">By Distance</option></select></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="smithGrid2d" onchange="draw2D()"> Grid</label><label><input type="checkbox" id="smithCircR2d" onchange="draw2D()"> Const-R</label><label><input type="checkbox" id="smithArcX2d" onchange="draw2D()"> Const-X</label></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Modular Overlay</strong> <span class="tip" title="Project lattice points by modular residue">?</span></label></div>
<div class="cg"><label>Enable Modular Coloring</label><input type="checkbox" id="mod2dEnable" onchange="draw2D()"></div>
<div class="cg"><label>Modulus M</label><input type="number" id="mod2dM" value="6" min="2" max="100" onchange="draw2D()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('mod2dM').value=6;document.getElementById('mod2dEnable').checked=true;draw2D()">6</button>
<button onclick="document.getElementById('mod2dM').value=12;document.getElementById('mod2dEnable').checked=true;draw2D()">12</button>
<button onclick="document.getElementById('mod2dM').value=30;document.getElementById('mod2dEnable').checked=true;draw2D()">30</button>
</div></div>
<div class="cg"><label>Color By</label><select id="mod2dColBy" onchange="draw2D()">
<option value="sum">Sum (x+y) mod M</option>
<option value="product">Product (x¬∑y) mod M</option>
<option value="diff">Difference |x-y| mod M</option>
<option value="gcdmod">GCD mod M</option>
<option value="coprime">Coprime to M</option>
</select></div>
<div class="cg"><label>Show Residue Rings</label><input type="checkbox" id="mod2dRings" onchange="draw2D()"></div>
</div>
<div class="bg"><button onclick="screenshot2D()">Screenshot</button><button onclick="exportAll2D()" style="background:#1a472a">üì¶ All</button><button onclick="exp2D()">PNG Export</button><button class="s" onclick="csv2D()">CSV Export</button><button class="s" onclick="screenshotCanvas('c2d','2D Lattice','2d_canvas.png')">Canvas Only</button><button class="s" onclick="screenshotStats('stats2dLive','2D Lattice','2d_stats.png')">Stats Only</button></div>
<div class="g2">
<div class="viz"><h3>2D Lattice Points Visualization (Click any point for details)</h3><canvas id="c2d" width="800" height="800"></canvas><div class="al" id="al2d"></div><div class="sg" id="st2d"></div></div>
<div class="viz"><h3>Live Statistics Dashboard <button onclick="screenshotDashboard('stats2dLive','2D_Lattice_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K Screenshot</button></h3><div id="stats2dLive" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">2D Lattice & Basel Problem Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
P(gcd(x,y) = 1) = 6/œÄ¬≤ = 1/Œ∂(2) = 0.6079271018540266
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Basel Problem:</strong> Œ∂(2) = Œ£1/n¬≤ = œÄ¬≤/6 = 1.6449340668482264 (Euler, 1734)</div>
<div><strong>Euler Product:</strong> Œ∂(2) = Œ†(1-p‚Åª¬≤)‚Åª¬π over all primes p</div>
<div><strong>Visible Points:</strong> Point (x,y) visible from origin iff gcd(x,y)=1</div>
<div><strong>Asymptotic:</strong> #{primitive in B_R} ~ œÄR¬≤/Œ∂(2) as R‚Üí‚àû</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Worked Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.5rem">
<div>‚Ä¢ gcd(3,5)=1 ‚Üí primitive (visible)</div>
<div>‚Ä¢ gcd(4,6)=2 ‚Üí not primitive</div>
<div>‚Ä¢ gcd(7,11)=1 ‚Üí primitive</div>
<div>‚Ä¢ gcd(12,18)=6 ‚Üí not primitive</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('r2dv').value=4;document.getElementById('r2d').value=4;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=4</button>
<button onclick="document.getElementById('r2dv').value=10;document.getElementById('r2d').value=10;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=10</button>
<button onclick="document.getElementById('r2dv').value=25;document.getElementById('r2d').value=25;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=25</button>
<button onclick="document.getElementById('r2dv').value=50;document.getElementById('r2d').value=50;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=50</button>
<button onclick="document.getElementById('r2dv').value=100;document.getElementById('r2d').value=100;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=100</button>
<button onclick="document.getElementById('r2dv').value=200;document.getElementById('r2d').value=200;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=200</button>
<button onclick="document.getElementById('r2dv').value=500;document.getElementById('r2d').value=200;draw2D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--acc);color:#000;cursor:pointer;font-weight:bold">R=500</button>
</div>
</div>
</div>
</div>

<div id="t3d" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Ball radius">?</span></label><div class="sig"><input type="range" id="r3d" min="1" max="50" step=".5" value="4" oninput="document.getElementById('r3dv').value=this.value;draw3DDebounced()"><input type="number" id="r3dv" value="4" min="1" step=".5" max="343"><button onclick="draw3D()" style="padding:2px 8px;margin-left:4px;border-radius:4px;border:1px solid var(--bord);background:var(--acc);color:#000;cursor:pointer;font-weight:bold">Go</button></div></div>
<div class="cg"><label>X Rotation <span class="tip" title="Rotation around X axis">?</span></label><div class="sig"><input type="number" id="rotX" value="0" min="0" max="360" step="1" style="width:60px" onchange="rx=this.value*Math.PI/180;draw3D()"><span style="color:var(--txt2)">¬∞</span><input type="range" id="rotXr" min="0" max="360" value="0" oninput="document.getElementById('rotX').value=this.value;rx=this.value*Math.PI/180;draw3D()"></div></div>
<div class="cg"><label>Y Rotation <span class="tip" title="Rotation around Y axis">?</span></label><div class="sig"><input type="number" id="rotY" value="0" min="0" max="360" step="1" style="width:60px" onchange="ry=this.value*Math.PI/180;draw3D()"><span style="color:var(--txt2)">¬∞</span><input type="range" id="rotYr" min="0" max="360" value="0" oninput="document.getElementById('rotY').value=this.value;ry=this.value*Math.PI/180;draw3D()"></div></div>
<div class="cg"><label>Z Rotation <span class="tip" title="Rotation around Z axis">?</span></label><div class="sig"><input type="number" id="rotZ" value="0" min="0" max="360" step="1" style="width:60px" onchange="rz=this.value*Math.PI/180;draw3D()"><span style="color:var(--txt2)">¬∞</span><input type="range" id="rotZr" min="0" max="360" value="0" oninput="document.getElementById('rotZ').value=this.value;rz=this.value*Math.PI/180;draw3D()"></div></div>
<div class="cg"><label>Zoom <span class="tip" title="Zoom level">?</span></label><div class="sig"><input type="range" id="zm3d" min=".2" max="5" step=".1" value="1" oninput="draw3D();document.getElementById('zmv').textContent=this.value+'x'"><span id="zmv" style="color:var(--txt2);min-width:40px">1x</span></div></div>
<div class="cg"><label>Point Size <span class="tip" title="Point radius">?</span></label><div class="sig"><input type="range" id="ps3d" min=".02" max=".5" step=".01" value=".12" oninput="draw3D();document.getElementById('psv').textContent=this.value"><span id="psv" style="color:var(--txt2);min-width:40px">.12</span></div></div>
<div class="cg"><label>Color Scheme <span class="tip" title="Color by">?</span></label><select id="col3d" onchange="draw3D()"><option value="gcd">By GCD</option><option value="dist">By Distance</option><option value="prim">Primitive vs Non</option><option value="rainbow">Rainbow (Cyclic)</option><option value="quadres">Quadratic Residues</option><option value="primality">Primality (x¬∑y¬∑z)</option><option value="moddist">Modular Distance</option><option value="symmetry">Symmetry Pattern</option><option value="heatmap">Heatmap (Density)</option><option value="divisibility">Divisibility</option><option value="discrete">Discrete GCD</option><option value="fire">Fire Gradient</option><option value="plasma">Plasma</option><option value="viridis">Viridis</option><option value="ocean">Ocean</option></select></div>
<div class="cg"><label>View Mode <span class="tip" title="Normal or inverted">?</span></label><select id="vm3d" onchange="draw3D()"><option value="normal">Normal</option><option value="inv">Inverted (Flip)</option></select></div>
<div class="cg"><label>Label Size <span class="tip" title="Info label size">?</span></label><div class="sig"><input type="range" id="lblsz3d" min="8" max="18" step="1" value="11" oninput="document.getElementById('lblsz3dv').textContent=this.value+'px'"><span id="lblsz3dv" style="color:var(--txt2);min-width:40px">11px</span></div></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Screenshot Options</strong></label></div>
<div class="cg"><label>Resolution</label><select id="ss3dRes"><option value="1">Standard (1x)</option><option value="2" selected>High (2x)</option><option value="4">4K (4x)</option></select></div>
<div class="cg"><label>Background</label><select id="ss3dBg"><option value="theme">Theme Default</option><option value="black">Black</option><option value="white">White</option><option value="transparent">Transparent</option></select></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="ss3dTitle" checked> Title</label><label><input type="checkbox" id="ss3dLegend" checked> Legend</label><label><input type="checkbox" id="ss3dStats" checked> Stats</label></div>
<div class="cg"><label>Title Text</label><input type="text" id="ss3dTitleTxt" value="Geometric M√∂bius Shell Sieve - 3D Ball" style="width:100%"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Smith Chart Transform</strong> <span class="tip" title="Œì = (z-1)/(z+1) conformal mapping to unit disk">?</span></label></div>
<div class="cg"><label>Enable Smith Chart</label><input type="checkbox" id="smith3d" onchange="draw3D()"></div>
<div class="cg"><label>Phase Shift Œ±</label><div class="sig"><input type="range" id="smithA3d" min="0" max="360" value="90" oninput="document.getElementById('smithA3dV').textContent=this.value+'¬∞';draw3D()"><span id="smithA3dV" style="color:var(--txt2)">90¬∞</span></div></div>
<div class="cg"><label>Radius Scale</label><select id="smithR3d" onchange="draw3D()"><option value="unit">Unit (R=1)</option><option value="index">By Index</option><option value="dist">By Distance</option></select></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="smithGrid3d" onchange="draw3D()"> Grid</label><label><input type="checkbox" id="smithCircR3d" onchange="draw3D()"> Const-R</label><label><input type="checkbox" id="smithArcX3d" onchange="draw3D()"> Const-X</label></div>
</div>
<div class="bg"><button onclick="screenshot3D()">Screenshot</button><button onclick="exportAll3D()" style="background:#1a472a">üì¶ All</button><button onclick="screenshot3D4K()">4K Export</button><button onclick="anim3d=!anim3d">Auto Rotate</button><button class="s" onclick="rx=0;ry=0;rz=0;panX=0;panY=0;document.getElementById('zm3d').value=1;document.getElementById('zmv').textContent='1x';document.getElementById('rotX').value=0;document.getElementById('rotY').value=0;document.getElementById('rotZ').value=0;document.getElementById('rotXr').value=0;document.getElementById('rotYr').value=0;document.getElementById('rotZr').value=0;draw3D()">Reset View</button><button class="s" onclick="csv3D()">Export Points</button></div>
<div class="g2">
<div class="viz"><h3>3D Ball Visualization (Drag to rotate | Scroll to zoom | Right-click to pan)</h3><canvas id="c3d" width="700" height="700"></canvas><div class="al" id="al3d"></div><div class="sg" id="st3d"></div></div>
<div class="viz"><h3>Live Statistics Dashboard <button onclick="screenshotDashboard('stats3dLive','3D_Ball_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K Screenshot</button></h3><div id="stats3dLive" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(0,217,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">3D Lattice & Ap√©ry's Constant Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
P(gcd(x,y,z) = 1) = 1/Œ∂(3) = 0.8319073725807075
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Ap√©ry's Constant:</strong> Œ∂(3) = Œ£1/n¬≥ = 1.2020569031595943 (proved irrational 1978)</div>
<div><strong>Euler Product:</strong> Œ∂(3) = Œ†(1-p‚Åª¬≥)‚Åª¬π over all primes</div>
<div><strong>Ball Volume:</strong> V‚ÇÉ = (4/3)œÄR¬≥</div>
<div><strong>Asymptotic:</strong> #{primitive in B_R} ~ (4/3)œÄR¬≥/Œ∂(3)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Worked Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.5rem">
<div>‚Ä¢ gcd(2,3,5)=1 ‚Üí primitive</div>
<div>‚Ä¢ gcd(4,6,8)=2 ‚Üí not primitive</div>
<div>‚Ä¢ gcd(1,1,1)=1 ‚Üí primitive</div>
<div>‚Ä¢ gcd(6,9,12)=3 ‚Üí not primitive</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('r3dv').value=3;document.getElementById('r3d').value=3;draw3D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=3 (Small)</button>
<button onclick="document.getElementById('r3dv').value=6;document.getElementById('r3d').value=6;draw3D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=6 (Medium)</button>
<button onclick="document.getElementById('r3dv').value=12;document.getElementById('r3d').value=12;draw3D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=12 (Large)</button>
<button onclick="document.getElementById('r3dv').value=20;document.getElementById('r3d').value=20;draw3D()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=20 (Dense)</button>
</div>
</div>
</div>
<p style="color:var(--txt2);font-size:.9rem;padding:1rem;background:rgba(0,217,255,.05);border-radius:4px"><strong>Controls:</strong> Left-drag to rotate | Scroll to zoom | Right-drag to pan | Inverted flips inner‚Üîouter</p>
</div>

<div id="tmob" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Compute Œº(n) for n ‚â§ N">?</span></label><div class="sig"><input type="range" id="mobN" min="10" max="500" step="10" value="100" oninput="document.getElementById('mobNv').value=this.value"><input type="number" id="mobNv" value="100" min="2" max="2000"  onkeydown="if(event.key==='Enter')drawMobius()"></div></div>
<div class="cg"><label>Visualization</label><select id="mobViz" onchange="drawMobius()">
<option value="strip">Œº(n) Strip Chart</option>
<option value="mertens">Mertens M(x)</option>
<option value="cumsum">Cumulative Œ£Œº(n)/n</option>
<option value="spiral">Ulam-like Spiral</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="mobCol" onchange="drawMobius()">
<option value="classic">Classic (Red/Gray/Blue)</option>
<option value="prime">Prime Factor Count</option>
<option value="sqfree">Squarefree Highlight</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="mobPtSz" min="2" max="15" value="6" onchange="drawMobius()"></div>
</div>
<div class="bg"><button onclick="drawMobius()">Compute</button><button onclick="screenshotMob()">Screenshot</button><button onclick="exportAllMob()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvMob()">CSV Export</button><button class="s" onclick="screenshotCanvas('cmob','M√∂bius Function','mobius_canvas.png')">Canvas</button><button class="s" onclick="screenshotStats('mobLiveStats','M√∂bius','mobius_stats.png')">Stats</button></div>
<div class="g2">
<div class="viz"><h3>M√∂bius Function Œº(n) ‚Äî The Heart of the Sieve</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Œº(n) = (-1)^k if n = p‚ÇÅp‚ÇÇ...p‚Çñ (k distinct primes), 0 if n has squared factor. Core identity: Œ£_{d|n} Œº(d) = [n=1]</p>
<canvas id="cmob" width="800" height="500"></canvas><div class="al" id="almob"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('mobLiveStats','Mobius_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="mobLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Distribution</h3><div class="pc" id="pmobDist"></div></div>
</div>
<div class="viz"><h3>M√∂bius Data Table (Click rows)</h3><div style="max-height:300px;overflow-y:auto"><table id="tmobT"><tr><th>n</th><th>Œº(n)</th><th>M(n)</th><th>Factorization</th><th>Squarefree</th></tr></table></div></div>
<div style="padding:1rem;background:rgba(150,100,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">M√∂bius Function Œº(n) Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Œº(n) = (-1)^k if n = p‚ÇÅp‚ÇÇ...p‚Çñ distinct primes, else 0 &nbsp;|&nbsp; Œ£_{d|n} Œº(d) = [n=1]
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>M√∂bius Inversion:</strong> If g(n) = Œ£_{d|n} f(d), then f(n) = Œ£_{d|n} Œº(d)g(n/d)</div>
<div><strong>Euler Product:</strong> 1/Œ∂(s) = Œ£ Œº(n)/nÀ¢ = Œ†(1 - p‚ÅªÀ¢)</div>
<div><strong>Totient:</strong> œÜ(n) = n ¬∑ Œ£_{d|n} Œº(d)/d</div>
<div><strong>Mertens:</strong> |M(x)| = O(x^¬Ω) equivalent to RH</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem">
<div>‚Ä¢ Œº(1) = 1</div>
<div>‚Ä¢ Œº(2) = -1 (prime)</div>
<div>‚Ä¢ Œº(6) = 1 (2¬∑3)</div>
<div>‚Ä¢ Œº(4) = 0 (2¬≤)</div>
<div>‚Ä¢ Œº(30) = -1 (2¬∑3¬∑5)</div>
<div>‚Ä¢ Œº(12) = 0 (2¬≤¬∑3)</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('mobNv').value=50;document.getElementById('mobN').value=50;drawMobius()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=50</button>
<button onclick="document.getElementById('mobNv').value=100;document.getElementById('mobN').value=100;drawMobius()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=100</button>
<button onclick="document.getElementById('mobNv').value=500;document.getElementById('mobN').value=500;drawMobius()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=500</button>
<button onclick="document.getElementById('mobNv').value=1000;drawMobius()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=1000</button>
</div>
</div>
</div>
</div>

<div id="tcayley" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Lattice boundary">?</span></label><div class="sig"><input type="range" id="rcay" min="1" max="50" step=".5" value="6" oninput="document.getElementById('rcayv').value=this.value;drawCayley()"><input type="number" id="rcayv" value="6" min="1" step=".5" onkeydown="if(event.key==='Enter')drawCayley()"></div></div>
<div class="cg"><label>View Range <span class="tip" title="Upper half-plane extent">?</span></label><input type="number" id="cayRange" value="4" min="1" max="20" step=".5" onchange="drawCayley()"></div>
<div class="cg"><label>Point Size</label><input type="range" id="caySz" min="1" max="10" value="3" onchange="drawCayley()"></div>
<div class="cg"><label>Color Scheme</label><select id="colCay" onchange="drawCayley()"><option value="gcd">By GCD</option><option value="prim">Primitive (Gold)</option><option value="imag">By Im(w)</option><option value="arg">By Arg(z)</option><option value="farey">Farey Level</option><option value="fire">Fire Gradient</option><option value="plasma">Plasma</option><option value="viridis">Viridis</option></select></div>
<div class="cg"><label>Filter</label><select id="cayFilt" onchange="drawCayley()"><option value="all">All Points</option><option value="prim">Primitive Only</option><option value="gcd2">GCD ‚â§ 2</option><option value="gcd3">GCD ‚â§ 3</option></select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="cayGrid" checked onchange="drawCayley()"> Grid</label>
<label><input type="checkbox" id="cayGeo" onchange="drawCayley()"> Geodesics</label>
<label><input type="checkbox" id="cayFord" onchange="drawCayley()"> Ford Circles</label>
<label><input type="checkbox" id="cayFarey" onchange="drawCayley()"> Farey Arcs</label>
<label><input type="checkbox" id="cayFund" onchange="drawCayley()"> Fundamental Domain</label>
<label><input type="checkbox" id="cayHoro" onchange="drawCayley()"> Horocycles</label>
</div></div>
<div class="cg"><label>Ford Depth</label><input type="number" id="cayFordQ" value="8" min="1" max="20" onchange="drawCayley()"></div>
<div class="cg"><label>Labels</label><select id="cayLbl" onchange="drawCayley()"><option value="none">None</option><option value="xy">Original (x,y)</option><option value="w">Cayley w</option><option value="frac">Fraction p/q</option></select></div>
</div>
<div class="bg"><button onclick="drawCayley()">Redraw</button><button onclick="screenshotCayley()">Screenshot</button><button onclick="exportAllCay()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCayley()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Cayley Transform: ùîª ‚Üí ‚Ñç Upper Half-Plane</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">w = i(1+z)/(1-z) maps unit disk to ‚Ñç. PSL(2,‚Ñ§) acts by M√∂bius transformations. Geodesics are semicircles ‚ä• to ‚Ñù.</p>
<canvas id="ccay" width="850" height="550"></canvas><div class="al" id="alcay"></div><div class="sg" id="stcay"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('cayLiveStats','Cayley_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="cayLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Im(w) Distribution</h3><div class="pc" id="pcayDist"></div></div>
</div>
<div style="padding:1rem;background:rgba(0,217,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Hyperbolic Geometry & Modular Group</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
w = i(1+z)/(1-z) &nbsp;maps&nbsp; ùîª ‚Üí ‚Ñç &nbsp;|&nbsp; ds¬≤ = (dx¬≤ + dy¬≤)/y¬≤
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Geodesics:</strong> Vertical lines and semicircles ‚ä• to ‚Ñù</div>
<div><strong>PSL(2,‚Ñ§):</strong> Generated by T: z‚Ü¶z+1 and S: z‚Ü¶-1/z</div>
<div><strong>Ford Circles:</strong> C(p/q) center (p/q, 1/2q¬≤), radius 1/2q¬≤</div>
<div><strong>Farey Neighbors:</strong> p/q, r/s neighbors iff |ps-qr|=1</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.5rem">
<div>‚Ä¢ C(0/1) tangent to C(1/1)</div>
<div>‚Ä¢ 1/2 and 1/3 are Farey neighbors</div>
<div>‚Ä¢ Fundamental domain: |z|‚â•1, |Re(z)|‚â§¬Ω</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('rcayv').value=4;document.getElementById('rcay').value=4;drawCayley()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=4</button>
<button onclick="document.getElementById('rcayv').value=8;document.getElementById('rcay').value=8;drawCayley()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=8</button>
<button onclick="document.getElementById('cayFord').checked=true;document.getElementById('cayFordQ').value=10;drawCayley()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Ford Circles</button>
<button onclick="document.getElementById('cayFund').checked=true;drawCayley()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Fund. Domain</button>
</div>
</div>
</div>
</div>

<div id="tprim" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus M <span class="tip" title="Ring ‚Ñ§/M‚Ñ§">?</span></label><div class="sig"><input type="range" id="mprim" min="2" max="500" step="1" value="17" oninput="document.getElementById('mprimv').value=this.value;drawPrimRoot()"><input type="number" id="mprimv" value="17" min="2" onkeydown="if(event.key==='Enter')drawPrimRoot()"></div></div>
<div class="cg"><label>Generator g <span class="tip" title="Primitive root candidate">?</span></label><div class="sig"><input type="number" id="gprim" value="3" min="1" max="500"><button onclick="drawPrimRoot()">Use</button><button onclick="findPrimRoot()">Find Smallest</button><button onclick="findAllPrimRoots()">Find All</button></div></div>
<div class="cg"><label>Point Size</label><input type="range" id="primPtSz" min="2" max="12" value="5" onchange="drawPrimRoot()"></div>
<div class="cg"><label>Color By</label><select id="colPrim" onchange="drawPrimRoot()"><option value="order">Element Order</option><option value="power">Power Index</option><option value="unit">Unit vs Non-Unit</option><option value="quadres">Quadratic Residue</option><option value="generator">Generator Orbit</option><option value="discrete">Discrete Log</option></select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="primSeq" checked onchange="drawPrimRoot()"> Power Sequence</label>
<label><input type="checkbox" id="primOrd" onchange="drawPrimRoot()"> Show Orders</label>
<label><input type="checkbox" id="primSubgrp" onchange="drawPrimRoot()"> Subgroups</label>
<label><input type="checkbox" id="primQR" onchange="drawPrimRoot()"> QR Highlight</label>
<label><input type="checkbox" id="primCosets" onchange="drawPrimRoot()"> Cosets</label>
</div></div>
<div class="cg"><label>Labels</label><select id="primLbl" onchange="drawPrimRoot()"><option value="none">None</option><option value="value">Value k</option><option value="order">Order</option><option value="dlog">Discrete Log</option></select></div>
<div class="cg"><label>Quick M</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="setM(7)">7</button><button onclick="setM(11)">11</button><button onclick="setM(13)">13</button><button onclick="setM(17)">17</button><button onclick="setM(23)">23</button><button onclick="setM(31)">31</button><button onclick="setM(37)">37</button><button onclick="setM(41)">41</button><button onclick="setM(97)">97</button>
</div></div>
</div>
<div class="bg"><button onclick="drawPrimRoot()">Analyze</button><button onclick="animatePowerSeq()">Animate</button><button onclick="screenshotPrim()">Screenshot</button><button onclick="exportAllPrim()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvPrim()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Cyclic Group (‚Ñ§/M‚Ñ§)√ó</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">g is a primitive root ‚ü∫ ord(g) = œÜ(M) ‚ü∫ ‚ü®g‚ü© = (‚Ñ§/M‚Ñ§)√ó</p>
<canvas id="cprim" width="700" height="700"></canvas><div class="al" id="alprim"></div><div class="sg" id="stprim"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('primLiveStats','PrimRoot_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="primLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Order Distribution</h3><div class="pc" id="pprimord"></div>
<h3 style="margin-top:1rem">Power Sequence g‚Åø mod M</h3><div class="pc" id="pprimseq"></div></div>
</div>
<div class="viz"><h3>Element Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tprimT"><tr><th>k</th><th>ord(k)</th><th>Unit?</th><th>Prim Root?</th><th>QR?</th><th>Disc Log</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Primitive Root Theory</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Definition:</strong> g is primitive root mod M ‚ü∫ ord(g) = œÜ(M)</div>
<div><strong>Existence:</strong> Prim roots exist for M = 1,2,4,p·µè,2p·µè (p odd prime)</div>
<div><strong>Count:</strong> If exists, exactly œÜ(œÜ(M)) primitive roots</div>
<div><strong>Discrete Log:</strong> If g prim root, every unit k = g‚Å± for unique i</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.5rem">
<div>‚Ä¢ 3 is prim root mod 7</div>
<div>‚Ä¢ 2 is prim root mod 5</div>
<div>‚Ä¢ No prim root mod 8</div>
<div>‚Ä¢ 2 is prim root mod 11</div>
</div>
</div>
</div>
</div>

<div id="tfarey" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Denominator Q <span class="tip" title="Farey sequence F_Q">?</span></label><div class="sig"><input type="range" id="fareyQ" min="2" max="50" value="8" oninput="document.getElementById('fareyQv').value=this.value;drawFarey()"><input type="number" id="fareyQv" value="8" min="2" max="100" onkeydown="if(event.key==='Enter')drawFarey()"></div></div>
<div class="cg"><label>Visualization</label><select id="fareyViz" onchange="drawFarey()">
<option value="sequence">Farey Sequence (Line)</option>
<option value="tree">Stern-Brocot Tree</option>
<option value="ford">Ford Circles</option>
<option value="arc">Farey Arcs (Geodesics)</option>
<option value="spiral">Farey Spiral</option>
</select></div>
<div class="cg"><label>Color By</label><select id="fareyCol" onchange="drawFarey()">
<option value="denom">By Denominator q</option>
<option value="level">By Farey Level</option>
<option value="depth">By Tree Depth</option>
<option value="parent">By Parent</option>
<option value="rainbow">Rainbow</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="fareySz" min="2" max="12" value="5" onchange="drawFarey()"></div>
</div>
<div class="ctrl">
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="fareyLabels" checked onchange="drawFarey()"> Fraction Labels</label>
<label><input type="checkbox" id="fareyMediant" onchange="drawFarey()"> Mediant Lines</label>
<label><input type="checkbox" id="fareyNeighbor" onchange="drawFarey()"> Neighbor Arcs</label>
<label><input type="checkbox" id="fareyGrid" checked onchange="drawFarey()"> Grid</label>
<label><input type="checkbox" id="fareyCircles" onchange="drawFarey()"> Tangent Circles</label>
</div></div>
<div class="cg"><label>Quick Q</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="setFareyQ(3)">F‚ÇÉ</button><button onclick="setFareyQ(5)">F‚ÇÖ</button><button onclick="setFareyQ(7)">F‚Çá</button><button onclick="setFareyQ(10)">F‚ÇÅ‚ÇÄ</button><button onclick="setFareyQ(15)">F‚ÇÅ‚ÇÖ</button><button onclick="setFareyQ(20)">F‚ÇÇ‚ÇÄ</button><button onclick="setFareyQ(30)">F‚ÇÉ‚ÇÄ</button>
</div></div>
<div class="cg"><label>Highlight p/q</label><div class="sig"><input type="number" id="fareyP" value="0" min="0" style="width:50px">/<input type="number" id="fareyQh" value="1" min="1" style="width:50px"><button onclick="highlightFraction()">Find</button></div></div>
</div>
<div class="bg"><button onclick="drawFarey()">Redraw</button><button onclick="screenshotFarey()">Screenshot</button><button onclick="exportAllFarey()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvFarey()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Farey Sequence F<sub id="fareyQdisp">8</sub></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">F_Q = {p/q : 0‚â§p‚â§q‚â§Q, gcd(p,q)=1} ordered by value. Neighbors satisfy |ps-qr|=1.</p>
<canvas id="cfarey" width="850" height="550"></canvas><div class="al" id="alfarey"></div><div class="sg" id="stfarey"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('fareyLiveStats','Farey_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="fareyLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">|F_Q| Growth</h3><div class="pc" id="pfareyGrowth"></div>
<h3 style="margin-top:1rem">Denominator Distribution</h3><div class="pc" id="pfareyDenom"></div></div>
</div>
<div class="viz"><h3>Farey Sequence Table (Click rows)</h3>
<div style="max-height:250px;overflow-y:auto">
<table id="tfareyT"><tr><th>Index</th><th>p/q</th><th>Value</th><th>Level</th><th>Left Neighbor</th><th>Right Neighbor</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Farey Sequence Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
|F_Q| = 1 + Œ£_{k=1}^Q œÜ(k) ‚âà 3Q¬≤/œÄ¬≤ &nbsp;|&nbsp; Neighbors: |ps - qr| = 1
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Definition:</strong> F_Q = {p/q : 0‚â§p‚â§q‚â§Q, gcd(p,q)=1}</div>
<div><strong>Mediant:</strong> Between p/q, r/s insert (p+r)/(q+s)</div>
<div><strong>Ford Circles:</strong> C(p/q) center (p/q, 1/2q¬≤), radius 1/2q¬≤</div>
<div><strong>Tangency:</strong> C(p/q), C(r/s) tangent iff neighbors</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples (F‚ÇÖ):</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
0/1, 1/5, 1/4, 1/3, 2/5, 1/2, 3/5, 2/3, 3/4, 4/5, 1/1 &nbsp;(|F‚ÇÖ|=11)
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="setFareyQ(5)" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">F‚ÇÖ (11)</button>
<button onclick="setFareyQ(10)" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">F‚ÇÅ‚ÇÄ (33)</button>
<button onclick="setFareyQ(20)" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">F‚ÇÇ‚ÇÄ (129)</button>
<button onclick="document.getElementById('fareyViz').value='ford';drawFarey()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Ford Circles</button>
</div>
</div>
</div>
</div>

<div id="tmod" class="tab">
<div class="ctrl" style="background:rgba(255,215,0,.1);border-radius:6px;padding:.5rem;margin-bottom:.5rem">
<div class="cg"><label><strong>View Mode</strong></label><select id="modViewMode" onchange="drawModRings()">
<option value="multi">Multi-Modulus Rings (M‚ÇÅ to M‚ÇÇ)</option>
<option value="single">Single M Projection (Farey Channels)</option>
</select></div>
</div>
<div id="modMultiControls">
<div class="ctrl">
<div class="cg"><label>Min Modulus <span class="tip" title="Inner ring">?</span></label><input type="number" id="modMin" value="1" min="1" max="100" onchange="drawModRings()"></div>
<div class="cg"><label>Max Modulus <span class="tip" title="Outer ring">?</span></label><input type="number" id="modMax" value="12" min="2" max="200" onchange="drawModRings()"></div>
<div class="cg"><label>Ring Spacing <span class="tip" title="How rings are spaced">?</span></label><select id="modSpace" onchange="drawModRings()"><option value="uniform">Uniform</option><option value="linear">Linear (c¬∑m)</option><option value="sqrt">Square Root (‚àöm)</option><option value="log">Logarithmic</option><option value="phi">Totient œÜ(m)</option></select></div>
<div class="cg"><label>Color Scheme</label><select id="modCol" onchange="drawModRings()"><option value="rainbow">Rainbow (Angular)</option><option value="gcd">By GCD (Gold=1)</option><option value="gcd_per_mod">GCD=1: Per Modulus</option><option value="gcd_spectrum">GCD=1: Spectral</option><option value="spf">Smallest Prime Factor</option><option value="ring">By Ring</option><option value="residue">By Residue Value</option><option value="prime">Prime vs Composite</option></select></div>
<div class="cg"><label>Phase Œ± <span class="tip" title="Global rotation">?</span></label><div class="sig"><input type="range" id="modPhase" min="0" max="360" value="0" oninput="document.getElementById('modPhaseV').textContent=this.value+'¬∞';document.getElementById('modPhaseNum').value=this.value;drawModRings()"><input type="number" id="modPhaseNum" value="0" min="0" max="360" step="1" style="width:60px" onchange="document.getElementById('modPhase').value=this.value;document.getElementById('modPhaseV').textContent=this.value+'¬∞';drawModRings()"><span id="modPhaseV" style="color:var(--txt2)">0¬∞</span></div></div>
<div class="cg"><label>Phase as r/m <span class="tip" title="Enter fraction for precise rotation">?</span></label><div class="sig"><input type="number" id="phaseR" value="0" min="0" style="width:50px">/&nbsp;<input type="number" id="phaseM" value="1" min="1" style="width:50px"><button onclick="const r=+document.getElementById('phaseR').value,m=+document.getElementById('phaseM').value;if(m>0){const deg=360*r/m;document.getElementById('modPhase').value=deg%360;document.getElementById('modPhaseNum').value=(deg%360).toFixed(2);document.getElementById('modPhaseV').textContent=(deg%360).toFixed(2)+'¬∞';drawModRings();}">Set</button></div></div>
<div class="cg"><label style="display:flex;gap:.3rem;flex-wrap:wrap"><button onclick="setPhase(0)">0¬∞</button><button onclick="setPhase(45)">45¬∞</button><button onclick="setPhase(90)">90¬∞</button><button onclick="setPhase(120)">120¬∞</button><button onclick="setPhase(180)">180¬∞</button><button onclick="setPhase(270)">270¬∞</button></label></div>
<div class="cg"><label>Point Size</label><input type="range" id="modPtSz" min="0.5" max="12" value="5" step="0.5" onchange="drawModRings()"></div>
</div>
</div>
<div id="modSingleControls" style="display:none">
<div class="ctrl">
<div class="cg"><label>Modulus M <span class="tip" title="Single modulus for channel projection">?</span></label><input type="number" id="modSingleM" value="60" min="2" max="10000" onchange="drawModRings()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('modSingleM').value=12;drawModRings()">12</button>
<button onclick="document.getElementById('modSingleM').value=30;drawModRings()">30</button>
<button onclick="document.getElementById('modSingleM').value=60;drawModRings()">60</button>
<button onclick="document.getElementById('modSingleM').value=210;drawModRings()">210</button>
<button onclick="document.getElementById('modSingleM').value=2310;drawModRings()">2310</button>
<button onclick="document.getElementById('modSingleM').value=101;drawModRings()">101 (P)</button>
</div></div>
<div class="cg"><label>Show Farey Lines</label><input type="checkbox" id="modFareyLines" checked onchange="drawModRings()"></div>
<div class="cg"><label>Farey Line Color</label><select id="modFareyCol" onchange="drawModRings()">
<option value="red">Red (Classic)</option>
<option value="gold">Gold</option>
<option value="gcd">By GCD</option>
<option value="depth">By Depth</option>
<option value="gradient">Gradient</option>
</select></div>
<div class="cg"><label>Line Thickness</label><input type="range" id="modFareyThick" min="0.5" max="3" step="0.1" value="1" onchange="drawModRings()"></div>
<div class="cg"><label>Show All Ring Points</label><input type="checkbox" id="modShowAllPts" checked onchange="drawModRings()"></div>
<div class="cg"><label>Point Color</label><select id="modSingleCol" onchange="drawModRings()">
<option value="coprime">Coprime vs Non-coprime</option>
<option value="ring">By Ring (Channel)</option>
<option value="gcd">By GCD Value</option>
<option value="rainbow">Rainbow Spectrum</option>
</select></div>
<div class="cg"><label>Invert (Inner‚ÜîOuter)</label><input type="checkbox" id="modInvert" onchange="drawModRings()"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Constellation Highlight</strong></label><select id="modConstellation" onchange="drawModRings()">
<option value="none">None</option>
<option value="twin">Twin Primes (gap=2)</option>
<option value="cousin">Cousin Primes (gap=4)</option>
<option value="sexy">Sexy Primes (gap=6)</option>
<option value="gap8">Gap-8 Pairs</option>
</select></div>
<div class="cg"><label>Constellation Color</label><input type="color" id="modConstColor" value="#ff00ff" onchange="drawModRings()"></div>
<div class="cg"><label>Filter Residues</label><select id="modFilter" onchange="drawModRings()">
<option value="all">All Residues</option>
<option value="coprime">Coprime Only</option>
<option value="noncoprime">Non-coprime Only</option>
</select></div>
</div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Per-Ring Rotation</strong> <span class="tip" title="Each ring rotates by index √ó increment">?</span></label></div>
<div class="cg"><label>Ring Increment <span id="ringIncV" style="color:var(--txt2)">0¬∞</span></label><div class="sig"><input type="range" id="ringInc" min="0" max="90" value="0" step="0.5" oninput="document.getElementById('ringIncV').textContent=this.value+'¬∞';document.getElementById('ringIncNum').value=this.value;drawModRings()"><input type="number" id="ringIncNum" value="0" min="0" max="360" step="0.5" style="width:60px" onkeydown="if(event.key==='Enter')document.getElementById('ringIncV').textContent=this.value+'¬∞';drawModRings()"></div></div>
<div class="cg"><label>Increment as r/m</label><div class="sig"><input type="number" id="ringIncR" value="0" min="0" style="width:50px">/&nbsp;<input type="number" id="ringIncM" value="1" min="1" style="width:50px"><button onclick="const r=+document.getElementById('ringIncR').value,m=+document.getElementById('ringIncM').value;if(m>0){const deg=360*r/m;document.getElementById('ringInc').value=Math.min(90,deg);document.getElementById('ringIncNum').value=deg.toFixed(4);document.getElementById('ringIncV').textContent=deg.toFixed(2)+'¬∞';drawModRings();}">Set</button></div></div>
<div class="cg"><label style="display:flex;gap:.3rem;flex-wrap:wrap"><button onclick="setRingInc(0)">0¬∞</button><button onclick="setRingInc(1)">1¬∞</button><button onclick="setRingInc(5)">5¬∞</button><button onclick="setRingInc(10)">10¬∞</button><button onclick="setRingInc(15)">15¬∞</button><button onclick="setRingInc(30)">30¬∞</button></label></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Gap Connections</strong> <span class="tip" title="Connect r‚Üír+g within ring (GCD=1 only)">?</span></label></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="gap2" onchange="drawModRings()"> Gap 2</label><label><input type="checkbox" id="gap4" onchange="drawModRings()"> Gap 4</label><label><input type="checkbox" id="gap6" onchange="drawModRings()"> Gap 6</label><label><input type="checkbox" id="gap8" onchange="drawModRings()"> Gap 8</label><label><input type="checkbox" id="gap10" onchange="drawModRings()"> Gap 10</label></div>
<div class="cg"><label>Gap Line Thickness <span id="gapThickV" style="color:var(--txt2)">0.3</span></label><input type="range" id="gapThick" min="0" max="1" step="0.01" value="0.3" oninput="document.getElementById('gapThickV').textContent=this.value;drawModRings()"></div>
<div class="cg"><label><strong>Lift Lines</strong></label></div>
<div class="cg"><label>Direct Lifts <span class="tip" title="r ‚Üí r across consecutive rings">?</span></label><input type="checkbox" id="modDirect" onchange="drawModRings()"></div>
<div class="cg"><label>Lift Line Thickness <span id="liftThickV" style="color:var(--txt2)">0.5</span></label><input type="range" id="liftThick" min="0" max="1" step="0.01" value="0.5" oninput="document.getElementById('liftThickV').textContent=this.value;drawModRings()"></div>
<div class="cg"><label>Show Only GCD=1</label><input type="checkbox" id="modGcd1" onchange="drawModRings()"></div>
<div class="cg"><label>Highlight Unit Circle</label><input type="checkbox" id="modUnit" checked onchange="drawModRings()"></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Smith Chart Transform</strong> <span class="tip" title="Œì = (z-1)/(z+1) conformal mapping">?</span></label></div>
<div class="cg"><label>Enable Smith Chart</label><input type="checkbox" id="smithMod" onchange="drawModRings()"></div>
<div class="cg"><label>Phase Shift Œ±</label><div class="sig"><input type="range" id="smithAMod" min="0" max="360" value="90" oninput="document.getElementById('smithAModV').textContent=this.value+'¬∞';drawModRings()"><span id="smithAModV" style="color:var(--txt2)">90¬∞</span></div></div>
<div class="cg"><label>Radius Scale</label><select id="smithRMod" onchange="drawModRings()"><option value="unit">Unit (R=1)</option><option value="scaled" selected>Scaled by Index</option><option value="modulus">By Modulus</option></select></div>
<div class="cg"><label>Zoom <span id="smithZoomV" style="color:var(--txt2)">1.0x</span></label><input type="range" id="smithZoom" min="0.1" max="3" step="0.05" value="1" oninput="document.getElementById('smithZoomV').textContent=this.value+'x';drawModRings()"></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="smithGridMod" checked onchange="drawModRings()"> Grid</label><label><input type="checkbox" id="smithCircRMod" checked onchange="drawModRings()"> Const-R</label><label><input type="checkbox" id="smithArcXMod" checked onchange="drawModRings()"> Const-X</label></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Point Labels</strong></label></div>
<div class="cg"><label>Label Mode</label><select id="modLabel" onchange="drawModRings()"><option value="none">None</option><option value="r">Residue r</option><option value="rm">r/M Fraction</option><option value="deg">Degree Œ∏¬∞</option><option value="gcd">GCD Value</option></select></div>
<div class="cg"><label>Label Size</label><input type="range" id="modLblSz" min="6" max="14" value="8" step="1" onchange="drawModRings()"></div>
</div>
<div class="bg"><button onclick="drawModRings()">Redraw</button><button onclick="screenshotMod()">Screenshot</button><button onclick="exportAllMod()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvMod()">CSV Export</button></div>
<div class="viz"><h3>Modular Ring System: Œ∏ = 2œÄr/M</h3><p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Concentric rings show residue classes. Gold points have GCD(r,M)=1 (Dirichlet character support œá(r)‚â†0). Direct lifts connect same residue across moduli.</p><canvas id="cmod" width="800" height="800"></canvas><div class="al" id="almod"></div><div class="sg" id="stmod"></div></div>
<div class="g2">
<div class="viz"><h3>Totient Density œÜ(M)/M</h3><div class="pc" id="pmodphi"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('modLiveStats','ModRings_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="modLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(150,100,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Interactive Modular Lifting Rings (Getachew 2025)</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
A geometric visualization framework for modular arithmetic that places residues r ‚àà {0,1,...,M-1} at angles Œ∏ = 2œÄr/M on concentric circles. The radial coordinate encodes the modulus M, creating a <strong>"lifting tower"</strong> where vertical connections between rings reveal how residues reduce or lift across moduli. Gold points mark coprime residues (the multiplicative group (‚Ñ§/M‚Ñ§)√ó), while gray points mark reducible residues. This visualization unifies Dirichlet characters, primitive roots, and the Chinese Remainder Theorem in a single geometric framework.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The "gap connections" between consecutive coprime residues within each ring reveal prime structure: primes p have œÜ(p) = p-1 evenly distributed coprimes with gap=1, while highly composite M shows clustering around coprime channels. The Smith Chart overlay applies the Cayley transform Œì=(z-1)/(z+1) to map the modular rings into the hyperbolic plane, connecting modular arithmetic to RF engineering impedance matching.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œÜ(M) = M ¬∑ ‚àè_{p|M}(1 - 1/p) &nbsp;|&nbsp; |(‚Ñ§/M‚Ñ§)*| = œÜ(M)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Euler's Totient:</strong> œÜ(M) = #{r : gcd(r,M)=1}</div>
<div><strong>Unit Group:</strong> (‚Ñ§/M‚Ñ§)* has order œÜ(M)</div>
<div><strong>Euler's Theorem:</strong> a^œÜ(M) ‚â° 1 (mod M)</div>
<div><strong>CRT:</strong> ‚Ñ§/MN ‚âÖ ‚Ñ§/M √ó ‚Ñ§/N if gcd(M,N)=1</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem">
<div>‚Ä¢ œÜ(6) = 2</div>
<div>‚Ä¢ œÜ(10) = 4</div>
<div>‚Ä¢ œÜ(12) = 4</div>
<div>‚Ä¢ œÜ(30) = 8</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('modMax').value=6;drawModRings()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M‚â§6</button>
<button onclick="document.getElementById('modMax').value=12;drawModRings()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M‚â§12</button>
<button onclick="document.getElementById('modMax').value=30;drawModRings()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M‚â§30</button>
<button onclick="document.getElementById('smithMod').checked=true;drawModRings()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Smith Chart</button>
</div>
</div>
</div>
</div>

<div id="terr" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Radius <span class="tip" title="Upper limit for R">?</span></label><div class="sig"><input type="range" id="errR" min="5" max="500" value="25" oninput="document.getElementById('errRv').value=this.value"><input type="number" id="errRv" value="25" min="2" max="1000"  onkeydown="if(event.key==='Enter')runErrNew()"></div></div>
<div class="cg"><label>Shape</label><select id="errSh"><option value="circle">Circle</option><option value="square">Square</option></select></div>
<div class="cg"><label>Step Size</label><select id="errStep"><option value="0.5">0.5</option><option value="1" selected>1</option><option value="2">2</option></select></div>
<div class="cg"><label>Error Exponent Œ∏</label><div class="sig"><input type="range" id="errTheta" min="0.3" max="1" step="0.05" value="0.5" oninput="document.getElementById('errThetaV').textContent=this.value"><span id="errThetaV" style="color:var(--txt2)">0.5</span></div></div>
</div>
<div class="ctrl">
<div class="cg"><label>Analysis</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="errBounds" checked> Show Bounds</label>
<label><input type="checkbox" id="errSmooth"> Smoothed</label>
<label><input type="checkbox" id="errLog"> Log Scale</label>
</div></div>
<div class="cg"><label>Compare</label><select id="errCompare"><option value="none">None</option><option value="primitive">Primitive Count</option><option value="both">Both</option></select></div>
</div>
<div class="bg"><button onclick="runErrNew()">Analyze</button><button onclick="runErrConvergence()">Convergence Study</button><button onclick="screenshotErr()">Screenshot</button><button onclick="exportAllErr()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvErr()">Export CSV</button><button class="s" onclick="screenshotChart('pe1','Error vs R','error_chart1.png')">Chart 1</button><button class="s" onclick="screenshotChart('pe2','Normalized Error','error_chart2.png')">Chart 2</button><button class="s" onclick="screenshotStats('errLiveStats','Error Analysis','error_stats.png')">Stats</button></div>
<div class="g2">
<div class="viz"><h3>Theory vs Actual Count</h3><div class="pc" id="pe1"></div><div class="al" id="ale1"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('errLiveStats','Error_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="errLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Absolute Error |Actual - Theory|</h3><div class="pc" id="pe2"></div><div class="al" id="ale2"></div></div>
<div class="viz"><h3>Relative Error %</h3><div class="pc" id="pe3"></div><div class="al" id="ale3"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Normalized Error / R^Œ∏</h3><div class="pc" id="pe4"></div><div class="al" id="ale4"></div></div>
<div class="viz"><h3>Error Distribution</h3><div class="pc" id="peHist"></div></div>
</div>
<div class="viz"><h3>Error Analysis Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="te"><tr><th>R</th><th>Theory</th><th>Actual</th><th>Primitive</th><th>Error</th><th>|Error|/‚àöR</th><th>Rel %</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,0,110,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Error Analysis Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
N(R) = Vol(K)¬∑R^n / Œ∂(n) + O(R^(n-1)) &nbsp;|&nbsp; |Error| = O(R^Œ∏)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Circle:</strong> N(R) = œÄR¬≤ + O(R^Œ∏), best Œ∏‚âà0.63</div>
<div><strong>Primitive:</strong> P(R) = œÄR¬≤/Œ∂(2) + O(R log R)</div>
<div><strong>Boundary:</strong> Error grows with perimeter</div>
<div><strong>RMS:</strong> ‚àö(Œ£ err¬≤/n) measures deviation</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('errRv').value=25;runErrNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§25</button>
<button onclick="document.getElementById('errRv').value=50;runErrNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§50</button>
<button onclick="document.getElementById('errRv').value=100;runErrNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§100</button>
<button onclick="document.getElementById('errSh').value='square';runErrNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Square</button>
</div>
</div>
</div>
</div>

<div id="tdim" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Dimension <span class="tip" title="Compute up to this dimension">?</span></label><div class="sig"><input type="range" id="dimMax" min="3" max="30" step="1" value="12" oninput="document.getElementById('dimMaxV').value=this.value"><input type="number" id="dimMaxV" value="12" min="2" max="50"  onkeydown="if(event.key==='Enter')runDimNew()"></div></div>
<div class="cg"><label>Radius R <span class="tip" title="Ball radius (lower for high dims)">?</span></label><div class="sig"><input type="range" id="rdim" min="1" max="20" step=".5" value="5" oninput="document.getElementById('rdimv').value=this.value"><input type="number" id="rdimv" value="5" min="1" max="50"  onkeydown="if(event.key==='Enter')runDimNew()"></div></div>
<div class="cg"><label>Compute Mode</label><select id="dimMode">
<option value="theory">Theory Only (fast)</option>
<option value="hybrid">Hybrid (compute ‚â§5D)</option>
<option value="full">Full Compute (slow)</option>
</select></div>
</div>
<div class="bg"><button onclick="runDimNew()">Compute All Dimensions</button><button onclick="screenshotDim()">Screenshot</button><button onclick="exportAllDim()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvDim()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Œ∂(n) Convergence to 1</h3><div class="pc" id="pdimZeta"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('dimLiveStats','Dimension_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="dimLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>1/Œ∂(n) Coprime Density</h3><div class="pc" id="pdimDens"></div></div>
<div class="viz"><h3>Volume of n-Ball</h3><div class="pc" id="pdimVol"></div></div>
</div>
<div class="viz"><h3>Dimension Analysis (Click rows)</h3><div style="max-height:350px;overflow-y:auto"><table id="tdimT"><tr><th>n</th><th>Vol(B‚Åø)</th><th>Œ∂(n)</th><th>1/Œ∂(n)</th><th>Computed</th><th>Error</th><th>Method</th></tr></table></div></div>
<div style="padding:1rem;background:rgba(255,140,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Dimension Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
P(gcd = 1) = 1/Œ∂(n) ‚Üí 1 as n ‚Üí ‚àû &nbsp;|&nbsp; Vol(B‚Åø) = œÄ^(n/2) / Œì(n/2+1)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Œ∂(2):</strong> œÄ¬≤/6 = 1.6449340668 ‚Üí 60.79271019% coprime</div>
<div><strong>Œ∂(3):</strong> Ap√©ry = 1.2020569032 ‚Üí 83.19073726% coprime</div>
<div><strong>Œ∂(4):</strong> œÄ‚Å¥/90 = 1.0823232337 ‚Üí 92.39393751% coprime</div>
<div><strong>Œ∂(‚àû):</strong> ‚Üí 1 ‚Üí 100% coprime</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('dimMaxV').value=10;runDimNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">n‚â§10</button>
<button onclick="document.getElementById('dimMaxV').value=20;runDimNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">n‚â§20</button>
<button onclick="document.getElementById('rdimv').value=3;runDimNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=3</button>
<button onclick="document.getElementById('dimMode').value='full';runDimNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Full Compute</button>
</div>
</div>
</div>
</div>

<div id="tsh" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Region radius">?</span></label><div class="sig"><input type="range" id="rsh" min="1" max="50" value="10" oninput="document.getElementById('rshv').value=this.value;runShNew()"><input type="number" id="rshv" value="10" min="1" max="100" onkeydown="if(event.key==='Enter')runShNew()"></div></div>
<div class="cg"><label>Max k <span class="tip" title="Maximum shell divisor">?</span></label><div class="sig"><input type="range" id="shK" min="5" max="50" value="15" oninput="document.getElementById('shKv').value=this.value;runShNew()"><input type="number" id="shKv" value="15" min="1" max="100" onkeydown="if(event.key==='Enter')runShNew()"></div></div>
<div class="cg"><label>Shape</label><select id="shShape" onchange="runShNew()"><option value="circle">Circle</option><option value="square">Square</option></select></div>
<div class="cg"><label>Display</label><select id="shDisplay" onchange="runShNew()"><option value="contrib">Contributions Œº(k)¬∑L(R/k)</option><option value="cumul">Cumulative Sum</option><option value="both">Both</option></select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Highlight</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="shSquarefree" checked onchange="runShNew()"> Squarefree Only</label>
<label><input type="checkbox" id="shPrimes" onchange="runShNew()"> Mark Primes</label>
<label><input type="checkbox" id="shShowZero" onchange="runShNew()"> Show Œº=0</label>
</div></div>
<div class="cg"><label>Color Mode</label><select id="shColor" onchange="runShNew()"><option value="sign">By Sign (¬±)</option><option value="mobius">By Œº(k)</option><option value="magnitude">By |Contribution|</option></select></div>
</div>
<div class="bg"><button onclick="runShNew()">Analyze Shells</button><button onclick="animateShells()">Animate</button><button onclick="screenshotSh()">Screenshot</button><button onclick="exportAllSh()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvSh()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>M√∂bius Shell Contributions</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Primitive count P(R) = Œ£ Œº(k)¬∑L(R/k) where L counts all lattice points</p>
<div class="pc" id="psh"></div><div class="al" id="alsh"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('shLiveStats','Shell_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="shLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Cumulative Sum Convergence</h3><div class="pc" id="pshCum"></div></div>
<div class="viz"><h3>Contribution Magnitude |Œº(k)¬∑L(R/k)|</h3><div class="pc" id="pshMag"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>M√∂bius Function Œº(k)</h3><div class="pc" id="pshMob"></div></div>
<div class="viz"><h3>Shell Size L(R/k)</h3><div class="pc" id="pshL"></div></div>
</div>
<div class="viz"><h3>Shell Decomposition Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tshT"><tr><th>k</th><th>Œº(k)</th><th>L(R/k)</th><th>Contribution</th><th>Cumulative</th><th>% of Total</th><th>Squarefree?</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Geometric M√∂bius Shell Sieve (Getachew 2025)</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
A geometric visualization of the classical M√∂bius inversion formula for counting primitive lattice points. The sieve decomposes the count P(R) into contributions from "shells" at scale k: each shell S_k contains points (kx, ky, ...) where gcd(x,y,...) = 1. The M√∂bius function Œº(k) provides the inclusion-exclusion weights, with <strong>positive shells (Œº=+1) adding points</strong> and <strong>negative shells (Œº=-1) removing overcounts</strong>. The visualization shows how these shells geometrically nest and cancel to isolate exactly the primitive points.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The sum truncates naturally at k = R (since L(R/k) = 0 for k > R), and only squarefree k contribute (since Œº(k) = 0 otherwise). The dominant contribution comes from k=1 (all lattice points), with corrections from small prime scales k=2,3,5,... The cumulative sum converges to P(R) = Vol(K)¬∑R^n/Œ∂(n) + O(R^{n-1}).
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
P(R) = Œ£_{k=1}^R Œº(k) ¬∑ L(R/k) &nbsp;|&nbsp; L(r) = lattice points in ball
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Main Term:</strong> k=1 gives L(R) (all points)</div>
<div><strong>Correction:</strong> k=2 removes even-gcd</div>
<div><strong>Cancellation:</strong> ¬± terms sum to primitive count</div>
<div><strong>Truncates:</strong> When R/k < 1</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Example (R=6):</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
P(6) = L(6) - L(3) - L(2) + L(1) - L(1.5) - L(1.2) + ...
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('rshv').value=5;runShNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=5</button>
<button onclick="document.getElementById('rshv').value=10;runShNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=10</button>
<button onclick="document.getElementById('rshv').value=25;runShNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=25</button>
<button onclick="animateShells()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Animate</button>
</div>
</div>
</div>
</div>
</div>

<div id="tgcd" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="Region radius">?</span></label><div class="sig"><input type="range" id="rgcd" min="1" max="500" value="15" oninput="document.getElementById('rgcdv').value=this.value"><input type="number" id="rgcdv" value="15" min="1" max="1000"  onkeydown="if(event.key==='Enter')runGcdNew()"></div></div>
<div class="cg"><label>Shape</label><select id="gcdShape" onchange="runGCD()"><option value="circle">Circle (x¬≤+y¬≤‚â§R¬≤)</option><option value="square">Square (|x|,|y|‚â§R)</option></select></div>
<div class="cg"><label>Analysis Mode</label><select id="gcdMode"><option value="full">Full Distribution</option><option value="avg">Average GCD Study</option><option value="coprime">Coprime Focus</option></select></div>
<div class="cg"><label>Top N GCDs</label><input type="number" id="gcdTopN" value="20" min="5" max="50" onkeydown="if(event.key==='Enter')runGcdNew()"></div>
</div>
<div class="bg"><button onclick="runGCD()">Analyze GCD</button><button onclick="runGCDConvergence()">Convergence Study</button><button onclick="screenshotGCD()">Screenshot</button><button onclick="exportAllGCD()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvGCD()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>GCD Frequency Distribution</h3><div class="pc" id="pgcd1"></div><div class="al" id="algcd1"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('gcdLiveStats','GCD_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="gcdLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Cumulative Distribution</h3><div class="pc" id="pgcd2"></div><div class="al" id="algcd2"></div></div>
<div class="viz"><h3>GCD vs Theory</h3><div class="pc" id="pgcd3"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Squarefree Analysis</h3><div class="pc" id="pgcdSF"></div></div>
<div class="viz"><h3>Divisibility Patterns</h3><div class="pc" id="pgcdDiv"></div></div>
</div>
<div class="viz"><h3>GCD Distribution Table (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tgcdT"><tr><th>GCD</th><th>Count</th><th>Percent</th><th>Cumulative</th><th>Theory</th><th>Squarefree?</th><th>Factorization</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,217,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">GCD Distribution Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
P(gcd = k) = 1/(k¬≤ ¬∑ Œ∂(2)) = 6/(œÄ¬≤k¬≤) &nbsp;|&nbsp; P(gcd = 1) = 0.6079271019
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>P(gcd=1):</strong> 6/œÄ¬≤ = 0.6079271018540266</div>
<div><strong>P(gcd=2):</strong> 6/(4œÄ¬≤) ‚âà 15.20%</div>
<div><strong>P(gcd=3):</strong> 6/(9œÄ¬≤) ‚âà 6.75%</div>
<div><strong>Average GCD:</strong> ~ ‚àö(log R)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('rgcdv').value=10;runGCD()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=10</button>
<button onclick="document.getElementById('rgcdv').value=25;runGCD()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=25</button>
<button onclick="document.getElementById('rgcdv').value=50;runGCD()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=50</button>
<button onclick="document.getElementById('gcdShape').value='square';runGCD()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Square</button>
</div>
</div>
</div>
</div>

<div id="tgaus" class="tab">
<div class="ctrl">
<div class="cg"><label>Radius R <span class="tip" title="|a+bi| ‚â§ R">?</span></label><div class="sig"><input type="range" id="rgaus" min="1" max="50" step=".5" value="8" oninput="document.getElementById('rgausv').value=this.value;drawGaus()"><input type="number" id="rgausv" value="8" min="1" step=".5" onkeydown="if(event.key==='Enter')drawGaus()"></div></div>
<div class="cg"><label>Zoom <span class="tip" title="Zoom level">?</span></label><div class="sig"><input type="range" id="zmgaus" min=".5" max="3" step=".1" value="1" oninput="drawGaus();document.getElementById('zmgausv').textContent=this.value+'x'"><span id="zmgausv" style="color:var(--txt2);min-width:40px">1x</span></div></div>
<div class="cg"><label>Point Size</label><input type="range" id="ptszgaus" min="1" max="10" step="0.5" value="3" onchange="drawGaus()"></div>
<div class="cg"><label>Color Scheme</label><select id="colGaus" onchange="drawGaus()">
<option value="gcd">By GCD (Primitive=Gold)</option>
<option value="gprime">Gaussian Primes (Green)</option>
<option value="norm">By Norm (Rainbow)</option>
<option value="arg">By Argument Œ∏</option>
<option value="quadrant">By Quadrant</option>
<option value="parity">By Parity (a+b mod 2)</option>
<option value="sum2sq">Sum of Two Squares</option>
</select></div>
<div class="cg"><label>Filter</label><select id="filtGaus" onchange="drawGaus()">
<option value="all">All Points</option>
<option value="prim">Primitive Only (GCD=1)</option>
<option value="gprime">Gaussian Primes Only</option>
<option value="units">Exclude Units (¬±1, ¬±i)</option>
</select></div>
<div class="cg"><label>Labels</label><select id="lblGaus" onchange="drawGaus()">
<option value="none">None</option>
<option value="val">a + bi</option>
<option value="norm">|z|¬≤</option>
<option value="arg">Œ∏¬∞</option>
</select></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap"><input type="checkbox" id="gausNormC" onchange="drawGaus()"> Norm Circles</label>
<label><input type="checkbox" id="gausAxes" checked onchange="drawGaus()"> Axes</label>
<label><input type="checkbox" id="gausGrid" checked onchange="drawGaus()"> Grid</label>
<label><input type="checkbox" id="gausUnits" onchange="drawGaus()"> Highlight Units</label></div>
<div class="cg"><label><input type="checkbox" id="gausAssoc" onchange="drawGaus()"> Show Associates</label>
<label><input type="checkbox" id="gausConj" onchange="drawGaus()"> Connect Conjugates</label></div>
</div>
<div class="bg"><button onclick="screenshotGaus()">Screenshot</button><button onclick="exportAllGaus()" style="background:#1a472a">üì¶ All</button><button onclick="drawGaus()">Analyze</button><button class="s" onclick="expGaus()">PNG Export</button><button class="s" onclick="csvGaus()">CSV Export</button></div>
<div class="g2">
<div class="viz"><h3>Complex Plane ‚Ñ§[i] (Click points)</h3><canvas id="cgaus" width="700" height="700"></canvas><div class="al" id="algaus1"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('gausLiveStats','Gaussian_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="gausLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Norm Distribution</h3><div class="pc" id="pgaus"></div><div class="al" id="algaus2"></div></div>
</div>
<div class="sg" id="stgaus"></div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Gaussian Integers ‚Ñ§[i] Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
N(a+bi) = a¬≤ + b¬≤ &nbsp;|&nbsp; p = a¬≤+b¬≤ ‚ü∫ p=2 or p‚â°1 (mod 4)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Units:</strong> {¬±1, ¬±i} exactly 4</div>
<div><strong>Gaussian Prime:</strong> N(z) prime OR p‚â°3(mod 4)</div>
<div><strong>UFD:</strong> Unique factorization domain</div>
<div><strong>Fermat:</strong> Two squares theorem</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem">
<div>‚Ä¢ 5 = (2+i)(2-i)</div>
<div>‚Ä¢ 3 is Gaussian prime</div>
<div>‚Ä¢ 13 = (3+2i)(3-2i)</div>
<div>‚Ä¢ 2 = -i(1+i)¬≤</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('rgausv').value=5;drawGaus()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=5</button>
<button onclick="document.getElementById('rgausv').value=10;drawGaus()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R=10</button>
<button onclick="document.getElementById('colGaus').value='gprime';drawGaus()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Gaussian Primes</button>
<button onclick="document.getElementById('colGaus').value='norm';drawGaus()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">By Norm</button>
</div>
</div>
</div>
</div>

<div id="tcirc" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Radius <span class="tip" title="Upper limit for analysis">?</span></label><div class="sig"><input type="range" id="circR" min="5" max="500" value="25" oninput="document.getElementById('circRv').value=this.value;document.getElementById('circVizR').value=Math.min(30,this.value);drawCircleViz();runCircNew()"><input type="number" id="circRv" value="25" min="2" max="1000" onkeydown="if(event.key==='Enter'){document.getElementById('circVizR').value=Math.min(30,this.value);drawCircleViz();runCircNew()}"></div></div>
<div class="cg"><label>Step Size</label><select id="circStep"><option value="0.5">0.5</option><option value="1" selected>1</option><option value="2">2</option></select></div>
<div class="cg"><label>Visualization R</label><input type="number" id="circVizR" value="10" min="2" max="30" onkeydown="if(event.key==='Enter')drawCircleViz()"></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="circBounds" checked> Error Bounds</label>
<label><input type="checkbox" id="circPrim"> Primitive Only</label>
</div></div>
</div>
<div class="bg"><button onclick="runCircNew()">Analyze</button><button onclick="drawCircleViz()">Visualize</button><button onclick="screenshotCirc()">Screenshot</button><button onclick="exportAllCirc()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCirc()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Gauss Circle Visualization</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Lattice points inside circle of radius R. Count ‚âà œÄR¬≤ with error O(R^Œ∏).</p>
<canvas id="ccirc" width="600" height="600"></canvas></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('circLiveStats','Circle_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="circLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Error Function r(R) = N(R) - œÄR¬≤</h3><div class="pc" id="pc2"></div><div class="al" id="alc2"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Lattice Count vs œÄR¬≤</h3><div class="pc" id="pc1"></div><div class="al" id="alc1"></div></div>
<div class="viz"><h3>Normalized Error r(R)/R^Œ∏</h3><div class="pc" id="pc3"></div><div class="al" id="alc3"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Error Magnitude |r(R)|</h3><div class="pc" id="pcircAbs"></div></div>
<div class="viz"><h3>Running Average of r(R)/‚àöR</h3><div class="pc" id="pcircAvg"></div></div>
</div>
<div class="viz"><h3>Circle Problem Data (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tcircT"><tr><th>R</th><th>N(R)</th><th>œÄR¬≤</th><th>r(R)</th><th>r(R)/‚àöR</th><th>|r(R)|/R^0.5</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,100,150,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Gauss Circle Problem Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
N(R) = œÄR¬≤ + r(R) &nbsp;where&nbsp; |r(R)| = O(R^Œ∏), Œ∏ ‚â§ 131/208 ‚âà 0.63
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Count:</strong> N(R) = #{(x,y)‚àà‚Ñ§¬≤ : x¬≤+y¬≤‚â§R¬≤}</div>
<div><strong>Hardy Conjecture:</strong> r(R) = O(R^(1/2+Œµ)) for all Œµ>0</div>
<div><strong>Omega Result:</strong> r(R) = Œ©(R^¬Ω (log R)^¬º)</div>
<div><strong>Gauss (1834):</strong> First studied, trivial bound O(R)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem">
<div>‚Ä¢ N(1) = 5</div>
<div>‚Ä¢ N(2) = 13</div>
<div>‚Ä¢ N(5) = 81</div>
<div>‚Ä¢ N(10) = 317</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('circRv').value=10;document.getElementById('circR').value=10;drawCircleViz();runCircNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§10</button>
<button onclick="document.getElementById('circRv').value=25;document.getElementById('circR').value=25;drawCircleViz();runCircNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§25</button>
<button onclick="document.getElementById('circRv').value=50;document.getElementById('circR').value=50;drawCircleViz();runCircNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§50</button>
<button onclick="document.getElementById('circRv').value=100;runCircNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">R‚â§100</button>
</div>
</div>
</div>
</div>

<div id="tdens" class="tab">
<div class="ctrl">
<div class="cg"><label>Fixed Radius R <span class="tip" title="Ball radius for sampling">?</span></label><div class="sig"><input type="range" id="densR" min="3" max="30" value="12" oninput="document.getElementById('densRv').textContent=this.value"><span id="densRv" style="color:var(--txt2)">12</span></div></div>
<div class="cg"><label>Max Dimension <span class="tip" title="Compute up to this dimension">?</span></label><div class="sig"><input type="range" id="densMaxK" min="3" max="20" value="10" oninput="document.getElementById('densMaxKv').textContent=this.value"><span id="densMaxKv" style="color:var(--txt2)">10</span></div></div>
<div class="cg"><label>Compute Mode</label><select id="densMode">
<option value="hybrid">Hybrid (exact for k‚â§4)</option>
<option value="theory">Theory Only (fast)</option>
<option value="sample">Monte Carlo Sample</option>
</select></div>
<div class="cg"><label>Sample Size</label><input type="number" id="densSample" value="10000" min="1000" max="100000" step="1000" onkeydown="if(event.key==='Enter')runDensity()"></div>
</div>
<div class="bg"><button onclick="runDensNew()">Compute All</button><button onclick="runConvergence()">Convergence Test</button><button onclick="screenshotDens()">Screenshot</button><button onclick="exportAllDens()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvDens()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>1/Œ∂(k) Density Convergence</h3><div class="pc" id="pdens1"></div><div class="al" id="aldens1"></div></div>
<div class="viz"><h3>Œ∂(k) ‚Üí 1 as k ‚Üí ‚àû</h3><div class="pc" id="pdensZeta"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Relative Error % by Dimension</h3><div class="pc" id="pdens2"></div><div class="al" id="aldens2"></div></div>
<div class="viz"><h3>Euler Product Verification</h3><div class="pc" id="pdensEuler"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('densLiveStats','Density_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="densLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
<div class="viz"><h3>Convergence to Limit</h3><div class="pc" id="pdensConv"></div></div>
</div>
<div class="viz"><h3>Comprehensive Density Table (Click rows)</h3>
<div style="max-height:350px;overflow-y:auto">
<table id="tdensT"><tr><th>k</th><th>Œ∂(k)</th><th>1/Œ∂(k)</th><th>Empirical</th><th>Total</th><th>Primitive</th><th>Abs Err</th><th>Rel Err %</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,140,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Zeta Function & Primitive Density Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
P(gcd(x‚ÇÅ,...,x‚Çñ)=1) = 1/Œ∂(k) ‚Üí 1 as k ‚Üí ‚àû
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Œ∂(2):</strong> œÄ¬≤/6 = 1.6449340668 ‚Üí 60.79271019% coprime pairs</div>
<div><strong>Œ∂(3):</strong> Ap√©ry = 1.2020569032 ‚Üí 83.19073726%</div>
<div><strong>Œ∂(10):</strong> ‚âà 1.00099 ‚Üí 99.9%</div>
<div><strong>Euler Product:</strong> Œ∂(s) = Œ†(1-p‚ÅªÀ¢)‚Åª¬π</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('densMaxKv').textContent=10;runDensNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">k‚â§10</button>
<button onclick="document.getElementById('densMaxKv').textContent=15;runDensNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">k‚â§15</button>
<button onclick="document.getElementById('densMode').value='sample';runDensNew()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Monte Carlo</button>
<button onclick="runConvergence()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Convergence</button>
</div>
</div>
</div>
</div>
</div>

<div id="tdir" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus M <span class="tip" title="Character modulus">?</span></label><div class="sig"><input type="range" id="dirM" min="2" max="100" value="12" oninput="document.getElementById('dirMv').value=this.value;drawDirichlet()"><input type="number" id="dirMv" value="12" min="2" max="500" onkeydown="if(event.key==='Enter')drawDirichlet()"></div></div>
<div class="cg"><label>Character Index <span class="tip" title="Which character (1 to œÜ(M))">?</span></label><div class="sig"><input type="range" id="dirIdx" min="0" max="10" value="0" oninput="document.getElementById('dirIdxV').textContent=this.value;drawDirichlet()"><span id="dirIdxV" style="color:var(--txt2)">0</span> <span id="dirIdxLabel" style="color:#ffd700;font-size:.8rem">(Principal œá‚ÇÄ)</span></div></div>
<div class="cg"><label>Visualization</label><select id="dirViz" onchange="drawDirichlet()">
<option value="circle">Unit Circle (œá values)</option>
<option value="support">Support vs Vanishing</option>
<option value="residues">Residue Classes</option>
<option value="table">Character Table</option>
<option value="lfunction">L-function Partial Sums</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="dirCol" onchange="drawDirichlet()">
<option value="arg">By Argument (Phase)</option>
<option value="support">Support (Gold) / Zero (Gray)</option>
<option value="real">Real Part</option>
<option value="order">By Order of œá(r)</option>
</select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="dirLabels" checked onchange="drawDirichlet()"> Labels</label>
<label><input type="checkbox" id="dirGrid" checked onchange="drawDirichlet()"> Unit Circle</label>
<label><input type="checkbox" id="dirRays" onchange="drawDirichlet()"> Arg Rays</label>
<label><input type="checkbox" id="dirConnect" onchange="drawDirichlet()"> Connect Values</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="dirPtSz" min="3" max="15" value="8" onchange="drawDirichlet()"></div>
<div class="cg"><label>L-function Terms</label><input type="number" id="dirLterms" value="100" min="10" max="1000" step="10" onchange="drawDirichlet()"></div>
</div>
<div class="bg"><button onclick="drawDirichlet()">Compute</button><button onclick="showAllChars()">All Characters</button><button onclick="screenshotDir()">Screenshot</button><button onclick="exportAllDir()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvDir()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Dirichlet Character œá mod <span id="dirMdisp">12</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">œá(r) ‚â† 0 (gold) when gcd(r,M)=1. œá(r) = 0 (gray) when gcd(r,M) > 1. Characters map units to roots of unity.</p>
<canvas id="cdir" width="750" height="550"></canvas><div class="al" id="aldir"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('dirLiveStats','Dirichlet_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="dirLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Character Value Distribution</h3><div class="pc" id="pdirDist"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>L(s,œá) Partial Sums</h3><div class="pc" id="pdirL"></div></div>
<div class="viz"><h3>Character Orthogonality</h3><div class="pc" id="pdirOrtho"></div></div>
</div>
<div class="viz"><h3>Character Table mod M (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tdirT"><tr><th>r</th><th>gcd(r,M)</th><th>œá(r)</th><th>|œá(r)|</th><th>arg(œá(r))</th><th>Support?</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Dirichlet Character Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
L(s,œá) = Œ£ œá(n)/nÀ¢ = ‚àè_p(1-œá(p)p‚ÅªÀ¢)‚Åª¬π &nbsp;|&nbsp; L(1,œá) ‚â† 0 for œá‚â†œá‚ÇÄ
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Principal œá‚ÇÄ:</strong> œá‚ÇÄ(r)=1 if gcd(r,M)=1</div>
<div><strong>Count:</strong> œÜ(M) characters mod M</div>
<div><strong>Orthogonality:</strong> Œ£œá(r)œáÃÑ'(r) = œÜ(M)Œ¥_{œáœá'}</div>
<div><strong>Dirichlet:</strong> ‚àû primes in each class</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples (mod 5):</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
œá‚ÇÄ: 1‚Üí1, 2‚Üí1, 3‚Üí1, 4‚Üí1 | œá‚ÇÅ: 1‚Üí1, 2‚Üíi, 3‚Üí-i, 4‚Üí-1
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('dirMv').value=5;drawDirichlet()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M=5</button>
<button onclick="document.getElementById('dirMv').value=12;drawDirichlet()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M=12</button>
<button onclick="document.getElementById('dirViz').value='table';drawDirichlet()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Full Table</button>
<button onclick="showAllChars()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">All œá</button>
</div>
</div>
</div>
</div>

<div id="ttwin" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Search primes up to N">?</span></label><div class="sig"><input type="range" id="twinN" min="100" max="10000" step="100" value="1000" oninput="document.getElementById('twinNv').value=this.value"><input type="number" id="twinNv" value="1000" min="10" max="100000"  onkeydown="if(event.key==='Enter')drawTwin()"></div></div>
<div class="cg"><label>Gap Size g <span class="tip" title="Find prime pairs (p, p+g)">?</span></label><div class="sig"><input type="range" id="twinG" min="2" max="30" step="2" value="2" oninput="document.getElementById('twinGv').value=this.value;drawTwin()"><input type="number" id="twinGv" value="2" min="2" max="100" step="2" onkeydown="if(event.key==='Enter')drawTwin()"></div></div>
<div class="cg"><label>Visualization</label><select id="twinViz" onchange="drawTwin()">
<option value="gaps">Prime Gap Distribution</option>
<option value="pairs">Twin Prime Pairs</option>
<option value="density">Gap Density by Range</option>
<option value="brun">Brun's Constant Convergence</option>
<option value="constellation">Prime Constellations</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="twinCol" onchange="drawTwin()">
<option value="gap">By Gap Size</option>
<option value="density">By Local Density</option>
<option value="log">By log(p)</option>
</select></div>
</div>
<div class="ctrl">
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="twinLabels" onchange="drawTwin()"> Labels</label>
<label><input type="checkbox" id="twinGrid" checked onchange="drawTwin()"> Grid</label>
<label><input type="checkbox" id="twinAvg" checked onchange="drawTwin()"> Running Average</label>
<label><input type="checkbox" id="twinTheory" checked onchange="drawTwin()"> Theory Curve</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="twinPtSz" min="2" max="12" value="5" onchange="drawTwin()"></div>
<div class="cg"><label>Constellation</label><select id="twinConst" onchange="drawTwin()">
<option value="twin">Twin (p,p+2)</option>
<option value="cousin">Cousin (p,p+4)</option>
<option value="sexy">Sexy (p,p+6)</option>
<option value="triplet">Triplet (p,p+2,p+6)</option>
<option value="quadruplet">Quadruplet (p,p+2,p+6,p+8)</option>
</select></div>
</div>
<div class="bg"><button onclick="drawTwin()">Analyze</button><button onclick="screenshotTwin()">Screenshot</button><button onclick="exportAllTwin()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvTwin()">Export CSV</button><button class="s" onclick="screenshotCanvas('ctwin','Twin Primes','twin_canvas.png')">Canvas</button><button class="s" onclick="screenshotChart('ptwin1','Twin Distribution','twin_chart.png')">Chart</button><button class="s" onclick="screenshotStats('twinLiveStats','Twin Primes','twin_stats.png')">Stats</button></div>
<div class="g2">
<div class="viz"><h3>Prime Gap Analysis up to N = <span id="twinNdisp">1000</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Twin primes (p, p+2) become rarer but are conjectured infinite. Brun proved Œ£1/p (twin) converges.</p>
<canvas id="ctwin" width="800" height="500"></canvas><div class="al" id="altwin"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('twinLiveStats','TwinPrime_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="twinLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Gap Frequency</h3><div class="pc" id="ptwinGap"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Brun's Constant Convergence</h3><div class="pc" id="ptwinBrun"></div></div>
<div class="viz"><h3>Prime Gaps vs log(p)</h3><div class="pc" id="ptwinLog"></div></div>
</div>
<div class="viz"><h3>Prime Pair Data (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="ttwinT"><tr><th>p</th><th>p+g</th><th>Gap</th><th>log(p)</th><th>gap/log(p)</th><th>Œ£1/p</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,100,150,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Twin Prime Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œÄ‚ÇÇ(x) ~ 2C‚ÇÇ ¬∑ x/(ln x)¬≤ &nbsp;|&nbsp; B‚ÇÇ = Œ£(1/p + 1/(p+2)) ‚âà 1.902
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Conjecture:</strong> Infinitely many twin primes (unproved)</div>
<div><strong>Brun (1919):</strong> Sum over twins converges</div>
<div><strong>Zhang (2013):</strong> Gaps ‚â§ 70M infinitely often</div>
<div><strong>Current:</strong> Gaps ‚â§ 246 infinitely often (Polymath)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">First Twin Primes:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
(3,5), (5,7), (11,13), (17,19), (29,31), (41,43), (59,61), (71,73)...
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('twinNv').value=1000;drawTwin()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§1K</button>
<button onclick="document.getElementById('twinNv').value=10000;drawTwin()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§10K</button>
<button onclick="document.getElementById('twinNv').value=50000;drawTwin()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§50K</button>
<button onclick="document.getElementById('twinGap').value=4;drawTwin()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Cousins (g=4)</button>
</div>
</div>
</div>
</div>

<div id="tpi" class="tab">
<div class="ctrl">
<div class="cg"><label>Max x <span class="tip" title="Count primes up to x">?</span></label><div class="sig"><input type="range" id="piX" min="100" max="100000" step="100" value="10000" oninput="document.getElementById('piXv').value=this.value"><input type="number" id="piXv" value="10000" min="10" max="1000000"  onkeydown="if(event.key==='Enter')drawPi()"></div></div>
<div class="cg"><label>Step Size</label><select id="piStep" onchange="drawPi()">
<option value="10">10</option>
<option value="50">50</option>
<option value="100" selected>100</option>
<option value="500">500</option>
</select></div>
<div class="cg"><label>Visualization</label><select id="piViz" onchange="drawPi()">
<option value="count">œÄ(x) Prime Count</option>
<option value="compare">œÄ(x) vs Approximations</option>
<option value="error">Error Analysis</option>
<option value="ratio">œÄ(x)¬∑ln(x)/x Ratio</option>
<option value="density">Prime Density 1/ln(x)</option>
</select></div>
<div class="cg"><label>Approximations</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="piLi" checked onchange="drawPi()"> Li(x)</label>
<label><input type="checkbox" id="piXlnx" checked onchange="drawPi()"> x/ln(x)</label>
<label><input type="checkbox" id="piRiemann" onchange="drawPi()"> R(x)</label>
</div></div>
</div>
<div class="ctrl">
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="piGrid" checked onchange="drawPi()"> Grid</label>
<label><input type="checkbox" id="piLog" onchange="drawPi()"> Log Scale</label>
<label><input type="checkbox" id="piBounds" onchange="drawPi()"> Chebyshev Bounds</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="piPtSz" min="2" max="10" value="4" onchange="drawPi()"></div>
</div>
<div class="bg"><button onclick="drawPi()">Compute</button><button onclick="screenshotPi()">Screenshot</button><button onclick="exportAllPi()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvPi()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Prime Counting Function œÄ(x) up to <span id="piXdisp">10000</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">œÄ(x) counts primes ‚â§ x. PNT: œÄ(x) ~ x/ln(x). Li(x) is the best elementary approximation.</p>
<canvas id="cpi" width="800" height="500"></canvas><div class="al" id="alpi"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('piLiveStats','PrimeCount_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="piLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Approximation Errors</h3><div class="pc" id="ppiErr"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>œÄ(x) vs Approximations</h3><div class="pc" id="ppiComp"></div></div>
<div class="viz"><h3>Ratio œÄ(x)¬∑ln(x)/x ‚Üí 1</h3><div class="pc" id="ppiRatio"></div></div>
</div>
<div class="viz"><h3>Prime Count Data (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tpiT"><tr><th>x</th><th>œÄ(x)</th><th>x/ln(x)</th><th>Li(x)</th><th>Error Li</th><th>Rel %</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Prime Number Theorem</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œÄ(x) ~ x/ln(x) ~ Li(x) = ‚à´‚ÇÇÀ£ dt/ln(t) &nbsp;(Hadamard, de la Vall√©e Poussin, 1896)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Error:</strong> œÄ(x) = Li(x) + O(x¬∑e^(-c‚àöln x))</div>
<div><strong>Riemann R(x):</strong> Œ£ Œº(n)/n ¬∑ Li(x^(1/n)) ‚Äî very accurate</div>
<div><strong>Chebyshev:</strong> 0.92x/ln x < œÄ(x) < 1.11x/ln x</div>
<div><strong>RH ‚üπ:</strong> |œÄ(x) - Li(x)| = O(‚àöx ln x)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Values:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem">
<div>‚Ä¢ œÄ(100) = 25</div>
<div>‚Ä¢ œÄ(1000) = 168</div>
<div>‚Ä¢ œÄ(10‚Å¥) = 1229</div>
<div>‚Ä¢ œÄ(10‚Å∂) = 78498</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('piXv').value=1000;drawPi()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">x‚â§1K</button>
<button onclick="document.getElementById('piXv').value=10000;drawPi()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">x‚â§10K</button>
<button onclick="document.getElementById('piXv').value=100000;drawPi()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">x‚â§100K</button>
<button onclick="document.getElementById('piViz').value='error';drawPi()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Error View</button>
</div>
</div>
</div>
</div>

<div id="tcomp" class="tab">
<div class="ctrl">
<div class="cg"><label>Composite M <span class="tip" title="Composite modulus to analyze">?</span></label><div class="sig"><input type="range" id="compM" min="4" max="500" value="60" oninput="document.getElementById('compMv').value=this.value;drawComp()"><input type="number" id="compMv" value="60" min="4" max="2000" onkeydown="if(event.key==='Enter')drawComp()"></div></div>
<div class="cg"><label>Visualization</label><select id="compViz" onchange="drawComp()">
<option value="projection">Channel Projections</option>
<option value="rings">Ring View</option>
<option value="channels">Channel Diagram</option>
<option value="factorization">Factor Tree</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="compCol" onchange="drawComp()">
<option value="type">By Channel Type</option>
<option value="gcd">By GCD Value</option>
<option value="spf">By Smallest Prime Factor</option>
<option value="lpf">By Largest Prime Factor</option>
<option value="depth">By Channel Depth</option>
</select></div>
<div class="cg"><label>Presets</label>
<button onclick="document.getElementById('compMv').value=6;drawComp()" style="padding:2px 6px">6</button>
<button onclick="document.getElementById('compMv').value=12;drawComp()" style="padding:2px 6px">12</button>
<button onclick="document.getElementById('compMv').value=30;drawComp()" style="padding:2px 6px">30</button>
<button onclick="document.getElementById('compMv').value=60;drawComp()" style="padding:2px 6px">60</button>
<button onclick="document.getElementById('compMv').value=210;drawComp()" style="padding:2px 6px">210</button>
</div>
</div>
<div class="ctrl">
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="compProj" checked onchange="drawComp()"> Projection Lines</label>
<label><input type="checkbox" id="compLabels" onchange="drawComp()"> Channel Labels</label>
<label><input type="checkbox" id="compMult" onchange="drawComp()"> Multiplicity</label>
<label><input type="checkbox" id="compCoprime" checked onchange="drawComp()"> Show Coprime</label>
</div></div>
<div class="cg"><label>Line Opacity</label><input type="range" id="compLineOp" min="0.05" max="0.5" step="0.05" value="0.15" onchange="drawComp()"></div>
<div class="cg"><label>Point Size</label><input type="range" id="compPtSz" min="3" max="15" value="6" onchange="drawComp()"></div>
<div class="cg"><label>Sweep</label><button onclick="startCompSweep()">Play</button><button onclick="stopCompSweep()">Stop</button><span id="compSweepR" style="margin-left:8px;color:#ffd700">r=1</span></div>
</div>
<div class="ctrl" style="border-top:1px solid var(--bord);padding-top:.5rem;margin-top:.5rem">
<div class="cg"><label><strong>Gap Connections</strong> <span class="tip" title="Connect r‚Üír+gap for coprime residues">?</span></label></div>
<div class="cg"><label style="display:flex;gap:.5rem;flex-wrap:wrap">
<input type="checkbox" id="compGap2" onchange="drawComp()"> Gap 2 (Twin)
<input type="checkbox" id="compGap4" onchange="drawComp()"> Gap 4 (Cousin)
<input type="checkbox" id="compGap6" onchange="drawComp()"> Gap 6 (Sexy)
</label></div>
<div class="cg"><label>Gap Line Color</label><select id="compGapCol" onchange="drawComp()">
<option value="auto">Auto (by gap)</option>
<option value="magenta">Magenta</option>
<option value="cyan">Cyan</option>
<option value="gold">Gold</option>
</select></div>
<div class="cg"><label>Gap Line Thickness</label><input type="range" id="compGapThick" min="0.5" max="3" step="0.1" value="1.5" onchange="drawComp()"></div>
<div class="cg"><label><strong>Filter</strong></label><select id="compFilter" onchange="drawComp()">
<option value="all">All Residues</option>
<option value="coprime">Coprime Only</option>
<option value="reducible">Reducible Only</option>
</select></div>
</div>
<div class="bg"><button onclick="drawComp()">Analyze</button><button onclick="screenshotComp()">Screenshot</button><button onclick="exportAllComp()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvComp()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Composite Channel Projection: M = <span id="compMdisp">60</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Cyan = coprime (gcd=1), Red = reducible (gcd>1). Lines show projection r/M ‚Üí r'/M' where M'=M/gcd(r,M).</p>
<canvas id="ccomp" width="750" height="600"></canvas><div class="al" id="alcomp"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('compLiveStats','Composite_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="compLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Channel Distribution</h3><div class="pc" id="pcompDist"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Reducibility by Divisor</h3><div class="pc" id="pcompDiv"></div></div>
<div class="viz"><h3>œÜ(M)/M Density</h3><div class="pc" id="pcompPhi"></div></div>
</div>
<div class="viz"><h3>Residue Channel Data (Click rows)</h3>
<div style="max-height:300px;overflow-y:auto">
<table id="tcompT"><tr><th>r</th><th>gcd(r,M)</th><th>Channel M'</th><th>Reduced r'</th><th>Type</th><th>Multiplicity</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,100,50,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Composite Channel Projection (Getachew 2025)</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
A framework for understanding how residues modulo composite M decompose into "channels" indexed by divisors of M. Each residue r ‚àà {0,1,...,M-1} projects to a reduced channel M' = M/gcd(r,M) with reduced residue r' = r/gcd(r,M). This creates a <strong>hierarchical lattice structure</strong> where the divisor lattice œÑ(M) organizes all possible reduction paths. Coprime residues (gcd=1) stay in the "full" channel M, while reducible residues collapse to smaller channels with multiplicities given by divisor counts.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The projection r ‚Üí r' reveals the multiplicative structure hidden in modular arithmetic. For highly composite M (like primorials 6, 30, 210, 2310), the channel decomposition provides a "sieve" perspective: primes beyond the prime factors of M survive in the coprime channel, while composite numbers collapse into reducible channels. This connects directly to wheel factorization and the M√∂bius sieve structure.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
r/M ‚Üí r'/M' where M' = M/gcd(r,M) &nbsp;|&nbsp; œÜ(M)/M = coprime density
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Coprime:</strong> gcd(r,M)=1 ‚Üí (‚Ñ§/M‚Ñ§)√ó</div>
<div><strong>Reducible:</strong> gcd(r,M)>1 ‚Üí smaller channel</div>
<div><strong>Channels:</strong> œÑ(M) from divisors</div>
<div><strong>œÜ(60)/60:</strong> 16/60 ‚âà 26.7%</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Example M=12:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
Coprime: 1,5,7,11 | Channels: 12,6,4,3,2,1
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('compMv').value=12;drawComp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M=12</button>
<button onclick="document.getElementById('compMv').value=30;drawComp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M=30</button>
<button onclick="document.getElementById('compMv').value=60;drawComp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M=60</button>
<button onclick="document.getElementById('compMv').value=210;drawComp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">M=210</button>
</div>
</div>
</div>
</div>

<div id="tcopair" class="tab">
<div class="ctrl">
<div class="cg"><label>Grid Size N <span class="tip" title="Count coprime pairs in N√óN grid">?</span></label><div class="sig"><input type="range" id="copairN" min="10" max="500" value="60" oninput="document.getElementById('copairNv').value=this.value"><input type="number" id="copairNv" value="60" min="5" max="2000"  onkeydown="if(event.key==='Enter')drawCopair()"></div></div>
<div class="cg"><label>Visualization</label><select id="copairViz" onchange="drawCopair()">
<option value="grid">Grid Heatmap</option>
<option value="density">Density Convergence</option>
<option value="scatter">Scatter (Coprime Only)</option>
<option value="gcdmap">GCD Value Map</option>
<option value="disc">Disc Analysis (RH)</option>
</select></div>
<div class="cg"><label>Color Scheme</label><select id="copairCol" onchange="drawCopair()">
<option value="classic">Classic (Green/Gray)</option>
<option value="gcd">By GCD Value</option>
<option value="neon">Neon (Cyan/Magenta)</option>
<option value="heatmap">Heatmap</option>
<option value="highcontrast">High Contrast</option>
<option value="angle">By Angle arctan(b/a)</option>
<option value="norm">By Norm a¬≤+b¬≤</option>
</select></div>
<div class="cg"><label>Overlays</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="copairCircle" onchange="drawCopair()"> Radius Circle</label>
<label><input type="checkbox" id="copairDiag" onchange="drawCopair()"> Diagonals</label>
<label><input type="checkbox" id="copairPrime" onchange="drawCopair()"> Prime Filter</label>
</div></div>
</div>
<div class="ctrl">
<div class="cg"><label>Circle R</label><div class="sig"><input type="range" id="copairR" min="10" max="100" value="40" oninput="document.getElementById('copairRv').textContent=this.value+'%';drawCopair()"><span id="copairRv" style="color:var(--txt2)">40%</span></div></div>
<div class="cg"><label>Modular Highlight</label><select id="copairMod" onchange="drawCopair()">
<option value="none">None</option>
<option value="2">mod 2</option>
<option value="3">mod 3</option>
<option value="4">mod 4</option>
<option value="5">mod 5</option>
<option value="6">mod 6</option>
</select></div>
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="copairAxes" checked onchange="drawCopair()"> Axes</label>
<label><input type="checkbox" id="copairLabels" onchange="drawCopair()"> Labels</label>
</div></div>
<div class="cg"><label>Animation</label>
<button onclick="startCopairAnim()">‚ñ∂ Play</button>
<button onclick="stopCopairAnim()">Stop</button>
<span id="copairAnimN" style="margin-left:8px;color:#ffd700">N=60</span></div>
</div>
<div class="bg"><button onclick="drawCopair()">Compute</button><button onclick="screenshotCopair()">Screenshot</button><button onclick="exportAllCopair()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCopair()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Coprime Lattice: 1 ‚â§ a,b ‚â§ <span id="copairNdisp">60</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Primitive vectors (gcd=1) are visible from origin. V(R)/œÄR¬≤ ‚Üí 6/œÄ¬≤ connects to Riemann Hypothesis.</p>
<canvas id="ccopair" width="700" height="700"></canvas><div class="al" id="alcopair"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('copairLiveStats','Coprime_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="copairLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">GCD Distribution</h3><div class="pc" id="pcopairGcd"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Disc Analysis V(R) & Error E(R)</h3><div class="pc" id="pcopairDisc"></div></div>
<div class="viz"><h3>Convergence to 6/œÄ¬≤</h3><div class="pc" id="pcopairConv"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>M√∂bius Function M(N) = Œ£Œº(n)</h3><div class="pc" id="pcopairMob"></div></div>
<div class="viz"><h3>|E(R)|/R^¬Ω (RH Bound)</h3><div class="pc" id="pcopairRH"></div></div>
</div>
<div class="viz"><h3>Sample Pairs (Click rows)</h3>
<div style="max-height:220px;overflow-y:auto">
<table id="tcopairT"><tr><th>a</th><th>b</th><th>gcd</th><th>Norm</th><th>Œ∏¬∞</th><th>Coprime?</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,136,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Coprime Lattice Disc Analysis & Riemann Hypothesis (Getachew 2025)</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
An interactive exploration of the deep connection between coprime lattice point counting and the Riemann Hypothesis. The function V(R) = #{(a,b) : gcd(a,b)=1, a¬≤+b¬≤‚â§R¬≤} grows asymptotically as 6R¬≤/œÄ¬≤ = R¬≤/Œ∂(2). The <strong>error term E(R) = V(R) - 6R¬≤/œÄ¬≤ encodes information about the zeta function zeros</strong>. The Riemann Hypothesis is equivalent to the bound |E(R)| = O(R^{¬Ω+Œµ}) for all Œµ > 0, analogous to the Gauss circle problem but for coprime pairs.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #ff006e">
<strong style="color:#ff006e">RH Connection:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The visualization tracks |E(R)|/R^¬Ω as a function of R. If RH is true, this ratio should remain bounded. The normalized error connects directly to the Mertens function M(N) = Œ£Œº(n), and the bound |M(N)|/‚àöN < const would prove RH. Current computations suggest the ratio fluctuates but does not diverge‚Äîconsistent with RH but not a proof.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
V(R) = 6R¬≤/œÄ¬≤ + E(R) &nbsp;|&nbsp; RH ‚ü∫ |E(R)| = O(R^(¬Ω+Œµ))
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Density:</strong> 6/œÄ¬≤ = 1/Œ∂(2) ‚âà 60.79%</div>
<div><strong>M√∂bius:</strong> M(N) = Œ£Œº(n) bounded if RH</div>
<div><strong>Disc:</strong> V(R) = #{gcd(a,b)=1, a¬≤+b¬≤‚â§R¬≤}</div>
<div><strong>Critical Line:</strong> Exponent ¬Ω = Re(s)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('copairNv').value=50;drawCopair()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=50</button>
<button onclick="document.getElementById('copairNv').value=100;drawCopair()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=100</button>
<button onclick="document.getElementById('copairViz').value='disc';drawCopair()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">RH Analysis</button>
<button onclick="startCopairAnim()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Animate</button>
</div>
</div>
</div>
</div>

<div id="tsierp" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Check which numbers 1..N can be expressed as 6ab¬±a¬±b">?</span></label><div class="sig"><input type="range" id="sierpN" min="50" max="500" value="200" oninput="document.getElementById('sierpNv').value=this.value"><input type="number" id="sierpNv" value="200" min="20" max="2000"  onkeydown="if(event.key==='Enter')drawSierp()"></div></div>
<div class="cg"><label>Visualization</label><select id="sierpViz" onchange="drawSierp()">
<option value="coverage">Coverage Map</option>
<option value="lattice">Lattice Structure</option>
<option value="gaps">Gap Analysis</option>
<option value="modular">Modular Patterns</option>
</select></div>
<div class="cg"><label>Form Filter</label><select id="sierpForm" onchange="drawSierp()">
<option value="all">All 4 Forms</option>
<option value="pp">6ab + a + b</option>
<option value="pm">6ab + a - b</option>
<option value="mp">6ab - a + b</option>
<option value="mm">6ab - a - b</option>
</select></div>
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="sierpLabels" onchange="drawSierp()"> Labels</label>
<label><input type="checkbox" id="sierpGCD" onchange="drawSierp()"> GCD Highlight</label>
</div></div>
</div>
<div class="ctrl">
<div class="cg"><label>Search a,b ‚â§</label><div class="sig"><input type="range" id="sierpAB" min="10" max="100" value="50" oninput="document.getElementById('sierpABv').value=this.value"><input type="number" id="sierpABv" value="50" min="5" max="200" onkeydown="if(event.key==='Enter')drawSierp()"></div></div>
<div class="cg"><label>Test Number</label><input type="number" id="sierpTest" value="1" min="1" style="width:80px"><button onclick="testSierpNum()" style="margin-left:5px">Test</button></div>
<div class="cg"><label>Presets</label>
<button onclick="document.getElementById('sierpNv').value=100;drawSierp()" style="padding:2px 6px">100</button>
<button onclick="document.getElementById('sierpNv').value=500;drawSierp()" style="padding:2px 6px">500</button>
<button onclick="document.getElementById('sierpNv').value=1000;drawSierp()" style="padding:2px 6px">1000</button>
</div>
</div>
<div class="bg"><button onclick="drawSierp()">Analyze</button><button onclick="screenshotSierp()">Screenshot</button><button onclick="exportAllSierp()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvSierp()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Sierpi≈Ñski Coverage: n ‚â§ <span id="sierpNdisp">200</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Green = expressible as 6ab¬±a¬±b. Red = uncovered (Sierpi≈Ñski candidates). Status: UNSOLVED since 1964.</p>
<canvas id="csierp" width="750" height="500"></canvas><div class="al" id="alsierp"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('sierpLiveStats','Sierpinski_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="sierpLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Coverage by Form</h3><div class="pc" id="psierpForm"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Uncovered Numbers Distribution</h3><div class="pc" id="psierpGaps"></div></div>
<div class="viz"><h3>Coverage Rate vs N</h3><div class="pc" id="psierpRate"></div></div>
</div>
<div class="viz"><h3>Uncovered Integers (Sierpi≈Ñski Candidates)</h3>
<div style="max-height:200px;overflow-y:auto">
<table id="tsierpT"><tr><th>n</th><th>n mod 6</th><th>n mod 12</th><th>Factorization</th><th>Neighbors</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(255,100,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Sierpi≈Ñski Problem Theory (1964)</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
n = 6ab ¬± a ¬± b &nbsp;|&nbsp; Are infinitely many integers uncovered?
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Form 1:</strong> 6ab + a + b</div>
<div><strong>Form 2:</strong> 6ab + a - b</div>
<div><strong>Form 3:</strong> 6ab - a + b</div>
<div><strong>Form 4:</strong> 6ab - a - b</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">First Uncovered:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
1, 2, 4, 5, 8, 10, 14, 16, 20, 26, 32, 40... (78 values ‚â§1000)
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('sierpNv').value=100;drawSierp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§100</button>
<button onclick="document.getElementById('sierpNv').value=500;drawSierp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§500</button>
<button onclick="document.getElementById('sierpNv').value=1000;drawSierp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§1000</button>
<button onclick="document.getElementById('sierpViz').value='lattice';drawSierp()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Lattice</button>
</div>
</div>
</div>
</div>

<div id="tkfree" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Count k-free integers up to N">?</span></label><div class="sig"><input type="range" id="kfreeN" min="100" max="5000" value="1000" oninput="document.getElementById('kfreeNv').value=this.value"><input type="number" id="kfreeNv" value="1000" min="50" max="50000"  onkeydown="if(event.key==='Enter')drawKfree()"></div></div>
<div class="cg"><label>k (power)</label><select id="kfreeK" onchange="drawKfree()">
<option value="2">k=2 (Squarefree)</option>
<option value="3">k=3 (Cubefree)</option>
<option value="4">k=4 (4th-power-free)</option>
<option value="5">k=5</option>
<option value="6">k=6</option>
</select></div>
<div class="cg"><label>Visualization</label><select id="kfreeViz" onchange="drawKfree()">
<option value="density">Density Convergence</option>
<option value="error">Error Analysis</option>
<option value="grid">Number Grid</option>
<option value="compare">Compare k values</option>
</select></div>
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="kfreeTheory" checked onchange="drawKfree()"> Theory Line</label>
<label><input type="checkbox" id="kfreeBound" checked onchange="drawKfree()"> Error Bound</label>
</div></div>
</div>
<div class="bg"><button onclick="drawKfree()">Compute</button><button onclick="screenshotKfree()">Screenshot</button><button onclick="exportAllKfree()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvKfree()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>k-Free Integers: k=<span id="kfreeKdisp">2</span>, N=<span id="kfreeNdisp">1000</span></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">n is k-free if no prime p has p^k | n. Count Q_k(N) ~ N/Œ∂(k) with error O(N^(1/k)).</p>
<canvas id="ckfree" width="750" height="500"></canvas><div class="al" id="alkfree"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('kfreeLiveStats','kFree_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="kfreeLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Zeta Reference</h3><div class="pc" id="pkfreeZeta"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Error Term E(N) = Q_k(N) - N/Œ∂(k)</h3><div class="pc" id="pkfreeErr"></div></div>
<div class="viz"><h3>|E(N)|/N^(1/k) Ratio</h3><div class="pc" id="pkfreeRatio"></div></div>
</div>
<div class="viz"><h3>First Non-k-free Integers</h3>
<div style="max-height:200px;overflow-y:auto">
<table id="tkfreeT"><tr><th>n</th><th>Factorization</th><th>Divisible by p^k</th><th>Smallest p</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,200,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">k-Free Integers & Boundary Cancellation</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Q_k(N) = N/Œ∂(k) + O(N^(1/k)) &nbsp;|&nbsp; Density = 1/Œ∂(k)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Squarefree:</strong> k=2, 1/Œ∂(2) ‚âà 60.79%</div>
<div><strong>Cubefree:</strong> k=3, 1/Œ∂(3) ‚âà 83.19%</div>
<div><strong>4th-free:</strong> k=4, 1/Œ∂(4) ‚âà 92.39%</div>
<div><strong>Error:</strong> Comes from (k-1)-dim boundary</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">First Non-Squarefree:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem">
4, 8, 9, 12, 16, 18, 20, 24, 25, 27, 28, 32... (divisible by p¬≤)
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('kfreeK').value='2';drawKfree()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Squarefree</button>
<button onclick="document.getElementById('kfreeK').value='3';drawKfree()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Cubefree</button>
<button onclick="document.getElementById('kfreeNv').value=5000;drawKfree()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N=5K</button>
<button onclick="document.getElementById('kfreeViz').value='compare';drawKfree()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Compare k</button>
</div>
</div>
</div>
</div>

<div id="teuler" class="tab">
<div class="ctrl">
<div class="cg"><label>Compute</label><select id="eulerTarget" onchange="drawEuler()">
<option value="pi">œÄ (from Œ∂(2)=œÄ¬≤/6)</option>
<option value="z2">Œ∂(2) = œÄ¬≤/6</option>
<option value="z4">Œ∂(4) = œÄ‚Å¥/90</option>
<option value="z6">Œ∂(6) = œÄ‚Å∂/945</option>
<option value="z8">Œ∂(8)</option>
</select></div>
<div class="cg"><label>Prime Limit <span class="tip" title="Use primes up to this value">?</span></label><div class="sig"><input type="range" id="eulerPmax" min="100" max="10000" value="1000" oninput="document.getElementById('eulerPmaxv').value=this.value"><input type="number" id="eulerPmaxv" value="1000" min="10" max="100000"  onkeydown="if(event.key==='Enter')drawEuler()"></div></div>
<div class="cg"><label>Visualization</label><select id="eulerViz" onchange="drawEuler()">
<option value="convergence">Convergence</option>
<option value="contributions">Prime Contributions</option>
<option value="gaps">Gap-Class Analysis</option>
<option value="residue">Residue Channels</option>
</select></div>
<div class="cg"><label>Modulus</label><input type="number" id="eulerMod" value="30" min="2" max="210" style="width:60px" onchange="drawEuler()"></div>
</div>
<div class="ctrl">
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="eulerRef" checked onchange="drawEuler()"> Reference Line</label>
<label><input type="checkbox" id="eulerError" checked onchange="drawEuler()"> Show Error</label>
</div></div>
<div class="cg"><label>Presets</label>
<button onclick="document.getElementById('eulerPmaxv').value=100;drawEuler()" style="padding:2px 6px">100</button>
<button onclick="document.getElementById('eulerPmaxv').value=1000;drawEuler()" style="padding:2px 6px">1K</button>
<button onclick="document.getElementById('eulerPmaxv').value=10000;drawEuler()" style="padding:2px 6px">10K</button>
<button onclick="document.getElementById('eulerPmaxv').value=50000;drawEuler()" style="padding:2px 6px">50K</button>
</div>
</div>
<div class="bg"><button onclick="drawEuler()">Compute</button><button onclick="screenshotEuler()">Screenshot</button><button onclick="exportAllEuler()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvEuler()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Euler Product: Œ∂(s) = ‚àè<sub>p</sub>(1-p<sup>-s</sup>)<sup>-1</sup></h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Computing <span id="eulerTargetDisp">œÄ</span> using primes ‚â§ <span id="eulerPmaxDisp">1000</span>. Basel: Œ∂(2)=œÄ¬≤/6.</p>
<canvas id="ceuler" width="750" height="500"></canvas><div class="al" id="aleuler"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('eulerLiveStats','Euler_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="eulerLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">Zeta Values Reference</h3><div class="pc" id="peulerZeta"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Convergence to Target</h3><div class="pc" id="peulerConv"></div></div>
<div class="viz"><h3>Error Decay</h3><div class="pc" id="peulerErr"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Gap-Class Contributions</h3><div class="pc" id="peulerGap"></div></div>
<div class="viz"><h3>Residue Channel Contributions</h3><div class="pc" id="peulerRes"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Euler Product & Basel Problem</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Œ∂(s) = Œ£ n‚ÅªÀ¢ = ‚àè_p (1 - p‚ÅªÀ¢)‚Åª¬π &nbsp;|&nbsp; œÄ = ‚àö(6 ¬∑ Œ∂(2))
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Basel (Euler 1734):</strong> Œ∂(2) = œÄ¬≤/6 ‚âà 1.6449</div>
<div><strong>Œ∂(4):</strong> œÄ‚Å¥/90 ‚âà 1.0823</div>
<div><strong>Œ∂(6):</strong> œÄ‚Å∂/945 ‚âà 1.0173</div>
<div><strong>Convergence:</strong> Error ~ 1/P_max for Œ∂(2)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Partial Products:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.5rem">
<div>‚Ä¢ p‚â§2: œÄ ‚âà 2.449</div>
<div>‚Ä¢ p‚â§5: œÄ ‚âà 2.924</div>
<div>‚Ä¢ p‚â§11: œÄ ‚âà 3.075</div>
<div>‚Ä¢ p‚â§101: œÄ ‚âà 3.1337</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('eulerPmaxv').value=100;drawEuler()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">P‚â§100</button>
<button onclick="document.getElementById('eulerPmaxv').value=1000;drawEuler()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">P‚â§1K</button>
<button onclick="document.getElementById('eulerPmaxv').value=10000;drawEuler()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">P‚â§10K</button>
<button onclick="document.getElementById('eulerTarget').value='zeta4';drawEuler()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Compute Œ∂(4)</button>
</div>
</div>
</div>
</div>

<div id="tchord" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n <span class="tip" title="Analyze chord uniformity for moduli up to n">?</span></label><div class="sig"><input type="range" id="chordN" min="50" max="500" value="200" oninput="document.getElementById('chordNv').value=this.value"><input type="number" id="chordNv" value="200" min="20" max="2000"  onkeydown="if(event.key==='Enter')drawChord()"></div></div>
<div class="cg"><label>Visualization</label><select id="chordViz" onchange="drawChord()">
<option value="scatter">CV Scatter (Prime vs Comp)</option>
<option value="histogram">CV Histogram</option>
<option value="separation">Separation by Range</option>
<option value="single">Single Modulus Detail</option>
<option value="compare">Compare 2-3 Moduli</option>
</select></div>
<div class="cg"><label>Test n‚ÇÅ</label><input type="number" id="chordTest" value="97" min="3" style="width:60px" onkeydown="if(event.key==='Enter')drawChord()"></div>
<div class="cg"><label>Compare n‚ÇÇ</label><input type="number" id="chordTest2" value="100" min="3" style="width:60px" onkeydown="if(event.key==='Enter')drawChord()"></div>
<div class="cg"><label>Compare n‚ÇÉ</label><input type="number" id="chordTest3" value="101" min="3" style="width:60px" onkeydown="if(event.key==='Enter')drawChord()"></div>
<div class="cg"><label>Display</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="chordThresh" checked onchange="drawChord()"> Threshold</label>
<label><input type="checkbox" id="chordLabels" onchange="drawChord()"> Labels</label>
</div></div>
</div>
<div class="bg"><button onclick="drawChord()">Analyze</button><button onclick="screenshotChord()">Screenshot</button><button onclick="exportAllChord()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvChord()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Chord Length Uniformity: CV(n) = œÉ/Œº</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Primes have uniform coprime spacing (low CV). Composites have irregular gaps (high CV). Separation grows with n.</p>
<canvas id="cchord" width="750" height="500"></canvas><div class="al" id="alchord"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('chordLiveStats','ChordCV_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="chordLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div>
<h3 style="margin-top:1rem">CV Distribution</h3><div class="pc" id="pchordDist"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Separation by Range</h3><div class="pc" id="pchordSep"></div></div>
<div class="viz"><h3>Prime vs Composite Average CV</h3><div class="pc" id="pchordAvg"></div></div>
</div>
<div class="viz"><h3>Sample Moduli (Click rows)</h3>
<div style="max-height:200px;overflow-y:auto">
<table id="tchordT"><tr><th>n</th><th>Type</th><th>œÜ(n)</th><th>CV</th><th>Gap Ratio</th><th>Verdict</th></tr></table>
</div></div>
<div style="padding:1rem;background:rgba(0,255,200,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Chord Length Uniformity Heuristic (Getachew 2025)</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
A novel primality heuristic based on the geometric uniformity of coprime residue distributions on the unit circle. For any integer n, we place the œÜ(n) coprime residues r ‚àà (‚Ñ§/n‚Ñ§)√ó at angles Œ∏_r = 2œÄr/n on the unit circle. The chord lengths between consecutive coprimes reveal a striking dichotomy: <strong>primes exhibit uniform spacing</strong> (low coefficient of variation), while <strong>composites show irregular gaps</strong> due to their divisor structure. This heuristic achieves ~92% classification accuracy for n ‚â§ 10,000 using a simple threshold CV < 0.22.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
For prime p, the coprime set is {1,2,...,p-1}, which distributes uniformly around the circle. The gaps between consecutive coprimes are all 1, yielding identical chord lengths L = 2¬∑sin(œÄ/p). As p ‚Üí ‚àû, CV ‚Üí 0 geometrically. For composite n = p‚ÇÅ^a‚ÇÅ¬∑p‚ÇÇ^a‚ÇÇ¬∑..., gaps cluster around multiples of the prime factors, creating variance in chord lengths and higher CV values.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
CV(n) = œÉ_L / Œº_L &nbsp;|&nbsp; L_i = 2¬∑sin(œÄ¬∑gap_i/n) &nbsp;|&nbsp; Prime: CV ‚Üí 0
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Prime signature:</strong> CV ‚Üí 0 as n ‚Üí ‚àû (uniform gaps)</div>
<div><strong>Composite:</strong> CV ‚âà 0.30 (irregular gaps)</div>
<div><strong>Decision:</strong> CV < 0.22 ‚Üí likely prime</div>
<div><strong>Separation:</strong> 92.3% accuracy at n‚â§10000</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Example CV Values:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem">
<div>‚Ä¢ n=97 (P): CV‚âà0.08</div>
<div>‚Ä¢ n=100 (C): CV‚âà0.35</div>
<div>‚Ä¢ n=101 (P): CV‚âà0.07</div>
<div>‚Ä¢ n=105 (C): CV‚âà0.42</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('chordNv').value=100;drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">n‚â§100</button>
<button onclick="document.getElementById('chordNv').value=500;drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">n‚â§500</button>
<button onclick="document.getElementById('chordTest').value=97;document.getElementById('chordViz').value='single';drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Single n=97</button>
<button onclick="document.getElementById('chordViz').value='histogram';drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Histogram</button>
</div>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('chordTest').value=97;document.getElementById('chordTest2').value=100;document.getElementById('chordTest3').value=101;document.getElementById('chordViz').value='compare';drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Compare 97 vs 100 vs 101</button>
<button onclick="document.getElementById('chordTest').value=89;document.getElementById('chordTest2').value=90;document.getElementById('chordTest3').value=0;document.getElementById('chordViz').value='compare';drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Compare 89 vs 90</button>
<button onclick="document.getElementById('chordTest').value=127;document.getElementById('chordTest2').value=128;document.getElementById('chordTest3').value=129;document.getElementById('chordViz').value='compare';drawChord()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Compare 127 vs 128 vs 129</button>
</div>
</div>
</div>
</div>

<div id="tgold" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Upper limit for analysis">?</span></label><div class="sig"><input type="range" id="goldN" min="10" max="10000" step="10" value="200" oninput="document.getElementById('goldNv').value=this.value"><input type="number" id="goldNv" value="200" min="10" max="50000"  onkeydown="if(event.key==='Enter')drawGoldbach()"></div></div>
<div class="cg"><label>Test Even <span class="tip" title="Test specific even number">?</span></label><input type="number" id="goldTest" value="100" min="4" step="2" onkeydown="if(event.key==='Enter')drawGoldbach()"></div>
<div class="cg"><label>Visualization</label><select id="goldViz" onchange="drawGoldbach()"><option value="comet">Goldbach Comet</option><option value="partitions">Partition Count</option><option value="single">Single Number</option><option value="heatmap">Heatmap</option></select></div>
<div class="cg"><label>Color</label><select id="goldCol" onchange="drawGoldbach()"><option value="count">By Count</option><option value="minPrime">By Min Prime</option><option value="maxGap">By Max Gap</option></select></div>
<div class="cg"><label>Point Size</label><input type="range" id="goldPtSz" min="1" max="8" step="0.5" value="3" onchange="drawGoldbach()"></div>
<div class="cg"><label><input type="checkbox" id="goldGrid" checked onchange="drawGoldbach()"> Grid</label>
<label><input type="checkbox" id="goldTrend" checked onchange="drawGoldbach()"> Trend Line</label></div>
<div class="bg"><button onclick="drawGoldbach()">Analyze</button><button class="s" onclick="expGoldbach()">PNG</button><button class="s" onclick="csvGoldbach()">CSV</button><button onclick="screenshotGoldbach()">Screenshot</button><button onclick="exportAllGold()" style="background:#1a472a">üì¶ All</button></div>
</div>
<div class="vc">
<div class="viz"><canvas id="cgold" width="700" height="450"></canvas><div class="als"><div id="algold1" class="al"></div><div id="algold2" class="al"></div></div></div>
<div class="viz"><h3>Partition Distribution</h3><div id="pgold" style="height:200px"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('goldLiveStats','Goldbach_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="goldLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
<div class="viz"><h3>Partitions Table</h3><div class="tblw"><table id="tgoldT"></table></div></div>
</div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Goldbach Conjecture Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
‚àÄ even n ‚â• 4: n = p + q for some primes p, q &nbsp;|&nbsp; G(n) = #{(p,q): p+q=n, p‚â§q prime}
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Conjecture:</strong> Every even n ‚â• 4 is sum of two primes</div>
<div><strong>Status:</strong> Unproven (verified to 4√ó10¬π‚Å∏)</div>
<div><strong>Hardy-Littlewood:</strong> G(n) ~ 2C‚ÇÇ¬∑n/(ln n)¬≤ ¬∑ ‚àè((p-1)/(p-2))</div>
<div><strong>C‚ÇÇ ‚âà 0.6601:</strong> Twin prime constant</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Examples:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem">
<div>‚Ä¢ 4 = 2+2</div>
<div>‚Ä¢ 10 = 3+7 = 5+5</div>
<div>‚Ä¢ 100 = 3+97 = 11+89 = ...</div>
<div>‚Ä¢ G(100) = 6 partitions</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('goldNv').value=100;drawGoldbach()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§100</button>
<button onclick="document.getElementById('goldNv').value=1000;drawGoldbach()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§1000</button>
<button onclick="document.getElementById('goldTest').value=1000;document.getElementById('goldViz').value='single';drawGoldbach()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Test 1000</button>
<button onclick="document.getElementById('goldViz').value='heatmap';drawGoldbach()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Heatmap</button>
</div>
</div>
</div>
</div>

<div id="tgap" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Upper limit for primes">?</span></label><div class="sig"><input type="range" id="gapN" min="100" max="100000" step="100" value="1000" oninput="document.getElementById('gapNv').value=this.value"><input type="number" id="gapNv" value="1000" min="100" max="500000"  onkeydown="if(event.key==='Enter')drawGap()"></div></div>
<div class="cg"><label>Visualization</label><select id="gapViz" onchange="drawGap()"><option value="scatter">Gap Scatter</option><option value="histogram">Gap Histogram</option><option value="records">Record Gaps</option><option value="ratio">Gap/ln(p) Ratio</option></select></div>
<div class="cg"><label>Color</label><select id="gapCol" onchange="drawGap()"><option value="gap">By Gap Size</option><option value="record">Highlight Records</option><option value="cram√©r">Cram√©r Ratio</option></select></div>
<div class="cg"><label>Point Size</label><input type="range" id="gapPtSz" min="1" max="8" step="0.5" value="2" onchange="drawGap()"></div>
<div class="cg"><label><input type="checkbox" id="gapGrid" checked onchange="drawGap()"> Grid</label>
<label><input type="checkbox" id="gapCram√©r" checked onchange="drawGap()"> Cram√©r Bound</label></div>
<div class="bg"><button onclick="drawGap()">Analyze</button><button class="s" onclick="expGap()">PNG</button><button class="s" onclick="csvGap()">CSV</button><button onclick="screenshotGap()">Screenshot</button><button onclick="exportAllGap()" style="background:#1a472a">üì¶ All</button></div>
</div>
<div class="vc">
<div class="viz"><canvas id="cgap" width="700" height="450"></canvas><div class="als"><div id="algap1" class="al"></div><div id="algap2" class="al"></div></div></div>
<div class="viz"><h3>Gap Distribution</h3><div id="pgap" style="height:200px"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('gapLiveStats','PrimeGap_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="gapLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
<div class="viz"><h3>Record Gaps Table</h3><div class="tblw"><table id="tgapT"></table></div></div>
</div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Prime Gap Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
g_n = p_{n+1} - p_n &nbsp;|&nbsp; Cram√©r: g_n = O((ln p_n)¬≤) &nbsp;|&nbsp; Average gap ~ ln(p_n)
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Cram√©r Conjecture:</strong> g_n < (ln p_n)¬≤ eventually</div>
<div><strong>Prime Number Theorem:</strong> Average gap ~ ln(n)</div>
<div><strong>Record Gap:</strong> g = 1550 at p ‚âà 9.8√ó10¬π‚Å∏</div>
<div><strong>Twin Prime Gap:</strong> g = 2 (infinitely many?)</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">First Record Gaps:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem">
<div>‚Ä¢ g=1 at p=2</div>
<div>‚Ä¢ g=2 at p=3</div>
<div>‚Ä¢ g=4 at p=7</div>
<div>‚Ä¢ g=6 at p=23</div>
<div>‚Ä¢ g=8 at p=89</div>
<div>‚Ä¢ g=14 at p=113</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('gapNv').value=1000;drawGap()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§1K</button>
<button onclick="document.getElementById('gapNv').value=10000;drawGap()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§10K</button>
<button onclick="document.getElementById('gapViz').value='records';drawGap()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Records</button>
<button onclick="document.getElementById('gapViz').value='histogram';drawGap()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Histogram</button>
</div>
</div>
</div>
</div>

<div id="tsoph" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N <span class="tip" title="Upper limit for search">?</span></label><div class="sig"><input type="range" id="sophN" min="100" max="100000" step="100" value="1000" oninput="document.getElementById('sophNv').value=this.value"><input type="number" id="sophNv" value="1000" min="100" max="500000"  onkeydown="if(event.key==='Enter')drawSophie()"></div></div>
<div class="cg"><label>Type</label><select id="sophType" onchange="drawSophie()"><option value="sophie">Sophie Germain (p, 2p+1)</option><option value="safe">Safe Primes (2p+1)</option><option value="cunningham1">Cunningham Chain 1st</option><option value="cunningham2">Cunningham Chain 2nd</option></select></div>
<div class="cg"><label>Visualization</label><select id="sophViz" onchange="drawSophie()"><option value="scatter">Scatter Plot</option><option value="density">Density</option><option value="chains">Chain Lengths</option></select></div>
<div class="cg"><label>Point Size</label><input type="range" id="sophPtSz" min="1" max="8" step="0.5" value="3" onchange="drawSophie()"></div>
<div class="cg"><label><input type="checkbox" id="sophGrid" checked onchange="drawSophie()"> Grid</label>
<label><input type="checkbox" id="sophPairs" checked onchange="drawSophie()"> Connect Pairs</label></div>
<div class="bg"><button onclick="drawSophie()">Analyze</button><button class="s" onclick="expSophie()">PNG</button><button class="s" onclick="csvSophie()">CSV</button><button onclick="screenshotSophie()">Screenshot</button><button onclick="exportAllSoph()" style="background:#1a472a">üì¶ All</button></div>
</div>
<div class="vc">
<div class="viz"><canvas id="csoph" width="700" height="450"></canvas><div class="als"><div id="alsoph1" class="al"></div><div id="alsoph2" class="al"></div></div></div>
<div class="viz"><h3>Distribution</h3><div id="psoph" style="height:200px"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('sophLiveStats','SophieGermain_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="sophLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.85rem"></div></div>
<div class="viz"><h3>Sophie Germain Primes Table</h3><div class="tblw"><table id="tsophT"></table></div></div>
</div>
<div style="padding:1rem;background:rgba(255,215,0,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Sophie Germain Primes Theory</h4>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
p is Sophie Germain prime ‚ü∫ p and 2p+1 both prime &nbsp;|&nbsp; 2p+1 is called "safe prime"
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;font-size:.85rem;color:var(--txt2)">
<div><strong>Sophie Germain (1776-1831):</strong> French mathematician</div>
<div><strong>Application:</strong> Cryptography (safe primes)</div>
<div><strong>Conjecture:</strong> Infinitely many (unproven)</div>
<div><strong>Density:</strong> ~C¬∑n/(ln n)¬≤ where C ‚âà 1.32</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">First Sophie Germain Primes:</strong>
<div style="font-size:.85rem;color:var(--txt2);margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem">
<div>‚Ä¢ 2 ‚Üí 5</div>
<div>‚Ä¢ 3 ‚Üí 7</div>
<div>‚Ä¢ 5 ‚Üí 11</div>
<div>‚Ä¢ 11 ‚Üí 23</div>
<div>‚Ä¢ 23 ‚Üí 47</div>
<div>‚Ä¢ 29 ‚Üí 59</div>
<div>‚Ä¢ 41 ‚Üí 83</div>
<div>‚Ä¢ 53 ‚Üí 107</div>
</div>
</div>
<div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bord)">
<strong style="color:var(--acc)">Quick Presets:</strong>
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
<button onclick="document.getElementById('sophNv').value=1000;drawSophie()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§1K</button>
<button onclick="document.getElementById('sophNv').value=10000;drawSophie()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">N‚â§10K</button>
<button onclick="document.getElementById('sophType').value='safe';drawSophie()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Safe Primes</button>
<button onclick="document.getElementById('sophType').value='cunningham1';drawSophie()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">Cunningham</button>
</div>
</div>
</div>
</div>

<div id="tmert" class="tab">
<div class="ctrl">
<div class="cg"><label>Max x <span class="tip" title="Upper bound for summation">?</span></label><div class="sig"><input type="range" id="mertX" min="100" max="50000" value="1000" oninput="document.getElementById('mertXv').value=this.value;drawMertens()"><input type="number" id="mertXv" value="1000" min="10" max="100000" onkeydown="if(event.key==='Enter')drawMertens()"></div></div>
<div class="cg"><label>Visualization</label><select id="mertViz" onchange="drawMertens()">
<option value="cumulative">M(x) Cumulative</option>
<option value="normalized">M(x)/‚àöx Normalized</option>
<option value="mobius">Œº(n) Values</option>
<option value="both">M(x) + Œº(n) Combined</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="mertCol" onchange="drawMertens()">
<option value="sign">By Sign (+1/-1/0)</option>
<option value="squarefree">Squarefree vs Not</option>
<option value="omega">By œâ(n) (distinct primes)</option>
</select></div>
<div class="cg"><label>Show Bounds</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="mertBoundSqrt" checked onchange="drawMertens()"> ¬±‚àöx</label>
<label><input type="checkbox" id="mertBoundRH" onchange="drawMertens()"> RH Bound x^{1/2+Œµ}</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="mertPtSz" min="1" max="8" value="3" step="0.5" onchange="drawMertens()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('mertXv').value=500;drawMertens()">500</button>
<button onclick="document.getElementById('mertXv').value=1000;drawMertens()">1K</button>
<button onclick="document.getElementById('mertXv').value=5000;drawMertens()">5K</button>
<button onclick="document.getElementById('mertXv').value=10000;drawMertens()">10K</button>
<button onclick="document.getElementById('mertXv').value=50000;drawMertens()">50K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawMertens()">Compute</button><button onclick="screenshotMertens()">Screenshot</button><button onclick="exportAllMert()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvMertens()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Mertens Function M(x) = Œ£Œº(n) for n‚â§x</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Click any point for details. RH ‚ü∫ M(x) = O(x^{1/2+Œµ}) for all Œµ>0.</p>
<canvas id="cmert" width="800" height="500"></canvas><div class="al" id="almert"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('mertLiveStats','Mertens_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="mertLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>M(x)/‚àöx Ratio</h3><div class="pc" id="pmertRatio"></div></div>
<div class="viz"><h3>Œº(n) Distribution</h3><div class="pc" id="pmertDist"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,100,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Mertens Function & Riemann Hypothesis</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Mertens function M(x) = Œ£_{n‚â§x} Œº(n) is the summatory function of the M√∂bius function. It encodes the "imbalance" between squarefree integers with even vs odd numbers of prime factors. The Riemann Hypothesis is equivalent to the bound |M(x)| = O(x^{1/2+Œµ}) for all Œµ > 0. The weaker Mertens conjecture |M(x)| < ‚àöx was disproved by Odlyzko and te Riele (1985), but the RH bound remains open.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (RH Connection):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The connection to RH comes through the identity: 1/Œ∂(s) = Œ£Œº(n)/n^s. The Dirichlet series for 1/Œ∂(s) converges absolutely for Re(s) > 1. The behavior of M(x) determines how far left this can be analytically continued. If |M(x)| = O(x^{1/2+Œµ}), then Œ∂(s) has no zeros with Re(s) > 1/2, which is RH. The normalized ratio M(x)/‚àöx oscillates but should remain bounded if RH is true.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
RH ‚ü∫ M(x) = O(x^{1/2+Œµ}) ‚àÄŒµ>0 &nbsp;&nbsp;|&nbsp;&nbsp; M(x) = Œ£_{n‚â§x} Œº(n) &nbsp;&nbsp;|&nbsp;&nbsp; 1/Œ∂(s) = Œ£ Œº(n)/n^s
</div>
</div>
</div>

<div id="tcheb" class="tab">
<div class="ctrl">
<div class="cg"><label>Max x <span class="tip" title="Upper bound for summation">?</span></label><div class="sig"><input type="range" id="chebX" min="100" max="50000" value="1000" oninput="document.getElementById('chebXv').value=this.value;drawChebyshev()"><input type="number" id="chebXv" value="1000" min="10" max="100000" onkeydown="if(event.key==='Enter')drawChebyshev()"></div></div>
<div class="cg"><label>Function</label><select id="chebFunc" onchange="drawChebyshev()">
<option value="psi">œà(x) = Œ£ Œõ(n)</option>
<option value="theta">Œ∏(x) = Œ£ log p</option>
<option value="both">Both œà(x) and Œ∏(x)</option>
<option value="error">Error œà(x) - x</option>
</select></div>
<div class="cg"><label>Show Reference</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="chebShowX" checked onchange="drawChebyshev()"> y = x line</label>
<label><input type="checkbox" id="chebShowRH" onchange="drawChebyshev()"> RH bound</label>
</div></div>
<div class="cg"><label>Normalization</label><select id="chebNorm" onchange="drawChebyshev()">
<option value="raw">Raw values</option>
<option value="ratio">œà(x)/x ratio</option>
<option value="error_norm">(œà(x)-x)/‚àöx</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="chebPtSz" min="1" max="8" value="3" step="0.5" onchange="drawChebyshev()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('chebXv').value=500;drawChebyshev()">500</button>
<button onclick="document.getElementById('chebXv').value=1000;drawChebyshev()">1K</button>
<button onclick="document.getElementById('chebXv').value=5000;drawChebyshev()">5K</button>
<button onclick="document.getElementById('chebXv').value=10000;drawChebyshev()">10K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawChebyshev()">Compute</button><button onclick="screenshotChebyshev()">Screenshot</button><button onclick="exportAllCheb()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvChebyshev()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Chebyshev Functions œà(x) and Œ∏(x)</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">œà(x) counts prime powers weighted by log. PNT: œà(x) ~ x. RH: œà(x) = x + O(x^{1/2+Œµ}).</p>
<canvas id="ccheb" width="800" height="500"></canvas><div class="al" id="alcheb"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('chebLiveStats','Chebyshev_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="chebLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>œà(x)/x Convergence</h3><div class="pc" id="pchebRatio"></div></div>
<div class="viz"><h3>Von Mangoldt Œõ(n)</h3><div class="pc" id="pchebLambda"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,200,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Chebyshev Functions & Prime Number Theorem</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Chebyshev function œà(x) = Œ£_{n‚â§x} Œõ(n) where Œõ(n) is the von Mangoldt function (log p if n=p^k, else 0). The companion function Œ∏(x) = Œ£_{p‚â§x} log p sums only over primes. The Prime Number Theorem (PNT) states œà(x) ~ x and Œ∏(x) ~ x as x‚Üí‚àû. These functions are smoother than œÄ(x) and connect directly to Œ∂(s) zeros.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Explicit Formula):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The explicit formula connects œà(x) to zeta zeros: œà(x) = x - Œ£_œÅ x^œÅ/œÅ - log(2œÄ) - ¬Ωlog(1-x^{-2}), where the sum is over nontrivial zeros œÅ of Œ∂(s). Each zero contributes an oscillation. RH (all œÅ have Re(œÅ)=1/2) implies these oscillations decay like ‚àöx, giving œà(x) = x + O(‚àöx log¬≤x).
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œà(x) = Œ£_{n‚â§x} Œõ(n) ~ x &nbsp;&nbsp;|&nbsp;&nbsp; Œ∏(x) = Œ£_{p‚â§x} log p ~ x &nbsp;&nbsp;|&nbsp;&nbsp; Œõ(p^k) = log p
</div>
</div>
</div>

<div id="tli" class="tab">
<div class="ctrl">
<div class="cg"><label>Max x <span class="tip" title="Upper bound for integration">?</span></label><div class="sig"><input type="range" id="liX" min="10" max="100000" value="1000" oninput="document.getElementById('liXv').value=this.value;drawLi()"><input type="number" id="liXv" value="1000" min="10" max="500000" onkeydown="if(event.key==='Enter')drawLi()"></div></div>
<div class="cg"><label>Visualization</label><select id="liViz" onchange="drawLi()">
<option value="comparison">œÄ(x) vs Li(x) vs x/ln(x)</option>
<option value="error">Error œÄ(x) - Li(x)</option>
<option value="ratio">œÄ(x)/Li(x) Ratio</option>
<option value="density">Prime Density 1/ln(x)</option>
</select></div>
<div class="cg"><label>Show Functions</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="liShowPi" checked onchange="drawLi()"> œÄ(x)</label>
<label><input type="checkbox" id="liShowLi" checked onchange="drawLi()"> Li(x)</label>
<label><input type="checkbox" id="liShowXln" checked onchange="drawLi()"> x/ln(x)</label>
<label><input type="checkbox" id="liShowR" onchange="drawLi()"> R(x) Riemann</label>
</div></div>
<div class="cg"><label>Scale</label><select id="liScale" onchange="drawLi()">
<option value="linear">Linear</option>
<option value="log">Logarithmic</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="liPtSz" min="1" max="8" value="3" step="0.5" onchange="drawLi()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('liXv').value=100;drawLi()">100</button>
<button onclick="document.getElementById('liXv').value=1000;drawLi()">1K</button>
<button onclick="document.getElementById('liXv').value=10000;drawLi()">10K</button>
<button onclick="document.getElementById('liXv').value=100000;drawLi()">100K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawLi()">Compute</button><button onclick="screenshotLi()">Screenshot</button><button onclick="exportAllLi()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvLi()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Logarithmic Integral Li(x) = ‚à´‚ÇÇÀ£ dt/ln(t)</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Li(x) is the best elementary approximation to œÄ(x). Click points for details.</p>
<canvas id="cli" width="800" height="500"></canvas><div class="al" id="alli"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('liLiveStats','Li_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="liLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Error œÄ(x) - Li(x)</h3><div class="pc" id="pliError"></div></div>
<div class="viz"><h3>Approximation Quality</h3><div class="pc" id="pliQuality"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,255,150,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Logarithmic Integral & Prime Counting</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The logarithmic integral Li(x) = ‚à´‚ÇÇÀ£ dt/ln(t) provides the best elementary approximation to the prime counting function œÄ(x). Gauss conjectured œÄ(x) ~ Li(x), which is the Prime Number Theorem (proved 1896). While x/ln(x) is simpler, Li(x) has smaller error: |œÄ(x) - Li(x)| grows much slower than |œÄ(x) - x/ln(x)|.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Skewes Number):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Surprisingly, Li(x) > œÄ(x) for all computed values, but Littlewood proved œÄ(x) - Li(x) changes sign infinitely often! The first crossover (Skewes number) is enormous: around 10^316. Under RH, |œÄ(x) - Li(x)| = O(‚àöx log x). Riemann's function R(x) = Œ£ Œº(n)/n ¬∑ Li(x^{1/n}) is even more accurate, incorporating the zeros of Œ∂(s).
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Li(x) = ‚à´‚ÇÇÀ£ dt/ln(t) &nbsp;&nbsp;|&nbsp;&nbsp; œÄ(x) ~ Li(x) &nbsp;&nbsp;|&nbsp;&nbsp; R(x) = Œ£ Œº(n)/n ¬∑ Li(x^{1/n})
</div>
</div>
</div>

<div id="tdiv" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n <span class="tip" title="Upper bound for computation">?</span></label><div class="sig"><input type="range" id="divN" min="50" max="10000" value="500" oninput="document.getElementById('divNv').value=this.value;drawDivisor()"><input type="number" id="divNv" value="500" min="10" max="50000" onkeydown="if(event.key==='Enter')drawDivisor()"></div></div>
<div class="cg"><label>Function</label><select id="divFunc" onchange="drawDivisor()">
<option value="tau">œÑ(n) = d(n) Divisor Count</option>
<option value="sigma">œÉ(n) Sum of Divisors</option>
<option value="sigma_k">œÉ_k(n) Power Sum</option>
<option value="both">Both œÑ(n) and œÉ(n)</option>
</select></div>
<div class="cg"><label>Visualization</label><select id="divViz" onchange="drawDivisor()">
<option value="scatter">Scatter Plot</option>
<option value="average">Running Average</option>
<option value="max">Record Values</option>
<option value="density">Density Distribution</option>
</select></div>
<div class="cg"><label>œÉ_k Power (k)</label><input type="number" id="divK" value="1" min="-2" max="10" onchange="drawDivisor()"></div>
<div class="cg"><label>Point Size</label><input type="range" id="divPtSz" min="1" max="8" value="2" step="0.5" onchange="drawDivisor()"></div>
<div class="cg"><label>Show Reference</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="divShowAvg" checked onchange="drawDivisor()"> Average Line</label>
<label><input type="checkbox" id="divShowHC" onchange="drawDivisor()"> Highly Composite</label>
</div></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('divNv').value=100;drawDivisor()">100</button>
<button onclick="document.getElementById('divNv').value=500;drawDivisor()">500</button>
<button onclick="document.getElementById('divNv').value=1000;drawDivisor()">1K</button>
<button onclick="document.getElementById('divNv').value=5000;drawDivisor()">5K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawDivisor()">Compute</button><button onclick="screenshotDivisor()">Screenshot</button><button onclick="exportAllDiv()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvDivisor()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Divisor Functions œÑ(n) and œÉ(n)</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">œÑ(n) counts divisors, œÉ(n) sums them. Click points for factorization details.</p>
<canvas id="cdiv" width="800" height="500"></canvas><div class="al" id="aldiv"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('divLiveStats','Divisor_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="divLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>œÑ(n) Distribution</h3><div class="pc" id="pdivTau"></div></div>
<div class="viz"><h3>œÉ(n)/n Abundancy</h3><div class="pc" id="pdivAbund"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Divisor Functions in Number Theory</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The divisor function œÑ(n) = d(n) counts the number of positive divisors of n, while œÉ(n) sums all divisors. For prime p, œÑ(p)=2 and œÉ(p)=p+1. These are multiplicative: œÑ(mn)=œÑ(m)œÑ(n) when gcd(m,n)=1. The average value of œÑ(n) is log n + 2Œ≥ - 1 where Œ≥‚âà0.5772 is Euler's constant. Highly composite numbers have more divisors than any smaller number.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Perfect & Abundant Numbers):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The abundancy index œÉ(n)/n classifies numbers: deficient (œÉ(n)/n < 2), perfect (œÉ(n)/n = 2), or abundant (œÉ(n)/n > 2). Perfect numbers satisfy œÉ(n) = 2n (e.g., 6, 28, 496). Euler proved even perfect numbers have form 2^{p-1}(2^p - 1) where 2^p - 1 is Mersenne prime. Whether odd perfect numbers exist is unknown!
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œÑ(n) = Œ£_{d|n} 1 &nbsp;&nbsp;|&nbsp;&nbsp; œÉ(n) = Œ£_{d|n} d &nbsp;&nbsp;|&nbsp;&nbsp; œÉ_k(n) = Œ£_{d|n} d^k &nbsp;&nbsp;|&nbsp;&nbsp; ‚ü®œÑ(n)‚ü© ~ log n
</div>
</div>
</div>

<div id="tliou" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n <span class="tip" title="Upper bound for computation">?</span></label><div class="sig"><input type="range" id="liouN" min="100" max="50000" value="1000" oninput="document.getElementById('liouNv').value=this.value;drawLiouville()"><input type="number" id="liouNv" value="1000" min="10" max="100000" onkeydown="if(event.key==='Enter')drawLiouville()"></div></div>
<div class="cg"><label>Visualization</label><select id="liouViz" onchange="drawLiouville()">
<option value="cumulative">L(x) = Œ£Œª(n) Cumulative</option>
<option value="normalized">L(x)/‚àöx Normalized</option>
<option value="lambda">Œª(n) Values</option>
<option value="comparison">L(x) vs M(x) Comparison</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="liouCol" onchange="drawLiouville()">
<option value="sign">By Sign (+1/-1)</option>
<option value="omega">By Œ©(n) (total primes)</option>
<option value="squarefree">Squarefree Highlight</option>
</select></div>
<div class="cg"><label>Show Bounds</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="liouBoundSqrt" checked onchange="drawLiouville()"> ¬±‚àöx</label>
<label><input type="checkbox" id="liouShowM" onchange="drawLiouville()"> Show M(x)</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="liouPtSz" min="1" max="8" value="3" step="0.5" onchange="drawLiouville()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('liouNv').value=500;drawLiouville()">500</button>
<button onclick="document.getElementById('liouNv').value=1000;drawLiouville()">1K</button>
<button onclick="document.getElementById('liouNv').value=5000;drawLiouville()">5K</button>
<button onclick="document.getElementById('liouNv').value=10000;drawLiouville()">10K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawLiouville()">Compute</button><button onclick="screenshotLiouville()">Screenshot</button><button onclick="exportAllLiou()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvLiouville()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Liouville Function L(x) = Œ£Œª(n)</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Œª(n) = (-1)^{Œ©(n)} where Œ©(n) counts prime factors with multiplicity. RH connection via P√≥lya conjecture.</p>
<canvas id="cliou" width="800" height="500"></canvas><div class="al" id="alliou"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('liouLiveStats','Liouville_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="liouLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>L(x)/‚àöx Ratio</h3><div class="pc" id="pliouRatio"></div></div>
<div class="viz"><h3>Œ©(n) Distribution</h3><div class="pc" id="pliouOmega"></div></div>
</div>
<div style="padding:1rem;background:rgba(150,100,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Liouville Function & P√≥lya Conjecture</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Liouville function Œª(n) = (-1)^{Œ©(n)} where Œ©(n) is the number of prime factors of n counted with multiplicity. Unlike Œº(n), Œª(n) is never zero. The summatory function L(x) = Œ£_{n‚â§x} Œª(n) relates to M(x) via: L(x) = Œ£_{k‚â§‚àöx} M(x/k¬≤). The Liouville function is completely multiplicative: Œª(mn) = Œª(m)Œª(n) for all m,n.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (P√≥lya Conjecture):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
P√≥lya conjectured (1919) that L(x) ‚â§ 0 for all x ‚â• 2, meaning more integers have an odd number of prime factors. This was disproved by Haselgrove (1958)! The first counterexample is around x ‚âà 906,150,257. Like M(x), RH implies L(x) = O(x^{1/2+Œµ}).
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Œª(n) = (-1)^{Œ©(n)} &nbsp;&nbsp;|&nbsp;&nbsp; L(x) = Œ£_{n‚â§x} Œª(n) &nbsp;&nbsp;|&nbsp;&nbsp; L(x) = Œ£_{k‚â§‚àöx} M(x/k¬≤)
</div>
</div>
</div>

<div id="tmang" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n <span class="tip" title="Upper bound for computation">?</span></label><div class="sig"><input type="range" id="mangN" min="50" max="5000" value="500" oninput="document.getElementById('mangNv').value=this.value;drawMangoldt()"><input type="number" id="mangNv" value="500" min="10" max="20000" onkeydown="if(event.key==='Enter')drawMangoldt()"></div></div>
<div class="cg"><label>Visualization</label><select id="mangViz" onchange="drawMangoldt()">
<option value="bars">Œõ(n) Bar Chart</option>
<option value="cumulative">œà(x) = Œ£ Œõ(n)</option>
<option value="primepower">Prime Power Highlight</option>
<option value="log">log p Values</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="mangCol" onchange="drawMangoldt()">
<option value="prime">By Prime Base</option>
<option value="power">By Power k</option>
<option value="size">By log p Size</option>
</select></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="mangShowPrimes" checked onchange="drawMangoldt()"> Primes (k=1)</label>
<label><input type="checkbox" id="mangShowPowers" checked onchange="drawMangoldt()"> Higher Powers</label>
<label><input type="checkbox" id="mangShowPsi" onchange="drawMangoldt()"> œà(x) Line</label>
</div></div>
<div class="cg"><label>Point Size</label><input type="range" id="mangPtSz" min="1" max="10" value="4" step="0.5" onchange="drawMangoldt()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('mangNv').value=100;drawMangoldt()">100</button>
<button onclick="document.getElementById('mangNv').value=500;drawMangoldt()">500</button>
<button onclick="document.getElementById('mangNv').value=1000;drawMangoldt()">1K</button>
<button onclick="document.getElementById('mangNv').value=2000;drawMangoldt()">2K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawMangoldt()">Compute</button><button onclick="screenshotMangoldt()">Screenshot</button><button onclick="exportAllMang()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvMangoldt()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Von Mangoldt Function Œõ(n)</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Œõ(n) = log p if n = p^k for prime p, else 0. Core building block for Chebyshev functions.</p>
<canvas id="cmang" width="800" height="500"></canvas><div class="al" id="almang"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('mangLiveStats','Mangoldt_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="mangLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Prime Powers by Base</h3><div class="pc" id="pmangPowers"></div></div>
<div class="viz"><h3>Œõ(n) Size Distribution</h3><div class="pc" id="pmangDist"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,255,200,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Von Mangoldt Function & Explicit Formulas</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The von Mangoldt function Œõ(n) equals log p when n is a prime power p^k, and 0 otherwise. It satisfies the elegant identity: Œ£_{d|n} Œõ(d) = log n, making it fundamental to multiplicative number theory. The Chebyshev function œà(x) = Œ£_{n‚â§x} Œõ(n) smooths prime counting, and PNT states œà(x) ~ x.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Explicit Formula):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The explicit formula directly connects Œõ(n) to zeta zeros: œà(x) = x - Œ£_œÅ x^œÅ/œÅ - log(2œÄ) + O(1), where œÅ runs over nontrivial zeros of Œ∂(s). Each zero contributes an oscillating term x^œÅ/œÅ. If RH holds (all Re(œÅ) = 1/2), these oscillations have amplitude ‚àöx, giving optimal error bounds.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Œõ(p^k) = log p &nbsp;&nbsp;|&nbsp;&nbsp; Œ£_{d|n} Œõ(d) = log n &nbsp;&nbsp;|&nbsp;&nbsp; œà(x) = Œ£ Œõ(n) = x - Œ£_œÅ x^œÅ/œÅ + O(1)
</div>
</div>
</div>

<div id="tram" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus q <span class="tip" title="Denominator for Ramanujan sum">?</span></label><div class="sig"><input type="range" id="ramQ" min="2" max="100" value="12" oninput="document.getElementById('ramQv').value=this.value;drawRamanujan()"><input type="number" id="ramQv" value="12" min="2" max="500" onkeydown="if(event.key==='Enter')drawRamanujan()"></div></div>
<div class="cg"><label>Max n <span class="tip" title="Range for n values">?</span></label><div class="sig"><input type="range" id="ramN" min="10" max="500" value="100" oninput="document.getElementById('ramNv').value=this.value;drawRamanujan()"><input type="number" id="ramNv" value="100" min="10" max="2000" onkeydown="if(event.key==='Enter')drawRamanujan()"></div></div>
<div class="cg"><label>Visualization</label><select id="ramViz" onchange="drawRamanujan()">
<option value="heatmap">c_q(n) Heatmap (q vs n)</option>
<option value="fixedq">c_q(n) for Fixed q</option>
<option value="fixedn">c_q(n) for Fixed n</option>
<option value="circle">Unit Circle Roots</option>
</select></div>
<div class="cg"><label>Color Scale</label><select id="ramCol" onchange="drawRamanujan()">
<option value="diverging">Diverging (¬±)</option>
<option value="magnitude">Magnitude |c_q|</option>
<option value="phase">By Sign</option>
</select></div>
<div class="cg"><label>Fixed n (for q-view)</label><input type="number" id="ramFixN" value="6" min="1" max="1000" onchange="drawRamanujan()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('ramQv').value=6;drawRamanujan()">q=6</button>
<button onclick="document.getElementById('ramQv').value=12;drawRamanujan()">q=12</button>
<button onclick="document.getElementById('ramQv').value=30;drawRamanujan()">q=30</button>
<button onclick="document.getElementById('ramQv').value=60;drawRamanujan()">q=60</button>
</div></div>
</div>
<div class="bg"><button onclick="drawRamanujan()">Compute</button><button onclick="screenshotRamanujan()">Screenshot</button><button onclick="exportAllRam()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvRamanujan()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Ramanujan Sum c_q(n) = Œ£_{gcd(a,q)=1} e^{2œÄian/q}</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Sum of primitive q-th roots of unity raised to power n. Always an integer! Click for details.</p>
<canvas id="cram" width="800" height="500"></canvas><div class="al" id="alram"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('ramLiveStats','Ramanujan_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="ramLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>c_q(n) vs n</h3><div class="pc" id="pramN"></div></div>
<div class="viz"><h3>c_q(n) for Divisors of q</h3><div class="pc" id="pramDiv"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,150,200,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Ramanujan Sums & Fourier Analysis on (‚Ñ§/q‚Ñ§)√ó</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Ramanujan sum c_q(n) = Œ£_{1‚â§a‚â§q, gcd(a,q)=1} e^{2œÄian/q} is the sum of primitive q-th roots of unity raised to the n-th power. Remarkably, c_q(n) is always an integer! It equals Œº(q/gcd(n,q))¬∑œÜ(q)/œÜ(q/gcd(n,q)) when gcd(n,q) divides q. Ramanujan sums form an orthogonal basis for arithmetic functions.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Ramanujan Expansion):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Any arithmetic function f(n) with convergent series can be expanded: f(n) = Œ£_q a_q¬∑c_q(n). For example, Œº(n) = Œ£_q Œº(q)c_q(n)/œÜ(q) and d(n) = Œ£_q c_q(n)log(q)/q. This is Fourier analysis on the integers! The expansion converges for multiplicative functions.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
c_q(n) = Œ£_{gcd(a,q)=1} e^{2œÄian/q} = Œº(q/d)¬∑œÜ(q)/œÜ(q/d) where d = gcd(n,q)
</div>
</div>
</div>

<div id="tulam" class="tab">
<div class="ctrl">
<div class="cg"><label>Spiral Size <span class="tip" title="Width/height in cells">?</span></label><div class="sig"><input type="range" id="ulamSize" min="51" max="401" step="2" value="101" oninput="document.getElementById('ulamSizev').value=this.value;drawUlam()"><input type="number" id="ulamSizev" value="101" min="11" step="2" max="501" onkeydown="if(event.key==='Enter')drawUlam()"></div></div>
<div class="cg"><label>Start Number</label><input type="number" id="ulamStart" value="1" min="1" max="1000000" onchange="drawUlam()"></div>
<div class="cg"><label>Highlight</label><select id="ulamHL" onchange="drawUlam()">
<option value="primes">Primes Only</option>
<option value="twin">Twin Primes</option>
<option value="sophie">Sophie Germain</option>
<option value="mersenne">Near 2^n-1</option>
<option value="diagonal">Diagonal Patterns</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="ulamCol" onchange="drawUlam()">
<option value="classic">Classic (Black/White)</option>
<option value="heat">Prime Density Heat</option>
<option value="mod6">Mod 6 Residue</option>
<option value="gcd">GCD Pattern</option>
</select></div>
<div class="cg"><label>Cell Size</label><input type="range" id="ulamCell" min="1" max="10" value="4" onchange="drawUlam()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('ulamSizev').value=51;drawUlam()">51√ó51</button>
<button onclick="document.getElementById('ulamSizev').value=101;drawUlam()">101√ó101</button>
<button onclick="document.getElementById('ulamSizev').value=201;drawUlam()">201√ó201</button>
<button onclick="document.getElementById('ulamSizev').value=401;drawUlam()">401√ó401</button>
</div></div>
</div>
<div class="bg"><button onclick="drawUlam()">Generate</button><button onclick="screenshotUlam()">Screenshot</button><button onclick="exportAllUlam()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvUlam()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Ulam Spiral ‚Äî Primes on Integer Spiral</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Integers spiral outward; primes cluster along diagonals. Discovered by Stanis≈Çaw Ulam (1963).</p>
<canvas id="culam" width="800" height="800"></canvas><div class="al" id="alulam"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('ulamLiveStats','Ulam_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="ulamLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Diagonal Prime Density</h3><div class="pc" id="pulamDiag"></div></div>
<div class="viz"><h3>Prime Gaps in Spiral</h3><div class="pc" id="pulamGaps"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,150,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Ulam Spiral & Prime Patterns</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Ulam spiral arranges positive integers in a square spiral, starting from 1 at the center. When primes are highlighted, striking diagonal patterns emerge. Discovered by Stanis≈Çaw Ulam in 1963 while doodling during a boring meeting! The diagonals correspond to quadratic polynomials n¬≤ + n + 41 (Euler's prime-rich polynomial) and similar forms.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Quadratic Polynomials):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Diagonals in the Ulam spiral represent quadratic sequences 4n¬≤ + bn + c. Some produce many primes: Euler's n¬≤ + n + 41 gives primes for n = 0 to 39. The diagonal density depends on the discriminant b¬≤ - 16c. Hardy-Littlewood conjecture predicts asymptotic prime density for each polynomial.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Spiral: 1 ‚Üí 2 ‚Üí 3 ‚Üí ... counterclockwise &nbsp;&nbsp;|&nbsp;&nbsp; Diagonals: 4n¬≤ + bn + c &nbsp;&nbsp;|&nbsp;&nbsp; Euler: n¬≤ + n + 41
</div>
</div>
</div>

<div id="tsacks" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n <span class="tip" title="Highest integer to plot">?</span></label><div class="sig"><input type="range" id="sacksN" min="1000" max="100000" value="10000" oninput="document.getElementById('sacksNv').value=this.value;drawSacks()"><input type="number" id="sacksNv" value="10000" min="100" max="500000" onkeydown="if(event.key==='Enter')drawSacks()"></div></div>
<div class="cg"><label>Highlight</label><select id="sacksHL" onchange="drawSacks()">
<option value="primes">Primes Only</option>
<option value="all">All Integers</option>
<option value="twin">Twin Primes</option>
<option value="squares">Perfect Squares</option>
<option value="triangular">Triangular Numbers</option>
</select></div>
<div class="cg"><label>Color Mode</label><select id="sacksCol" onchange="drawSacks()">
<option value="classic">Classic White</option>
<option value="rainbow">Rainbow by n</option>
<option value="density">Local Density</option>
<option value="gap">Gap to Next Prime</option>
</select></div>
<div class="cg"><label>Point Size</label><input type="range" id="sacksPtSz" min="0.5" max="5" value="1.5" step="0.5" onchange="drawSacks()"></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="sacksShowArcs" onchange="drawSacks()"> Parabolic Arcs</label>
<label><input type="checkbox" id="sacksShowGrid" onchange="drawSacks()"> Radial Grid</label>
</div></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('sacksNv').value=5000;drawSacks()">5K</button>
<button onclick="document.getElementById('sacksNv').value=10000;drawSacks()">10K</button>
<button onclick="document.getElementById('sacksNv').value=50000;drawSacks()">50K</button>
<button onclick="document.getElementById('sacksNv').value=100000;drawSacks()">100K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawSacks()">Generate</button><button onclick="screenshotSacks()">Screenshot</button><button onclick="exportAllSacks()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvSacks()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Sacks Spiral ‚Äî Primes on ‚àön Archimedean Spiral</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Each integer n at angle Œ∏ = 2œÄ‚àön, radius r = ‚àön. Primes form curved arms. Click for details.</p>
<canvas id="csacks" width="800" height="800"></canvas><div class="al" id="alsacks"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('sacksLiveStats','Sacks_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="sacksLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Angular Distribution</h3><div class="pc" id="psacksAngle"></div></div>
<div class="viz"><h3>Radial Prime Density</h3><div class="pc" id="psacksRadial"></div></div>
</div>
<div style="padding:1rem;background:rgba(150,255,200,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Sacks Spiral & Prime Curves</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Sacks spiral (Robert Sacks, 1994) places integer n at polar coordinates (‚àön, 2œÄ‚àön). Perfect squares lie on the positive x-axis. Primes cluster along curved arms corresponding to quadratic polynomials. Unlike Ulam's square spiral, the Sacks spiral reveals smooth parabolic curves through prime-rich sequences.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Parabolic Arms):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Each parabolic arm in the Sacks spiral corresponds to a quadratic polynomial an¬≤ + bn + c. Primes from n¬≤ + n + 41 form a distinct curve. The visual clustering reveals that primes are not random but follow patterns encoded in quadratic residues modulo small primes. Twin primes appear as nearby paired curves.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Position: r = ‚àön, Œ∏ = 2œÄ‚àön &nbsp;&nbsp;|&nbsp;&nbsp; Squares on x-axis &nbsp;&nbsp;|&nbsp;&nbsp; Arms: an¬≤ + bn + c
</div>
</div>
</div>

<div id="thardy" class="tab">
<div class="ctrl">
<div class="cg"><label>t Range <span class="tip" title="Imaginary part of s = ¬Ω + it">?</span></label><div class="sig"><input type="range" id="hardyT" min="10" max="200" value="50" oninput="document.getElementById('hardyTv').value=this.value;drawHardy()"><input type="number" id="hardyTv" value="50" min="1" max="1000" onkeydown="if(event.key==='Enter')drawHardy()"></div></div>
<div class="cg"><label>Resolution</label><div class="sig"><input type="range" id="hardyRes" min="500" max="5000" value="2000" step="100" oninput="document.getElementById('hardyResv').value=this.value;drawHardy()"><input type="number" id="hardyResv" value="2000" min="100" max="10000" onchange="drawHardy()"></div></div>
<div class="cg"><label>Visualization</label><select id="hardyViz" onchange="drawHardy()">
<option value="zt">Z(t) Function</option>
<option value="envelope">|Z(t)| Envelope</option>
<option value="zeros">Zero Crossings</option>
<option value="theta">Œ∏(t) Phase</option>
</select></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="hardyShowZeros" checked onchange="drawHardy()"> Mark Zeros</label>
<label><input type="checkbox" id="hardyShowGram" onchange="drawHardy()"> Gram Points</label>
<label><input type="checkbox" id="hardyShowEnv" onchange="drawHardy()"> ¬±t^{1/4} Bound</label>
</div></div>
<div class="cg"><label>Start t</label><input type="number" id="hardyStart" value="0" min="0" max="900" step="10" onchange="drawHardy()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('hardyTv').value=30;document.getElementById('hardyStart').value=0;drawHardy()">First Zeros</button>
<button onclick="document.getElementById('hardyTv').value=50;document.getElementById('hardyStart').value=0;drawHardy()">t‚â§50</button>
<button onclick="document.getElementById('hardyTv').value=100;document.getElementById('hardyStart').value=0;drawHardy()">t‚â§100</button>
<button onclick="document.getElementById('hardyTv').value=50;document.getElementById('hardyStart').value=100;drawHardy()">100-150</button>
</div></div>
</div>
<div class="bg"><button onclick="drawHardy()">Compute</button><button onclick="screenshotHardy()">Screenshot</button><button onclick="exportAllHardy()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvHardy()">Export CSV</button><button class="s" onclick="screenshotCanvas('chardy','Hardy Z(t)','hardy_canvas.png')">Canvas</button><button class="s" onclick="screenshotChart('phardyZeros','Zero Locations','hardy_zeros.png')">Zeros</button><button class="s" onclick="screenshotStats('hardyLiveStats','Hardy Z(t)','hardy_stats.png')">Stats</button></div>
<div class="g2">
<div class="viz"><h3>Hardy Z-Function: Z(t) = e^{iŒ∏(t)}Œ∂(¬Ω+it)</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Z(t) is real! Sign changes = zeros on critical line. RH: ALL nontrivial zeros are sign changes of Z(t).</p>
<canvas id="chardy" width="800" height="500"></canvas><div class="al" id="alhardy"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('hardyLiveStats','Hardy_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="hardyLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Zero Distribution</h3><div class="pc" id="phardyZeros"></div></div>
<div class="viz"><h3>|Z(t)| Growth</h3><div class="pc" id="phardyGrowth"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,100,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Hardy Z-Function & Critical Line Zeros</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Hardy Z-function Z(t) = e^{iŒ∏(t)}Œ∂(¬Ω+it) where Œ∏(t) is the Riemann-Siegel theta function. The key property: Z(t) is REAL for real t! This means zeros of Œ∂(s) on the critical line Re(s)=¬Ω appear as sign changes of Z(t). Hardy (1914) used this to prove infinitely many zeros lie on the critical line.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (RH Equivalence):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The Riemann Hypothesis states that ALL nontrivial zeros of Œ∂(s) have Re(s)=¬Ω. Equivalently: every zero appears as a sign change of Z(t). The first zeros occur at t ‚âà 14.135, 21.022, 25.011, 30.425, 32.935... Over 10 trillion zeros verified on critical line!
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Z(t) = e^{iŒ∏(t)}Œ∂(¬Ω+it) ‚àà ‚Ñù &nbsp;&nbsp;|&nbsp;&nbsp; Œ∏(t) = arg(Œì(¬º+it/2)) - (t/2)log œÄ &nbsp;&nbsp;|&nbsp;&nbsp; Z(Œ≥‚Çô) = 0
</div>
</div>
</div>

<div id="tgram" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n <span class="tip" title="Number of Gram points">?</span></label><div class="sig"><input type="range" id="gramN" min="10" max="500" value="100" oninput="document.getElementById('gramNv').value=this.value;drawGram()"><input type="number" id="gramNv" value="100" min="5" max="2000" onkeydown="if(event.key==='Enter')drawGram()"></div></div>
<div class="cg"><label>Visualization</label><select id="gramViz" onchange="drawGram()">
<option value="grampoints">Gram Points g_n</option>
<option value="theta">Œ∏(t) Function</option>
<option value="intervals">Gram Intervals</option>
<option value="violations">Gram's Law Violations</option>
</select></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="gramShowZeros" checked onchange="drawGram()"> Zeta Zeros</label>
<label><input type="checkbox" id="gramShowLaw" checked onchange="drawGram()"> Gram's Law</label>
<label><input type="checkbox" id="gramShowBlocks" onchange="drawGram()"> Gram Blocks</label>
</div></div>
<div class="cg"><label>Start Index</label><input type="number" id="gramStart" value="-1" min="-1" max="1000" onchange="drawGram()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('gramNv').value=50;document.getElementById('gramStart').value=-1;drawGram()">First 50</button>
<button onclick="document.getElementById('gramNv').value=100;drawGram()">First 100</button>
<button onclick="document.getElementById('gramNv').value=200;drawGram()">First 200</button>
<button onclick="document.getElementById('gramStart').value=126;document.getElementById('gramNv').value=20;drawGram()">Lehmer (126)</button>
</div></div>
</div>
<div class="bg"><button onclick="drawGram()">Compute</button><button onclick="screenshotGram()">Screenshot</button><button onclick="exportAllGram()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvGram()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Gram Points: Œ∏(g_n) = nœÄ</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Gram points organize zero counting. Gram's Law: usually one zero per Gram interval. Violations are rare but important.</p>
<canvas id="cgram" width="800" height="500"></canvas><div class="al" id="algram"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('gramLiveStats','Gram_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="gramLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Gram Point Spacing</h3><div class="pc" id="pgramSpace"></div></div>
<div class="viz"><h3>Zeros per Gram Interval</h3><div class="pc" id="pgramCount"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,200,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Gram Points & Zero Organization</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Gram points g_n are defined by Œ∏(g_n) = nœÄ where Œ∏(t) is the Riemann-Siegel theta function. They provide a natural grid for locating zeros. At Gram points, Z(g_n) = (-1)‚Åø|Œ∂(¬Ω+ig_n)|, so the sign of Z alternates IF there's exactly one zero per interval. The first Gram point g‚ÇÄ ‚âà 17.845.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Gram's Law):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Gram's Law states (-1)‚ÅøZ(g_n) > 0, equivalent to exactly one zero in [g_{n-1}, g_n]. It holds ~73% of the time asymptotically. Violations occur in "Gram blocks" where zeros cluster. The famous Lehmer pair near g‚ÇÅ‚ÇÇ‚ÇÜ shows two very close zeros, almost violating RH!
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Œ∏(g_n) = nœÄ &nbsp;&nbsp;|&nbsp;&nbsp; g_n ‚âà 2œÄn/W(n/e) &nbsp;&nbsp;|&nbsp;&nbsp; Gram's Law: (-1)‚ÅøZ(g_n) > 0
</div>
</div>
</div>

<div id="texplicit" class="tab">
<div class="ctrl">
<div class="cg"><label>Max x <span class="tip" title="Upper bound for œÄ(x)">?</span></label><div class="sig"><input type="range" id="explicitX" min="100" max="10000" value="1000" oninput="document.getElementById('explicitXv').value=this.value;drawExplicit()"><input type="number" id="explicitXv" value="1000" min="10" max="100000" onkeydown="if(event.key==='Enter')drawExplicit()"></div></div>
<div class="cg"><label>Number of Zeros</label><div class="sig"><input type="range" id="explicitZeros" min="0" max="100" value="20" oninput="document.getElementById('explicitZerosv').value=this.value;drawExplicit()"><input type="number" id="explicitZerosv" value="20" min="0" max="500" onchange="drawExplicit()"></div></div>
<div class="cg"><label>Visualization</label><select id="explicitViz" onchange="drawExplicit()">
<option value="buildup">Build œÄ(x) from Zeros</option>
<option value="error">Error Analysis</option>
<option value="oscillations">Zero Oscillations</option>
<option value="cumulative">Cumulative Effect</option>
</select></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="explicitShowPi" checked onchange="drawExplicit()"> Actual œÄ(x)</label>
<label><input type="checkbox" id="explicitShowLi" checked onchange="drawExplicit()"> Li(x)</label>
<label><input type="checkbox" id="explicitShowSum" checked onchange="drawExplicit()"> Zero Sum</label>
</div></div>
<div class="cg"><label>Animation</label><div style="display:flex;gap:.3rem">
<button onclick="animateExplicit()">‚ñ∂ Animate</button>
<button onclick="stopExplicitAnim()">‚èπ Stop</button>
</div></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('explicitXv').value=100;document.getElementById('explicitZerosv').value=5;drawExplicit()">Small</button>
<button onclick="document.getElementById('explicitXv').value=1000;document.getElementById('explicitZerosv').value=20;drawExplicit()">Medium</button>
<button onclick="document.getElementById('explicitXv').value=5000;document.getElementById('explicitZerosv').value=50;drawExplicit()">Large</button>
</div></div>
</div>
<div class="bg"><button onclick="drawExplicit()">Compute</button><button onclick="screenshotExplicit()">Screenshot</button><button onclick="exportAllExplicit()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvExplicit()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Explicit Formula: œÄ(x) = Li(x) - Œ£_œÅ Li(x^œÅ) - ...</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Watch how adding zeros reconstructs œÄ(x)! Each zero œÅ contributes an oscillating term.</p>
<canvas id="cexplicit" width="800" height="500"></canvas><div class="al" id="alexplicit"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('explicitLiveStats','Explicit_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="explicitLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Individual Zero Contributions</h3><div class="pc" id="pexplicitContrib"></div></div>
<div class="viz"><h3>Error: œÄ(x) - Approximation</h3><div class="pc" id="pexplicitError"></div></div>
</div>
<div style="padding:1rem;background:rgba(150,255,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Riemann's Explicit Formula</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Riemann's explicit formula expresses œÄ(x) exactly in terms of Li(x) and contributions from each zeta zero: œÄ(x) = Li(x) - Œ£_œÅ Li(x^œÅ) - log(2) + ‚à´_x^‚àû dt/(t(t¬≤-1)log t). Each zero œÅ = ¬Ω + iŒ≥ contributes an oscillating term Li(x^œÅ) ‚âà -x^{¬Ω}cos(Œ≥ log x)/(Œ≥ log x). More zeros = more accurate approximation!
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Zeros Control Primes):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
This formula proves that zeta zeros DIRECTLY control prime distribution! If RH holds (all Re(œÅ)=¬Ω), each term decays like x^¬Ω, giving œÄ(x) = Li(x) + O(‚àöx log x). Zeros off the critical line would create larger oscillations. The formula is the mathematical proof that understanding zeros = understanding primes.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œÄ(x) = Li(x) - Œ£_œÅ Li(x^œÅ) - log(2) + ... &nbsp;&nbsp;|&nbsp;&nbsp; Li(x^œÅ) oscillates like x^{Re(œÅ)}
</div>
</div>
</div>

<div id="tzerocount" class="tab">
<div class="ctrl">
<div class="cg"><label>Max T <span class="tip" title="Height on critical line">?</span></label><div class="sig"><input type="range" id="zcountT" min="20" max="500" value="100" oninput="document.getElementById('zcountTv').value=this.value;drawZeroCount()"><input type="number" id="zcountTv" value="100" min="10" max="2000" onkeydown="if(event.key==='Enter')drawZeroCount()"></div></div>
<div class="cg"><label>Visualization</label><select id="zcountViz" onchange="drawZeroCount()">
<option value="count">N(T) vs T</option>
<option value="compare">N(T) vs Approximation</option>
<option value="error">Error S(T)</option>
<option value="stairs">Staircase Plot</option>
</select></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="zcountShowApprox" checked onchange="drawZeroCount()"> Riemann-von Mangoldt</label>
<label><input type="checkbox" id="zcountShowZeros" checked onchange="drawZeroCount()"> Mark Zeros</label>
</div></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('zcountTv').value=50;drawZeroCount()">T‚â§50</button>
<button onclick="document.getElementById('zcountTv').value=100;drawZeroCount()">T‚â§100</button>
<button onclick="document.getElementById('zcountTv').value=200;drawZeroCount()">T‚â§200</button>
</div></div>
</div>
<div class="bg"><button onclick="drawZeroCount()">Compute</button><button onclick="screenshotZeroCount()">Screenshot</button><button onclick="exportAllZcount()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvZeroCount()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Zero Counting: N(T) = #{œÅ : 0 < Im(œÅ) < T}</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Count of zeros with imaginary part less than T. Riemann-von Mangoldt: N(T) ~ (T/2œÄ)log(T/2œÄe).</p>
<canvas id="czerocount" width="800" height="500"></canvas><div class="al" id="alzerocount"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('zcountLiveStats','ZeroCount_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="zcountLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>N(T) Growth Rate</h3><div class="pc" id="pzcountGrowth"></div></div>
<div class="viz"><h3>S(T) = N(T) - ‚ü®N(T)‚ü©</h3><div class="pc" id="pzcountS"></div></div>
</div>
<div style="padding:1rem;background:rgba(200,100,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Zero Counting Function N(T)</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
N(T) counts zeros œÅ of Œ∂(s) with 0 < Im(œÅ) < T. The Riemann-von Mangoldt formula gives N(T) = (T/2œÄ)log(T/2œÄe) + O(log T). More precisely, N(T) = (1/œÄ)Œ∏(T) + 1 + S(T), where S(T) = (1/œÄ)arg Œ∂(¬Ω+iT) is the "error" term.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (RH Connection):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
RH implies S(T) = O(log T / log log T), much smaller than the unconditional O(log T). The oscillations in S(T) encode deep information about zero spacing. Large values of |S(T)| correspond to unusual zero distributions.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
N(T) = (T/2œÄ)log(T/2œÄe) + O(log T) &nbsp;&nbsp;|&nbsp;&nbsp; S(T) = N(T) - ‚ü®N(T)‚ü© &nbsp;&nbsp;|&nbsp;&nbsp; RH ‚üπ S(T) small
</div>
</div>
</div>

<div id="targand" class="tab">
<div class="ctrl">
<div class="cg"><label>œÉ Range <span class="tip" title="Real part range">?</span></label><div style="display:flex;gap:.3rem"><input type="number" id="argandS1" value="-2" step="0.5" style="width:60px" onchange="drawArgand()"><span>to</span><input type="number" id="argandS2" value="4" step="0.5" style="width:60px" onchange="drawArgand()"></div></div>
<div class="cg"><label>t Range <span class="tip" title="Imaginary part range">?</span></label><div style="display:flex;gap:.3rem"><input type="number" id="argandT1" value="-30" step="5" style="width:60px" onchange="drawArgand()"><span>to</span><input type="number" id="argandT2" value="30" step="5" style="width:60px" onchange="drawArgand()"></div></div>
<div class="cg"><label>Resolution</label><input type="range" id="argandRes" min="50" max="300" value="150" onchange="drawArgand()"></div>
<div class="cg"><label>Color Mode</label><select id="argandCol" onchange="drawArgand()">
<option value="phase">Phase (Argument)</option>
<option value="modulus">Modulus |Œ∂(s)|</option>
<option value="logmod">Log |Œ∂(s)|</option>
<option value="real">Re(Œ∂(s))</option>
<option value="imag">Im(Œ∂(s))</option>
</select></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="argandShowCrit" checked onchange="drawArgand()"> Critical Line</label>
<label><input type="checkbox" id="argandShowZeros" checked onchange="drawArgand()"> Zeros</label>
<label><input type="checkbox" id="argandShowPole" checked onchange="drawArgand()"> Pole at s=1</label>
</div></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('argandS1').value=-2;document.getElementById('argandS2').value=4;document.getElementById('argandT1').value=-30;document.getElementById('argandT2').value=30;drawArgand()">Standard</button>
<button onclick="document.getElementById('argandS1').value=0;document.getElementById('argandS2').value=1;document.getElementById('argandT1').value=10;document.getElementById('argandT2').value=30;drawArgand()">First Zeros</button>
<button onclick="document.getElementById('argandS1').value=-4;document.getElementById('argandS2').value=2;document.getElementById('argandT1').value=-5;document.getElementById('argandT2').value=5;drawArgand()">Wide View</button>
</div></div>
</div>
<div class="bg"><button onclick="drawArgand()">Compute</button><button onclick="screenshotArgand()">Screenshot</button><button onclick="exportAllArgand()" style="background:#1a472a">üì¶ All</button></div>
<div class="g2">
<div class="viz"><h3>Œ∂(s) Domain Coloring ‚Äî Complex Plane Visualization</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Phase portrait of Œ∂(s). Zeros appear as color wheel centers. Critical line Re(s)=¬Ω shown.</p>
<canvas id="cargand" width="700" height="700"></canvas><div class="al" id="alargand"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('argandLiveStats','Argand_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="argandLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Domain Coloring & Zeta Visualization</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Domain coloring represents complex functions by mapping output to color: phase (argument) ‚Üí hue, modulus ‚Üí brightness. For Œ∂(s), zeros appear as points where all colors meet (full color wheel), and the pole at s=1 shows as a bright singularity. The critical strip 0 < Re(s) < 1 contains all nontrivial zeros.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Visual RH):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
RH states all nontrivial zeros lie on Re(s)=¬Ω. In domain coloring, this means all color-wheel centers (zeros) in the critical strip should align vertically on the critical line. The trivial zeros at s=-2,-4,-6,... are visible on the negative real axis.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Color: arg(Œ∂(s)) ‚Üí Hue &nbsp;&nbsp;|&nbsp;&nbsp; Zeros: full color wheel &nbsp;&nbsp;|&nbsp;&nbsp; RH: zeros on Re(s)=¬Ω
</div>
</div>
</div>

<div id="tzetareal" class="tab">
<div class="ctrl">
<div class="cg"><label>s Range <span class="tip" title="Real axis range">?</span></label><div style="display:flex;gap:.3rem"><input type="number" id="zetarealS1" value="-10" step="1" style="width:60px" onchange="drawZetaReal()"><span>to</span><input type="number" id="zetarealS2" value="10" step="1" style="width:60px" onchange="drawZetaReal()"></div></div>
<div class="cg"><label>Resolution</label><input type="range" id="zetarealRes" min="200" max="2000" value="1000" onchange="drawZetaReal()"></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="zetarealShowPole" checked onchange="drawZetaReal()"> Pole at s=1</label>
<label><input type="checkbox" id="zetarealShowTrivial" checked onchange="drawZetaReal()"> Trivial Zeros</label>
<label><input type="checkbox" id="zetarealShowSpecial" checked onchange="drawZetaReal()"> Special Values</label>
</div></div>
<div class="cg"><label>Y Clamp</label><input type="range" id="zetarealYclamp" min="2" max="20" value="5" onchange="drawZetaReal()"></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('zetarealS1').value=-10;document.getElementById('zetarealS2').value=10;drawZetaReal()">Full Range</button>
<button onclick="document.getElementById('zetarealS1').value=1.01;document.getElementById('zetarealS2').value=5;drawZetaReal()">Positive Only</button>
<button onclick="document.getElementById('zetarealS1').value=-8;document.getElementById('zetarealS2').value=0;drawZetaReal()">Negative Only</button>
</div></div>
</div>
<div class="bg"><button onclick="drawZetaReal()">Compute</button><button onclick="screenshotZetaReal()">Screenshot</button><button onclick="exportAllZetareal()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvZetaReal()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Œ∂(s) on Real Axis ‚Äî From Basel to Trivial Zeros</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Zeta on real line: pole at s=1, special values Œ∂(2)=œÄ¬≤/6, trivial zeros at s=-2,-4,-6,...</p>
<canvas id="czetareal" width="800" height="500"></canvas><div class="al" id="alzetareal"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('zetarealLiveStats','ZetaReal_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="zetarealLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div class="g2">
<div class="viz"><h3>Special Values Œ∂(n)</h3><div class="pc" id="pzetarealSpecial"></div></div>
<div class="viz"><h3>Œ∂(s) Near Pole</h3><div class="pc" id="pzetarealPole"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,255,200,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Riemann Zeta on Real Axis</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
On the real axis, Œ∂(s) reveals its fundamental structure: a simple pole at s=1 with residue 1, the Basel problem Œ∂(2)=œÄ¬≤/6, Ap√©ry's constant Œ∂(3)‚âà1.202, and trivial zeros at negative even integers s=-2,-4,-6,... from the functional equation. For s>1, Œ∂(s) = Œ£n^{-s} converges absolutely.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Functional Equation):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The functional equation Œ∂(s) = 2À¢œÄ^{s-1}sin(œÄs/2)Œì(1-s)Œ∂(1-s) connects values at s and 1-s. This explains why Œ∂(-2n)=0 (trivial zeros) and gives Œ∂(0)=-¬Ω, Œ∂(-1)=-1/12 (Ramanujan summation!).
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Œ∂(2)=œÄ¬≤/6 &nbsp;|&nbsp; Œ∂(4)=œÄ‚Å¥/90 &nbsp;|&nbsp; Œ∂(-2n)=0 &nbsp;|&nbsp; Œ∂(0)=-¬Ω &nbsp;|&nbsp; Œ∂(-1)=-1/12
</div>
</div>
</div>

<div id="tmontgomery" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Zeros <span class="tip" title="Number of zeros to analyze">?</span></label><div class="sig"><input type="range" id="montN" min="10" max="80" value="50" oninput="document.getElementById('montNv').value=this.value;drawMontgomery()"><input type="number" id="montNv" value="50" min="5" max="80" onkeydown="if(event.key==='Enter')drawMontgomery()"></div></div>
<div class="cg"><label>Bin Width <span class="tip" title="Histogram bin width">?</span></label><div class="sig"><input type="range" id="montBin" min="0.05" max="0.5" step="0.05" value="0.1" oninput="drawMontgomery()"><span id="montBinV" style="color:var(--txt2)">0.1</span></div></div>
<div class="cg"><label>View Mode</label><select id="montMode" onchange="drawMontgomery()">
<option value="histogram">Pair Correlation Histogram</option>
<option value="scatter">Zero Spacing Scatter</option>
<option value="cumulative">Cumulative Distribution</option>
</select></div>
<div class="cg"><label>Show GUE Prediction</label><input type="checkbox" id="montGUE" checked onchange="drawMontgomery()"></div>
</div>
<div class="bg"><button onclick="drawMontgomery()">Compute</button><button onclick="screenshotMontgomery()">Screenshot</button><button onclick="exportAllMont()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvMontgomery()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Montgomery Pair Correlation ‚Äî Zero Spacing Statistics</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Distribution of normalized gaps between consecutive zeros of Œ∂(s).</p>
<canvas id="cmontgomery" width="800" height="500"></canvas><div class="al" id="almontgomery"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('montLiveStats','Montgomery_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="montLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Montgomery Pair Correlation Conjecture</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Hugh Montgomery (1973) discovered that the pair correlation of zeros of Œ∂(s) matches the eigenvalue statistics of random Hermitian matrices from the Gaussian Unitary Ensemble (GUE). The pair correlation function R‚ÇÇ(x) = 1 - (sin(œÄx)/(œÄx))¬≤ describes how zeros "repel" each other.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Insight (Dyson's Connection):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Freeman Dyson recognized Montgomery's result matched random matrix theory. This suggests deep connections between quantum chaos, nuclear physics (energy levels), and prime numbers. The zeros behave like eigenvalues of a random Hamiltonian!
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
R‚ÇÇ(x) = 1 - (sin(œÄx)/(œÄx))¬≤ &nbsp;&nbsp;|&nbsp;&nbsp; Zeros repel: P(gap‚Üí0) ‚Üí 0
</div>
</div>
</div>

<div id="tgue" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Zeros <span class="tip" title="Number of zeros to analyze">?</span></label><div class="sig"><input type="range" id="gueN" min="10" max="80" value="50" oninput="document.getElementById('gueNv').value=this.value;drawGUE()"><input type="number" id="gueNv" value="50" min="5" max="80" onkeydown="if(event.key==='Enter')drawGUE()"></div></div>
<div class="cg"><label>View Mode</label><select id="gueMode" onchange="drawGUE()">
<option value="spacing">Nearest Neighbor Spacing</option>
<option value="unfolded">Unfolded Zeros</option>
<option value="wigner">Wigner vs Poisson</option>
</select></div>
<div class="cg"><label>Show Wigner Surmise</label><input type="checkbox" id="gueWigner" checked onchange="drawGUE()"></div>
<div class="cg"><label>Show Poisson</label><input type="checkbox" id="guePoisson" checked onchange="drawGUE()"></div>
</div>
<div class="bg"><button onclick="drawGUE()">Compute</button><button onclick="screenshotGUE()">Screenshot</button><button onclick="exportAllGUE()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvGUE()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>GUE Random Matrix Statistics</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Nearest neighbor spacing distribution compared to random matrix predictions.</p>
<canvas id="cgue" width="800" height="500"></canvas><div class="al" id="algue"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('gueLiveStats','GUE_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="gueLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Random Matrix Theory & Zeta Zeros</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Wigner Surmise:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
For GUE matrices, Wigner derived the nearest neighbor spacing distribution: P(s) = (32/œÄ¬≤)s¬≤ exp(-4s¬≤/œÄ). This shows level repulsion ‚Äî small spacings are suppressed. Zeta zeros follow this remarkably well!
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #ff6496">
<strong style="color:#ff6496">Poisson (Random) vs GUE:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Random (uncorrelated) levels have Poisson spacing: P(s) = exp(-s). This has maximum at s=0, meaning small gaps are most likely. GUE zeros are anti-correlated, with P(0)=0. Zeta zeros behave like GUE, not Poisson!
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
Wigner: P(s) = (32/œÄ¬≤)s¬≤e^{-4s¬≤/œÄ} &nbsp;|&nbsp; Poisson: P(s) = e^{-s}
</div>
</div>
</div>

<div id="tprimerace" class="tab">
<div class="ctrl">
<div class="cg"><label>Max x <span class="tip" title="Count primes up to x">?</span></label><div class="sig"><input type="range" id="raceX" min="100" max="100000" step="100" value="10000" oninput="document.getElementById('raceXv').value=this.value"><input type="number" id="raceXv" value="10000" min="100" max="1000000" onkeydown="if(event.key==='Enter')drawPrimeRace()"></div></div>
<div class="cg"><label>Modulus q</label><select id="raceQ" onchange="drawPrimeRace()">
<option value="4">mod 4: 1 vs 3</option>
<option value="3">mod 3: 1 vs 2</option>
<option value="8">mod 8: 1,3,5,7</option>
<option value="5">mod 5: 1,2,3,4</option>
<option value="6">mod 6: 1 vs 5</option>
</select></div>
<div class="cg"><label>View Mode</label><select id="raceMode" onchange="drawPrimeRace()">
<option value="difference">Difference œÄ(x;q,a) - œÄ(x;q,b)</option>
<option value="ratio">Ratio œÄ(x;q,a) / œÄ(x;q,b)</option>
<option value="both">Both Counts</option>
</select></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('raceXv').value=1000;document.getElementById('raceX').value=1000;drawPrimeRace()">x=1K</button>
<button onclick="document.getElementById('raceXv').value=10000;document.getElementById('raceX').value=10000;drawPrimeRace()">x=10K</button>
<button onclick="document.getElementById('raceXv').value=100000;document.getElementById('raceX').value=100000;drawPrimeRace()">x=100K</button>
</div></div>
</div>
<div class="bg"><button onclick="drawPrimeRace()">Compute</button><button onclick="screenshotPrimeRace()">Screenshot</button><button onclick="exportAllRace()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvPrimeRace()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Prime Races ‚Äî Chebyshev Bias Visualization</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Which residue class has more primes? Track the race as x increases.</p>
<canvas id="cprimerace" width="800" height="500"></canvas><div class="al" id="alprimerace"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('raceLiveStats','PrimeRace_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="raceLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Chebyshev's Bias in Prime Races</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">The Phenomenon:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Chebyshev (1853) noticed that primes ‚â° 3 (mod 4) seem to outnumber primes ‚â° 1 (mod 4). Though both classes have density 1/2 asymptotically, non-quadratic residues "win" more often. This is the Chebyshev bias.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Rubinstein-Sarnak (1994):</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Under GRH, primes ‚â° 3 (mod 4) lead ~99.59% of the "time" (in logarithmic density). The bias connects to zeros of L-functions: L(s,œá‚ÇÑ) with œá‚ÇÑ(-1)=-1 causes the asymmetry.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œÄ(x;4,3) > œÄ(x;4,1) for ~99.59% of x &nbsp;&nbsp;|&nbsp;&nbsp; First 3‚Üí1 lead change: x = 26861
</div>
</div>
</div>

<div id="tlfunc" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus q <span class="tip" title="Character modulus">?</span></label><div class="sig"><input type="range" id="lfuncQ" min="3" max="50" value="5" oninput="document.getElementById('lfuncQv').value=this.value;drawLfunc()"><input type="number" id="lfuncQv" value="5" min="3" max="100" onkeydown="if(event.key==='Enter')drawLfunc()"></div></div>
<div class="cg"><label>s value (real part)</label><div class="sig"><input type="range" id="lfuncS" min="1.1" max="10" step="0.1" value="2" oninput="document.getElementById('lfuncSv').value=this.value;drawLfunc()"><input type="number" id="lfuncSv" value="2" min="1.01" max="20" step="0.1" onkeydown="if(event.key==='Enter')drawLfunc()"></div></div>
<div class="cg"><label>View Mode</label><select id="lfuncMode" onchange="drawLfunc()">
<option value="values">L(s,œá) Values</option>
<option value="characters">Character Table</option>
<option value="euler">Euler Product</option>
</select></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('lfuncQv').value=3;document.getElementById('lfuncQ').value=3;drawLfunc()">q=3</button>
<button onclick="document.getElementById('lfuncQv').value=4;document.getElementById('lfuncQ').value=4;drawLfunc()">q=4</button>
<button onclick="document.getElementById('lfuncQv').value=5;document.getElementById('lfuncQ').value=5;drawLfunc()">q=5</button>
<button onclick="document.getElementById('lfuncQv').value=7;document.getElementById('lfuncQ').value=7;drawLfunc()">q=7</button>
</div></div>
</div>
<div class="bg"><button onclick="drawLfunc()">Compute</button><button onclick="screenshotLfunc()">Screenshot</button><button onclick="exportAllLfunc()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvLfunc()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Dirichlet L-Functions ‚Äî L(s,œá) for mod q Characters</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Compute L(s,œá) for all Dirichlet characters œá mod q.</p>
<canvas id="clfunc" width="800" height="500"></canvas><div class="al" id="allfunc"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('lfuncLiveStats','Lfunc_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="lfuncLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Dirichlet L-Functions & Generalized RH</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Definition:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
For a Dirichlet character œá mod q: L(s,œá) = Œ£ œá(n)/nÀ¢ = ‚àè‚Çö (1-œá(p)/pÀ¢)‚Åª¬π. When œá=œá‚ÇÄ (principal), L(s,œá‚ÇÄ) = Œ∂(s)‚àè_{p|q}(1-p‚ÅªÀ¢). Non-principal L-functions are entire (no pole).
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Generalized Riemann Hypothesis:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
GRH states that ALL nontrivial zeros of ALL Dirichlet L-functions lie on Re(s)=¬Ω. This implies strong results about prime distribution in arithmetic progressions and the Chebyshev bias.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
L(s,œá) = Œ£ œá(n)/nÀ¢ = ‚àè‚Çö (1-œá(p)p‚ÅªÀ¢)‚Åª¬π &nbsp;&nbsp;|&nbsp;&nbsp; GRH: all zeros on Re(s)=¬Ω
</div>
</div>
</div>

<div id="tlfunczeros" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus q <span class="tip" title="Character modulus">?</span></label><div class="sig"><input type="range" id="lzeroQ" min="3" max="20" value="5" oninput="document.getElementById('lzeroQv').value=this.value;drawLfuncZeros()"><input type="number" id="lzeroQv" value="5" min="3" max="50" onkeydown="if(event.key==='Enter')drawLfuncZeros()"></div></div>
<div class="cg"><label>t Range <span class="tip" title="Imaginary part range">?</span></label><div class="sig"><input type="range" id="lzeroT" min="10" max="100" value="30" oninput="document.getElementById('lzeroTv').value=this.value;drawLfuncZeros()"><input type="number" id="lzeroTv" value="30" min="5" max="200" onkeydown="if(event.key==='Enter')drawLfuncZeros()"></div></div>
<div class="cg"><label>View Mode</label><select id="lzeroMode" onchange="drawLfuncZeros()">
<option value="zeros">Zero Locations</option>
<option value="argand">Domain Coloring</option>
<option value="critical">Critical Line</option>
</select></div>
<div class="cg"><label>Show All Characters</label><input type="checkbox" id="lzeroAll" checked onchange="drawLfuncZeros()"></div>
</div>
<div class="bg"><button onclick="drawLfuncZeros()">Compute</button><button onclick="screenshotLfuncZeros()">Screenshot</button><button onclick="exportAllLzero()" style="background:#1a472a">üì¶ All</button></div>
<div class="g2">
<div class="viz"><h3>L-Function Zeros ‚Äî Zeros of L(s,œá) on Critical Line</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Visualize zeros of Dirichlet L-functions. All should lie on Re(s)=¬Ω (GRH).</p>
<canvas id="clfunczeros" width="800" height="600"></canvas><div class="al" id="allfunczeros"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('lzeroLiveStats','Lfunc_Zeros_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="lzeroLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(255,200,100,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Zeros of Dirichlet L-Functions</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Zero Distribution:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Each primitive character œá mod q has its own L-function with infinitely many zeros in the critical strip. The zero-free region and zero density affect prime distribution in arithmetic progressions.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #ff6496">
<strong style="color:#ff6496">Connection to Prime Races:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
The zeros of L(s,œá) determine oscillations in œÄ(x;q,a). Low-lying zeros (small imaginary part) cause the Chebyshev bias. If a zero existed with Re(œÅ)>¬Ω, prime distribution in progressions would be badly behaved.
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
N(T,œá) ~ (T/œÄ)log(qT/2œÄe) &nbsp;&nbsp;|&nbsp;&nbsp; Each L(s,œá) has infinitely many zeros
</div>
</div>
</div>

<div id="tquantum" class="tab">
<div class="ctrl">
<div class="cg"><label>Principal n <span class="tip" title="Principal quantum number (energy level)">?</span></label><div class="sig"><input type="range" id="quantumN" min="1" max="7" value="3" oninput="document.getElementById('quantumNv').value=this.value;drawQuantum()"><input type="number" id="quantumNv" value="3" min="1" max="10" onkeydown="if(event.key==='Enter')drawQuantum()"></div></div>
<div class="cg"><label>Angular l <span class="tip" title="Angular momentum quantum number (0=s, 1=p, 2=d, 3=f)">?</span></label><div class="sig"><input type="range" id="quantumL" min="0" max="6" value="1" oninput="document.getElementById('quantumLv').value=this.value;drawQuantum()"><input type="number" id="quantumLv" value="1" min="0" max="9" onkeydown="if(event.key==='Enter')drawQuantum()"></div></div>
<div class="cg"><label>Magnetic m <span class="tip" title="Magnetic quantum number (-l to +l)">?</span></label><div class="sig"><input type="range" id="quantumM" min="-6" max="6" value="0" oninput="document.getElementById('quantumMv').value=this.value;drawQuantum()"><input type="number" id="quantumMv" value="0" min="-9" max="9" onkeydown="if(event.key==='Enter')drawQuantum()"></div></div>
<div class="cg"><label>View Mode</label><select id="quantumMode" onchange="drawQuantum()">
<option value="cloud">Probability Cloud</option>
<option value="radial">Radial Function</option>
<option value="angular">Angular Distribution</option>
<option value="cross">Cross Section</option>
<option value="all">All Orbitals (n fixed)</option>
</select></div>
<div class="cg"><label>Resolution</label><input type="range" id="quantumRes" min="20" max="100" value="50" oninput="drawQuantum()"></div>
<div class="cg"><label>Show</label><div style="display:flex;gap:.5rem;flex-wrap:wrap">
<label><input type="checkbox" id="quantumNodes" checked onchange="drawQuantum()"> Nodes</label>
<label><input type="checkbox" id="quantumAxes" checked onchange="drawQuantum()"> Axes</label>
<label><input type="checkbox" id="quantumLabels" checked onchange="drawQuantum()"> Labels</label>
</div></div>
<div class="cg"><label>Presets</label><div style="display:flex;gap:.3rem;flex-wrap:wrap">
<button onclick="document.getElementById('quantumN').value=1;document.getElementById('quantumNv').value=1;document.getElementById('quantumL').value=0;document.getElementById('quantumLv').value=0;document.getElementById('quantumM').value=0;document.getElementById('quantumMv').value=0;drawQuantum()">1s</button>
<button onclick="document.getElementById('quantumN').value=2;document.getElementById('quantumNv').value=2;document.getElementById('quantumL').value=1;document.getElementById('quantumLv').value=1;document.getElementById('quantumM').value=0;document.getElementById('quantumMv').value=0;drawQuantum()">2p</button>
<button onclick="document.getElementById('quantumN').value=3;document.getElementById('quantumNv').value=3;document.getElementById('quantumL').value=2;document.getElementById('quantumLv').value=2;document.getElementById('quantumM').value=0;document.getElementById('quantumMv').value=0;drawQuantum()">3d</button>
<button onclick="document.getElementById('quantumN').value=4;document.getElementById('quantumNv').value=4;document.getElementById('quantumL').value=3;document.getElementById('quantumLv').value=3;document.getElementById('quantumM').value=0;document.getElementById('quantumMv').value=0;drawQuantum()">4f</button>
</div></div>
</div>
<div class="bg"><button onclick="drawQuantum()">Compute</button><button onclick="screenshotQuantum()">Screenshot</button><button onclick="exportAllQuantum()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvQuantum()">Export CSV</button><button class="s" onclick="screenshotCanvas('cquantum','Quantum Orbital','quantum_canvas.png')">Canvas</button><button class="s" onclick="screenshotStats('quantumLiveStats','Quantum Orbitals','quantum_stats.png')">Stats</button></div>
<div class="g2">
<div class="viz"><h3>Quantum Orbital œà_{n,l,m} ‚Äî Hydrogen Wavefunction Visualization</h3>
<p style="color:var(--txt2);font-size:.85rem;margin-bottom:.5rem">Electron probability density |œà|¬≤ for hydrogen-like orbitals. Nodes connect to zeta zeros!</p>
<canvas id="cquantum" width="700" height="700"></canvas><div class="al" id="alquantum"></div></div>
<div class="viz"><h3>Live Statistics <button onclick="screenshotDashboard('quantumLiveStats','Quantum_Stats')" style="float:right;padding:2px 8px;font-size:.7rem;border-radius:4px;border:1px solid var(--bord);background:var(--bg2);color:var(--txt);cursor:pointer">4K</button></h3><div id="quantumLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem;font-size:.9rem"></div></div>
</div>
<div style="padding:1rem;background:rgba(100,200,255,.08);border-radius:8px;margin-top:1rem">
<h4 style="color:var(--acc);margin-bottom:.5rem">Quantum Mechanics & Number Theory Connection</h4>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid var(--acc)">
<strong style="color:#ffd700">Abstract:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Electron orbitals are described by wavefunctions œà_{n,l,m}(r,Œ∏,œÜ) = R_{nl}(r)Y_l^m(Œ∏,œÜ). The radial part R_{nl} has exactly n-l-1 nodes (zeros), mirroring how Œ∂(s) zeros control prime distribution. The angular part Y_l^m are spherical harmonics ‚Äî the same functions appearing in our higher-dimensional primitive counting!
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #00d9ff">
<strong style="color:#00d9ff">Key Analogy:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
<strong>Radial Nodes ‚Üî Zeta Zeros:</strong> Both control oscillations. R_{nl}(r) has n-l-1 zeros determining radial probability. Œ∂(s) zeros at œÅ_k control oscillations in œÄ(x). Higher n gives more nodes; higher T gives more zeta zeros.<br>
<strong>Quantization ‚Üî Coprimality:</strong> Quantum numbers (n,l,m) are discrete like lattice points. Angular momentum l¬≤ = l(l+1)ƒß¬≤ is quantized like gcd=1 constraint.
</p>
</div>
<div style="margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.15);border-radius:6px;border-left:3px solid #ff6496">
<strong style="color:#ff6496">Spherical Harmonics:</strong>
<p style="color:var(--txt2);font-size:.85rem;margin-top:.5rem;line-height:1.6">
Y_l^m(Œ∏,œÜ) = N_{lm} P_l^m(cos Œ∏) e^{imœÜ} where P_l^m are associated Legendre polynomials. These are eigenfunctions of angular momentum operators, forming an orthonormal basis on the sphere ‚Äî exactly what we use to analyze primitive lattice points in k dimensions via the k-ball volume formula!
</p>
</div>
<div class="fm" style="margin:.5rem 0;padding:.75rem;background:var(--bg1);border-radius:6px;text-align:center;font-size:1.1rem">
œà_{nlm} = R_{nl}(r)Y_l^m(Œ∏,œÜ) &nbsp;&nbsp;|&nbsp;&nbsp; Radial nodes: n-l-1 &nbsp;&nbsp;|&nbsp;&nbsp; Angular nodes: l
</div>
</div>
</div>

<!-- PRIME K-TUPLES TAB -->
<div id="tktuples" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N</label><div class="sig"><input type="range" id="ktupleN" min="100" max="100000" step="100" value="10000" oninput="document.getElementById('ktupleNv').value=this.value"><input type="number" id="ktupleNv" value="10000" min="10" max="1000000" onkeydown="if(event.key==='Enter')drawKtuples()"></div></div>
<div class="cg"><label>Tuple Type</label><select id="ktupleType" onchange="drawKtuples()">
<option value="twin">Twins (p, p+2)</option>
<option value="cousin">Cousins (p, p+4)</option>
<option value="sexy">Sexy (p, p+6)</option>
<option value="triplet">Triplets (p, p+2, p+6)</option>
<option value="quadruplet">Quadruplets</option>
<option value="quintuplet">Quintuplets</option>
<option value="sextuplet">Sextuplets</option>
</select></div>
</div>
<div class="bg"><button onclick="drawKtuples()">Analyze</button><button onclick="screenshotKtuples()">Screenshot</button><button onclick="exportAllKtuples()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvKtuples()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Prime k-Tuples Distribution</h3><canvas id="cktuples" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="ktuplesLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Tuple Density</h3><div id="pktuples1" style="height:280px"></div></div>
</div>

<!-- CARMICHAEL TAB -->
<div id="tcarmichael" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N</label><div class="sig"><input type="range" id="carmN" min="1000" max="1000000" step="1000" value="100000" oninput="document.getElementById('carmNv').value=this.value"><input type="number" id="carmNv" value="100000" min="100" max="10000000" onkeydown="if(event.key==='Enter')drawCarmichael()"></div></div>
<div class="cg"><label>Test Base a</label><input type="number" id="carmBase" value="2" min="2" max="100"></div>
</div>
<div class="bg"><button onclick="drawCarmichael()">Find Carmichaels</button><button onclick="screenshotCarmichael()">Screenshot</button><button onclick="exportAllCarmichael()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCarmichael()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Carmichael Numbers (Pseudoprimes)</h3><canvas id="ccarm" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="carmLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Growth Rate</h3><div id="pcarm1" style="height:280px"></div></div>
</div>

<!-- MERSENNE TAB -->
<div id="tmersenne" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Exponent p</label><div class="sig"><input type="range" id="mersP" min="10" max="1000" value="100" oninput="document.getElementById('mersPv').value=this.value"><input type="number" id="mersPv" value="100" min="2" max="10000" onkeydown="if(event.key==='Enter')drawMersenne()"></div></div>
<div class="cg"><label>Show</label><select id="mersMode" onchange="drawMersenne()">
<option value="all">All 2^p - 1</option>
<option value="prime">Mersenne Primes Only</option>
<option value="factors">With Factorizations</option>
</select></div>
</div>
<div class="bg"><button onclick="drawMersenne()">Compute</button><button onclick="screenshotMersenne()">Screenshot</button><button onclick="exportAllMersenne()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvMersenne()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Mersenne Numbers 2^p - 1</h3><canvas id="cmers" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="mersLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Known Mersenne Primes</h3><div id="pmers1" style="height:280px"></div></div>
</div>

<!-- CONTINUED FRACTIONS TAB -->
<div id="tcontinued" class="tab">
<div class="ctrl">
<div class="cg"><label>Number</label><select id="cfNum" onchange="drawContinued()">
<option value="pi">œÄ</option>
<option value="e">e</option>
<option value="phi">(1+‚àö5)/2 Golden</option>
<option value="sqrt2">‚àö2</option>
<option value="sqrt3">‚àö3</option>
<option value="custom">Custom</option>
</select></div>
<div class="cg"><label>Custom Value</label><input type="number" id="cfCustom" value="3.14159" step="0.0001" onchange="document.getElementById('cfNum').value='custom';drawContinued()"></div>
<div class="cg"><label>Terms</label><input type="range" id="cfTerms" min="5" max="50" value="20" oninput="drawContinued()"></div>
</div>
<div class="bg"><button onclick="drawContinued()">Compute</button><button onclick="screenshotContinued()">Screenshot</button><button onclick="exportAllContinued()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvContinued()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Continued Fraction Expansion</h3><canvas id="ccf" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="cfLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Convergent Errors</h3><div id="pcf1" style="height:280px"></div></div>
</div>

<!-- STERN-BROCOT TAB -->
<div id="tsternbrocot" class="tab">
<div class="ctrl">
<div class="cg"><label>Depth</label><input type="range" id="sbDepth" min="3" max="10" value="6" oninput="drawSternBrocot()"></div>
<div class="cg"><label>Highlight</label><select id="sbHighlight" onchange="drawSternBrocot()">
<option value="none">None</option>
<option value="farey">Farey Connection</option>
<option value="path">Path to Fraction</option>
</select></div>
<div class="cg"><label>Target p/q</label><input type="number" id="sbP" value="3" min="1" style="width:50px">/<input type="number" id="sbQ" value="5" min="1" style="width:50px"></div>
</div>
<div class="bg"><button onclick="drawSternBrocot()">Generate</button><button onclick="screenshotSternBrocot()">Screenshot</button><button onclick="exportAllSternBrocot()" style="background:#1a472a">üì¶ All</button></div>
<div class="g2">
<div class="viz"><h3>Stern-Brocot Tree</h3><canvas id="csb" width="700" height="600"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="sbLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
</div>

<!-- PYTHAGOREAN TAB -->
<div id="tpythag" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Hypotenuse</label><div class="sig"><input type="range" id="pythC" min="10" max="1000" value="100" oninput="document.getElementById('pythCv').value=this.value;drawPythag()"><input type="number" id="pythCv" value="100" min="5" max="10000" onkeydown="if(event.key==='Enter')drawPythag()"></div></div>
<div class="cg"><label>Show</label><select id="pythMode" onchange="drawPythag()">
<option value="primitive">Primitive Only</option>
<option value="all">All Triples</option>
<option value="tree">Generation Tree</option>
</select></div>
</div>
<div class="bg"><button onclick="drawPythag()">Generate</button><button onclick="screenshotPythag()">Screenshot</button><button onclick="exportAllPythag()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvPythag()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Pythagorean Triples a¬≤ + b¬≤ = c¬≤</h3><canvas id="cpyth" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="pythLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Triple Distribution</h3><div id="ppyth1" style="height:280px"></div></div>
</div>

<!-- SUM OF SQUARES TAB -->
<div id="tsumsquares" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N</label><div class="sig"><input type="range" id="ssqN" min="10" max="500" value="100" oninput="document.getElementById('ssqNv').value=this.value;drawSumSquares()"><input type="number" id="ssqNv" value="100" min="1" max="1000" onkeydown="if(event.key==='Enter')drawSumSquares()"></div></div>
<div class="cg"><label>Squares k</label><select id="ssqK" onchange="drawSumSquares()">
<option value="2">r‚ÇÇ(n) - Two Squares</option>
<option value="3">r‚ÇÉ(n) - Three Squares</option>
<option value="4">r‚ÇÑ(n) - Four Squares</option>
</select></div>
</div>
<div class="bg"><button onclick="drawSumSquares()">Compute</button><button onclick="screenshotSumSquares()">Screenshot</button><button onclick="exportAllSumSquares()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvSumSquares()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Sum of Squares Representations</h3><canvas id="cssq" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="ssqLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>r_k(n) Distribution</h3><div id="pssq1" style="height:280px"></div></div>
</div>

<!-- QUADRATIC RESIDUES TAB -->
<div id="tquadres" class="tab">
<div class="ctrl">
<div class="cg"><label>Modulus p</label><div class="sig"><input type="range" id="qrP" min="3" max="200" value="23" oninput="document.getElementById('qrPv').value=this.value;drawQuadRes()"><input type="number" id="qrPv" value="23" min="3" max="1000" onkeydown="if(event.key==='Enter')drawQuadRes()"></div></div>
<div class="cg"><label>View</label><select id="qrMode" onchange="drawQuadRes()">
<option value="grid">Residue Grid</option>
<option value="legendre">Legendre Symbol</option>
<option value="paley">Paley Graph</option>
</select></div>
</div>
<div class="bg"><button onclick="drawQuadRes()">Compute</button><button onclick="screenshotQuadRes()">Screenshot</button><button onclick="exportAllQuadRes()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvQuadRes()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Quadratic Residues mod p</h3><canvas id="cqr" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="qrLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Legendre Symbol Pattern</h3><div id="pqr1" style="height:280px"></div></div>
</div>

<!-- PARTITIONS TAB -->
<div id="tpartition" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N</label><div class="sig"><input type="range" id="partN" min="10" max="200" value="50" oninput="document.getElementById('partNv').value=this.value"><input type="number" id="partNv" value="50" min="1" max="500" onkeydown="if(event.key==='Enter')drawPartition()"></div></div>
<div class="cg"><label>Test n</label><input type="number" id="partTest" value="10" min="1" max="100"></div>
<div class="cg"><label>View</label><select id="partMode" onchange="drawPartition()">
<option value="growth">Growth p(n)</option>
<option value="ferrers">Ferrers Diagrams</option>
<option value="congruences">Ramanujan Congruences</option>
</select></div>
</div>
<div class="bg"><button onclick="drawPartition()">Compute</button><button onclick="screenshotPartition()">Screenshot</button><button onclick="exportAllPartition()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvPartition()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Partition Function p(n)</h3><canvas id="cpart" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="partLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Partition Growth</h3><div id="ppart1" style="height:280px"></div></div>
</div>

<!-- BERNOULLI TAB -->
<div id="tbernoulli" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n</label><div class="sig"><input type="range" id="bernN" min="5" max="50" value="20" oninput="document.getElementById('bernNv').value=this.value;drawBernoulli()"><input type="number" id="bernNv" value="20" min="1" max="100" onkeydown="if(event.key==='Enter')drawBernoulli()"></div></div>
<div class="cg"><label>Show</label><select id="bernMode" onchange="drawBernoulli()">
<option value="values">B‚Çô Values</option>
<option value="zeta">Œ∂(-n) Connection</option>
<option value="sums">Power Sums</option>
</select></div>
</div>
<div class="bg"><button onclick="drawBernoulli()">Compute</button><button onclick="screenshotBernoulli()">Screenshot</button><button onclick="exportAllBernoulli()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvBernoulli()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Bernoulli Numbers B‚Çô</h3><canvas id="cbern" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="bernLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Connection to Œ∂(s)</h3><div id="pbern1" style="height:280px"></div></div>
</div>

<!-- FIBONACCI TAB -->
<div id="tfibonacci" class="tab">
<div class="ctrl">
<div class="cg"><label>Terms</label><div class="sig"><input type="range" id="fibN" min="10" max="100" value="30" oninput="document.getElementById('fibNv').value=this.value;drawFibonacci()"><input type="number" id="fibNv" value="30" min="5" max="200" onkeydown="if(event.key==='Enter')drawFibonacci()"></div></div>
<div class="cg"><label>Show</label><select id="fibMode" onchange="drawFibonacci()">
<option value="spiral">Golden Spiral</option>
<option value="ratio">œÜ Convergence</option>
<option value="zeckendorf">Zeckendorf</option>
<option value="pisano">Pisano Periods</option>
</select></div>
</div>
<div class="bg"><button onclick="drawFibonacci()">Compute</button><button onclick="screenshotFibonacci()">Screenshot</button><button onclick="exportAllFibonacci()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvFibonacci()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Fibonacci Sequence</h3><canvas id="cfib" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="fibLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Ratio Convergence to œÜ</h3><div id="pfib1" style="height:280px"></div></div>
</div>

<!-- CATALAN TAB -->
<div id="tcatalan" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n</label><div class="sig"><input type="range" id="catN" min="5" max="30" value="15" oninput="document.getElementById('catNv').value=this.value;drawCatalan()"><input type="number" id="catNv" value="15" min="1" max="50" onkeydown="if(event.key==='Enter')drawCatalan()"></div></div>
<div class="cg"><label>Visualization</label><select id="catMode" onchange="drawCatalan()">
<option value="lattice">Lattice Paths</option>
<option value="dyck">Dyck Paths</option>
<option value="trees">Binary Trees</option>
<option value="triangulations">Triangulations</option>
</select></div>
</div>
<div class="bg"><button onclick="drawCatalan()">Compute</button><button onclick="screenshotCatalan()">Screenshot</button><button onclick="exportAllCatalan()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCatalan()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Catalan Numbers C‚Çô</h3><canvas id="ccat" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="catLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Growth of C‚Çô</h3><div id="pcat1" style="height:280px"></div></div>
</div>

<!-- ALIQUOT TAB -->
<div id="taliquot" class="tab">
<div class="ctrl">
<div class="cg"><label>Starting n</label><div class="sig"><input type="range" id="aliqN" min="2" max="1000" value="276" oninput="document.getElementById('aliqNv').value=this.value"><input type="number" id="aliqNv" value="276" min="2" max="10000" onkeydown="if(event.key==='Enter')drawAliquot()"></div></div>
<div class="cg"><label>Max Steps</label><input type="number" id="aliqSteps" value="100" min="10" max="1000"></div>
<div class="cg"><label>Mode</label><select id="aliqMode" onchange="drawAliquot()">
<option value="single">Single Sequence</option>
<option value="classify">Classify 1-N</option>
</select></div>
</div>
<div class="bg"><button onclick="drawAliquot()">Trace</button><button onclick="screenshotAliquot()">Screenshot</button><button onclick="exportAllAliquot()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvAliquot()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Aliquot Sequence s(n) = œÉ(n) - n</h3><canvas id="caliq" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="aliqLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Sequence Trajectory</h3><div id="paliq1" style="height:280px"></div></div>
</div>

<!-- CYCLOTOMIC TAB -->
<div id="tcyclotomic" class="tab">
<div class="ctrl">
<div class="cg"><label>Max n</label><div class="sig"><input type="range" id="cycN" min="5" max="50" value="20" oninput="document.getElementById('cycNv').value=this.value;drawCyclotomic()"><input type="number" id="cycNv" value="20" min="1" max="100" onkeydown="if(event.key==='Enter')drawCyclotomic()"></div></div>
<div class="cg"><label>View</label><select id="cycMode" onchange="drawCyclotomic()">
<option value="roots">Roots of Unity</option>
<option value="poly">Polynomial Coefficients</option>
<option value="degree">Degree œÜ(n)</option>
</select></div>
</div>
<div class="bg"><button onclick="drawCyclotomic()">Compute</button><button onclick="screenshotCyclotomic()">Screenshot</button><button onclick="exportAllCyclotomic()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCyclotomic()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Cyclotomic Polynomials Œ¶‚Çô(x)</h3><canvas id="ccyc" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="cycLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Polynomial Degrees</h3><div id="pcyc1" style="height:280px"></div></div>
</div>

<!-- COLLATZ TAB -->
<div id="tcollatz" class="tab">
<div class="ctrl">
<div class="cg"><label>Starting n</label><div class="sig"><input type="range" id="collN" min="1" max="10000" value="27" oninput="document.getElementById('collNv').value=this.value"><input type="number" id="collNv" value="27" min="1" max="1000000" onkeydown="if(event.key==='Enter')drawCollatz()"></div></div>
<div class="cg"><label>Mode</label><select id="collMode" onchange="drawCollatz()">
<option value="single">Single Trajectory</option>
<option value="stopping">Stopping Times</option>
<option value="tree">Inverse Tree</option>
</select></div>
</div>
<div class="bg"><button onclick="drawCollatz()">Compute</button><button onclick="screenshotCollatz()">Screenshot</button><button onclick="exportAllCollatz()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvCollatz()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Collatz Conjecture (3n+1)</h3><canvas id="ccoll" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="collLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Trajectory</h3><div id="pcoll1" style="height:280px"></div></div>
</div>

<!-- HIGHLY COMPOSITE TAB -->
<div id="thighcomp" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N</label><div class="sig"><input type="range" id="hcN" min="100" max="100000" step="100" value="10000" oninput="document.getElementById('hcNv').value=this.value"><input type="number" id="hcNv" value="10000" min="10" max="1000000" onkeydown="if(event.key==='Enter')drawHighComp()"></div></div>
<div class="cg"><label>Type</label><select id="hcMode" onchange="drawHighComp()">
<option value="hc">Highly Composite</option>
<option value="superior">Superior HC</option>
<option value="abundant">Abundant</option>
</select></div>
</div>
<div class="bg"><button onclick="drawHighComp()">Find</button><button onclick="screenshotHighComp()">Screenshot</button><button onclick="exportAllHighComp()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvHighComp()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Highly Composite Numbers</h3><canvas id="chc" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="hcLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>d(n) Records</h3><div id="phc1" style="height:280px"></div></div>
</div>

<!-- PERFECT NUMBERS TAB -->
<div id="tperfect" class="tab">
<div class="ctrl">
<div class="cg"><label>Max N</label><div class="sig"><input type="range" id="perfN" min="100" max="100000" step="100" value="10000" oninput="document.getElementById('perfNv').value=this.value"><input type="number" id="perfNv" value="10000" min="10" max="10000000" onkeydown="if(event.key==='Enter')drawPerfect()"></div></div>
<div class="cg"><label>Show</label><select id="perfMode" onchange="drawPerfect()">
<option value="classify">Classification</option>
<option value="sigma">œÉ(n)/n Ratio</option>
<option value="mersenne">Mersenne Connection</option>
</select></div>
</div>
<div class="bg"><button onclick="drawPerfect()">Analyze</button><button onclick="screenshotPerfect()">Screenshot</button><button onclick="exportAllPerfect()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvPerfect()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Perfect, Abundant, Deficient</h3><canvas id="cperf" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="perfLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>œÉ(n)/n Distribution</h3><div id="pperf1" style="height:280px"></div></div>
</div>

<!-- TAXICAB TAB -->
<div id="ttaxicab" class="tab">
<div class="ctrl">
<div class="cg"><label>Max Sum</label><div class="sig"><input type="range" id="taxiN" min="1000" max="100000" step="1000" value="20000" oninput="document.getElementById('taxiNv').value=this.value"><input type="number" id="taxiNv" value="20000" min="100" max="1000000" onkeydown="if(event.key==='Enter')drawTaxicab()"></div></div>
<div class="cg"><label>Min Ways k</label><select id="taxiK" onchange="drawTaxicab()">
<option value="2">Ta(2) - 2 ways</option>
<option value="3">Ta(3) - 3 ways</option>
<option value="4">Ta(4) - 4 ways</option>
</select></div>
</div>
<div class="bg"><button onclick="drawTaxicab()">Find Taxicabs</button><button onclick="screenshotTaxicab()">Screenshot</button><button onclick="exportAllTaxicab()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvTaxicab()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Taxicab Numbers (Hardy-Ramanujan)</h3><canvas id="ctaxi" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="taxiLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Representations</h3><div id="ptaxi1" style="height:280px"></div></div>
</div>

<!-- ELLIPTIC CURVES TAB -->
<div id="telliptic" class="tab">
<div class="ctrl">
<div class="cg"><label>a coefficient</label><input type="number" id="ellA" value="-1" step="1"></div>
<div class="cg"><label>b coefficient</label><input type="number" id="ellB" value="1" step="1"></div>
<div class="cg"><label>View</label><select id="ellMode" onchange="drawElliptic()">
<option value="real">Real Points y¬≤ = x¬≥ + ax + b</option>
<option value="modp">Points mod p</option>
<option value="group">Group Law</option>
</select></div>
<div class="cg"><label>Prime p (for mod)</label><input type="number" id="ellP" value="23" min="3" max="1000"></div>
</div>
<div class="bg"><button onclick="drawElliptic()">Draw Curve</button><button onclick="screenshotElliptic()">Screenshot</button><button onclick="exportAllElliptic()" style="background:#1a472a">üì¶ All</button><button class="s" onclick="csvElliptic()">Export CSV</button></div>
<div class="g2">
<div class="viz"><h3>Elliptic Curve y¬≤ = x¬≥ + ax + b</h3><canvas id="cell" width="700" height="500"></canvas></div>
<div class="viz"><h3>Live Statistics</h3><div id="ellLiveStats" style="background:var(--bg2);border-radius:8px;padding:1rem"></div></div>
</div>
<div class="viz"><h3>Point Count</h3><div id="pell1" style="height:280px"></div></div>
</div>

<div id="ref" class="sec">
<div class="rs"><h3>M√∂bius Shell Sieve ‚Äî Complete Platform Overview</h3><p>This comprehensive research platform integrates <strong>65 interactive visualization tools</strong> exploring number theory, from lattice points to the Riemann Hypothesis. Every tab features live dashboards, theory panels, multiple charts, CSV export, and click-to-inspect modals.</p></div>

<div class="rs"><h3>Mathematical Credits & Historical Attribution</h3>
<p style="color:var(--txt2);margin-bottom:1rem">This platform visualizes theorems and concepts developed by brilliant mathematicians over centuries:</p>
<div class="fb"><strong>Leonhard Euler (1707-1783)</strong> ‚Äî Euler product Œ∂(s)=‚àè(1-p‚ÅªÀ¢)‚Åª¬π, Basel problem Œ∂(2)=œÄ¬≤/6, totient function œÜ(n), discovered e and formalized much of number theory.</div>
<div class="fb"><strong>Carl Friedrich Gauss (1777-1855)</strong> ‚Äî Gaussian integers ‚Ñ§[i], quadratic reciprocity, prime counting conjecture œÄ(x)~x/ln(x), Circle Problem lattice point counting.</div>
<div class="fb"><strong>Bernhard Riemann (1826-1866)</strong> ‚Äî Riemann zeta function analytic continuation, Riemann Hypothesis (all nontrivial zeros have Re(s)=¬Ω), prime distribution via zeros.</div>
<div class="fb"><strong>August Ferdinand M√∂bius (1790-1868)</strong> ‚Äî M√∂bius function Œº(n), M√∂bius inversion formula, foundational to inclusion-exclusion in number theory.</div>
<div class="fb"><strong>Peter Gustav Lejeune Dirichlet (1805-1859)</strong> ‚Äî Dirichlet L-functions L(s,œá), primes in arithmetic progressions, Dirichlet characters, hyperbola method.</div>
<div class="fb"><strong>Arthur Cayley (1821-1895)</strong> ‚Äî Cayley transform mapping disk‚Üîhalf-plane, foundational to hyperbolic geometry and modular forms.</div>
<div class="fb"><strong>John Farey (1766-1826)</strong> ‚Äî Farey sequences F_n of reduced fractions, mediant property, connection to Ford circles.</div>
<div class="fb"><strong>Lester R. Ford (1886-1967)</strong> ‚Äî Ford circles tangent to real axis at rationals, geometric visualization of Farey sequences.</div>
<div class="fb"><strong>G.H. Hardy (1877-1947) & J.E. Littlewood (1885-1977)</strong> ‚Äî Prime race analysis, circle method, asymptotic analysis of prime distribution.</div>
<div class="fb"><strong>Wac≈Çaw Sierpi≈Ñski (1882-1969)</strong> ‚Äî Sierpi≈Ñski problem (1964): integers not expressible as 6ab¬±a¬±b, contributions to number theory and set theory.</div>
<div class="fb"><strong>Viggo Brun (1885-1978)</strong> ‚Äî Brun sieve for twin primes, proved Œ£1/p (twin primes) converges (Brun's constant ‚âà1.902).</div>
<div class="fb"><strong>Alphonse de Polignac (1826-1863)</strong> ‚Äî Twin prime conjecture (1849): infinitely many primes p where p+2 is also prime.</div>
<div class="fb"><strong>Christian Goldbach (1690-1764)</strong> ‚Äî Goldbach conjecture (1742): every even integer ‚â•4 is sum of two primes. Letter to Euler.</div>
<div class="fb"><strong>Sophie Germain (1776-1831)</strong> ‚Äî Sophie Germain primes (p where 2p+1 is also prime), contributions to Fermat's Last Theorem and elasticity theory.</div>
<div class="fb"><strong>Harald Cram√©r (1893-1985)</strong> ‚Äî Cram√©r's conjecture on prime gaps: g_n = O((ln p_n)¬≤), probabilistic model for primes.</div>
</div>

<div class="rs"><h3>All 41 Interactive Tabs</h3>
<h4>Lattice & Geometry (Tabs 1-3)</h4>
<div class="fb"><strong>2D Lattice</strong> ‚Äî Gauss circle problem: count lattice points in disk. Primitive density ‚Üí 6/œÄ¬≤ (Euler). 15+ color schemes.</div>
<div class="fb"><strong>3D Ball</strong> ‚Äî Extends to 3D sphere. Primitive density ‚Üí 1/Œ∂(3) ‚âà 0.832 (Ap√©ry's constant). Drag rotation.</div>
<div class="fb"><strong>M√∂bius Œº(n)</strong> ‚Äî Visualize M√∂bius function: Œº(n)=(-1)^k if squarefree with k prime factors, else 0. Mertens function M(x).</div>

<h4>Modular Arithmetic (Tabs 4-7)</h4>
<div class="fb"><strong>Modular Rings</strong> ‚Äî Concentric rings at angles Œ∏=2œÄr/M. Foundation for Dirichlet characters. Gap connections.</div>
<div class="fb"><strong>Cayley ‚Ñç</strong> ‚Äî Cayley transform w=i(1+z)/(1-z) mapping disk to upper half-plane. Ford circles, hyperbolic geodesics.</div>
<div class="fb"><strong>Farey</strong> ‚Äî Farey sequence F_n: all reduced fractions p/q with q‚â§n. Mediant property, |F_n|~3n¬≤/œÄ¬≤.</div>
<div class="fb"><strong>Primitive Roots</strong> ‚Äî Generator g of (‚Ñ§/M‚Ñ§)√ó. Exists iff M‚àà{1,2,4,p^k,2p^k}. Power sequences g^n mod M.</div>

<h4>Analysis & Error (Tabs 8-10)</h4>
<div class="fb"><strong>Error Analysis</strong> ‚Äî Deviation from 1/Œ∂(k) density. Theory vs actual, absolute/relative error, boundary terms.</div>
<div class="fb"><strong>Dimensions</strong> ‚Äî Primitive density in k-dimensional balls converges to 1/Œ∂(k). Compare k=2 through k=7.</div>
<div class="fb"><strong>Shells</strong> ‚Äî M√∂bius shell decomposition: points at each GCD level. Divisor contributions to total count.</div>

<h4>Classical Problems (Tabs 11-14)</h4>
<div class="fb"><strong>GCD Analysis</strong> ‚Äî Statistical GCD distribution: mean, median, mode. Squarefree proportion ‚Üí 6/œÄ¬≤.</div>
<div class="fb"><strong>Gaussian ‚Ñ§[i]</strong> ‚Äî Gauss: complex integers a+bi. Norm N(z)=a¬≤+b¬≤. Gaussian primes, unit group {¬±1,¬±i}.</div>
<div class="fb"><strong>Circle Problem</strong> ‚Äî Gauss-Dirichlet: N(R)=œÄR¬≤+E(R). Error E(R)=O(R^Œ∏), Œ∏ between 1/4 and 1/2. RH connection.</div>
<div class="fb"><strong>Density 1/Œ∂</strong> ‚Äî Empirical verification: primitive lattice point density approaches 1/Œ∂(k) exactly.</div>

<h4>Characters & Primes (Tabs 15-17)</h4>
<div class="fb"><strong>Dirichlet œá</strong> ‚Äî Dirichlet characters mod q. L-functions L(s,œá)=Œ£œá(n)n‚ÅªÀ¢. Prime distribution in residue classes.</div>
<div class="fb"><strong>Twin Primes</strong> ‚Äî Polignac conjecture: infinitely many (p, p+2). Brun's constant B‚ÇÇ‚âà1.902. Hardy-Littlewood conjecture.</div>
<div class="fb"><strong>Prime Counting œÄ(x)</strong> ‚Äî Gauss/Riemann: œÄ(x)~x/ln(x)~Li(x). Prime number theorem. Chebyshev bounds.</div>

<h4>Advanced Topics (Tabs 18-26)</h4>
<div class="fb"><strong>Composite Channels</strong> ‚Äî How composite moduli project residues onto Farey channels. Reducibility analysis, channel multiplicities.</div>
<div class="fb"><strong>Coprime Pairs</strong> ‚Äî Density theorem: P(gcd(a,b)=1)=6/œÄ¬≤. Disc analysis V(R), error E(R), RH connection |E(R)|=O(R^¬Ω‚Å∫·µã).</div>
<div class="fb"><strong>Sierpi≈Ñski</strong> ‚Äî Sierpi≈Ñski problem (1964): integers not expressible as 6ab¬±a¬±b. 78 known uncovered ‚â§1000. Unsolved.</div>
<div class="fb"><strong>k-Free</strong> ‚Äî Boundary cancellation principle: k-free integers have density 1/Œ∂(k), error O(N^(1/k)) from boundary.</div>
<div class="fb"><strong>Euler ‚àè</strong> ‚Äî Compute œÄ and Œ∂(2n) via Euler product. Gap-class decomposition, residue channel analysis mod m.</div>
<div class="fb"><strong>Chord CV</strong> ‚Äî Chord length uniformity heuristic (Getachew 2025): CV separates primes (low) from composites (high). 92% separation at n‚â§10000.</div>
<div class="fb"><strong>Goldbach</strong> ‚Äî Goldbach conjecture: every even n‚â•4 is sum of two primes. Comet visualization, partition count G(n), Hardy-Littlewood prediction.</div>
<div class="fb"><strong>Prime Gaps</strong> ‚Äî Gap distribution g_n = p_{n+1} - p_n. Record gaps, Cram√©r's conjecture g_n = O((ln p)¬≤), gap/ln(p) ratio analysis.</div>
<div class="fb"><strong>Sophie Germain</strong> ‚Äî Sophie Germain primes (p where 2p+1 also prime), safe primes, Cunningham chains. Cryptographic applications.</div>

<h4>RH Connection (Tabs 27-29)</h4>
<div class="fb"><strong>Mertens M(x)</strong> ‚Äî Mertens function M(x)=Œ£Œº(n) for n‚â§x. RH ‚ü∫ |M(x)|=O(x^{1/2+Œµ}). Tracks Œº(n) cumulative imbalance. M(x)/‚àöx ratio analysis.</div>
<div class="fb"><strong>Chebyshev œà</strong> ‚Äî Chebyshev function œà(x)=Œ£ Œõ(n) and Œ∏(x)=Œ£ log p. Von Mangoldt Œõ(n). PNT: œà(x)~x. RH: œà(x)=x+O(‚àöx log¬≤x).</div>
<div class="fb"><strong>Li(x)</strong> ‚Äî Logarithmic integral Li(x)=‚à´‚ÇÇÀ£ dt/ln(t). Best elementary œÄ(x) approximation. Littlewood's sign changes. Skewes number ~10¬≥¬π‚Å∂.</div>

<h4>Arithmetic Functions (Tabs 30-32)</h4>
<div class="fb"><strong>Divisor d(n)</strong> ‚Äî œÑ(n) counts divisors, œÉ(n) sums them. Highly composite numbers, perfect/abundant/deficient classification. Average œÑ(n) ~ log n.</div>
<div class="fb"><strong>Liouville Œª</strong> ‚Äî Œª(n)=(-1)^{Œ©(n)} where Œ© counts primes with multiplicity. L(x)=Œ£Œª(n). P√≥lya conjecture (disproved). RH connection.</div>
<div class="fb"><strong>Mangoldt Œõ</strong> ‚Äî Œõ(n)=log p if n=p^k, else 0. Core of Chebyshev œà(x). Explicit formula: œà(x)=x-Œ£ x^œÅ/œÅ. Prime power decomposition.</div>

<h4>Advanced & Visual (Tabs 33-35)</h4>
<div class="fb"><strong>Ramanujan c_q</strong> ‚Äî Ramanujan sum c_q(n) = Œ£_{gcd(a,q)=1} e^{2œÄian/q}. Always integer! Fourier basis for arithmetic functions. Heatmap and unit circle views.</div>
<div class="fb"><strong>Ulam Spiral</strong> ‚Äî Integers on square spiral, primes highlighted. Diagonal patterns reveal quadratic polynomials. Euler's n¬≤+n+41. Discovered 1963.</div>
<div class="fb"><strong>Sacks Spiral</strong> ‚Äî Primes at (‚àön, 2œÄ‚àön) Archimedean spiral. Parabolic arms from quadratic sequences. Squares on x-axis. Visual prime clustering.</div>

<h4>Critical Line (Tabs 36-41)</h4>
<div class="fb"><strong>Hardy Z(t)</strong> ‚Äî Z(t)=e^{iŒ∏(t)}Œ∂(¬Ω+it) is REAL. Sign changes = zeros on critical line. RH: all zeros are sign changes. First zeros: 14.135, 21.022, 25.011...</div>
<div class="fb"><strong>Gram Points</strong> ‚Äî g_n where Œ∏(g_n)=nœÄ. Organize zero counting. Gram's Law: one zero per interval (~73%). Violations form Gram blocks. Lehmer pairs.</div>
<div class="fb"><strong>Explicit œÄ(x)</strong> ‚Äî œÄ(x)=Li(x)-Œ£_œÅ Li(x^œÅ)-log(2)+... Each zero œÅ contributes oscillation. Animation builds œÄ(x) from zeros. RH ‚üπ O(‚àöx log x) error.</div>
<div class="fb"><strong>N(T) Zeros</strong> ‚Äî Zero counting N(T)=#{œÅ: 0<Im(œÅ)<T}. Riemann-von Mangoldt: N(T)~(T/2œÄ)log(T/2œÄe). Error S(T) encodes zero spacing.</div>
<div class="fb"><strong>Œ∂(s) Argand</strong> ‚Äî Domain coloring of Œ∂(s) in complex plane. Phase‚Üíhue, modulus‚Üíbrightness. Zeros appear as color wheels. Critical line Re(s)=¬Ω highlighted.</div>
<div class="fb"><strong>Œ∂(s) Real</strong> ‚Äî Zeta on real axis: pole at s=1, Basel Œ∂(2)=œÄ¬≤/6, Ap√©ry Œ∂(3), trivial zeros at s=-2,-4,-6,... Functional equation visualization.</div>

<h4>Zero Statistics (Tabs 42-43)</h4>
<div class="fb"><strong>Montgomery Pair Correlation</strong> ‚Äî Spacing between zeros follows R‚ÇÇ(x) = 1-(sin œÄx/œÄx)¬≤. Discovered by Hugh Montgomery (1973). Connection to GUE random matrices.</div>
<div class="fb"><strong>GUE Statistics</strong> ‚Äî Zeros follow Gaussian Unitary Ensemble (random matrix) statistics. Wigner surmise: P(s)=(œÄ/2)s¬∑exp(-œÄs¬≤/4). Level repulsion: P(0)=0.</div>

<h4>Prime Races (Tab 44)</h4>
<div class="fb"><strong>Prime Races</strong> ‚Äî Chebyshev bias: primes ‚â°3 (mod 4) outnumber ‚â°1 (mod 4) about 99.59% of the time! Rubinstein-Sarnak (1994) proved this under GRH.</div>

<h4>L-Functions (Tabs 45-46)</h4>
<div class="fb"><strong>Dirichlet L-functions</strong> ‚Äî L(s,œá) = Œ£œá(n)/nÀ¢ for Dirichlet characters œá mod q. Principal L-function equals Œ∂(s)√ó(local factors). Others are entire.</div>
<div class="fb"><strong>L-function Zeros</strong> ‚Äî Generalized RH: all nontrivial zeros of all L(s,œá) lie on Re(s)=¬Ω. Low-lying zeros cause the Chebyshev bias in prime races.</div>

<h4>Quantum-Number Theory (Tab 47)</h4>
<div class="fb"><strong>Quantum Orbitals</strong> ‚Äî œà_{nlm}(r,Œ∏,œÜ) = R_{nl}(r)Y_l^m(Œ∏,œÜ). Radial nodes (n-l-1) mirror zeta zeros. Spherical harmonics Y_l^m connect to k-dimensional ball volumes. Quantization ‚Üî coprimality.</div>
</div>

<div class="rs"><h3>Key Theorems Visualized</h3>
<div class="fb"><strong>Euler Product (1737):</strong> Œ∂(s) = ‚àè<sub>p prime</sub>(1-p‚ÅªÀ¢)‚Åª¬π for Re(s)>1. Connects primes to zeta function.</div>
<div class="fb"><strong>Basel Problem (Euler 1734):</strong> Œ∂(2) = 1+1/4+1/9+... = œÄ¬≤/6. First exact value of Œ∂(2n).</div>
<div class="fb"><strong>M√∂bius Inversion (1832):</strong> If g(n)=Œ£_{d|n}f(d), then f(n)=Œ£_{d|n}Œº(d)g(n/d). Fundamental identity.</div>
<div class="fb"><strong>Primitive Density:</strong> #{gcd=1 in B_k(R)}/#{all in B_k(R)} ‚Üí 1/Œ∂(k) as R‚Üí‚àû.</div>
<div class="fb"><strong>Dirichlet's Theorem (1837):</strong> Infinitely many primes in arithmetic progression a+nd when gcd(a,n)=1.</div>
<div class="fb"><strong>Prime Number Theorem (1896):</strong> œÄ(x) ~ x/ln(x). Proved independently by Hadamard and de la Vall√©e Poussin.</div>
<div class="fb"><strong>Riemann Hypothesis (1859):</strong> All nontrivial zeros of Œ∂(s) satisfy Re(s)=¬Ω. Millennium Prize problem.</div>
<div class="fb"><strong>Hardy-Littlewood Conjecture:</strong> Twin prime count ~ 2C‚ÇÇ‚à´dx/(ln x)¬≤ where C‚ÇÇ‚âà0.66 is twin prime constant.</div>
</div>

<div class="rs"><h3>References & Further Reading</h3>
<div class="fb"><strong>Edwards, H.M.</strong> (1974). <em>Riemann's Zeta Function</em>. Academic Press. ‚Äî Comprehensive treatment of Œ∂(s).</div>
<div class="fb"><strong>Apostol, T.M.</strong> (1976). <em>Introduction to Analytic Number Theory</em>. Springer. ‚Äî Standard graduate text.</div>
<div class="fb"><strong>Hardy, G.H. & Wright, E.M.</strong> (2008). <em>An Introduction to the Theory of Numbers</em>. 6th ed. Oxford. ‚Äî Classic reference.</div>
<div class="fb"><strong>Davenport, H.</strong> (2000). <em>Multiplicative Number Theory</em>. 3rd ed. Springer. ‚Äî Dirichlet L-functions and characters.</div>
<div class="fb"><strong>Titchmarsh, E.C.</strong> (1986). <em>The Theory of the Riemann Zeta Function</em>. 2nd ed. Oxford. ‚Äî Definitive Œ∂(s) reference.</div>
<div class="fb"><strong>Montgomery, H.L. & Vaughan, R.C.</strong> (2007). <em>Multiplicative Number Theory I</em>. Cambridge. ‚Äî Modern treatment.</div>
<div class="fb"><strong>Iwaniec, H. & Kowalski, E.</strong> (2004). <em>Analytic Number Theory</em>. AMS. ‚Äî Advanced techniques.</div>
<div class="fb"><strong>OEIS</strong> ‚Äî Online Encyclopedia of Integer Sequences: <a href="https://oeis.org" target="_blank" style="color:var(--acc)">oeis.org</a></div>
</div>

<div class="rs"><h3>Platform Features</h3>
<ul>
<li><strong>Live Dashboards:</strong> Real-time statistics with big number cards and detailed breakdowns</li>
<li><strong>Theory Panels:</strong> 8 key facts per tab explaining the mathematics</li>
<li><strong>Multiple Charts:</strong> Plotly-powered interactive charts (3-6 per tab)</li>
<li><strong>Click Inspector:</strong> Click any point/cell for detailed modal analysis</li>
<li><strong>CSV Export:</strong> Download data for external analysis</li>
<li><strong>Screenshot:</strong> High-resolution PNG export with embedded dashboard</li>
<li><strong>Dual Controls:</strong> Every slider has matching input box for precise values</li>
<li><strong>Dark/Light Mode:</strong> Toggle in header, persists across sessions</li>
<li><strong>Precision Control:</strong> 2-16 decimal places for all calculations</li>
</ul>
</div>

<div class="rs"><h3>About</h3>
<p><strong>Created by:</strong> Wessen Getachew (<a href="https://twitter.com/7dview" target="_blank" style="color:var(--acc)">@7dview</a>)</p>
<p><strong>Philosophy:</strong> Making deep number theory accessible through interactive visualization. Every theorem deserves to be seen, not just read.</p>
<p><strong>Technology:</strong> Pure HTML5/CSS3/JavaScript. No frameworks, no dependencies except Plotly.js for charts.</p>
<p style="margin-top:1rem;color:var(--txt2);font-size:.85rem"><em>"The mathematician does not study pure mathematics because it is useful; he studies it because he delights in it and he delights in it because it is beautiful."</em> ‚Äî Henri Poincar√©</p>
</div>
</div>

<div id="modal" class="modal" onclick="this.classList.remove('active')">
<div class="mc" onclick="event.stopPropagation()">
<span class="mx" onclick="document.getElementById('modal').classList.remove('active')">&times;</span>
<h2 id="mtitle">Analysis</h2>
<div id="mbody"></div>
</div>
</div>

<footer>
<div style="margin-bottom:1rem"><strong style="color:var(--acc)">By Wessen Getachew</strong> ¬∑ <a href="https://twitter.com/7dview" target="_blank" style="color:var(--acc2)">@7dview</a></div>
<div style="display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:1rem">
<a href="https://wessengetachew.github.io/Farey/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Farey Triangle</a>
<a href="https://wessengetachew.github.io/1-2/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">1/Œ∂(2) Explorer</a>
<a href="https://wessengetachew.github.io/Primes/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Prime Explorer</a>
<a href="https://wessengetachew.github.io/Composite/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Composite Analysis</a>
<a href="https://wessengetachew.github.io/GCD/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">GCD Explorer</a>
<a href="https://wessengetachew.github.io/Reduced/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Reduced Residues</a>
<a href="https://wessengetachew.github.io/Infinitemoduli/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Modular Arithmetic</a>
<a href="https://wessengetachew.github.io/finite/" target="_blank" style="color:var(--acc);text-decoration:none;padding:.4rem .8rem;border:1px solid var(--acc);border-radius:4px">Finite Fields</a>
</div>
<div style="color:var(--txt2);font-size:.85rem">A philosophical exploration of optimal prime sieves through geometric visualization</div>
</footer>

<script>
// HIGH-PRECISION MATHEMATICAL CONSTANTS (17+ decimal places)
const PI = 3.14159265358979323846264338327950288;
const PI_SQ = 9.86960440108935861883449099987615114; // œÄ¬≤
const PI_4 = 97.40909103400243723644033268870511124; // œÄ‚Å¥
const PI_6 = 961.3891935753043477935274768132038336; // œÄ‚Å∂
const PI_8 = 9488.531016070574879254676078451192839; // œÄ‚Å∏

// Zeta values with maximum precision
const ZETA2 = 1.64493406684822643647241516664602519; // œÄ¬≤/6
const ZETA3 = 1.20205690315959428539973816151144999; // Ap√©ry's constant
const ZETA4 = 1.08232323371113819151600369654116790; // œÄ‚Å¥/90
const ZETA5 = 1.03692775514336992633136548645703417;
const ZETA6 = 1.01734306198444913971451792979092053; // œÄ‚Å∂/945
const ZETA7 = 1.00834927738192282683979754984979676;
const ZETA8 = 1.00407735619794433937868523850865247; // œÄ‚Å∏/9450

// Inverse zeta (primitive densities)
const INV_ZETA2 = 0.60792710185402662866327677925836583; // 6/œÄ¬≤ ‚âà 60.79271%
const INV_ZETA3 = 0.83190737258070746868312627885303710; // 1/Œ∂(3) ‚âà 83.19074%
const INV_ZETA4 = 0.92393937506088059965327506266838895; // 90/œÄ‚Å¥ ‚âà 92.39394%
const INV_ZETA5 = 0.96439694022155614594451655816101030;
const INV_ZETA6 = 0.98295257001054197674506666180529804;
const INV_ZETA7 = 0.99171786507468023731390850206009357;
const INV_ZETA8 = 0.99593897568449780461998282310567081;

let P=4,D={},rx=0,ry=0,rz=0,panX=0,panY=0,anim3d=false,pts2d=[],pts3d=[],gausP=[];
// Debounce for sliders
let draw2DTimer=null,draw3DTimer=null;
function draw2DDebounced(){clearTimeout(draw2DTimer);draw2DTimer=setTimeout(draw2D,50);}
function draw3DDebounced(){clearTimeout(draw3DTimer);draw3DTimer=setTimeout(draw3D,50);}
const fmt=n=>{if(n===0)return'0';if(n==null||isNaN(n)||!isFinite(n))return'‚Äî';return parseFloat(n).toFixed(P);};
const fmtH=n=>{if(n===0)return'0';if(n==null||isNaN(n)||!isFinite(n))return'‚Äî';return parseFloat(n).toPrecision(17);}; // High precision format
const gcd=(a,b)=>{a=Math.abs(Math.round(a));b=Math.abs(Math.round(b));while(b)[a,b]=[b,a%b];return a||1;};
const isPrime=n=>{if(n<2)return false;if(n===2)return true;if(n%2===0)return false;for(let i=3;i*i<=n;i+=2)if(n%i===0)return false;return true;};
const totient=n=>{if(n<1)return 0;let r=n;for(let p=2;p*p<=n;p++){if(n%p===0){while(n%p===0)n/=p;r-=r/p;}}if(n>1)r-=r/n;return Math.round(r);};
const gcdM=(...n)=>n.reduce((a,b)=>gcd(a,b));
const mob=n=>{if(n===1)return 1;let pf=0,t=n;for(let i=2;i*i<=n;i++){if(n%i===0){if(t%(i*i)===0)return 0;pf++;while(t%i===0)t/=i;}}if(t>1)pf++;return pf%2===0?1:-1;};
const zeta=n=>{
// Use exact high-precision constants
if(n===2)return ZETA2;
if(n===3)return ZETA3;
if(n===4)return ZETA4;
if(n===5)return ZETA5;
if(n===6)return ZETA6;
if(n===7)return ZETA7;
if(n===8)return ZETA8;
// For other values, use series with many terms
let s=0;for(let k=1;k<=10000;k++)s+=1/Math.pow(k,n);return s;
};
const zetaInv=n=>{
if(n===2)return INV_ZETA2;
if(n===3)return INV_ZETA3;
if(n===4)return INV_ZETA4;
if(n===5)return INV_ZETA5;
if(n===6)return INV_ZETA6;
if(n===7)return INV_ZETA7;
if(n===8)return INV_ZETA8;
return 1/zeta(n);
};
const vol=n=>[0,2,PI,4*PI/3,PI_SQ/2,8*PI_SQ/15,PI*PI_SQ/6,16*PI*PI_SQ/105][n]||0;
const theory=(R,n)=>(vol(n)*zetaInv(n))*Math.pow(R,n);
const sqfree=n=>{for(let i=2;i*i<=n;i++)if(n%(i*i)===0)return false;return true;};
const isDark=()=>!document.body.classList.contains('light');
const plo=()=>({plot_bgcolor:isDark()?'rgba(10,14,39,0.8)':'rgba(245,247,250,0.95)',paper_bgcolor:isDark()?'rgba(10,14,39,0.8)':'rgba(245,247,250,0.95)',font:{color:isDark()?'#e0e0ff':'#1a1a1a'},margin:{l:50,r:30,t:30,b:40}});
const canvBg=()=>isDark()?'#0a0e27':'#f5f7fa';
const gridC=()=>isDark()?'rgba(0,217,255,0.12)':'rgba(0,102,204,0.15)';
const bordC=()=>isDark()?'rgba(0,217,255,0.5)':'rgba(0,102,204,0.6)';
function toggleTheme(){document.body.classList.toggle('light');document.getElementById('thm').textContent=isDark()?'D':'L';draw2D();if(document.getElementById('t3d').classList.contains('active'))draw3D();}
function showSec(id,btn){document.querySelectorAll('.sec').forEach(s=>s.classList.remove('active'));document.querySelectorAll('.snav .nbtn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active');btn.classList.add('active');}
function showTab(id,btn){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tabs .tbtn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active');btn.classList.add('active');if(id==='t3d')draw3D();if(id==='tcayley')drawCayley();if(id==='tfarey')drawFarey();if(id==='tprim')drawPrimRoot();if(id==='tmod')drawModRings();if(id==='tgaus')drawGaus();if(id==='tmob')drawMobius();if(id==='tdim')runDimNew();if(id==='tcirc'){drawCircleViz();runCircNew();}if(id==='tcomp')drawComp();if(id==='tcopair')drawCopair();if(id==='tsierp')drawSierp();if(id==='tkfree')drawKfree();if(id==='teuler')drawEuler();if(id==='tchord')drawChord();if(id==='tdir')drawDirichlet();if(id==='ttwin')drawTwin();if(id==='tpi')drawPi();if(id==='tgold')drawGoldbach();if(id==='tgap')drawGap();if(id==='tsoph')drawSophie();if(id==='tmert')drawMertens();if(id==='tcheb')drawChebyshev();if(id==='tli')drawLi();if(id==='tdiv')drawDivisor();if(id==='tliou')drawLiouville();if(id==='tmang')drawMangoldt();if(id==='tram')drawRamanujan();if(id==='tulam')drawUlam();if(id==='tsacks')drawSacks();if(id==='thardy')drawHardy();if(id==='tgram')drawGram();if(id==='texplicit')drawExplicit();if(id==='tzerocount')drawZeroCount();if(id==='targand')drawArgand();if(id==='tzetareal')drawZetaReal();if(id==='tmontgomery')drawMontgomery();if(id==='tgue')drawGUE();if(id==='tprimerace')drawPrimeRace();if(id==='tlfunc')drawLfunc();if(id==='tlfunczeros')drawLfuncZeros();if(id==='tquantum')drawQuantum();if(id==='tktuples')drawKtuples();if(id==='tcarmichael')drawCarmichael();if(id==='tmersenne')drawMersenne();if(id==='tcontinued')drawContinued();if(id==='tsternbrocot')drawSternBrocot();if(id==='tpythag')drawPythag();if(id==='tsumsquares')drawSumSquares();if(id==='tquadres')drawQuadRes();if(id==='tpartition')drawPartition();if(id==='tbernoulli')drawBernoulli();if(id==='tfibonacci')drawFibonacci();if(id==='tcatalan')drawCatalan();if(id==='taliquot')drawAliquot();if(id==='tcyclotomic')drawCyclotomic();if(id==='tcollatz')drawCollatz();if(id==='thighcomp')drawHighComp();if(id==='tperfect')drawPerfect();if(id==='ttaxicab')drawTaxicab();if(id==='telliptic')drawElliptic();}

async function screenshotDashboard(elemId, title='Dashboard'){
const el=document.getElementById(elemId);if(!el)return;
const scale=4;
const w=el.offsetWidth,h=el.offsetHeight;
const c=document.createElement('canvas');c.width=w*scale;c.height=h*scale;
const ctx=c.getContext('2d');
ctx.scale(scale,scale);
ctx.fillStyle=isDark()?'#1a1a2e':'#ffffff';ctx.fillRect(0,0,w,h);
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 16px Segoe UI';ctx.fillText(title+' ‚Äî M√∂bius Shell Sieve',10,24);
ctx.fillStyle=isDark()?'rgba(255,255,255,0.5)':'rgba(0,0,0,0.5)';ctx.font='10px Segoe UI';ctx.fillText(new Date().toISOString().slice(0,19).replace('T',' '),10,h-8);
try{
const html2canvas=(await import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm')).default;
const snap=await html2canvas(el,{scale:scale,backgroundColor:isDark()?'#1a1a2e':'#ffffff',logging:false});
ctx.drawImage(snap,0,36,w,h-44);
c.toBlob(blob=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${title.replace(/[^a-zA-Z0-9]/g,'_')}_4K_${Date.now()}.png`;a.click();URL.revokeObjectURL(a.href);},'image/png');
}catch(e){
ctx.fillStyle=isDark()?'#e0e0e0':'#333';ctx.font='12px Segoe UI';
const lines=el.innerText.split('\n').slice(0,30);
lines.forEach((line,i)=>ctx.fillText(line.substring(0,80),10,50+i*16));
c.toBlob(blob=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${title.replace(/[^a-zA-Z0-9]/g,'_')}_4K_${Date.now()}.png`;a.click();URL.revokeObjectURL(a.href);},'image/png');
}}

function legend(id,title,data){const d=document.getElementById(id);if(!d)return;d.innerHTML=`<h4>${title}</h4><div class="lg">${data.map(([l,v,c])=>`<div class="li" style="border-left-color:${c}"><strong>${l}</strong><span class="v">${fmt(v)}</span></div>`).join('')}</div>`;}
function modal(title,data){document.getElementById('mtitle').textContent=title;document.getElementById('mbody').innerHTML=data.map(([l,v])=>`<div class="ds"><div class="dr"><span class="dl">${l}:</span><span class="dv">${typeof v==='number'?fmt(v):v}</span></div></div>`).join('');document.getElementById('modal').classList.add('active');}
function dl(c,f){const a=document.createElement('a');a.href='data:text/csv,'+encodeURIComponent(c);a.download=f;a.click();}
function enum2D(R,sh){const pts=[],m=Math.ceil(R)+1;for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++){const inCirc=x*x+y*y<=R*R,inSq=Math.abs(x)<=R&&Math.abs(y)<=R;const inR=sh==='circle'?inCirc:sh==='square'?inSq:inSq;if(inR){const g=gcdM(x,y);pts.push({x,y,g,p:g===1,inCircle:inCirc});}}return pts;}
function enum3D(R){const pts=[],m=Math.ceil(R)+1;for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){const g=gcdM(x,y,z);pts.push({x,y,z,g,p:g===1});}return pts;}

function smithTransform(r,theta,alpha){
const th=theta+alpha*Math.PI/180;
const A=r*Math.cos(th)-1,B=r*Math.sin(th),C=r*Math.cos(th)+1;
const denom=C*C+B*B;
if(denom<1e-10)return{x:0,y:0};
const re=(A*C+B*B)/denom,im=B*(C-A)/denom;
return{x:re,y:im};}

function smithTransformUnit(theta){return{x:0,y:Math.tan(theta/2)};}

function drawSmithGrid(ctx,cx,cy,rad,showGrid,showConstR,showConstX){
if(showGrid){ctx.strokeStyle=isDark()?'rgba(100,150,200,0.3)':'rgba(50,100,150,0.3)';ctx.lineWidth=0.5;
ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();
ctx.strokeStyle=isDark()?'rgba(255,255,255,0.4)':'rgba(0,0,0,0.4)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(cx-rad,cy);ctx.lineTo(cx+rad,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,cy-rad);ctx.lineTo(cx,cy+rad);ctx.stroke();}
if(showConstR){ctx.strokeStyle='rgba(100,150,200,0.25)';ctx.lineWidth=0.5;
const rVals=[0.2,0.5,1,2,5];
rVals.forEach(r=>{const center=r/(1+r),radius=1/(1+r);ctx.beginPath();ctx.arc(cx+center*rad,cy,radius*rad,0,2*Math.PI);ctx.stroke();});}
if(showConstX){ctx.strokeStyle='rgba(150,100,200,0.25)';ctx.lineWidth=0.5;
const xVals=[-2,-1,-0.5,0.5,1,2];
xVals.forEach(x=>{if(Math.abs(x)<0.01)return;const centerY=1/x,radius=1/Math.abs(x);ctx.beginPath();ctx.arc(cx+rad,cy-centerY*rad,radius*rad,x>0?Math.PI:0,x>0?0:Math.PI,x>0);ctx.stroke();});}}

function draw2D(){
try{
let R=+document.getElementById('r2dv').value||+document.getElementById('r2d').value;
const maxSafeR=500;
if(R>maxSafeR){
if(!confirm(`R=${R} will compute ${Math.round(Math.PI*R*R).toLocaleString()}+ points which may freeze your browser.\n\nContinue anyway?`)){
R=maxSafeR;document.getElementById('r2dv').value=R;document.getElementById('r2d').value=Math.min(200,R);
}}
const c=document.getElementById('c2d'),ctx=c.getContext('2d'),sh=document.getElementById('sh2d').value,col=document.getElementById('col2d').value,lbl=document.getElementById('lbl2d').value,zm=+document.getElementById('zm2d').value,lblsz=+document.getElementById('lblsz2d').value,ptSz=+document.getElementById('ptSz2d').value;
const smithEnabled=document.getElementById('smith2d').checked,smithAlpha=+document.getElementById('smithA2d').value,smithRMode=document.getElementById('smithR2d').value;
const smithGrid=document.getElementById('smithGrid2d').checked,smithConstR=document.getElementById('smithCircR2d').checked,smithConstX=document.getElementById('smithArcX2d').checked;
const modEnabled=document.getElementById('mod2dEnable').checked,modM=+document.getElementById('mod2dM').value||6,modColBy=document.getElementById('mod2dColBy').value,modRings=document.getElementById('mod2dRings').checked;
const cx=c.width/2,cy=c.height/2,sc=(c.width/2)/(R*1.15)*zm,smithRad=(c.width/2-40)*zm;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
if(smithEnabled){drawSmithGrid(ctx,cx,cy,smithRad,smithGrid,smithConstR,smithConstX);ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,smithRad,0,2*Math.PI);ctx.stroke();}
else{ctx.strokeStyle=gridC();ctx.lineWidth=1;for(let i=-Math.ceil(R);i<=Math.ceil(R);i++){ctx.beginPath();ctx.moveTo(cx+i*sc,0);ctx.lineTo(cx+i*sc,c.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,cy+i*sc);ctx.lineTo(c.width,cy+i*sc);ctx.stroke();}ctx.strokeStyle=bordC();ctx.lineWidth=2;if(sh==='circle'){ctx.beginPath();ctx.arc(cx,cy,R*sc,0,2*Math.PI);ctx.stroke();}else if(sh==='square'){ctx.strokeRect(cx-R*sc,cy-R*sc,2*R*sc,2*R*sc);}else if(sh==='both'){ctx.strokeRect(cx-R*sc,cy-R*sc,2*R*sc,2*R*sc);ctx.strokeStyle='rgba(255,136,0,0.8)';ctx.beginPath();ctx.arc(cx,cy,R*sc,0,2*Math.PI);ctx.stroke();}

// Modular residue rings overlay
if(modEnabled&&modRings){
ctx.setLineDash([5,3]);
for(let r=1;r<=modM;r++){
const ringRad=r*(R*sc/modM);
ctx.strokeStyle=`hsla(${(r/modM)*360},70%,50%,0.4)`;
ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,ringRad,0,2*Math.PI);ctx.stroke();
}
ctx.setLineDash([]);
}}
pts2d=enum2D(R,sh);
const conn=document.getElementById('conn2d').value,connOp=+document.getElementById('connOp2d').value;
if(conn!=='none'&&!smithEnabled){ctx.lineWidth=1;const primPts=pts2d.filter(p=>p.p);
if(conn==='gcd1'){ctx.strokeStyle=`rgba(0,217,255,${connOp})`;for(let i=0;i<primPts.length;i++)for(let j=i+1;j<primPts.length;j++){const p1=primPts[i],p2=primPts[j],d=Math.hypot(p1.x-p2.x,p1.y-p2.y);if(d<=2){ctx.beginPath();ctx.moveTo(cx+p1.x*sc,cy-p1.y*sc);ctx.lineTo(cx+p2.x*sc,cy-p2.y*sc);ctx.stroke();}}}
else if(conn==='same'){const byGcd={};pts2d.forEach(p=>{if(!byGcd[p.g])byGcd[p.g]=[];byGcd[p.g].push(p);});Object.keys(byGcd).forEach(g=>{const ps=byGcd[g];ctx.strokeStyle=`hsla(${g*60},100%,50%,${connOp})`;for(let i=0;i<ps.length;i++)for(let j=i+1;j<ps.length;j++){const p1=ps[i],p2=ps[j],d=Math.hypot(p1.x-p2.x,p1.y-p2.y);if(d<=2){ctx.beginPath();ctx.moveTo(cx+p1.x*sc,cy-p1.y*sc);ctx.lineTo(cx+p2.x*sc,cy-p2.y*sc);ctx.stroke();}}});}
else if(conn==='radial'){ctx.strokeStyle=`rgba(255,215,0,${connOp})`;for(const p of primPts){ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+p.x*sc,cy-p.y*sc);ctx.stroke();}}
else if(conn==='diagonal'){ctx.strokeStyle=`rgba(150,100,255,${connOp})`;const diag=pts2d.filter(p=>Math.abs(p.x)===Math.abs(p.y));for(let i=0;i<diag.length;i++)for(let j=i+1;j<diag.length;j++){const p1=diag[i],p2=diag[j];if(Math.abs(p1.x-p2.x)<=2){ctx.beginPath();ctx.moveTo(cx+p1.x*sc,cy-p1.y*sc);ctx.lineTo(cx+p2.x*sc,cy-p2.y*sc);ctx.stroke();}}}}
let prim=0,inCircCount=0,outCircCount=0;const gcds=pts2d.map(p=>p.g);
for(let idx=0;idx<pts2d.length;idx++){const pt=pts2d[idx];if(pt.p)prim++;if(sh==='both'){if(pt.inCircle)inCircCount++;else outCircCount++;}
let px,py;
if(smithEnabled){const theta=Math.atan2(pt.y,pt.x);const dist=Math.sqrt(pt.x*pt.x+pt.y*pt.y);let r=1;if(smithRMode==='index')r=1+(idx/pts2d.length)*2;else if(smithRMode==='dist')r=0.5+dist/(R*2);const sm=smithTransform(r,theta,smithAlpha);px=cx+sm.x*smithRad;py=cy-sm.y*smithRad;}
else{px=cx+pt.x*sc;py=cy-pt.y*sc;}
let clr;if(col==='gcd')clr={1:'#00d9ff',2:'#64c8ff',3:'#9664ff'}[pt.g]||'#ff6496';
else if(col==='dist'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`hsl(${Math.floor((1-d)*240)},100%,50%)`;}
else if(col==='prim')clr=pt.p?'#00d9ff':'#ff6496';
else if(col==='rainbow'){const ang=Math.atan2(pt.y,pt.x);clr=`hsl(${Math.floor((ang+Math.PI)/(2*Math.PI)*360)},100%,50%)`;}
else if(col==='quadres'){const n2=(pt.x*pt.x+pt.y*pt.y)%Math.max(2,Math.ceil(R)),isQR=n2===0||[...Array(Math.ceil(R))].some((_,i)=>(i*i)%Math.max(2,Math.ceil(R))===n2);clr=isQR?'#ffd700':'#9664ff';}
else if(col==='primality'){const prod=Math.abs(pt.x*pt.y),isPr=prod>1&&[...Array(Math.floor(Math.sqrt(prod))+1)].every((_,i)=>i<2||prod%i!==0);clr=prod<=1?'#64c8ff':isPr?'#00ff88':'#ff6496';}
else if(col==='moddist'){const md=Math.min(Math.abs(pt.x),Math.abs(pt.y));clr=`hsl(${Math.floor(md/R*300)},100%,50%)`;}
else if(col==='symmetry'){const sym=Math.abs(Math.abs(pt.x)-Math.abs(pt.y));clr=sym===0?'#ffd700':`hsl(${Math.floor(sym/R*240)},80%,50%)`;}
else if(col==='heatmap'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=d<.25?'#00008b':d<.5?'#00d9ff':d<.75?'#ffff00':'#ff0000';}
else if(col==='divisibility'){const dc=[...Array(pt.g)].filter((_,i)=>i>0&&pt.g%i===0).length+1;clr=`hsl(${dc*40},100%,50%)`;}
else if(col==='discrete'){const cols=['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000075','#808080'];clr=cols[(pt.g-1)%cols.length];}
else if(col==='fire'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=d<.33?`rgb(${Math.floor(d*3*255)},0,0)`:d<.66?`rgb(255,${Math.floor((d-.33)*3*255)},0)`:`rgb(255,${Math.floor(128+(d-.66)*3*127)},${Math.floor((d-.66)*3*255)})`;}
else if(col==='plasma'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`rgb(${Math.floor(13+d*230)},${Math.floor(8+d*92+Math.sin(d*Math.PI)*100)},${Math.floor(135+d*80-d*d*150)})`;}
else if(col==='viridis'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`rgb(${Math.floor(68+d*187)},${Math.floor(1+d*206)},${Math.floor(84-d*50+d*d*100)})`;}
else if(col==='ocean'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y)/R;clr=`rgb(${Math.floor(d*100)},${Math.floor(50+d*150)},${Math.floor(100+d*155)})`;}
else clr=pt.p?'#00d9ff':'#ff6496';

// Modular overlay coloring (overrides if enabled)
if(modEnabled){
let modVal;
if(modColBy==='sum')modVal=((pt.x%modM+modM)+(pt.y%modM+modM))%modM;
else if(modColBy==='product')modVal=((pt.x%modM+modM)*(pt.y%modM+modM))%modM;
else if(modColBy==='diff')modVal=Math.abs((pt.x%modM+modM)-(pt.y%modM+modM))%modM;
else if(modColBy==='gcdmod')modVal=pt.g%modM;
else if(modColBy==='coprime'){modVal=gcd(Math.abs(pt.x)+Math.abs(pt.y),modM)===1?1:0;}
else modVal=0;
if(modColBy==='coprime'){clr=modVal===1?'#00ff88':'#ff4040';}
else{clr=`hsl(${(modVal/modM)*360},75%,55%)`;}}

if(sh==='both'&&!pt.inCircle){clr=isDark()?'rgba(255,100,150,0.4)':'rgba(200,50,100,0.4)';}
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(px,py,ptSz,0,2*Math.PI);ctx.fill();
if(lbl==='coords'){ctx.fillStyle=isDark()?'rgba(0,217,255,0.9)':'rgba(0,102,204,0.9)';ctx.font=`bold ${lblsz}px Arial`;ctx.textAlign='center';ctx.fillText(`(${pt.x},${pt.y})`,px,py-7*zm);}
else if(lbl==='gcd'){ctx.fillStyle=isDark()?'rgba(0,217,255,0.9)':'rgba(0,102,204,0.9)';ctx.font=`bold ${lblsz}px Arial`;ctx.textAlign='center';ctx.fillText(pt.g,px,py-7*zm);}}
if(smithEnabled){ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';ctx.fillText('Smith Chart: Œì = (z-1)/(z+1)',10,20);ctx.fillText(`Œ± = ${smithAlpha}¬∞`,10,35);}
const tot=pts2d.length,th=theory(R,2),err=Math.abs(prim-th),relE=th>0?err/th*100:0,z2=zeta(2);
if(sh==='both'){legend('al2d','Square + Circle Comparison',[['In Circle',inCircCount,'#ff8c00'],['Outside',outCircCount,'#9664ff'],['Circle Ratio',fmt(100*inCircCount/tot)+'%','#ff8c00']]);
document.getElementById('st2d').innerHTML='';}
else{legend('al2d',smithEnabled?'Smith Chart':'2D Lattice',[['1/Œ∂(2) Pred',fmt(tot/z2),'#9664ff'],['Theory',fmt(th),'#ff8c00'],['Error',fmt(err),'#ff006e']]);
document.getElementById('st2d').innerHTML='';}
const gcdDist={};gcds.forEach(g=>{gcdDist[g]=(gcdDist[g]||0)+1;});const gcdKeys=Object.keys(gcdDist).sort((a,b)=>+a-+b);
const baselRatio=z2>0?(prim/tot)/(1/z2):0;
document.getElementById('stats2dLive').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: 2D Lattice | FIELD: ‚Ñ§¬≤ | TYPE: Primitive Lattice Points</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;font-size:.75rem">
<span>R: <strong style="color:#00d9ff">${R}</strong></span>
<span>Shape: <strong style="color:#ffd700">${sh}</strong></span>
<span>Color: <strong style="color:#00ff88">${col}</strong></span>
<span>Zoom: <strong style="color:#ff6496">${zm}x</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00d9ff">${R}</div><div style="font-size:.75rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#ffd700">${tot}</div><div style="font-size:.75rem;color:var(--txt2)">TOTAL POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00ff88">${prim}</div><div style="font-size:.75rem;color:var(--txt2)">PRIMITIVE</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#9664ff">${fmt(th)}</div><div style="font-size:.65rem;color:var(--txt2)">PREDICTED</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ff8c00">${fmt(tot/z2)}</div><div style="font-size:.65rem;color:var(--txt2)">BASEL PRED</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:${err<5?'#00ff88':'#ff6496'}">${fmt(err)}</div><div style="font-size:.65rem;color:var(--txt2)">ERROR</div></div>
</div>
${sh==='both'?`<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Square vs Circle Comparison</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>In Circle:</span><span style="color:#ff8c00;font-weight:bold">${inCircCount}</span>
<span>Outside Circle:</span><span style="color:#9664ff;font-weight:bold">${outCircCount}</span>
<span>Circle Ratio:</span><span style="color:#ff8c00">${fmt(100*inCircCount/tot)}%</span>
<span>œÄ/4 ‚âà:</span><span style="color:#9664ff">${fmt(Math.PI/4*100)}%</span>
<span>Difference:</span><span style="color:${Math.abs(inCircCount/tot-Math.PI/4)<0.05?'#00ff88':'#ff6496'}">${fmt(Math.abs(100*inCircCount/tot-Math.PI/4*100))}%</span>
</div>
</div>`:''}
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Shape:</span><span style="color:var(--txt)">${sh==='circle'?'Circle':sh==='square'?'Square':'Both'}</span>
<span>Color Mode:</span><span style="color:var(--txt)">${col}</span>
<span>Zoom Level:</span><span style="color:var(--txt)">${zm}x</span>
<span>Point Size:</span><span style="color:var(--txt)">${ptSz}px</span>
${smithEnabled?`<span>Smith Chart:</span><span style="color:#00ff88">ON (Œ±=${smithAlpha}¬∞)</span>`:`<span>Smith Chart:</span><span style="color:#ff6496">OFF</span>`}
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Basel Problem Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Coprime Density:</span><span style="color:#ffd700;font-weight:bold">${fmt(100*prim/tot)}%</span>
<span>Basel Limit (6/œÄ¬≤):</span><span style="color:#9664ff">${fmt(100/z2)}%</span>
<span>Ratio to Basel:</span><span style="color:${baselRatio>0.95&&baselRatio<1.05?'#00ff88':'#ff8c00'}">${fmt(baselRatio*100)}%</span>
<span>Predicted Count:</span><span style="color:#9664ff">${fmt(tot/z2)}</span>
<span>Theory (2D):</span><span style="color:#ff8c00">${fmt(th)}</span>
<span>Abs Error:</span><span style="color:${err<5?'#00ff88':'#ff6496'}">${fmt(err)}</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">GCD Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Min GCD:</span><span style="color:var(--txt)">${gcds.reduce((a,b)=>Math.min(a,b),Infinity)}</span>
<span>Max GCD:</span><span style="color:var(--txt)">${gcds.reduce((a,b)=>Math.max(a,b),0)}</span>
<span>Avg GCD:</span><span style="color:var(--txt)">${fmt(gcds.reduce((a,b)=>a+b,0)/tot)}</span>
<span>Unique GCDs:</span><span style="color:var(--txt)">${gcdKeys.length}</span>
</div>
<div style="margin-top:8px;font-size:.75rem">
${gcdKeys.slice(0,6).map(g=>`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:${+g===1?'#ffd700':+g===2?'#00d9ff':'#9664ff'};color:#000;font-weight:bold">GCD=${g}: ${gcdDist[g]}</span>`).join('')}
${gcdKeys.length>6?'<span style="color:var(--txt2)">...</span>':''}
</div>
</div>
<div>
<strong style="color:var(--acc)">Quick Properties</strong>
<div style="margin-top:6px;font-size:.8rem;line-height:1.6">
‚Ä¢ Area covered: ${sh==='circle'?`œÄR¬≤ ‚âà ${fmt(Math.PI*R*R)}`:`(2R+1)¬≤ = ${(2*Math.ceil(R)+1)**2}`}<br>
‚Ä¢ Points per unit area: ${fmt(tot/(sh==='circle'?Math.PI*R*R:(2*R+1)**2))}<br>
‚Ä¢ Primitive per unit: ${fmt(prim/(sh==='circle'?Math.PI*R*R:(2*R+1)**2))}<br>
‚Ä¢ Œ∂(2) = œÄ¬≤/6 ‚âà ${fmt(z2)}
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);for(let idx=0;idx<pts2d.length;idx++){const pt=pts2d[idx];let px,py;if(smithEnabled){const theta=Math.atan2(pt.y,pt.x);const dist=Math.sqrt(pt.x*pt.x+pt.y*pt.y);let r=1;if(smithRMode==='index')r=1+(idx/pts2d.length)*2;else if(smithRMode==='dist')r=0.5+dist/(R*2);const sm=smithTransform(r,theta,smithAlpha);px=cx+sm.x*smithRad;py=cy-sm.y*smithRad;}else{px=cx+pt.x*sc;py=cy-pt.y*sc;}if(Math.hypot(mx-px,my-py)<12){const theta=Math.atan2(pt.y,pt.x);const sm=smithEnabled?smithTransform(1,theta,smithAlpha):{x:0,y:0};modal('2D Point Analysis',[['Coordinates',`(${pt.x}, ${pt.y})`],['GCD(x,y)',pt.g],['Primitive',pt.p?'Yes':'No'],['Distance',Math.sqrt(pt.x*pt.x+pt.y*pt.y)],['Œ∏ (radians)',theta.toFixed(4)],smithEnabled?['Œì (Smith)',`${sm.x.toFixed(4)} + ${sm.y.toFixed(4)}i`]:['Norm',pt.x*pt.x+pt.y*pt.y]]);break;}}};
}catch(e){console.error('draw2D error:',e);}}
function exp2D(){const c=document.getElementById('c2d');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='mobius_2d.png';a.click();});}
function csv2D(){let s='x,y,gcd,primitive\n';for(const p of pts2d)s+=`${p.x},${p.y},${p.g},${p.p}\n`;dl(s,'mobius_2d.csv');}

// Comprehensive screenshot helper
function extractDashboardData(dashId){
const dash=document.getElementById(dashId);if(!dash)return{cards:[],sections:[]};
const cards=[],sections=[];
dash.querySelectorAll('[style*="grid-template-columns:repeat(3"]>div').forEach(card=>{
const val=card.querySelector('div:first-child');
const lbl=card.querySelector('div:last-child');
if(val&&lbl)cards.push({value:val.textContent,label:lbl.textContent,color:val.style.color||'#00d9ff'});
});
dash.querySelectorAll('[style*="border-bottom"]').forEach(sec=>{
const title=sec.querySelector('strong');
const items=[];
sec.querySelectorAll('[style*="grid-template-columns:1fr 1fr"]>span').forEach((span,i,arr)=>{
if(i%2===0&&arr[i+1])items.push({key:span.textContent,val:arr[i+1].textContent,color:arr[i+1].style.color||'inherit'});
});
if(title)sections.push({title:title.textContent,items});
});
return{cards,sections};
}

// Universal screenshot helper for consistent format across all tabs
async function screenshotUnified(canvasId, dashId, title, filename, options={}){
const c=document.getElementById(canvasId);
if(!c)return console.error('Canvas not found:',canvasId);
const dashData=extractDashboardData(dashId);
const scale=options.scale||2;
const pad=options.pad||30;
const dashH=options.dashH||350;
const legendText=options.legend||'';
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;
out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
// Background
ctx.fillStyle=isDk?'#0d1321':'#ffffff';
ctx.fillRect(0,0,out.width/scale,out.height/scale);
// Title
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';
ctx.font='bold 18px Segoe UI';
ctx.textAlign='center';
ctx.fillText(title,out.width/scale/2,pad);
// Canvas
ctx.drawImage(c,pad,pad+25,c.width,c.height);
// Dashboard background
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';
ctx.fillRect(pad,dashY-10,c.width,dashH);
// Dashboard content
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
// Optional legend text
if(legendText){
ctx.fillStyle=isDk?'#ffd700':'#cc8800';
ctx.font='12px Segoe UI';
ctx.fillText(legendText,pad+10,out.height/scale-30);
}
// Footer
ctx.fillStyle=isDk?'#506080':'#888';
ctx.font='10px Segoe UI';
ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
// Export
out.toBlob(b=>{
const a=document.createElement('a');
a.href=URL.createObjectURL(b);
a.download=filename;
a.click();
},'image/png',1.0);
}

// === COMPREHENSIVE SCREENSHOT SYSTEM ===

// Screenshot single canvas
async function screenshotCanvas(canvasId, title, filename){
const c=document.getElementById(canvasId);
if(!c)return alert('Canvas not found');
const scale=2,pad=30;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;
out.height=(c.height+pad*2+40)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
ctx.fillStyle=canvBg();ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 16px Segoe UI';ctx.textAlign='center';
ctx.fillText(title,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+20,c.width,c.height);
ctx.fillStyle=isDark()?'#506080':'#888';ctx.font='10px Segoe UI';
ctx.fillText('M√∂bius Shell Sieve',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();},'image/png',1.0);
}

// Screenshot single Plotly chart
async function screenshotChart(plotId, title, filename){
const p=document.getElementById(plotId);
if(!p||!p.offsetWidth)return alert('Chart not ready');
const img=await Plotly.toImage(p,{format:'png',width:p.offsetWidth*2,height:p.offsetHeight*2,scale:2});
const scale=2,pad=30;
const loaded=await new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=img;});
const out=document.createElement('canvas');
out.width=loaded.width+pad*2*scale;
out.height=loaded.height+pad*2*scale+40*scale;
const ctx=out.getContext('2d');
ctx.fillStyle=canvBg();ctx.fillRect(0,0,out.width,out.height);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font=`bold ${16*scale}px Segoe UI`;ctx.textAlign='center';
ctx.fillText(title,out.width/2,pad*scale);
ctx.drawImage(loaded,pad*scale,pad*scale+20*scale);
ctx.fillStyle=isDark()?'#506080':'#888';ctx.font=`${10*scale}px Segoe UI`;
ctx.fillText('M√∂bius Shell Sieve',out.width/2,out.height-10*scale);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();},'image/png',1.0);
}

// Screenshot stats dashboard only
async function screenshotStats(dashId, title, filename){
const dashData=extractDashboardData(dashId);
const scale=2,pad=30,w=600,h=400;
const out=document.createElement('canvas');
out.width=(w+pad*2)*scale;out.height=(h+pad*2)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 16px Segoe UI';ctx.textAlign='center';
ctx.fillText(title+' ‚Äî Statistics',out.width/scale/2,pad);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad,pad+25,w,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();},'image/png',1.0);
}

// Screenshot ALL elements on a tab (canvases + charts + stats)
async function screenshotTabAll(config){
const {canvases=[], charts=[], dashId, title, filename} = config;
const scale=2, pad=30, gap=20, chartH=300;
const loadedCanvases=canvases.map(id=>document.getElementById(id)).filter(c=>c);
const loadedCharts=charts.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
const dashData=dashId?extractDashboardData(dashId):{cards:[],sections:[]};
const isDk=isDark();

// Calculate dimensions
let totalH=60; // title
const canvasH=loadedCanvases.length?Math.max(...loadedCanvases.map(c=>c.height))+gap:0;
const canvasW=loadedCanvases.length?loadedCanvases.reduce((a,c)=>a+c.width+gap,0)-gap:0;
totalH+=canvasH;

// Charts in 2 columns
const chartRows=Math.ceil(loadedCharts.length/2);
const chartTotalH=chartRows*(chartH+gap);
totalH+=chartTotalH;

// Dashboard
const dashH=dashData.cards.length||dashData.sections.length?300:0;
totalH+=dashH;
totalH+=pad*2+40; // padding + footer

const totalW=Math.max(canvasW,800)+pad*2;

// Create output canvas
const out=document.createElement('canvas');
out.width=totalW*scale;
out.height=totalH*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);

// Background
ctx.fillStyle=isDk?'#0d1321':'#ffffff';
ctx.fillRect(0,0,totalW,totalH);

// Title
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';
ctx.font='bold 20px Segoe UI';ctx.textAlign='center';
ctx.fillText(title+' ‚Äî Complete Export',totalW/2,pad+15);
let cy=pad+40;

// Draw canvases side by side
if(loadedCanvases.length){
let cx=pad;
loadedCanvases.forEach(c=>{
ctx.drawImage(c,cx,cy,c.width,c.height);
cx+=c.width+gap;
});
cy+=canvasH;
}

// Draw charts in 2-column grid
if(loadedCharts.length){
const chartW=(totalW-pad*2-gap)/2;
const chartImgs=await Promise.all(loadedCharts.map(p=>Plotly.toImage(p,{format:'png',width:chartW,height:chartH,scale:2})));
const chartLoaded=await Promise.all(chartImgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
chartLoaded.forEach((img,i)=>{
const col=i%2, row=Math.floor(i/2);
const x=pad+col*(chartW+gap);
const y=cy+row*(chartH+gap);
ctx.drawImage(img,x,y,chartW,chartH);
});
cy+=chartTotalH;
}

// Draw dashboard
if(dashH){
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';
ctx.fillRect(pad,cy,totalW-pad*2,dashH-20);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,cy+15,totalW-pad*2-20,isDk);
cy+=dashH;
}

// Footer
ctx.fillStyle=isDk?'#506080':'#888';
ctx.font='11px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî @7dview ‚Äî wessengetachew.github.io',totalW/2,totalH-15);

out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();},'image/png',1.0);
}

// Tab-specific export all functions
function exportAll2D(){screenshotTabAll({canvases:['c2d'],dashId:'stats2dLive',title:'2D Lattice Points',filename:'2d_lattice_all.png'});}
function exportAll3D(){screenshotTabAll({canvases:['c3d'],dashId:'stats3dLive',title:'3D Lattice Points',filename:'3d_lattice_all.png'});}
function exportAllErr(){screenshotTabAll({charts:['pe1','pe2','pe3','pe4'],dashId:'errLiveStats',title:'Error Analysis',filename:'error_all.png'});}
function exportAllMob(){screenshotTabAll({canvases:['cmob'],charts:['pmob1','pmob2'],dashId:'mobLiveStats',title:'M√∂bius Function',filename:'mobius_all.png'});}
function exportAllDim(){screenshotTabAll({charts:['pdimNew','pdimDens','pdimVol'],dashId:'dimLiveStats',title:'Higher Dimensions',filename:'dimensions_all.png'});}
function exportAllSh(){screenshotTabAll({charts:['psh1','psh2','psh3'],dashId:'shLiveStats',title:'Shell Analysis',filename:'shells_all.png'});}
function exportAllGCD(){screenshotTabAll({canvases:['cgcd'],charts:['pgcd1','pgcd2'],dashId:'gcdLiveStats',title:'GCD Distribution',filename:'gcd_all.png'});}
function exportAllGaus(){screenshotTabAll({canvases:['cgaus'],dashId:'gausLiveStats',title:'Gaussian Integers',filename:'gaussian_all.png'});}
function exportAllCirc(){screenshotTabAll({canvases:['ccirc'],charts:['pcirc1','pcirc2','pcirc3'],dashId:'circLiveStats',title:'Circle Problem',filename:'circle_all.png'});}
function exportAllDens(){screenshotTabAll({charts:['pdens1','pdens2','pdens3'],dashId:'densLiveStats',title:'Density 1/Œ∂(k)',filename:'density_all.png'});}
function exportAllCay(){screenshotTabAll({canvases:['ccay'],dashId:'cayLiveStats',title:'Cayley Transform',filename:'cayley_all.png'});}
function exportAllPrim(){screenshotTabAll({canvases:['cprim'],charts:['pprim1'],dashId:'primLiveStats',title:'Primitive Roots',filename:'primroot_all.png'});}
function exportAllFarey(){screenshotTabAll({canvases:['cfarey'],charts:['pfarey1'],dashId:'fareyLiveStats',title:'Farey Sequence',filename:'farey_all.png'});}
function exportAllMod(){screenshotTabAll({canvases:['cmod'],dashId:'modLiveStats',title:'Modular Rings',filename:'modular_all.png'});}
function exportAllDir(){screenshotTabAll({canvases:['cdir'],charts:['pdir1','pdir2'],dashId:'dirLiveStats',title:'Dirichlet Characters',filename:'dirichlet_all.png'});}
function exportAllTwin(){screenshotTabAll({canvases:['ctwin'],charts:['ptwin1','ptwin2'],dashId:'twinLiveStats',title:'Twin Primes',filename:'twin_all.png'});}
function exportAllPi(){screenshotTabAll({canvases:['cpi'],charts:['ppi1','ppi2'],dashId:'piLiveStats',title:'Prime Counting œÄ(x)',filename:'pi_all.png'});}
function exportAllComp(){screenshotTabAll({canvases:['ccomp'],charts:['pcomp1'],dashId:'compLiveStats',title:'Composite Channels',filename:'composite_all.png'});}
function exportAllCopair(){screenshotTabAll({canvases:['ccopair'],charts:['pcopair1','pcopair2'],dashId:'copairLiveStats',title:'Coprime Pairs',filename:'coprime_all.png'});}
function exportAllSierp(){screenshotTabAll({canvases:['csierp'],charts:['psierp1'],dashId:'sierpLiveStats',title:'Sierpi≈Ñski',filename:'sierpinski_all.png'});}
function exportAllKfree(){screenshotTabAll({canvases:['ckfree'],charts:['pkfree1','pkfree2'],dashId:'kfreeLiveStats',title:'k-Free Integers',filename:'kfree_all.png'});}
function exportAllEuler(){screenshotTabAll({canvases:['ceuler'],charts:['peuler1','peuler2'],dashId:'eulerLiveStats',title:'Euler Product',filename:'euler_all.png'});}
function exportAllChord(){screenshotTabAll({canvases:['cchord'],charts:['pchord1'],dashId:'chordLiveStats',title:'Chord Uniformity',filename:'chord_all.png'});}
function exportAllGold(){screenshotTabAll({canvases:['cgold'],charts:['pgold'],dashId:'goldLiveStats',title:'Goldbach Conjecture',filename:'goldbach_all.png'});}
function exportAllGap(){screenshotTabAll({canvases:['cgap'],charts:['pgap1','pgap2'],dashId:'gapLiveStats',title:'Prime Gaps',filename:'gap_all.png'});}
function exportAllSoph(){screenshotTabAll({canvases:['csoph'],charts:['psoph1'],dashId:'sophLiveStats',title:'Sophie Germain',filename:'sophie_all.png'});}
function exportAllMert(){screenshotTabAll({canvases:['cmert'],charts:['pmertRatio','pmertDist'],dashId:'mertLiveStats',title:'Mertens M(x)',filename:'mertens_all.png'});}
function exportAllCheb(){screenshotTabAll({canvases:['ccheb'],charts:['pcheb1','pcheb2'],dashId:'chebLiveStats',title:'Chebyshev œà(x)',filename:'chebyshev_all.png'});}
function exportAllLi(){screenshotTabAll({canvases:['cli'],charts:['pli1','pli2'],dashId:'liLiveStats',title:'Logarithmic Integral',filename:'li_all.png'});}
function exportAllDiv(){screenshotTabAll({canvases:['cdiv'],charts:['pdiv1','pdiv2'],dashId:'divLiveStats',title:'Divisor Function',filename:'divisor_all.png'});}
function exportAllLiou(){screenshotTabAll({canvases:['cliou'],charts:['pliou1','pliou2'],dashId:'liouLiveStats',title:'Liouville Œª(n)',filename:'liouville_all.png'});}
function exportAllMang(){screenshotTabAll({canvases:['cmang'],charts:['pmang1','pmang2'],dashId:'mangLiveStats',title:'Mangoldt Œõ(n)',filename:'mangoldt_all.png'});}
function exportAllRam(){screenshotTabAll({canvases:['cram'],charts:['pram1'],dashId:'ramLiveStats',title:'Ramanujan Sums',filename:'ramanujan_all.png'});}
function exportAllUlam(){screenshotTabAll({canvases:['culam'],dashId:'ulamLiveStats',title:'Ulam Spiral',filename:'ulam_all.png'});}
function exportAllSacks(){screenshotTabAll({canvases:['csacks'],dashId:'sacksLiveStats',title:'Sacks Spiral',filename:'sacks_all.png'});}
function exportAllHardy(){screenshotTabAll({canvases:['chardy'],charts:['phardyZeros','phardyGrowth'],dashId:'hardyLiveStats',title:'Hardy Z(t)',filename:'hardy_all.png'});}
function exportAllGram(){screenshotTabAll({canvases:['cgram'],charts:['pgram1'],dashId:'gramLiveStats',title:'Gram Points',filename:'gram_all.png'});}
function exportAllExplicit(){screenshotTabAll({canvases:['cexplicit'],charts:['pexplicit1'],dashId:'explicitLiveStats',title:'Explicit œÄ(x)',filename:'explicit_all.png'});}
function exportAllZcount(){screenshotTabAll({canvases:['czcount'],charts:['pzcount1','pzcount2'],dashId:'zcountLiveStats',title:'N(T) Zero Counting',filename:'zerocount_all.png'});}
function exportAllArgand(){screenshotTabAll({canvases:['cargand'],dashId:'argandLiveStats',title:'Œ∂(s) Argand',filename:'argand_all.png'});}
function exportAllZetareal(){screenshotTabAll({canvases:['czetareal'],dashId:'zetarealLiveStats',title:'Œ∂(s) Real Axis',filename:'zetareal_all.png'});}
function exportAllMont(){screenshotTabAll({charts:['pmontCorr','pmontHist'],dashId:'montLiveStats',title:'Montgomery Correlation',filename:'montgomery_all.png'});}
function exportAllGUE(){screenshotTabAll({charts:['pgueSpacing','pgueHist'],dashId:'gueLiveStats',title:'GUE Statistics',filename:'gue_all.png'});}
function exportAllRace(){screenshotTabAll({canvases:['crace'],charts:['praceCount'],dashId:'raceLiveStats',title:'Prime Races',filename:'primerace_all.png'});}
function exportAllLfunc(){screenshotTabAll({canvases:['clfunc'],charts:['plfunc1'],dashId:'lfuncLiveStats',title:'L-functions',filename:'lfunc_all.png'});}
function exportAllLzero(){screenshotTabAll({canvases:['clfunczeros'],dashId:'lzeroLiveStats',title:'L-function Zeros',filename:'lfunczeros_all.png'});}
function exportAllQuantum(){screenshotTabAll({canvases:['cquantum'],dashId:'quantumLiveStats',title:'Quantum Orbitals',filename:'quantum_all.png'});}

function renderDashboard(ctx,data,x,y,w,isDk){
let cy=y;const pad=15,colW=w/3-pad;
// Cards
if(data.cards.length>0){
data.cards.forEach((card,i)=>{
const cx=x+i*(colW+pad);
ctx.fillStyle=isDk?'#1a1f35':'#f0f0f0';
ctx.fillRect(cx,cy,colW,55);
ctx.fillStyle=card.color;ctx.font='bold 20px Segoe UI';ctx.textAlign='center';
ctx.fillText(card.value,cx+colW/2,cy+28);
ctx.fillStyle=isDk?'#8090b0':'#666';ctx.font='10px Segoe UI';
ctx.fillText(card.label,cx+colW/2,cy+45);
});
cy+=70;
}
ctx.textAlign='left';
// Sections
data.sections.forEach(sec=>{
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 12px Segoe UI';
ctx.fillText(sec.title,x,cy);cy+=18;
const cols=2,itemW=w/cols;
sec.items.forEach((item,i)=>{
const ix=x+(i%cols)*itemW,iy=cy+Math.floor(i/cols)*16;
ctx.fillStyle=isDk?'#8090b0':'#555';ctx.font='11px Segoe UI';
ctx.fillText(item.key,ix,iy);
ctx.fillStyle=item.color!=='inherit'?item.color:(isDk?'#e0e0e0':'#222');
ctx.fillText(item.val,ix+95,iy);
});
cy+=Math.ceil(sec.items.length/cols)*16+15;
});
return cy;
}

async function screenshot2D(){
const R=document.getElementById('r2dv').value,sh=document.getElementById('sh2d').value;
await screenshotUnified('c2d','stats2dLive',`2D Lattice Points ‚Äî R=${R}, Shape: ${sh}`,'mobius_2d_complete.png',{dashH:300});
}

async function screenshot3D(){
const R=document.getElementById('r3dv').value;
await screenshotUnified('c3d','stats3dLive',`3D Ball Lattice Points ‚Äî R=${R}`,'mobius_3d_complete.png',{dashH:320});
}

async function screenshotGaus(){
const R=document.getElementById('rgausv').value,col=document.getElementById('colGaus').value;
await screenshotUnified('cgaus','gausLiveStats',`Gaussian Integers ‚Ñ§[i] ‚Äî R=${R}, Color: ${col}`,'gaussian_complete.png',{dashH:320});
}

function draw3D(){
let R=+document.getElementById('r3dv').value||+document.getElementById('r3d').value;
const maxSafe3D=70;
if(R>maxSafe3D){
const pts=Math.round(4/3*Math.PI*R*R*R);
if(!confirm(`R=${R} will compute ~${pts.toLocaleString()} 3D points which may freeze your browser.\n\nContinue anyway?`)){
R=maxSafe3D;document.getElementById('r3dv').value=R;document.getElementById('r3d').value=Math.min(50,R);
}}
const c=document.getElementById('c3d'),ctx=c.getContext('2d'),col=document.getElementById('col3d').value,vm=document.getElementById('vm3d').value,zm=+document.getElementById('zm3d').value,ps=+document.getElementById('ps3d').value;
const smithEnabled=document.getElementById('smith3d').checked,smithAlpha=+document.getElementById('smithA3d').value,smithRMode=document.getElementById('smithR3d').value;
const smithGrid=document.getElementById('smithGrid3d').checked,smithConstR=document.getElementById('smithCircR3d').checked,smithConstX=document.getElementById('smithArcX3d').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cxS=c.width/2,cyS=c.height/2,smithRad=(c.width/2-40)*zm;
if(smithEnabled){drawSmithGrid(ctx,cxS,cyS,smithRad,smithGrid,smithConstR,smithConstX);ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cxS,cyS,smithRad,0,2*Math.PI);ctx.stroke();}
let rawPts=enum3D(R);
if(vm==='inv')rawPts=rawPts.map(pt=>{const n=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z);if(n>.1){const s=R*R/(n*n);return{x:pt.x*s,y:pt.y*s,z:pt.z*s,g:pt.g,p:pt.p};}return pt;});
const proj=rawPts.map((pt,idx)=>{let x=pt.x,y=pt.y,z=pt.z;
let y1=y*Math.cos(rx)-z*Math.sin(rx),z1=y*Math.sin(rx)+z*Math.cos(rx);y=y1;z=z1;
let x2=x*Math.cos(ry)+z*Math.sin(ry),z2=-x*Math.sin(ry)+z*Math.cos(ry);x=x2;z=z2;
let x3=x*Math.cos(rz)-y*Math.sin(rz),y3=x*Math.sin(rz)+y*Math.cos(rz);x=x3;y=y3;
let px,py;
if(smithEnabled){const theta=Math.atan2(y,x);const dist3d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z);let r=1;if(smithRMode==='index')r=1+(idx/rawPts.length)*2;else if(smithRMode==='dist')r=0.5+dist3d/(R*2);const sm=smithTransform(r,theta,smithAlpha);px=cxS+sm.x*smithRad;py=cyS-sm.y*smithRad;}
else{const fov=500,sc=fov/(z+fov/2);px=c.width/2+(x*sc*zm*15)+panX;py=c.height/2-(y*sc*zm*15)+panY;}
let clr;if(col==='gcd')clr={1:'#00d9ff',2:'#64c8ff',3:'#9664ff'}[pt.g]||'#ff6496';
else if(col==='dist'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`hsl(${Math.floor((1-d)*240)},100%,50%)`;}
else if(col==='prim')clr=pt.p?'#00d9ff':'#ff6496';
else if(col==='rainbow'){const ang=Math.atan2(pt.y,pt.x);clr=`hsl(${Math.floor((ang+Math.PI)/(2*Math.PI)*360)},100%,50%)`;}
else if(col==='quadres'){const n2=(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)%Math.max(2,Math.ceil(R)),isQR=n2===0||[...Array(Math.ceil(R))].some((_,i)=>(i*i)%Math.max(2,Math.ceil(R))===n2);clr=isQR?'#ffd700':'#9664ff';}
else if(col==='primality'){const prod=Math.abs(pt.x*pt.y*pt.z),isPr=prod>1&&[...Array(Math.floor(Math.sqrt(prod))+1)].every((_,i)=>i<2||prod%i!==0);clr=prod<=1?'#64c8ff':isPr?'#00ff88':'#ff6496';}
else if(col==='moddist'){const md=Math.min(Math.abs(pt.x),Math.abs(pt.y),Math.abs(pt.z));clr=`hsl(${Math.floor(md/R*300)},100%,50%)`;}
else if(col==='symmetry'){const vals=[Math.abs(pt.x),Math.abs(pt.y),Math.abs(pt.z)].sort((a,b)=>a-b),sym=vals[2]-vals[0];clr=sym===0?'#ffd700':`hsl(${Math.floor(sym/R*240)},80%,50%)`;}
else if(col==='heatmap'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=d<.25?'#00008b':d<.5?'#00d9ff':d<.75?'#ffff00':'#ff0000';}
else if(col==='divisibility'){const dc=[...Array(pt.g)].filter((_,i)=>i>0&&pt.g%i===0).length+1;clr=`hsl(${dc*40},100%,50%)`;}
else if(col==='discrete'){const cols=['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000075','#808080'];clr=cols[(pt.g-1)%cols.length];}
else if(col==='fire'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=d<.33?`rgb(${Math.floor(d*3*255)},0,0)`:d<.66?`rgb(255,${Math.floor((d-.33)*3*255)},0)`:`rgb(255,${Math.floor(128+(d-.66)*3*127)},${Math.floor((d-.66)*3*255)})`;}
else if(col==='plasma'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`rgb(${Math.floor(13+d*230)},${Math.floor(8+d*92+Math.sin(d*Math.PI)*100)},${Math.floor(135+d*80-d*d*150)})`;}
else if(col==='viridis'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`rgb(${Math.floor(68+d*187)},${Math.floor(1+d*206)},${Math.floor(84-d*50+d*d*100)})`;}
else if(col==='ocean'){const d=Math.sqrt(pt.x*pt.x+pt.y*pt.y+pt.z*pt.z)/R;clr=`rgb(${Math.floor(d*100)},${Math.floor(50+d*150)},${Math.floor(100+d*155)})`;}
else clr=pt.p?'#00d9ff':'#ff6496';
const fov=500,sc=fov/(z+fov/2);
return{px,py,z,clr,sc:smithEnabled?1:sc*zm,g:pt.g,p:pt.p,ox:pt.x,oy:pt.y,oz:pt.z};});
proj.sort((a,b)=>a.z-b.z);
if(!smithEnabled){ctx.strokeStyle=gridC();ctx.lineWidth=1;
const seg=12;for(let lat=0;lat<seg;lat++)for(let lng=0;lng<seg;lng++){const lat1=(lat/seg)*Math.PI,lng1=(lng/seg)*2*Math.PI,lng2=((lng+1)/seg)*2*Math.PI;
const x1=R*Math.sin(lat1)*Math.cos(lng1),y1=R*Math.cos(lat1),z1=R*Math.sin(lat1)*Math.sin(lng1);
const x2=R*Math.sin(lat1)*Math.cos(lng2),y2=R*Math.cos(lat1),z2=R*Math.sin(lat1)*Math.sin(lng2);
const rot1=(p)=>{let x=p.x,y=p.y,z=p.z;let y1=y*Math.cos(rx)-z*Math.sin(rx),z1=y*Math.sin(rx)+z*Math.cos(rx);y=y1;z=z1;let x2=x*Math.cos(ry)+z*Math.sin(ry),z2=-x*Math.sin(ry)+z*Math.cos(ry);x=x2;z=z2;let x3=x*Math.cos(rz)-y*Math.sin(rz),y3=x*Math.sin(rz)+y*Math.cos(rz);return{x:x3,y:y3,z};};
const pr1=rot1({x:x1,y:y1,z:z1}),pr2=rot1({x:x2,y:y2,z:z2});
const fov=500,sc1=fov/(pr1.z+fov/2),sc2=fov/(pr2.z+fov/2);
const px1=c.width/2+pr1.x*sc1*zm*15+panX,py1=c.height/2-pr1.y*sc1*zm*15+panY;
const px2=c.width/2+pr2.x*sc2*zm*15+panX,py2=c.height/2-pr2.y*sc2*zm*15+panY;
ctx.beginPath();ctx.moveTo(px1,py1);ctx.lineTo(px2,py2);ctx.stroke();}}
for(const p of proj){ctx.fillStyle=p.clr;ctx.beginPath();ctx.arc(p.px,p.py,Math.max(1,ps*p.sc*10),0,2*Math.PI);ctx.fill();}
if(smithEnabled){ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';ctx.fillText('Smith Chart: Œì = (z-1)/(z+1)',10,20);ctx.fillText(`Œ± = ${smithAlpha}¬∞`,10,35);}
pts3d=proj;
const tot=rawPts.length,prim=rawPts.filter(p=>p.p).length,th=theory(R,3),z3=zeta(3);
legend('al3d',`${smithEnabled?'Smith Chart':'3D Ball'} ${vm==='inv'?'(Inverted)':''}`,[['1/Œ∂(3) Pred',fmt(tot/z3),'#9664ff'],['Theory',fmt(th),'#ff8c00']]);
document.getElementById('st3d').innerHTML='';
const gcd3dDist={};rawPts.forEach(p=>{gcd3dDist[p.g]=(gcd3dDist[p.g]||0)+1;});const gcd3dKeys=Object.keys(gcd3dDist).sort((a,b)=>+a-+b);
const basel3dRatio=z3>0?(prim/tot)/(1/z3):0;
const rotXdeg=Math.round(rx*180/Math.PI)%360,rotYdeg=Math.round(ry*180/Math.PI)%360,rotZdeg=Math.round(rz*180/Math.PI)%360;
document.getElementById('stats3dLive').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00d9ff">${R}</div><div style="font-size:.75rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#ffd700">${tot}</div><div style="font-size:.75rem;color:var(--txt2)">TOTAL POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00ff88">${prim}</div><div style="font-size:.75rem;color:var(--txt2)">PRIMITIVE</div></div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">View Settings</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>X-Rotation:</span><span style="color:#ff6496;font-weight:bold">${rotXdeg}¬∞</span>
<span>Y-Rotation:</span><span style="color:#00d9ff;font-weight:bold">${rotYdeg}¬∞</span>
<span>Z-Rotation:</span><span style="color:#ffd700;font-weight:bold">${rotZdeg}¬∞</span>
<span>Zoom Level:</span><span style="color:var(--txt)">${zm}x</span>
<span>View Mode:</span><span style="color:${vm==='inv'?'#ff8c00':'#00ff88'}">${vm==='inv'?'INVERTED':'Normal'}</span>
<span>Auto-Rotate:</span><span style="color:${anim3d?'#00ff88':'#ff6496'}">${anim3d?'ON':'OFF'}</span>
${smithEnabled?`<span>Smith Chart:</span><span style="color:#00ff88">ON (Œ±=${smithAlpha}¬∞)</span>`:`<span>Smith Chart:</span><span style="color:#ff6496">OFF</span>`}
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Basel Problem Analysis (3D)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Coprime Density:</span><span style="color:#ffd700;font-weight:bold">${fmt(100*prim/tot)}%</span>
<span>Basel Limit (1/Œ∂(3)):</span><span style="color:#9664ff">${fmt(100/z3)}%</span>
<span>Ratio to Basel:</span><span style="color:${basel3dRatio>0.9&&basel3dRatio<1.1?'#00ff88':'#ff8c00'}">${fmt(basel3dRatio*100)}%</span>
<span>Predicted Count:</span><span style="color:#9664ff">${fmt(tot/z3)}</span>
<span>Theory (3D):</span><span style="color:#ff8c00">${fmt(th)}</span>
<span>Abs Error:</span><span style="color:${Math.abs(prim-th)<10?'#00ff88':'#ff6496'}">${fmt(Math.abs(prim-th))}</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">GCD Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Min GCD:</span><span style="color:var(--txt)">${rawPts.reduce((m,p)=>Math.min(m,p.g),Infinity)}</span>
<span>Max GCD:</span><span style="color:var(--txt)">${rawPts.reduce((m,p)=>Math.max(m,p.g),0)}</span>
<span>Unique GCDs:</span><span style="color:var(--txt)">${gcd3dKeys.length}</span>
</div>
<div style="margin-top:8px;font-size:.75rem">
${gcd3dKeys.slice(0,6).map(g=>`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:${+g===1?'#ffd700':+g===2?'#00d9ff':'#9664ff'};color:#000;font-weight:bold">GCD=${g}: ${gcd3dDist[g]}</span>`).join('')}
${gcd3dKeys.length>6?'<span style="color:var(--txt2)">...</span>':''}
</div>
</div>
<div>
<strong style="color:var(--acc)">Quick Properties</strong>
<div style="margin-top:6px;font-size:.8rem;line-height:1.6">
‚Ä¢ Volume: (4/3)œÄR¬≥ ‚âà ${fmt(4/3*Math.PI*R*R*R)}<br>
‚Ä¢ Points per unit vol: ${fmt(tot/(4/3*Math.PI*R*R*R))}<br>
‚Ä¢ Œ∂(3) ‚âà ${fmt(z3)} (Ap√©ry's constant)<br>
‚Ä¢ 1/Œ∂(3) ‚âà ${fmt(1/z3)} (coprime prob)
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);for(const p of[...proj].reverse())if(Math.hypot(mx-p.px,my-p.py)<10){const theta=Math.atan2(p.oy,p.ox);const sm=smithEnabled?smithTransform(1,theta,smithAlpha):{x:0,y:0};modal('3D Point Analysis',[['Position',`(${fmt(p.ox)}, ${fmt(p.oy)}, ${fmt(p.oz)})`],['GCD',p.g],['Primitive',p.p?'Yes':'No'],['Distance',Math.sqrt(p.ox*p.ox+p.oy*p.oy+p.oz*p.oz)],smithEnabled?['Œì (Smith)',`${sm.x.toFixed(4)} + ${sm.y.toFixed(4)}i`]:['Z-depth',p.z]]);break;}};}
let drag=false,rmd=false,lx,ly;
function syncRotInputs(){document.getElementById('rotX').value=Math.round(rx*180/Math.PI)%360;document.getElementById('rotY').value=Math.round(ry*180/Math.PI)%360;document.getElementById('rotZ').value=Math.round(rz*180/Math.PI)%360;document.getElementById('rotXr').value=Math.round(rx*180/Math.PI)%360;document.getElementById('rotYr').value=Math.round(ry*180/Math.PI)%360;document.getElementById('rotZr').value=Math.round(rz*180/Math.PI)%360;}
document.getElementById('c3d').onmousedown=e=>{if(e.button===0){drag=true;}else if(e.button===2){rmd=true;}lx=e.clientX;ly=e.clientY;e.preventDefault();};
document.getElementById('c3d').oncontextmenu=e=>e.preventDefault();
document.onmousemove=e=>{if(drag){ry+=(e.clientX-lx)*.01;rx+=(e.clientY-ly)*.01;lx=e.clientX;ly=e.clientY;syncRotInputs();draw3D();}else if(rmd){panX+=(e.clientX-lx);panY+=(e.clientY-ly);lx=e.clientX;ly=e.clientY;draw3D();}};
document.onmouseup=()=>{drag=false;rmd=false;};
document.getElementById('c3d').onwheel=e=>{const z=document.getElementById('zm3d');z.value=Math.max(.2,Math.min(5,+z.value+(e.deltaY>0?-.1:.1)));document.getElementById('zmv').textContent=z.value+'x';draw3D();e.preventDefault();};
setInterval(()=>{if(anim3d){ry+=.015;syncRotInputs();draw3D();}},50);
function csv3D(){let s='x,y,z,gcd,primitive\n';for(const p of enum3D(+document.getElementById('r3dv').value||+document.getElementById('r3d').value))s+=`${p.x},${p.y},${p.z},${p.g},${p.p}\n`;dl(s,'mobius_3d.csv');}

function runErr(){runErrNew();}

function runErrNew(){
const maxR=+document.getElementById('errRv').value||+document.getElementById('errR').value;
const sh=document.getElementById('errSh').value;
const step=+document.getElementById('errStep').value;
const theta=+document.getElementById('errTheta').value;
const showBounds=document.getElementById('errBounds').checked;
const useLog=document.getElementById('errLog').checked;
const compare=document.getElementById('errCompare').value;

const rs=[],totals=[],prims=[],ths=[],primThs=[],errs=[],normErrs=[],relEs=[];
D.err=[];

for(let r=step;r<=maxR;r+=step){
const pts=enum2D(r,sh);
const total=pts.length;
const prim=pts.filter(x=>x.p).length;
const th=sh==='circle'?Math.PI*r*r:(2*Math.floor(r)+1)**2;
const primTh=th/zeta(2);
const err=total-th;
const primErr=prim-primTh;
const normErr=r>0?err/Math.pow(r,theta):0;

rs.push(r);
totals.push(total);
prims.push(prim);
ths.push(th);
primThs.push(primTh);
errs.push(err);
normErrs.push(normErr);
relEs.push(th>0?Math.abs(err)/th*100:0);
D.err.push({r,total,prim,th,primTh,err,primErr,normErr,relE:th>0?Math.abs(err)/th*100:0,sqrtR:Math.abs(err)/Math.sqrt(r)});}

// Statistics
const meanErr=errs.reduce((a,b)=>a+b,0)/errs.length;
const rmsErr=Math.sqrt(errs.reduce((a,b)=>a+b*b,0)/errs.length);
const maxAbsErr=errs.reduce((m,e)=>Math.max(m,Math.abs(e)),0);
const minAbsErr=errs.reduce((m,e)=>Math.min(m,Math.abs(e)),Infinity);

// Chart 1: Theory vs Actual
const traces1=[
{x:rs,y:ths,name:`Theory ${sh==='circle'?'œÄR¬≤':'(2R+1)¬≤'}`,mode:'lines',line:{color:'#ff8c00',width:3}},
{x:rs,y:totals,name:'Actual Total',mode:'markers',marker:{color:'#00d9ff',size:5}}
];
if(compare==='primitive'||compare==='both'){
traces1.push({x:rs,y:primThs,name:'Prim Theory',mode:'lines',line:{color:'#00ff88',width:2,dash:'dash'}});
traces1.push({x:rs,y:prims,name:'Primitive',mode:'markers',marker:{color:'#ffd700',size:4}});}
Plotly.newPlot('pe1',traces1,{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'Count',type:useLog?'log':'linear'}});
legend('ale1','Count Comparison',[['Max Total',totals.reduce((a,b)=>Math.max(a,b),0),'#00d9ff'],['Max Prim',prims.reduce((a,b)=>Math.max(a,b),0),'#ffd700']]);

// Chart 2: Absolute Error
const traces2=[{x:rs,y:errs,name:'Error',mode:'lines+markers',line:{color:'#ff006e',width:2},marker:{size:4}}];
if(showBounds){
traces2.push({x:rs,y:rs.map(r=>Math.sqrt(r)*2),name:'O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});
traces2.push({x:rs,y:rs.map(r=>-Math.sqrt(r)*2),name:'-O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});}
Plotly.newPlot('pe2',traces2,{...plo(),xaxis:{title:'R'},yaxis:{title:'Error N(R)-œÄR¬≤'}});
legend('ale2','Absolute Error',[['Max',fmt(maxAbsErr),'#ff006e'],['RMS',fmt(rmsErr),'#ff8c00']]);

// Chart 3: Relative Error %
Plotly.newPlot('pe3',[{x:rs,y:relEs,mode:'lines+markers',line:{color:'#00ff88',width:2},marker:{size:3}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'|Error|/Theory %',type:useLog?'log':'linear'}});
legend('ale3','Relative Error',[['Max %',fmt(relEs.reduce((a,b)=>Math.max(a,b),0)),'#ff006e'],['Min %',fmt(relEs.reduce((a,b)=>Math.min(a,b),Infinity)),'#00ff88']]);

// Chart 4: Normalized Error
Plotly.newPlot('pe4',[
{x:rs,y:normErrs,name:`Error/R^${theta}`,mode:'lines+markers',line:{color:'#9664ff',width:2},marker:{size:3}},
{x:rs,y:rs.map(()=>0),mode:'lines',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'R'},yaxis:{title:`Error / R^${theta}`}});
const maxNormErr=normErrs.reduce((m,e)=>Math.max(m,Math.abs(e)),0);
legend('ale4','Normalized',[['Œ∏ =',theta,'#9664ff'],['Bounded?',maxNormErr<10?'Yes':'No','#00ff88']]);

// Chart 5: Error histogram
const errBins=[],binSize=Math.max(1,Math.ceil(maxAbsErr/10));
for(let b=-10;b<=10;b++){const lo=b*binSize,hi=(b+1)*binSize;
errBins.push({bin:`${lo}`,count:errs.filter(e=>e>=lo&&e<hi).length});}
Plotly.newPlot('peHist',[{x:errBins.map(b=>b.bin),y:errBins.map(b=>b.count),type:'bar',marker:{color:errBins.map(b=>+b.bin>=0?'#00d9ff':'#ff006e')}}],{...plo(),xaxis:{title:'Error Range'},yaxis:{title:'Frequency'}});

// Live stats
document.getElementById('errLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Error Analysis | FIELD: ‚Ñ§¬≤ Lattice | TYPE: Primitive Point Counting</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;font-size:.75rem">
<span>Max R: <strong style="color:#00d9ff">${maxR}</strong></span>
<span>Shape: <strong style="color:#ffd700">${sh}</strong></span>
<span>Step: <strong style="color:#00ff88">${step}</strong></span>
<span>Œ∏: <strong style="color:#ff6496">${theta}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxR}</div><div style="font-size:.7rem;color:var(--txt2)">MAX R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${D.err.length}</div><div style="font-size:.7rem;color:var(--txt2)">DATA POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${sh}</div><div style="font-size:.7rem;color:var(--txt2)">SHAPE</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#9664ff">${totals[totals.length-1]}</div><div style="font-size:.65rem;color:var(--txt2)">TOTAL COUNT</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ff8c00">${fmt(ths[ths.length-1])}</div><div style="font-size:.65rem;color:var(--txt2)">PREDICTED</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:${Math.abs(errs[errs.length-1])<10?'#00ff88':'#ff6496'}">${fmt(errs[errs.length-1])}</div><div style="font-size:.65rem;color:var(--txt2)">ERROR</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Mean Error:</span><span style="color:#00d9ff">${fmt(meanErr)}</span>
<span>RMS Error:</span><span style="color:#ff8c00">${fmt(rmsErr)}</span>
<span>Max |Error|:</span><span style="color:#ff006e">${fmt(maxAbsErr)}</span>
<span>Min |Error|:</span><span style="color:#00ff88">${fmt(minAbsErr)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Normalized Analysis (Œ∏=${theta})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max |Err|/R^Œ∏:</span><span style="color:#9664ff">${fmt(maxNormErr)}</span>
<span>Avg |Err|/‚àöR:</span><span style="color:#ffd700">${fmt(D.err.reduce((a,d)=>a+d.sqrtR,0)/D.err.length)}</span>
<span>Bounded:</span><span style="color:${maxNormErr<20?'#00ff88':'#ff6496'}">${maxNormErr<20?'Likely':'Unclear'}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Primitive Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Final Prim Count:</span><span style="color:#ffd700">${prims[prims.length-1]}</span>
<span>Theory P(R)/Œ∂(2):</span><span style="color:#ff8c00">${fmt(primThs[primThs.length-1])}</span>
<span>Prim Density:</span><span style="color:#00ff88">${fmt(100*prims[prims.length-1]/totals[totals.length-1])}%</span>
<span>6/œÄ¬≤ theory:</span><span style="color:#9664ff">${fmt(100/zeta(2))}%</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Observations</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Error oscillates around 0 (unbiased)<br>
‚Ä¢ |Error| grows roughly as O(R^0.5)<br>
‚Ä¢ Best known: O(R^0.63)<br>
‚Ä¢ Conjecture: O(R^0.5+Œµ)
</div>
</div>`;

// Table
document.getElementById('te').innerHTML='<tr><th>R</th><th>Theory</th><th>Actual</th><th>Primitive</th><th>Error</th><th>|Err|/‚àöR</th><th>Rel %</th></tr>'+
D.err.map(d=>`<tr onclick="modal('R=${d.r}',[['Total',${d.total}],['Primitive',${d.prim}],['Theory',${fmt(d.th)}],['Error',${fmt(d.err)}],['|Error|/‚àöR',${fmt(d.sqrtR)}],['Rel Error %',${fmt(d.relE)}]])" style="cursor:pointer;color:${Math.abs(d.err)<Math.sqrt(d.r)*2?'#00ff88':'inherit'}"><td>${fmt(d.r)}</td><td>${fmt(d.th)}</td><td>${d.total}</td><td>${d.prim}</td><td>${fmt(d.err)}</td><td>${fmt(d.sqrtR)}</td><td>${fmt(d.relE)}</td></tr>`).join('');}

function runErrConvergence(){
const Rs=[5,10,15,20,30,40,50,75,100];
const sqrtNorm=[];
for(const R of Rs){
const pts=enum2D(R,'circle');
const th=Math.PI*R*R;
const err=pts.length-th;
sqrtNorm.push({R,err,norm:Math.abs(err)/Math.sqrt(R)});}
Plotly.newPlot('pe4',[{x:Rs,y:sqrtNorm.map(d=>d.norm),mode:'lines+markers',line:{color:'#9664ff',width:2}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'|Error|/‚àöR'}});
legend('ale4','Convergence',[['Trend','~constant?','#9664ff']]);}

function csvErr(){let s='R,Theory,Total,Primitive,Error,NormErr,RelError%,SqrtR\n';for(const d of D.err)s+=`${d.r},${d.th},${d.total},${d.prim},${d.err},${d.normErr},${d.relE},${d.sqrtR}\n`;dl(s,'error.csv');}

function runDim(){const R=+document.getElementById('rdim').value;D.dim=[];for(let n=2;n<=7;n++){const v=vol(n),z=zeta(n),th=theory(R,n),prim=Math.round(th),err=Math.abs(prim-th);D.dim.push({n,v,z,th,prim,err});}
document.getElementById('tdimT').innerHTML='<tr><th>n</th><th>Vol(B_n)</th><th>Œ∂(n)</th><th>Theory</th><th>Computed</th><th>Error</th></tr>'+D.dim.map(d=>`<tr onclick="modal('Dimension ${d.n}',[['Volume',${d.v}],['Œ∂(${d.n})',${d.z}],['1/Œ∂(${d.n})',${1/d.z}],['Theory',${d.th}]])" style="cursor:pointer"><td>${d.n}</td><td>${fmt(d.v)}</td><td>${fmt(d.z)}</td><td>${fmt(d.th)}</td><td>${d.prim}</td><td>${fmt(d.err)}</td></tr>`).join('');
legend('aldim','Primitive Density 1/Œ∂(k)',D.dim.map(d=>[`n=${d.n}`,1/d.z,`hsl(${d.n*50},100%,50%)`]));}
function csvDim(){let s='n,Vol,Zeta,Theory,Computed,Error\n';for(const d of D.dim)s+=`${d.n},${d.v},${d.z},${d.th},${d.prim},${d.err}\n`;dl(s,'dimensions.csv');}

// M√∂bius function - heart of the sieve
function mobius(n){if(n===1)return 1;let cnt=0;for(let p=2;p*p<=n;p++){if(n%p===0){cnt++;n/=p;if(n%p===0)return 0;}}if(n>1)cnt++;return cnt%2===0?1:-1;}
function factorize(n){if(n===1)return '1';const f=[];for(let p=2;p*p<=n;p++){let e=0;while(n%p===0){e++;n/=p;}if(e>0)f.push(e>1?`${p}^${e}`:p);}if(n>1)f.push(n);return f.join('¬∑');}
function mertens(N){let m=0;for(let n=1;n<=N;n++)m+=mobius(n);return m;}

let mobData=[];
function drawMobius(){
const N=+document.getElementById('mobNv').value||+document.getElementById('mobN').value;
const viz=document.getElementById('mobViz').value,col=document.getElementById('mobCol').value;
const ptSz=+document.getElementById('mobPtSz').value;
const c=document.getElementById('cmob'),ctx=c.getContext('2d');
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
mobData=[];let M=0,sum1=0,cnt1=0,cnt0=0,cntM1=0;
for(let n=1;n<=N;n++){const mu=mobius(n);M+=mu;sum1+=mu/n;const sf=mu!==0;
if(mu===1)cnt1++;else if(mu===0)cnt0++;else cntM1++;
mobData.push({n,mu,M,sum1,sf,fac:factorize(n)});}
const cx=c.width/2,cy=c.height/2;
if(viz==='strip'){
const w=c.width-80,h=c.height-60,cols=Math.ceil(Math.sqrt(N*1.5)),rows=Math.ceil(N/cols);
const dx=w/cols,dy=h/rows;
ctx.font='bold 14px Segoe UI';ctx.fillStyle=isDark()?'#ffd700':'#cc8800';
ctx.fillText('Œº(n): Red=-1, Gray=0, Blue=+1',40,25);
for(let i=0;i<mobData.length;i++){const d=mobData[i],x=40+(i%cols)*dx,y=50+Math.floor(i/cols)*dy;
let clr;if(col==='classic')clr=d.mu===1?'#4ECDC4':d.mu===-1?'#FF6B6B':'#555';
else if(col==='prime'){const pf=factorize(d.n).split('¬∑').length;clr=d.mu===0?'#333':`hsl(${pf*60},80%,55%)`;}
else clr=d.sf?'#ffd700':'#333';
ctx.fillStyle=clr;ctx.fillRect(x,y,dx-1,dy-1);}}
else if(viz==='mertens'){
const maxM=mobData.reduce((m,d)=>Math.max(m,Math.abs(d.M)),0);
const w=c.width-80,h=c.height-80,scX=w/N,scY=(h/2)/(maxM||1);
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(40,cy);ctx.lineTo(c.width-40,cy);ctx.stroke();
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('M(x) = Œ£Œº(n) for n‚â§x',50,30);
ctx.fillText('0',25,cy+4);ctx.fillText(maxM+'',15,55);ctx.fillText(-maxM+'',15,c.height-45);
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
mobData.forEach((d,i)=>{const x=40+d.n*scX,y=cy-d.M*scY;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();
ctx.strokeStyle='rgba(255,100,100,0.5)';ctx.lineWidth=1;
ctx.beginPath();mobData.forEach((d,i)=>{const x=40+d.n*scX,bound=Math.sqrt(d.n);ctx.moveTo(x,cy-bound*scY);ctx.lineTo(x,cy+bound*scY);});ctx.stroke();}
else if(viz==='cumsum'){
const w=c.width-80,h=c.height-80,scX=w/N;
const vals=mobData.map(d=>d.sum1),minV=vals.reduce((a,b)=>Math.min(a,b),Infinity),maxV=vals.reduce((a,b)=>Math.max(a,b),-Infinity);
const scY=h/(maxV-minV||1);
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('Œ£Œº(n)/n ‚Üí 0 as N‚Üí‚àû (equivalent to PNT)',50,30);
ctx.strokeStyle=gridC();ctx.beginPath();ctx.moveTo(40,c.height-40-(0-minV)*scY);ctx.lineTo(c.width-40,c.height-40-(0-minV)*scY);ctx.stroke();
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=2;
mobData.forEach((d,i)=>{const x=40+d.n*scX,y=c.height-40-(d.sum1-minV)*scY;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();}
else if(viz==='spiral'){
const maxR=Math.min(c.width,c.height)/2-30;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='12px Segoe UI';
ctx.fillText('Ulam-like spiral: Œº(n) values',50,30);
for(let i=0;i<mobData.length;i++){const d=mobData[i],ang=Math.sqrt(d.n)*2.4,r=Math.sqrt(d.n)/Math.sqrt(N)*maxR;
const x=cx+r*Math.cos(ang),y=cy+r*Math.sin(ang);
let clr=d.mu===1?'#4ECDC4':d.mu===-1?'#FF6B6B':'#333';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,ptSz/2,0,2*Math.PI);ctx.fill();}}
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='strip'){const w=c.width-80,cols=Math.ceil(Math.sqrt(N*1.5)),dx=w/cols,dy=(c.height-60)/Math.ceil(N/cols);
const col=Math.floor((mx-40)/dx),row=Math.floor((my-50)/dy),idx=row*cols+col;
if(idx>=0&&idx<mobData.length){const d=mobData[idx];modal('M√∂bius Analysis',[['n',d.n],['Œº(n)',d.mu],['M(n)',d.M],['Œ£Œº(k)/k',fmt(d.sum1)],['Factorization',d.fac],['Squarefree',d.sf?'Yes':'No']]);}}};
const sqfreeC=mobData.filter(d=>d.sf).length;
legend('almob','M√∂bius Statistics',[['Œ£Œº(n)/n',fmt(sum1),'#00ff88'],['M(N)',M,'#00d9ff']]);
Plotly.newPlot('pmobDist',[{x:['Œº=1','Œº=0','Œº=-1'],y:[cnt1,cnt0,cntM1],type:'bar',marker:{color:['#4ECDC4','#555','#FF6B6B']}}],{...plo(),xaxis:{title:'Œº(n) value'},yaxis:{title:'Count'}});
document.getElementById('mobLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: M√∂bius Function | FIELD: ‚Ñ§ (Integers) | TYPE: Œº(n) Analysis</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>N: <strong style="color:#00d9ff">${N}</strong></span>
<span>Mode: <strong style="color:#ffd700">${viz}</strong></span>
<span>M(N): <strong style="color:#00ff88">${M}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#4ECDC4">${cnt1}</div><div style="font-size:.7rem;color:var(--txt2)">Œº(n)=+1</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#555">${cnt0}</div><div style="font-size:.7rem;color:var(--txt2)">Œº(n)=0</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#FF6B6B">${cntM1}</div><div style="font-size:.7rem;color:var(--txt2)">Œº(n)=-1</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#9664ff">${sqfreeC}</div><div style="font-size:.6rem;color:var(--txt2)">SQUAREFREE (ACTUAL)</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ff8c00">${Math.round(N*6/Math.PI/Math.PI)}</div><div style="font-size:.6rem;color:var(--txt2)">PREDICTED (6N/œÄ¬≤)</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>N:</span><span style="color:#ffd700;font-weight:bold">${N}</span>
<span>Mertens M(N):</span><span style="color:#00d9ff;font-weight:bold">${M}</span>
<span>Œ£Œº(n)/n:</span><span style="color:#00ff88;font-weight:bold">${fmt(sum1)}</span>
<span>|M(N)|/‚àöN:</span><span style="color:${Math.abs(M)/Math.sqrt(N)<1?'#00ff88':'#ff8c00'}">${fmt(Math.abs(M)/Math.sqrt(N))}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Squarefree Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Squarefree count:</span><span style="color:#ffd700">${sqfreeC}</span>
<span>Squarefree %:</span><span style="color:#00ff88">${fmt(100*sqfreeC/N)}%</span>
<span>Theory 6/œÄ¬≤:</span><span style="color:#9664ff">${fmt(600/Math.PI/Math.PI)}%</span>
<span>Non-squarefree:</span><span style="color:#ff6496">${cnt0}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Riemann Hypothesis Connection</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ RH ‚ü∫ M(x) = O(x^(¬Ω+Œµ)) for all Œµ>0<br>
‚Ä¢ Current bound: |M(N)|/‚àöN = ${fmt(Math.abs(M)/Math.sqrt(N))}<br>
‚Ä¢ Mertens conjecture |M(x)|<‚àöx is FALSE<br>
‚Ä¢ First counterexample: x ‚âà 10^16
</div>
</div>`;
document.getElementById('tmobT').innerHTML='<tr><th>n</th><th>Œº(n)</th><th>M(n)</th><th>Factorization</th><th>Squarefree</th></tr>'+
mobData.slice(0,100).map(d=>`<tr onclick="modal('n=${d.n}',[['Œº(${d.n})',${d.mu}],['M(${d.n})',${d.M}],['Factorization','${d.fac}'],['Squarefree','${d.sf?'Yes':'No'}']])" style="cursor:pointer;color:${d.mu===1?'#4ECDC4':d.mu===-1?'#FF6B6B':'#666'}"><td>${d.n}</td><td>${d.mu}</td><td>${d.M}</td><td>${d.fac}</td><td>${d.sf?'Yes':'No'}</td></tr>`).join('');}
function csvMob(){let s='n,mu,M,sumMuOverN,factorization,squarefree\n';for(const d of mobData)s+=`${d.n},${d.mu},${d.M},${d.sum1},"${d.fac}",${d.sf}\n`;dl(s,'mobius.csv');}
async function screenshotMob(){
const c=document.getElementById('cmob'),dashData=extractDashboardData('mobLiveStats');
const N=document.getElementById('mobNv').value,viz=document.getElementById('mobViz').value;
const scale=2,pad=30,dashH=300;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M√∂bius Function Œº(n) ‚Äî N=${N}, Mode: ${viz}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='mobius_function_complete.png';a.click();},'image/png',1.0);}

// Upgraded Dimension function
function gamma(n){if(n===1)return 1;if(n===0.5)return Math.sqrt(Math.PI);return(n-1)*gamma(n-1);}
function ballVol(n){return Math.pow(Math.PI,n/2)/gamma(n/2+1);}

function runDimNew(){
const maxD=+document.getElementById('dimMaxV').value||+document.getElementById('dimMax').value;
const R=+document.getElementById('rdimv').value||+document.getElementById('rdim').value;
const mode=document.getElementById('dimMode').value;
D.dim=[];const ns=[],zs=[],invZs=[],vols=[],comps=[];
let exactCount=0;

for(let n=2;n<=maxD;n++){
const v=ballVol(n),z=zeta(n),invZ=1/z,th=v*Math.pow(R,n)*invZ;
let computed=Math.round(th),err=0,method='theory';
if(mode==='full'||(mode==='hybrid'&&n<=5)){
if(n===2){let tot=0,prim=0;for(let x=-Math.ceil(R);x<=Math.ceil(R);x++)for(let y=-Math.ceil(R);y<=Math.ceil(R);y++)if(x*x+y*y<=R*R){tot++;if(gcdM(x,y)===1)prim++;}computed=prim;err=Math.abs(prim-th);method='exact';exactCount++;}
else if(n===3){let tot=0,prim=0;const m=Math.ceil(R);for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){tot++;if(gcdM(x,y,z)===1)prim++;}computed=prim;err=Math.abs(prim-th);method='exact';exactCount++;}
else if(n<=5&&R<=8){let tot=0,prim=0;const m=Math.min(Math.ceil(R),5);
(function en(dim,coords){if(coords.length===n){const s=coords.reduce((a,x)=>a+x*x,0);if(s<=R*R){tot++;if(gcdM(...coords)===1)prim++;}return;}for(let i=-m;i<=m;i++)en(dim,[...coords,i]);})(n,[]);
computed=prim;err=Math.abs(prim-th);method='exact';exactCount++;}}
ns.push(n);zs.push(z);invZs.push(invZ);vols.push(v*Math.pow(R,n));comps.push(computed);
D.dim.push({n,v,z,invZ,th,computed,err,method,volRn:v*Math.pow(R,n)});}

// Chart 1: Œ∂(n) convergence
Plotly.newPlot('pdimZeta',[
{x:ns,y:zs,mode:'lines+markers',name:'Œ∂(n)',line:{color:'#ff8c00',width:2},marker:{size:6}},
{x:ns,y:ns.map(()=>1),mode:'lines',name:'Limit=1',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'Dimension n'},yaxis:{title:'Œ∂(n)',range:[0.9,zs.reduce((a,b)=>Math.max(a,b),0)+0.2]}});

// Chart 2: 1/Œ∂(n) density
Plotly.newPlot('pdimDens',[
{x:ns,y:invZs,mode:'lines+markers',name:'1/Œ∂(n)',line:{color:'#00ff88',width:2},marker:{size:6}},
{x:ns,y:ns.map(()=>1),mode:'lines',name:'Limit=1',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'Dimension n'},yaxis:{title:'1/Œ∂(n) = P(coprime)',range:[0.5,1.05]}});

// Chart 3: Volume
Plotly.newPlot('pdimVol',[
{x:ns,y:vols,mode:'lines+markers',name:'Vol(B‚Åø)¬∑R‚Åø',line:{color:'#9664ff',width:2},marker:{size:6}}
],{...plo(),xaxis:{title:'Dimension n'},yaxis:{title:'Volume¬∑R‚Åø',type:maxD>15?'log':'linear'}});

// Find special values
const maxVolIdx=vols.indexOf(vols.reduce((a,b)=>Math.max(a,b),0));
const z2=zeta(2),z3=zeta(3),z4=zeta(4);

// Live stats
document.getElementById('dimLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Higher Dimensions | FIELD: ‚Ñ§·µè Ball | TYPE: Primitive Density 1/Œ∂(k)</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max Dim: <strong style="color:#00d9ff">${maxD}</strong></span>
<span>R: <strong style="color:#ffd700">${R}</strong></span>
<span>Mode: <strong style="color:#00ff88">${mode}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxD}</div><div style="font-size:.7rem;color:var(--txt2)">MAX DIM</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${R}</div><div style="font-size:.7rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${mode}</div><div style="font-size:.7rem;color:var(--txt2)">MODE</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${fmt(1/z2)}</div><div style="font-size:.6rem;color:var(--txt2)">1/Œ∂(2) DENSITY</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff8c00">${fmt(1/z3)}</div><div style="font-size:.6rem;color:var(--txt2)">1/Œ∂(3) DENSITY</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#00ff88">${fmt(1/zeta(maxD))}</div><div style="font-size:.6rem;color:var(--txt2)">1/Œ∂(${maxD}) DENSITY</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Œ∂ Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Œ∂(2) = œÄ¬≤/6:</span><span style="color:#ff8c00">${fmt(z2)}</span>
<span>Œ∂(3) Ap√©ry:</span><span style="color:#00d9ff">${fmt(z3)}</span>
<span>Œ∂(4) = œÄ‚Å¥/90:</span><span style="color:#9664ff">${fmt(z4)}</span>
<span>Œ∂(${maxD}):</span><span style="color:#ffd700">${fmt(zeta(maxD))}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Coprime Densities 1/Œ∂(n)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>1/Œ∂(2) = 6/œÄ¬≤:</span><span style="color:#00ff88">${fmt(1/z2)} (${fmt(100/z2)}%)</span>
<span>1/Œ∂(3):</span><span style="color:#00d9ff">${fmt(1/z3)} (${fmt(100/z3)}%)</span>
<span>1/Œ∂(${maxD}):</span><span style="color:#ffd700">${fmt(1/zeta(maxD))} (${fmt(100/zeta(maxD))}%)</span>
<span>Limit as n‚Üí‚àû:</span><span style="color:#00ff88">1 (100%)</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Volume Analysis (R=${R})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max Vol at n=:</span><span style="color:#9664ff">${ns[maxVolIdx]}</span>
<span>Max Vol value:</span><span style="color:#9664ff">${fmt(vols[maxVolIdx])}</span>
<span>Vol(B¬≤)¬∑R¬≤:</span><span style="color:#00d9ff">${fmt(vols[0])}</span>
<span>Vol(B${maxD})¬∑R^${maxD}:</span><span style="color:#ffd700">${fmt(vols[vols.length-1])}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Computation</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Dimensions:</span><span style="color:var(--txt)">${D.dim.length}</span>
<span>Exact computed:</span><span style="color:#00ff88">${exactCount}</span>
<span>Theory only:</span><span style="color:#ffd700">${D.dim.length-exactCount}</span>
<span>Total primitives:</span><span style="color:#00d9ff">${comps.reduce((a,b)=>a+b,0)}</span>
</div>
</div>`;

// Table
document.getElementById('tdimT').innerHTML='<tr><th>n</th><th>Vol(B‚Åø)</th><th>Œ∂(n)</th><th>1/Œ∂(n)</th><th>Computed</th><th>Error</th><th>Method</th></tr>'+
D.dim.map(d=>`<tr onclick="modal('Dimension ${d.n}',[['Vol(B${d.n})',${d.v}],['Vol√óR^${d.n}',${d.volRn}],['Œ∂(${d.n})',${d.z}],['1/Œ∂(${d.n})',${d.invZ}],['Theory',${d.th}],['Computed',${d.computed}],['Method','${d.method}']])" style="cursor:pointer"><td>${d.n}</td><td>${fmt(d.v)}</td><td>${fmt(d.z)}</td><td>${fmt(d.invZ)}</td><td>${d.computed}</td><td>${fmt(d.err)}</td><td style="color:${d.method==='exact'?'#00ff88':'#ffd700'}">${d.method}</td></tr>`).join('');}


function runSh(){runShNew();}

let shAnimId=null;
function runShNew(){
const R=+document.getElementById('rshv').value||+document.getElementById('rsh').value;
const maxK=+document.getElementById('shKv').value||+document.getElementById('shK').value;
const shape=document.getElementById('shShape').value;
const display=document.getElementById('shDisplay').value;
const colorMode=document.getElementById('shColor').value;
const sfOnly=document.getElementById('shSquarefree').checked;
const markPrimes=document.getElementById('shPrimes').checked;
const showZero=document.getElementById('shShowZero').checked;

const ks=[],cs=[],Ls=[],mus=[];
D.sh=[];
let cum=0,pos=0,neg=0,actualPrim=0;

// Compute actual primitive count for comparison
const pts=enum2D(R,shape);
actualPrim=pts.filter(p=>p.p).length;

for(let k=1;k<=maxK;k++){
if(R/k<0.5)break;
const L=enum2D(R/k,shape).length;
const m=mob(k);
const c=m*L;
cum+=c;
if(c>0)pos+=c;
if(c<0)neg+=c;
const sf=isSquarefree(k);
const isPrime=k>1&&factorizeN(k).indexOf('¬∑')===-1&&factorizeN(k).indexOf('^')===-1;
ks.push(k);
cs.push(c);
Ls.push(L);
mus.push(m);
D.sh.push({k,m,L,c,cum,sf,isPrime,pctTotal:0,fac:factorizeN(k)});}

// Calculate percentages
const absTotal=D.sh.reduce((a,d)=>a+Math.abs(d.c),0);
D.sh.forEach(d=>{d.pctTotal=absTotal>0?100*Math.abs(d.c)/absTotal:0;});

// Filter for display
const filtered=sfOnly?D.sh.filter(d=>d.sf):showZero?D.sh:D.sh.filter(d=>d.m!==0);

// Chart 1: Main contributions
let barColors;
if(colorMode==='sign')barColors=filtered.map(d=>d.c>0?'#00ff88':d.c<0?'#ff006e':'#666');
else if(colorMode==='mobius')barColors=filtered.map(d=>d.m===1?'#00d9ff':d.m===-1?'#ff8c00':'#666');
else{const maxAbsC=cs.reduce((m,c)=>Math.max(m,Math.abs(c)),0)||1;barColors=filtered.map(d=>`hsl(${Math.abs(d.c)/maxAbsC*240},70%,50%)`);}

const traces1=[];
if(display==='contrib'||display==='both'){
traces1.push({x:filtered.map(d=>d.k),y:filtered.map(d=>d.c),name:'Œº(k)¬∑L(R/k)',type:'bar',marker:{color:barColors}});}
if(display==='cumul'||display==='both'){
traces1.push({x:filtered.map(d=>d.k),y:filtered.map(d=>d.cum),name:'Cumulative',mode:'lines+markers',line:{color:'#ffd700',width:2},yaxis:display==='both'?'y2':'y'});}

const layout1={...plo(),xaxis:{title:'Shell k'},yaxis:{title:'Contribution'}};
if(display==='both')layout1.yaxis2={title:'Cumulative',overlaying:'y',side:'right'};
Plotly.newPlot('psh',traces1,layout1);
legend('alsh','Shell Decomposition',[['Positive',pos,'#00ff88'],['Negative',Math.abs(neg),'#ff006e'],['Net (Œ£)',cum,'#ffd700']]);

// Chart 2: Cumulative convergence
Plotly.newPlot('pshCum',[
{x:D.sh.map(d=>d.k),y:D.sh.map(d=>d.cum),name:'Running Sum',mode:'lines+markers',line:{color:'#00d9ff',width:2}},
{x:D.sh.map(d=>d.k),y:D.sh.map(()=>actualPrim),name:'Actual P(R)',mode:'lines',line:{color:'#ffd700',dash:'dash'}}
],{...plo(),xaxis:{title:'Max Shell k'},yaxis:{title:'Œ£Œº(k)¬∑L(R/k)'}});

// Chart 3: Magnitude chart
Plotly.newPlot('pshMag',[{x:D.sh.map(d=>d.k),y:D.sh.map(d=>Math.abs(d.c)),type:'bar',marker:{color:D.sh.map(d=>d.sf?'#00ff88':'#9664ff')}}],{...plo(),xaxis:{title:'k'},yaxis:{title:'|Œº(k)¬∑L(R/k)|'}});

// Chart 4: M√∂bius function
Plotly.newPlot('pshMob',[{x:D.sh.map(d=>d.k),y:D.sh.map(d=>d.m),type:'bar',marker:{color:D.sh.map(d=>d.m===1?'#00d9ff':d.m===-1?'#ff006e':'#666')}}],{...plo(),xaxis:{title:'k'},yaxis:{title:'Œº(k)',range:[-1.5,1.5]}});

// Chart 5: Shell sizes
Plotly.newPlot('pshL',[{x:D.sh.map(d=>d.k),y:D.sh.map(d=>d.L),mode:'lines+markers',line:{color:'#ff8c00',width:2}}],{...plo(),xaxis:{title:'k'},yaxis:{title:'L(R/k)'}});

// Live stats
const nonZeroCount=D.sh.filter(d=>d.m!==0).length;
const sfCount=D.sh.filter(d=>d.sf).length;
const primeCount=D.sh.filter(d=>d.isPrime).length;
const convergenceErr=Math.abs(cum-actualPrim);

document.getElementById('shLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${R}</div><div style="font-size:.7rem;color:var(--txt2)">RADIUS R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${cum}</div><div style="font-size:.7rem;color:var(--txt2)">SHELL SUM</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${actualPrim}</div><div style="font-size:.7rem;color:var(--txt2)">ACTUAL P(R)</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Shape:</span><span style="color:var(--txt)">${shape}</span>
<span>Max k:</span><span style="color:var(--txt)">${maxK}</span>
<span>Active Shells:</span><span style="color:var(--txt)">${D.sh.length}</span>
<span>Non-zero Œº:</span><span style="color:var(--txt)">${nonZeroCount}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Contribution Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Positive sum:</span><span style="color:#00ff88">+${pos}</span>
<span>Negative sum:</span><span style="color:#ff006e">${neg}</span>
<span>Net (M√∂bius):</span><span style="color:#ffd700">${cum}</span>
<span>Actual P(R):</span><span style="color:#00d9ff">${actualPrim}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Convergence</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Error |Œ£ - P(R)|:</span><span style="color:${convergenceErr<5?'#00ff88':'#ff8c00'}">${convergenceErr}</span>
<span>Rel Error:</span><span style="color:var(--txt)">${actualPrim>0?fmt(100*convergenceErr/actualPrim)+'%':'‚Äî'}</span>
<span>k=1 contrib:</span><span style="color:#00d9ff">${D.sh[0]?.c||0}</span>
<span>k=2 contrib:</span><span style="color:#ff006e">${D.sh[1]?.c||0}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Shell Composition</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Squarefree k:</span><span style="color:#00ff88">${sfCount}</span>
<span>Prime k:</span><span style="color:#9664ff">${primeCount}</span>
<span>Œº(k)=0 shells:</span><span style="color:#666">${D.sh.length-nonZeroCount}</span>
<span>Largest |contrib|:</span><span style="color:#ffd700">${D.sh.reduce((m,d)=>Math.max(m,Math.abs(d.c)),0)}</span>
</div>
</div>`;

// Table
document.getElementById('tshT').innerHTML='<tr><th>k</th><th>Œº(k)</th><th>L(R/k)</th><th>Contribution</th><th>Cumulative</th><th>% of |Total|</th><th>SF?</th></tr>'+
D.sh.map(d=>`<tr onclick="modal('Shell k=${d.k}',[['Œº(${d.k})',${d.m}],['L(R/${d.k})',${d.L}],['Contribution',${d.c}],['Cumulative',${d.cum}],['Factorization','${d.fac}'],['Squarefree',${d.sf}]])" style="cursor:pointer;color:${d.m===0?'#666':d.c>0?'#00ff88':'#ff006e'}"><td>${d.k}${d.isPrime?' ‚òÖ':''}</td><td>${d.m}</td><td>${d.L}</td><td>${d.c>0?'+':''}${d.c}</td><td>${d.cum}</td><td>${fmt(d.pctTotal)}%</td><td>${d.sf?'‚úì':''}</td></tr>`).join('');}

function animateShells(){
const R=+document.getElementById('rshv').value,maxK=+document.getElementById('shKv').value;
if(shAnimId)cancelAnimationFrame(shAnimId);
let step=1;
function frame(){
document.getElementById('shKv').value=step;
document.getElementById('shK').value=Math.min(50,step);
runShNew();
if(step<maxK){step++;shAnimId=setTimeout(()=>requestAnimationFrame(frame),200);}else{shAnimId=null;}}
frame();}

function csvSh(){let s='k,mu,L,Contribution,Cumulative,PctTotal,Squarefree,Factorization\n';for(const d of D.sh)s+=`${d.k},${d.m},${d.L},${d.c},${d.cum},${d.pctTotal},${d.sf},"${d.fac}"\n`;dl(s,'shells.csv');}

function isSquarefree(n){if(n<=1)return n===1;for(let p=2;p*p<=n;p++)if(n%(p*p)===0)return false;return true;}
function factorizeN(n){if(n<=1)return n===1?'1':'0';let s='',m=n;for(let p=2;p*p<=m;p++){let e=0;while(m%p===0){m/=p;e++;}if(e>0)s+=(s?'¬∑':'')+p+(e>1?'^'+e:'');}if(m>1)s+=(s?'¬∑':'')+m;return s||'1';}

function runGCD(){
const R=+document.getElementById('rgcdv').value||+document.getElementById('rgcd').value;
const shape=document.getElementById('gcdShape').value;
const topN=+document.getElementById('gcdTopN').value;
const m=Math.ceil(R)+1,gc={},all=[];

for(let x=-m;x<=m;x++){
for(let y=-m;y<=m;y++){
const inRegion=shape==='circle'?(x*x+y*y<=R*R):(Math.abs(x)<=R&&Math.abs(y)<=R);
if(inRegion){const g=gcdM(x,y);gc[g]=(gc[g]||0)+1;all.push(g);}}}

const sorted=Object.entries(gc).sort((a,b)=>+a[0]-+b[0]);
const tot=all.length;
const gcd1=gc[1]||0;
const z2=zeta(2);

// Compute statistics
const mean=all.reduce((a,b)=>a+b,0)/tot;
const sortedAll=[...all].sort((a,b)=>a-b);
const median=sortedAll[Math.floor(tot/2)];
const mode=sorted.reduce((a,b)=>b[1]>a[1]?b:a)[0];
const maxGcd=all.reduce((a,b)=>Math.max(a,b),0);
const variance=all.reduce((a,b)=>a+(b-mean)**2,0)/tot;
const stddev=Math.sqrt(variance);

// Squarefree analysis
const sfCount=all.filter(g=>isSquarefree(g)).length;
const sfGcds=sorted.filter(([g])=>isSquarefree(+g));

// Prepare data
D.gcd=sorted.map(([g,c])=>{
const pct=100*c/tot;
return{g:+g,count:c,pct,sf:isSquarefree(+g),fac:factorizeN(+g)};});

// Cumulative
let cumul=0;
D.gcd.forEach(d=>{cumul+=d.pct;d.cumul=cumul;});

// Theory: P(gcd=k) ‚âà 1/(k¬≤¬∑Œ∂(2)) for primitive scaling
D.gcd.forEach(d=>{d.theory=100/(d.g*d.g*z2);});

// Charts
const top=D.gcd.slice(0,topN);
Plotly.newPlot('pgcd1',[{x:top.map(d=>d.g),y:top.map(d=>d.count),type:'bar',marker:{color:top.map(d=>d.g===1?'#ffd700':d.sf?'#00d9ff':'#9664ff')}}],{...plo(),xaxis:{title:'GCD'},yaxis:{title:'Count'}});
legend('algcd1','GCD Distribution',[['GCD=1',gcd1,'#ffd700'],['Total',tot,'#00d9ff']]);

// Cumulative chart
Plotly.newPlot('pgcd2',[{x:D.gcd.slice(0,30).map(d=>d.g),y:D.gcd.slice(0,30).map(d=>d.cumul),mode:'lines+markers',line:{color:'#00ff88',width:2}}],{...plo(),xaxis:{title:'GCD ‚â§ k'},yaxis:{title:'Cumulative %',range:[0,105]}});
legend('algcd2','Cumulative',[['50% at GCD‚â§',D.gcd.find(d=>d.cumul>=50)?.g||'‚Äî','#00ff88']]);

// Theory comparison
Plotly.newPlot('pgcd3',[
{x:top.map(d=>d.g),y:top.map(d=>d.pct),name:'Actual %',type:'bar',marker:{color:'#00d9ff'}},
{x:top.map(d=>d.g),y:top.map(d=>d.theory),name:'Theory %',type:'scatter',mode:'markers',marker:{color:'#ff8c00',size:10,symbol:'diamond'}}
],{...plo(),xaxis:{title:'GCD'},yaxis:{title:'Percentage'},barmode:'group'});

// Squarefree chart
const sfData=D.gcd.filter(d=>d.sf).slice(0,15);
const nonSfData=D.gcd.filter(d=>!d.sf).slice(0,10);
Plotly.newPlot('pgcdSF',[
{x:sfData.map(d=>d.g),y:sfData.map(d=>d.count),name:'Squarefree',type:'bar',marker:{color:'#00ff88'}},
{x:nonSfData.map(d=>d.g),y:nonSfData.map(d=>d.count),name:'Non-SF',type:'bar',marker:{color:'#ff6496'}}
],{...plo(),xaxis:{title:'GCD'},yaxis:{title:'Count'},barmode:'group'});

// Divisibility by small primes
const div2=all.filter(g=>g%2===0).length;
const div3=all.filter(g=>g%3===0).length;
const div5=all.filter(g=>g%5===0).length;
const div6=all.filter(g=>g%6===0).length;
Plotly.newPlot('pgcdDiv',[{x:['2|gcd','3|gcd','5|gcd','6|gcd'],y:[div2,div3,div5,div6],type:'bar',marker:{color:['#00d9ff','#ff8c00','#9664ff','#00ff88']}}],{...plo(),yaxis:{title:'Count'}});

// Live stats
document.getElementById('gcdLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${gcd1}</div><div style="font-size:.7rem;color:var(--txt2)">GCD = 1</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${tot}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(100*gcd1/tot)}%</div><div style="font-size:.7rem;color:var(--txt2)">COPRIME %</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius R:</span><span style="color:var(--txt)">${R}</span>
<span>Shape:</span><span style="color:var(--txt)">${shape}</span>
<span>Unique GCDs:</span><span style="color:var(--txt)">${sorted.length}</span>
<span>Max GCD:</span><span style="color:var(--txt)">${maxGcd}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Mean GCD:</span><span style="color:#00d9ff">${fmt(mean)}</span>
<span>Median GCD:</span><span style="color:#ff8c00">${median}</span>
<span>Mode GCD:</span><span style="color:#ffd700">${mode}</span>
<span>Std Dev:</span><span style="color:#9664ff">${fmt(stddev)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Theory Comparison</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Actual P(gcd=1):</span><span style="color:#ffd700">${fmt(100*gcd1/tot)}%</span>
<span>Theory 6/œÄ¬≤:</span><span style="color:#ff8c00">${fmt(100/z2)}%</span>
<span>Error:</span><span style="color:${Math.abs(gcd1/tot-1/z2)<0.02?'#00ff88':'#ff6496'}">${fmt(Math.abs(100*gcd1/tot-100/z2))}%</span>
<span>Ratio:</span><span style="color:#00d9ff">${fmt((gcd1/tot)/(1/z2))}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Squarefree Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>SF GCDs:</span><span style="color:#00ff88">${sfCount} (${fmt(100*sfCount/tot)}%)</span>
<span>Theory 6/œÄ¬≤:</span><span style="color:#ff8c00">${fmt(100/z2)}%</span>
<span>Non-SF GCDs:</span><span style="color:#ff6496">${tot-sfCount}</span>
<span>Unique SF values:</span><span style="color:#9664ff">${sfGcds.length}</span>
</div>
</div>`;

// Table
document.getElementById('tgcdT').innerHTML='<tr><th>GCD</th><th>Count</th><th>Percent</th><th>Cumulative</th><th>Theory</th><th>SF?</th><th>Factors</th></tr>'+
D.gcd.slice(0,50).map(d=>`<tr onclick="modal('GCD ${d.g}',[['Count',${d.count}],['Percent','${fmt(d.pct)}%'],['Cumulative','${fmt(d.cumul)}%'],['Theory','${fmt(d.theory)}%'],['Squarefree',${d.sf}],['Factorization','${d.fac}']])" style="cursor:pointer;color:${d.g===1?'#ffd700':d.sf?'inherit':'#9664ff'}"><td>${d.g}</td><td>${d.count}</td><td>${fmt(d.pct)}%</td><td>${fmt(d.cumul)}%</td><td>${fmt(d.theory)}%</td><td>${d.sf?'‚úì':''}</td><td>${d.fac}</td></tr>`).join('');}

function runGCDConvergence(){
const Rs=[5,10,15,20,25,30,40,50];
const densities=[];
for(const R of Rs){
let tot=0,gcd1=0;const m=Math.ceil(R);
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=R*R){tot++;if(gcdM(x,y)===1)gcd1++;}
densities.push({R,density:gcd1/tot,theory:1/zeta(2)});}
Plotly.newPlot('pgcd3',[
{x:Rs,y:densities.map(d=>d.density*100),name:'Actual',mode:'lines+markers',line:{color:'#00d9ff',width:2}},
{x:Rs,y:densities.map(d=>d.theory*100),name:'6/œÄ¬≤',mode:'lines',line:{color:'#ff8c00',dash:'dash'}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'P(gcd=1) %',range:[58,65]}});}

function csvGCD(){let s='GCD,Count,Percent,Cumulative,Theory,Squarefree,Factorization\n';for(const d of D.gcd)s+=`${d.g},${d.count},${d.pct},${d.cumul},${d.theory},${d.sf},"${d.fac}"\n`;dl(s,'gcd.csv');}

function isGausPrime(a,b){
const n2=a*a+b*b;if(n2===0)return false;if(n2===1)return false;
if(a===0){const bAbs=Math.abs(b);if(bAbs<2)return false;if(bAbs===2)return false;if(bAbs%4===3){for(let i=2;i*i<=bAbs;i++)if(bAbs%i===0)return false;return true;}return false;}
if(b===0){const aAbs=Math.abs(a);if(aAbs<2)return false;if(aAbs===2)return false;if(aAbs%4===3){for(let i=2;i*i<=aAbs;i++)if(aAbs%i===0)return false;return true;}return false;}
for(let i=2;i*i<=n2;i++)if(n2%i===0)return false;return true;
}

function drawGaus(){
const c=document.getElementById('cgaus'),ctx=c.getContext('2d');
const R=+document.getElementById('rgausv').value||+document.getElementById('rgaus').value;
const zm=+document.getElementById('zmgaus').value,ptSz=+document.getElementById('ptszgaus').value;
const col=document.getElementById('colGaus').value,filt=document.getElementById('filtGaus').value;
const lbl=document.getElementById('lblGaus').value;
const showNormC=document.getElementById('gausNormC').checked,showAxes=document.getElementById('gausAxes').checked;
const showGrid=document.getElementById('gausGrid').checked,showUnits=document.getElementById('gausUnits').checked;
const showAssoc=document.getElementById('gausAssoc').checked,showConj=document.getElementById('gausConj').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,sc=(c.width/2)/(R*1.15)*zm,nc={};
gausP=[];let tot=0,prim=0,gprimeC=0;
const quadC={0:0,1:0,2:0,3:0};
for(let a=-Math.ceil(R);a<=Math.ceil(R);a++)for(let b=-Math.ceil(R);b<=Math.ceil(R);b++){
const n2=a*a+b*b;if(Math.sqrt(n2)<=R){
const g=gcdM(a,b),isPrim=g===1,isGP=isGausPrime(a,b);
const arg=Math.atan2(b,a);
const quad=a>=0?(b>=0?0:3):(b>=0?1:2);
const isUnit=(a===1&&b===0)||(a===-1&&b===0)||(a===0&&b===1)||(a===0&&b===-1);
if(filt==='prim'&&!isPrim)continue;
if(filt==='gprime'&&!isGP)continue;
if(filt==='units'&&isUnit)continue;
tot++;if(isPrim)prim++;if(isGP)gprimeC++;
nc[n2]=(nc[n2]||0)+1;quadC[quad]++;
gausP.push({a,b,n2,g,isPrim,isGP,arg,quad,isUnit});}}
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=-Math.ceil(R);i<=Math.ceil(R);i++){ctx.beginPath();ctx.moveTo(cx+i*sc,0);ctx.lineTo(cx+i*sc,c.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,cy-i*sc);ctx.lineTo(c.width,cy-i*sc);ctx.stroke();}}
if(showAxes){ctx.strokeStyle=isDark()?'rgba(255,215,0,0.6)':'rgba(200,150,0,0.6)';ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(0,cy);ctx.lineTo(c.width,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,0);ctx.lineTo(cx,c.height);ctx.stroke();
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 12px Segoe UI';
ctx.fillText('Re',c.width-25,cy-8);ctx.fillText('Im',cx+8,15);}
if(showNormC){ctx.strokeStyle='rgba(150,100,255,0.3)';ctx.lineWidth=1;
for(let n=1;n<=R*R;n++){const r=Math.sqrt(n);if(r<=R){ctx.beginPath();ctx.arc(cx,cy,r*sc,0,2*Math.PI);ctx.stroke();}}}
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,R*sc,0,2*Math.PI);ctx.stroke();
if(showConj){ctx.strokeStyle='rgba(0,217,255,0.15)';ctx.lineWidth=1;
for(const p of gausP){if(p.b>0){ctx.beginPath();ctx.moveTo(cx+p.a*sc,cy-p.b*sc);ctx.lineTo(cx+p.a*sc,cy+p.b*sc);ctx.stroke();}}}
if(showAssoc){ctx.strokeStyle='rgba(255,136,0,0.2)';ctx.lineWidth=1;
for(const p of gausP){if(p.a>0&&p.b>=0){const pts=[[p.a,p.b],[-p.a,p.b],[-p.a,-p.b],[p.a,-p.b],[p.b,p.a],[-p.b,p.a],[-p.b,-p.a],[p.b,-p.a]];
ctx.beginPath();pts.forEach((q,i)=>{if(i===0)ctx.moveTo(cx+q[0]*sc,cy-q[1]*sc);else ctx.lineTo(cx+q[0]*sc,cy-q[1]*sc);});ctx.closePath();ctx.stroke();}}}
for(const p of gausP){
let clr;
if(col==='gcd')clr=p.isPrim?'#ffd700':'#555';
else if(col==='gprime')clr=p.isGP?'#00ff88':p.isPrim?'#ffd700':'#444';
else if(col==='norm')clr=`hsl(${(p.n2/R/R*300)%360},80%,60%)`;
else if(col==='arg')clr=`hsl(${((p.arg+Math.PI)/(2*Math.PI)*360)},85%,55%)`;
else if(col==='quadrant'){const qc=['#FF6B6B','#4ECDC4','#FFE66D','#95E1D3'];clr=qc[p.quad];}
else if(col==='parity')clr=(p.a+p.b)%2===0?'#00d9ff':'#ff6496';
else if(col==='sum2sq')clr=p.n2>0?'#00ff88':'#666';
else clr=p.isPrim?'#00d9ff':'#64c8ff';
if(showUnits&&p.isUnit){ctx.strokeStyle='#ff006e';ctx.lineWidth=3;ctx.beginPath();ctx.arc(cx+p.a*sc,cy-p.b*sc,ptSz+4,0,2*Math.PI);ctx.stroke();}
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(cx+p.a*sc,cy-p.b*sc,p.isGP?ptSz+1:ptSz,0,2*Math.PI);ctx.fill();}
if(lbl!=='none'){ctx.font='9px Segoe UI';ctx.textAlign='center';ctx.fillStyle=isDark()?'rgba(255,255,255,0.8)':'rgba(0,0,0,0.8)';
for(const p of gausP){let t='';if(lbl==='val')t=p.b>=0?`${p.a}+${p.b}i`:`${p.a}${p.b}i`;
else if(lbl==='norm')t=p.n2;else if(lbl==='arg')t=Math.round(p.arg*180/Math.PI)+'¬∞';
ctx.fillText(t,cx+p.a*sc,cy-p.b*sc-ptSz-3);}}
const z2=zeta(2),baselRatio=tot>0?(prim/tot)/(1/z2):0;
const norms=Object.entries(nc).sort((a,b)=>+a[0]-+b[0]).slice(0,25);
const uniqueNorms=Object.keys(nc).length;
const sum2sqCount=Object.keys(nc).filter(n=>+n>0).length;
legend('algaus1','‚Ñ§[i] Theory',[['1/Œ∂(2) Pred',fmt(tot/z2),'#9664ff'],['Coprime 6/œÄ¬≤',fmt(100/z2)+'%','#ff8c00']]);
legend('algaus2','Norm Analysis',[['Unique |z|¬≤',uniqueNorms,'#9664ff'],['Max Norm¬≤',gausP.reduce((m,p)=>Math.max(m,p.n2),0),'#ff8c00']]);
Plotly.newPlot('pgaus',[{x:norms.map(x=>+x[0]),y:norms.map(x=>x[1]),type:'bar',marker:{color:norms.map((_,i)=>`hsl(${i*12},70%,55%)`)}}],{...plo(),xaxis:{title:'|z|¬≤ (Norm¬≤)'},yaxis:{title:'Count'}});
document.getElementById('stgaus').innerHTML='';
document.getElementById('gausLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${tot}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${prim}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMITIVE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${gprimeC}</div><div style="font-size:.7rem;color:var(--txt2)">GAUSS PRIMES</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius:</span><span style="color:var(--txt)">${R}</span>
<span>Zoom:</span><span style="color:var(--txt)">${zm}x</span>
<span>Color:</span><span style="color:var(--txt)">${col}</span>
<span>Filter:</span><span style="color:var(--txt)">${filt}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Coprime Density (‚Ñ§[i] Lattice)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Prim Density:</span><span style="color:#ffd700;font-weight:bold">${fmt(100*prim/tot)}%</span>
<span>Theory 1/Œ∂(2):</span><span style="color:#9664ff">${fmt(100/z2)}%</span>
<span>Ratio:</span><span style="color:${baselRatio>.95&&baselRatio<1.05?'#00ff88':'#ff8c00'}">${fmt(baselRatio*100)}%</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Quadrant Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span style="color:#FF6B6B">Q1 (a‚â•0,b‚â•0):</span><span>${quadC[0]}</span>
<span style="color:#4ECDC4">Q2 (a<0,b‚â•0):</span><span>${quadC[1]}</span>
<span style="color:#FFE66D">Q3 (a<0,b<0):</span><span>${quadC[2]}</span>
<span style="color:#95E1D3">Q4 (a‚â•0,b<0):</span><span>${quadC[3]}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Norm Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Unique Norms:</span><span style="color:#9664ff">${uniqueNorms}</span>
<span>Max |z|¬≤:</span><span>${gausP.reduce((m,p)=>Math.max(m,p.n2),0)}</span>
<span>Sum-2-Sq Norms:</span><span style="color:#00ff88">${sum2sqCount}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Gaussian Prime Facts</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ p‚â°1(mod 4): splits as œÄ¬∑œÄÃÑ<br>
‚Ä¢ p‚â°3(mod 4): stays prime in ‚Ñ§[i]<br>
‚Ä¢ 2 = -i(1+i)¬≤ (ramifies)<br>
‚Ä¢ Units: {1, -1, i, -i}
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
for(const p of gausP){const px=cx+p.a*sc,py=cy-p.b*sc;
if(Math.hypot(mx-px,my-py)<12){
const assoc=`¬±${Math.abs(p.a)}¬±${Math.abs(p.b)}i, ¬±${Math.abs(p.b)}¬±${Math.abs(p.a)}i`;
modal('Gaussian Integer Analysis',[
['Value',p.b>=0?`${p.a} + ${p.b}i`:`${p.a} - ${Math.abs(p.b)}i`],
['Norm |z|',fmt(Math.sqrt(p.n2))],
['Norm¬≤ |z|¬≤',p.n2],
['Argument Œ∏',fmt(p.arg*180/Math.PI)+'¬∞'],
['GCD(Re,Im)',p.g],
['Primitive',p.isPrim?'Yes':'No'],
['Gaussian Prime',p.isGP?'Yes':'No'],
['Unit',p.isUnit?'Yes':'No'],
['Quadrant','Q'+(p.quad+1)],
['Associates',assoc]
]);break;}}};}
function expGaus(){const c=document.getElementById('cgaus');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='gaussian.png';a.click();});}
function csvGaus(){let s='Re,Im,Norm2,GCD,Primitive,GaussianPrime,Argument,Quadrant,Unit\n';for(const p of gausP)s+=`${p.a},${p.b},${p.n2},${p.g},${p.isPrim},${p.isGP},${p.arg},${p.quad},${p.isUnit}\n`;dl(s,'gaussian.csv');}

function runCirc(){runCircNew();}

function runCircNew(){
const maxR=+document.getElementById('circRv').value||+document.getElementById('circR').value;
const step=+document.getElementById('circStep').value;
const showBounds=document.getElementById('circBounds').checked;
const primOnly=document.getElementById('circPrim').checked;

const rs=[],cs=[],ps=[],ths=[],es=[],sqrtEs=[],normEs=[];
D.circ=[];

for(let r=step;r<=maxR;r+=step){
let cnt=0,prim=0;
const m=Math.ceil(r)+1;
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=r*r){cnt++;if(gcdM(x,y)===1)prim++;}
const th=Math.PI*r*r,err=cnt-th;
rs.push(r);cs.push(cnt);ps.push(prim);ths.push(th);es.push(err);
sqrtEs.push(r>0?err/Math.sqrt(r):0);
normEs.push(r>0?Math.abs(err)/Math.pow(r,0.5):0);
D.circ.push({r,cnt,prim,th,err,sqrtR:err/Math.sqrt(r),normR:Math.abs(err)/Math.pow(r,0.5),relE:th>0?Math.abs(err)/th*100:0});}

// Statistics
const maxErr=Math.max(...es);
const minErr=Math.min(...es);
const avgErr=es.reduce((a,b)=>a+b,0)/es.length;
const maxNorm=Math.max(...normEs);

// Chart 1: Count vs Theory
Plotly.newPlot('pc1',[
{x:rs,y:ths,name:'œÄR¬≤',mode:'lines',line:{color:'#ff8c00',width:3}},
{x:rs,y:cs,name:'N(R)',mode:'markers',marker:{color:'#00d9ff',size:5}},
{x:rs,y:ps,name:'Primitive',mode:'markers',marker:{color:'#ffd700',size:4,symbol:'diamond'}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'Count'}});
legend('alc1','Lattice Count',[['N(max)',cs[cs.length-1],'#00d9ff'],['œÄR¬≤',fmt(ths[ths.length-1]),'#ff8c00']]);

// Chart 2: Error r(R)
const traces2=[{x:rs,y:es,name:'r(R)=N(R)-œÄR¬≤',mode:'lines+markers',line:{color:'#ff006e',width:2},marker:{size:3}}];
if(showBounds){
traces2.push({x:rs,y:rs.map(r=>2*Math.sqrt(r)),name:'O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});
traces2.push({x:rs,y:rs.map(r=>-2*Math.sqrt(r)),name:'-O(‚àöR)',mode:'lines',line:{color:'#666',dash:'dot'}});}
Plotly.newPlot('pc2',traces2,{...plo(),xaxis:{title:'R'},yaxis:{title:'r(R) = N(R) - œÄR¬≤'}});
legend('alc2','Error r(R)',[['Max',fmt(maxErr),'#ff006e'],['Min',fmt(minErr),'#00ff88']]);

// Chart 3: Normalized error
Plotly.newPlot('pc3',[
{x:rs,y:sqrtEs,name:'r(R)/‚àöR',mode:'lines+markers',line:{color:'#9664ff',width:2},marker:{size:3}},
{x:rs,y:rs.map(()=>0),mode:'lines',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'R'},yaxis:{title:'r(R)/‚àöR'}});
legend('alc3','Normalized',[['Max |r|/‚àöR',fmt(maxNorm),'#9664ff']]);

// Chart 4: Absolute error magnitude
Plotly.newPlot('pcircAbs',[{x:rs,y:es.map(Math.abs),mode:'lines+markers',line:{color:'#00ff88',width:2}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'|r(R)|'}});

// Chart 5: Running average
const runAvg=sqrtEs.map((e,i)=>sqrtEs.slice(0,i+1).reduce((a,b)=>a+b,0)/(i+1));
Plotly.newPlot('pcircAvg',[{x:rs,y:runAvg,mode:'lines',line:{color:'#ffd700',width:2}}],{...plo(),xaxis:{title:'R'},yaxis:{title:'Running Avg r(R)/‚àöR'}});

// Live stats
document.getElementById('circLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Circle Problem | FIELD: ‚Ñ§¬≤ Disc | TYPE: Gauss Lattice Counting</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max R: <strong style="color:#00d9ff">${maxR}</strong></span>
<span>Step: <strong style="color:#ffd700">${step}</strong></span>
<span>Points: <strong style="color:#00ff88">${D.circ.length}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxR}</div><div style="font-size:.7rem;color:var(--txt2)">MAX R</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${cs[cs.length-1]}</div><div style="font-size:.7rem;color:var(--txt2)">N(R) ACTUAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(ths[ths.length-1])}</div><div style="font-size:.7rem;color:var(--txt2)">œÄR¬≤ PREDICTED</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${ps[ps.length-1]}</div><div style="font-size:.6rem;color:var(--txt2)">PRIMITIVE</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff8c00">${fmt(es[es.length-1])}</div><div style="font-size:.6rem;color:var(--txt2)">ERROR r(R)</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:${Math.abs(es[es.length-1]/Math.sqrt(maxR))<2?'#00ff88':'#ff6496'}">${fmt(es[es.length-1]/Math.sqrt(maxR))}</div><div style="font-size:.6rem;color:var(--txt2)">r(R)/‚àöR</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max r(R):</span><span style="color:#ff006e">${fmt(maxErr)}</span>
<span>Min r(R):</span><span style="color:#00ff88">${fmt(minErr)}</span>
<span>Avg r(R):</span><span style="color:#00d9ff">${fmt(avgErr)}</span>
<span>Max |r|/‚àöR:</span><span style="color:#9664ff">${fmt(maxNorm)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Final Values (R=${maxR})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>N(R):</span><span style="color:#00d9ff">${cs[cs.length-1]}</span>
<span>œÄR¬≤:</span><span style="color:#ff8c00">${fmt(ths[ths.length-1])}</span>
<span>r(R):</span><span style="color:${es[es.length-1]>=0?'#00ff88':'#ff006e'}">${fmt(es[es.length-1])}</span>
<span>Primitive:</span><span style="color:#ffd700">${ps[ps.length-1]}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Gauss Circle Bounds</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Trivial: |r(R)| = O(R)<br>
‚Ä¢ Best known: |r(R)| = O(R^0.6298...)<br>
‚Ä¢ Conjectured: |r(R)| = O(R^(1/2+Œµ))<br>
‚Ä¢ Œ©-result: r(R) = Œ©(R^0.5 (log R)^0.25)
</div>
</div>`;

// Table
document.getElementById('tcircT').innerHTML='<tr><th>R</th><th>N(R)</th><th>œÄR¬≤</th><th>r(R)</th><th>r(R)/‚àöR</th><th>|r(R)|/R^0.5</th></tr>'+
D.circ.map(d=>`<tr onclick="modal('R=${d.r}',[['N(R)',${d.cnt}],['œÄR¬≤',${fmt(d.th)}],['r(R)',${fmt(d.err)}],['Primitive',${d.prim}],['r(R)/‚àöR',${fmt(d.sqrtR)}]])" style="cursor:pointer"><td>${fmt(d.r)}</td><td>${d.cnt}</td><td>${fmt(d.th)}</td><td>${fmt(d.err)}</td><td>${fmt(d.sqrtR)}</td><td>${fmt(d.normR)}</td></tr>`).join('');}

function drawCircleViz(){
const R=+document.getElementById('circVizR').value;
const c=document.getElementById('ccirc'),ctx=c.getContext('2d');
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,scale=Math.min(cx,cy-30)/(R+1);
// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=-R;i<=R;i++){ctx.beginPath();ctx.moveTo(cx+i*scale,cy-R*scale);ctx.lineTo(cx+i*scale,cy+R*scale);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx-R*scale,cy+i*scale);ctx.lineTo(cx+R*scale,cy+i*scale);ctx.stroke();}
// Circle
ctx.strokeStyle='#ff8c00';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,R*scale,0,2*Math.PI);ctx.stroke();
// Points
let cnt=0,prim=0;
for(let x=-Math.ceil(R);x<=Math.ceil(R);x++)for(let y=-Math.ceil(R);y<=Math.ceil(R);y++)if(x*x+y*y<=R*R){
cnt++;const isPrim=gcdM(x,y)===1;if(isPrim)prim++;
ctx.fillStyle=isPrim?'#ffd700':'#00d9ff';
ctx.beginPath();ctx.arc(cx+x*scale,cy-y*scale,3,0,2*Math.PI);ctx.fill();}
// Title
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Gauss Circle: R=${R}, N(R)=${cnt}, œÄR¬≤=${fmt(Math.PI*R*R)}, r(R)=${fmt(cnt-Math.PI*R*R)}`,cx,25);
ctx.fillText(`Primitive: ${prim} (${fmt(100*prim/cnt)}%)`,cx,c.height-10);}

function csvCirc(){let s='R,Count,Primitive,Theory,Error,SqrtR,NormR,RelError\n';for(const d of D.circ)s+=`${d.r},${d.cnt},${d.prim},${d.th},${d.err},${d.sqrtR},${d.normR},${d.relE}\n`;dl(s,'circle.csv');}

// Euler product approximation
function eulerProduct(s,maxP){let prod=1;for(let p=2;p<=maxP;p++){let isPrime=true;for(let i=2;i*i<=p;i++)if(p%i===0){isPrime=false;break;}if(isPrime)prod*=1/(1-Math.pow(p,-s));}return prod;}

// Monte Carlo sampling for high dimensions
function monteCarloDensity(k,R,samples){let inside=0,coprime=0;
for(let s=0;s<samples;s++){
const coords=[];for(let i=0;i<k;i++)coords.push(Math.floor(Math.random()*(2*R+1))-R);
const r2=coords.reduce((a,x)=>a+x*x,0);
if(r2<=R*R){inside++;if(gcdM(...coords)===1)coprime++;}}
return{tot:inside,prim:coprime,emp:inside>0?coprime/inside:0};}

function runDensNew(){
const R=+document.getElementById('densR').value;
const maxK=+document.getElementById('densMaxK').value;
const mode=document.getElementById('densMode').value;
const samples=+document.getElementById('densSample').value;
const ks=[],ths=[],emps=[],zetaVals=[],eulerVals=[];
D.dens=[];

for(let k=2;k<=maxK;k++){
let tot=0,prim=0,emp=0;
const z=zeta(k),th=1/z;

if(mode==='theory'){
emp=th;tot=0;prim=0;
}else if(mode==='sample'||k>4){
const mc=monteCarloDensity(k,R,samples);
tot=mc.tot;prim=mc.prim;emp=mc.emp;
}else{
// Exact computation for k<=4
const m=Math.ceil(R);
if(k===2){for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=R*R){tot++;if(gcdM(x,y)===1)prim++;}}
else if(k===3){for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){tot++;if(gcdM(x,y,z)===1)prim++;}}
else if(k===4){const sm=Math.min(6,m);for(let a=-sm;a<=sm;a++)for(let b=-sm;b<=sm;b++)for(let c=-sm;c<=sm;c++)for(let d=-sm;d<=sm;d++)if(a*a+b*b+c*c+d*d<=R*R){tot++;if(gcdM(a,b,c,d)===1)prim++;}}
emp=tot>0?prim/tot:th;}

const euler=eulerProduct(k,100);
ks.push(k);ths.push(th);emps.push(emp);zetaVals.push(z);eulerVals.push(euler);
D.dens.push({k,z,th,emp,tot,prim,err:Math.abs(emp-th),relE:th>0?Math.abs(emp-th)/th*100:0,euler});}

// Chart 1: Density convergence
Plotly.newPlot('pdens1',[
{x:ks,y:ths,name:'Theory 1/Œ∂(k)',mode:'lines+markers',line:{color:'#ff8c00',width:3},marker:{size:8}},
{x:ks,y:emps,name:'Empirical',mode:'markers',marker:{color:'#00d9ff',size:10,symbol:'diamond'}},
{x:ks,y:ks.map(()=>1),name:'Limit (1)',mode:'lines',line:{color:'#666',dash:'dash',width:1}}
],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'P(coprime)',range:[0.5,1.05]}});
legend('aldens1','Density Analysis',[['1/Œ∂(2)',ths[0],'#ff8c00'],['1/Œ∂('+maxK+')',ths[ths.length-1],'#00d9ff']]);

// Chart 2: Zeta convergence to 1
Plotly.newPlot('pdensZeta',[
{x:ks,y:zetaVals,name:'Œ∂(k)',mode:'lines+markers',line:{color:'#9664ff',width:2},marker:{size:6}},
{x:ks,y:ks.map(()=>1),name:'Limit',mode:'lines',line:{color:'#666',dash:'dash'}}
],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'Œ∂(k)',range:[0.95,Math.max(...zetaVals)+0.1]}});

// Chart 3: Error bars
Plotly.newPlot('pdens2',[{x:ks,y:D.dens.map(d=>d.relE),type:'bar',marker:{color:D.dens.map(d=>d.relE<1?'#00ff88':d.relE<5?'#ffd700':'#ff6496')}}],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'Relative Error %'}});
legend('aldens2','Error Analysis',[['Max Error',fmt(Math.max(...D.dens.map(d=>d.relE)))+'%','#ff6496'],['Min Error',fmt(Math.min(...D.dens.map(d=>d.relE)))+'%','#00ff88']]);

// Chart 4: Euler product verification
Plotly.newPlot('pdensEuler',[
{x:ks,y:zetaVals,name:'Œ∂(k) (Series)',mode:'lines+markers',line:{color:'#ff8c00',width:2}},
{x:ks,y:eulerVals,name:'Euler Product (p‚â§100)',mode:'markers',marker:{color:'#00ff88',size:8,symbol:'cross'}}
],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'Value'}});

// Chart 5: Convergence rate
const convRate=ks.map((k,i)=>i>0?Math.abs(ths[i]-1)/Math.abs(ths[i-1]-1):1);
Plotly.newPlot('pdensConv',[{x:ks.slice(1),y:convRate.slice(1),type:'scatter',mode:'lines+markers',line:{color:'#00d9ff',width:2},marker:{size:6}}],{...plo(),xaxis:{title:'Dimension k'},yaxis:{title:'|1/Œ∂(k)-1|/|1/Œ∂(k-1)-1|'}});

// Live stats
const avgErr=D.dens.reduce((a,d)=>a+d.relE,0)/D.dens.length;
const totalPts=D.dens.reduce((a,d)=>a+d.tot,0);
const totalPrim=D.dens.reduce((a,d)=>a+d.prim,0);
document.getElementById('densLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${maxK-1}</div><div style="font-size:.7rem;color:var(--txt2)">DIMENSIONS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${totalPts.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL SAMPLES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${totalPrim.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">COPRIME</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius R:</span><span style="color:var(--txt)">${R}</span>
<span>Max Dimension:</span><span style="color:var(--txt)">${maxK}</span>
<span>Mode:</span><span style="color:var(--txt)">${mode}</span>
<span>Monte Carlo:</span><span style="color:var(--txt)">${samples.toLocaleString()}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Summary</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Avg Error:</span><span style="color:${avgErr<2?'#00ff88':'#ff8c00'}">${fmt(avgErr)}%</span>
<span>Max Error:</span><span style="color:#ff6496">${fmt(Math.max(...D.dens.map(d=>d.relE)))}%</span>
<span>Min Error:</span><span style="color:#00ff88">${fmt(Math.min(...D.dens.map(d=>d.relE)))}%</span>
<span>Best k:</span><span style="color:#ffd700">k=${D.dens.reduce((a,d)=>d.relE<a.relE?d:a).k}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Zeta Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Œ∂(2) = œÄ¬≤/6:</span><span style="color:#9664ff">${fmt(zeta(2))}</span>
<span>Œ∂(3) (Ap√©ry):</span><span style="color:#ff8c00">${fmt(zeta(3))}</span>
<span>Œ∂(4) = œÄ‚Å¥/90:</span><span style="color:#00d9ff">${fmt(zeta(4))}</span>
<span>Œ∂(${maxK}):</span><span style="color:#00ff88">${fmt(zeta(maxK))}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Observations</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ As k‚Üë, Œ∂(k)‚Üí1 exponentially fast<br>
‚Ä¢ P(coprime in k-dim) = 1/Œ∂(k) ‚Üí 1<br>
‚Ä¢ Higher dimensions ‚âà almost always coprime<br>
‚Ä¢ Euler product: Œ∂(s) = Œ†(1-p‚ÅªÀ¢)‚Åª¬π
</div>
</div>`;

// Table
document.getElementById('tdensT').innerHTML='<tr><th>k</th><th>Œ∂(k)</th><th>1/Œ∂(k)</th><th>Empirical</th><th>Total</th><th>Primitive</th><th>Abs Err</th><th>Rel Err %</th></tr>'+
D.dens.map(d=>`<tr onclick="modal('Dimension ${d.k} Analysis',[['Œ∂(${d.k})',${d.z}],['1/Œ∂(${d.k})',${d.th}],['Empirical',${d.emp}],['Total Points',${d.tot}],['Primitive',${d.prim}],['Euler Product',${d.euler}],['Abs Error',${d.err}],['Rel Error %',${d.relE}]])" style="cursor:pointer;color:${d.relE<1?'#00ff88':d.relE<5?'inherit':'#ff6496'}"><td>${d.k}</td><td>${fmt(d.z)}</td><td>${fmt(d.th)}</td><td>${fmt(d.emp)}</td><td>${d.tot}</td><td>${d.prim}</td><td>${fmt(d.err)}</td><td>${fmt(d.relE)}</td></tr>`).join('');}

function runConvergence(){
const Rs=[5,8,10,12,15,20];
const conv2d=[],conv3d=[];
for(const R of Rs){
let tot2=0,prim2=0,tot3=0,prim3=0;
const m=Math.ceil(R);
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)if(x*x+y*y<=R*R){tot2++;if(gcdM(x,y)===1)prim2++;}
for(let x=-m;x<=m;x++)for(let y=-m;y<=m;y++)for(let z=-m;z<=m;z++)if(x*x+y*y+z*z<=R*R){tot3++;if(gcdM(x,y,z)===1)prim3++;}
conv2d.push({R,emp:prim2/tot2,th:1/zeta(2),err:Math.abs(prim2/tot2-1/zeta(2))});
conv3d.push({R,emp:prim3/tot3,th:1/zeta(3),err:Math.abs(prim3/tot3-1/zeta(3))});}
Plotly.newPlot('pdensConv',[
{x:Rs,y:conv2d.map(c=>c.err),name:'2D Error',mode:'lines+markers',line:{color:'#00d9ff',width:2}},
{x:Rs,y:conv3d.map(c=>c.err),name:'3D Error',mode:'lines+markers',line:{color:'#ff8c00',width:2}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'|Empirical - Theory|',type:'log'}});}

function runDens(){runDensNew();}
function csvDens(){let s='k,Zeta,InvZeta,Empirical,Total,Primitive,AbsError,RelError,EulerProd\n';for(const d of D.dens)s+=`${d.k},${d.z},${d.th},${d.emp},${d.tot},${d.prim},${d.err},${d.relE},${d.euler}\n`;dl(s,'density.csv');}

async function screenshotPlotly(plotIds,legends,title,filename){
const scale=2,pad=30,gap=20;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:p.offsetWidth,height:p.offsetHeight,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const legEls=legends.map(id=>document.getElementById(id)).filter(l=>l);
const legH=legEls.length?100:0;
const cols=Math.min(2,loaded.length),rows=Math.ceil(loaded.length/cols);
const pw=loaded[0].width/2,ph=loaded[0].height/2;
const out=document.createElement('canvas');
out.width=(pw*cols+gap*(cols-1)+pad*2)*scale;
out.height=(ph*rows+gap*(rows-1)+pad*2+40+legH)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
ctx.fillStyle=canvBg();ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.fillText(title,pad,pad+20);
loaded.forEach((img,i)=>{const col=i%cols,row=Math.floor(i/cols);ctx.drawImage(img,pad+col*(pw+gap),pad+40+row*(ph+gap),pw,ph);});
if(legEls.length){let ly=pad+40+rows*(ph+gap)+10;
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.fillText('Statistics',pad,ly);ly+=20;
ctx.font='12px Segoe UI';let lx=pad;
legEls.forEach(leg=>{leg.querySelectorAll('.li').forEach((li,j)=>{const l=li.querySelector('strong')?.textContent||'',v=li.querySelector('.v')?.textContent||'';
ctx.fillStyle=isDark()?'#b0b8d8':'#4a5568';ctx.fillText(l+': '+v,lx,ly);lx+=160;if(lx>out.width/scale-pad){lx=pad;ly+=18;}});});}
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=filename;a.click();},'image/png',1.0);}

async function screenshotErr(){
const dashData=extractDashboardData('errLiveStats');
const maxR=document.getElementById('errRv').value,shape=document.getElementById('errSh').value;
const plotIds=['pe1','pe2','pe3','pe4'];
const scale=2,pad=30,gap=10,dashH=280;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:380,height:220,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=190,ph=110;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph*2+gap+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Error Analysis ‚Äî R‚â§${maxR}, ${shape}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{const col=i%2,row=Math.floor(i/2);ctx.drawImage(img,pad+col*(pw+gap),pad+30+row*(ph+gap),pw,ph);});
const dashY=pad+30+2*(ph+gap)+10;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='error_complete.png';a.click();},'image/png',1.0);}

async function screenshotSh(){
const dashData=extractDashboardData('shLiveStats');
const R=document.getElementById('rshv').value,maxK=document.getElementById('shKv').value;
const plotIds=['psh','pshCum'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M√∂bius Shell Decomposition ‚Äî R=${R}, k‚â§${maxK}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='shells_complete.png';a.click();},'image/png',1.0);}
async function screenshotGCD(){
const dashData=extractDashboardData('gcdLiveStats');
const R=document.getElementById('rgcdv').value,shape=document.getElementById('gcdShape').value;
const plotIds=['pgcd1','pgcd2'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`GCD Distribution Analysis ‚Äî R=${R}, ${shape}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='gcd_complete.png';a.click();},'image/png',1.0);}

async function screenshotCirc(){
const dashData=extractDashboardData('circLiveStats');
const maxR=document.getElementById('circRv').value;
const plotIds=['pc1','pc2'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Gauss Circle Problem ‚Äî R‚â§${maxR}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='circle_complete.png';a.click();},'image/png',1.0);}
async function screenshotDens(){
const dashData=extractDashboardData('densLiveStats');
const R=document.getElementById('densR').value;
const maxK=document.getElementById('densMaxK').value;
const mode=document.getElementById('densMode').value;
const plotIds=['pdens1','pdensZeta','pdens2','pdensEuler'];
const scale=2,pad=30,gap=15;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125,dashH=250;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph*2+gap+dashH+pad*4+50)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Primitive Density 1/Œ∂(k) ‚Äî R=${R}, k=2‚Üí${maxK}, ${mode}`,out.width/scale/2,pad);
// 2x2 grid of charts
loaded.forEach((img,i)=>{const col=i%2,row=Math.floor(i/2);ctx.drawImage(img,pad+col*(pw+gap),pad+35+row*(ph+gap),pw,ph);});
// Dashboard
const dashY=pad+35+2*(ph+gap)+10;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-20);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='density_complete.png';a.click();},'image/png',1.0);}
async function screenshotDim(){
const dashData=extractDashboardData('dimLiveStats');
const maxD=document.getElementById('dimMaxV').value,R=document.getElementById('rdimv').value;
const plotIds=['pdimZeta','pdimDens'];
const scale=2,pad=30,gap=15,dashH=300;
const plots=plotIds.map(id=>document.getElementById(id)).filter(p=>p&&p.offsetWidth);
if(!plots.length)return alert('Run analysis first');
const imgs=await Promise.all(plots.map(p=>Plotly.toImage(p,{format:'png',width:400,height:250,scale:2})));
const loaded=await Promise.all(imgs.map(src=>new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=src;})));
const pw=200,ph=125;
const out=document.createElement('canvas');
out.width=(pw*2+gap+pad*2)*scale;out.height=(ph+dashH+pad*4)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Dimension Analysis ‚Äî n=2‚Üí${maxD}, R=${R}`,out.width/scale/2,pad);
loaded.forEach((img,i)=>{ctx.drawImage(img,pad+i*(pw+gap),pad+30,pw,ph);});
const dashY=pad+30+ph+15;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY,pw*2+gap,dashH-30);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY+10,pw*2+gap-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dimensions_complete.png';a.click();},'image/png',1.0);}

let cayleyPts=[],primRootData={};

function cayley(z){const x=z.x,y=z.y,d=(1-x)*(1-x)+y*y;if(d<1e-10)return{x:0,y:1e6};return{x:-2*y/d,y:(1-x*x-y*y)/d};}
function invCayley(w){const x=w.x,y=w.y,d=x*x+(y+1)*(y+1);if(d<1e-10)return{x:0,y:0};return{x:-2*x/d,y:(x*x+y*y-1)/d};}
function fareyLevel(p,q){if(q===0)return 0;return q;}

function drawCayley(){
const c=document.getElementById('ccay'),ctx=c.getContext('2d');
const R=+document.getElementById('rcayv').value||+document.getElementById('rcay').value;
const range=+document.getElementById('cayRange').value,col=document.getElementById('colCay').value;
const ptSz=+document.getElementById('caySz').value,filt=document.getElementById('cayFilt').value;
const lbl=document.getElementById('cayLbl').value,fordQ=+document.getElementById('cayFordQ').value;
const showGrid=document.getElementById('cayGrid').checked,showGeo=document.getElementById('cayGeo').checked;
const showFord=document.getElementById('cayFord').checked,showFarey=document.getElementById('cayFarey').checked;
const showFund=document.getElementById('cayFund').checked,showHoro=document.getElementById('cayHoro').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const scX=c.width/(2*range),scY=c.height/range,ox=c.width/2,oy=c.height;

// Grid
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=-Math.ceil(range);i<=Math.ceil(range);i++){ctx.beginPath();ctx.moveTo(ox+i*scX,0);ctx.lineTo(ox+i*scX,c.height);ctx.stroke();}
for(let i=0;i<=range;i++){ctx.beginPath();ctx.moveTo(0,oy-i*scY);ctx.lineTo(c.width,oy-i*scY);ctx.stroke();}}

// Fundamental domain of PSL(2,Z)
if(showFund){
ctx.fillStyle='rgba(255,215,0,0.1)';ctx.strokeStyle='rgba(255,215,0,0.6)';ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(ox-0.5*scX,0);ctx.lineTo(ox-0.5*scX,oy-Math.sqrt(0.75)*scY);
ctx.arc(ox,oy,scY,Math.PI*2/3,Math.PI/3,true);
ctx.lineTo(ox+0.5*scX,0);ctx.closePath();ctx.fill();ctx.stroke();
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='11px Segoe UI';
ctx.fillText('‚Ñ±',ox-8,oy-0.5*scY);}

// Horocycles at i, 2i, etc
if(showHoro){ctx.strokeStyle='rgba(0,255,136,0.3)';ctx.lineWidth=1;
for(let h=1;h<=Math.min(5,range);h++){const r=0.5/h*scY;
ctx.beginPath();ctx.arc(ox,oy-h*scY+r,r,0,2*Math.PI);ctx.stroke();}}

// Ford circles
if(showFord){ctx.lineWidth=1;
for(let q=1;q<=fordQ;q++){for(let p=-q*Math.ceil(range);p<=q*Math.ceil(range);p++){
if(gcd(Math.abs(p),q)!==1)continue;
const cx=ox+(p/q)*scX,r=1/(2*q*q)*scY;
if(r<1||cx<-50||cx>c.width+50)continue;
const alpha=Math.max(0.1,0.6-q*0.05);
ctx.strokeStyle=`hsla(${(p+q)*30},70%,60%,${alpha})`;
ctx.beginPath();ctx.arc(cx,oy-r,r,0,2*Math.PI);ctx.stroke();
if(r>8&&lbl==='frac'){ctx.fillStyle=isDark()?'#9664ff':'#6644aa';ctx.font='9px Segoe UI';
ctx.fillText(p+'/'+q,cx-10,oy-2*r-2);}}}}

// Farey arcs (geodesics between Farey neighbors)
if(showFarey){ctx.strokeStyle='rgba(255,100,150,0.4)';ctx.lineWidth=1;
const fareyPairs=[];
for(let q=1;q<=Math.min(fordQ,12);q++){for(let p=0;p<=q;p++){if(gcd(p,q)===1)fareyPairs.push([p,q]);}}
for(let i=0;i<fareyPairs.length;i++){for(let j=i+1;j<fareyPairs.length;j++){
const[p1,q1]=fareyPairs[i],[p2,q2]=fareyPairs[j];
if(Math.abs(p1*q2-p2*q1)===1){
const x1=p1/q1,x2=p2/q2,mid=(x1+x2)/2,r=Math.abs(x2-x1)/2;
if(r*scX>2&&Math.abs(mid)<range){
ctx.beginPath();ctx.arc(ox+mid*scX,oy,r*scX,Math.PI,0,true);ctx.stroke();}}}}}

// Geodesics (semicircles)
if(showGeo){ctx.strokeStyle='rgba(255,136,0,0.25)';ctx.lineWidth=1;
for(let i=1;i<=8;i++){const r=i*0.3*scY;ctx.beginPath();ctx.arc(ox,oy,r,Math.PI,0,true);ctx.stroke();}
for(let x=-3;x<=3;x++){if(x===0)continue;const r=Math.abs(x)*0.5*scX;
ctx.beginPath();ctx.arc(ox+x*0.5*scX,oy,r,Math.PI,0,true);ctx.stroke();}}

// Real axis
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,oy);ctx.lineTo(c.width,oy);ctx.stroke();

// Compute and draw points
cayleyPts=[];const pts=enum2D(R,'circle');let prim=0,maxIm=0,minIm=Infinity;
const imDist={};
for(const pt of pts){
if(pt.x===0&&pt.y===0)continue;
if(filt==='prim'&&!pt.p)continue;
if(filt==='gcd2'&&pt.g>2)continue;
if(filt==='gcd3'&&pt.g>3)continue;
const nrm=Math.sqrt(pt.x*pt.x+pt.y*pt.y);
const zNorm={x:pt.x/(nrm+.01)*.99,y:pt.y/(nrm+.01)*.99};
const w=cayley(zNorm);
if(w.y>0&&w.y<range*2&&Math.abs(w.x)<range*2){
if(pt.p)prim++;
maxIm=Math.max(maxIm,w.y);minIm=Math.min(minIm,w.y);
const imBin=Math.floor(w.y*4)/4;imDist[imBin]=(imDist[imBin]||0)+1;
const px=ox+w.x*scX,py=oy-w.y*scY;
const arg=Math.atan2(pt.y,pt.x);
let clr;
if(col==='gcd')clr=pt.p?'#00d9ff':'#ff6496';
else if(col==='prim')clr=pt.p?'#ffd700':'#555';
else if(col==='imag')clr=`hsl(${Math.floor(w.y/range*240)},80%,55%)`;
else if(col==='arg')clr=`hsl(${Math.floor((arg+Math.PI)/(2*Math.PI)*360)},80%,55%)`;
else if(col==='farey'){const fl=Math.min(nrm,10);clr=`hsl(${fl*25},70%,50%)`;}
else if(col==='fire'){const d=w.y/range;clr=d<.33?`rgb(${Math.floor(d*3*255)},0,0)`:d<.66?`rgb(255,${Math.floor((d-.33)*3*255)},0)`:`rgb(255,200,${Math.floor((d-.66)*3*255)})`;}
else if(col==='plasma'){const d=w.y/range;clr=`rgb(${Math.floor(13+d*230)},${Math.floor(8+d*92+Math.sin(d*Math.PI)*100)},${Math.floor(135+d*80)})`;}
else if(col==='viridis'){const d=w.y/range;clr=`rgb(${Math.floor(68+d*187)},${Math.floor(1+d*206)},${Math.floor(84+d*50)})`;}
else clr=pt.p?'#00d9ff':'#ff6496';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(px,py,ptSz,0,2*Math.PI);ctx.fill();
// Labels
if(lbl==='xy'){ctx.fillStyle=isDark()?'#aaa':'#555';ctx.font='9px Segoe UI';ctx.fillText(`(${pt.x},${pt.y})`,px+ptSz+2,py+3);}
else if(lbl==='w'){ctx.fillStyle=isDark()?'#aaa':'#555';ctx.font='9px Segoe UI';ctx.fillText(`${w.x.toFixed(1)}+${w.y.toFixed(1)}i`,px+ptSz+2,py+3);}
cayleyPts.push({...pt,wx:w.x,wy:w.y,px,py,arg});}}

// Axis labels
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 12px Segoe UI';
ctx.fillText('Re(w)',c.width-50,oy-10);ctx.fillText('Im(w)',ox+5,20);
for(let i=-Math.floor(range);i<=Math.floor(range);i++){if(i!==0){ctx.fillStyle=isDark()?'#888':'#666';ctx.font='10px Segoe UI';ctx.fillText(i+'',ox+i*scX-5,oy+15);}}
for(let i=1;i<=Math.floor(range);i++){ctx.fillStyle=isDark()?'#888':'#666';ctx.font='10px Segoe UI';ctx.fillText(i+'i',ox+8,oy-i*scY+4);}

// Legend and stats
legend('alcay','Cayley ‚Ñç',[]);
document.getElementById('stcay').innerHTML='';

// Live stats
const avgIm=cayleyPts.length>0?cayleyPts.reduce((s,p)=>s+p.wy,0)/cayleyPts.length:0;
const imKeys=Object.keys(imDist).sort((a,b)=>+a-+b);
document.getElementById('cayLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${cayleyPts.length}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${prim}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMITIVE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(100*prim/Math.max(1,cayleyPts.length))}%</div><div style="font-size:.7rem;color:var(--txt2)">DENSITY</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Radius R:</span><span style="color:var(--txt)">${R}</span>
<span>View Range:</span><span style="color:var(--txt)">${range}</span>
<span>Color:</span><span style="color:var(--txt)">${col}</span>
<span>Filter:</span><span style="color:var(--txt)">${filt}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Im(w) Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Min Im(w):</span><span style="color:#ff6496">${fmt(minIm)}</span>
<span>Max Im(w):</span><span style="color:#00ff88">${fmt(maxIm)}</span>
<span>Avg Im(w):</span><span style="color:#00d9ff">${fmt(avgIm)}</span>
<span>Spread:</span><span style="color:#ffd700">${fmt(maxIm-minIm)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Overlays Active</strong>
<div style="margin-top:5px;font-size:.8rem">
${showGrid?'<span style="color:#00ff88">Grid</span> ':''}${showGeo?'<span style="color:#ff8c00">Geodesics</span> ':''}${showFord?'<span style="color:#9664ff">Ford(q‚â§'+fordQ+')</span> ':''}${showFarey?'<span style="color:#ff6496">Farey</span> ':''}${showFund?'<span style="color:#ffd700">Fund.Dom</span> ':''}${showHoro?'<span style="color:#00ff88">Horocycles</span> ':''}
${!showGrid&&!showGeo&&!showFord&&!showFarey&&!showFund&&!showHoro?'<em>None</em>':''}
</div>
</div>
<div>
<strong style="color:var(--acc)">Hyperbolic Facts</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Hyperbolic area of fund. domain = œÄ/3<br>
‚Ä¢ Ford circles are tangent, never overlap<br>
‚Ä¢ Farey neighbors have |ps-qr|=1<br>
‚Ä¢ Horocycles: circles tangent to ‚Ñù at ‚àû
</div>
</div>`;

// Im(w) distribution chart
Plotly.newPlot('pcayDist',[{x:imKeys.map(k=>+k),y:imKeys.map(k=>imDist[k]),type:'bar',marker:{color:imKeys.map(k=>`hsl(${+k/range*240},70%,55%)`)}}],{...plo(),xaxis:{title:'Im(w)'},yaxis:{title:'Count'},height:200});

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
for(const p of cayleyPts){if(Math.hypot(mx-p.px,my-p.py)<ptSz+5){
const hypDist=Math.log(p.wy);
modal('Cayley Point Analysis',[
['Original (x,y)',`(${p.x}, ${p.y})`],
['Cayley w',`${fmt(p.wx)} + ${fmt(p.wy)}i`],
['|w|',fmt(Math.sqrt(p.wx*p.wx+p.wy*p.wy))],
['Arg(z)',fmt(p.arg*180/Math.PI)+'¬∞'],
['Im(w)',fmt(p.wy)],
['log(Im(w))',fmt(hypDist)],
['GCD',p.g],
['Primitive',p.p?'Yes':'No']
]);break;}}};}

function csvCayley(){let s='x,y,gcd,primitive,Re_w,Im_w,arg\n';for(const p of cayleyPts)s+=`${p.x},${p.y},${p.g},${p.p},${p.wx},${p.wy},${p.arg}\n`;dl(s,'cayley.csv');}

async function screenshotCayley(){
const c=document.getElementById('ccay'),dashData=extractDashboardData('cayLiveStats');
const R=document.getElementById('rcayv').value,range=document.getElementById('cayRange').value;
const col=document.getElementById('colCay').value,filt=document.getElementById('cayFilt').value;
const scale=2,pad=30,dashH=300;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Cayley Transform ùîª‚Üí‚Ñç ‚Äî R=${R}, Range=${range}, ${col}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
ctx.textAlign='left';
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH-20);
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#ffd700':'#cc8800';ctx.font='11px Segoe UI';
ctx.fillText('w = i(1+z)/(1-z) ¬∑ Geodesics = semicircles ‚ä• ‚Ñù ¬∑ Ford circles tangent at rationals',pad+10,out.height/scale-30);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='cayley_complete.png';a.click();},'image/png',1.0);}

function mulOrd(a,m){if(gcd(a,m)!==1)return 0;let ord=1,x=a%m;while(x!==1&&ord<=m){x=(x*a)%m;ord++;}return ord;}

function findPrimRoot(){const M=+document.getElementById('mprimv').value||+document.getElementById('mprim').value,phi=eulerPhi(M);for(let g=2;g<M;g++)if(gcd(g,M)===1&&mulOrd(g,M)===phi){document.getElementById('gprim').value=g;drawPrimRoot();return;}alert('No primitive root exists for M='+M);}

function findAllPrimRoots(){const M=+document.getElementById('mprimv').value,phi=eulerPhi(M);const roots=[];for(let g=1;g<M;g++)if(gcd(g,M)===1&&mulOrd(g,M)===phi)roots.push(g);if(roots.length>0){modal('All Primitive Roots mod '+M,[['Count',roots.length],['œÜ(œÜ(M))',eulerPhi(phi)],['Roots',roots.slice(0,30).join(', ')+(roots.length>30?' ...':'')]]);}else{alert('No primitive roots exist for M='+M);}}

function setM(m){document.getElementById('mprim').value=m;document.getElementById('mprimv').value=m;findPrimRoot();}

function isQuadraticResidue(a,p){if(gcd(a,p)!==1)return false;return modPow(a,(p-1)/2,p)===1;}
function modPow(b,e,m){let r=1;b=b%m;while(e>0){if(e%2===1)r=(r*b)%m;e=Math.floor(e/2);b=(b*b)%m;}return r;}

function eulerPhi(n){let r=n,m=n;for(let p=2;p*p<=m;p++)if(m%p===0){while(m%p===0)m/=p;r-=r/p;}if(m>1)r-=r/m;return Math.round(r);}

function discreteLog(a,g,M,phi){if(gcd(a,M)!==1)return-1;let x=1;for(let i=0;i<phi;i++){if(x===a)return i;x=(x*g)%M;}return-1;}

let primAnimId=null;
function animatePowerSeq(){
const M=+document.getElementById('mprimv').value,g=+document.getElementById('gprim').value,phi=eulerPhi(M);
if(gcd(g,M)!==1||mulOrd(g,M)!==phi){alert('g must be a primitive root');return;}
if(primAnimId)cancelAnimationFrame(primAnimId);
let step=0;const c=document.getElementById('cprim'),ctx=c.getContext('2d');
const cx=c.width/2,cy=c.height/2,rad=Math.min(cx,cy)-80;
function frame(){
drawPrimRoot();ctx.strokeStyle='rgba(255,215,0,0.8)';ctx.lineWidth=3;ctx.beginPath();
let x=1;for(let i=0;i<=step;i++){const ang=2*Math.PI*x/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);x=(x*g)%M;}
ctx.stroke();
if(step<phi){step++;primAnimId=requestAnimationFrame(frame);}else{primAnimId=null;}}
frame();}

function drawPrimRoot(){
const c=document.getElementById('cprim'),ctx=c.getContext('2d');
const M=+document.getElementById('mprimv').value||+document.getElementById('mprim').value;
const g=+document.getElementById('gprim').value,col=document.getElementById('colPrim').value;
const ptSz=+document.getElementById('primPtSz').value,lbl=document.getElementById('primLbl').value;
const showSeq=document.getElementById('primSeq').checked,showOrd=document.getElementById('primOrd').checked;
const showSubgrp=document.getElementById('primSubgrp').checked,showQR=document.getElementById('primQR').checked;
const showCosets=document.getElementById('primCosets').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,rad=Math.min(cx,cy)-80;

// Draw circle
ctx.strokeStyle=gridC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();

const phi=eulerPhi(M),isPrimRoot=gcd(g,M)===1&&mulOrd(g,M)===phi;
const elements=[],orders={},ordCounts={},qrCount=[];
let maxOrd=0;

// Compute discrete logs if g is primitive root
const dlogs={};
if(isPrimRoot){let x=1;for(let i=0;i<phi;i++){dlogs[x]=i;x=(x*g)%M;}}

for(let k=1;k<M;k++){
const ord=mulOrd(k,M);
const isUnit=gcd(k,M)===1;
const isQR=M>2&&isUnit?isQuadraticResidue(k,M):false;
const dlog=isPrimRoot&&isUnit?dlogs[k]:-1;
orders[k]=ord;
if(ord>0)ordCounts[ord]=(ordCounts[ord]||0)+1;
if(ord>maxOrd)maxOrd=ord;
elements.push({k,ord,isUnit,isQR,dlog});}

// Draw subgroup circles
if(showSubgrp&&isPrimRoot){
const divs=[];for(let d=1;d<=phi;d++)if(phi%d===0)divs.push(d);
divs.forEach((d,i)=>{if(d<phi&&d>1){
ctx.strokeStyle=`hsla(${i*60},70%,50%,0.3)`;ctx.lineWidth=1;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.arc(cx,cy,rad*d/phi,0,2*Math.PI);ctx.stroke();ctx.setLineDash([]);}});}

// Highlight quadratic residues arc
if(showQR&&M>2){
ctx.fillStyle='rgba(0,255,136,0.1)';ctx.beginPath();ctx.moveTo(cx,cy);
elements.filter(e=>e.isQR).forEach(e=>{const ang=2*Math.PI*e.k/M-Math.PI/2;ctx.lineTo(cx+rad*Math.cos(ang),cy+rad*Math.sin(ang));});
ctx.closePath();ctx.fill();}

// Draw cosets
if(showCosets&&isPrimRoot){
const H=elements.filter(e=>e.isQR).map(e=>e.k);
ctx.strokeStyle='rgba(150,100,255,0.4)';ctx.lineWidth=1;
H.forEach(h=>{const ang=2*Math.PI*h/M-Math.PI/2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+rad*Math.cos(ang),cy+rad*Math.sin(ang));ctx.stroke();});}

// Draw elements
for(const e of elements){
const ang=2*Math.PI*e.k/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
let clr;
if(col==='order')clr=e.ord===0?'#666':e.ord===phi?'#ffd700':`hsl(${Math.floor(e.ord/maxOrd*300)},100%,50%)`;
else if(col==='power')clr=e.isUnit?'#00d9ff':'#ff6496';
else if(col==='unit')clr=e.isUnit?'#00ff88':'#ff6496';
else if(col==='quadres')clr=e.isQR?'#00ff88':e.isUnit?'#ff8c00':'#666';
else if(col==='generator')clr=e.ord===phi?'#ffd700':e.isUnit?'#00d9ff':'#666';
else if(col==='discrete')clr=e.dlog>=0?`hsl(${e.dlog/phi*360},80%,50%)`:'#666';
else clr=e.isUnit?'#00d9ff':'#ff6496';

ctx.fillStyle=clr;
const sz=e.ord===phi?ptSz+2:ptSz;
ctx.beginPath();ctx.arc(px,py,sz,0,2*Math.PI);ctx.fill();

// Labels
if(lbl!=='none'||(showOrd&&e.ord>0)){
ctx.fillStyle=isDark()?'rgba(255,255,255,0.85)':'rgba(0,0,0,0.85)';ctx.font='10px Arial';ctx.textAlign='center';
let txt='';
if(lbl==='value')txt=e.k;
else if(lbl==='order')txt=e.ord>0?e.ord:'';
else if(lbl==='dlog')txt=e.dlog>=0?e.dlog:'';
else if(showOrd&&e.ord>0)txt=e.ord;
if(txt!=='')ctx.fillText(txt,px,py-ptSz-5);}}

// Power sequence
if(showSeq&&isPrimRoot){
ctx.strokeStyle='rgba(255,215,0,0.6)';ctx.lineWidth=2;ctx.beginPath();
let x=1;for(let i=0;i<=phi;i++){
const ang=2*Math.PI*x/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);x=(x*g)%M;}
ctx.stroke();}

// Title
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M = ${M}, œÜ(M) = ${phi}, g = ${g}`,cx,25);
ctx.fillStyle=isPrimRoot?'#00ff88':'#ff6496';
ctx.fillText(isPrimRoot?'‚úì g is a PRIMITIVE ROOT':'‚úó g is NOT a primitive root',cx,45);

const primRoots=elements.filter(e=>e.ord===phi).map(e=>e.k);
const qrs=elements.filter(e=>e.isQR).length;
const units=elements.filter(e=>e.isUnit).length;

// Legend
legend('alprim','Primitive Roots',[]);
document.getElementById('stprim').innerHTML='';

// Live stats
document.getElementById('primLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${M}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS M</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${phi}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ(M)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${primRoots.length}</div><div style="font-size:.7rem;color:var(--txt2)">PRIM ROOTS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Generator Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>g:</span><span style="color:var(--txt)">${g}</span>
<span>ord(g):</span><span style="color:${mulOrd(g,M)===phi?'#00ff88':'#ff6496'}">${mulOrd(g,M)}</span>
<span>Is Prim Root:</span><span style="color:${isPrimRoot?'#00ff88':'#ff6496'}">${isPrimRoot?'Yes':'No'}</span>
<span>gcd(g,M):</span><span style="color:var(--txt)">${gcd(g,M)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Group Structure</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Units |(‚Ñ§/M‚Ñ§)√ó|:</span><span style="color:#00d9ff">${units}</span>
<span>Quadratic Residues:</span><span style="color:#00ff88">${qrs}</span>
<span>Non-Residues:</span><span style="color:#ff8c00">${units-qrs}</span>
<span>Max Order:</span><span style="color:#ffd700">${maxOrd}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Primitive Roots</strong>
<div style="margin-top:5px;font-size:.8rem">
<span>Count: <strong style="color:#ffd700">${primRoots.length}</strong></span>
<span style="margin-left:10px">œÜ(œÜ(M)): <strong style="color:#9664ff">${eulerPhi(phi)}</strong></span>
<div style="margin-top:5px;color:var(--txt2);word-break:break-all">${primRoots.slice(0,15).join(', ')}${primRoots.length>15?' ...':''}</div>
</div>
</div>
<div>
<strong style="color:var(--acc)">Existence Test</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
Prim roots exist for M = 1,2,4,p·µè,2p·µè<br>
M=${M}: ${primRoots.length>0?'<span style="color:#00ff88">‚úì Has primitive roots</span>':'<span style="color:#ff6496">‚úó No primitive roots</span>'}
</div>
</div>`;

// Order distribution chart
const ordData=Object.entries(ordCounts).sort((a,b)=>+a[0]-+b[0]);
Plotly.newPlot('pprimord',[{x:ordData.map(d=>d[0]),y:ordData.map(d=>d[1]),type:'bar',marker:{color:ordData.map(d=>+d[0]===phi?'#ffd700':'#00d9ff')}}],{...plo(),xaxis:{title:'Order'},yaxis:{title:'Count'},height:200});

// Power sequence plot
if(isPrimRoot){
const seqX=[],seqY=[];let x=1;
for(let i=0;i<=phi;i++){seqX.push(i);seqY.push(x);x=(x*g)%M;}
Plotly.newPlot('pprimseq',[{x:seqX,y:seqY,mode:'lines+markers',line:{color:'#ffd700'},marker:{size:4}}],{...plo(),xaxis:{title:'Power n'},yaxis:{title:'g‚Åø mod M'},height:180});}
else{Plotly.newPlot('pprimseq',[{x:[],y:[]}],{...plo(),height:180,annotations:[{text:'Select a primitive root to see power sequence',showarrow:false,font:{size:12,color:'#888'}}]});}

// Table
document.getElementById('tprimT').innerHTML='<tr><th>k</th><th>ord(k)</th><th>Unit?</th><th>Prim Root?</th><th>QR?</th><th>Disc Log</th></tr>'+
elements.slice(0,100).map(e=>`<tr onclick="modal('Element ${e.k} mod ${M}',[['k',${e.k}],['ord(k)',${e.ord}],['Unit',${e.isUnit}],['Prim Root',${e.ord===phi}],['QR',${e.isQR}],['Discrete Log',${e.dlog}]])" style="cursor:pointer;color:${e.ord===phi?'#ffd700':e.isUnit?'inherit':'#666'}"><td>${e.k}</td><td>${e.ord}</td><td>${e.isUnit?'‚úì':'‚úó'}</td><td>${e.ord===phi?'‚úì':''}</td><td>${e.isQR?'‚úì':''}</td><td>${e.dlog>=0?e.dlog:'‚Äî'}</td></tr>`).join('');

primRootData={M,phi,g,isPrimRoot,elements,primRoots,maxOrd};

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
for(const el of elements){const ang=2*Math.PI*el.k/M-Math.PI/2,px=cx+rad*Math.cos(ang),py=cy+rad*Math.sin(ang);
if(Math.hypot(mx-px,my-py)<ptSz+5){
modal('Element Analysis',[['k',el.k],['Order',el.ord],['Unit',el.isUnit?'Yes':'No'],['Primitive Root',el.ord===phi?'Yes':'No'],['Quadratic Residue',el.isQR?'Yes':'No'],['Discrete Log',el.dlog>=0?el.dlog:'N/A']]);break;}}};}

function csvPrim(){let s='k,order,isUnit,isPrimRoot,isQR,discreteLog\n';for(const e of primRootData.elements||[])s+=`${e.k},${e.ord},${e.isUnit},${e.ord===primRootData.phi},${e.isQR},${e.dlog}\n`;dl(s,'primitive_roots.csv');}

// ==================== FAREY SEQUENCES ====================
let fareyData={seq:[],Q:0};

function setFareyQ(q){document.getElementById('fareyQ').value=Math.min(50,q);document.getElementById('fareyQv').value=q;drawFarey();}

function generateFarey(Q){
const seq=[{p:0,q:1,level:1,value:0}];
for(let q=1;q<=Q;q++){for(let p=0;p<=q;p++){if(gcd(p,q)===1&&!(p===0&&q>1)){
seq.push({p,q,level:q,value:p/q});}}}
seq.sort((a,b)=>a.value-b.value);
// Find neighbors
for(let i=0;i<seq.length;i++){
seq[i].idx=i;
seq[i].left=i>0?seq[i-1]:null;
seq[i].right=i<seq.length-1?seq[i+1]:null;}
return seq;}

function fareyLevel(p,q){return q;}

function mediant(a,b){return{p:a.p+b.p,q:a.q+b.q};}

function highlightFraction(){
const p=+document.getElementById('fareyP').value,q=+document.getElementById('fareyQh').value;
if(q<=0||gcd(p,q)!==1){alert('Enter valid coprime p/q');return;}
const found=fareyData.seq.find(f=>f.p===p&&f.q===q);
if(found){
modal(`Fraction ${p}/${q}`,[
['Value',found.value],['Level (first appears)',found.q],['Index',found.idx],
['Left Neighbor',found.left?`${found.left.p}/${found.left.q}`:'‚Äî'],
['Right Neighbor',found.right?`${found.right.p}/${found.right.q}`:'‚Äî'],
['Ford Circle Center',`(${p/q}, ${1/(2*q*q)})`],['Ford Circle Radius',1/(2*q*q)]
]);}else{alert(`${p}/${q} not in F_${fareyData.Q} (need q‚â§${fareyData.Q})`);}drawFarey();}

function drawFarey(){
const c=document.getElementById('cfarey'),ctx=c.getContext('2d');
const Q=+document.getElementById('fareyQv').value||+document.getElementById('fareyQ').value;
const viz=document.getElementById('fareyViz').value,col=document.getElementById('fareyCol').value;
const ptSz=+document.getElementById('fareySz').value;
const showLabels=document.getElementById('fareyLabels').checked;
const showMediant=document.getElementById('fareyMediant').checked;
const showNeighbor=document.getElementById('fareyNeighbor').checked;
const showGrid=document.getElementById('fareyGrid').checked;
const showCircles=document.getElementById('fareyCircles').checked;
const highlightP=+document.getElementById('fareyP').value,highlightQ=+document.getElementById('fareyQh').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('fareyQdisp').textContent=Q;

// Generate Farey sequence
fareyData.seq=generateFarey(Q);
fareyData.Q=Q;
const seq=fareyData.seq;

const pad=50,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='sequence'){
// Line visualization
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){const x=pad+i*w/10;ctx.beginPath();ctx.moveTo(x,pad);ctx.lineTo(x,c.height-pad);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='center';ctx.fillText((i/10).toFixed(1),x,c.height-pad+15);}}
// Real line
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pad,c.height/2);ctx.lineTo(c.width-pad,c.height/2);ctx.stroke();
// Points
seq.forEach((f,i)=>{
const x=pad+f.value*w,y=c.height/2;
let clr;
if(col==='denom')clr=`hsl(${f.q/Q*300},80%,50%)`;
else if(col==='level')clr=`hsl(${f.level/Q*300},80%,50%)`;
else if(col==='depth')clr=`hsl(${Math.log2(f.q+1)/Math.log2(Q+1)*300},80%,50%)`;
else if(col==='parent')clr=f.q<=2?'#ffd700':'#00d9ff';
else clr=`hsl(${i/seq.length*360},80%,50%)`;
if(f.p===highlightP&&f.q===highlightQ)clr='#ff006e';
ctx.fillStyle=clr;
const sz=f.p===highlightP&&f.q===highlightQ?ptSz+4:ptSz;
ctx.beginPath();ctx.arc(x,y,sz,0,2*Math.PI);ctx.fill();
// Labels
if(showLabels&&(f.q<=Math.min(8,Q)||f.p===highlightP&&f.q===highlightQ)){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(`${f.p}/${f.q}`,x,y-ptSz-8);}});}

else if(viz==='ford'){
// Ford circles
const scale=w,ox=pad,oy=c.height-80;
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){const x=ox+i*scale/10;ctx.beginPath();ctx.moveTo(x,50);ctx.lineTo(x,oy);ctx.stroke();}}
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(ox+scale,oy);ctx.stroke();
seq.forEach(f=>{
if(f.q===0)return;
const cx=ox+f.value*scale,r=scale/(2*f.q*f.q);
if(r<1)return;
let clr;
if(col==='denom')clr=`hsla(${f.q/Q*300},70%,50%,0.7)`;
else if(col==='level')clr=`hsla(${f.level/Q*300},70%,50%,0.7)`;
else clr=`hsla(${f.value*360},70%,50%,0.7)`;
if(f.p===highlightP&&f.q===highlightQ)clr='rgba(255,0,110,0.9)';
ctx.strokeStyle=clr;ctx.lineWidth=f.q<=5?2:1;
ctx.beginPath();ctx.arc(cx,oy-r,r,0,2*Math.PI);ctx.stroke();
if(showLabels&&r>10){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(`${f.p}/${f.q}`,cx,oy-2*r-5);}});
// Tangency lines
if(showCircles){ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
for(let i=0;i<seq.length-1;i++){
const a=seq[i],b=seq[i+1];
if(Math.abs(a.p*b.q-b.p*a.q)===1){
const cx1=ox+a.value*scale,r1=scale/(2*a.q*a.q);
const cx2=ox+b.value*scale,r2=scale/(2*b.q*b.q);
ctx.beginPath();ctx.moveTo(cx1,oy-r1);ctx.lineTo(cx2,oy-r2);ctx.stroke();}}}}

else if(viz==='arc'){
// Farey arcs (geodesics in upper half-plane)
const scale=w,ox=pad,oy=c.height-50;
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(ox+scale,oy);ctx.stroke();
// Draw arcs between neighbors
for(let i=0;i<seq.length-1;i++){
const a=seq[i],b=seq[i+1];
const x1=a.value,x2=b.value;
const mid=(x1+x2)/2,r=Math.abs(x2-x1)/2;
let clr;
if(col==='denom')clr=`hsla(${(a.q+b.q)/2/Q*300},70%,50%,0.6)`;
else clr=`hsla(${i/seq.length*360},70%,50%,0.6)`;
ctx.strokeStyle=clr;ctx.lineWidth=1;
ctx.beginPath();ctx.arc(ox+mid*scale,oy,r*scale,Math.PI,0,true);ctx.stroke();}
// Points on real line
seq.forEach(f=>{
const x=ox+f.value*scale;
ctx.fillStyle=f.p===highlightP&&f.q===highlightQ?'#ff006e':'#ffd700';
ctx.beginPath();ctx.arc(x,oy,3,0,2*Math.PI);ctx.fill();
if(showLabels&&f.q<=6){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(`${f.p}/${f.q}`,x,oy+15);}});}

else if(viz==='tree'){
// Stern-Brocot tree visualization
const levels=Math.min(6,Math.ceil(Math.log2(Q)));
ctx.strokeStyle=gridC();ctx.lineWidth=1;
function drawTree(left,right,depth,x,y,w){
if(depth>levels)return;
const m=mediant(left,right);
if(m.q>Q)return;
const mx=x,my=y;
let clr=`hsl(${depth*50},70%,50%)`;
if(m.p===highlightP&&m.q===highlightQ)clr='#ff006e';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(mx,my,ptSz+2-depth*0.3,0,2*Math.PI);ctx.fill();
if(showLabels&&depth<=4){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(`${m.p}/${m.q}`,mx,my-10);}
if(depth<levels){
const nextY=my+60;
// Left child
ctx.strokeStyle='rgba(100,200,255,0.4)';ctx.beginPath();ctx.moveTo(mx,my+ptSz);ctx.lineTo(x-w/4,nextY-ptSz);ctx.stroke();
drawTree(left,m,depth+1,x-w/4,nextY,w/2);
// Right child  
ctx.strokeStyle='rgba(255,140,0,0.4)';ctx.beginPath();ctx.moveTo(mx,my+ptSz);ctx.lineTo(x+w/4,nextY-ptSz);ctx.stroke();
drawTree(m,right,depth+1,x+w/4,nextY,w/2);}}
// Root nodes 0/1 and 1/1
ctx.fillStyle='#ffd700';
ctx.beginPath();ctx.arc(pad+w*0.1,60,8,0,2*Math.PI);ctx.fill();
ctx.beginPath();ctx.arc(pad+w*0.9,60,8,0,2*Math.PI);ctx.fill();
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Arial';ctx.textAlign='center';
ctx.fillText('0/1',pad+w*0.1,45);ctx.fillText('1/1',pad+w*0.9,45);
drawTree({p:0,q:1},{p:1,q:1},1,c.width/2,120,w*0.8);}

else if(viz==='spiral'){
// Farey spiral
const cx=c.width/2,cy=c.height/2,maxR=Math.min(cx,cy)-60;
seq.forEach((f,i)=>{
const theta=f.value*4*Math.PI;
const r=20+i/seq.length*maxR;
const x=cx+r*Math.cos(theta),y=cy+r*Math.sin(theta);
let clr;
if(col==='denom')clr=`hsl(${f.q/Q*300},80%,50%)`;
else clr=`hsl(${i/seq.length*360},80%,50%)`;
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();});}

// Mediant lines
if(showMediant&&viz==='sequence'){
ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
for(let i=0;i<seq.length-1;i++){
const m=mediant(seq[i],seq[i+1]);
if(m.q<=Q){const x=pad+m.p/m.q*w;
ctx.beginPath();ctx.moveTo(x,c.height/2-20);ctx.lineTo(x,c.height/2+20);ctx.stroke();}}}

// Stats
const denomCounts={};seq.forEach(f=>{denomCounts[f.q]=(denomCounts[f.q]||0)+1;});
const denomData=Object.entries(denomCounts).sort((a,b)=>+a[0]-+b[0]);

// Live stats
document.getElementById('fareyLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${Q}</div><div style="font-size:.7rem;color:var(--txt2)">MAX DENOM Q</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${seq.length}</div><div style="font-size:.7rem;color:var(--txt2)">|F_Q|</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${fmt(3*Q*Q/(Math.PI*Math.PI))}</div><div style="font-size:.7rem;color:var(--txt2)">THEORY 3Q¬≤/œÄ¬≤</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Sequence Properties</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Actual |F_Q|:</span><span style="color:#00d9ff">${seq.length}</span>
<span>Theory 3Q¬≤/œÄ¬≤:</span><span style="color:#ffd700">${fmt(3*Q*Q/(Math.PI*Math.PI))}</span>
<span>Error:</span><span style="color:#00ff88">${fmt(Math.abs(seq.length-3*Q*Q/(Math.PI*Math.PI)))}</span>
<span>Œ£œÜ(k) for k‚â§Q:</span><span style="color:#9664ff">${seq.length-1}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Visualization</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Mode:</span><span style="color:var(--txt)">${viz}</span>
<span>Color:</span><span style="color:var(--txt)">${col}</span>
<span>Point Size:</span><span style="color:var(--txt)">${ptSz}px</span>
<span>Labels:</span><span style="color:var(--txt)">${showLabels?'On':'Off'}</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">Key Facts</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Neighbors p/q, r/s satisfy |ps-qr|=1<br>
‚Ä¢ Mediant (p+r)/(q+s) lies between<br>
‚Ä¢ Ford circles tangent ‚ü∫ neighbors<br>
‚Ä¢ |F_Q| = 1 + Œ£œÜ(k) ‚âà 3Q¬≤/œÄ¬≤
</div>
</div>`;

// Growth chart
const growthX=[],growthY=[],growthTh=[];
for(let q=1;q<=Q;q++){growthX.push(q);growthY.push(generateFarey(q).length);growthTh.push(1+3*q*q/(Math.PI*Math.PI));}
Plotly.newPlot('pfareyGrowth',[
{x:growthX,y:growthY,name:'|F_Q|',mode:'lines+markers',line:{color:'#00d9ff',width:2},marker:{size:4}},
{x:growthX,y:growthTh,name:'3Q¬≤/œÄ¬≤',mode:'lines',line:{color:'#ff8c00',dash:'dash'}}
],{...plo(),xaxis:{title:'Q'},yaxis:{title:'|F_Q|'},height:180});

// Denominator distribution
Plotly.newPlot('pfareyDenom',[{x:denomData.map(d=>d[0]),y:denomData.map(d=>d[1]),type:'bar',marker:{color:denomData.map(d=>`hsl(${+d[0]/Q*300},70%,50%)`)}}],{...plo(),xaxis:{title:'Denominator q'},yaxis:{title:'Count œÜ(q)'},height:180});

// Legend and stats bar
legend('alfarey','Farey F_'+Q,[]);
document.getElementById('stfarey').innerHTML='';

// Table
document.getElementById('tfareyT').innerHTML='<tr><th>Index</th><th>p/q</th><th>Value</th><th>Level</th><th>Left</th><th>Right</th></tr>'+
seq.slice(0,80).map(f=>`<tr onclick="modal('${f.p}/${f.q}',[['Value',${f.value}],['First appears in F_',${f.q}],['Index',${f.idx}],['Left','${f.left?f.left.p+'/'+f.left.q:'‚Äî'}'],['Right','${f.right?f.right.p+'/'+f.right.q:'‚Äî'}'],['Ford radius',${1/(2*f.q*f.q)}]])" style="cursor:pointer;color:${f.p===highlightP&&f.q===highlightQ?'#ff006e':'inherit'}"><td>${f.idx}</td><td>${f.p}/${f.q}</td><td>${f.value.toFixed(6)}</td><td>F_${f.q}</td><td>${f.left?f.left.p+'/'+f.left.q:'‚Äî'}</td><td>${f.right?f.right.p+'/'+f.right.q:'‚Äî'}</td></tr>`).join('');

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='sequence'){
const y0=c.height/2;
for(const f of seq){const x=pad+f.value*w;
if(Math.hypot(mx-x,my-y0)<ptSz+5){
modal(`Fraction ${f.p}/${f.q}`,[['Value',f.value],['Level',f.q],['Index',f.idx],['Left',f.left?f.left.p+'/'+f.left.q:'‚Äî'],['Right',f.right?f.right.p+'/'+f.right.q:'‚Äî'],['Ford Center',`(${f.value.toFixed(4)}, ${(1/(2*f.q*f.q)).toFixed(6)})`],['Ford Radius',(1/(2*f.q*f.q)).toFixed(6)]]);break;}}}};}

function csvFarey(){let s='index,p,q,value,level,left_p,left_q,right_p,right_q\n';
for(const f of fareyData.seq)s+=`${f.idx},${f.p},${f.q},${f.value},${f.q},${f.left?f.left.p:''},${f.left?f.left.q:''},${f.right?f.right.p:''},${f.right?f.right.q:''}\n`;
dl(s,'farey.csv');}

async function screenshotFarey(){
const Q=document.getElementById('fareyQv').value,viz=document.getElementById('fareyViz').value;
await screenshotUnified('cfarey','fareyLiveStats',`Farey Sequence F_${Q} ‚Äî ${viz} view`,'farey_complete.png',{dashH:300});
}

// ==================== END FAREY ====================

async function screenshotPrim(){
const M=document.getElementById('mprimv').value;
await screenshotUnified('cprim','primLiveStats',`Primitive Roots & Cyclic Structure (‚Ñ§/${M}‚Ñ§)√ó`,'primitive_roots_complete.png',{dashH:320});
}

let modRingData=[];

function setPhase(deg){document.getElementById('modPhase').value=deg;document.getElementById('modPhaseNum').value=deg;document.getElementById('modPhaseV').textContent=deg+'¬∞';drawModRings();}
function setRingInc(deg){document.getElementById('ringInc').value=Math.min(90,deg);document.getElementById('ringIncNum').value=deg;document.getElementById('ringIncV').textContent=deg+'¬∞';drawModRings();}

function drawModRings(){
const c=document.getElementById('cmod'),ctx=c.getContext('2d');
const viewMode=document.getElementById('modViewMode').value;

// Toggle control visibility
document.getElementById('modMultiControls').style.display=viewMode==='multi'?'block':'none';
document.getElementById('modSingleControls').style.display=viewMode==='single'?'block':'none';

if(viewMode==='single'){
drawSingleMProjection(c,ctx);
return;
}

const minM=+document.getElementById('modMin').value,maxM=+document.getElementById('modMax').value;
const spacing=document.getElementById('modSpace').value,col=document.getElementById('modCol').value;
const phase=+document.getElementById('modPhase').value*Math.PI/180,ptSz=+document.getElementById('modPtSz').value;
const ringInc=+document.getElementById('ringIncNum').value*Math.PI/180;
const showDirect=document.getElementById('modDirect').checked,showGcd1=document.getElementById('modGcd1').checked;
const showUnit=document.getElementById('modUnit').checked;
const gapThick=parseFloat(document.getElementById('gapThick').value);
const liftThick=parseFloat(document.getElementById('liftThick').value);
const labelMode=document.getElementById('modLabel').value,labelSz=+document.getElementById('modLblSz').value;
const selectedGaps=[];
if(document.getElementById('gap2').checked)selectedGaps.push(2);
if(document.getElementById('gap4').checked)selectedGaps.push(4);
if(document.getElementById('gap6').checked)selectedGaps.push(6);
if(document.getElementById('gap8').checked)selectedGaps.push(8);
if(document.getElementById('gap10').checked)selectedGaps.push(10);
const smithEnabled=document.getElementById('smithMod').checked,smithAlpha=+document.getElementById('smithAMod').value;
const smithRMode=document.getElementById('smithRMod').value,smithZoom=+document.getElementById('smithZoom').value;
const smithGrid=document.getElementById('smithGridMod').checked,smithConstR=document.getElementById('smithCircRMod').checked,smithConstX=document.getElementById('smithArcXMod').checked;
ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,maxRad=Math.min(cx,cy)-40;
const smithRad=maxRad*smithZoom;
if(smithEnabled){drawSmithGrid(ctx,cx,cy,smithRad,smithGrid,smithConstR,smithConstX);ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,smithRad,0,2*Math.PI);ctx.stroke();}
const rings=[];for(let m=minM;m<=maxM;m++)rings.push(m);
const getRadius=(m,i)=>{const n=rings.length;if(spacing==='uniform')return maxRad*(i+1)/(n+1);if(spacing==='linear')return maxRad*m/maxM;if(spacing==='sqrt')return maxRad*Math.sqrt(m)/Math.sqrt(maxM);if(spacing==='log')return maxRad*Math.log(m+1)/Math.log(maxM+1);if(spacing==='phi')return maxRad*eulerPhi(m)/eulerPhi(maxM);return maxRad*(i+1)/(n+1);};
const getSmithR=(i,m)=>{if(smithRMode==='unit')return 1;if(smithRMode==='scaled')return 0.5+(i/Math.max(1,rings.length-1))*1.5;if(smithRMode==='modulus')return Math.min(3,Math.log(m+1)/Math.log(10));return 1;};
const spf=(n)=>{if(n<2)return n;for(let p=2;p*p<=n;p++)if(n%p===0)return p;return n;};
const spfColors={2:'#FF6B6B',3:'#4ECDC4',5:'#FFE66D',7:'#95E1D3',11:'#F38181',13:'#AA96DA',17:'#FCBAD3',19:'#A8D8EA',23:'#DFE6E9'};
modRingData=[];let totalPts=0,totalGcd1=0;
if(showUnit&&minM===1&&!smithEnabled){ctx.strokeStyle='rgba(255,215,0,0.8)';ctx.lineWidth=3;ctx.beginPath();ctx.arc(cx,cy,getRadius(1,0),0,2*Math.PI);ctx.stroke();ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(cx,cy,ptSz+2,0,2*Math.PI);ctx.fill();}
for(let i=0;i<rings.length;i++){const m=rings[i];if(m<2)continue;const rad=getRadius(m,i),phi=eulerPhi(m);
if(!smithEnabled){ctx.strokeStyle=gridC();ctx.lineWidth=1;ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();}
const coprimes=[];for(let r=0;r<m;r++)if(gcd(r,m)===1)coprimes.push(r);
const pts=[];for(let r=0;r<m;r++){const g=gcd(r,m),isGcd1=g===1;if(showGcd1&&!isGcd1)continue;
const ang=2*Math.PI*r/m-Math.PI/2+phase+(i*ringInc);
let px,py;
if(smithEnabled){const smR=getSmithR(i,m);const theta=ang+smithAlpha*Math.PI/180;let gamma;if(smithRMode==='unit'){gamma={re:0,im:Math.tan(theta/2)};}else{const A=smR*Math.cos(theta)-1,B=smR*Math.sin(theta),C=smR*Math.cos(theta)+1;const denom=C*C+B*B;gamma=denom<1e-10?{re:0,im:0}:{re:(A*C+B*B)/denom,im:B*(C-A)/denom};}px=cx+gamma.re*smithRad;py=cy-gamma.im*smithRad;}
else{px=cx+rad*Math.cos(ang);py=cy+rad*Math.sin(ang);}
let clr;const angle=r/m;
if(col==='rainbow')clr=`hsl(${Math.floor(angle*360)},75%,65%)`;
else if(col==='gcd')clr=isGcd1?'#ffd700':'#666666';
else if(col==='gcd_per_mod'){if(isGcd1){const modHue=(m*67)%360;clr=`hsl(${modHue},85%,70%)`;}else clr='#666666';}
else if(col==='gcd_spectrum'){if(isGcd1){const density=phi/m;const spectralHue=(density*240+r*15)%360;const sat=60+density*30;clr=`hsl(${spectralHue},${sat}%,65%)`;}else clr='#666666';}
else if(col==='spf'){const pf=spf(r);clr=spfColors[pf]||`hsl(${(pf*37)%360},70%,60%)`;}
else if(col==='ring')clr=`hsl(${Math.floor(i/rings.length*300)},78%,62%)`;
else if(col==='residue')clr=`hsl(${(r*37)%360},80%,70%)`;
else if(col==='prime'){const isPr=r>1&&[...Array(Math.floor(Math.sqrt(r))+1)].every((_,j)=>j<2||r%j!==0);clr=isPr?'#FF6B6B':'#4ECDC4';}
else clr=isGcd1?'#ffd700':'#666666';
pts.push({r,m,g,isGcd1,ang,px,py,clr,rad});totalPts++;if(isGcd1)totalGcd1++;}
for(const pt of pts){ctx.fillStyle=pt.clr;ctx.beginPath();ctx.arc(pt.px,pt.py,pt.isGcd1?ptSz:ptSz*.7,0,2*Math.PI);ctx.fill();}
if(labelMode!=='none'){ctx.font=`${labelSz}px Segoe UI`;ctx.textAlign='center';ctx.textBaseline='bottom';
for(const pt of pts){let lbl='';if(labelMode==='r')lbl=pt.r;else if(labelMode==='rm')lbl=`${pt.r}/${pt.m}`;else if(labelMode==='deg')lbl=Math.round((pt.ang+Math.PI/2)*180/Math.PI)+'¬∞';else if(labelMode==='gcd')lbl=pt.g;ctx.fillStyle=isDark()?'rgba(255,255,255,0.85)':'rgba(0,0,0,0.85)';ctx.fillText(lbl,pt.px,pt.py-ptSz-2);}}
modRingData.push({m,phi,pts,coprimes,index:i});}
const gapLineWidth=0.2+gapThick*2.8;
selectedGaps.forEach((gap,gapIdx)=>{const hue=(gapIdx*360/selectedGaps.length)%360;
for(const ring of modRingData){ring.coprimes.forEach(r=>{const r2=(r+gap)%ring.m;if(ring.coprimes.includes(r2)){const p1=ring.pts.find(p=>p.r===r&&p.isGcd1);const p2=ring.pts.find(p=>p.r===r2&&p.isGcd1);if(p1&&p2){ctx.beginPath();ctx.moveTo(p1.px,p1.py);ctx.lineTo(p2.px,p2.py);ctx.strokeStyle=`hsla(${hue},75%,65%,0.6)`;ctx.lineWidth=gapLineWidth;ctx.stroke();}}});}});
if(showDirect){const liftLineWidth=0.5+liftThick*3.5;ctx.strokeStyle='rgba(255,215,0,0.7)';ctx.lineWidth=liftLineWidth;
for(let i=0;i<modRingData.length-1;i++){const curr=modRingData[i],next=modRingData[i+1];for(const p1 of curr.pts){if(!p1.isGcd1)continue;const p2=next.pts.find(p=>p.r===p1.r&&p.isGcd1);if(p2){ctx.beginPath();ctx.moveTo(p1.px,p1.py);ctx.lineTo(p2.px,p2.py);ctx.stroke();}}}}
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(smithEnabled?`Smith Chart: M=${minM} to ${maxM}, Œ±=${smithAlpha}¬∞, Zoom ${smithZoom}x`:`Modular Rings M=${minM} to ${maxM}`,cx,20);
legend('almod',smithEnabled?'Smith Chart':'Modular Rings',[]);
document.getElementById('stmod').innerHTML='';
const phiData=modRingData.filter(r=>r.m>1).map(r=>({m:r.m,phi:r.phi,density:r.phi/r.m}));
Plotly.newPlot('pmodphi',[{x:phiData.map(d=>d.m),y:phiData.map(d=>d.density),type:'scatter',mode:'lines+markers',name:'œÜ(M)/M',line:{color:'#ffd700'},marker:{color:'#ffd700'}}],{...plo(),xaxis:{title:'Modulus M'},yaxis:{title:'œÜ(M)/M',range:[0,1]}});
const avgDensity=phiData.length>0?phiData.reduce((a,d)=>a+d.density,0)/phiData.length:0;
const minDensity=phiData.length>0?Math.min(...phiData.map(d=>d.density)):0;
const maxDensity=phiData.length>0?Math.max(...phiData.map(d=>d.density)):0;
const gapColors={2:'#FF6B6B',4:'#4ECDC4',6:'#FFE66D',8:'#95E1D3',10:'#F38181'};
let gapHtml=selectedGaps.length>0?selectedGaps.map(g=>`<span style="display:inline-block;padding:2px 8px;margin:2px;border-radius:4px;background:${gapColors[g]||'#888'};color:#000;font-weight:bold">Gap ${g}</span>`).join(''):'<em>None</em>';
const phaseDeg=phase*180/Math.PI,ringIncDeg=ringInc*180/Math.PI;
document.getElementById('modLiveStats').innerHTML=`
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Configuration</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Modulus Range:</span><span style="color:var(--txt)">${minM} ‚Üí ${maxM}</span>
<span>Ring Count:</span><span style="color:var(--txt)">${rings.length}</span>
<span>Spacing:</span><span style="color:var(--txt)">${spacing}</span>
<span>Color Mode:</span><span style="color:var(--txt)">${col}</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Rotation Settings</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Global Phase Œ±:</span><span style="color:#00d9ff;font-weight:bold">${phaseDeg.toFixed(2)}¬∞</span>
<span>Phase as r/m:</span><span style="color:#9664ff">${phaseDeg>0?fmt(phaseDeg/360)+' rev':'0'}</span>
<span>Per-Ring Increment:</span><span style="color:#ffd700;font-weight:bold">${ringIncDeg.toFixed(2)}¬∞</span>
<span>Total Twist:</span><span style="color:#ff8c00">${fmt(ringIncDeg*(rings.length-1))}¬∞</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Statistics</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Total Residues:</span><span style="color:#00d9ff;font-weight:bold">${totalPts}</span>
<span>GCD=1 Count:</span><span style="color:#ffd700;font-weight:bold">${totalGcd1}</span>
<span>Coprime Density:</span><span style="color:#00ff88;font-weight:bold">${fmt(100*totalGcd1/totalPts)}%</span>
<span>Avg œÜ(M)/M:</span><span style="color:#ffd700">${fmt(avgDensity*100)}%</span>
<span>Min œÜ(M)/M:</span><span style="color:#ff6496">${fmt(minDensity*100)}%</span>
<span>Max œÜ(M)/M:</span><span style="color:#00ff88">${fmt(maxDensity*100)}%</span>
</div>
</div>
<div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Active Gaps</strong><br>
<div style="margin-top:6px">${gapHtml}</div>
</div>
<div>
<strong style="color:var(--acc)">Connections</strong><br>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
<span>Direct Lifts:</span><span style="color:${showDirect?'#00ff88':'#ff6496'}">${showDirect?'ON':'OFF'}</span>
<span>Smith Chart:</span><span style="color:${smithEnabled?'#00ff88':'#ff6496'}">${smithEnabled?'ON':'OFF'}</span>
${smithEnabled?`<span>Smith Zoom:</span><span style="color:var(--txt)">${smithZoom}x</span>
<span>Phase Œ±:</span><span style="color:var(--txt)">${smithAlpha}¬∞</span>`:''}
</div>
</div>`;
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);for(const ring of modRingData)for(const p of ring.pts)if(Math.hypot(mx-p.px,my-p.py)<ptSz+5){const theta=p.ang+smithAlpha*Math.PI/180;const smR=smithEnabled?getSmithR(ring.index,ring.m):1;let gamma;if(smithRMode==='unit')gamma={re:0,im:Math.tan(theta/2)};else{const A=smR*Math.cos(theta)-1,B=smR*Math.sin(theta),C=smR*Math.cos(theta)+1;const denom=C*C+B*B;gamma=denom<1e-10?{re:0,im:0}:{re:(A*C+B*B)/denom,im:B*(C-A)/denom};}modal('Residue Point',[['Residue r',p.r],['Modulus M',p.m],['GCD(r,M)',p.g],['Coprime œá(r)‚â†0',p.isGcd1?'Yes':'No'],['Angle Œ∏',fmt(p.ang*180/Math.PI)+'¬∞'],['œÜ(M)',ring.phi],smithEnabled?['Œì (Smith)',`${gamma.re.toFixed(4)} + ${gamma.im.toFixed(4)}i`]:['Ring Radius',fmt(p.rad)]]);return;}};}

// Single M Projection Mode (Farey Channels)
function drawSingleMProjection(c,ctx){
const M=+document.getElementById('modSingleM').value||60;
const showFarey=document.getElementById('modFareyLines').checked;
const fareyCol=document.getElementById('modFareyCol').value;
const fareyThick=+document.getElementById('modFareyThick').value;
const showAllPts=document.getElementById('modShowAllPts').checked;
const ptCol=document.getElementById('modSingleCol').value;
const invert=document.getElementById('modInvert').checked;
const constellation=document.getElementById('modConstellation').value;
const constColor=document.getElementById('modConstColor').value;
const filter=document.getElementById('modFilter').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
const cx=c.width/2,cy=c.height/2,maxRad=Math.min(cx,cy)-50;

// Get divisors of M for channel rings
const divisors=[];
for(let d=1;d<=M;d++)if(M%d===0)divisors.push(d);
divisors.sort((a,b)=>a-b);

// Compute prime factorization
const factors=[];
let temp=M;
for(let p=2;p*p<=temp;p++){let exp=0;while(temp%p===0){exp++;temp/=p;}if(exp>0)factors.push({p,exp});}
if(temp>1)factors.push({p:temp,exp:1});
const factorStr=factors.map(f=>f.exp>1?`${f.p}<sup>${f.exp}</sup>`:f.p).join('¬∑');

// Ring radii: outer ring is M, inner rings are divisors
const ringMap={};
const numRings=divisors.length;
divisors.forEach((d,i)=>{
const idx=invert?numRings-1-i:i;
ringMap[d]={radius:maxRad*(idx+1)/numRings,index:idx};
});

// Draw channel rings
ctx.lineWidth=1;
for(const d of divisors){
const rad=ringMap[d].radius;
ctx.strokeStyle=d===M?'rgba(0,217,255,0.8)':'rgba(255,215,0,0.5)';
ctx.lineWidth=d===M?2:1;
ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();
// Ring label
ctx.fillStyle=isDark()?'rgba(255,255,255,0.7)':'rgba(0,0,0,0.7)';
ctx.font='10px Segoe UI';ctx.textAlign='right';
ctx.fillText(`M'=${d}`,cx+rad-5,cy-5);
}

// Compute residue data
const residues=[];
const phi=eulerPhi(M);
for(let r=0;r<M;r++){
const g=gcd(r,M);
const Mprime=M/g;
const rprime=r/g;
const isCoprime=g===1;
if(filter==='coprime'&&!isCoprime)continue;
if(filter==='noncoprime'&&isCoprime)continue;
residues.push({r,g,Mprime,rprime,isCoprime});
}

// Draw Farey projection lines
if(showFarey){
ctx.lineWidth=fareyThick;
for(const res of residues){
if(res.isCoprime)continue; // Only reducible residues have projection lines
const outerRad=ringMap[M].radius;
const innerRad=ringMap[res.Mprime].radius;
const outerAng=2*Math.PI*res.r/M-Math.PI/2;
const innerAng=2*Math.PI*res.rprime/res.Mprime-Math.PI/2;

const x1=cx+outerRad*Math.cos(outerAng);
const y1=cy+outerRad*Math.sin(outerAng);
const x2=cx+innerRad*Math.cos(innerAng);
const y2=cy+innerRad*Math.sin(innerAng);

let lineCol;
if(fareyCol==='red')lineCol='rgba(255,0,0,0.6)';
else if(fareyCol==='gold')lineCol='rgba(255,215,0,0.6)';
else if(fareyCol==='gcd')lineCol=`hsla(${(res.g*60)%360},70%,50%,0.6)`;
else if(fareyCol==='depth'){const depth=Math.log2(res.g);lineCol=`hsla(${depth*60},70%,50%,0.6)`;}
else if(fareyCol==='gradient'){const t=res.r/M;lineCol=`hsla(${t*360},70%,50%,0.6)`;}
else lineCol='rgba(255,0,0,0.6)';

ctx.strokeStyle=lineCol;
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
}
}

// Draw points on rings
const ptSz=5;
const allPts=[];

for(const res of residues){
// Outer ring point
const outerRad=ringMap[M].radius;
const outerAng=2*Math.PI*res.r/M-Math.PI/2;
const ox=cx+outerRad*Math.cos(outerAng);
const oy=cy+outerRad*Math.sin(outerAng);

let clr;
if(ptCol==='coprime')clr=res.isCoprime?'#00ffff':'#ff4040';
else if(ptCol==='ring')clr=`hsl(${(ringMap[M].index*60)%360},70%,60%)`;
else if(ptCol==='gcd')clr=`hsl(${(res.g*50)%360},70%,60%)`;
else if(ptCol==='rainbow')clr=`hsl(${(res.r/M*360)},70%,60%)`;
else clr=res.isCoprime?'#00ffff':'#ff4040';

ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(ox,oy,res.isCoprime?ptSz:ptSz*0.7,0,2*Math.PI);ctx.fill();
allPts.push({r:res.r,m:M,g:res.g,Mprime:res.Mprime,rprime:res.rprime,isCoprime:res.isCoprime,px:ox,py:oy,ring:M});

// Inner ring points (if showing all)
if(showAllPts&&!res.isCoprime){
const innerRad=ringMap[res.Mprime].radius;
const innerAng=2*Math.PI*res.rprime/res.Mprime-Math.PI/2;
const ix=cx+innerRad*Math.cos(innerAng);
const iy=cy+innerRad*Math.sin(innerAng);

if(ptCol==='ring')clr=`hsl(${(ringMap[res.Mprime].index*60)%360},70%,60%)`;
ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(ix,iy,ptSz*0.6,0,2*Math.PI);ctx.fill();
allPts.push({r:res.rprime,m:res.Mprime,g:1,Mprime:res.Mprime,rprime:res.rprime,isCoprime:true,px:ix,py:iy,ring:res.Mprime});
}
}

// Draw constellation highlights (gap connections on outer ring)
if(constellation!=='none'){
const gap=constellation==='twin'?2:constellation==='cousin'?4:constellation==='sexy'?6:8;
const coprimes=residues.filter(r=>r.isCoprime).map(r=>r.r);
ctx.strokeStyle=constColor;ctx.lineWidth=2;
for(let i=0;i<coprimes.length;i++){
const r1=coprimes[i];
const r2=(r1+gap)%M;
if(coprimes.includes(r2)){
const ang1=2*Math.PI*r1/M-Math.PI/2;
const ang2=2*Math.PI*r2/M-Math.PI/2;
const rad=ringMap[M].radius;
const x1=cx+rad*Math.cos(ang1),y1=cy+rad*Math.sin(ang1);
const x2=cx+rad*Math.cos(ang2),y2=cy+rad*Math.sin(ang2);
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
}
}
}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Modular Reduction Projection: M = ${M}`,cx,20);
ctx.font='12px Segoe UI';ctx.fillStyle=isDark()?'#aaa':'#666';
ctx.fillText(factors.length>0?`= ${factors.map(f=>f.exp>1?f.p+'^'+f.exp:f.p).join(' √ó ')}`:(isPrime(M)?'(Prime)':''),cx,38);

// Legend
legend('almod','Single M Projection',[['Coprime (GCD=1)',phi,'#00ffff'],['Reducible (GCD>1)',M-phi,'#ff4040'],['Channels',divisors.length,'#ffd700']]);

// Stats
const channelCounts={};
for(const d of divisors)channelCounts[d]=0;
for(const res of residues)channelCounts[res.Mprime]++;

document.getElementById('modLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${M}</div><div style="font-size:.65rem;color:var(--txt2)">MODULUS M</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${phi}</div><div style="font-size:.65rem;color:var(--txt2)">œÜ(M)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${divisors.length}</div><div style="font-size:.65rem;color:var(--txt2)">CHANNELS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Factorization</strong>
<div style="margin-top:5px;font-size:.9rem;color:#ffd700">${factors.length>0?factors.map(f=>f.exp>1?f.p+'<sup>'+f.exp+'</sup>':f.p).join(' √ó '):'Prime'}</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Density Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Coprime Density:</span><span style="color:#00ff88">${fmt(phi/M*100)}%</span>
<span>Reducible:</span><span style="color:#ff6496">${M-phi} (${fmt((M-phi)/M*100)}%)</span>
<span>œâ(M) distinct primes:</span><span style="color:#ffd700">${factors.length}</span>
<span>Œ©(M) with mult:</span><span style="color:#9664ff">${factors.reduce((a,f)=>a+f.exp,0)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Channel Distribution</strong>
<div style="max-height:120px;overflow-y:auto;margin-top:5px">
${divisors.map(d=>`<div style="display:flex;justify-content:space-between;font-size:.75rem;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.1)"><span>M'=${d}</span><span style="color:#00d9ff">${channelCounts[d]} residues</span><span style="color:#ffd700">${fmt(channelCounts[d]/M*100)}%</span></div>`).join('')}
</div>
</div>
${constellation!=='none'?`<div style="background:rgba(255,0,255,.1);padding:8px;border-radius:6px;font-size:.8rem">
<strong style="color:${constColor}">Constellation: ${constellation}</strong><br>
<span style="color:var(--txt2)">Gap-${constellation==='twin'?2:constellation==='cousin'?4:constellation==='sexy'?6:8} connections shown</span>
</div>`:''}`;

// Plotly chart for channel distribution
Plotly.newPlot('pmodphi',[{x:divisors.map(d=>'M\'='+d),y:divisors.map(d=>channelCounts[d]),type:'bar',marker:{color:divisors.map(d=>d===M?'#00d9ff':'#ffd700')}}],{...plo(),xaxis:{title:'Channel'},yaxis:{title:'Residue Count'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
for(const p of allPts){
if(Math.hypot(mx-p.px,my-p.py)<ptSz+5){
modal(`Residue r=${p.r} mod ${p.m}`,[
['r (residue)',p.r],
['M (modulus)',p.m],
['gcd(r,M)',p.g],
['Channel M\'',p.Mprime],
['Reduced r\'',p.rprime],
['Type',p.isCoprime?'Coprime (irreducible)':'Reducible'],
['Angle Œ∏',fmt(p.r/p.m*360)+'¬∞'],
['r/M',fmt(p.r/p.m)],
['Ring',p.ring===M?'Outer (M)':'Inner (M\'='+p.ring+')']
]);
return;
}
}
};
}


function csvMod(){let s='modulus,residue,gcd,coprime,angle_deg\n';for(const ring of modRingData)for(const p of ring.pts)s+=`${p.m},${p.r},${p.g},${p.isGcd1},${p.ang*180/Math.PI}\n`;dl(s,'modular_rings.csv');}

// Dirichlet Characters
let dirData={M:12,chars:[],current:null};

function getDirichletChars(M){
// Generate all Dirichlet characters mod M
// For simplicity, we compute character values as roots of unity
const phi=eulerPhi(M);
const units=[];
for(let r=1;r<M;r++)if(gcd(r,M)===1)units.push(r);

// Find a generator if exists (primitive root)
let gen=null;
for(const g of units){if(mulOrd(g,M)===phi){gen=g;break;}}

const chars=[];
// Principal character
const chi0={idx:0,name:'œá‚ÇÄ',values:{},order:1};
for(let r=0;r<M;r++)chi0.values[r]=gcd(r,M)===1?{re:1,im:0}:{re:0,im:0};
chars.push(chi0);

// Other characters (if primitive root exists)
if(gen!==null){
for(let k=1;k<phi;k++){
const chi={idx:k,name:`œá_${k}`,values:{},order:phi/gcd(k,phi)};
for(let r=0;r<M;r++){
if(gcd(r,M)>1){chi.values[r]={re:0,im:0};}
else{
// Find discrete log of r base gen
let dlog=0,x=1;
for(let i=0;i<phi;i++){if(x===r){dlog=i;break;}x=(x*gen)%M;}
const ang=2*Math.PI*k*dlog/phi;
chi.values[r]={re:Math.cos(ang),im:Math.sin(ang)};}}
chars.push(chi);}}
else{
// No primitive root - just create principal
for(let k=1;k<Math.min(phi,10);k++){
const chi={idx:k,name:`œá_${k}`,values:{},order:1};
for(let r=0;r<M;r++)chi.values[r]=gcd(r,M)===1?{re:1,im:0}:{re:0,im:0};
chars.push(chi);}}
return chars;}

function drawDirichlet(){
const c=document.getElementById('cdir'),ctx=c.getContext('2d');
const M=+document.getElementById('dirMv').value||+document.getElementById('dirM').value;
const charIdx=+document.getElementById('dirIdx').value;
const viz=document.getElementById('dirViz').value;
const col=document.getElementById('dirCol').value;
const ptSz=+document.getElementById('dirPtSz').value;
const showLabels=document.getElementById('dirLabels').checked;
const showGrid=document.getElementById('dirGrid').checked;
const showRays=document.getElementById('dirRays').checked;
const showConnect=document.getElementById('dirConnect').checked;
const Lterms=+document.getElementById('dirLterms').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('dirMdisp').textContent=M;

// Generate characters
dirData.M=M;
dirData.chars=getDirichletChars(M);
const phi=eulerPhi(M);

// Update slider max
document.getElementById('dirIdx').max=Math.min(dirData.chars.length-1,phi-1);
const chi=dirData.chars[Math.min(charIdx,dirData.chars.length-1)]||dirData.chars[0];
dirData.current=chi;

// Update label
const idxLabel=document.getElementById('dirIdxLabel');
idxLabel.textContent=charIdx===0?'(Principal œá‚ÇÄ)':`(Order ${chi.order})`;

const cx=c.width/2,cy=c.height/2,R=Math.min(cx,cy)-80;
const pad=50,w=c.width-2*pad,h=c.height-2*pad;

// Collect data
const pts=[];
let supportCount=0,zeroCount=0;
for(let r=0;r<M;r++){
const v=chi.values[r];
const isSupport=Math.abs(v.re)>1e-10||Math.abs(v.im)>1e-10;
if(isSupport)supportCount++;else zeroCount++;
const arg=Math.atan2(v.im,v.re);
const mag=Math.sqrt(v.re*v.re+v.im*v.im);
pts.push({r,v,isSupport,arg,mag,gcdVal:gcd(r,M)});}

if(viz==='circle'||viz==='support'){
// Unit circle visualization
if(showGrid){
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,R,0,2*Math.PI);ctx.stroke();
// Axes
ctx.beginPath();ctx.moveTo(cx-R-20,cy);ctx.lineTo(cx+R+20,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,cy-R-20);ctx.lineTo(cx,cy+R+20);ctx.stroke();
// Labels
ctx.fillStyle=isDark()?'#888':'#666';ctx.font='12px Segoe UI';ctx.textAlign='center';
ctx.fillText('Re',cx+R+30,cy+4);ctx.fillText('Im',cx,cy-R-25);
ctx.fillText('1',cx+R+5,cy+15);ctx.fillText('-1',cx-R-10,cy+15);
ctx.fillText('i',cx+10,cy-R+5);ctx.fillText('-i',cx+10,cy+R+15);}

if(showRays){
ctx.strokeStyle='rgba(150,100,255,0.3)';ctx.lineWidth=1;
for(let k=0;k<phi;k++){
const ang=2*Math.PI*k/phi;
ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+R*1.1*Math.cos(ang),cy-R*1.1*Math.sin(ang));ctx.stroke();}}

// Draw character values on unit circle
const drawnPts=[];
for(const p of pts){
let x,y;
if(p.isSupport){
x=cx+R*p.v.re;y=cy-R*p.v.im;
}else{
// Zero values - place at origin or along real axis
x=cx;y=cy;}

let clr;
if(col==='support')clr=p.isSupport?'#ffd700':'#555';
else if(col==='arg')clr=p.isSupport?`hsl(${(p.arg+Math.PI)/(2*Math.PI)*360},80%,55%)`:'#555';
else if(col==='real')clr=p.isSupport?(p.v.re>=0?'#00ff88':'#ff6496'):'#555';
else clr=p.isSupport?`hsl(${chi.order*60},70%,55%)`:'#555';

if(p.isSupport){
ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();
ctx.strokeStyle=isDark()?'#fff':'#000';ctx.lineWidth=1;ctx.stroke();
drawnPts.push({x,y,p});

if(showLabels&&M<=24){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(p.r,x,y-ptSz-5);}}}

if(showConnect&&drawnPts.length>1){
ctx.strokeStyle='rgba(0,217,255,0.4)';ctx.lineWidth=1;ctx.beginPath();
const sorted=[...drawnPts].sort((a,b)=>a.p.r-b.p.r);
ctx.moveTo(sorted[0].x,sorted[0].y);
for(let i=1;i<sorted.length;i++)ctx.lineTo(sorted[i].x,sorted[i].y);
ctx.closePath();ctx.stroke();}

// Show zeros clustered
ctx.fillStyle='#555';ctx.font='11px Segoe UI';ctx.textAlign='center';
const zeros=pts.filter(p=>!p.isSupport);
if(zeros.length>0){
ctx.fillText(`œá(r)=0 for r‚àà{${zeros.slice(0,8).map(p=>p.r).join(',')}}${zeros.length>8?'...':''}`,cx,c.height-30);}}

else if(viz==='residues'){
// Residue class bar visualization
const barW=w/(M+1),barH=h*0.6;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Residue Classes mod ${M}`,cx,pad-10);

for(let r=0;r<M;r++){
const p=pts[r];
const x=pad+(r+0.5)*barW;
const barHeight=p.isSupport?barH:barH*0.2;
const clr=p.isSupport?'#ffd700':'#555';
ctx.fillStyle=clr;
ctx.fillRect(x-barW*0.4,cy+barH/2-barHeight,barW*0.8,barHeight);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';
ctx.fillText(r,x,cy+barH/2+20);
if(p.isSupport&&showLabels){
ctx.fillStyle='#00d9ff';ctx.font='9px Arial';
const vStr=p.v.im===0?p.v.re.toFixed(2):`e^{${(p.arg/Math.PI).toFixed(2)}œÄi}`;
ctx.fillText(p.v.re.toFixed(1),x,cy+barH/2-barHeight-8);}}}

else if(viz==='table'){
// Full character table
const chars=dirData.chars.slice(0,Math.min(10,phi));
const cellW=w/(M+2),cellH=25;
ctx.font='11px Segoe UI';
// Header
ctx.fillStyle='#00d9ff';ctx.textAlign='center';
ctx.fillText('r',pad+cellW/2,pad+cellH/2);
for(let r=0;r<M;r++)ctx.fillText(r,pad+(r+1.5)*cellW,pad+cellH/2);
// Rows for each character
for(let ci=0;ci<chars.length;ci++){
const chi=chars[ci];
const y=pad+(ci+1.5)*cellH;
ctx.fillStyle='#ffd700';ctx.fillText(chi.name,pad+cellW/2,y);
for(let r=0;r<M;r++){
const v=chi.values[r];
const isZ=Math.abs(v.re)<1e-10&&Math.abs(v.im)<1e-10;
ctx.fillStyle=isZ?'#555':Math.abs(v.im)<1e-10?(v.re>0?'#00ff88':'#ff6496'):'#00d9ff';
let txt=isZ?'0':Math.abs(v.im)<1e-10?v.re.toFixed(0):Math.abs(v.re)<1e-10?(v.im>0?'i':'-i'):'œâ';
ctx.fillText(txt,pad+(r+1.5)*cellW,y);}}}

else if(viz==='lfunction'){
// L-function canvas display
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 16px Segoe UI';ctx.textAlign='center';
ctx.fillText(`L(s,œá) = Œ£ œá(n)/nÀ¢  (${Lterms} terms)`,cx,cy-80);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='14px Segoe UI';
// Compute for display
const sDisp=[1,2,3];
for(let si=0;si<sDisp.length;si++){
const s=sDisp[si];
let Lre=0,Lim=0;
for(let n=1;n<=Lterms;n++){const v=chi.values[n%M];Lre+=v.re*Math.pow(n,-s);Lim+=v.im*Math.pow(n,-s);}
ctx.fillText(`L(${s},œá) ‚âà ${Lre.toFixed(4)} + ${Lim.toFixed(4)}i   |L| = ${Math.sqrt(Lre*Lre+Lim*Lim).toFixed(4)}`,cx,cy-30+si*30);}}

// L-function chart (always compute)
const sVals=[1,1.2,1.5,2,2.5,3,4,5];
const Ldata=[];
for(const s of sVals){
let Lre=0,Lim=0;
for(let n=1;n<=Lterms;n++){
const v=chi.values[n%M];
const coef=Math.pow(n,-s);
Lre+=v.re*coef;Lim+=v.im*coef;}
Ldata.push({s,Lre,Lim,Lmag:Math.sqrt(Lre*Lre+Lim*Lim)});}
Plotly.newPlot('pdirL',[
{x:sVals,y:Ldata.map(d=>d.Lre),name:'Re L(s,œá)',mode:'lines+markers',line:{color:'#00d9ff'}},
{x:sVals,y:Ldata.map(d=>d.Lim),name:'Im L(s,œá)',mode:'lines+markers',line:{color:'#ff8c00'}},
{x:sVals,y:Ldata.map(d=>d.Lmag),name:'|L(s,œá)|',mode:'lines+markers',line:{color:'#00ff88'}}
],{...plo(),xaxis:{title:'s'},yaxis:{title:'L(s,œá)'}});

// Distribution chart
const argBins=[];
for(let k=0;k<8;k++){
const lo=-Math.PI+k*Math.PI/4,hi=lo+Math.PI/4;
const cnt=pts.filter(p=>p.isSupport&&p.arg>=lo&&p.arg<hi).length;
argBins.push({bin:`${(lo/Math.PI*180).toFixed(0)}¬∞`,count:cnt});}
Plotly.newPlot('pdirDist',[{x:argBins.map(b=>b.bin),y:argBins.map(b=>b.count),type:'bar',marker:{color:'#9664ff'}}],{...plo(),xaxis:{title:'Argument'},yaxis:{title:'Count'}});

// Orthogonality check
const orthoData=[];
for(let i=0;i<Math.min(5,dirData.chars.length);i++){
for(let j=i;j<Math.min(5,dirData.chars.length);j++){
let sumRe=0,sumIm=0;
for(let r=0;r<M;r++){
const vi=dirData.chars[i].values[r],vj=dirData.chars[j].values[r];
sumRe+=vi.re*vj.re+vi.im*vj.im;sumIm+=vi.im*vj.re-vi.re*vj.im;}
orthoData.push({i,j,sum:Math.sqrt(sumRe*sumRe+sumIm*sumIm)});}}
Plotly.newPlot('pdirOrtho',[{x:orthoData.map(d=>`œá${d.i}¬∑œáÃÑ${d.j}`),y:orthoData.map(d=>d.sum),type:'bar',marker:{color:orthoData.map(d=>d.i===d.j?'#ffd700':'#555')}}],{...plo(),xaxis:{title:'Character Pair'},yaxis:{title:'|Œ£œá·µ¢œáÃÑ‚±º|'}});

// Legend
legend('aldir','Character Info',[['Support œá‚â†0',supportCount,'#ffd700'],['Zero œá=0',zeroCount,'#555'],['Order',chi.order,'#00d9ff']]);

// Live stats
document.getElementById('dirLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${M}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS M</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${phi}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ(M)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${dirData.chars.length}</div><div style="font-size:.7rem;color:var(--txt2)">CHARACTERS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Current Character œá_${charIdx}</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Order:</span><span style="color:#9664ff">${chi.order}</span>
<span>Support size:</span><span style="color:#ffd700">${supportCount}</span>
<span>Zero count:</span><span style="color:#555">${zeroCount}</span>
<span>Is principal:</span><span style="color:${charIdx===0?'#00ff88':'#ff6496'}">${charIdx===0?'Yes':'No'}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Support (œá(r) ‚â† 0)</strong>
<div style="margin-top:5px;font-size:.8rem;color:var(--txt2)">
r ‚àà {${pts.filter(p=>p.isSupport).slice(0,12).map(p=>p.r).join(', ')}}${supportCount>12?'...':''}
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Vanishing (œá(r) = 0)</strong>
<div style="margin-top:5px;font-size:.8rem;color:#555">
r ‚àà {${pts.filter(p=>!p.isSupport).map(p=>p.r).join(', ')||'‚àÖ'}}
</div>
</div>
<div>
<strong style="color:var(--acc)">Key Properties</strong>
<div style="margin-top:5px;font-size:.75rem;line-height:1.5;color:var(--txt2)">
‚Ä¢ Completely multiplicative: œá(ab)=œá(a)œá(b)<br>
‚Ä¢ œá(1) = 1 always<br>
‚Ä¢ |œá(r)| = 1 when œá(r) ‚â† 0<br>
‚Ä¢ œá(r+M) = œá(r) (periodic)
</div>
</div>`;

// Table
document.getElementById('tdirT').innerHTML='<tr><th>r</th><th>gcd(r,M)</th><th>œá(r)</th><th>|œá(r)|</th><th>arg(œá(r))</th><th>Support?</th></tr>'+
pts.map(p=>`<tr onclick="modal('œá(${p.r})',[['r',${p.r}],['gcd(${p.r},${M})',${p.gcdVal}],['Re œá(r)',${p.v.re.toFixed(6)}],['Im œá(r)',${p.v.im.toFixed(6)}],['|œá(r)|',${p.mag.toFixed(6)}],['arg œá(r)',${(p.arg/Math.PI).toFixed(4)}+'œÄ']])" style="cursor:pointer;color:${p.isSupport?'#ffd700':'#555'}"><td>${p.r}</td><td>${p.gcdVal}</td><td>${p.isSupport?(Math.abs(p.v.im)<1e-6?p.v.re.toFixed(2):`${p.v.re.toFixed(2)}+${p.v.im.toFixed(2)}i`):'0'}</td><td>${p.mag.toFixed(3)}</td><td>${p.isSupport?(p.arg/Math.PI).toFixed(3)+'œÄ':'‚Äî'}</td><td>${p.isSupport?'‚úì':''}</td></tr>`).join('');

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='circle'||viz==='support'){
for(const p of pts){if(!p.isSupport)continue;
const x=cx+R*p.v.re,y=cy-R*p.v.im;
if(Math.hypot(mx-x,my-y)<ptSz+5){
modal(`œá(${p.r})`,[['r',p.r],['gcd(r,M)',p.gcdVal],['œá(r)',`${p.v.re.toFixed(4)}+${p.v.im.toFixed(4)}i`],['|œá(r)|',p.mag.toFixed(6)],['arg(œá(r))',(p.arg/Math.PI).toFixed(4)+'œÄ']]);break;}}}};}

function showAllChars(){
const M=+document.getElementById('dirMv').value;
const chars=getDirichletChars(M);
const rows=chars.slice(0,15).map(chi=>[chi.name,chi.order]);
modal(`All ${chars.length} Characters mod ${M}`,rows);}

function csvDir(){
const M=dirData.M,chi=dirData.current;
let s='r,gcd,re_chi,im_chi,mag,arg,support\n';
for(let r=0;r<M;r++){
const v=chi.values[r];
const mag=Math.sqrt(v.re*v.re+v.im*v.im);
const arg=Math.atan2(v.im,v.re);
s+=`${r},${gcd(r,M)},${v.re},${v.im},${mag},${arg},${mag>0.5?1:0}\n`;}
dl(s,'dirichlet_char.csv');}

async function screenshotDir(){
const M=document.getElementById('dirMv').value,idx=document.getElementById('dirIdx').value;
await screenshotUnified('cdir','dirLiveStats',`Dirichlet Character œá_${idx} mod ${M}`,'dirichlet_char.png',{dashH:350});
}

// Twin Primes & Prime Gaps
let twinData={primes:[],gaps:[],twins:[]};

function sievePrimes(N){
const sieve=new Array(N+1).fill(true);
sieve[0]=sieve[1]=false;
for(let i=2;i*i<=N;i++)if(sieve[i])for(let j=i*i;j<=N;j+=i)sieve[j]=false;
const primes=[];for(let i=2;i<=N;i++)if(sieve[i])primes.push(i);
return primes;}

function drawTwin(){
const c=document.getElementById('ctwin'),ctx=c.getContext('2d');
const N=+document.getElementById('twinNv').value||+document.getElementById('twinN').value;
const g=+document.getElementById('twinGv').value||+document.getElementById('twinG').value;
const viz=document.getElementById('twinViz').value;
const col=document.getElementById('twinCol').value;
const ptSz=+document.getElementById('twinPtSz').value;
const showLabels=document.getElementById('twinLabels').checked;
const showGrid=document.getElementById('twinGrid').checked;
const showAvg=document.getElementById('twinAvg').checked;
const showTheory=document.getElementById('twinTheory').checked;
const constType=document.getElementById('twinConst').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('twinNdisp').textContent=N;

// Generate primes
const primes=sievePrimes(N);
twinData.primes=primes;

// Compute gaps
const gaps=[];
for(let i=1;i<primes.length;i++)gaps.push({p:primes[i-1],gap:primes[i]-primes[i-1],idx:i});
twinData.gaps=gaps;

// Find twin primes (or other constellations)
const twins=[];
let gapPattern=[2];
if(constType==='cousin')gapPattern=[4];
else if(constType==='sexy')gapPattern=[6];
else if(constType==='triplet')gapPattern=[2,4];
else if(constType==='quadruplet')gapPattern=[2,4,2];

for(let i=0;i<primes.length-gapPattern.length;i++){
let match=true;
for(let j=0;j<gapPattern.length;j++){
if(primes[i+j+1]-primes[i+j]!==gapPattern[j]){match=false;break;}}
if(match)twins.push({p:primes[i],constellation:primes.slice(i,i+gapPattern.length+1)});}
twinData.twins=twins;

// Brun's constant partial sum
let brunSum=0;
const brunPartial=[];
for(const t of twins.filter(t=>t.constellation.length===2)){
brunSum+=1/t.p+1/t.constellation[1];
brunPartial.push({p:t.p,sum:brunSum});}

const pad=60,w=c.width-2*pad,h=c.height-2*pad;
const cx=c.width/2,cy=c.height/2;

// Gap frequency
const gapFreq={};
for(const g of gaps)gapFreq[g.gap]=(gapFreq[g.gap]||0)+1;
const gapArr=Object.entries(gapFreq).map(([g,c])=>({gap:+g,count:c})).sort((a,b)=>a.gap-b.gap);

if(viz==='gaps'){
// Histogram of prime gaps
const maxGap=Math.max(...gaps.map(g=>g.gap));
const barW=w/Math.min(maxGap/2+1,30);
const maxCount=Math.max(...gapArr.map(g=>g.count));
if(showGrid){
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();}}
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Prime Gap Distribution',cx,30);
for(const gd of gapArr.slice(0,30)){
const x=pad+(gd.gap/2-1)*barW;
const barH=h*gd.count/maxCount;
let clr=gd.gap===2?'#ffd700':gd.gap===4?'#00d9ff':gd.gap===6?'#ff8c00':`hsl(${gd.gap*10},70%,50%)`;
ctx.fillStyle=clr;
ctx.fillRect(x,pad+h-barH,barW*0.8,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';
ctx.fillText(gd.gap,x+barW*0.4,pad+h+15);
if(showLabels)ctx.fillText(gd.count,x+barW*0.4,pad+h-barH-5);}}

else if(viz==='pairs'){
// Show twin prime pairs as points
const maxP=primes[primes.length-1];
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`${constType.charAt(0).toUpperCase()+constType.slice(1)} Prime Pairs (gap=${gapPattern.join(',')})`,cx,30);
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;ctx.strokeRect(pad,pad,w,h);}
for(let i=0;i<twins.length;i++){
const t=twins[i];
const x=pad+w*t.p/maxP;
const y=pad+h-h*i/Math.max(twins.length-1,1);
ctx.fillStyle='#ffd700';
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();
if(showLabels&&twins.length<30){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';
ctx.fillText(`(${t.constellation.join(',')})`,x+ptSz+3,y+3);}}}

else if(viz==='density'){
// Gap density by range
const ranges=[];
const rangeSize=Math.ceil(N/10);
for(let r=0;r<10;r++){
const lo=r*rangeSize,hi=(r+1)*rangeSize;
const rangeGaps=gaps.filter(g=>g.p>=lo&&g.p<hi);
const twinCount=rangeGaps.filter(g=>g.gap===g).length;
const avgGap=rangeGaps.length?rangeGaps.reduce((a,g)=>a+g.gap,0)/rangeGaps.length:0;
ranges.push({lo,hi,count:rangeGaps.length,avgGap,twinCount});}
const maxAvg=Math.max(...ranges.map(r=>r.avgGap));
const barW=w/10;
for(let i=0;i<ranges.length;i++){
const r=ranges[i];
const x=pad+i*barW;
const barH=h*r.avgGap/maxAvg;
ctx.fillStyle=`hsl(${i*36},70%,50%)`;
ctx.fillRect(x,pad+h-barH,barW*0.8,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(`${(r.lo/1000).toFixed(0)}k`,x+barW*0.4,pad+h+15);}}

else if(viz==='brun'){
// Brun's constant convergence
if(brunPartial.length>0){
const maxSum=brunPartial[brunPartial.length-1].sum;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText("Brun's Constant B‚ÇÇ ‚âà 1.902 (Convergence)",cx,30);
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='right';
ctx.fillText((maxSum*i/5).toFixed(3),pad-5,y+3);}}
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
for(let i=0;i<brunPartial.length;i++){
const x=pad+w*i/(brunPartial.length-1);
const y=pad+h-h*brunPartial[i].sum/maxSum;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
// Reference line at B2 ‚âà 1.902
if(showTheory&&maxSum>1.5){
ctx.strokeStyle='#ff006e';ctx.setLineDash([5,5]);ctx.beginPath();
const y1902=pad+h-h*1.902/maxSum;
ctx.moveTo(pad,y1902);ctx.lineTo(pad+w,y1902);ctx.stroke();ctx.setLineDash([]);
ctx.fillStyle='#ff006e';ctx.font='11px Arial';ctx.textAlign='left';
ctx.fillText('B‚ÇÇ ‚âà 1.902',pad+w-60,y1902-5);}}}

else if(viz==='constellation'){
// Prime constellations visualization  
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Prime ${constType.charAt(0).toUpperCase()+constType.slice(1)}s: ${twins.length} found`,cx,30);
const cols=Math.ceil(Math.sqrt(twins.length));
const rows=Math.ceil(twins.length/cols);
const cellW=w/cols,cellH=h/rows;
for(let i=0;i<Math.min(twins.length,100);i++){
const t=twins[i];
const col=i%cols,row=Math.floor(i/cols);
const x=pad+col*cellW+cellW/2;
const y=pad+row*cellH+cellH/2;
ctx.fillStyle=`hsl(${i*7},70%,55%)`;
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='8px Arial';ctx.textAlign='center';
ctx.fillText(t.constellation.join(','),x,y+ptSz+10);}}

// Charts
Plotly.newPlot('ptwinGap',[{x:gapArr.slice(0,20).map(g=>g.gap),y:gapArr.slice(0,20).map(g=>g.count),type:'bar',marker:{color:gapArr.slice(0,20).map(g=>g.gap===2?'#ffd700':'#00d9ff')}}],{...plo(),xaxis:{title:'Gap'},yaxis:{title:'Count'}});

Plotly.newPlot('ptwinBrun',[{x:brunPartial.map(b=>b.p),y:brunPartial.map(b=>b.sum),mode:'lines',line:{color:'#00d9ff',width:2},name:'Œ£(1/p+1/(p+2))'}],{...plo(),xaxis:{title:'p'},yaxis:{title:"Brun's partial sum"}});

Plotly.newPlot('ptwinLog',[{x:gaps.map(g=>Math.log(g.p)),y:gaps.map(g=>g.gap),mode:'markers',marker:{size:3,color:'#9664ff'},name:'Gap'},{x:gaps.map(g=>Math.log(g.p)),y:gaps.map((_,i)=>{const localGaps=gaps.slice(Math.max(0,i-20),i+20);return localGaps.reduce((a,g)=>a+g.gap,0)/localGaps.length;}),mode:'lines',line:{color:'#ffd700',width:2},name:'Running Avg'}],{...plo(),xaxis:{title:'ln(p)'},yaxis:{title:'Gap'}});

// Stats
const avgGap=gaps.reduce((a,g)=>a+g.gap,0)/gaps.length;
const maxGapVal=Math.max(...gaps.map(g=>g.gap));
const gapG=gaps.filter(g=>g.gap===g).length;
legend('altwin','Gap Statistics',[['Twin pairs',twins.filter(t=>t.constellation.length===2).length,'#ffd700'],['Avg gap',avgGap.toFixed(2),'#00d9ff'],['Max gap',maxGapVal,'#ff006e']]);

// Live stats
document.getElementById('twinLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Twin Primes | FIELD: ‚Ñ§ (Primes) | TYPE: ${constType} Constellation</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>N: <strong style="color:#00d9ff">${N}</strong></span>
<span>Type: <strong style="color:#ffd700">${constType}</strong></span>
<span>Primes: <strong style="color:#00ff88">${primes.length}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${primes.length}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES ‚â§ N</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${twins.length}</div><div style="font-size:.7rem;color:var(--txt2)">${constType.toUpperCase()}S</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${avgGap.toFixed(2)}</div><div style="font-size:.7rem;color:var(--txt2)">AVG GAP</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${fmt(2*1.32*N/(Math.log(N)*Math.log(N)))}</div><div style="font-size:.65rem;color:var(--txt2)">HARDY-LITTLEWOOD PRED</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff8c00">${fmt(100*twins.length/primes.length)}%</div><div style="font-size:.65rem;color:var(--txt2)">TWIN RATIO</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Gap Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Most common gap:</span><span style="color:#ffd700">${gapArr[0]?.gap||0} (${gapArr[0]?.count||0}√ó)</span>
<span>Max gap:</span><span style="color:#ff006e">${maxGapVal}</span>
<span>Gap=2 count:</span><span style="color:#00d9ff">${gapFreq[2]||0}</span>
<span>Gap=6 count:</span><span style="color:#ff8c00">${gapFreq[6]||0}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Brun's Constant</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Partial sum:</span><span style="color:#00d9ff">${brunPartial.length?brunPartial[brunPartial.length-1].sum.toFixed(6):'‚Äî'}</span>
<span>B‚ÇÇ ‚âà:</span><span style="color:#9664ff">1.902160...</span>
<span>Twin pairs:</span><span style="color:#ffd700">${twins.filter(t=>t.constellation.length===2).length}</span>
<span>Convergence:</span><span style="color:#00ff88">Proved (Brun 1919)</span>
</div>
</div>
<div>
<strong style="color:var(--acc)">First ${constType}s</strong>
<div style="margin-top:5px;font-size:.75rem;color:var(--txt2)">
${twins.slice(0,8).map(t=>`(${t.constellation.join(',')})`).join(', ')}${twins.length>8?'...':''}
</div>
</div>`;

// Table
document.getElementById('ttwinT').innerHTML='<tr><th>p</th><th>p+g</th><th>Gap</th><th>log(p)</th><th>gap/log(p)</th><th>Œ£1/p</th></tr>'+
twins.slice(0,100).map((t,i)=>{
const bp=brunPartial.find(b=>b.p===t.p);
return`<tr onclick="modal('${constType} at ${t.p}',[['p',${t.p}],['Constellation','${t.constellation.join(', ')}']])" style="cursor:pointer"><td>${t.p}</td><td>${t.constellation[1]||''}</td><td>${t.constellation[1]-t.p||''}</td><td>${Math.log(t.p).toFixed(3)}</td><td>${((t.constellation[1]-t.p)/Math.log(t.p)).toFixed(3)}</td><td>${bp?bp.sum.toFixed(4):'‚Äî'}</td></tr>`;}).join('');}

function csvTwin(){
let s='p,gap,constellation,brun_partial\n';
let bsum=0;
for(const t of twinData.twins){
if(t.constellation.length===2)bsum+=1/t.p+1/t.constellation[1];
s+=`${t.p},${t.constellation[1]-t.p},"${t.constellation.join(',')}",${bsum}\n`;}
dl(s,'twin_primes.csv');}

async function screenshotTwin(){
const c=document.getElementById('ctwin'),dashData=extractDashboardData('twinLiveStats');
const N=document.getElementById('twinNv').value;
const scale=2,pad=30,dashH=320;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Twin Prime Analysis ‚Äî N=${N}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='twin_primes.png';a.click();},'image/png',1.0);}

// Prime Counting œÄ(x)
let piData={xs:[],pis:[],lis:[],xlnxs:[]};

function Li(x){
// Logarithmic integral approximation
if(x<=2)return 0;
let sum=0;const dx=0.1;
for(let t=2;t<=x;t+=dx)sum+=dx/Math.log(t);
return sum;}

function RiemannR(x){
// Riemann R function (simplified)
let sum=0;
for(let n=1;n<=100;n++){
const m=mob(n);
if(m!==0)sum+=m/n*Li(Math.pow(x,1/n));}
return sum;}

function drawPi(){
const c=document.getElementById('cpi'),ctx=c.getContext('2d');
const X=+document.getElementById('piXv').value||+document.getElementById('piX').value;
const step=+document.getElementById('piStep').value;
const viz=document.getElementById('piViz').value;
const showLi=document.getElementById('piLi').checked;
const showXlnx=document.getElementById('piXlnx').checked;
const showRiem=document.getElementById('piRiemann').checked;
const showGrid=document.getElementById('piGrid').checked;
const showLog=document.getElementById('piLog').checked;
const showBounds=document.getElementById('piBounds').checked;
const ptSz=+document.getElementById('piPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('piXdisp').textContent=X;

// Compute œÄ(x) for range
const primes=sievePrimes(X);
const xs=[],pis=[],lis=[],xlnxs=[],riems=[];
let piCount=0,primeIdx=0;
for(let x=step;x<=X;x+=step){
while(primeIdx<primes.length&&primes[primeIdx]<=x){piCount++;primeIdx++;}
xs.push(x);
pis.push(piCount);
lis.push(Li(x));
xlnxs.push(x/Math.log(x));
if(showRiem&&x<=10000)riems.push(RiemannR(x));else riems.push(null);}
piData={xs,pis,lis,xlnxs,riems};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;
const maxPi=Math.max(...pis);

if(viz==='count'||viz==='compare'){
// Plot œÄ(x) and approximations
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Prime Counting Function œÄ(x)',c.width/2,30);
if(showGrid){
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){
const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='right';
ctx.fillText(Math.round(maxPi*i/5),pad-5,y+3);}}
// x/ln(x) line
if(showXlnx){
ctx.beginPath();ctx.strokeStyle='#ff8c00';ctx.lineWidth=1.5;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h-h*xlnxs[i]/maxPi;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}
// Li(x) line
if(showLi){
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=1.5;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h-h*lis[i]/maxPi;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}
// œÄ(x) actual
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h-h*pis[i]/maxPi;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
// Legend
ctx.font='11px Segoe UI';ctx.textAlign='left';
let ly=pad+20;
ctx.fillStyle='#00d9ff';ctx.fillRect(pad+10,ly-8,15,3);ctx.fillText('œÄ(x)',pad+30,ly);ly+=18;
if(showXlnx){ctx.fillStyle='#ff8c00';ctx.fillRect(pad+10,ly-8,15,3);ctx.fillText('x/ln(x)',pad+30,ly);ly+=18;}
if(showLi){ctx.fillStyle='#00ff88';ctx.fillRect(pad+10,ly-8,15,3);ctx.fillText('Li(x)',pad+30,ly);}}

else if(viz==='error'){
// Error plot
const liErrs=pis.map((p,i)=>p-lis[i]);
const xlnxErrs=pis.map((p,i)=>p-xlnxs[i]);
const maxErr=Math.max(...liErrs.map(Math.abs),...xlnxErrs.map(Math.abs));
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Approximation Errors: œÄ(x) - Approx',c.width/2,30);
// Zero line
ctx.strokeStyle=gridC();ctx.lineWidth=1;ctx.beginPath();
ctx.moveTo(pad,pad+h/2);ctx.lineTo(pad+w,pad+h/2);ctx.stroke();
// Li error
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=2;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h/2-h/2*liErrs[i]/maxErr;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
// x/ln(x) error
ctx.beginPath();ctx.strokeStyle='#ff8c00';ctx.lineWidth=2;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h/2-h/2*xlnxErrs[i]/maxErr;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

else if(viz==='ratio'){
// œÄ(x)¬∑ln(x)/x ratio ‚Üí 1
const ratios=pis.map((p,i)=>p*Math.log(xs[i])/xs[i]);
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('PNT Ratio: œÄ(x)¬∑ln(x)/x ‚Üí 1',c.width/2,30);
const maxR=Math.max(...ratios),minR=Math.min(...ratios);
// Reference line at 1
ctx.strokeStyle='#ff006e';ctx.setLineDash([5,5]);ctx.lineWidth=1;ctx.beginPath();
const y1=pad+h-(1-minR)/(maxR-minR)*h;
ctx.moveTo(pad,y1);ctx.lineTo(pad+w,y1);ctx.stroke();ctx.setLineDash([]);
// Ratio curve
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h-(ratios[i]-minR)/(maxR-minR)*h;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

else if(viz==='density'){
// Prime density 1/ln(x)
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Prime Density ‚âà 1/ln(x)',c.width/2,30);
const empirical=[];
for(let i=1;i<pis.length;i++)empirical.push((pis[i]-pis[i-1])/step);
const theory=xs.map(x=>1/Math.log(x));
const maxD=Math.max(...empirical,...theory);
// Theory
ctx.beginPath();ctx.strokeStyle='#ff8c00';ctx.lineWidth=2;
for(let i=0;i<xs.length;i++){
const x=pad+w*xs[i]/X;const y=pad+h-h*theory[i]/maxD;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
// Empirical (smoothed)
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
for(let i=0;i<empirical.length;i++){
const x=pad+w*xs[i+1]/X;
const avgD=empirical.slice(Math.max(0,i-5),i+5).reduce((a,b)=>a+b,0)/Math.min(10,i+5);
const y=pad+h-h*avgD/maxD;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

// Charts
const liErrs=pis.map((p,i)=>Math.abs(p-lis[i]));
const xlnxErrs=pis.map((p,i)=>Math.abs(p-xlnxs[i]));
Plotly.newPlot('ppiErr',[
{x:xs,y:liErrs,name:'|œÄ(x)-Li(x)|',mode:'lines',line:{color:'#00ff88'}},
{x:xs,y:xlnxErrs,name:'|œÄ(x)-x/ln(x)|',mode:'lines',line:{color:'#ff8c00'}}
],{...plo(),xaxis:{title:'x'},yaxis:{title:'Absolute Error'}});

Plotly.newPlot('ppiComp',[
{x:xs,y:pis,name:'œÄ(x)',mode:'lines',line:{color:'#00d9ff',width:2}},
{x:xs,y:lis,name:'Li(x)',mode:'lines',line:{color:'#00ff88'}},
{x:xs,y:xlnxs,name:'x/ln(x)',mode:'lines',line:{color:'#ff8c00'}}
],{...plo(),xaxis:{title:'x'},yaxis:{title:'Count'}});

const ratios=pis.map((p,i)=>xs[i]>10?p*Math.log(xs[i])/xs[i]:null).filter(x=>x!==null);
Plotly.newPlot('ppiRatio',[
{x:xs.filter((_,i)=>xs[i]>10),y:ratios,mode:'lines',line:{color:'#9664ff',width:2},name:'œÄ(x)ln(x)/x'},
{x:[xs[0],xs[xs.length-1]],y:[1,1],mode:'lines',line:{color:'#ff006e',dash:'dash'},name:'Limit=1'}
],{...plo(),xaxis:{title:'x'},yaxis:{title:'Ratio',range:[0.8,1.3]}});

// Stats
const finalPi=pis[pis.length-1];
const finalLi=lis[lis.length-1];
const finalXlnx=xlnxs[xlnxs.length-1];
legend('alpi','œÄ(x) Statistics',[['œÄ('+X+')',finalPi,'#00d9ff'],['Li error',Math.abs(finalPi-finalLi).toFixed(1),'#00ff88'],['x/ln error',Math.abs(finalPi-finalXlnx).toFixed(1),'#ff8c00']]);

// Live stats
document.getElementById('piLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Prime Counting œÄ(x) | FIELD: ‚Ñ§ (Primes) | TYPE: Counting Function</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max x: <strong style="color:#00d9ff">${X}</strong></span>
<span>œÄ(x): <strong style="color:#ffd700">${finalPi}</strong></span>
<span>Density: <strong style="color:#00ff88">${fmt(100*finalPi/X)}%</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${finalPi}</div><div style="font-size:.7rem;color:var(--txt2)">œÄ(${X}) ACTUAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00ff88">${finalLi.toFixed(1)}</div><div style="font-size:.7rem;color:var(--txt2)">Li(${X}) PRED</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ff8c00">${finalXlnx.toFixed(1)}</div><div style="font-size:.7rem;color:var(--txt2)">x/ln(x)</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${(finalPi-finalLi).toFixed(2)}</div><div style="font-size:.65rem;color:var(--txt2)">Li ERROR</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff6496">${(100*(finalPi-finalLi)/finalPi).toFixed(3)}%</div><div style="font-size:.65rem;color:var(--txt2)">REL ERROR</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Analysis at x=${X}</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Li(x) error:</span><span style="color:#00ff88">${(finalPi-finalLi).toFixed(2)} (${(100*(finalPi-finalLi)/finalPi).toFixed(3)}%)</span>
<span>x/ln(x) error:</span><span style="color:#ff8c00">${(finalPi-finalXlnx).toFixed(2)} (${(100*(finalPi-finalXlnx)/finalPi).toFixed(2)}%)</span>
<span>Li is better by:</span><span style="color:#9664ff">${(Math.abs(finalPi-finalXlnx)-Math.abs(finalPi-finalLi)).toFixed(1)}</span>
<span>Ratio œÄ¬∑ln/x:</span><span style="color:#00d9ff">${(finalPi*Math.log(X)/X).toFixed(4)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Prime Number Theorem</strong>
<div style="margin-top:5px;font-size:.8rem;color:var(--txt2)">
œÄ(x) ~ x/ln(x) as x ‚Üí ‚àû<br>
Better: œÄ(x) ~ Li(x) = ‚à´‚ÇÇÀ£ dt/ln(t)
</div>
</div>
<div>
<strong style="color:var(--acc)">Key Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>œÄ(100):</span><span style="color:var(--txt)">25</span>
<span>œÄ(1000):</span><span style="color:var(--txt)">168</span>
<span>œÄ(10000):</span><span style="color:var(--txt)">1229</span>
<span>œÄ(100000):</span><span style="color:var(--txt)">9592</span>
</div>
</div>`;

// Table
document.getElementById('tpiT').innerHTML='<tr><th>x</th><th>œÄ(x)</th><th>x/ln(x)</th><th>Li(x)</th><th>Error Li</th><th>Rel %</th></tr>'+
xs.slice(0,100).map((x,i)=>`<tr onclick="modal('œÄ(${x})',[['x',${x}],['œÄ(x)',${pis[i]}],['Li(x)',${lis[i].toFixed(2)}],['x/ln(x)',${xlnxs[i].toFixed(2)}]])" style="cursor:pointer"><td>${x}</td><td>${pis[i]}</td><td>${xlnxs[i].toFixed(1)}</td><td>${lis[i].toFixed(1)}</td><td>${(pis[i]-lis[i]).toFixed(1)}</td><td>${(100*(pis[i]-lis[i])/pis[i]).toFixed(2)}%</td></tr>`).join('');}

function csvPi(){
let s='x,pi_x,li_x,x_ln_x,error_li,error_xlnx\n';
for(let i=0;i<piData.xs.length;i++)s+=`${piData.xs[i]},${piData.pis[i]},${piData.lis[i]},${piData.xlnxs[i]},${piData.pis[i]-piData.lis[i]},${piData.pis[i]-piData.xlnxs[i]}\n`;
dl(s,'prime_counting.csv');}

async function screenshotPi(){
const X=document.getElementById('piXv').value;
await screenshotUnified('cpi','piLiveStats',`Prime Counting Function ‚Äî x=${X}`,'prime_counting.png',{dashH:320});
}

// Composite Channel Projection
let compData={M:60,residues:[],channels:[]};
let compSweepInterval=null,compSweepR=1;

function factorizeArr(n){
const factors=[];
let d=2;
while(d*d<=n){
while(n%d===0){factors.push(d);n/=d;}
d++;}
if(n>1)factors.push(n);
return factors;}

function getDivisors(n){
const divs=[1];
for(let i=2;i<=n;i++)if(n%i===0)divs.push(i);
return divs;}

function smallestPrimeFactor(n){
if(n<=1)return 1;
if(n%2===0)return 2;
for(let i=3;i*i<=n;i+=2)if(n%i===0)return i;
return n;}

function largestPrimeFactor(n){
const f=factorizeArr(n);
return f.length?f[f.length-1]:1;}

function drawComp(){
const c=document.getElementById('ccomp'),ctx=c.getContext('2d');
const M=+document.getElementById('compMv').value||+document.getElementById('compM').value;
const viz=document.getElementById('compViz').value;
const col=document.getElementById('compCol').value;
const showProj=document.getElementById('compProj').checked;
const showLabels=document.getElementById('compLabels').checked;
const showMult=document.getElementById('compMult').checked;
const showCoprime=document.getElementById('compCoprime').checked;
const lineOp=+document.getElementById('compLineOp').value;
const ptSz=+document.getElementById('compPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('compMdisp').textContent=M;

compData.M=M;
const phi=eulerPhi(M);
const divs=getDivisors(M);
const factors=factorizeArr(M);
const primeFactors=[...new Set(factors)];

// Build residue data
const residues=[];
const channelCounts={};
for(let r=0;r<M;r++){
const g=gcd(r,M);
const Mprime=M/g;
const rprime=r/g;
const isCoprime=g===1;
const spf=smallestPrimeFactor(g);
const lpf=largestPrimeFactor(g);
residues.push({r,g,Mprime,rprime,isCoprime,spf,lpf});
channelCounts[Mprime]=(channelCounts[Mprime]||0)+1;}
compData.residues=residues;
compData.channels=divs.map(d=>({M:d,count:channelCounts[d]||0,mult:M/d}));

const cx=c.width/2,cy=c.height/2,R=Math.min(cx,cy)-60;

if(viz==='projection'||viz==='rings'){
// Draw main ring (M)
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,R,0,2*Math.PI);ctx.stroke();

// Draw channel rings (divisors of M)
if(showProj){
for(const d of divs){
if(d===M)continue;
const rRing=R*d/M;
ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,rRing,0,2*Math.PI);ctx.stroke();}}

// Draw projection lines for reducible residues
if(showProj){
ctx.globalAlpha=lineOp;
for(const res of residues){
if(res.isCoprime)continue;
const ang1=-2*Math.PI*res.r/M;
const x1=cx+R*Math.cos(ang1),y1=cy+R*Math.sin(ang1);
const rTarget=R*res.Mprime/M;
const ang2=-2*Math.PI*res.rprime/res.Mprime;
const x2=cx+rTarget*Math.cos(ang2),y2=cy+rTarget*Math.sin(ang2);
ctx.strokeStyle='#ff4040';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
ctx.globalAlpha=1;}

// Draw points
const filter=document.getElementById('compFilter').value;
for(const res of residues){
if(!showCoprime&&res.isCoprime)continue;
if(filter==='coprime'&&!res.isCoprime)continue;
if(filter==='reducible'&&res.isCoprime)continue;
const ang=-2*Math.PI*res.r/M;
const x=cx+R*Math.cos(ang),y=cy+R*Math.sin(ang);
let clr;
if(col==='type')clr=res.isCoprime?'#00d9ff':'#ff4040';
else if(col==='gcd')clr=res.g===1?'#00d9ff':`hsl(${res.g*30},70%,50%)`;
else if(col==='spf')clr=`hsl(${res.spf*40},80%,50%)`;
else if(col==='lpf')clr=`hsl(${res.lpf*25},70%,55%)`;
else if(col==='depth')clr=`hsl(${(1-res.Mprime/M)*280},70%,50%)`;
else clr=res.isCoprime?'#00d9ff':'#ff4040';
ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();
if(res.isCoprime){ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.stroke();}
if(showLabels&&M<=30){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(res.r,x,y-ptSz-3);}}

// Draw gap connections for coprime residues
const gaps=[];
if(document.getElementById('compGap2').checked)gaps.push({gap:2,color:'#ff6b6b'});
if(document.getElementById('compGap4').checked)gaps.push({gap:4,color:'#4ecdc4'});
if(document.getElementById('compGap6').checked)gaps.push({gap:6,color:'#ffe66d'});
const gapCol=document.getElementById('compGapCol').value;
const gapThick=+document.getElementById('compGapThick').value;
const coprimes=residues.filter(r=>r.isCoprime).map(r=>r.r);

for(const{gap,color}of gaps){
ctx.lineWidth=gapThick;
for(const r1 of coprimes){
const r2=(r1+gap)%M;
if(coprimes.includes(r2)){
const ang1=-2*Math.PI*r1/M;
const ang2=-2*Math.PI*r2/M;
const x1=cx+R*Math.cos(ang1),y1=cy+R*Math.sin(ang1);
const x2=cx+R*Math.cos(ang2),y2=cy+R*Math.sin(ang2);
ctx.strokeStyle=gapCol==='auto'?color:gapCol==='magenta'?'#ff00ff':gapCol==='cyan'?'#00ffff':'#ffd700';
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
}}}}

else if(viz==='channels'){
// Bar chart of channels
const barW=(c.width-100)/divs.length;
const maxCount=Math.max(...compData.channels.map(ch=>ch.count));
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Channel Distribution for M=${M}`,cx,30);
for(let i=0;i<compData.channels.length;i++){
const ch=compData.channels[i];
const x=50+i*barW;
const barH=(c.height-100)*ch.count/maxCount;
ctx.fillStyle=ch.M===M?'#00d9ff':`hsl(${i*360/divs.length},70%,50%)`;
ctx.fillRect(x,c.height-50-barH,barW*0.8,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';
ctx.fillText(`M'=${ch.M}`,x+barW*0.4,c.height-35);
if(showMult)ctx.fillText(`√ó${ch.mult}`,x+barW*0.4,c.height-50-barH-5);}}

else if(viz==='factorization'){
// Factor tree visualization
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 16px Segoe UI';ctx.textAlign='center';
ctx.fillText(`M = ${M} = ${factors.join(' √ó ')}`,cx,40);
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='14px Segoe UI';
ctx.fillText(`Prime factors: {${primeFactors.join(', ')}}`,cx,70);
ctx.fillText(`œÜ(${M}) = ${phi}`,cx,100);
ctx.fillText(`œÑ(${M}) = ${divs.length} divisors`,cx,130);
// Draw divisor lattice
const levels={};
for(const d of divs){
const nf=factorizeArr(d).length;
if(!levels[nf])levels[nf]=[];
levels[nf].push(d);}
const levelKeys=Object.keys(levels).map(Number).sort((a,b)=>a-b);
const levelH=(c.height-200)/Math.max(levelKeys.length,1);
for(let li=0;li<levelKeys.length;li++){
const lv=levels[levelKeys[li]];
const y=180+li*levelH;
const xStep=c.width/(lv.length+1);
for(let i=0;i<lv.length;i++){
const x=xStep*(i+1);
ctx.fillStyle=lv[i]===M?'#ffd700':lv[i]===1?'#00ff88':'#00d9ff';
ctx.beginPath();ctx.arc(x,y,15,0,2*Math.PI);ctx.fill();
ctx.fillStyle=isDark()?'#000':'#fff';ctx.font='bold 11px Arial';
ctx.fillText(lv[i],x,y+4);}}}

// Charts
Plotly.newPlot('pcompDist',[{x:compData.channels.map(ch=>`M'=${ch.M}`),y:compData.channels.map(ch=>ch.count),type:'bar',marker:{color:compData.channels.map(ch=>ch.M===M?'#00d9ff':'#ff8c00')}}],{...plo(),xaxis:{title:'Channel'},yaxis:{title:'Residues'}});

const divPhis=divs.map(d=>({d,phi:eulerPhi(d),ratio:eulerPhi(d)/d}));
Plotly.newPlot('pcompDiv',[{x:divs,y:divs.map(d=>M/d),type:'bar',name:'Multiplicity',marker:{color:'#9664ff'}}],{...plo(),xaxis:{title:'Divisor M\''},yaxis:{title:'Multiplicity d=M/M\''}});

Plotly.newPlot('pcompPhi',[{x:divs,y:divPhis.map(d=>d.ratio),mode:'lines+markers',line:{color:'#00ff88'},name:'œÜ(M\')/M\''},{x:[divs[0],divs[divs.length-1]],y:[6/Math.PI**2,6/Math.PI**2],mode:'lines',line:{color:'#ff006e',dash:'dash'},name:'6/œÄ¬≤'}],{...plo(),xaxis:{title:'Divisor'},yaxis:{title:'Coprime Density'}});

// Legend
const coprimeCount=residues.filter(r=>r.isCoprime).length;
const reducibleCount=M-coprimeCount;
legend('alcomp','Channel Stats',[['Coprime œÜ(M)',coprimeCount,'#00d9ff'],['Reducible',reducibleCount,'#ff4040'],['Channels œÑ(M)',divs.length,'#ffd700']]);

// Live stats
document.getElementById('compLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ffd700">${M}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS M</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#00d9ff">${phi}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ(M)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.4rem;font-weight:bold;color:#ff4040">${reducibleCount}</div><div style="font-size:.7rem;color:var(--txt2)">REDUCIBLE</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Factorization</strong>
<div style="margin-top:5px;font-size:.9rem;color:var(--txt)">M = ${factors.join(' √ó ')}</div>
<div style="font-size:.8rem;color:var(--txt2)">Prime factors: {${primeFactors.join(', ')}}</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Density Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>œÜ(M)/M:</span><span style="color:#00ff88">${(phi/M*100).toFixed(2)}%</span>
<span>Reducible ratio:</span><span style="color:#ff4040">${(reducibleCount/M*100).toFixed(2)}%</span>
<span>6/œÄ¬≤ limit:</span><span style="color:#9664ff">60.79%</span>
<span>Channels œÑ(M):</span><span style="color:#ffd700">${divs.length}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Divisors of M</strong>
<div style="margin-top:5px;font-size:.75rem;color:var(--txt2)">{${divs.join(', ')}}</div>
</div>
<div>
<strong style="color:var(--acc)">Channel Multiplicities</strong>
<div style="margin-top:5px;font-size:.75rem;color:var(--txt2)">
${compData.channels.slice(0,8).map(ch=>`M'=${ch.M}: √ó${ch.mult}`).join(' | ')}${compData.channels.length>8?'...':''}
</div>
</div>`;

// Table
document.getElementById('tcompT').innerHTML='<tr><th>r</th><th>gcd(r,M)</th><th>Channel M\'</th><th>Reduced r\'</th><th>Type</th><th>Multiplicity</th></tr>'+
residues.slice(0,100).map(res=>`<tr onclick="modal('Residue ${res.r} mod ${M}',[['r',${res.r}],['gcd(r,M)',${res.g}],['Channel M\\'',${res.Mprime}],['Reduced r\\'',${res.rprime}],['Type','${res.isCoprime?'Coprime':'Reducible'}'],['SPF',${res.spf}],['LPF',${res.lpf}]])" style="cursor:pointer;color:${res.isCoprime?'#00d9ff':'#ff4040'}"><td>${res.r}</td><td>${res.g}</td><td>${res.Mprime}</td><td>${res.rprime}</td><td>${res.isCoprime?'Coprime':'Reducible'}</td><td>${M/res.Mprime}</td></tr>`).join('');

// Click handler
c.onclick=e=>{const rect=c.getBoundingClientRect(),mx=(e.clientX-rect.left)*(c.width/rect.width),my=(e.clientY-rect.top)*(c.height/rect.height);
const cx=c.width/2,cy=c.height/2,R=Math.min(cx,cy)-60;
for(const res of residues){
const ang=-2*Math.PI*res.r/M;
const x=cx+R*Math.cos(ang),y=cy+R*Math.sin(ang);
if(Math.hypot(mx-x,my-y)<ptSz+5){
modal(`Residue ${res.r} mod ${M}`,[['r',res.r],['gcd(r,M)',res.g],['Channel M\'',res.Mprime],['Reduced r\'',res.rprime],['Type',res.isCoprime?'Coprime':'Reducible'],['Multiplicity',M/res.Mprime]]);break;}}};}

function startCompSweep(){
stopCompSweep();
const M=+document.getElementById('compMv').value;
const coprimes=compData.residues.filter(r=>r.isCoprime).map(r=>r.r);
let idx=0;
compSweepInterval=setInterval(()=>{
compSweepR=coprimes[idx%coprimes.length];
document.getElementById('compSweepR').textContent='r='+compSweepR;
// Highlight current coprime
drawComp();
const c=document.getElementById('ccomp'),ctx=c.getContext('2d');
const cx=c.width/2,cy=c.height/2,R=Math.min(cx,cy)-60;
const ang=-2*Math.PI*compSweepR/M;
const x=cx+R*Math.cos(ang),y=cy+R*Math.sin(ang);
ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(x,y,12,0,2*Math.PI);ctx.fill();
ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
idx++;},500);}

function stopCompSweep(){if(compSweepInterval){clearInterval(compSweepInterval);compSweepInterval=null;}}

function csvComp(){
let s='r,gcd,channel_M,reduced_r,type,multiplicity,spf,lpf\n';
for(const res of compData.residues)s+=`${res.r},${res.g},${res.Mprime},${res.rprime},${res.isCoprime?'coprime':'reducible'},${compData.M/res.Mprime},${res.spf},${res.lpf}\n`;
dl(s,'composite_channels.csv');}

async function screenshotComp(){
const M=document.getElementById('compMv').value;
await screenshotUnified('ccomp','compLiveStats',`Composite Channel Projection ‚Äî M=${M}`,'composite_channels.png',{dashH:350});
}

// Coprime Pairs Grid
let copairData={N:60,pairs:[],coprimeCount:0};
let copairAnimInterval=null;

function drawCopair(){
const c=document.getElementById('ccopair'),ctx=c.getContext('2d');
const N=+document.getElementById('copairNv').value||+document.getElementById('copairN').value;
const viz=document.getElementById('copairViz').value;
const col=document.getElementById('copairCol').value;
const showCircle=document.getElementById('copairCircle').checked;
const showDiag=document.getElementById('copairDiag').checked;
const showPrime=document.getElementById('copairPrime').checked;
const showLabels=document.getElementById('copairLabels').checked;
const showAxes=document.getElementById('copairAxes').checked;
const circleR=+document.getElementById('copairR').value/100;
const modHighlight=document.getElementById('copairMod').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('copairNdisp').textContent=N;
document.getElementById('copairAnimN').textContent='N='+N;

// Compute coprime pairs and disc statistics
let coprimeCount=0,discCoprime=0,discTotal=0;
const gcdCounts={};
const R=N*circleR;
const theory=6/Math.PI**2;

// M√∂bius function
function mobius(n){
if(n===1)return 1;
let result=1,temp=n;
for(let p=2;p*p<=temp;p++){
if(temp%p===0){
temp/=p;
if(temp%p===0)return 0;
result*=-1;}}
if(temp>1)result*=-1;
return result;}

// Compute M(N) = Œ£Œº(n)
let mobiusSum=0,mobiusSumN2=0;
for(let n=1;n<=N;n++){
const mu=mobius(n);
mobiusSum+=mu;
mobiusSumN2+=mu/(n*n);}

for(let a=1;a<=N;a++){
for(let b=1;b<=N;b++){
const g=gcd(a,b);
const isCoprime=g===1;
if(isCoprime)coprimeCount++;
gcdCounts[g]=(gcdCounts[g]||0)+1;
const dist2=a*a+b*b;
if(dist2<=R*R){
discTotal++;
if(isCoprime)discCoprime++;}}}

const totalPairs=N*N;
const ratio=coprimeCount/totalPairs;
const expectedDisc=theory*Math.PI*R*R;
const errorE=discCoprime-expectedDisc;
const errorRatio=Math.abs(errorE)/Math.sqrt(R);

const pad=40,w=c.width-2*pad,h=c.height-2*pad;
const scale=Math.min(w,h)/N;

// Color function
function getColor(a,b,g,isCoprime){
if(showPrime&&!isPrime(a)&&!isPrime(b))return 'rgba(50,50,50,0.3)';
if(modHighlight!=='none'){
const m=+modHighlight;
if(a%m===0||b%m===0)return '#ffd700';}
if(col==='classic')return isCoprime?'#00ff88':'#333';
if(col==='gcd')return isCoprime?'#00ff88':`hsl(${g*40},60%,40%)`;
if(col==='neon')return isCoprime?'#00ffff':'#ff00ff';
if(col==='heatmap')return isCoprime?`hsl(${120-g*10},80%,50%)`:`hsl(${g*20},60%,35%)`;
if(col==='highcontrast')return isCoprime?'#ffff00':'#000';
if(col==='angle')return `hsl(${Math.atan2(b,a)*180/Math.PI*2},70%,${isCoprime?55:35}%)`;
if(col==='norm')return `hsl(${(a*a+b*b)%360},70%,${isCoprime?55:35}%)`;
return isCoprime?'#00ff88':'#333';}

if(viz==='grid'||viz==='gcdmap'||viz==='disc'){
// Draw grid
const cellW=w/N,cellH=h/N;
for(let a=1;a<=N;a++){
for(let b=1;b<=N;b++){
const g=gcd(a,b);
const isCoprime=g===1;
const x=pad+(a-1)*cellW;
const y=pad+h-b*cellH;
ctx.fillStyle=getColor(a,b,g,isCoprime);
ctx.fillRect(x,y,cellW+0.5,cellH+0.5);}}

// Axes
if(showAxes){
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,pad+h);ctx.lineTo(pad+w,pad+h);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,pad+h);ctx.stroke();
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='11px Segoe UI';ctx.textAlign='center';
ctx.fillText('a',pad+w/2,pad+h+25);
ctx.save();ctx.translate(15,pad+h/2);ctx.rotate(-Math.PI/2);ctx.fillText('b',0,0);ctx.restore();}

// Diagonals
if(showDiag){
ctx.strokeStyle='#ffd700';ctx.lineWidth=1.5;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.moveTo(pad,pad+h);ctx.lineTo(pad+w,pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad+w,pad+h);ctx.stroke();ctx.setLineDash([]);}

// Radius circle
if(showCircle||viz==='disc'){
const cx=pad,cy=pad+h;
const rPx=R*scale;
ctx.strokeStyle='#ff006e';ctx.lineWidth=2;
ctx.beginPath();ctx.arc(cx,cy,rPx,0,-Math.PI/2,true);ctx.stroke();
ctx.fillStyle='#ff006e';ctx.font='11px Arial';
ctx.fillText(`R=${R.toFixed(1)}`,cx+rPx*0.7,cy-rPx*0.7);}

// Labels
if(showLabels&&N<=40){
ctx.fillStyle=isDark()?'#888':'#555';ctx.font='8px Arial';ctx.textAlign='center';
for(let i=1;i<=N;i+=Math.ceil(N/20)){
ctx.fillText(i,pad+(i-0.5)*cellW,pad+h+12);
ctx.fillText(i,pad-12,pad+h-(i-0.5)*cellH+3);}}}

else if(viz==='density'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Coprime Density Convergence to 6/œÄ¬≤',c.width/2,25);
const densities=[];
for(let n=5;n<=N;n+=Math.max(1,Math.floor(N/50))){
let cnt=0;
for(let a=1;a<=n;a++)for(let b=1;b<=n;b++)if(gcd(a,b)===1)cnt++;
densities.push({n,ratio:cnt/(n*n)});}
ctx.strokeStyle='#ff006e';ctx.lineWidth=2;ctx.setLineDash([5,5]);
const y6pi=pad+h*(1-theory);
ctx.beginPath();ctx.moveTo(pad,y6pi);ctx.lineTo(pad+w,y6pi);ctx.stroke();ctx.setLineDash([]);
ctx.fillStyle='#ff006e';ctx.font='11px Arial';ctx.textAlign='left';
ctx.fillText('6/œÄ¬≤ ‚âà 0.6079',pad+5,y6pi-5);
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=2;
for(let i=0;i<densities.length;i++){
const x=pad+w*i/(densities.length-1);
const y=pad+h*(1-densities[i].ratio);
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

else if(viz==='scatter'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Primitive Lattice Vectors (Visible from Origin)',c.width/2,25);
const plotN=Math.min(N,120);
for(let a=1;a<=plotN;a++){
for(let b=1;b<=plotN;b++){
if(gcd(a,b)!==1)continue;
if(showPrime&&!isPrime(a)&&!isPrime(b))continue;
const x=pad+w*a/plotN;
const y=pad+h-h*b/plotN;
ctx.fillStyle=`hsl(${Math.atan2(b,a)*180/Math.PI*2},70%,55%)`;
ctx.beginPath();ctx.arc(x,y,2.5,0,2*Math.PI);ctx.fill();}}
if(showCircle){
ctx.strokeStyle='#ff006e';ctx.lineWidth=2;
ctx.beginPath();ctx.arc(pad,pad+h,R*w/plotN,0,-Math.PI/2,true);ctx.stroke();}}

// Charts
const gcdArr=Object.entries(gcdCounts).map(([g,c])=>({g:+g,count:c})).sort((a,b)=>a.g-b.g).slice(0,12);
Plotly.newPlot('pcopairGcd',[{x:gcdArr.map(g=>`${g.g}`),y:gcdArr.map(g=>g.count),type:'bar',marker:{color:gcdArr.map(g=>g.g===1?'#00ff88':'#ff8c00')}}],{...plo(),xaxis:{title:'gcd'},yaxis:{title:'Count'}});

// Disc analysis chart
const discData=[];
for(let r=10;r<=N;r+=Math.max(1,Math.floor(N/25))){
let vr=0;
for(let a=1;a<=r;a++)for(let b=1;b<=r;b++)if(a*a+b*b<=r*r&&gcd(a,b)===1)vr++;
const exp=theory*Math.PI*r*r;
discData.push({r,vr,exp,err:vr-exp,errRatio:Math.abs(vr-exp)/Math.sqrt(r)});}
Plotly.newPlot('pcopairDisc',[
{x:discData.map(d=>d.r),y:discData.map(d=>d.vr),mode:'lines',name:'V(R)',line:{color:'#00ff88'}},
{x:discData.map(d=>d.r),y:discData.map(d=>d.exp),mode:'lines',name:'(6/œÄ¬≤)œÄR¬≤',line:{color:'#ffd700',dash:'dash'}}
],{...plo(),xaxis:{title:'Radius R'},yaxis:{title:'Coprime in Disc'}});

// Convergence chart
const convData=[];
for(let n=10;n<=N;n+=Math.max(1,Math.floor(N/25))){
let cnt=0;
for(let a=1;a<=n;a++)for(let b=1;b<=n;b++)if(gcd(a,b)===1)cnt++;
convData.push({n,ratio:cnt/(n*n)});}
Plotly.newPlot('pcopairConv',[
{x:convData.map(d=>d.n),y:convData.map(d=>d.ratio),mode:'lines+markers',line:{color:'#00ff88'},name:'A_N/N¬≤'},
{x:[10,N],y:[theory,theory],mode:'lines',line:{color:'#ff006e',dash:'dash'},name:'6/œÄ¬≤'}
],{...plo(),xaxis:{title:'N'},yaxis:{title:'Ratio',range:[0.55,0.68]}});

// M√∂bius chart
const mobData=[];
let mSum=0;
for(let n=1;n<=Math.min(N,200);n+=Math.max(1,Math.floor(N/50))){
for(let k=(mobData.length?mobData[mobData.length-1].n+1:1);k<=n;k++)mSum+=mobius(k);
mobData.push({n,mSum,bound:Math.sqrt(n)});}
Plotly.newPlot('pcopairMob',[
{x:mobData.map(d=>d.n),y:mobData.map(d=>d.mSum),mode:'lines',name:'M(N)',line:{color:'#00d9ff'}},
{x:mobData.map(d=>d.n),y:mobData.map(d=>d.bound),mode:'lines',name:'‚àöN',line:{color:'#ffd700',dash:'dot'}},
{x:mobData.map(d=>d.n),y:mobData.map(d=>-d.bound),mode:'lines',name:'-‚àöN',line:{color:'#ffd700',dash:'dot'}}
],{...plo(),xaxis:{title:'N'},yaxis:{title:'M(N) = Œ£Œº(n)'}});

// RH bound chart
Plotly.newPlot('pcopairRH',[
{x:discData.map(d=>d.r),y:discData.map(d=>d.errRatio),mode:'lines+markers',line:{color:'#ff006e'},name:'|E(R)|/R^¬Ω'}
],{...plo(),xaxis:{title:'R'},yaxis:{title:'|E(R)|/‚àöR',range:[0,Math.max(...discData.map(d=>d.errRatio))*1.2]}});

// Legend
legend('alcopair','Statistics',[['Coprime A_N',coprimeCount,'#00ff88'],['V(R) in disc',discCoprime,'#00d9ff'],['|E(R)|/‚àöR',errorRatio.toFixed(2),'#ff006e']]);

// Live stats
const absErr=Math.abs(ratio-theory);
document.getElementById('copairLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Coprime Pairs | FIELD: ‚Ñ§√ó‚Ñ§ Grid | TYPE: GCD=1 Counting</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Grid N: <strong style="color:#00d9ff">${N}</strong></span>
<span>Total: <strong style="color:#ffd700">${(N*N).toLocaleString()}</strong></span>
<span>Coprime: <strong style="color:#00ff88">${coprimeCount.toLocaleString()}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${N}</div><div style="font-size:.65rem;color:var(--txt2)">GRID N</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${coprimeCount.toLocaleString()}</div><div style="font-size:.65rem;color:var(--txt2)">COPRIME (ACTUAL)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${Math.round(N*N*theory).toLocaleString()}</div><div style="font-size:.65rem;color:var(--txt2)">PREDICTED (6N¬≤/œÄ¬≤)</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${ratio.toFixed(5)}</div><div style="font-size:.6rem;color:var(--txt2)">DENSITY A_N/N¬≤</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff8c00">${theory.toFixed(6)}</div><div style="font-size:.6rem;color:var(--txt2)">THEORY 6/œÄ¬≤</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:${absErr<0.01?'#00ff88':'#ff6496'}">${absErr.toFixed(6)}</div><div style="font-size:.6rem;color:var(--txt2)">ERROR</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Density Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Theory 6/œÄ¬≤:</span><span style="color:#ff006e">${theory.toFixed(6)}</span>
<span>Error:</span><span style="color:#ffd700">${absErr.toFixed(6)}</span>
<span>Relative:</span><span style="color:#9664ff">${(100*absErr/theory).toFixed(3)}%</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Disc Analysis (R=${R.toFixed(1)})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>V(R) coprime:</span><span style="color:#00ff88">${discCoprime}</span>
<span>Expected:</span><span style="color:#ffd700">${expectedDisc.toFixed(1)}</span>
<span>E(R):</span><span style="color:#ff006e">${errorE.toFixed(2)}</span>
<span>|E(R)|/‚àöR:</span><span style="color:#00d9ff;font-weight:bold">${errorRatio.toFixed(3)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">M√∂bius Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>M(N)=Œ£Œº(n):</span><span style="color:#00d9ff">${mobiusSum}</span>
<span>|M(N)|/‚àöN:</span><span style="color:#ffd700">${(Math.abs(mobiusSum)/Math.sqrt(N)).toFixed(3)}</span>
<span>Œ£Œº(n)/n¬≤:</span><span style="color:#00ff88">${mobiusSumN2.toFixed(6)}</span>
</div>
</div>
<div style="background:rgba(255,0,110,.1);padding:8px;border-radius:6px;font-size:.75rem">
<strong style="color:#ff006e">RH Connection</strong><br>
<span style="color:var(--txt2)">|E(R)|=O(R^¬Ω‚Å∫·µã) ‚ü∫ RH true. Current |E|/‚àöR = ${errorRatio.toFixed(3)}</span>
</div>`;

// Table
const samplePairs=[];
for(let a=1;a<=Math.min(12,N);a++){
for(let b=1;b<=Math.min(12,N);b++){
const g=gcd(a,b);
samplePairs.push({a,b,g,norm:a*a+b*b,angle:(Math.atan2(b,a)*180/Math.PI).toFixed(1)});}}
document.getElementById('tcopairT').innerHTML='<tr><th>a</th><th>b</th><th>gcd</th><th>Norm</th><th>Œ∏¬∞</th><th>Coprime?</th></tr>'+
samplePairs.slice(0,100).map(p=>`<tr onclick="modal('Pair (${p.a},${p.b})',[['a',${p.a}],['b',${p.b}],['gcd(a,b)',${p.g}],['Norm a¬≤+b¬≤',${p.norm}],['Angle',${p.angle}+'¬∞'],['Coprime',${p.g===1}],['Visible from origin',${p.g===1}]])" style="cursor:pointer;color:${p.g===1?'#00ff88':'#666'}"><td>${p.a}</td><td>${p.b}</td><td>${p.g}</td><td>${p.norm}</td><td>${p.angle}</td><td>${p.g===1?'‚úì':''}</td></tr>`).join('');

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
const cellW=(c.width-80)/N,cellH=(c.height-80)/N;
const a=Math.floor((mx-40)/cellW)+1;
const b=N-Math.floor((my-40)/cellH);
if(a>=1&&a<=N&&b>=1&&b<=N){
const g=gcd(a,b);
const norm=a*a+b*b;
const angle=(Math.atan2(b,a)*180/Math.PI).toFixed(2);
modal(`Lattice Point (${a}, ${b})`,[['a',a],['b',b],['gcd(a,b)',g],['Coprime (visible)?',g===1?'Yes':'No'],['Norm a¬≤+b¬≤',norm],['Distance ‚àö(a¬≤+b¬≤)',Math.sqrt(norm).toFixed(3)],['Angle Œ∏',angle+'¬∞'],['Gaussian z',`${a}+${b}i`],['In disc R=${R.toFixed(1)}?',norm<=R*R?'Yes':'No']]);}};}

function startCopairAnim(){
stopCopairAnim();
let n=10;
const maxN=+document.getElementById('copairNv').value;
copairAnimInterval=setInterval(()=>{
document.getElementById('copairNv').value=n;
drawCopair();
n+=2;
if(n>maxN)stopCopairAnim();},200);}

function stopCopairAnim(){if(copairAnimInterval){clearInterval(copairAnimInterval);copairAnimInterval=null;}}

function csvCopair(){
const N=copairData.N;
let s='a,b,gcd,coprime,sum,product\n';
for(let a=1;a<=Math.min(N,100);a++){
for(let b=1;b<=Math.min(N,100);b++){
const g=gcd(a,b);
s+=`${a},${b},${g},${g===1?1:0},${a+b},${a*b}\n`;}}
dl(s,'coprime_pairs.csv');}

async function screenshotCopair(){
const N=document.getElementById('copairNv').value;
await screenshotUnified('ccopair','copairLiveStats',`Coprime Pairs Grid ‚Äî N=${N}`,'coprime_pairs.png',{dashH:350});
}

// Sierpi≈Ñski Problem: 6ab ¬± a ¬± b
let sierpData={N:200,covered:new Set(),uncovered:[]};

function sierpinski6ab(maxN,maxAB){
const covered=new Set();
const formCounts={pp:new Set(),pm:new Set(),mp:new Set(),mm:new Set()};
const maxA=maxAB||Math.ceil(Math.sqrt(maxN/6))+5;
for(let a=1;a<=maxA;a++){
for(let b=1;b<=maxA;b++){
const pp=6*a*b+a+b;
const pm=6*a*b+a-b;
const mp=6*a*b-a+b;
const mm=6*a*b-a-b;
if(pp>0&&pp<=maxN){covered.add(pp);formCounts.pp.add(pp);}
if(pm>0&&pm<=maxN){covered.add(pm);formCounts.pm.add(pm);}
if(mp>0&&mp<=maxN){covered.add(mp);formCounts.mp.add(mp);}
if(mm>0&&mm<=maxN){covered.add(mm);formCounts.mm.add(mm);}}}
const uncovered=[];
for(let n=1;n<=maxN;n++)if(!covered.has(n))uncovered.push(n);
return {covered,uncovered,formCounts};}

function drawSierp(){
const c=document.getElementById('csierp'),ctx=c.getContext('2d');
const N=+document.getElementById('sierpNv').value||+document.getElementById('sierpN').value;
const maxAB=+document.getElementById('sierpABv').value;
const viz=document.getElementById('sierpViz').value;
const form=document.getElementById('sierpForm').value;
const showLabels=document.getElementById('sierpLabels').checked;
const showGCD=document.getElementById('sierpGCD').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('sierpNdisp').textContent=N;

const result=sierpinski6ab(N,maxAB);
sierpData={N,covered:result.covered,uncovered:result.uncovered};

const pad=40,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='coverage'){
// Grid showing covered vs uncovered
const cols=Math.ceil(Math.sqrt(N*1.5));
const rows=Math.ceil(N/cols);
const cellW=w/cols,cellH=h/rows;
for(let n=1;n<=N;n++){
const col=(n-1)%cols;
const row=Math.floor((n-1)/cols);
const x=pad+col*cellW;
const y=pad+row*cellH;
let isCovered=result.covered.has(n);
if(form!=='all'){
isCovered=result.formCounts[form].has(n);}
ctx.fillStyle=isCovered?'#00ff88':'#ff4040';
ctx.fillRect(x+1,y+1,cellW-2,cellH-2);
if(showLabels&&N<=100){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='8px Arial';ctx.textAlign='center';
ctx.fillText(n,x+cellW/2,y+cellH/2+3);}}
// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Coverage Map: ${result.covered.size} covered, ${result.uncovered.length} uncovered`,c.width/2,25);}

else if(viz==='lattice'){
// Show lattice points (a,b) and what they cover
const maxPlot=Math.min(maxAB,50);
const scale=Math.min(w,h)/maxPlot;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Lattice (a,b): Each point generates 4 values via 6ab¬±a¬±b',c.width/2,25);
for(let a=1;a<=maxPlot;a++){
for(let b=1;b<=maxPlot;b++){
const x=pad+a*scale;
const y=pad+h-b*scale;
const g=gcd(a,b);
let clr='#00d9ff';
if(showGCD){
if(g%6===0)clr='#ffd700';
else if(g%3===0)clr='#ff8c00';
else if(g%2===0)clr='#9664ff';}
ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(x,y,3,0,2*Math.PI);ctx.fill();}}
// Axes
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,pad+h);ctx.lineTo(pad+w,pad+h);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,pad+h);ctx.stroke();
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='11px Segoe UI';
ctx.fillText('a',pad+w/2,pad+h+25);
ctx.save();ctx.translate(15,pad+h/2);ctx.rotate(-Math.PI/2);ctx.fillText('b',0,0);ctx.restore();}

else if(viz==='gaps'){
// Show gaps between uncovered numbers
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Uncovered Numbers (${result.uncovered.length} total)`,c.width/2,25);
if(result.uncovered.length>0){
const maxU=result.uncovered[result.uncovered.length-1];
for(let i=0;i<result.uncovered.length;i++){
const n=result.uncovered[i];
const x=pad+w*n/maxU;
const y=pad+h/2;
ctx.fillStyle='#ff4040';
ctx.beginPath();ctx.arc(x,y,5,0,2*Math.PI);ctx.fill();
if(showLabels&&result.uncovered.length<=50){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(n,x,y-10);}}}
// Mark gaps
ctx.strokeStyle='#ffd700';ctx.lineWidth=1;
for(let i=1;i<result.uncovered.length;i++){
const gap=result.uncovered[i]-result.uncovered[i-1];
if(gap>10){
const x1=pad+w*result.uncovered[i-1]/result.uncovered[result.uncovered.length-1];
const x2=pad+w*result.uncovered[i]/result.uncovered[result.uncovered.length-1];
ctx.beginPath();ctx.moveTo(x1,pad+h/2+20);ctx.lineTo(x2,pad+h/2+20);ctx.stroke();
ctx.fillStyle='#ffd700';ctx.font='8px Arial';
ctx.fillText(gap,(x1+x2)/2,pad+h/2+35);}}}

else if(viz==='modular'){
// Modular distribution of uncovered numbers
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Uncovered Numbers by Residue Class mod 6 and mod 12',c.width/2,25);
const mod6=[0,0,0,0,0,0];
const mod12=[0,0,0,0,0,0,0,0,0,0,0,0];
for(const n of result.uncovered){
mod6[n%6]++;
mod12[n%12]++;}
// Draw mod 6 bars
const barW=w/2/6-10;
for(let i=0;i<6;i++){
const x=pad+i*(barW+10);
const barH=mod6[i]*5;
ctx.fillStyle=`hsl(${i*60},70%,50%)`;
ctx.fillRect(x,pad+h/2-barH,barW,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(`${i}`,x+barW/2,pad+h/2+15);
ctx.fillText(mod6[i],x+barW/2,pad+h/2-barH-5);}
ctx.fillText('mod 6',pad+w/4,pad+h/2+35);
// Draw mod 12 bars
const barW2=w/2/12-5;
for(let i=0;i<12;i++){
const x=pad+w/2+i*(barW2+5);
const barH=mod12[i]*5;
ctx.fillStyle=`hsl(${i*30},70%,50%)`;
ctx.fillRect(x,pad+h/2-barH,barW2,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='8px Arial';ctx.textAlign='center';
ctx.fillText(`${i}`,x+barW2/2,pad+h/2+12);
ctx.fillText(mod12[i],x+barW2/2,pad+h/2-barH-5);}
ctx.fillText('mod 12',pad+3*w/4,pad+h/2+35);}

// Charts
const formData=[
{form:'6ab+a+b',count:result.formCounts.pp.size},
{form:'6ab+a-b',count:result.formCounts.pm.size},
{form:'6ab-a+b',count:result.formCounts.mp.size},
{form:'6ab-a-b',count:result.formCounts.mm.size}];
Plotly.newPlot('psierpForm',[{x:formData.map(f=>f.form),y:formData.map(f=>f.count),type:'bar',marker:{color:['#00ff88','#00d9ff','#ffd700','#ff8c00']}}],{...plo(),xaxis:{title:'Form'},yaxis:{title:'Numbers Covered'}});

// Gap distribution
const gaps=[];
for(let i=1;i<result.uncovered.length;i++){
gaps.push(result.uncovered[i]-result.uncovered[i-1]);}
const gapCounts={};
for(const g of gaps)gapCounts[g]=(gapCounts[g]||0)+1;
const gapArr=Object.entries(gapCounts).map(([g,c])=>({gap:+g,count:c})).sort((a,b)=>a.gap-b.gap).slice(0,15);
Plotly.newPlot('psierpGaps',[{x:gapArr.map(g=>`gap ${g.gap}`),y:gapArr.map(g=>g.count),type:'bar',marker:{color:'#ff4040'}}],{...plo(),xaxis:{title:'Gap Size'},yaxis:{title:'Frequency'}});

// Coverage rate
const rateData=[];
const step=Math.max(5,Math.floor(N/25));
for(let n=20;n<=N;n+=step){
const r=sierpinski6ab(n,Math.ceil(Math.sqrt(n/6))+5);
rateData.push({n,rate:100*r.covered.size/n});}
if(rateData.length>0){
Plotly.newPlot('psierpRate',[{x:rateData.map(d=>d.n),y:rateData.map(d=>d.rate),mode:'lines+markers',line:{color:'#00ff88'},marker:{size:6}}],{...plo(),xaxis:{title:'N'},yaxis:{title:'Coverage %',range:[Math.min(90,...rateData.map(d=>d.rate))-2,100]}});
}else{
Plotly.newPlot('psierpRate',[],{...plo()});}

// Legend
legend('alsierp','Statistics',[['Covered',result.covered.size,'#00ff88'],['Uncovered',result.uncovered.length,'#ff4040'],['Rate',(100*result.covered.size/N).toFixed(2)+'%','#ffd700']]);

// Live stats
const coverageRate=(100*result.covered.size/N).toFixed(2);
document.getElementById('sierpLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${N}</div><div style="font-size:.65rem;color:var(--txt2)">MAX N</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${result.covered.size}</div><div style="font-size:.65rem;color:var(--txt2)">COVERED</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff4040">${result.uncovered.length}</div><div style="font-size:.65rem;color:var(--txt2)">UNCOVERED</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Coverage Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Coverage Rate:</span><span style="color:#00ff88">${coverageRate}%</span>
<span>Search Depth:</span><span style="color:#ffd700">a,b ‚â§ ${maxAB}</span>
<span>First Uncovered:</span><span style="color:#ff4040">${result.uncovered[0]||'none'}</span>
<span>Last Uncovered:</span><span style="color:#ff4040">${result.uncovered[result.uncovered.length-1]||'none'}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Form Coverage</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>6ab+a+b:</span><span style="color:#00ff88">${result.formCounts.pp.size}</span>
<span>6ab+a-b:</span><span style="color:#00d9ff">${result.formCounts.pm.size}</span>
<span>6ab-a+b:</span><span style="color:#ffd700">${result.formCounts.mp.size}</span>
<span>6ab-a-b:</span><span style="color:#ff8c00">${result.formCounts.mm.size}</span>
</div>
</div>
<div style="background:rgba(255,64,64,.1);padding:8px;border-radius:6px;font-size:.75rem">
<strong style="color:#ff4040">Open Problem (1964)</strong><br>
<span style="color:var(--txt2)">Are there infinitely many uncovered integers? Known: 78 uncovered ‚â§1000</span>
</div>`;

// Table
document.getElementById('tsierpT').innerHTML='<tr><th>n</th><th>n mod 6</th><th>n mod 12</th><th>Factorization</th><th>Neighbors</th></tr>'+
result.uncovered.slice(0,50).map(n=>{
const factors=factorizeArr(n).join('√ó')||'1';
const prev=result.uncovered[result.uncovered.indexOf(n)-1]||'-';
const next=result.uncovered[result.uncovered.indexOf(n)+1]||'-';
return `<tr onclick="testSierpNum(${n})" style="cursor:pointer;color:#ff4040"><td>${n}</td><td>${n%6}</td><td>${n%12}</td><td>${factors}</td><td>${prev}, ${next}</td></tr>`;}).join('');

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='coverage'){
const cols=Math.ceil(Math.sqrt(N*1.5));
const cellW=(c.width-80)/cols,cellH=(c.height-80)/Math.ceil(N/cols);
const col=Math.floor((mx-40)/cellW);
const row=Math.floor((my-40)/cellH);
const n=row*cols+col+1;
if(n>=1&&n<=N){
const isCovered=result.covered.has(n);
modal(`Number ${n}`,[['n',n],['Covered?',isCovered?'Yes':'No'],['n mod 6',n%6],['n mod 12',n%12],['Factorization',factorizeArr(n).join('√ó')||'1']]);}}};
}

function testSierpNum(n){
if(!n)n=+document.getElementById('sierpTest').value;
const maxAB=+document.getElementById('sierpABv').value;
const reps=[];
for(let a=1;a<=maxAB;a++){
for(let b=1;b<=maxAB;b++){
if(6*a*b+a+b===n)reps.push(`6¬∑${a}¬∑${b}+${a}+${b}`);
if(6*a*b+a-b===n)reps.push(`6¬∑${a}¬∑${b}+${a}-${b}`);
if(6*a*b-a+b===n)reps.push(`6¬∑${a}¬∑${b}-${a}+${b}`);
if(6*a*b-a-b===n)reps.push(`6¬∑${a}¬∑${b}-${a}-${b}`);}}
const msg=reps.length>0?reps.slice(0,5).join('\n'):'No representation found';
modal(`Test n = ${n}`,[['n',n],['Covered?',reps.length>0?'Yes':'No'],['Representations',reps.length],['Examples',msg]]);}

function csvSierp(){
let s='n,covered,mod6,mod12,factorization\n';
for(let n=1;n<=sierpData.N;n++){
const isCov=sierpData.covered.has(n)?1:0;
s+=`${n},${isCov},${n%6},${n%12},"${factorizeArr(n).join('√ó')||'1'}"\n`;}
dl(s,'sierpinski_coverage.csv');}

async function screenshotSierp(){
const c=document.getElementById('csierp'),dashData=extractDashboardData('sierpLiveStats');
const N=document.getElementById('sierpNv').value;
const scale=2,pad=30,dashH=350;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Sierpi≈Ñski Problem ‚Äî N=${N}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='sierpinski.png';a.click();},'image/png',1.0);}

// k-Free Integers (Squarefree, Cubefree, etc.)
const zetaVals={2:ZETA2,3:ZETA3,4:ZETA4,5:ZETA5,6:ZETA6,7:ZETA7,8:ZETA8};

function isKfree(n,k){
if(n<=1)return n===1;
for(let p=2;p*p<=n;p++){
if(n%p===0){
let cnt=0;
while(n%p===0){cnt++;n/=p;}
if(cnt>=k)return false;}}
return true;}

function countKfree(N,k){
let count=0;
const nonKfree=[];
for(let n=1;n<=N;n++){
if(isKfree(n,k))count++;
else if(nonKfree.length<100)nonKfree.push(n);}
return {count,nonKfree};}

function drawKfree(){
const c=document.getElementById('ckfree'),ctx=c.getContext('2d');
const N=+document.getElementById('kfreeNv').value||+document.getElementById('kfreeN').value;
const k=+document.getElementById('kfreeK').value;
const viz=document.getElementById('kfreeViz').value;
const showTheory=document.getElementById('kfreeTheory').checked;
const showBound=document.getElementById('kfreeBound').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);
document.getElementById('kfreeKdisp').textContent=k;
document.getElementById('kfreeNdisp').textContent=N;

const zeta=zetaVals[k]||1;
const density=1/zeta;
const result=countKfree(N,k);
const predicted=N/zeta;
const error=result.count-predicted;
const errorBound=Math.pow(N,1/k);
const errorRatio=Math.abs(error)/errorBound;

const pad=50,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='density'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`${k===2?'Squarefree':k===3?'Cubefree':k+'-free'} Density Convergence to 1/Œ∂(${k})`,c.width/2,25);
const densData=[];
const step=Math.max(10,Math.floor(N/40));
for(let n=50;n<=N;n+=step){
const r=countKfree(n,k);
densData.push({n,ratio:r.count/n});}
// Theory line
if(showTheory){
ctx.strokeStyle='#ff006e';ctx.lineWidth=2;ctx.setLineDash([5,5]);
const yTheory=pad+h*(1-density);
ctx.beginPath();ctx.moveTo(pad,yTheory);ctx.lineTo(pad+w,yTheory);ctx.stroke();ctx.setLineDash([]);
ctx.fillStyle='#ff006e';ctx.font='11px Arial';ctx.textAlign='left';
ctx.fillText(`1/Œ∂(${k}) ‚âà ${density.toFixed(4)}`,pad+5,yTheory-5);}
// Density curve
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=2;
for(let i=0;i<densData.length;i++){
const x=pad+w*i/(densData.length-1);
const y=pad+h*(1-densData[i].ratio);
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

else if(viz==='error'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Error Term E(N) = Q_${k}(N) - N/Œ∂(${k})`,c.width/2,25);
const errData=[];
const step=Math.max(10,Math.floor(N/40));
for(let n=50;n<=N;n+=step){
const r=countKfree(n,k);
const pred=n/zeta;
errData.push({n,err:r.count-pred,bound:Math.pow(n,1/k)});}
const maxErr=Math.max(...errData.map(d=>Math.abs(d.err)));
const maxBound=Math.max(...errData.map(d=>d.bound));
const scale=Math.max(maxErr,maxBound);
// Error curve
ctx.beginPath();ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
for(let i=0;i<errData.length;i++){
const x=pad+w*i/(errData.length-1);
const y=pad+h/2-h/2*errData[i].err/scale;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
// Bound curves
if(showBound){
ctx.strokeStyle='#ffd700';ctx.lineWidth=1.5;ctx.setLineDash([3,3]);
ctx.beginPath();
for(let i=0;i<errData.length;i++){
const x=pad+w*i/(errData.length-1);
const y=pad+h/2-h/2*errData[i].bound/scale;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
ctx.beginPath();
for(let i=0;i<errData.length;i++){
const x=pad+w*i/(errData.length-1);
const y=pad+h/2+h/2*errData[i].bound/scale;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();ctx.setLineDash([]);}
// Zero line
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,pad+h/2);ctx.lineTo(pad+w,pad+h/2);ctx.stroke();}

else if(viz==='grid'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`${k}-free Numbers Grid (green = ${k}-free)`,c.width/2,25);
const gridN=Math.min(N,500);
const cols=Math.ceil(Math.sqrt(gridN*1.5));
const rows=Math.ceil(gridN/cols);
const cellW=w/cols,cellH=h/rows;
for(let n=1;n<=gridN;n++){
const col=(n-1)%cols;
const row=Math.floor((n-1)/cols);
const x=pad+col*cellW;
const y=pad+row*cellH;
ctx.fillStyle=isKfree(n,k)?'#00ff88':'#ff4040';
ctx.fillRect(x+0.5,y+0.5,cellW-1,cellH-1);}}

else if(viz==='compare'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Comparing Densities for k = 2, 3, 4, 5, 6',c.width/2,25);
const colors=['#00ff88','#00d9ff','#ffd700','#ff8c00','#ff006e'];
for(let ki=2;ki<=6;ki++){
const dens=1/zetaVals[ki];
const y=pad+h*(1-dens);
ctx.strokeStyle=colors[ki-2];ctx.lineWidth=2;ctx.setLineDash([]);
ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();
ctx.fillStyle=colors[ki-2];ctx.font='11px Arial';ctx.textAlign='left';
ctx.fillText(`k=${ki}: 1/Œ∂(${ki})=${dens.toFixed(4)}`,pad+10+(ki-2)*120,y-5);}}

// Charts - Zeta reference
const zetaData=[2,3,4,5,6].map(ki=>({k:ki,zeta:zetaVals[ki],inv:1/zetaVals[ki]}));
Plotly.newPlot('pkfreeZeta',[{x:zetaData.map(d=>`k=${d.k}`),y:zetaData.map(d=>d.inv),type:'bar',marker:{color:['#00ff88','#00d9ff','#ffd700','#ff8c00','#ff006e']},name:'1/Œ∂(k)'}],{...plo(),xaxis:{title:'k'},yaxis:{title:'Density 1/Œ∂(k)',range:[0.5,1]}});

// Error chart
const errData=[];
const step=Math.max(10,Math.floor(N/30));
for(let n=50;n<=N;n+=step){
const r=countKfree(n,k);
const pred=n/zeta;
errData.push({n,err:r.count-pred});}
Plotly.newPlot('pkfreeErr',[{x:errData.map(d=>d.n),y:errData.map(d=>d.err),mode:'lines',line:{color:'#00d9ff'},name:'E(N)'}],{...plo(),xaxis:{title:'N'},yaxis:{title:'Error'}});

// Ratio chart
const ratioData=errData.map(d=>({n:d.n,ratio:Math.abs(d.err)/Math.pow(d.n,1/k)}));
Plotly.newPlot('pkfreeRatio',[{x:ratioData.map(d=>d.n),y:ratioData.map(d=>d.ratio),mode:'lines+markers',line:{color:'#ff006e'},name:'|E|/N^(1/k)'}],{...plo(),xaxis:{title:'N'},yaxis:{title:'Ratio'}});

// Legend
legend('alkfree','Statistics',[['Q_k(N)',result.count,'#00ff88'],['Predicted',predicted.toFixed(1),'#ffd700'],['Error',error.toFixed(2),'#00d9ff']]);

// Live stats
document.getElementById('kfreeLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${k}</div><div style="font-size:.65rem;color:var(--txt2)">k VALUE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${result.count}</div><div style="font-size:.65rem;color:var(--txt2)">Q_k(N)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${(result.count/N).toFixed(5)}</div><div style="font-size:.65rem;color:var(--txt2)">DENSITY</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Theoretical Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Œ∂(${k}):</span><span style="color:#ffd700">${zeta.toFixed(6)}</span>
<span>1/Œ∂(${k}):</span><span style="color:#00ff88">${density.toFixed(6)}</span>
<span>Predicted:</span><span style="color:#9664ff">${predicted.toFixed(2)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Error Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>E(N):</span><span style="color:#00d9ff">${error.toFixed(3)}</span>
<span>|E(N)|:</span><span style="color:#ff006e">${Math.abs(error).toFixed(3)}</span>
<span>Bound N^(1/${k}):</span><span style="color:#ffd700">${errorBound.toFixed(2)}</span>
<span>|E|/Bound:</span><span style="color:#ff8c00;font-weight:bold">${errorRatio.toFixed(4)}</span>
</div>
</div>
<div style="background:rgba(0,255,136,.1);padding:8px;border-radius:6px;font-size:.75rem">
<strong style="color:#00ff88">Boundary Principle</strong><br>
<span style="color:var(--txt2)">Error O(N^(1/k)) from (k-1)-dim boundary truncation</span>
</div>`;

// Table
const nonKfreeData=result.nonKfree.slice(0,40).map(n=>{
const f=factorizeArr(n);
let smallestPk=0;
for(let p=2;p*p<=n;p++){
let cnt=0,temp=n;
while(temp%p===0){cnt++;temp/=p;}
if(cnt>=k){smallestPk=p;break;}}
return {n,factors:f.join('√ó'),pk:`${smallestPk}^${k}`,p:smallestPk};});
document.getElementById('tkfreeT').innerHTML='<tr><th>n</th><th>Factorization</th><th>Divisible by p^k</th><th>Smallest p</th></tr>'+
nonKfreeData.map(d=>`<tr style="color:#ff4040"><td>${d.n}</td><td>${d.factors}</td><td>${d.pk}</td><td>${d.p}</td></tr>`).join('');}

function csvKfree(){
const N=+document.getElementById('kfreeNv').value;
const k=+document.getElementById('kfreeK').value;
let s=`n,is_${k}_free,cumulative_count,density\n`;
let cnt=0;
for(let n=1;n<=N;n++){
const kf=isKfree(n,k)?1:0;
cnt+=kf;
s+=`${n},${kf},${cnt},${(cnt/n).toFixed(6)}\n`;}
dl(s,`${k}_free_integers.csv`);}

async function screenshotKfree(){
const c=document.getElementById('ckfree'),dashData=extractDashboardData('kfreeLiveStats');
const N=document.getElementById('kfreeNv').value,k=document.getElementById('kfreeK').value;
const scale=2,pad=30,dashH=350;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`${k}-Free Integers ‚Äî N=${N}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='k_free.png';a.click();},'image/png',1.0);}

// Euler Product for œÄ and Œ∂(2n)
let eulerData={primes:[],product:1,target:Math.PI};

function eulerProductPrimes(primes,s){
let product=1;
for(const p of primes){
product*=1/(1-Math.pow(p,-s));}
return product;}

function drawEuler(){
const c=document.getElementById('ceuler'),ctx=c.getContext('2d');
const Pmax=+document.getElementById('eulerPmaxv').value||+document.getElementById('eulerPmax').value;
const target=document.getElementById('eulerTarget').value;
const viz=document.getElementById('eulerViz').value;
const mod=+document.getElementById('eulerMod').value||30;
const showRef=document.getElementById('eulerRef').checked;
const showError=document.getElementById('eulerError').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

// Generate primes
const primes=sievePrimes(Pmax);

// Target values
const targets={
pi:{s:2,exact:Math.PI,name:'œÄ',transform:z=>Math.sqrt(6*z)},
z2:{s:2,exact:Math.PI**2/6,name:'Œ∂(2)',transform:z=>z},
z4:{s:4,exact:Math.PI**4/90,name:'Œ∂(4)',transform:z=>z},
z6:{s:6,exact:Math.PI**6/945,name:'Œ∂(6)',transform:z=>z},
z8:{s:8,exact:1.00407735619794,name:'Œ∂(8)',transform:z=>z}};
const tgt=targets[target];
const s=tgt.s;

// Compute Euler product
const zeta=eulerProductPrimes(primes,s);
const computed=tgt.transform(zeta);
const error=Math.abs(computed-tgt.exact);
const relError=error/tgt.exact;

document.getElementById('eulerTargetDisp').textContent=tgt.name;
document.getElementById('eulerPmaxDisp').textContent=Pmax;

const pad=50,w=c.width-2*pad,h=c.height-2*pad;

// Gap-class analysis
const gapClasses={};
for(let i=0;i<primes.length-1;i++){
const gap=primes[i+1]-primes[i];
if(!gapClasses[gap])gapClasses[gap]=[];
gapClasses[gap].push(primes[i]);}

// Residue channel analysis
const channels={};
for(let a=1;a<mod;a++){
if(gcd(a,mod)===1)channels[a]=[];}
for(const p of primes){
const r=p%mod;
if(channels[r])channels[r].push(p);}

if(viz==='convergence'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Computing ${tgt.name} via Euler Product`,c.width/2,25);
// Convergence curve
const convData=[];
const step=Math.max(1,Math.floor(primes.length/60));
let prod=1;
for(let i=0;i<primes.length;i++){
prod*=1/(1-Math.pow(primes[i],-s));
if(i%step===0||i===primes.length-1){
const val=tgt.transform(prod);
convData.push({p:primes[i],val});}}
const maxP=primes[primes.length-1];
const minV=Math.min(...convData.map(d=>d.val))*0.999;
const maxV=Math.max(...convData.map(d=>d.val),tgt.exact)*1.001;
// Reference line
if(showRef){
ctx.strokeStyle='#ff006e';ctx.lineWidth=2;ctx.setLineDash([5,5]);
const yRef=pad+h*(1-(tgt.exact-minV)/(maxV-minV));
ctx.beginPath();ctx.moveTo(pad,yRef);ctx.lineTo(pad+w,yRef);ctx.stroke();ctx.setLineDash([]);
ctx.fillStyle='#ff006e';ctx.font='11px Arial';ctx.textAlign='left';
ctx.fillText(`${tgt.name} = ${tgt.exact.toFixed(10)}`,pad+5,yRef-5);}
// Convergence curve
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=2;
for(let i=0;i<convData.length;i++){
const x=pad+w*convData[i].p/maxP;
const y=pad+h*(1-(convData[i].val-minV)/(maxV-minV));
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

else if(viz==='contributions'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Individual Prime Contributions to Œ∂('+s+')',c.width/2,25);
const contribs=primes.slice(0,50).map(p=>({p,contrib:1/(1-Math.pow(p,-s))}));
const maxC=Math.max(...contribs.map(c=>c.contrib));
const barW=w/contribs.length-2;
for(let i=0;i<contribs.length;i++){
const barH=h*(contribs[i].contrib-1)/(maxC-1);
const x=pad+i*(barW+2);
const y=pad+h-barH;
ctx.fillStyle=`hsl(${i*7},70%,50%)`;
ctx.fillRect(x,y,barW,barH);}}

else if(viz==='gaps'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Gap-Class Decomposition: Œ∂(s) = ‚àè_g P_g(s)',c.width/2,25);
const gapArr=Object.entries(gapClasses).map(([g,ps])=>{
let prod=1;
for(const p of ps)prod*=1/(1-Math.pow(p,-s));
return {gap:+g,count:ps.length,prod};}).sort((a,b)=>a.gap-b.gap).slice(0,15);
const maxProd=Math.max(...gapArr.map(g=>g.prod));
const barW=w/gapArr.length-4;
for(let i=0;i<gapArr.length;i++){
const barH=h*Math.log(gapArr[i].prod)/Math.log(maxProd);
const x=pad+i*(barW+4);
const y=pad+h-barH;
ctx.fillStyle=`hsl(${gapArr[i].gap*20},70%,50%)`;
ctx.fillRect(x,y,barW,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';
ctx.fillText(`g=${gapArr[i].gap}`,x+barW/2,pad+h+12);}}

else if(viz==='residue'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Residue Channels mod ${mod} (œÜ(${mod})=${Object.keys(channels).length} channels)`,c.width/2,25);
const chanArr=Object.entries(channels).map(([a,ps])=>{
let prod=1;
for(const p of ps)prod*=1/(1-Math.pow(p,-s));
return {a:+a,count:ps.length,prod};}).sort((a,b)=>a.a-b.a);
const maxProd=Math.max(...chanArr.map(c=>c.prod));
const barW=w/chanArr.length-2;
for(let i=0;i<chanArr.length;i++){
const barH=h*Math.log(chanArr[i].prod)/Math.log(maxProd);
const x=pad+i*(barW+2);
const y=pad+h-barH;
ctx.fillStyle=`hsl(${chanArr[i].a*360/mod},70%,50%)`;
ctx.fillRect(x,y,barW,barH);
if(chanArr.length<=20){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='8px Arial';ctx.textAlign='center';
ctx.fillText(chanArr[i].a,x+barW/2,pad+h+10);}}}

// Charts
const zetaRef=[{k:2,val:Math.PI**2/6},{k:4,val:Math.PI**4/90},{k:6,val:Math.PI**6/945},{k:8,val:1.00407735619794}];
Plotly.newPlot('peulerZeta',[{x:zetaRef.map(z=>`Œ∂(${z.k})`),y:zetaRef.map(z=>z.val),type:'bar',marker:{color:['#00ff88','#00d9ff','#ffd700','#ff8c00']}}],{...plo(),yaxis:{title:'Value'}});

// Convergence chart
const convData=[];
let prod=1;
const step=Math.max(1,Math.floor(primes.length/40));
for(let i=0;i<primes.length;i++){
prod*=1/(1-Math.pow(primes[i],-s));
if(i%step===0||i===primes.length-1){
convData.push({p:primes[i],val:tgt.transform(prod)});}}
Plotly.newPlot('peulerConv',[
{x:convData.map(d=>d.p),y:convData.map(d=>d.val),mode:'lines',line:{color:'#00ff88'},name:'Computed'},
{x:[2,Pmax],y:[tgt.exact,tgt.exact],mode:'lines',line:{color:'#ff006e',dash:'dash'},name:'Exact'}
],{...plo(),xaxis:{title:'Prime'},yaxis:{title:tgt.name}});

// Error chart
const errData=convData.map(d=>({p:d.p,err:Math.abs(d.val-tgt.exact)}));
Plotly.newPlot('peulerErr',[{x:errData.map(d=>d.p),y:errData.map(d=>d.err),mode:'lines',line:{color:'#ff006e'}}],{...plo(),xaxis:{title:'Prime'},yaxis:{title:'|Error|',type:'log'}});

// Gap chart
const gapArr=Object.entries(gapClasses).map(([g,ps])=>({gap:+g,count:ps.length})).sort((a,b)=>a.gap-b.gap).slice(0,12);
Plotly.newPlot('peulerGap',[{x:gapArr.map(g=>`gap ${g.gap}`),y:gapArr.map(g=>g.count),type:'bar',marker:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'Gap'},yaxis:{title:'Primes'}});

// Residue chart
const chanArr=Object.entries(channels).map(([a,ps])=>({a:+a,count:ps.length})).sort((a,b)=>a.a-b.a);
Plotly.newPlot('peulerRes',[{x:chanArr.map(c=>`${c.a}`),y:chanArr.map(c=>c.count),type:'bar',marker:{color:chanArr.map(c=>`hsl(${c.a*360/mod},70%,50%)`)}}],{...plo(),xaxis:{title:`Residue mod ${mod}`},yaxis:{title:'Primes'}});

// Legend
legend('aleuler','Euler Product',[['Computed',computed.toFixed(12),'#00ff88'],['Exact',tgt.exact.toFixed(12),'#ff006e'],['Primes',primes.length,'#00d9ff']]);

eulerData={primes,product:zeta,computed,target:tgt.exact};

// Live stats
document.getElementById('eulerLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#00d9ff">${primes.length}</div><div style="font-size:.65rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#00ff88">${computed.toFixed(10)}</div><div style="font-size:.65rem;color:var(--txt2)">${tgt.name} COMPUTED</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ff006e">${tgt.exact.toFixed(10)}</div><div style="font-size:.65rem;color:var(--txt2)">${tgt.name} EXACT</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Accuracy Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Absolute Error:</span><span style="color:#ffd700">${error.toExponential(4)}</span>
<span>Relative Error:</span><span style="color:#9664ff">${(relError*100).toExponential(3)}%</span>
<span>Correct Digits:</span><span style="color:#00ff88">~${Math.max(0,-Math.floor(Math.log10(relError))).toFixed(0)}</span>
<span>Convergence Rate:</span><span style="color:#00d9ff">~1/P_max</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Euler Product Œ∂(${s})</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Œ∂(${s}) computed:</span><span style="color:#00d9ff">${zeta.toFixed(10)}</span>
<span>Largest prime:</span><span style="color:#ffd700">${primes[primes.length-1]}</span>
<span>Gap classes:</span><span style="color:#ff8c00">${Object.keys(gapClasses).length}</span>
<span>P_max / œÄ(P_max):</span><span style="color:#9664ff">${(primes[primes.length-1]/primes.length).toFixed(2)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Reference Zeta Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Œ∂(2) = œÄ¬≤/6:</span><span style="color:#00ff88">${(Math.PI*Math.PI/6).toFixed(8)}</span>
<span>Œ∂(4) = œÄ‚Å¥/90:</span><span style="color:#00d9ff">${(Math.pow(Math.PI,4)/90).toFixed(8)}</span>
<span>Œ∂(6) = œÄ‚Å∂/945:</span><span style="color:#ffd700">${(Math.pow(Math.PI,6)/945).toFixed(8)}</span>
<span>Œ∂(8) = œÄ‚Å∏/9450:</span><span style="color:#9664ff">${(Math.pow(Math.PI,8)/9450).toFixed(8)}</span>
</div>
</div>
<div style="background:rgba(0,255,136,.1);padding:8px;border-radius:6px;font-size:.75rem">
<strong style="color:#00ff88">Basel Problem (Euler 1734)</strong><br>
<span style="color:var(--txt2)">Œ∂(2) = 1+1/4+1/9+... = œÄ¬≤/6<br>œÄ = ‚àö(6¬∑‚àè<sub>p</sub>(1-p‚Åª¬≤)‚Åª¬π)</span>
</div>`;
}

function csvEuler(){
const primes=eulerData.primes;
const s=document.getElementById('eulerTarget').value==='pi'?2:+document.getElementById('eulerTarget').value.slice(1);
let csv='prime,index,1/(1-p^-s),cumulative_product\n';
let prod=1;
for(let i=0;i<primes.length;i++){
const factor=1/(1-Math.pow(primes[i],-s));
prod*=factor;
csv+=`${primes[i]},${i+1},${factor.toFixed(12)},${prod.toFixed(12)}\n`;}
dl(csv,'euler_product.csv');}

async function screenshotEuler(){
const Pmax=document.getElementById('eulerPmaxv').value;
await screenshotUnified('ceuler','eulerLiveStats',`Euler Product ‚Äî Primes ‚â§ ${Pmax}`,'euler_product.png',{dashH:350});
}

// Chord Length Uniformity Analysis
let chordData={results:[]};

function chordCV(n){
const coprimes=[];
for(let r=1;r<n;r++)if(gcd(r,n)===1)coprimes.push(r);
if(coprimes.length<2)return {cv:0,mean:0,stdDev:0,phi:coprimes.length,gapRatio:1,chords:[]};
const chords=[];
for(let i=0;i<coprimes.length;i++){
const r1=coprimes[i];
const r2=coprimes[(i+1)%coprimes.length];
const gap=(r2>r1)?(r2-r1):(r2+n-r1);
chords.push(2*Math.sin(Math.PI*gap/n));}
const mean=chords.reduce((a,b)=>a+b,0)/chords.length;
const variance=chords.reduce((a,b)=>a+(b-mean)**2,0)/chords.length;
const stdDev=Math.sqrt(variance);
const cv=mean>0?stdDev/mean:0;
const gapRatio=Math.max(...chords)/Math.min(...chords);
return {cv,mean,stdDev,phi:coprimes.length,gapRatio,chords};}

function drawChord(){
const c=document.getElementById('cchord'),ctx=c.getContext('2d');
const maxN=+document.getElementById('chordNv').value||+document.getElementById('chordN').value;
const viz=document.getElementById('chordViz').value;
const testN=+document.getElementById('chordTest').value||97;
const showThresh=document.getElementById('chordThresh').checked;
const showLabels=document.getElementById('chordLabels').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

// Compute CV for all n in range
const results=[];
let primeSum=0,primeCount=0,compSum=0,compCount=0;
for(let n=3;n<=maxN;n++){
const r=chordCV(n);
const prime=isPrime(n);
results.push({n,cv:r.cv,phi:r.phi,gapRatio:r.gapRatio,prime});
if(prime){primeSum+=r.cv;primeCount++;}
else{compSum+=r.cv;compCount++;}}
chordData.results=results;

const primeAvg=primeCount>0?primeSum/primeCount:0;
const compAvg=compCount>0?compSum/compCount:0;
const separation=compAvg>0?((compAvg-primeAvg)/compAvg*100):0;

const pad=50,w=c.width-2*pad,h=c.height-2*pad;
const threshold=0.22;

if(viz==='scatter'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Chord CV: Primes (green) vs Composites (red)',c.width/2,25);
const maxCV=Math.max(...results.map(r=>r.cv),0.5);
// Threshold line
if(showThresh){
ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.setLineDash([5,5]);
const yThresh=pad+h*(1-threshold/maxCV);
ctx.beginPath();ctx.moveTo(pad,yThresh);ctx.lineTo(pad+w,yThresh);ctx.stroke();ctx.setLineDash([]);
ctx.fillStyle='#ffd700';ctx.font='10px Arial';ctx.textAlign='left';
ctx.fillText('CV=0.22 threshold',pad+5,yThresh-5);}
// Plot points
for(const r of results){
const x=pad+w*(r.n-3)/(maxN-3);
const y=pad+h*(1-r.cv/maxCV);
ctx.fillStyle=r.prime?'#00ff88':'#ff4040';
ctx.beginPath();ctx.arc(x,y,3,0,2*Math.PI);ctx.fill();}
// Axes
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,pad+h);ctx.lineTo(pad+w,pad+h);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,pad+h);ctx.stroke();
ctx.fillStyle=isDark()?'#00d9ff':'#0066cc';ctx.font='11px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',pad+w/2,pad+h+25);
ctx.save();ctx.translate(15,pad+h/2);ctx.rotate(-Math.PI/2);ctx.fillText('CV',0,0);ctx.restore();}

else if(viz==='histogram'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('CV Distribution: Primes vs Composites',c.width/2,25);
const bins=20;
const primeBins=new Array(bins).fill(0);
const compBins=new Array(bins).fill(0);
for(const r of results){
const bin=Math.min(bins-1,Math.floor(r.cv*bins/0.6));
if(r.prime)primeBins[bin]++;else compBins[bin]++;}
const maxBin=Math.max(...primeBins,...compBins);
const barW=w/bins/2-2;
for(let i=0;i<bins;i++){
const x=pad+i*w/bins;
const ph=h*primeBins[i]/maxBin;
const ch=h*compBins[i]/maxBin;
ctx.fillStyle='#00ff88';ctx.fillRect(x,pad+h-ph,barW,ph);
ctx.fillStyle='#ff4040';ctx.fillRect(x+barW+2,pad+h-ch,barW,ch);}
// Labels
ctx.fillStyle=isDark()?'#888':'#666';ctx.font='9px Arial';ctx.textAlign='center';
for(let i=0;i<=bins;i+=5){
ctx.fillText((i*0.6/bins).toFixed(2),pad+i*w/bins,pad+h+12);}}

else if(viz==='separation'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Separation Growth by Range',c.width/2,25);
const ranges=[50,100,200,300,400,500,maxN].filter(r=>r<=maxN);
const sepData=[];
for(const rng of ranges){
let ps=0,pc=0,cs=0,cc=0;
for(const r of results){
if(r.n>rng)continue;
if(r.prime){ps+=r.cv;pc++;}else{cs+=r.cv;cc++;}}
const pa=pc>0?ps/pc:0;
const ca=cc>0?cs/cc:0;
sepData.push({rng,sep:ca>0?(ca-pa)/ca*100:0,primeAvg:pa,compAvg:ca});}
const maxSep=Math.max(...sepData.map(d=>d.sep),80);
ctx.beginPath();ctx.strokeStyle='#00ff88';ctx.lineWidth=3;
for(let i=0;i<sepData.length;i++){
const x=pad+w*i/(sepData.length-1);
const y=pad+h*(1-sepData[i].sep/maxSep);
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();
// Points with labels
for(let i=0;i<sepData.length;i++){
const x=pad+w*i/(sepData.length-1);
const y=pad+h*(1-sepData[i].sep/maxSep);
ctx.fillStyle='#00ff88';ctx.beginPath();ctx.arc(x,y,6,0,2*Math.PI);ctx.fill();
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(sepData[i].sep.toFixed(1)+'%',x,y-12);
ctx.fillText('n‚â§'+sepData[i].rng,x,pad+h+15);}}

else if(viz==='single'){
const r=chordCV(testN);
const prime=isPrime(testN);
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Chord Analysis for n=${testN} (${prime?'PRIME':'COMPOSITE'})`,c.width/2,25);
// Draw unit circle with coprime points
const cx=c.width/2,cy=c.height/2+20,rad=Math.min(w,h)/2-30;
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();
// Draw coprime points and chords
const coprimes=[];
for(let i=1;i<testN;i++)if(gcd(i,testN)===1)coprimes.push(i);
for(let i=0;i<coprimes.length;i++){
const angle=2*Math.PI*coprimes[i]/testN-Math.PI/2;
const x=cx+rad*Math.cos(angle);
const y=cy+rad*Math.sin(angle);
ctx.fillStyle='#00ff88';ctx.beginPath();ctx.arc(x,y,5,0,2*Math.PI);ctx.fill();
// Draw chord to next
const nextAngle=2*Math.PI*coprimes[(i+1)%coprimes.length]/testN-Math.PI/2;
const nx=cx+rad*Math.cos(nextAngle);
const ny=cy+rad*Math.sin(nextAngle);
ctx.strokeStyle='rgba(0,255,136,0.3)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(nx,ny);ctx.stroke();}
// Info
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';ctx.textAlign='left';
ctx.fillText(`œÜ(${testN}) = ${r.phi}`,pad,pad+h-60);
ctx.fillText(`CV = ${r.cv.toFixed(4)}`,pad,pad+h-40);
ctx.fillText(`Gap Ratio = ${r.gapRatio.toFixed(3)}`,pad,pad+h-20);
ctx.fillText(`Verdict: ${r.cv<0.22?'Likely Prime':'Likely Composite'}`,pad+200,pad+h-40);}

else if(viz==='compare'){
// Compare 2-3 moduli side by side
const n1=testN;
const n2=+document.getElementById('chordTest2').value||100;
const n3=+document.getElementById('chordTest3').value||0;
const nums=n3>2?[n1,n2,n3]:[n1,n2];
const cols=nums.length;
const cw=(c.width-pad*2)/cols-10;
const rad=Math.min(cw/2-20,(h-80)/2-20);

ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Comparing ${nums.length} Moduli: ${nums.join(' vs ')}`,c.width/2,20);

const colors=['#00ff88','#ff8c00','#00d9ff'];
const bgColors=['rgba(0,255,136,0.1)','rgba(255,140,0,0.1)','rgba(0,217,255,0.1)'];

nums.forEach((n,idx)=>{
const cv=chordCV(n);
const prime=isPrime(n);
const cx=pad+cw/2+idx*(cw+10)+5;
const cy=pad+rad+50;

// Background panel
ctx.fillStyle=bgColors[idx];
ctx.fillRect(pad+idx*(cw+10),pad+35,cw,h-45);

// Title
ctx.fillStyle=colors[idx];ctx.font='bold 13px Segoe UI';ctx.textAlign='center';
ctx.fillText(`n = ${n}`,cx,pad+52);
ctx.fillStyle=prime?'#00ff88':'#ff4040';ctx.font='11px Segoe UI';
ctx.fillText(prime?'PRIME':'COMPOSITE',cx,pad+68);

// Circle
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();

// Draw coprime points and chords
const coprimes=[];
for(let i=1;i<n;i++)if(gcd(i,n)===1)coprimes.push(i);
for(let i=0;i<coprimes.length;i++){
const angle=2*Math.PI*coprimes[i]/n-Math.PI/2;
const x=cx+rad*Math.cos(angle);
const y=cy+rad*Math.sin(angle);
ctx.fillStyle=colors[idx];ctx.beginPath();ctx.arc(x,y,3,0,2*Math.PI);ctx.fill();
// Chord to next
const nextAngle=2*Math.PI*coprimes[(i+1)%coprimes.length]/n-Math.PI/2;
const nx=cx+rad*Math.cos(nextAngle);
const ny=cy+rad*Math.sin(nextAngle);
ctx.strokeStyle=colors[idx].replace(')',',0.25)').replace('rgb','rgba');
ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(nx,ny);ctx.stroke();}

// Stats below circle
const statsY=cy+rad+20;
ctx.fillStyle=isDark()?'#e0e0e0':'#333';ctx.font='11px Segoe UI';ctx.textAlign='center';
ctx.fillText(`œÜ(${n}) = ${cv.phi}`,cx,statsY);
ctx.fillStyle=colors[idx];ctx.font='bold 12px Segoe UI';
ctx.fillText(`CV = ${cv.cv.toFixed(4)}`,cx,statsY+16);
ctx.fillStyle=isDark()?'#aaa':'#666';ctx.font='10px Segoe UI';
ctx.fillText(`Gap: ${cv.gapRatio.toFixed(2)}`,cx,statsY+30);
ctx.fillText(`Mean: ${cv.mean.toFixed(3)}`,cx,statsY+43);
ctx.fillText(`œÉ: ${cv.stdDev.toFixed(4)}`,cx,statsY+56);

// Verdict bar
const barY=statsY+68;
ctx.fillStyle=cv.cv<0.22?'rgba(0,255,136,0.3)':'rgba(255,64,64,0.3)';
ctx.fillRect(cx-cw/2+10,barY,cw-20,20);
ctx.fillStyle=cv.cv<0.22?'#00ff88':'#ff4040';ctx.font='bold 10px Segoe UI';
ctx.fillText(cv.cv<0.22?'LIKELY PRIME':'LIKELY COMPOSITE',cx,barY+14);
});

// Comparison summary at bottom
const summaryY=pad+h-25;
ctx.fillStyle=isDark()?'#888':'#666';ctx.font='10px Segoe UI';ctx.textAlign='center';
const cvs=nums.map(n=>chordCV(n).cv);
const minCV=Math.min(...cvs);
const winner=nums[cvs.indexOf(minCV)];
ctx.fillText(`Lowest CV: n=${winner} (${minCV.toFixed(4)}) ‚Äî Most uniform distribution`,c.width/2,summaryY);}

// Charts
const primeResults=results.filter(r=>r.prime);
const compResults=results.filter(r=>!r.prime);
Plotly.newPlot('pchordDist',[
{x:primeResults.map(r=>r.cv),type:'histogram',name:'Primes',marker:{color:'#00ff88'},opacity:0.7,nbinsx:20},
{x:compResults.map(r=>r.cv),type:'histogram',name:'Composites',marker:{color:'#ff4040'},opacity:0.7,nbinsx:20}
],{...plo(),barmode:'overlay',xaxis:{title:'CV'},yaxis:{title:'Count'}});

// Separation chart
const sepRanges=[50,100,150,200,300,400,500].filter(r=>r<=maxN);
const sepVals=sepRanges.map(rng=>{
let ps=0,pc=0,cs=0,cc=0;
for(const r of results){if(r.n>rng)continue;if(r.prime){ps+=r.cv;pc++;}else{cs+=r.cv;cc++;}}
const pa=pc>0?ps/pc:0,ca=cc>0?cs/cc:0;
return ca>0?(ca-pa)/ca*100:0;});
Plotly.newPlot('pchordSep',[{x:sepRanges.map(r=>'‚â§'+r),y:sepVals,type:'bar',marker:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'Range'},yaxis:{title:'Separation %'}});

// Average CV
Plotly.newPlot('pchordAvg',[{x:['Primes','Composites'],y:[primeAvg,compAvg],type:'bar',marker:{color:['#00ff88','#ff4040']}}],{...plo(),yaxis:{title:'Average CV'}});

// Legend
const testR=chordCV(testN);
legend('alchord','Analysis',[['Prime Avg CV',primeAvg.toFixed(4),'#00ff88'],['Comp Avg CV',compAvg.toFixed(4),'#ff4040'],['Separation',separation.toFixed(1)+'%','#00d9ff']]);

// Live stats
document.getElementById('chordLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${maxN}</div><div style="font-size:.65rem;color:var(--txt2)">MAX N</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${primeCount}</div><div style="font-size:.65rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff4040">${compCount}</div><div style="font-size:.65rem;color:var(--txt2)">COMPOSITES</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">CV Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Prime Avg CV:</span><span style="color:#00ff88">${primeAvg.toFixed(4)}</span>
<span>Composite Avg CV:</span><span style="color:#ff4040">${compAvg.toFixed(4)}</span>
<span>Separation:</span><span style="color:#00d9ff;font-weight:bold">${separation.toFixed(1)}%</span>
<span>Threshold:</span><span style="color:#ffd700">CV < 0.22</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Classification Accuracy</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>True Positive:</span><span style="color:#00ff88">${results.filter(r=>r.prime&&r.cv<0.22).length}</span>
<span>True Negative:</span><span style="color:#00ff88">${results.filter(r=>!r.prime&&r.cv>=0.22).length}</span>
<span>False Positive:</span><span style="color:#ff6496">${results.filter(r=>!r.prime&&r.cv<0.22).length}</span>
<span>False Negative:</span><span style="color:#ff6496">${results.filter(r=>r.prime&&r.cv>=0.22).length}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Test n = ${testN}</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.75rem">
<span>Type:</span><span style="color:${isPrime(testN)?'#00ff88':'#ff4040'}">${isPrime(testN)?'Prime':'Composite'}</span>
<span>œÜ(n):</span><span style="color:#ffd700">${testR.phi}</span>
<span>CV:</span><span style="color:#00d9ff">${testR.cv.toFixed(4)}</span>
<span>Gap Ratio:</span><span style="color:#9664ff">${testR.gapRatio.toFixed(3)}</span>
</div>
</div>
<div style="background:${testR.cv<0.22?'rgba(0,255,136,.15)':'rgba(255,64,64,.15)'};padding:8px;border-radius:6px;font-size:.8rem">
<strong style="color:${testR.cv<0.22?'#00ff88':'#ff4040'}">Verdict: ${testR.cv<0.22?'Likely Prime':'Likely Composite'}</strong>
</div>`;

// Table
const tableData=results.slice(0,60).map(r=>({...r,verdict:r.cv<0.22?'Prime?':'Comp?'}));
document.getElementById('tchordT').innerHTML='<tr><th>n</th><th>Type</th><th>œÜ(n)</th><th>CV</th><th>Gap Ratio</th><th>Verdict</th></tr>'+
tableData.map(r=>`<tr onclick="document.getElementById('chordTest').value=${r.n};drawChord()" style="cursor:pointer;color:${r.prime?'#00ff88':'#ff4040'}"><td>${r.n}</td><td>${r.prime?'Prime':'Comp'}</td><td>${r.phi}</td><td>${r.cv.toFixed(4)}</td><td>${r.gapRatio.toFixed(2)}</td><td>${r.verdict}</td></tr>`).join('');

// Click handler for scatter plot
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);

if(viz==='scatter'){
const maxCV=Math.max(...results.map(r=>r.cv),0.5);
for(const r of results){
const x=pad+w*(r.n-3)/(maxN-3);
const y=pad+h*(1-r.cv/maxCV);
if(Math.hypot(mx-x,my-y)<8){
const cv=chordCV(r.n);
modal('Chord Analysis n='+r.n,[
['n',r.n],
['Type',r.prime?'Prime':'Composite'],
['œÜ(n)',cv.phi],
['CV (œÉ/Œº)',cv.cv.toFixed(6)],
['Mean Chord',cv.mean.toFixed(6)],
['Std Dev',cv.stdDev.toFixed(6)],
['Gap Ratio',cv.gapRatio.toFixed(4)],
['Chord Count',cv.chords.length],
['Min Chord',Math.min(...cv.chords).toFixed(4)],
['Max Chord',Math.max(...cv.chords).toFixed(4)],
['CV Threshold','< 0.22 = Prime'],
['Verdict',cv.cv<0.22?'Likely Prime':'Likely Composite']
]);
document.getElementById('chordTest').value=r.n;
break;}}}

else if(viz==='single'){
// Click on single circle shows coprime details
const cx=c.width/2,cy=c.height/2+20,rad=Math.min(w,h)/2-30;
const coprimes=[];
for(let i=1;i<testN;i++)if(gcd(i,testN)===1)coprimes.push(i);
for(let i=0;i<coprimes.length;i++){
const angle=2*Math.PI*coprimes[i]/testN-Math.PI/2;
const px=cx+rad*Math.cos(angle);
const py=cy+rad*Math.sin(angle);
if(Math.hypot(mx-px,my-py)<10){
const r=coprimes[i];
const nextR=coprimes[(i+1)%coprimes.length];
const gap=(nextR>r)?(nextR-r):(nextR+testN-r);
const chordLen=2*Math.sin(Math.PI*gap/testN);
modal(`Coprime r=${r} mod ${testN}`,[
['Residue r',r],
['Next coprime',nextR],
['Gap to next',gap],
['Chord length',chordLen.toFixed(6)],
['Angle Œ∏',(coprimes[i]/testN*360).toFixed(2)+'¬∞'],
['r/n',fmt(r/testN)],
['gcd(r,n)',gcd(r,testN)]
]);
break;}}}

else if(viz==='compare'){
// Click on compare circles
const n1=testN;
const n2=+document.getElementById('chordTest2').value||100;
const n3=+document.getElementById('chordTest3').value||0;
const nums=n3>2?[n1,n2,n3]:[n1,n2];
const cols=nums.length;
const cw=(c.width-pad*2)/cols-10;
const rad=Math.min(cw/2-20,(h-80)/2-20);

for(let idx=0;idx<nums.length;idx++){
const n=nums[idx];
const cx=pad+cw/2+idx*(cw+10)+5;
const cy=pad+rad+50;
if(Math.hypot(mx-cx,my-cy)<rad+20){
const cv=chordCV(n);
modal(`Chord Analysis n=${n}`,[
['n',n],
['Type',isPrime(n)?'Prime':'Composite'],
['œÜ(n)',cv.phi],
['CV (œÉ/Œº)',cv.cv.toFixed(6)],
['Mean Chord',cv.mean.toFixed(6)],
['Std Dev',cv.stdDev.toFixed(6)],
['Gap Ratio',cv.gapRatio.toFixed(4)],
['Chord Count',cv.chords.length],
['Verdict',cv.cv<0.22?'Likely Prime':'Likely Composite']
]);
break;}}}};}

function csvChord(){
let csv='n,type,phi,cv,gap_ratio,verdict\n';
for(const r of chordData.results){
csv+=`${r.n},${r.prime?'prime':'composite'},${r.phi},${r.cv.toFixed(6)},${r.gapRatio.toFixed(4)},${r.cv<0.22?'likely_prime':'likely_composite'}\n`;}
dl(csv,'chord_uniformity.csv');}

async function screenshotChord(){
const maxN=document.getElementById('chordNv').value;
await screenshotUnified('cchord','chordLiveStats',`Chord Uniformity ‚Äî n ‚â§ ${maxN}`,'chord_uniformity.png',{dashH:350});
}

// ==================== GOLDBACH CONJECTURE ====================
let goldbachData={partitions:[],maxN:0};

function goldbachPartitions(n){
if(n<4||n%2!==0)return[];
const primes=sievePrimes(n);
const primeSet=new Set(primes);
const parts=[];
for(let i=0;i<primes.length&&primes[i]<=n/2;i++){
const p=primes[i],q=n-p;
if(primeSet.has(q))parts.push({p,q,diff:q-p});}
return parts;}

function drawGoldbach(){
const c=document.getElementById('cgold'),ctx=c.getContext('2d');
const maxN=+document.getElementById('goldNv').value||+document.getElementById('goldN').value;
const testN=+document.getElementById('goldTest').value;
const viz=document.getElementById('goldViz').value;
const col=document.getElementById('goldCol').value;
const ptSz=+document.getElementById('goldPtSz').value;
const showGrid=document.getElementById('goldGrid').checked;
const showTrend=document.getElementById('goldTrend').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const results=[];
let maxCount=0,totalParts=0;
for(let n=4;n<=maxN;n+=2){
const parts=goldbachPartitions(n);
const count=parts.length;
const minP=parts.length>0?Math.min(...parts.map(p=>p.p)):0;
const maxGap=parts.length>0?Math.max(...parts.map(p=>p.diff)):0;
results.push({n,count,parts,minP,maxGap});
maxCount=Math.max(maxCount,count);
totalParts+=count;}
goldbachData={partitions:results,maxN};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='comet'||viz==='partitions'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Goldbach Comet ‚Äî Partition Count G(n)',c.width/2,30);

if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='right';ctx.fillText(Math.round(maxCount*i/5),pad-5,y+3);}
for(let i=0;i<=5;i++){const x=pad+i*w/5;ctx.beginPath();ctx.moveTo(x,pad);ctx.lineTo(x,pad+h);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='center';ctx.fillText(Math.round(4+i*(maxN-4)/5),x,pad+h+15);}}

for(const r of results){
const x=pad+w*(r.n-4)/(maxN-4);
const y=pad+h-h*r.count/maxCount;
let clr;
if(col==='count')clr=`hsl(${120-r.count/maxCount*120},80%,50%)`;
else if(col==='minPrime')clr=`hsl(${r.minP/r.n*240},80%,50%)`;
else if(col==='maxGap')clr=`hsl(${r.maxGap/(r.n/2)*120},80%,50%)`;
else clr='#00d9ff';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();}

if(showTrend){
ctx.strokeStyle='rgba(255,136,0,0.6)';ctx.lineWidth=2;ctx.beginPath();
for(let i=0;i<results.length;i++){
const r=results[i];
const expectedG=r.n>10?2*0.6601*r.n/Math.pow(Math.log(r.n),2):r.count;
const x=pad+w*(r.n-4)/(maxN-4);
const y=pad+h-h*Math.min(expectedG,maxCount)/maxCount;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}}

else if(viz==='single'){
const tn=testN%2===0?testN:testN+1;
const parts=goldbachPartitions(tn);
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Goldbach Partitions of ${tn} ‚Äî ${parts.length} ways`,c.width/2,30);
const cx=c.width/2,cy=c.height/2,rad=Math.min(w,h)/2-20;
ctx.strokeStyle=bordC();ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,rad,0,2*Math.PI);ctx.stroke();
for(let i=0;i<parts.length;i++){
const {p,q}=parts[i];
const angP=2*Math.PI*p/tn-Math.PI/2,angQ=2*Math.PI*q/tn-Math.PI/2;
const px=cx+rad*Math.cos(angP),py=cy+rad*Math.sin(angP);
const qx=cx+rad*Math.cos(angQ),qy=cy+rad*Math.sin(angQ);
ctx.strokeStyle=`hsl(${i*360/parts.length},80%,50%)`;ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(qx,qy);ctx.stroke();
ctx.fillStyle=`hsl(${i*360/parts.length},80%,50%)`;
ctx.beginPath();ctx.arc(px,py,5,0,2*Math.PI);ctx.fill();
ctx.beginPath();ctx.arc(qx,qy,5,0,2*Math.PI);ctx.fill();
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText(p,px,py-10);ctx.fillText(q,qx,qy-10);}}

else if(viz==='heatmap'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Goldbach Heatmap ‚Äî p + q = n',c.width/2,30);
const primes=sievePrimes(maxN);
const cellW=w/primes.length,cellH=h/primes.length;
for(let i=0;i<primes.length&&i<100;i++){
for(let j=i;j<primes.length&&j<100;j++){
const n=primes[i]+primes[j];
if(n<=maxN&&n%2===0){
const intensity=n/maxN;
ctx.fillStyle=`hsl(${240-intensity*240},70%,${30+intensity*40}%)`;
ctx.fillRect(pad+i*cellW,pad+j*cellH,cellW,cellH);}}}}

const testParts=goldbachPartitions(testN%2===0?testN:testN+1);
const avgCount=results.length>0?totalParts/results.length:0;
const maxCountN=results.reduce((a,r)=>r.count>a.count?r:a,{count:0,n:0});
const minCountN=results.filter(r=>r.count>0).reduce((a,r)=>r.count<a.count?r:a,{count:Infinity,n:0});
const zeros=results.filter(r=>r.count===0).length;

legend('algold1','Goldbach Analysis',[['Max G(n)',maxCount+' at n='+maxCountN.n,'#00ff88'],['Avg G(n)',fmt(avgCount),'#ffd700']]);
legend('algold2','Test n='+(testN%2===0?testN:testN+1),[['Partitions',testParts.length,'#00d9ff'],['Min Prime',testParts[0]?.p||0,'#9664ff']]);

Plotly.newPlot('pgold',[{x:results.map(r=>r.n),y:results.map(r=>r.count),type:'scatter',mode:'markers',marker:{size:3,color:results.map(r=>`hsl(${120-r.count/maxCount*120},80%,50%)`)}}],{...plo(),xaxis:{title:'n'},yaxis:{title:'G(n)'}});

document.getElementById('goldLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Goldbach Conjecture | FIELD: ‚Ñ§ (Even) | TYPE: Prime Sum Partitions</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max N: <strong style="color:#00d9ff">${maxN}</strong></span>
<span>Test n: <strong style="color:#ffd700">${testN}</strong></span>
<span>Mode: <strong style="color:#00ff88">${vizMode}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${results.length}</div><div style="font-size:.7rem;color:var(--txt2)">EVEN NUMBERS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${totalParts}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL PARTITIONS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${zeros}</div><div style="font-size:.7rem;color:var(--txt2)">COUNTEREXAMPLES</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${maxCount}</div><div style="font-size:.6rem;color:var(--txt2)">MAX G(n) at ${maxCountN.n}</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff8c00">${fmt(avgCount)}</div><div style="font-size:.6rem;color:var(--txt2)">AVG PARTITIONS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Partition Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max G(n):</span><span style="color:#00ff88">${maxCount} at n=${maxCountN.n}</span>
<span>Min G(n):</span><span style="color:#ff6496">${minCountN.count} at n=${minCountN.n}</span>
<span>Average G(n):</span><span style="color:#ffd700">${fmt(avgCount)}</span>
<span>Total pairs:</span><span style="color:#00d9ff">${totalParts}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Hardy-Littlewood Prediction</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Twin Prime Constant C‚ÇÇ:</span><span style="color:#9664ff">0.6601618...</span>
<span>G(n) ~ 2C‚ÇÇ¬∑n/(ln n)¬≤:</span><span style="color:#ff8c00">${fmt(2*0.6601*maxN/Math.pow(Math.log(maxN),2))}</span>
<span>Actual at n=${maxN}:</span><span style="color:#00ff88">${results[results.length-1]?.count||0}</span>
</div>
</div>
<div style="background:${zeros===0?'rgba(0,255,136,.15)':'rgba(255,64,64,.15)'};padding:8px;border-radius:6px;font-size:.8rem">
<strong style="color:${zeros===0?'#00ff88':'#ff4040'}">${zeros===0?'‚úì Goldbach verified for all n ‚â§ '+maxN:'‚úó Found '+zeros+' counterexamples!'}</strong>
</div>`;

document.getElementById('tgoldT').innerHTML='<tr><th>n</th><th>G(n)</th><th>Min p</th><th>Max Gap</th><th>First Partition</th></tr>'+
results.slice(0,100).map(r=>`<tr onclick="document.getElementById('goldTest').value=${r.n};document.getElementById('goldViz').value='single';drawGoldbach()" style="cursor:pointer;color:${r.count===0?'#ff4040':r.count>10?'#00ff88':'inherit'}"><td>${r.n}</td><td>${r.count}</td><td>${r.minP}</td><td>${r.maxGap}</td><td>${r.parts[0]?r.parts[0].p+'+'+r.parts[0].q:'‚Äî'}</td></tr>`).join('');}

function csvGoldbach(){let s='n,partition_count,min_prime,max_gap,partitions\n';for(const r of goldbachData.partitions)s+=`${r.n},${r.count},${r.minP},${r.maxGap},"${r.parts.map(p=>p.p+'+'+p.q).join('; ')}"\n`;dl(s,'goldbach.csv');}
function expGoldbach(){const c=document.getElementById('cgold');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='goldbach.png';a.click();});}

async function screenshotGoldbach(){
const c=document.getElementById('cgold'),dashData=extractDashboardData('goldLiveStats');
const maxN=document.getElementById('goldNv').value;
const scale=2,pad=30,dashH=350;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Goldbach Conjecture ‚Äî n ‚â§ ${maxN}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='goldbach_complete.png';a.click();},'image/png',1.0);}

// ==================== PRIME GAPS ====================
let gapData={gaps:[],records:[]};

function drawGap(){
const c=document.getElementById('cgap'),ctx=c.getContext('2d');
const maxN=+document.getElementById('gapNv').value||+document.getElementById('gapN').value;
const viz=document.getElementById('gapViz').value;
const col=document.getElementById('gapCol').value;
const ptSz=+document.getElementById('gapPtSz').value;
const showGrid=document.getElementById('gapGrid').checked;
const showCram√©r=document.getElementById('gapCram√©r').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const primes=sievePrimes(maxN);
const gaps=[],records=[];
let maxGap=0,sumGap=0,recordGap=0;
const gapFreq={};
for(let i=1;i<primes.length;i++){
const g=primes[i]-primes[i-1];
const cram√©r=Math.pow(Math.log(primes[i]),2);
const ratio=g/Math.log(primes[i]);
gaps.push({p:primes[i-1],pNext:primes[i],gap:g,cram√©r,ratio,isRecord:g>recordGap});
if(g>recordGap){recordGap=g;records.push({p:primes[i-1],gap:g,ratio});}
maxGap=Math.max(maxGap,g);
sumGap+=g;
gapFreq[g]=(gapFreq[g]||0)+1;}
gapData={gaps,records,primes};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='scatter'||viz==='ratio'){
const isRatio=viz==='ratio';
const maxY=isRatio?Math.max(...gaps.map(g=>g.ratio)):maxGap;
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(isRatio?'Prime Gap Ratio g/ln(p)':'Prime Gaps g = p_{n+1} - p_n',c.width/2,30);

if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();
ctx.fillStyle=isDark()?'#666':'#999';ctx.font='10px Arial';ctx.textAlign='right';ctx.fillText(fmt(maxY*i/5),pad-5,y+3);}}

if(showCram√©r&&!isRatio){
ctx.strokeStyle='rgba(255,136,0,0.5)';ctx.lineWidth=2;ctx.beginPath();
for(let i=0;i<gaps.length;i+=Math.max(1,Math.floor(gaps.length/500))){
const x=pad+w*i/gaps.length;
const cram√©r=Math.pow(Math.log(gaps[i].p),2);
const y=pad+h-h*Math.min(cram√©r,maxY)/maxY;
if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}
ctx.stroke();}

for(let i=0;i<gaps.length;i++){
const g=gaps[i];
const x=pad+w*i/gaps.length;
const yVal=isRatio?g.ratio:g.gap;
const y=pad+h-h*yVal/maxY;
let clr;
if(col==='gap')clr=`hsl(${240-g.gap/maxGap*240},80%,50%)`;
else if(col==='record')clr=g.isRecord?'#ff006e':'#00d9ff';
else if(col==='cram√©r')clr=g.gap>g.cram√©r?'#ff4040':'#00ff88';
else clr='#00d9ff';
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,g.isRecord?ptSz+2:ptSz,0,2*Math.PI);ctx.fill();}}

else if(viz==='histogram'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Prime Gap Distribution',c.width/2,30);
const gapKeys=Object.keys(gapFreq).map(Number).sort((a,b)=>a-b);
const maxFreq=Math.max(...Object.values(gapFreq));
const barW=w/gapKeys.length;
for(let i=0;i<gapKeys.length;i++){
const g=gapKeys[i],f=gapFreq[g];
const x=pad+i*barW,barH=h*f/maxFreq;
ctx.fillStyle=g===2?'#ffd700':`hsl(${g*10},70%,50%)`;
ctx.fillRect(x,pad+h-barH,barW-1,barH);}}

else if(viz==='records'){
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText('Record Prime Gaps',c.width/2,30);
const maxRecGap=records.length>0?Math.max(...records.map(r=>r.gap)):1;
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();}}
for(let i=0;i<records.length;i++){
const r=records[i];
const x=pad+w*Math.log(r.p)/Math.log(primes[primes.length-1]);
const y=pad+h-h*r.gap/maxRecGap;
ctx.fillStyle='#ff006e';ctx.beginPath();ctx.arc(x,y,5,0,2*Math.PI);ctx.fill();
if(i<20){ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='9px Arial';ctx.textAlign='center';ctx.fillText(r.gap,x,y-8);}}}

const avgGap=gaps.length>0?sumGap/gaps.length:0;
const gap2Count=gapFreq[2]||0;
const mostCommon=Object.entries(gapFreq).sort((a,b)=>b[1]-a[1])[0];

legend('algap1','Gap Statistics',[['Max Gap',maxGap,'#ff006e'],['Avg Gap',fmt(avgGap),'#00d9ff']]);
legend('algap2','Distribution',[['Gap=2 (twins)',gap2Count,'#ffd700'],['Records',records.length,'#9664ff']]);

const gapKeys=Object.keys(gapFreq).map(Number).sort((a,b)=>a-b).slice(0,30);
Plotly.newPlot('pgap',[{x:gapKeys,y:gapKeys.map(g=>gapFreq[g]),type:'bar',marker:{color:gapKeys.map(g=>g===2?'#ffd700':`hsl(${g*10},70%,50%)`)}}],{...plo(),xaxis:{title:'Gap'},yaxis:{title:'Frequency'}});

document.getElementById('gapLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${primes.length}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff006e">${maxGap}</div><div style="font-size:.7rem;color:var(--txt2)">MAX GAP</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${records.length}</div><div style="font-size:.7rem;color:var(--txt2)">RECORDS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Gap Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Average gap:</span><span style="color:#00d9ff">${fmt(avgGap)}</span>
<span>ln(N):</span><span style="color:#9664ff">${fmt(Math.log(maxN))}</span>
<span>Gap=2 (twins):</span><span style="color:#ffd700">${gap2Count}</span>
<span>Most common:</span><span style="color:#00ff88">${mostCommon?mostCommon[0]+' ('+mostCommon[1]+'√ó)':'-'}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Cram√©r Analysis</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Cram√©r bound (ln N)¬≤:</span><span style="color:#ff8c00">${fmt(Math.pow(Math.log(maxN),2))}</span>
<span>Max/Cram√©r ratio:</span><span style="color:${maxGap<Math.pow(Math.log(maxN),2)?'#00ff88':'#ff4040'}">${fmt(maxGap/Math.pow(Math.log(maxN),2))}</span>
<span>Gaps exceeding Cram√©r:</span><span style="color:#ff6496">${gaps.filter(g=>g.gap>g.cram√©r).length}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">First Record Gaps</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:5px">
${records.slice(0,8).map(r=>`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:#ff006e;color:#fff;font-weight:bold">g=${r.gap} at p=${r.p}</span>`).join('')}
</div>
</div>`;

document.getElementById('tgapT').innerHTML='<tr><th>p</th><th>Gap</th><th>p+gap</th><th>g/ln(p)</th><th>Record?</th></tr>'+
records.slice(0,50).map(r=>`<tr style="color:#ff006e"><td>${r.p}</td><td>${r.gap}</td><td>${r.p+r.gap}</td><td>${fmt(r.ratio)}</td><td>‚úì</td></tr>`).join('');}

function csvGap(){let s='p,gap,p_next,ratio,is_record\n';for(const g of gapData.gaps)s+=`${g.p},${g.gap},${g.pNext},${g.ratio},${g.isRecord}\n`;dl(s,'prime_gaps.csv');}
function expGap(){const c=document.getElementById('cgap');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='prime_gaps.png';a.click();});}

async function screenshotGap(){
const c=document.getElementById('cgap'),dashData=extractDashboardData('gapLiveStats');
const maxN=document.getElementById('gapNv').value;
const scale=2,pad=30,dashH=380;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Prime Gaps ‚Äî N ‚â§ ${maxN}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='prime_gaps_complete.png';a.click();},'image/png',1.0);}

// ==================== SOPHIE GERMAIN PRIMES ====================
let sophieData={primes:[],pairs:[]};

function isSophieGermain(p,primeSet){return primeSet.has(p)&&primeSet.has(2*p+1);}
function isSafePrime(p,primeSet){return primeSet.has(p)&&p>2&&(p-1)/2>0&&primeSet.has((p-1)/2);}

function cunninghamChain(p,primeSet,type){
const chain=[p];
let curr=p;
while(true){
const next=type===1?2*curr+1:2*curr-1;
if(!primeSet.has(next))break;
chain.push(next);
curr=next;}
return chain;}

function drawSophie(){
const c=document.getElementById('csoph'),ctx=c.getContext('2d');
const maxN=+document.getElementById('sophNv').value||+document.getElementById('sophN').value;
const type=document.getElementById('sophType').value;
const viz=document.getElementById('sophViz').value;
const ptSz=+document.getElementById('sophPtSz').value;
const showGrid=document.getElementById('sophGrid').checked;
const showPairs=document.getElementById('sophPairs').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const primes=sievePrimes(maxN*2+1);
const primeSet=new Set(primes);
const results=[];
let maxChain=0;

if(type==='sophie'){
for(const p of primes){
if(p<=maxN&&isSophieGermain(p,primeSet)){
results.push({p,q:2*p+1,type:'sophie'});}}}
else if(type==='safe'){
for(const p of primes){
if(p<=maxN&&isSafePrime(p,primeSet)){
results.push({p,q:(p-1)/2,type:'safe'});}}}
else if(type==='cunningham1'||type==='cunningham2'){
const ctype=type==='cunningham1'?1:2;
const seen=new Set();
for(const p of primes){
if(p<=maxN&&!seen.has(p)){
const chain=cunninghamChain(p,primeSet,ctype);
if(chain.length>=2){
chain.forEach(x=>seen.add(x));
results.push({p,chain,len:chain.length,type});
maxChain=Math.max(maxChain,chain.length);}}}}
sophieData={primes:results,type,maxN};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;
const typeLabel=type==='sophie'?'Sophie Germain Primes (p, 2p+1)':type==='safe'?'Safe Primes (2p+1 where p prime)':type==='cunningham1'?'Cunningham Chains (1st kind)':'Cunningham Chains (2nd kind)';

ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(typeLabel,c.width/2,30);

if(viz==='scatter'){
if(showGrid){ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=5;i++){const x=pad+i*w/5;ctx.beginPath();ctx.moveTo(x,pad);ctx.lineTo(x,pad+h);ctx.stroke();
const y=pad+h-i*h/5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(pad+w,y);ctx.stroke();}}

if(type==='sophie'||type==='safe'){
const maxP=results.length>0?Math.max(...results.map(r=>r.p)):maxN;
const maxQ=results.length>0?Math.max(...results.map(r=>r.q)):maxN;
for(const r of results){
const x=pad+w*r.p/maxP;
const y=pad+h-h*r.q/maxQ;
if(showPairs){ctx.strokeStyle='rgba(150,100,255,0.3)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(pad+w*r.q/maxP,pad+h-h*r.p/maxQ);ctx.stroke();}
ctx.fillStyle=type==='sophie'?'#00ff88':'#ff8c00';
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();}}
else{
for(const r of results){
const clr=`hsl(${r.len*60},80%,50%)`;
for(let i=0;i<r.chain.length;i++){
const x=pad+w*r.chain[i]/maxN;
const y=pad+h-h*r.len/maxChain;
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(x,y,ptSz+i,0,2*Math.PI);ctx.fill();}}}}

else if(viz==='density'){
const binSize=Math.ceil(maxN/50);
const bins=[];
for(let i=0;i<50;i++){
const lo=i*binSize,hi=(i+1)*binSize;
const count=results.filter(r=>r.p>=lo&&r.p<hi).length;
bins.push({lo,hi,count});}
const maxBin=Math.max(...bins.map(b=>b.count));
for(let i=0;i<bins.length;i++){
const barH=h*bins[i].count/maxBin;
ctx.fillStyle=`hsl(${120-bins[i].count/maxBin*120},70%,50%)`;
ctx.fillRect(pad+i*w/50,pad+h-barH,w/50-1,barH);}}

else if(viz==='chains'&&(type==='cunningham1'||type==='cunningham2')){
const chainLens={};
for(const r of results){chainLens[r.len]=(chainLens[r.len]||0)+1;}
const lenKeys=Object.keys(chainLens).map(Number).sort((a,b)=>a-b);
const maxFreq=Math.max(...Object.values(chainLens));
const barW=w/lenKeys.length;
for(let i=0;i<lenKeys.length;i++){
const len=lenKeys[i],f=chainLens[len];
ctx.fillStyle=`hsl(${len*60},70%,50%)`;
const barH=h*f/maxFreq;
ctx.fillRect(pad+i*barW,pad+h-barH,barW-2,barH);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Arial';ctx.textAlign='center';
ctx.fillText('len='+len,pad+i*barW+barW/2,pad+h+15);}}

const density=results.length/maxN;
const expected=maxN>100?1.32*maxN/Math.pow(Math.log(maxN),2):results.length;

legend('alsoph1',typeLabel,[['Count',results.length,'#00ff88'],['Density',fmt(density*100)+'%','#ffd700']]);
legend('alsoph2','Analysis',[['Expected ~',fmt(expected),'#9664ff'],['Largest',results[results.length-1]?.p||0,'#00d9ff']]);

const dist=[];
for(let i=0;i<Math.min(results.length,30);i++)dist.push(results[i].p);
Plotly.newPlot('psoph',[{x:dist,y:dist.map((_,i)=>i+1),type:'scatter',mode:'markers',marker:{size:6,color:'#00ff88'}}],{...plo(),xaxis:{title:'p'},yaxis:{title:'Index'}});

document.getElementById('sophLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${results.length}</div><div style="font-size:.7rem;color:var(--txt2)">${type.toUpperCase()}</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fmt(density*100)}%</div><div style="font-size:.7rem;color:var(--txt2)">DENSITY</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${results[results.length-1]?.p||0}</div><div style="font-size:.7rem;color:var(--txt2)">LARGEST</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Count:</span><span style="color:#00ff88">${results.length}</span>
<span>Expected ~C¬∑n/(ln n)¬≤:</span><span style="color:#9664ff">${fmt(expected)}</span>
<span>Ratio actual/expected:</span><span style="color:#ffd700">${fmt(results.length/expected)}</span>
<span>Smallest:</span><span style="color:#00d9ff">${results[0]?.p||0}</span>
</div>
</div>
${type.includes('cunningham')?`<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Chain Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:5px;font-size:.8rem">
<span>Max chain length:</span><span style="color:#ff006e">${maxChain}</span>
<span>Chains of length 2:</span><span style="color:#00d9ff">${results.filter(r=>r.len===2).length}</span>
<span>Chains of length 3+:</span><span style="color:#ffd700">${results.filter(r=>r.len>=3).length}</span>
</div>
</div>`:''}
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">First ${type==='sophie'?'Sophie Germain':type==='safe'?'Safe':'Cunningham'} Primes</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:5px">
${results.slice(0,10).map(r=>type.includes('cunningham')?`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:hsl(${r.len*60},70%,50%);color:#000;font-weight:bold">${r.chain.join('‚Üí')}</span>`:`<span style="display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;background:#00ff88;color:#000;font-weight:bold">${r.p}‚Üí${r.q}</span>`).join('')}
</div>
</div>`;

document.getElementById('tsophT').innerHTML='<tr><th>p</th><th>'+(type.includes('cunningham')?'Chain':'q=2p+1 or (p-1)/2')+'</th><th>'+(type.includes('cunningham')?'Length':'Type')+'</th></tr>'+
results.slice(0,80).map(r=>type.includes('cunningham')?`<tr style="color:hsl(${r.len*60},80%,50%)"><td>${r.p}</td><td>${r.chain.join('‚Üí')}</td><td>${r.len}</td></tr>`:`<tr style="color:#00ff88"><td>${r.p}</td><td>${r.q}</td><td>${type}</td></tr>`).join('');}

function csvSophie(){let s='p,'+(sophieData.type.includes('cunningham')?'chain,length':'q,type')+'\n';for(const r of sophieData.primes)s+=sophieData.type.includes('cunningham')?`${r.p},"${r.chain.join(',')}",${r.len}\n`:`${r.p},${r.q},${r.type}\n`;dl(s,'sophie_germain.csv');}
function expSophie(){const c=document.getElementById('csoph');c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='sophie_germain.png';a.click();});}

async function screenshotSophie(){
const c=document.getElementById('csoph'),dashData=extractDashboardData('sophLiveStats');
const maxN=document.getElementById('sophNv').value,type=document.getElementById('sophType').value;
const scale=2,pad=30,dashH=380;
const out=document.createElement('canvas');
out.width=(c.width+pad*2)*scale;out.height=(c.height+dashH+pad*3)*scale;
const ctx=out.getContext('2d');ctx.scale(scale,scale);
const isDk=isDark();
ctx.fillStyle=isDk?'#0d1321':'#ffffff';ctx.fillRect(0,0,out.width/scale,out.height/scale);
ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 18px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Sophie Germain Analysis ‚Äî N ‚â§ ${maxN}`,out.width/scale/2,pad);
ctx.drawImage(c,pad,pad+25,c.width,c.height);
const dashY=c.height+pad+45;
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(pad,dashY-10,c.width,dashH);
ctx.textAlign='left';
renderDashboard(ctx,dashData,pad+10,dashY,c.width-20,isDk);
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',out.width/scale/2,out.height/scale-10);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='sophie_germain_complete.png';a.click();},'image/png',1.0);}

async function screenshotMod(){
const viewMode=document.getElementById('modViewMode').value;
let title;
if(viewMode==='single'){
const M=document.getElementById('modSingleM').value;
title=`Modular Reduction Projection ‚Äî M=${M}`;
}else{
const minM=document.getElementById('modMin').value,maxM=document.getElementById('modMax').value;
title=`Modular Ring System Œ∏=2œÄr/M ‚Äî M=${minM}‚Üí${maxM}`;
}
await screenshotUnified('cmod','modLiveStats',title,'modular_rings_complete.png',{dashH:350,legend:'Gold = GCD(r,M)=1 ‚Äî Dirichlet Character Support œá(r)‚â†0'});
}

async function screenshot3D4K(){
const c=document.getElementById('c3d'),dashData=extractDashboardData('stats3dLive');
const res=+document.getElementById('ss3dRes').value||4,bg=document.getElementById('ss3dBg').value;
const showTitle=document.getElementById('ss3dTitle').checked,showLegend=document.getElementById('ss3dLegend').checked,showStats=document.getElementById('ss3dStats').checked;
const titleTxt=document.getElementById('ss3dTitleTxt').value||'3D Visualization';
const pad=60,titleH=showTitle?80:0,legendH=showLegend?80:0,statsH=showStats?250:0;
const out=document.createElement('canvas');out.width=c.width*res;out.height=(c.height+titleH+legendH+statsH+40)*res;
const ctx=out.getContext('2d');ctx.scale(res,res);
const isDk=bg!=='white';
if(bg==='black')ctx.fillStyle='#000';else if(bg==='white')ctx.fillStyle='#fff';else if(bg==='transparent')ctx.fillStyle='transparent';else ctx.fillStyle=canvBg();
ctx.fillRect(0,0,out.width/res,out.height/res);
let yOff=0;
if(showTitle){ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 24px Segoe UI';ctx.textAlign='center';ctx.fillText(titleTxt,c.width/2,pad);ctx.font='14px Segoe UI';ctx.fillStyle=isDk?'#aaa':'#666';ctx.fillText('By Wessen Getachew ¬∑ @7dview',c.width/2,pad+30);yOff=titleH;}
ctx.drawImage(c,0,yOff);yOff+=c.height+20;
if(showStats&&dashData.cards.length>0){
ctx.fillStyle=isDk?'#151b2d':'#f5f5f5';ctx.fillRect(20,yOff,c.width-40,statsH-20);
renderDashboard(ctx,dashData,30,yOff+15,c.width-60,isDk);yOff+=statsH;}
if(showLegend){ctx.fillStyle=isDk?'#00d9ff':'#0066cc';ctx.font='bold 14px Segoe UI';ctx.textAlign='left';ctx.fillText('Legend',pad,yOff+15);ctx.font='11px Segoe UI';const legs=[['GCD=1 (Primitive)','#ffd700'],['GCD=2','#00d9ff'],['GCD=3','#9664ff'],['GCD>3','#ff6496']];let lx=pad+70;legs.forEach(([txt,clr])=>{ctx.fillStyle=clr;ctx.fillRect(lx,yOff+5,12,12);ctx.fillStyle=isDk?'#e0e0ff':'#333';ctx.fillText(txt,lx+16,yOff+15);lx+=130;});}
ctx.fillStyle=isDk?'#506080':'#888';ctx.font='10px Segoe UI';ctx.textAlign='center';
ctx.fillText('M√∂bius Shell Sieve ‚Äî wessengetachew.github.io',c.width/2,out.height/res-15);
out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`mobius_3d_${res}x.png`;a.click();},'image/png',1.0);}

// ==================== MERTENS FUNCTION M(x) ====================
let mertensData={values:[],maxX:0};

function computeMertens(maxX){
const mu=new Array(maxX+1).fill(1);
const sieve=new Array(maxX+1).fill(true);
// Compute M√∂bius function
for(let p=2;p<=maxX;p++){
if(sieve[p]){
for(let m=p;m<=maxX;m+=p){mu[m]*=-1;sieve[m]=false;}
for(let m=p*p;m<=maxX;m+=p*p)mu[m]=0;
for(let m=p;m<=maxX;m+=p)sieve[m]=true;
}}
// Compute cumulative M(x)
const M=new Array(maxX+1);
M[0]=0;
for(let n=1;n<=maxX;n++)M[n]=M[n-1]+mu[n];
return{mu,M};
}

function drawMertens(){
const c=document.getElementById('cmert'),ctx=c.getContext('2d');
const maxX=+document.getElementById('mertXv').value||+document.getElementById('mertX').value;
const viz=document.getElementById('mertViz').value;
const col=document.getElementById('mertCol').value;
const showSqrt=document.getElementById('mertBoundSqrt').checked;
const showRH=document.getElementById('mertBoundRH').checked;
const ptSz=+document.getElementById('mertPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const{mu,M}=computeMertens(maxX);
mertensData={mu,M,maxX};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;
const cx=pad,cy=c.height/2;

// Determine data range
let data,yMin,yMax,ylabel;
if(viz==='cumulative'||viz==='both'){
data=M.slice(1);
yMin=Math.min(...data);yMax=Math.max(...data);
ylabel='M(x)';
}else if(viz==='normalized'){
data=M.slice(1).map((m,i)=>m/Math.sqrt(i+1));
yMin=Math.min(...data);yMax=Math.max(...data);
ylabel='M(x)/‚àöx';
}else if(viz==='mobius'){
data=mu.slice(1);
yMin=-1.5;yMax=1.5;
ylabel='Œº(n)';
}else{
data=M.slice(1);
yMin=Math.min(...data);yMax=Math.max(...data);
ylabel='M(x)';
}

const margin=Math.abs(yMax-yMin)*0.1||1;
yMin-=margin;yMax+=margin;
const scX=w/maxX,scY=h/(yMax-yMin);

// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
const gx=pad+i*w/10;
ctx.beginPath();ctx.moveTo(gx,pad);ctx.lineTo(gx,c.height-pad);ctx.stroke();
const gy=pad+i*h/10;
ctx.beginPath();ctx.moveTo(pad,gy);ctx.lineTo(c.width-pad,gy);ctx.stroke();
}

// Axes
ctx.strokeStyle=bordC();ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,c.height-pad);ctx.lineTo(c.width-pad,c.height-pad);ctx.stroke();
// Zero line
if(yMin<0&&yMax>0){
const y0=c.height-pad+yMin*scY;
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,y0);ctx.lineTo(c.width-pad,y0);ctx.stroke();
}

// Bounds
if(showSqrt&&(viz==='cumulative'||viz==='both')){
ctx.strokeStyle='rgba(0,255,136,0.4)';ctx.lineWidth=1;ctx.setLineDash([5,3]);
ctx.beginPath();
for(let x=1;x<=maxX;x++){
const px=pad+x*scX;
const py=c.height-pad-(Math.sqrt(x)-yMin)*scY;
if(x===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
ctx.beginPath();
for(let x=1;x<=maxX;x++){
const px=pad+x*scX;
const py=c.height-pad-(-Math.sqrt(x)-yMin)*scY;
if(x===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
ctx.setLineDash([]);
}

// Draw data
const allPts=[];
if(viz==='mobius'){
// Bar chart for Œº(n)
for(let n=1;n<=maxX;n++){
const px=pad+n*scX;
const py0=c.height-pad+yMin*scY;
const py=c.height-pad-(mu[n]-yMin)*scY;
let clr;
if(col==='sign'){clr=mu[n]===1?'#00ff88':mu[n]===-1?'#ff6496':'#666';}
else if(col==='squarefree'){clr=mu[n]!==0?'#ffd700':'#444';}
else{const omega=countDistinctPrimes(n);clr=`hsl(${omega*60},70%,50%)`;}
ctx.fillStyle=clr;
ctx.fillRect(px-ptSz/2,Math.min(py,py0),ptSz,Math.abs(py-py0)||1);
allPts.push({n,mu:mu[n],M:M[n],px,py});
}
}else{
// Line/scatter for M(x)
ctx.strokeStyle='#00d9ff';ctx.lineWidth=1.5;
ctx.beginPath();
for(let n=1;n<=maxX;n++){
const val=viz==='normalized'?M[n]/Math.sqrt(n):M[n];
const px=pad+n*scX;
const py=c.height-pad-(val-yMin)*scY;
if(n===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
allPts.push({n,mu:mu[n],M:M[n],val,px,py});
}
ctx.stroke();
// Points
for(const pt of allPts){
let clr;
if(col==='sign'){clr=mu[pt.n]===1?'#00ff88':mu[pt.n]===-1?'#ff6496':'#666';}
else if(col==='squarefree'){clr=mu[pt.n]!==0?'#ffd700':'#444';}
else{const omega=countDistinctPrimes(pt.n);clr=`hsl(${omega*60},70%,50%)`;}
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(pt.px,pt.py,ptSz,0,2*Math.PI);ctx.fill();
}
}

// Labels
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText(ylabel,0,0);ctx.restore();

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Mertens Function M(x) = Œ£Œº(n) ‚Äî x ‚â§ ${maxX}`,c.width/2,25);

// Stats
const maxM=Math.max(...M.slice(1));
const minM=Math.min(...M.slice(1));
const finalM=M[maxX];
const sqrtX=Math.sqrt(maxX);
const ratio=finalM/sqrtX;
const mu1Count=mu.slice(1).filter(m=>m===1).length;
const muNeg1Count=mu.slice(1).filter(m=>m===-1).length;
const mu0Count=mu.slice(1).filter(m=>m===0).length;
const sqfreeRatio=((mu1Count+muNeg1Count)/maxX*100);

legend('almert','Mertens M(x)',[['M('+maxX+')',finalM,'#00d9ff'],['Max M',maxM,'#00ff88'],['Min M',minM,'#ff6496']]);

document.getElementById('mertLiveStats').innerHTML=`
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Mertens M(x) | FIELD: ‚Ñ§ | TYPE: Œ£Œº(n) Cumulative Sum</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max x: <strong style="color:#00d9ff">${maxX}</strong></span>
<span>M(x): <strong style="color:#ffd700">${finalM}</strong></span>
<span>Mode: <strong style="color:#00ff88">${mode}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${maxX}</div><div style="font-size:.7rem;color:var(--txt2)">MAX x</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${finalM}</div><div style="font-size:.7rem;color:var(--txt2)">M(${maxX}) ACTUAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:${Math.abs(ratio)<1?'#00ff88':'#ff6496'}">${fmt(ratio)}</div><div style="font-size:.7rem;color:var(--txt2)">M(x)/‚àöx</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#00ff88">${maxM}</div><div style="font-size:.6rem;color:var(--txt2)">MAX M(x)</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff6496">${minM}</div><div style="font-size:.6rem;color:var(--txt2)">MIN M(x)</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">¬±${fmt(sqrtX)}</div><div style="font-size:.6rem;color:var(--txt2)">‚àöx BOUND</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Mertens Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Maximum M(x):</span><span style="color:#00ff88;font-weight:bold">${maxM}</span>
<span>Minimum M(x):</span><span style="color:#ff6496;font-weight:bold">${minM}</span>
<span>‚àöx bound:</span><span style="color:#ffd700">¬±${fmt(sqrtX)}</span>
<span>|M(x)/‚àöx| max:</span><span style="color:${Math.max(Math.abs(maxM),Math.abs(minM))/sqrtX<1?'#00ff88':'#ff6496'}">${fmt(Math.max(Math.abs(maxM),Math.abs(minM))/sqrtX)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">M√∂bius Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Œº(n) = +1:</span><span style="color:#00ff88">${mu1Count} (${fmt(mu1Count/maxX*100)}%)</span>
<span>Œº(n) = -1:</span><span style="color:#ff6496">${muNeg1Count} (${fmt(muNeg1Count/maxX*100)}%)</span>
<span>Œº(n) = 0:</span><span style="color:#666">${mu0Count} (${fmt(mu0Count/maxX*100)}%)</span>
<span>Squarefree:</span><span style="color:#ffd700">${fmt(sqfreeRatio)}% (‚Üí6/œÄ¬≤‚âà60.8%)</span>
</div>
</div>
<div style="background:${Math.abs(ratio)<1?'rgba(0,255,136,.1)':'rgba(255,100,150,.1)'};padding:8px;border-radius:6px">
<strong style="color:${Math.abs(ratio)<1?'#00ff88':'#ff6496'}">RH Status: ${Math.abs(ratio)<1?'CONSISTENT':'CHECK NEEDED'}</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">|M(x)/‚àöx| ${Math.abs(ratio)<1?'<':'‚â•'} 1 at x=${maxX}</div>
</div>`;

// Plotly charts
Plotly.newPlot('pmertRatio',[{x:[...Array(maxX)].map((_,i)=>i+1),y:M.slice(1).map((m,i)=>m/Math.sqrt(i+1)),type:'scatter',mode:'lines',name:'M(x)/‚àöx',line:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'x'},yaxis:{title:'M(x)/‚àöx'}});
Plotly.newPlot('pmertDist',[{x:['+1','-1','0'],y:[mu1Count,muNeg1Count,mu0Count],type:'bar',marker:{color:['#00ff88','#ff6496','#666']}}],{...plo(),xaxis:{title:'Œº(n) value'},yaxis:{title:'Count'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
for(const pt of allPts){
if(Math.hypot(mx-pt.px,my-pt.py)<ptSz+5){
modal(`Mertens at n=${pt.n}`,[
['n',pt.n],['Œº(n)',pt.mu],['M(n)',pt.M],
['M(n)/‚àön',fmt(pt.M/Math.sqrt(pt.n))],
['‚àön',fmt(Math.sqrt(pt.n))],
['|M(n)| < ‚àön',Math.abs(pt.M)<Math.sqrt(pt.n)?'Yes':'No']
]);return;
}}};
}

function countDistinctPrimes(n){
let count=0,d=2;
while(d*d<=n){if(n%d===0){count++;while(n%d===0)n/=d;}d++;}
if(n>1)count++;
return count;
}

async function screenshotMertens(){
const maxX=document.getElementById('mertXv').value;
await screenshotUnified('cmert','mertLiveStats',`Mertens Function M(x) ‚Äî x ‚â§ ${maxX}`,'mertens_complete.png',{dashH:350});
}

function csvMertens(){
let s='n,mu_n,M_n,M_n_over_sqrt_n\n';
for(let n=1;n<=mertensData.maxX;n++)s+=`${n},${mertensData.mu[n]},${mertensData.M[n]},${mertensData.M[n]/Math.sqrt(n)}\n`;
dl(s,'mertens_data.csv');
}

// ==================== CHEBYSHEV FUNCTIONS œà(x), Œ∏(x) ====================
let chebyshevData={psi:[],theta:[],lambda:[],maxX:0};

function vonMangoldt(n){
// Œõ(n) = log(p) if n = p^k for some prime p and k ‚â• 1, else 0
if(n<2)return 0;
let p=2,logp=0;
while(p*p<=n){
if(n%p===0){
let m=n;
while(m%p===0)m/=p;
if(m===1)return Math.log(p);
return 0;
}
p++;
}
// n is prime
return Math.log(n);
}

function computeChebyshev(maxX){
const primes=sievePrimes(maxX);
const primeSet=new Set(primes);
const psi=new Array(maxX+1).fill(0);
const theta=new Array(maxX+1).fill(0);
const lambda=new Array(maxX+1).fill(0);

for(let n=2;n<=maxX;n++){
lambda[n]=vonMangoldt(n);
psi[n]=psi[n-1]+lambda[n];
theta[n]=theta[n-1]+(primeSet.has(n)?Math.log(n):0);
}
psi[0]=0;psi[1]=0;theta[0]=0;theta[1]=0;
return{psi,theta,lambda,primes};
}

function drawChebyshev(){
const c=document.getElementById('ccheb'),ctx=c.getContext('2d');
const maxX=+document.getElementById('chebXv').value||+document.getElementById('chebX').value;
const func=document.getElementById('chebFunc').value;
const showX=document.getElementById('chebShowX').checked;
const showRH=document.getElementById('chebShowRH').checked;
const norm=document.getElementById('chebNorm').value;
const ptSz=+document.getElementById('chebPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const{psi,theta,lambda,primes}=computeChebyshev(maxX);
chebyshevData={psi,theta,lambda,primes,maxX};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

// Determine data
let data1,data2,label1,label2,yMin,yMax;
if(norm==='ratio'){
data1=psi.slice(2).map((v,i)=>v/(i+2));
data2=theta.slice(2).map((v,i)=>v/(i+2));
label1='œà(x)/x';label2='Œ∏(x)/x';
yMin=0;yMax=Math.max(...data1,1.2);
}else if(norm==='error_norm'){
data1=psi.slice(2).map((v,i)=>(v-(i+2))/Math.sqrt(i+2));
data2=theta.slice(2).map((v,i)=>(v-(i+2))/Math.sqrt(i+2));
label1='(œà(x)-x)/‚àöx';label2='(Œ∏(x)-x)/‚àöx';
yMin=Math.min(...data1,...data2)-1;yMax=Math.max(...data1,...data2)+1;
}else{
if(func==='error'){
data1=psi.slice(2).map((v,i)=>v-(i+2));
label1='œà(x)-x';
yMin=Math.min(...data1);yMax=Math.max(...data1);
}else{
data1=psi.slice(2);
data2=theta.slice(2);
label1='œà(x)';label2='Œ∏(x)';
yMin=0;yMax=Math.max(...data1,maxX);
}
}

const margin=(yMax-yMin)*0.1||1;
yMin-=margin;yMax+=margin;
const scX=w/(maxX-2),scY=h/(yMax-yMin);

// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
const gx=pad+i*w/10,gy=pad+i*h/10;
ctx.beginPath();ctx.moveTo(gx,pad);ctx.lineTo(gx,c.height-pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,gy);ctx.lineTo(c.width-pad,gy);ctx.stroke();
}

// y=x reference line
if(showX&&norm==='raw'&&func!=='error'){
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=2;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.moveTo(pad,c.height-pad-(0-yMin)*scY);ctx.lineTo(c.width-pad,c.height-pad-(maxX-yMin)*scY);ctx.stroke();
ctx.setLineDash([]);
}
if(showX&&norm==='ratio'){
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=2;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.moveTo(pad,c.height-pad-(1-yMin)*scY);ctx.lineTo(c.width-pad,c.height-pad-(1-yMin)*scY);ctx.stroke();
ctx.setLineDash([]);
}

// Draw œà(x)
ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<data1.length;i++){
const px=pad+i*scX;
const py=c.height-pad-(data1[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();

// Draw Œ∏(x) if showing both
if((func==='both'||func==='theta')&&data2){
ctx.strokeStyle='#ff6496';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<data2.length;i++){
const px=pad+i*scX;
const py=c.height-pad-(data2[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Chebyshev Functions ‚Äî x ‚â§ ${maxX}`,c.width/2,25);

// Labels
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('x',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText(label1,0,0);ctx.restore();

// Stats
const finalPsi=psi[maxX];
const finalTheta=theta[maxX];
const psiRatio=finalPsi/maxX;
const thetaRatio=finalTheta/maxX;
const error=finalPsi-maxX;
const normError=error/Math.sqrt(maxX);
const primeCount=primes.length;

legend('alcheb','Chebyshev',[['œà('+maxX+')',fmt(finalPsi),'#00d9ff'],['Œ∏('+maxX+')',fmt(finalTheta),'#ff6496'],['Primes',primeCount,'#ffd700']]);

document.getElementById('chebLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${fmt(finalPsi)}</div><div style="font-size:.7rem;color:var(--txt2)">œà(${maxX})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${fmt(finalTheta)}</div><div style="font-size:.7rem;color:var(--txt2)">Œ∏(${maxX})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${primeCount}</div><div style="font-size:.7rem;color:var(--txt2)">œÄ(${maxX})</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Prime Number Theorem</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>œà(x)/x:</span><span style="color:#00d9ff;font-weight:bold">${fmt(psiRatio)} (‚Üí1)</span>
<span>Œ∏(x)/x:</span><span style="color:#ff6496;font-weight:bold">${fmt(thetaRatio)} (‚Üí1)</span>
<span>œà(x) - x:</span><span style="color:${error<0?'#ff6496':'#00ff88'}">${fmt(error)}</span>
<span>(œà(x)-x)/‚àöx:</span><span style="color:#ffd700">${fmt(normError)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Von Mangoldt Œõ(n)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Œõ(n)>0 count:</span><span style="color:#00d9ff">${lambda.filter(l=>l>0).length}</span>
<span>Max Œõ(n):</span><span style="color:#ffd700">${fmt(Math.max(...lambda))}</span>
<span>Œ£ Œõ(n):</span><span style="color:#ff6496">${fmt(finalPsi)}</span>
<span>œà-Œ∏ diff:</span><span style="color:#9664ff">${fmt(finalPsi-finalTheta)}</span>
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">PNT Verification</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">œà(x)/x = ${fmt(psiRatio)} ‚âà 1 confirms PNT</div>
</div>`;

// Plotly charts
Plotly.newPlot('pchebRatio',[
{x:[...Array(maxX-1)].map((_,i)=>i+2),y:psi.slice(2).map((v,i)=>v/(i+2)),name:'œà(x)/x',line:{color:'#00d9ff'}},
{x:[...Array(maxX-1)].map((_,i)=>i+2),y:psi.slice(2).map(()=>1),name:'y=1',line:{color:'#ffd700',dash:'dash'}}
],{...plo(),xaxis:{title:'x'},yaxis:{title:'Ratio',range:[0.8,1.2]}});

const lambdaX=[],lambdaY=[];
for(let n=2;n<=Math.min(maxX,500);n++)if(lambda[n]>0){lambdaX.push(n);lambdaY.push(lambda[n]);}
Plotly.newPlot('pchebLambda',[{x:lambdaX,y:lambdaY,type:'bar',name:'Œõ(n)',marker:{color:'#9664ff'}}],{...plo(),xaxis:{title:'n'},yaxis:{title:'Œõ(n)'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const n=Math.round((mx-pad)/scX+2);
if(n>=2&&n<=maxX){
modal(`Chebyshev at x=${n}`,[
['x',n],['œà(x)',fmt(psi[n])],['Œ∏(x)',fmt(theta[n])],
['Œõ(n)',fmt(lambda[n])],['œà(x)/x',fmt(psi[n]/n)],
['œà(x)-x',fmt(psi[n]-n)],['(œà(x)-x)/‚àöx',fmt((psi[n]-n)/Math.sqrt(n))]
]);
}};
}

async function screenshotChebyshev(){
const maxX=document.getElementById('chebXv').value;
await screenshotUnified('ccheb','chebLiveStats',`Chebyshev Functions ‚Äî x ‚â§ ${maxX}`,'chebyshev_complete.png',{dashH:350});
}

function csvChebyshev(){
let s='n,lambda_n,psi_n,theta_n,psi_over_n\n';
for(let n=2;n<=chebyshevData.maxX;n++)s+=`${n},${chebyshevData.lambda[n]},${chebyshevData.psi[n]},${chebyshevData.theta[n]},${chebyshevData.psi[n]/n}\n`;
dl(s,'chebyshev_data.csv');
}

// ==================== LOGARITHMIC INTEGRAL Li(x) ====================
let liData={pi:[],li:[],xln:[],R:[],maxX:0};

function logIntegral(x){
// Li(x) = ‚à´‚ÇÇÀ£ dt/ln(t) using numerical integration
if(x<2)return 0;
let sum=0;
const steps=Math.max(100,Math.floor(x/10));
const dx=(x-2)/steps;
for(let i=0;i<steps;i++){
const t1=2+i*dx;
const t2=2+(i+1)*dx;
const tm=(t1+t2)/2;
sum+=dx/Math.log(tm);
}
return sum;
}

function riemannR(x){
// R(x) = Œ£ Œº(n)/n ¬∑ Li(x^{1/n}) - approximation using first terms
if(x<2)return 0;
let sum=0;
const maxN=Math.floor(Math.log2(x))+5;
const mu=[0,1,-1,-1,0,-1,1,-1,0,0,1,-1,0,-1,1,1,0,-1,0,-1,0];
for(let n=1;n<=Math.min(maxN,20);n++){
if(n<mu.length&&mu[n]!==0){
const xn=Math.pow(x,1/n);
if(xn>=2)sum+=mu[n]/n*logIntegral(xn);
}
}
return sum;
}

function drawLi(){
const c=document.getElementById('cli'),ctx=c.getContext('2d');
const maxX=+document.getElementById('liXv').value||+document.getElementById('liX').value;
const viz=document.getElementById('liViz').value;
const showPi=document.getElementById('liShowPi').checked;
const showLi=document.getElementById('liShowLi').checked;
const showXln=document.getElementById('liShowXln').checked;
const showR=document.getElementById('liShowR').checked;
const scale=document.getElementById('liScale').value;
const ptSz=+document.getElementById('liPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

// Compute values
const primes=sievePrimes(maxX);
const piVals=new Array(maxX+1).fill(0);
let pCount=0;
for(let n=2;n<=maxX;n++){
if(primes.includes(n))pCount++;
piVals[n]=pCount;
}

const samplePoints=Math.min(200,maxX);
const step=Math.max(1,Math.floor(maxX/samplePoints));
const xs=[],piArr=[],liArr=[],xlnArr=[],rArr=[];

for(let x=10;x<=maxX;x+=step){
xs.push(x);
piArr.push(piVals[x]);
liArr.push(logIntegral(x));
xlnArr.push(x/Math.log(x));
if(showR)rArr.push(riemannR(x));
}

liData={pi:piArr,li:liArr,xln:xlnArr,R:rArr,xs,maxX,piVals};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

// Determine range based on visualization
let yMin=0,yMax;
if(viz==='error'){
const errors=piArr.map((p,i)=>p-liArr[i]);
yMin=Math.min(...errors)-5;yMax=Math.max(...errors)+5;
}else if(viz==='ratio'){
yMin=0.9;yMax=1.1;
}else if(viz==='density'){
yMin=0;yMax=0.5;
}else{
yMax=Math.max(...piArr,...liArr)*1.1;
}

const scX=w/(maxX-10);
const scY=h/(yMax-yMin);

// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
const gx=pad+i*w/10,gy=pad+i*h/10;
ctx.beginPath();ctx.moveTo(gx,pad);ctx.lineTo(gx,c.height-pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,gy);ctx.lineTo(c.width-pad,gy);ctx.stroke();
}

// Draw based on visualization mode
if(viz==='comparison'){
// œÄ(x)
if(showPi){
ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(piArr[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}
// Li(x)
if(showLi){
ctx.strokeStyle='#ff6496';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(liArr[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}
// x/ln(x)
if(showXln){
ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.setLineDash([5,3]);
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(xlnArr[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();ctx.setLineDash([]);
}
// R(x)
if(showR&&rArr.length>0){
ctx.strokeStyle='#9664ff';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(rArr[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}
}else if(viz==='error'){
const errors=piArr.map((p,i)=>p-liArr[i]);
ctx.strokeStyle='#ff6496';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(errors[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
// Zero line
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=1;ctx.setLineDash([5,5]);
const y0=c.height-pad-(0-yMin)*scY;
ctx.beginPath();ctx.moveTo(pad,y0);ctx.lineTo(c.width-pad,y0);ctx.stroke();ctx.setLineDash([]);
}else if(viz==='ratio'){
const ratios=piArr.map((p,i)=>liArr[i]>0?p/liArr[i]:1);
ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(ratios[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
// y=1 line
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=2;ctx.setLineDash([5,5]);
const y1=c.height-pad-(1-yMin)*scY;
ctx.beginPath();ctx.moveTo(pad,y1);ctx.lineTo(c.width-pad,y1);ctx.stroke();ctx.setLineDash([]);
}else if(viz==='density'){
const density=xs.map(x=>1/Math.log(x));
ctx.strokeStyle='#ffd700';ctx.lineWidth=2;
ctx.beginPath();
for(let i=0;i<xs.length;i++){
const px=pad+(xs[i]-10)*scX;
const py=c.height-pad-(density[i]-yMin)*scY;
if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Prime Counting: œÄ(x), Li(x), x/ln(x) ‚Äî x ‚â§ ${maxX}`,c.width/2,25);

// Labels
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('x',c.width/2,c.height-15);

// Stats
const finalPi=piVals[maxX];
const finalLi=logIntegral(maxX);
const finalXln=maxX/Math.log(maxX);
const finalR=showR?riemannR(maxX):0;
const errorLi=finalPi-finalLi;
const errorXln=finalPi-finalXln;
const relErrorLi=errorLi/finalPi*100;
const relErrorXln=errorXln/finalPi*100;

legend('alli','Prime Counting',[['œÄ(x)',finalPi,'#00d9ff'],['Li(x)',fmt(finalLi),'#ff6496'],['x/ln(x)',fmt(finalXln),'#ffd700']]);

document.getElementById('liLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${finalPi}</div><div style="font-size:.7rem;color:var(--txt2)">œÄ(${maxX})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${fmt(finalLi)}</div><div style="font-size:.7rem;color:var(--txt2)">Li(${maxX})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fmt(finalXln)}</div><div style="font-size:.7rem;color:var(--txt2)">x/ln(x)</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Approximation Errors</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>œÄ(x) - Li(x):</span><span style="color:#ff6496;font-weight:bold">${fmt(errorLi)}</span>
<span>œÄ(x) - x/ln(x):</span><span style="color:#ffd700;font-weight:bold">${fmt(errorXln)}</span>
<span>Li(x) rel error:</span><span style="color:#ff6496">${fmt(relErrorLi)}%</span>
<span>x/ln(x) rel error:</span><span style="color:#ffd700">${fmt(relErrorXln)}%</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Approximation Quality</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>œÄ(x)/Li(x):</span><span style="color:#00d9ff">${fmt(finalPi/finalLi)}</span>
<span>œÄ(x)/(x/ln x):</span><span style="color:#ffd700">${fmt(finalPi/finalXln)}</span>
<span>Li(x) advantage:</span><span style="color:#00ff88">${fmt(Math.abs(errorXln)-Math.abs(errorLi))} closer</span>
${showR?`<span>R(x) error:</span><span style="color:#9664ff">${fmt(finalPi-finalR)}</span>`:''}
</div>
</div>
<div style="background:rgba(255,100,150,.1);padding:8px;border-radius:6px">
<strong style="color:#ff6496">Li(x) > œÄ(x) Always?</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Currently Li(x) - œÄ(x) = ${fmt(finalLi-finalPi)} > 0. First crossover at ~10¬≥¬π‚Å∂!</div>
</div>`;

// Plotly charts
Plotly.newPlot('pliError',[{x:xs,y:piArr.map((p,i)=>p-liArr[i]),name:'œÄ(x)-Li(x)',line:{color:'#ff6496'}}],{...plo(),xaxis:{title:'x'},yaxis:{title:'Error'}});
Plotly.newPlot('pliQuality',[
{x:xs,y:piArr.map((p,i)=>Math.abs(p-liArr[i])),name:'|œÄ(x)-Li(x)|',line:{color:'#ff6496'}},
{x:xs,y:piArr.map((p,i)=>Math.abs(p-xlnArr[i])),name:'|œÄ(x)-x/ln(x)|',line:{color:'#ffd700'}}
],{...plo(),xaxis:{title:'x'},yaxis:{title:'Absolute Error'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const x=Math.round((mx-pad)/scX+10);
if(x>=10&&x<=maxX){
const pi=piVals[x]||0;
const li=logIntegral(x);
const xln=x/Math.log(x);
modal(`Prime Counting at x=${x}`,[
['x',x],['œÄ(x)',pi],['Li(x)',fmt(li)],['x/ln(x)',fmt(xln)],
['œÄ(x)-Li(x)',fmt(pi-li)],['œÄ(x)-x/ln(x)',fmt(pi-xln)],
['œÄ(x)/Li(x)',fmt(pi/li)]
]);
}};
}

async function screenshotLi(){
const maxX=document.getElementById('liXv').value;
await screenshotUnified('cli','liLiveStats',`Logarithmic Integral Li(x) ‚Äî x ‚â§ ${maxX}`,'li_complete.png',{dashH:350});
}

function csvLi(){
let s='x,pi_x,Li_x,x_over_ln_x,pi_minus_Li\n';
for(let i=0;i<liData.xs.length;i++){
const x=liData.xs[i];
s+=`${x},${liData.pi[i]},${liData.li[i]},${liData.xln[i]},${liData.pi[i]-liData.li[i]}\n`;
}
dl(s,'li_data.csv');
}

// ==================== DIVISOR FUNCTIONS œÑ(n), œÉ(n) ====================
let divisorData={tau:[],sigma:[],maxN:0};

function computeDivisors(n){
let tau=0,sigma=0;
for(let d=1;d*d<=n;d++){
if(n%d===0){
tau+=d*d===n?1:2;
sigma+=d*d===n?d:d+n/d;
}}
return{tau,sigma};
}

function sigmaK(n,k){
let sum=0;
for(let d=1;d*d<=n;d++){
if(n%d===0){
sum+=Math.pow(d,k);
if(d*d!==n)sum+=Math.pow(n/d,k);
}}
return sum;
}

function isHighlyComposite(n,tauArr){
const t=tauArr[n];
for(let i=1;i<n;i++)if(tauArr[i]>=t)return false;
return true;
}

function drawDivisor(){
const c=document.getElementById('cdiv'),ctx=c.getContext('2d');
const maxN=+document.getElementById('divNv').value||+document.getElementById('divN').value;
const func=document.getElementById('divFunc').value;
const viz=document.getElementById('divViz').value;
const k=+document.getElementById('divK').value;
const ptSz=+document.getElementById('divPtSz').value;
const showAvg=document.getElementById('divShowAvg').checked;
const showHC=document.getElementById('divShowHC').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

// Compute divisor functions
const tau=new Array(maxN+1).fill(0);
const sigma=new Array(maxN+1).fill(0);
const sigmaK_arr=new Array(maxN+1).fill(0);

for(let n=1;n<=maxN;n++){
const d=computeDivisors(n);
tau[n]=d.tau;
sigma[n]=d.sigma;
if(func==='sigma_k')sigmaK_arr[n]=sigmaK(n,k);
}

divisorData={tau,sigma,sigmaK:sigmaK_arr,maxN};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

// Determine data and range
let data,ylabel,yMax;
if(func==='tau'){data=tau.slice(1);ylabel='œÑ(n)';yMax=Math.max(...data)*1.1;}
else if(func==='sigma'){data=sigma.slice(1);ylabel='œÉ(n)';yMax=Math.max(...data)*1.1;}
else if(func==='sigma_k'){data=sigmaK_arr.slice(1);ylabel=`œÉ_${k}(n)`;yMax=Math.max(...data)*1.1;}
else{data=tau.slice(1);ylabel='œÑ(n)';yMax=Math.max(...data)*1.1;}

const scX=w/maxN,scY=h/yMax;

// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
const gx=pad+i*w/10,gy=pad+i*h/10;
ctx.beginPath();ctx.moveTo(gx,pad);ctx.lineTo(gx,c.height-pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,gy);ctx.lineTo(c.width-pad,gy);ctx.stroke();
}

// Average line for œÑ(n) ~ log n
if(showAvg&&func==='tau'){
ctx.strokeStyle='rgba(255,215,0,0.6)';ctx.lineWidth=2;ctx.setLineDash([5,3]);
ctx.beginPath();
for(let n=2;n<=maxN;n++){
const avg=Math.log(n)+2*0.5772-1;
const px=pad+n*scX;
const py=c.height-pad-avg*scY;
if(n===2)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();ctx.setLineDash([]);
}

// Find highly composite numbers
const hcNums=[];
if(showHC){
let maxTau=0;
for(let n=1;n<=maxN;n++){
if(tau[n]>maxTau){hcNums.push(n);maxTau=tau[n];}
}}

// Draw points
const allPts=[];
for(let n=1;n<=maxN;n++){
const val=func==='sigma'?sigma[n]:func==='sigma_k'?sigmaK_arr[n]:tau[n];
const px=pad+n*scX;
const py=c.height-pad-val*scY;
let clr='#00d9ff';
if(showHC&&hcNums.includes(n))clr='#ffd700';
else if(func==='tau'){
if(tau[n]===2)clr='#ff6496'; // prime
else if(tau[n]%2===1)clr='#9664ff'; // square
else clr='#00d9ff';
}
ctx.fillStyle=clr;ctx.beginPath();ctx.arc(px,py,ptSz,0,2*Math.PI);ctx.fill();
allPts.push({n,tau:tau[n],sigma:sigma[n],px,py});
}

// Draw second function if both
if(func==='both'){
ctx.fillStyle='#ff6496';
for(let n=1;n<=maxN;n++){
const val=sigma[n]/maxN*h/yMax*tau[maxN]; // normalize
const px=pad+n*scX;
const py=c.height-pad-sigma[n]/(sigma[maxN]/tau[maxN])*scY;
ctx.beginPath();ctx.arc(px,py,ptSz*0.7,0,2*Math.PI);ctx.fill();
}}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Divisor Functions ‚Äî n ‚â§ ${maxN}`,c.width/2,25);

// Labels
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText(ylabel,0,0);ctx.restore();

// Stats
const avgTau=tau.slice(1).reduce((a,b)=>a+b,0)/maxN;
const avgSigma=sigma.slice(1).reduce((a,b)=>a+b,0)/maxN;
const maxTau=Math.max(...tau.slice(1));
const maxTauN=tau.indexOf(maxTau);
const primeCount=tau.slice(1).filter(t=>t===2).length;
const perfectNums=[6,28,496,8128].filter(p=>p<=maxN);
const abundantCount=sigma.slice(1).filter((s,i)=>s>2*(i+1)).length;

legend('aldiv','Divisor Functions',[['Avg œÑ(n)',fmt(avgTau),'#00d9ff'],['Max œÑ',maxTau+' at n='+maxTauN,'#ffd700'],['Primes',primeCount,'#ff6496']]);

document.getElementById('divLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${maxN}</div><div style="font-size:.7rem;color:var(--txt2)">MAX n</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fmt(avgTau)}</div><div style="font-size:.7rem;color:var(--txt2)">AVG œÑ(n)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${primeCount}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Divisor Count œÑ(n)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Maximum œÑ(n):</span><span style="color:#ffd700;font-weight:bold">${maxTau} at n=${maxTauN}</span>
<span>Average œÑ(n):</span><span style="color:#00d9ff">${fmt(avgTau)}</span>
<span>Theory (log n):</span><span style="color:#ff6496">${fmt(Math.log(maxN)+2*0.5772-1)}</span>
<span>Highly Composite:</span><span style="color:#9664ff">${hcNums.slice(0,5).join(', ')}...</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Sum of Divisors œÉ(n)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Average œÉ(n):</span><span style="color:#00d9ff">${fmt(avgSigma)}</span>
<span>Perfect numbers:</span><span style="color:#ffd700">${perfectNums.join(', ')||'none in range'}</span>
<span>Abundant (œÉ>2n):</span><span style="color:#ff6496">${abundantCount} (${fmt(abundantCount/maxN*100)}%)</span>
<span>Deficient:</span><span style="color:#00ff88">${maxN-abundantCount-perfectNums.length}</span>
</div>
</div>`;

// Plotly charts
const tauDist={};
tau.slice(1).forEach(t=>{tauDist[t]=(tauDist[t]||0)+1;});
Plotly.newPlot('pdivTau',[{x:Object.keys(tauDist).map(Number),y:Object.values(tauDist),type:'bar',marker:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'œÑ(n)'},yaxis:{title:'Count'}});

const abundancy=sigma.slice(1).map((s,i)=>s/(i+1));
Plotly.newPlot('pdivAbund',[{x:[...Array(maxN)].map((_,i)=>i+1),y:abundancy,type:'scatter',mode:'markers',marker:{size:3,color:'#ff6496'}}],{...plo(),xaxis:{title:'n'},yaxis:{title:'œÉ(n)/n'},shapes:[{type:'line',x0:1,x1:maxN,y0:2,y1:2,line:{color:'#ffd700',dash:'dash'}}]});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
for(const pt of allPts){
if(Math.hypot(mx-pt.px,my-pt.py)<ptSz+5){
const factors=[];let n=pt.n,d=2;
while(d*d<=n){if(n%d===0){let c=0;while(n%d===0){c++;n/=d;}factors.push(d+'^'+c);}d++;}
if(n>1)factors.push(n+'^1');
modal(`Divisors of n=${pt.n}`,[
['n',pt.n],['œÑ(n)',pt.tau],['œÉ(n)',pt.sigma],
['œÉ(n)/n',fmt(pt.sigma/pt.n)],['Factorization',factors.join('¬∑')||'1'],
['Type',pt.sigma===2*pt.n?'PERFECT':pt.sigma>2*pt.n?'Abundant':'Deficient']
]);return;
}}};
}

async function screenshotDivisor(){
const maxN=document.getElementById('divNv').value;
await screenshotUnified('cdiv','divLiveStats',`Divisor Functions ‚Äî n ‚â§ ${maxN}`,'divisor_complete.png',{dashH:350});
}

function csvDivisor(){
let s='n,tau_n,sigma_n,sigma_over_n\n';
for(let n=1;n<=divisorData.maxN;n++)s+=`${n},${divisorData.tau[n]},${divisorData.sigma[n]},${divisorData.sigma[n]/n}\n`;
dl(s,'divisor_data.csv');
}

// ==================== LIOUVILLE FUNCTION Œª(n) ====================
let liouvilleData={lambda:[],L:[],maxN:0};

function bigOmega(n){
// Count prime factors with multiplicity
let count=0,d=2;
while(d*d<=n){while(n%d===0){count++;n/=d;}d++;}
if(n>1)count++;
return count;
}

function computeLiouville(maxN){
const lambda=new Array(maxN+1).fill(0);
const L=new Array(maxN+1).fill(0);
for(let n=1;n<=maxN;n++){
lambda[n]=bigOmega(n)%2===0?1:-1;
L[n]=L[n-1]+lambda[n];
}
return{lambda,L};
}

function drawLiouville(){
const c=document.getElementById('cliou'),ctx=c.getContext('2d');
const maxN=+document.getElementById('liouNv').value||+document.getElementById('liouN').value;
const viz=document.getElementById('liouViz').value;
const col=document.getElementById('liouCol').value;
const showSqrt=document.getElementById('liouBoundSqrt').checked;
const showM=document.getElementById('liouShowM').checked;
const ptSz=+document.getElementById('liouPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const{lambda,L}=computeLiouville(maxN);
liouvilleData={lambda,L,maxN};

// Also compute M(x) for comparison
let M=null;
if(viz==='comparison'||showM){
const{M:Marr}=computeMertens(maxN);
M=Marr;
}

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

// Determine data and range
let data,ylabel,yMin,yMax;
if(viz==='cumulative'||viz==='comparison'){
data=L.slice(1);
yMin=Math.min(...data);yMax=Math.max(...data);
ylabel='L(x)';
}else if(viz==='normalized'){
data=L.slice(1).map((l,i)=>l/Math.sqrt(i+1));
yMin=Math.min(...data);yMax=Math.max(...data);
ylabel='L(x)/‚àöx';
}else{
data=lambda.slice(1);
yMin=-1.5;yMax=1.5;
ylabel='Œª(n)';
}

const margin=Math.abs(yMax-yMin)*0.1||1;
yMin-=margin;yMax+=margin;
const scX=w/maxN,scY=h/(yMax-yMin);

// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
const gx=pad+i*w/10,gy=pad+i*h/10;
ctx.beginPath();ctx.moveTo(gx,pad);ctx.lineTo(gx,c.height-pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,gy);ctx.lineTo(c.width-pad,gy);ctx.stroke();
}

// Zero line
if(yMin<0&&yMax>0){
const y0=c.height-pad+yMin*scY;
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,y0);ctx.lineTo(c.width-pad,y0);ctx.stroke();
}

// Bounds ¬±‚àöx
if(showSqrt&&(viz==='cumulative'||viz==='comparison')){
ctx.strokeStyle='rgba(0,255,136,0.4)';ctx.lineWidth=1;ctx.setLineDash([5,3]);
ctx.beginPath();
for(let x=1;x<=maxN;x++){
const px=pad+x*scX;
const py=c.height-pad-(Math.sqrt(x)-yMin)*scY;
if(x===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
ctx.beginPath();
for(let x=1;x<=maxN;x++){
const px=pad+x*scX;
const py=c.height-pad-(-Math.sqrt(x)-yMin)*scY;
if(x===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
ctx.setLineDash([]);
}

// Draw M(x) if comparison
if((viz==='comparison'||showM)&&M){
ctx.strokeStyle='rgba(255,100,150,0.6)';ctx.lineWidth=1.5;
ctx.beginPath();
for(let n=1;n<=maxN;n++){
const px=pad+n*scX;
const py=c.height-pad-(M[n]-yMin)*scY;
if(n===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}

// Draw L(x) or Œª(n)
const allPts=[];
if(viz==='lambda'){
for(let n=1;n<=maxN;n++){
const px=pad+n*scX;
const py0=c.height-pad+yMin*scY;
const py=c.height-pad-(lambda[n]-yMin)*scY;
let clr;
if(col==='sign'){clr=lambda[n]===1?'#00ff88':'#ff6496';}
else if(col==='omega'){const om=bigOmega(n);clr=`hsl(${om*50},70%,50%)`;}
else{const mu=computeMertens(n).mu[n];clr=mu!==0?'#ffd700':'#666';}
ctx.fillStyle=clr;
ctx.fillRect(px-ptSz/2,Math.min(py,py0),ptSz,Math.abs(py-py0)||1);
allPts.push({n,lambda:lambda[n],L:L[n],omega:bigOmega(n),px,py});
}
}else{
ctx.strokeStyle='#9664ff';ctx.lineWidth=2;
ctx.beginPath();
for(let n=1;n<=maxN;n++){
const val=viz==='normalized'?L[n]/Math.sqrt(n):L[n];
const px=pad+n*scX;
const py=c.height-pad-(val-yMin)*scY;
if(n===1)ctx.moveTo(px,py);else ctx.lineTo(px,py);
allPts.push({n,lambda:lambda[n],L:L[n],omega:bigOmega(n),px,py});
}ctx.stroke();
}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Liouville Function L(x) = Œ£Œª(n) ‚Äî n ‚â§ ${maxN}`,c.width/2,25);

// Labels
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText(ylabel,0,0);ctx.restore();

// Stats
const finalL=L[maxN];
const sqrtN=Math.sqrt(maxN);
const ratio=finalL/sqrtN;
const lambda1Count=lambda.slice(1).filter(l=>l===1).length;
const lambdaNeg1Count=lambda.slice(1).filter(l=>l===-1).length;
const maxL=Math.max(...L.slice(1));
const minL=Math.min(...L.slice(1));

legend('alliou','Liouville L(x)',[['L('+maxN+')',finalL,'#9664ff'],['Max L',maxL,'#00ff88'],['Min L',minL,'#ff6496']]);

document.getElementById('liouLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#9664ff">${finalL}</div><div style="font-size:.7rem;color:var(--txt2)">L(${maxN})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fmt(ratio)}</div><div style="font-size:.7rem;color:var(--txt2)">L(x)/‚àöx</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:${finalL<=0?'#00ff88':'#ff6496'}">${finalL<=0?'YES':'NO'}</div><div style="font-size:.7rem;color:var(--txt2)">L(x)‚â§0?</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Liouville Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Maximum L(x):</span><span style="color:#00ff88;font-weight:bold">${maxL}</span>
<span>Minimum L(x):</span><span style="color:#ff6496;font-weight:bold">${minL}</span>
<span>‚àöx bound:</span><span style="color:#ffd700">¬±${fmt(sqrtN)}</span>
<span>|L(x)/‚àöx| max:</span><span style="color:#9664ff">${fmt(Math.max(Math.abs(maxL),Math.abs(minL))/sqrtN)}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Œª(n) Distribution</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Œª(n) = +1 (even Œ©):</span><span style="color:#00ff88">${lambda1Count} (${fmt(lambda1Count/maxN*100)}%)</span>
<span>Œª(n) = -1 (odd Œ©):</span><span style="color:#ff6496">${lambdaNeg1Count} (${fmt(lambdaNeg1Count/maxN*100)}%)</span>
<span>Imbalance:</span><span style="color:#9664ff">${lambda1Count-lambdaNeg1Count}</span>
<span>Note:</span><span style="color:var(--txt2)">Œª(n) never 0</span>
</div>
</div>
<div style="background:${finalL<=0?'rgba(0,255,136,.1)':'rgba(255,100,150,.1)'};padding:8px;border-radius:6px">
<strong style="color:${finalL<=0?'#00ff88':'#ff6496'}">P√≥lya Status: L(${maxN}) ${finalL<=0?'‚â§':'>'} 0</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">First counterexample at x ‚âà 906,150,257</div>
</div>`;

// Plotly charts
Plotly.newPlot('pliouRatio',[{x:[...Array(maxN)].map((_,i)=>i+1),y:L.slice(1).map((l,i)=>l/Math.sqrt(i+1)),type:'scatter',mode:'lines',name:'L(x)/‚àöx',line:{color:'#9664ff'}}],{...plo(),xaxis:{title:'x'},yaxis:{title:'L(x)/‚àöx'}});

const omegaDist={};
for(let n=1;n<=maxN;n++){const om=bigOmega(n);omegaDist[om]=(omegaDist[om]||0)+1;}
Plotly.newPlot('pliouOmega',[{x:Object.keys(omegaDist).map(Number),y:Object.values(omegaDist),type:'bar',marker:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'Œ©(n)'},yaxis:{title:'Count'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
for(const pt of allPts){
if(Math.hypot(mx-pt.px,my-pt.py)<ptSz+5){
modal(`Liouville at n=${pt.n}`,[
['n',pt.n],['Œª(n)',pt.lambda],['Œ©(n)',pt.omega],
['L(n)',pt.L],['L(n)/‚àön',fmt(pt.L/Math.sqrt(pt.n))],
['‚àön',fmt(Math.sqrt(pt.n))]
]);return;
}}};
}

async function screenshotLiouville(){
const maxN=document.getElementById('liouNv').value;
await screenshotUnified('cliou','liouLiveStats',`Liouville Function L(x) ‚Äî n ‚â§ ${maxN}`,'liouville_complete.png',{dashH:350});
}

function csvLiouville(){
let s='n,lambda_n,L_n,Omega_n,L_over_sqrt_n\n';
for(let n=1;n<=liouvilleData.maxN;n++)s+=`${n},${liouvilleData.lambda[n]},${liouvilleData.L[n]},${bigOmega(n)},${liouvilleData.L[n]/Math.sqrt(n)}\n`;
dl(s,'liouville_data.csv');
}

// ==================== VON MANGOLDT Œõ(n) ====================
let mangoldtData={lambda:[],psi:[],maxN:0};

function computeMangoldt(maxN){
const lambda=new Array(maxN+1).fill(0);
const psi=new Array(maxN+1).fill(0);
const primes=sievePrimes(Math.floor(Math.sqrt(maxN))+1);
const primeSet=new Set(sievePrimes(maxN));

for(let n=2;n<=maxN;n++){
// Check if n is a prime power
let isPrimePower=false,base=0,power=0;
for(const p of primes){
if(p>n)break;
let k=0,m=n;
while(m%p===0){m/=p;k++;}
if(m===1&&k>0){isPrimePower=true;base=p;power=k;break;}
}
if(isPrimePower){
lambda[n]=Math.log(base);
}
psi[n]=psi[n-1]+lambda[n];
}
return{lambda,psi,primeSet};
}

function drawMangoldt(){
const c=document.getElementById('cmang'),ctx=c.getContext('2d');
const maxN=+document.getElementById('mangNv').value||+document.getElementById('mangN').value;
const viz=document.getElementById('mangViz').value;
const col=document.getElementById('mangCol').value;
const showPrimes=document.getElementById('mangShowPrimes').checked;
const showPowers=document.getElementById('mangShowPowers').checked;
const showPsi=document.getElementById('mangShowPsi').checked;
const ptSz=+document.getElementById('mangPtSz').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const{lambda,psi,primeSet}=computeMangoldt(maxN);
mangoldtData={lambda,psi,maxN};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

// Determine range
let yMax;
if(viz==='cumulative'){yMax=psi[maxN]*1.1;}
else{yMax=Math.max(...lambda.slice(1))*1.2;}

const scX=w/maxN,scY=h/yMax;

// Grid
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
const gx=pad+i*w/10,gy=pad+i*h/10;
ctx.beginPath();ctx.moveTo(gx,pad);ctx.lineTo(gx,c.height-pad);ctx.stroke();
ctx.beginPath();ctx.moveTo(pad,gy);ctx.lineTo(c.width-pad,gy);ctx.stroke();
}

// y=x reference for œà(x)
if(viz==='cumulative'||showPsi){
ctx.strokeStyle='rgba(255,215,0,0.4)';ctx.lineWidth=2;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.moveTo(pad,c.height-pad);ctx.lineTo(c.width-pad,c.height-pad-maxN*scY);ctx.stroke();
ctx.setLineDash([]);
}

// Draw œà(x) line
if(viz==='cumulative'||showPsi){
ctx.strokeStyle='#00d9ff';ctx.lineWidth=2;
ctx.beginPath();
for(let n=2;n<=maxN;n++){
const px=pad+n*scX;
const py=c.height-pad-psi[n]*scY;
if(n===2)ctx.moveTo(px,py);else ctx.lineTo(px,py);
}ctx.stroke();
}

// Draw Œõ(n) bars
const allPts=[];
if(viz!=='cumulative'){
for(let n=2;n<=maxN;n++){
if(lambda[n]===0)continue;
// Determine if prime or higher power
const isPrime=primeSet.has(n);
const logVal=lambda[n];
const base=Math.round(Math.exp(logVal));
const power=Math.round(Math.log(n)/Math.log(base));

if(isPrime&&!showPrimes)continue;
if(!isPrime&&!showPowers)continue;

const px=pad+n*scX;
const py=c.height-pad-logVal*scY;
const py0=c.height-pad;

let clr;
if(col==='prime'){
// Color by prime base
const hue=(base*37)%360;
clr=`hsl(${hue},70%,50%)`;
}else if(col==='power'){
clr=power===1?'#00d9ff':power===2?'#ff6496':power===3?'#ffd700':'#9664ff';
}else{
// By size
const t=logVal/Math.log(maxN);
clr=`hsl(${(1-t)*240},70%,50%)`;
}

ctx.fillStyle=clr;
ctx.fillRect(px-ptSz/2,py,ptSz,py0-py);
allPts.push({n,lambda:logVal,base,power,isPrime,px,py});
}}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Von Mangoldt Function Œõ(n) ‚Äî n ‚â§ ${maxN}`,c.width/2,25);

// Labels
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText(viz==='cumulative'?'œà(x)':'Œõ(n)',0,0);ctx.restore();

// Legend for powers
if(viz!=='cumulative'&&col==='power'){
const legs=[['k=1 (prime)','#00d9ff'],['k=2','#ff6496'],['k=3','#ffd700'],['k‚â•4','#9664ff']];
let lx=pad;
ctx.font='10px Segoe UI';
legs.forEach(([txt,clr])=>{
ctx.fillStyle=clr;ctx.fillRect(lx,c.height-pad+15,10,10);
ctx.fillStyle=isDark()?'#fff':'#000';ctx.fillText(txt,lx+14,c.height-pad+23);
lx+=80;
});
}

// Stats
const finalPsi=psi[maxN];
const primeCount=lambda.slice(1).filter((l,i)=>l>0&&primeSet.has(i+1)).length;
const powerCount=lambda.slice(1).filter((l,i)=>l>0&&!primeSet.has(i+1)).length;
const maxLambda=Math.max(...lambda.slice(1));
const psiRatio=finalPsi/maxN;

legend('almang','Von Mangoldt',[['œà('+maxN+')',fmt(finalPsi),'#00d9ff'],['Primes',primeCount,'#ffd700'],['Powers',powerCount,'#ff6496']]);

document.getElementById('mangLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${fmt(finalPsi)}</div><div style="font-size:.7rem;color:var(--txt2)">œà(${maxN})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${primeCount}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${powerCount}</div><div style="font-size:.7rem;color:var(--txt2)">POWERS k‚â•2</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Chebyshev œà(x)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>œà(x):</span><span style="color:#00d9ff;font-weight:bold">${fmt(finalPsi)}</span>
<span>œà(x)/x:</span><span style="color:#ffd700">${fmt(psiRatio)} (‚Üí1)</span>
<span>œà(x) - x:</span><span style="color:${finalPsi-maxN<0?'#ff6496':'#00ff88'}">${fmt(finalPsi-maxN)}</span>
<span>(œà-x)/‚àöx:</span><span style="color:#9664ff">${fmt((finalPsi-maxN)/Math.sqrt(maxN))}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Prime Powers</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Total Œõ(n)>0:</span><span style="color:#00d9ff">${primeCount+powerCount}</span>
<span>Max Œõ(n):</span><span style="color:#ffd700">${fmt(maxLambda)} = log(${Math.round(Math.exp(maxLambda))})</span>
<span>Primes (k=1):</span><span style="color:#00ff88">${primeCount}</span>
<span>Higher powers:</span><span style="color:#ff6496">${powerCount}</span>
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">PNT Check</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">œà(x)/x = ${fmt(psiRatio)} ‚Üí 1 as x ‚Üí ‚àû</div>
</div>`;

// Plotly charts - prime powers by base
const powersByBase={};
for(let n=2;n<=maxN;n++){
if(lambda[n]>0){
const base=Math.round(Math.exp(lambda[n]));
powersByBase[base]=(powersByBase[base]||0)+1;
}}
const bases=Object.keys(powersByBase).map(Number).slice(0,20);
Plotly.newPlot('pmangPowers',[{x:bases,y:bases.map(b=>powersByBase[b]),type:'bar',marker:{color:bases.map(b=>`hsl(${(b*37)%360},70%,50%)`)}}],{...plo(),xaxis:{title:'Prime Base p'},yaxis:{title:'Count of p^k ‚â§ n'}});

// Distribution of Œõ(n) values
const lambdaVals=lambda.slice(1).filter(l=>l>0);
Plotly.newPlot('pmangDist',[{x:lambdaVals,type:'histogram',nbinsx:30,marker:{color:'#9664ff'}}],{...plo(),xaxis:{title:'Œõ(n) = log p'},yaxis:{title:'Count'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
for(const pt of allPts){
if(Math.hypot(mx-pt.px,my-pt.py)<ptSz+10){
modal(`Von Mangoldt at n=${pt.n}`,[
['n',pt.n],['Œõ(n)',fmt(pt.lambda)],['Base p',pt.base],['Power k',pt.power],
['Type',pt.isPrime?'Prime':'Prime Power'],['n = p^k',`${pt.base}^${pt.power}`],
['œà(n)',fmt(psi[pt.n])]
]);return;
}}};
}

async function screenshotMangoldt(){
const maxN=document.getElementById('mangNv').value;
await screenshotUnified('cmang','mangLiveStats',`Von Mangoldt Function Œõ(n) ‚Äî n ‚â§ ${maxN}`,'mangoldt_complete.png',{dashH:350});
}

function csvMangoldt(){
let s='n,Lambda_n,psi_n,is_prime_power\n';
for(let n=2;n<=mangoldtData.maxN;n++)s+=`${n},${mangoldtData.lambda[n]},${mangoldtData.psi[n]},${mangoldtData.lambda[n]>0?1:0}\n`;
dl(s,'mangoldt_data.csv');
}

// ==================== RAMANUJAN SUMS c_q(n) ====================
let ramanujanData={cqn:[],maxQ:0,maxN:0};

function ramanujanMu(n){
if(n===1)return 1;
let pf=0,d=2;
while(d*d<=n){
if(n%d===0){
n/=d;pf++;
if(n%d===0)return 0;
}
d++;
}
if(n>1)pf++;
return pf%2===0?1:-1;
}

function ramanujanSum(q,n){
// c_q(n) = Œº(q/d) * œÜ(q) / œÜ(q/d) where d = gcd(n,q)
const d=gcd(n,q);
if(q%d!==0)return 0;
const qd=q/d;
return ramanujanMu(qd)*eulerPhi(q)/eulerPhi(qd);
}

function drawRamanujan(){
const c=document.getElementById('cram'),ctx=c.getContext('2d');
const maxQ=+document.getElementById('ramQv').value||+document.getElementById('ramQ').value;
const maxN=+document.getElementById('ramNv').value||+document.getElementById('ramN').value;
const viz=document.getElementById('ramViz').value;
const col=document.getElementById('ramCol').value;
const fixN=+document.getElementById('ramFixN').value||1;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

// Compute c_q(n) values
const cqn=[];
for(let q=1;q<=maxQ;q++){
cqn[q]=[];
for(let n=1;n<=maxN;n++){
cqn[q][n]=ramanujanSum(q,n);
}}
ramanujanData={cqn,maxQ,maxN};

const pad=60,w=c.width-2*pad,h=c.height-2*pad;

if(viz==='heatmap'){
// Draw q vs n heatmap
const cellW=w/maxN,cellH=h/maxQ;
let maxVal=0;
for(let q=1;q<=maxQ;q++)for(let n=1;n<=maxN;n++)maxVal=Math.max(maxVal,Math.abs(cqn[q][n]));

for(let q=1;q<=maxQ;q++){
for(let n=1;n<=maxN;n++){
const val=cqn[q][n];
let clr;
if(col==='diverging'){
const t=val/(maxVal||1);
if(t>0)clr=`rgba(0,200,100,${Math.abs(t)})`;
else if(t<0)clr=`rgba(255,100,100,${Math.abs(t)})`;
else clr='rgba(50,50,80,0.3)';
}else if(col==='magnitude'){
const t=Math.abs(val)/(maxVal||1);
clr=`hsl(${240-t*200},70%,${30+t*40}%)`;
}else{
clr=val>0?'#00ff88':val<0?'#ff6496':'#333';
}
ctx.fillStyle=clr;
ctx.fillRect(pad+(n-1)*cellW,pad+(q-1)*cellH,cellW+0.5,cellH+0.5);
}}

// Axes
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText('q',0,0);ctx.restore();
}else if(viz==='fixedq'){
// Plot c_q(n) for fixed q
const data=cqn[maxQ]||[];
let yMin=Math.min(...data.slice(1)),yMax=Math.max(...data.slice(1));
const margin=(yMax-yMin)*0.1||1;
yMin-=margin;yMax+=margin;
const scX=w/maxN,scY=h/(yMax-yMin);

// Grid and zero line
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let i=0;i<=10;i++){
ctx.beginPath();ctx.moveTo(pad+i*w/10,pad);ctx.lineTo(pad+i*w/10,c.height-pad);ctx.stroke();
}
if(yMin<0&&yMax>0){
const y0=c.height-pad+yMin*scY;
ctx.strokeStyle='rgba(255,215,0,0.5)';ctx.lineWidth=1;
ctx.beginPath();ctx.moveTo(pad,y0);ctx.lineTo(c.width-pad,y0);ctx.stroke();
}

// Plot bars
for(let n=1;n<=maxN;n++){
const val=data[n]||0;
const px=pad+n*scX;
const py0=c.height-pad+yMin*scY;
const py=c.height-pad-(val-yMin)*scY;
ctx.fillStyle=val>0?'#00ff88':val<0?'#ff6496':'#666';
ctx.fillRect(px-2,Math.min(py,py0),4,Math.abs(py-py0)||1);
}

ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='12px Segoe UI';
ctx.textAlign='center';ctx.fillText('n',c.width/2,c.height-15);
ctx.save();ctx.translate(15,c.height/2);ctx.rotate(-Math.PI/2);ctx.fillText(`c_${maxQ}(n)`,0,0);ctx.restore();
}else if(viz==='circle'){
// Show roots of unity on unit circle
const cx=c.width/2,cy=c.height/2,radius=Math.min(w,h)/2-20;
ctx.strokeStyle=gridC();ctx.lineWidth=1;
ctx.beginPath();ctx.arc(cx,cy,radius,0,2*Math.PI);ctx.stroke();

// Draw all q-th roots
for(let a=0;a<maxQ;a++){
const angle=2*Math.PI*a/maxQ;
const x=cx+radius*Math.cos(angle);
const y=cy-radius*Math.sin(angle);
const isPrim=gcd(a,maxQ)===1;
ctx.fillStyle=isPrim?'#ffd700':'#666';
ctx.beginPath();ctx.arc(x,y,isPrim?6:4,0,2*Math.PI);ctx.fill();
if(isPrim&&maxQ<=24){
ctx.fillStyle=isDark()?'#fff':'#000';ctx.font='10px Segoe UI';
ctx.textAlign='center';ctx.fillText(a,x,y-10);
}}

ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 12px Segoe UI';ctx.textAlign='center';
ctx.fillText(`œÜ(${maxQ}) = ${eulerPhi(maxQ)} primitive roots`,cx,c.height-pad+30);
}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Ramanujan Sum c_q(n) ‚Äî q = ${maxQ}, n ‚â§ ${maxN}`,c.width/2,25);

// Stats
const phiQ=eulerPhi(maxQ);
const cq1=ramanujanSum(maxQ,1);
const cqq=ramanujanSum(maxQ,maxQ);
const divisors=[];for(let d=1;d<=maxQ;d++)if(maxQ%d===0)divisors.push(d);

legend('alram','Ramanujan c_q(n)',[['œÜ(q)',phiQ,'#ffd700'],['c_q(1)',cq1,'#00d9ff'],['c_q(q)',cqq,'#ff6496']]);

document.getElementById('ramLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${maxQ}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS q</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${phiQ}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ(q)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${cq1}</div><div style="font-size:.7rem;color:var(--txt2)">c_q(1) = Œº(q)</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Key Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>c_q(1) = Œº(q):</span><span style="color:#00d9ff;font-weight:bold">${cq1}</span>
<span>c_q(q) = œÜ(q):</span><span style="color:#ffd700">${phiQ}</span>
<span>Divisors of q:</span><span style="color:#9664ff">${divisors.join(', ')}</span>
<span>c_q(n) range:</span><span style="color:#ff6496">[${-phiQ}, ${phiQ}]</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">c_q(n) for First Few n</strong>
<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-top:6px;font-size:.75rem">
${[1,2,3,4,5,6,7,8,9,10].map(n=>`<span>c(${n})=${ramanujanSum(maxQ,n)}</span>`).join('')}
</div>
</div>`;

// Plotly charts
Plotly.newPlot('pramN',[{x:[...Array(maxN)].map((_,i)=>i+1),y:[...Array(maxN)].map((_,i)=>ramanujanSum(maxQ,i+1)),type:'bar',marker:{color:[...Array(maxN)].map((_,i)=>ramanujanSum(maxQ,i+1)>0?'#00ff88':'#ff6496')}}],{...plo(),xaxis:{title:'n'},yaxis:{title:`c_${maxQ}(n)`}});

const divData=divisors.map(d=>({x:d,y:ramanujanSum(maxQ,d)}));
Plotly.newPlot('pramDiv',[{x:divisors,y:divisors.map(d=>ramanujanSum(maxQ,d)),type:'bar',marker:{color:'#ffd700'}}],{...plo(),xaxis:{title:'d | q'},yaxis:{title:'c_q(d)'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
if(viz==='heatmap'){
const cellW=w/maxN,cellH=h/maxQ;
const n=Math.floor((mx-pad)/cellW)+1;
const q=Math.floor((my-pad)/cellH)+1;
if(n>=1&&n<=maxN&&q>=1&&q<=maxQ){
modal(`Ramanujan Sum c_${q}(${n})`,[
['q',q],['n',n],['c_q(n)',ramanujanSum(q,n)],
['gcd(n,q)',gcd(n,q)],['œÜ(q)',eulerPhi(q)],['Œº(q/gcd)',ramanujanMu(q/gcd(n,q))]
]);
}}};
}

async function screenshotRamanujan(){
const q=document.getElementById('ramQv').value;
await screenshotUnified('cram','ramLiveStats',`Ramanujan Sum c_q(n) ‚Äî q = ${q}`,'ramanujan_complete.png',{dashH:300});
}

function csvRamanujan(){
let s='q,n,c_q_n\n';
for(let q=1;q<=ramanujanData.maxQ;q++)for(let n=1;n<=ramanujanData.maxN;n++)s+=`${q},${n},${ramanujanData.cqn[q][n]}\n`;
dl(s,'ramanujan_data.csv');
}

// ==================== ULAM SPIRAL ====================
let ulamData={grid:[],primes:[],size:0};

function generateUlamSpiral(size,start=1){
const grid=Array(size).fill(null).map(()=>Array(size).fill(0));
const cx=Math.floor(size/2),cy=Math.floor(size/2);
let x=cx,y=cy,n=start;
const dirs=[[1,0],[0,-1],[-1,0],[0,1]]; // right, up, left, down
let dir=0,steps=1,stepCount=0,turnCount=0;

grid[y][x]=n++;
const maxN=start+size*size-1;
const primes=new Set(sievePrimes(maxN));

while(n<=maxN&&x>=0&&x<size&&y>=0&&y<size){
x+=dirs[dir][0];y+=dirs[dir][1];
if(x>=0&&x<size&&y>=0&&y<size)grid[y][x]=n;
n++;stepCount++;
if(stepCount===steps){
stepCount=0;dir=(dir+1)%4;turnCount++;
if(turnCount===2){turnCount=0;steps++;}
}}
return{grid,primes,start};
}

function drawUlam(){
const c=document.getElementById('culam'),ctx=c.getContext('2d');
const size=+document.getElementById('ulamSizev').value||+document.getElementById('ulamSize').value;
const start=+document.getElementById('ulamStart').value||1;
const hl=document.getElementById('ulamHL').value;
const col=document.getElementById('ulamCol').value;
const cellSz=+document.getElementById('ulamCell').value;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const{grid,primes}=generateUlamSpiral(size,start);
ulamData={grid,primes,size,start};

const pad=10;
const cellW=(c.width-2*pad)/size;
const cellH=(c.height-2*pad)/size;
const actualCell=Math.min(cellW,cellH,cellSz);
const offsetX=(c.width-size*actualCell)/2;
const offsetY=(c.height-size*actualCell)/2;

// Draw grid
let primeCount=0,twinCount=0;
for(let y=0;y<size;y++){
for(let x=0;x<size;x++){
const n=grid[y][x];
if(!n)continue;
const isPrime=primes.has(n);
if(isPrime)primeCount++;

let show=false,clr='#fff';
if(hl==='primes'&&isPrime){show=true;clr='#fff';}
else if(hl==='twin'&&isPrime&&(primes.has(n+2)||primes.has(n-2))){show=true;clr='#ffd700';if(primes.has(n+2))twinCount++;}
else if(hl==='sophie'&&isPrime&&primes.has(2*n+1)){show=true;clr='#ff6496';}
else if(hl==='diagonal'){
const cx=Math.floor(size/2),cy=Math.floor(size/2);
if(x===y||x===size-1-y||x===cx||y===cy){show=isPrime;clr='#00d9ff';}
}else if(hl==='mersenne'){
const log2=Math.log2(n+1);
if(Math.abs(log2-Math.round(log2))<0.01){show=true;clr='#9664ff';}
else if(isPrime)show=true;
}

if(col==='classic'){
if(show){ctx.fillStyle=clr;ctx.fillRect(offsetX+x*actualCell,offsetY+y*actualCell,actualCell,actualCell);}
}else if(col==='heat'){
if(isPrime){
// Count nearby primes for heat
let nearby=0;
for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++){
const ny=y+dy,nx=x+dx;
if(ny>=0&&ny<size&&nx>=0&&nx<size&&grid[ny][nx]&&primes.has(grid[ny][nx]))nearby++;
}
const t=nearby/25;
ctx.fillStyle=`hsl(${60-t*60},100%,${40+t*30}%)`;
ctx.fillRect(offsetX+x*actualCell,offsetY+y*actualCell,actualCell,actualCell);
}
}else if(col==='mod6'){
if(isPrime){
const mod=n%6;
const colors={1:'#00d9ff',5:'#ff6496'};
ctx.fillStyle=colors[mod]||'#ffd700';
ctx.fillRect(offsetX+x*actualCell,offsetY+y*actualCell,actualCell,actualCell);
}
}else if(col==='gcd'){
if(isPrime){
const g=gcd(x-Math.floor(size/2),y-Math.floor(size/2));
ctx.fillStyle=`hsl(${g*60},70%,50%)`;
ctx.fillRect(offsetX+x*actualCell,offsetY+y*actualCell,actualCell,actualCell);
}
}
}}

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Ulam Spiral ${size}√ó${size} ‚Äî Start: ${start}`,c.width/2,20);

// Stats
const maxN=start+size*size-1;
const density=primeCount/(size*size)*100;

legend('alulam','Ulam Spiral',[['Primes',primeCount,'#ffd700'],['Total',size*size,'#00d9ff'],['Density',fmt(density)+'%','#ff6496']]);

document.getElementById('ulamLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${primeCount}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${size}√ó${size}</div><div style="font-size:.7rem;color:var(--txt2)">GRID SIZE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${fmt(density)}%</div><div style="font-size:.7rem;color:var(--txt2)">DENSITY</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Spiral Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Range:</span><span style="color:#00d9ff">${start} to ${maxN}</span>
<span>Primes in range:</span><span style="color:#ffd700">${primeCount}</span>
<span>Expected (PNT):</span><span style="color:#9664ff">${Math.round(maxN/Math.log(maxN))}</span>
<span>Twin pairs:</span><span style="color:#ff6496">${Math.floor(twinCount/2)}</span>
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">Diagonal Patterns</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Primes cluster on diagonals 4n¬≤+bn+c. Try Euler's n¬≤+n+41!</div>
</div>`;

// Plotly charts - diagonal density
const diagCounts=[];
for(let d=-Math.floor(size/2);d<=Math.floor(size/2);d++){
let count=0;
for(let i=0;i<size;i++){
const y=i,x=i+d+Math.floor(size/2);
if(x>=0&&x<size&&grid[y]&&grid[y][x]&&primes.has(grid[y][x]))count++;
}
diagCounts.push({d,count});
}
Plotly.newPlot('pulamDiag',[{x:diagCounts.map(dc=>dc.d),y:diagCounts.map(dc=>dc.count),type:'bar',marker:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'Diagonal Offset'},yaxis:{title:'Prime Count'}});

// Gap distribution
const primeList=[...primes].filter(p=>p>=start&&p<=maxN).sort((a,b)=>a-b);
const gaps=[];
for(let i=1;i<Math.min(primeList.length,1000);i++)gaps.push(primeList[i]-primeList[i-1]);
Plotly.newPlot('pulamGaps',[{x:gaps,type:'histogram',nbinsx:20,marker:{color:'#ff6496'}}],{...plo(),xaxis:{title:'Gap Size'},yaxis:{title:'Count'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
const gx=Math.floor((mx-offsetX)/actualCell);
const gy=Math.floor((my-offsetY)/actualCell);
if(gx>=0&&gx<size&&gy>=0&&gy<size&&grid[gy]&&grid[gy][gx]){
const n=grid[gy][gx];
modal(`Ulam Spiral at (${gx},${gy})`,[
['Value',n],['Prime?',primes.has(n)?'YES':'NO'],
['Grid Position',`(${gx}, ${gy})`],['Distance from Center',fmt(Math.hypot(gx-size/2,gy-size/2))],
['n mod 6',n%6]
]);
}};
}

async function screenshotUlam(){
const size=document.getElementById('ulamSizev').value;
await screenshotUnified('culam','ulamLiveStats',`Ulam Spiral ${size}√ó${size}`,'ulam_spiral.png',{dashH:280});
}

function csvUlam(){
let s='x,y,n,is_prime\n';
for(let y=0;y<ulamData.size;y++)for(let x=0;x<ulamData.size;x++){
const n=ulamData.grid[y][x];
if(n)s+=`${x},${y},${n},${ulamData.primes.has(n)?1:0}\n`;
}
dl(s,'ulam_spiral.csv');
}

// ==================== SACKS SPIRAL ====================
let sacksData={points:[],primes:new Set(),maxN:0};

function drawSacks(){
const c=document.getElementById('csacks'),ctx=c.getContext('2d');
const maxN=+document.getElementById('sacksNv').value||+document.getElementById('sacksN').value;
const hl=document.getElementById('sacksHL').value;
const col=document.getElementById('sacksCol').value;
const ptSz=+document.getElementById('sacksPtSz').value;
const showArcs=document.getElementById('sacksShowArcs').checked;
const showGrid=document.getElementById('sacksShowGrid').checked;

ctx.fillStyle=canvBg();ctx.fillRect(0,0,c.width,c.height);

const primes=new Set(sievePrimes(maxN));
sacksData={primes,maxN};

const cx=c.width/2,cy=c.height/2;
const maxR=Math.sqrt(maxN);
const scale=Math.min(c.width,c.height)/2/maxR*0.9;

// Grid circles for perfect squares
if(showGrid){
ctx.strokeStyle=gridC();ctx.lineWidth=0.5;
for(let k=1;k*k<=maxN;k+=Math.ceil(Math.sqrt(maxN)/10)){
ctx.beginPath();ctx.arc(cx,cy,k*scale,0,2*Math.PI);ctx.stroke();
}}

// Draw parabolic arcs (reference curves)
if(showArcs){
ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
// n¬≤ + n + 41 (Euler's polynomial)
ctx.beginPath();
for(let n=0;n<Math.sqrt(maxN);n++){
const val=n*n+n+41;
if(val>maxN)break;
const r=Math.sqrt(val)*scale;
const theta=2*Math.PI*Math.sqrt(val);
const x=cx+r*Math.cos(theta);
const y=cy-r*Math.sin(theta);
if(n===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
}ctx.stroke();
}

// Draw points
const points=[];
let primeCount=0,twinCount=0;
for(let n=1;n<=maxN;n++){
const sqrtN=Math.sqrt(n);
const r=sqrtN*scale;
const theta=2*Math.PI*sqrtN;
const x=cx+r*Math.cos(theta);
const y=cy-r*Math.sin(theta);
const isPrime=primes.has(n);
if(isPrime)primeCount++;

let show=false,clr='#fff';
if(hl==='primes'&&isPrime){show=true;}
else if(hl==='all'){show=true;clr=isPrime?'#ffd700':'#444';}
else if(hl==='twin'&&isPrime&&(primes.has(n+2)||primes.has(n-2))){show=true;clr='#ff6496';twinCount++;}
else if(hl==='squares'){const sq=Math.sqrt(n);show=Math.abs(sq-Math.round(sq))<0.001;clr='#00d9ff';}
else if(hl==='triangular'){const t=(Math.sqrt(8*n+1)-1)/2;show=Math.abs(t-Math.round(t))<0.001;clr='#9664ff';}

if(show){
if(col==='classic'){clr=clr==='#fff'?'#ffd700':clr;}
else if(col==='rainbow'){clr=`hsl(${(n/maxN)*360},70%,50%)`;}
else if(col==='density'){
// Local prime density
let nearby=0;
for(let k=Math.max(1,n-50);k<=Math.min(maxN,n+50);k++)if(primes.has(k))nearby++;
const t=nearby/100;
clr=`hsl(${120-t*120},70%,50%)`;
}else if(col==='gap'){
if(isPrime){
let gap=0;
for(let k=n+1;k<=Math.min(maxN,n+100);k++)if(primes.has(k)){gap=k-n;break;}
clr=`hsl(${Math.min(gap*10,240)},70%,50%)`;
}
}
ctx.fillStyle=clr;
ctx.beginPath();ctx.arc(x,y,ptSz,0,2*Math.PI);ctx.fill();
points.push({n,x,y,isPrime});
}}

// Mark center and axes
ctx.fillStyle='#ff6496';ctx.beginPath();ctx.arc(cx,cy,3,0,2*Math.PI);ctx.fill();

// Title
ctx.fillStyle=isDark()?'#ffd700':'#cc8800';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';
ctx.fillText(`Sacks Spiral ‚Äî n ‚â§ ${maxN}`,c.width/2,20);

// Stats
const density=primeCount/maxN*100;
const expected=maxN/Math.log(maxN);

legend('alsacks','Sacks Spiral',[['Primes',primeCount,'#ffd700'],['Max n',maxN,'#00d9ff'],['Density',fmt(density)+'%','#ff6496']]);

document.getElementById('sacksLiveStats').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${primeCount}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${maxN}</div><div style="font-size:.7rem;color:var(--txt2)">MAX n</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${fmt(density)}%</div><div style="font-size:.7rem;color:var(--txt2)">DENSITY</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Spiral Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Primes found:</span><span style="color:#ffd700">${primeCount}</span>
<span>PNT prediction:</span><span style="color:#9664ff">${Math.round(expected)}</span>
<span>Ratio:</span><span style="color:#00d9ff">${fmt(primeCount/expected)}</span>
<span>Max radius:</span><span style="color:#ff6496">${fmt(maxR)}</span>
</div>
</div>
<div style="background:rgba(0,255,136,.1);padding:8px;border-radius:6px">
<strong style="color:#00ff88">Parabolic Arms</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Primes cluster on curves an¬≤+bn+c. Toggle arcs to see Euler's n¬≤+n+41.</div>
</div>`;

// Plotly charts - angular distribution
const angleBins=Array(36).fill(0);
for(let n=2;n<=maxN;n++){
if(primes.has(n)){
const theta=(2*Math.PI*Math.sqrt(n))%(2*Math.PI);
const bin=Math.floor(theta/(2*Math.PI)*36);
angleBins[bin]++;
}}
Plotly.newPlot('psacksAngle',[{x:[...Array(36)].map((_,i)=>i*10),y:angleBins,type:'bar',marker:{color:'#00d9ff'}}],{...plo(),xaxis:{title:'Angle (degrees)'},yaxis:{title:'Prime Count'}});

// Radial density
const radialBins=[];
const binSize=Math.ceil(Math.sqrt(maxN)/20);
for(let r=0;r<Math.sqrt(maxN);r+=binSize){
let count=0,total=0;
for(let n=Math.floor(r*r);n<Math.min(maxN,(r+binSize)*(r+binSize));n++){
total++;if(primes.has(n))count++;
}
radialBins.push({r:r+binSize/2,density:count/total*100});
}
Plotly.newPlot('psacksRadial',[{x:radialBins.map(b=>b.r),y:radialBins.map(b=>b.density),type:'scatter',mode:'lines+markers',line:{color:'#ff6496'}}],{...plo(),xaxis:{title:'Radius (‚àön)'},yaxis:{title:'Prime %'}});

// Click handler
c.onclick=e=>{
const rect=c.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(c.width/rect.width);
const my=(e.clientY-rect.top)*(c.height/rect.height);
// Find closest point
let closest=null,minD=Infinity;
for(const pt of points){
const d=Math.hypot(mx-pt.x,my-pt.y);
if(d<minD&&d<20){minD=d;closest=pt;}
}
if(closest){
const sqrtN=Math.sqrt(closest.n);
modal(`Sacks Spiral at n=${closest.n}`,[
['n',closest.n],['Prime?',closest.isPrime?'YES':'NO'],
['‚àön',fmt(sqrtN)],['Œ∏ = 2œÄ‚àön',fmt(2*Math.PI*sqrtN)+' rad'],
['Position',`(${fmt(closest.x-cx)}, ${fmt(cy-closest.y)})`]
]);
}};
}

async function screenshotSacks(){
const maxN=document.getElementById('sacksNv').value;
await screenshotUnified('csacks','sacksLiveStats',`Sacks Spiral ‚Äî n ‚â§ ${maxN}`,'sacks_spiral.png',{dashH:280});
}

function csvSacks(){
let s='n,sqrt_n,theta,x,y,is_prime\n';
for(let n=1;n<=sacksData.maxN;n++){
const sqrtN=Math.sqrt(n);
const theta=2*Math.PI*sqrtN;
s+=`${n},${sqrtN},${theta},${Math.cos(theta)*sqrtN},${Math.sin(theta)*sqrtN},${sacksData.primes.has(n)?1:0}\n`;
}
dl(s,'sacks_spiral.csv');
}

// ==================== RIEMANN ZETA CRITICAL LINE ====================
// Known zeros of zeta (imaginary parts Œ≥ where Œ∂(¬Ω+iŒ≥)=0)
const ZETA_ZEROS = [
14.134725141734693790, 21.022039638771554993, 25.010857580145688763,
30.424876125859513210, 32.935061587739189691, 37.586178158825671257,
40.918719012147495187, 43.327073280914999519, 48.005150881167159727,
49.773832477672302181, 52.970321477714460644, 56.446247697063394804,
59.347044002602353079, 60.831778524609809844, 65.112544048081606660,
67.079810529494173714, 69.546401711173979253, 72.067157674481907582,
75.704690699083933168, 77.144840068874805372, 79.337375020249367922,
82.910380854086030183, 84.735492980517050105, 87.425274613125229406,
88.809111207634465423, 92.491899270558484296, 94.651344040519886966,
95.870634228245309758, 98.831194218193692233, 101.31785100573139122,
103.72553804047833941, 105.44662305232609449, 107.16861118427640751,
111.02953554316967452, 111.87465917699263708, 114.32022091545271276,
116.22668032085755438, 118.79078286597621732, 121.37012500242064591,
122.94682929355258820, 124.25681855434576718, 127.51668387959649512,
129.57870419995605098, 131.08768853093265672, 133.49773720299758645,
134.75650975337387133, 138.11604205453344320, 139.73620895212138895,
141.12370740402112376, 143.11184580762063273, 146.00098248680048919,
147.42276534793308755, 150.05352042078782659, 150.92525768847052854,
153.02469388962161583, 156.11290929488542054, 157.59759182416338810,
158.84998824471372968, 161.18896413346127860, 163.03070969030579894,
165.53706942685747168, 167.18443976129343424, 169.09451541521459628,
169.91197647941169893, 173.41153663823262780, 174.75419152430845339,
176.44143416899626780, 178.37740777482236746, 179.91648402025634847,
182.20707848436646288, 184.87446784609816684, 185.59878367807166488,
187.22892258423618890, 189.41615865498588760, 192.02665636054838648,
193.07972660174592792, 195.26539668337094868, 196.87648158723658498,
198.01530956127895210, 201.26475194370447961, 202.49359453091668116
];

// Riemann-Siegel theta function Œ∏(t) = arg(Œì(1/4 + it/2)) - (t/2)log(œÄ)
function thetaRS(t) {
if(t < 1) return 0;
// Stirling approximation for arg(Œì(1/4 + it/2))
// Œ∏(t) ‚âà (t/2)log(t/2œÄ) - t/2 - œÄ/8 + 1/(48t) + ...
const term1 = (t/2) * Math.log(t / (2 * PI));
const term2 = -t/2;
const term3 = -PI/8;
const term4 = 1/(48*t);
const term5 = 7/(5760*t*t*t);
return term1 + term2 + term3 + term4 + term5;
}

// Hardy Z-function approximation using Riemann-Siegel formula
function hardyZ(t) {
if(t < 1) return 1;
// Main sum approximation
const sqrtT2pi = Math.sqrt(t / (2 * PI));
const N = Math.floor(sqrtT2pi);
let mainSum = 0;
for(let n = 1; n <= N; n++) {
mainSum += Math.cos(thetaRS(t) - t * Math.log(n)) / Math.sqrt(n);
}
mainSum *= 2;
// Correction term (simplified)
const p = sqrtT2pi - N;
const C0 = Math.cos(2 * PI * (p * p - p - 1/16)) / Math.cos(2 * PI * p);
const correction = Math.pow(-1, N - 1) * Math.pow(t / (2 * PI), -0.25) * C0;
return mainSum + correction;
}

// Find zeros by sign changes
function findZerosInRange(tMin, tMax, resolution) {
const zeros = [];
const dt = (tMax - tMin) / resolution;
let prevZ = hardyZ(tMin);
for(let i = 1; i <= resolution; i++) {
const t = tMin + i * dt;
const z = hardyZ(t);
if(prevZ * z < 0) {
// Bisect to find more precise zero
let lo = t - dt, hi = t;
for(let j = 0; j < 20; j++) {
const mid = (lo + hi) / 2;
const zm = hardyZ(mid);
if(zm * hardyZ(lo) < 0) hi = mid;
else lo = mid;
}
zeros.push((lo + hi) / 2);
}
prevZ = z;
}
return zeros;
}

// Gram points: Œ∏(g_n) = nœÄ
function gramPoint(n) {
// Newton's method to solve Œ∏(g) = nœÄ
let g = n < 0 ? 10 : 2 * PI * Math.exp(1 + n / Math.E); // Initial guess
for(let i = 0; i < 50; i++) {
const th = thetaRS(g);
const target = n * PI;
const diff = th - target;
// Derivative: Œ∏'(t) ‚âà (1/2)log(t/2œÄ)
const deriv = 0.5 * Math.log(g / (2 * PI));
if(Math.abs(deriv) < 1e-10) break;
const newG = g - diff / deriv;
if(Math.abs(newG - g) < 1e-12) break;
g = newG;
}
return g;
}

let hardyData = {tVals: [], zVals: [], zeros: [], gramPts: []};

function drawHardy() {
const c = document.getElementById('chardy'), ctx = c.getContext('2d');
const tMax = +document.getElementById('hardyTv').value || 50;
const tStart = +document.getElementById('hardyStart').value || 0;
const resolution = +document.getElementById('hardyResv').value || 2000;
const viz = document.getElementById('hardyViz').value;
const showZeros = document.getElementById('hardyShowZeros').checked;
const showGram = document.getElementById('hardyShowGram').checked;
const showEnv = document.getElementById('hardyShowEnv').checked;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const tMin = Math.max(1, tStart);
const tRange = tMax;
const dt = tRange / resolution;

// Compute Z(t) values
const tVals = [], zVals = [], absZ = [];
for(let i = 0; i <= resolution; i++) {
const t = tMin + i * dt;
const z = hardyZ(t);
tVals.push(t);
zVals.push(z);
absZ.push(Math.abs(z));
}
hardyData = {tVals, zVals, absZ, tMin, tMax: tMin + tRange};

// Find zeros
const zeros = findZerosInRange(tMin, tMin + tRange, resolution * 2);
hardyData.zeros = zeros;

// Compute Gram points in range
const gramPts = [];
for(let n = -1; n < 500; n++) {
const g = gramPoint(n);
if(g >= tMin && g <= tMin + tRange) gramPts.push({n, g, z: hardyZ(g)});
if(g > tMin + tRange) break;
}
hardyData.gramPts = gramPts;

const pad = 60, w = c.width - 2*pad, h = c.height - 2*pad;

// Determine y range
let yMin, yMax;
if(viz === 'envelope' || viz === 'theta') {
yMin = 0; yMax = Math.max(...absZ) * 1.1;
} else {
yMin = Math.min(...zVals); yMax = Math.max(...zVals);
const margin = (yMax - yMin) * 0.1;
yMin -= margin; yMax += margin;
}

const scX = w / tRange, scY = h / (yMax - yMin);

// Grid
ctx.strokeStyle = gridC(); ctx.lineWidth = 0.5;
for(let i = 0; i <= 10; i++) {
const gx = pad + i * w / 10, gy = pad + i * h / 10;
ctx.beginPath(); ctx.moveTo(gx, pad); ctx.lineTo(gx, c.height - pad); ctx.stroke();
ctx.beginPath(); ctx.moveTo(pad, gy); ctx.lineTo(c.width - pad, gy); ctx.stroke();
}

// Zero line
if(yMin < 0 && yMax > 0) {
const y0 = c.height - pad + yMin * scY;
ctx.strokeStyle = 'rgba(255,215,0,0.6)'; ctx.lineWidth = 2;
ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(c.width - pad, y0); ctx.stroke();
}

// Envelope bounds ¬±t^{1/4}
if(showEnv && viz !== 'theta') {
ctx.strokeStyle = 'rgba(0,255,136,0.3)'; ctx.lineWidth = 1; ctx.setLineDash([5,3]);
ctx.beginPath();
for(let i = 0; i <= resolution; i++) {
const t = tVals[i];
const env = Math.pow(t, 0.25) * 2;
const px = pad + (t - tMin) * scX;
const py = c.height - pad - (env - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
ctx.beginPath();
for(let i = 0; i <= resolution; i++) {
const t = tVals[i];
const env = -Math.pow(t, 0.25) * 2;
const px = pad + (t - tMin) * scX;
const py = c.height - pad - (env - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
ctx.setLineDash([]);
}

// Draw Z(t) or |Z(t)|
ctx.strokeStyle = viz === 'theta' ? '#9664ff' : '#00d9ff'; ctx.lineWidth = 1.5;
ctx.beginPath();
for(let i = 0; i <= resolution; i++) {
const px = pad + (tVals[i] - tMin) * scX;
const val = viz === 'envelope' ? absZ[i] : viz === 'theta' ? thetaRS(tVals[i]) % (2*PI) : zVals[i];
const py = c.height - pad - (val - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();

// Mark zeros
if(showZeros) {
ctx.fillStyle = '#ff6496';
for(const z of zeros) {
const px = pad + (z - tMin) * scX;
const py = c.height - pad + yMin * scY;
ctx.beginPath(); ctx.arc(px, py, 5, 0, 2*PI); ctx.fill();
}
}

// Mark Gram points
if(showGram) {
ctx.fillStyle = '#ffd700';
for(const gp of gramPts) {
const px = pad + (gp.g - tMin) * scX;
const py = c.height - pad - (0 - yMin) * scY;
ctx.beginPath(); ctx.arc(px, py - 10, 4, 0, 2*PI); ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '9px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('g' + gp.n, px, py - 18);
ctx.fillStyle = '#ffd700';
}
}

// Title
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800'; ctx.font = 'bold 14px Segoe UI'; ctx.textAlign = 'center';
ctx.fillText(`Hardy Z-Function ‚Äî t ‚àà [${fmt(tMin)}, ${fmt(tMin + tRange)}]`, c.width/2, 25);

// Labels
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('t', c.width/2, c.height - 15);
ctx.save(); ctx.translate(15, c.height/2); ctx.rotate(-PI/2);
ctx.fillText(viz === 'envelope' ? '|Z(t)|' : viz === 'theta' ? 'Œ∏(t) mod 2œÄ' : 'Z(t)', 0, 0);
ctx.restore();

// Known zeros in range
const knownInRange = ZETA_ZEROS.filter(z => z >= tMin && z <= tMin + tRange);

legend('alhardy', 'Hardy Z(t)', [
['Zeros Found', zeros.length, '#ff6496'],
['Known Zeros', knownInRange.length, '#ffd700'],
['Gram Points', gramPts.length, '#00d9ff']
]);

document.getElementById('hardyLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Hardy Z(t) | FIELD: Critical Line œÉ=¬Ω | TYPE: Real Zeta Proxy</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>t range: <strong style="color:#00d9ff">[${fmt(tMin)}, ${fmt(tMin+tRange)}]</strong></span>
<span>Mode: <strong style="color:#ffd700">${viz}</strong></span>
<span>Resolution: <strong style="color:#00ff88">${resolution}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${zeros.length}</div><div style="font-size:.7rem;color:var(--txt2)">ZEROS FOUND</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${gramPts.length}</div><div style="font-size:.7rem;color:var(--txt2)">GRAM POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${fmt(tMin + tRange)}</div><div style="font-size:.7rem;color:var(--txt2)">MAX t</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${knownInRange.length}</div><div style="font-size:.6rem;color:var(--txt2)">KNOWN ZEROS IN RANGE</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ff8c00">${zeros.length>0?fmt(zeros[0]):'‚Äî'}</div><div style="font-size:.6rem;color:var(--txt2)">FIRST ZERO</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">First Zeros in Range</strong>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;font-size:.75rem;font-family:monospace">
${zeros.slice(0, 8).map(z => `<span style="background:var(--bg1);padding:2px 6px;border-radius:3px">${z.toFixed(6)}</span>`).join('')}
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Known Riemann Zeros (first 10)</strong>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;font-size:.75rem;font-family:monospace">
${ZETA_ZEROS.slice(0, 10).map(z => `<span style="background:var(--bg1);padding:2px 6px;border-radius:3px;color:${z >= tMin && z <= tMin + tRange ? '#ffd700' : 'var(--txt2)'}">${z.toFixed(4)}</span>`).join('')}
</div>
</div>
<div style="background:rgba(255,100,150,.1);padding:8px;border-radius:6px">
<strong style="color:#ff6496">RH Verification</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">All ${zeros.length} zeros found on critical line Re(s)=¬Ω</div>
</div>`;

// Plotly charts
Plotly.newPlot('phardyZeros', [{x: zeros, y: zeros.map(() => 0), type: 'scatter', mode: 'markers', marker: {color: '#ff6496', size: 8}, name: 'Zeros'}], {...plo(), xaxis: {title: 'Œ≥ (imaginary part)'}, yaxis: {title: '', showticklabels: false}});

const growthX = [], growthY = [];
for(let i = 0; i < resolution; i += Math.floor(resolution/50)) {
growthX.push(tVals[i]);
growthY.push(absZ[i]);
}
Plotly.newPlot('phardyGrowth', [
{x: growthX, y: growthY, type: 'scatter', mode: 'lines', name: '|Z(t)|', line: {color: '#00d9ff'}},
{x: growthX, y: growthX.map(t => Math.pow(t, 0.25)), type: 'scatter', mode: 'lines', name: 't^{1/4}', line: {color: '#ffd700', dash: 'dash'}}
], {...plo(), xaxis: {title: 't'}, yaxis: {title: '|Z(t)|'}});

// Click handler
c.onclick = e => {
const rect = c.getBoundingClientRect();
const mx = (e.clientX - rect.left) * (c.width / rect.width);
const t = tMin + (mx - pad) / scX;
if(t >= tMin && t <= tMin + tRange) {
const z = hardyZ(t);
const th = thetaRS(t);
modal(`Hardy Z at t = ${t.toFixed(6)}`, [
['t', t.toFixed(10)],
['Z(t)', z.toFixed(10)],
['|Z(t)|', Math.abs(z).toFixed(10)],
['Œ∏(t)', th.toFixed(10)],
['Œ∏(t)/œÄ', (th/PI).toFixed(6)],
['Nearest zero', zeros.length > 0 ? zeros.reduce((a,b) => Math.abs(b-t) < Math.abs(a-t) ? b : a).toFixed(6) : 'N/A']
]);
}
};
}

async function screenshotHardy() {
const tMax = document.getElementById('hardyTv').value;
await screenshotUnified('chardy', 'hardyLiveStats', `Hardy Z-Function ‚Äî t ‚â§ ${tMax}`, 'hardy_z.png', {dashH: 320});
}

function csvHardy() {
let s = 't,Z_t,abs_Z_t,theta_t\n';
for(let i = 0; i < hardyData.tVals.length; i += Math.max(1, Math.floor(hardyData.tVals.length / 5000))) {
s += `${hardyData.tVals[i]},${hardyData.zVals[i]},${hardyData.absZ[i]},${thetaRS(hardyData.tVals[i])}\n`;
}
dl(s, 'hardy_z_data.csv');
}

// ==================== GRAM POINTS ====================
let gramData = {points: [], zeros: [], intervals: []};

function drawGram() {
const c = document.getElementById('cgram'), ctx = c.getContext('2d');
const maxN = +document.getElementById('gramNv').value || 100;
const startN = +document.getElementById('gramStart').value || -1;
const viz = document.getElementById('gramViz').value;
const showZeros = document.getElementById('gramShowZeros').checked;
const showLaw = document.getElementById('gramShowLaw').checked;
const showBlocks = document.getElementById('gramShowBlocks').checked;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Compute Gram points
const points = [];
for(let n = startN; n < startN + maxN; n++) {
const g = gramPoint(n);
const z = hardyZ(g);
const sign = z > 0 ? 1 : -1;
const expectedSign = Math.pow(-1, n);
const satisfiesLaw = sign === expectedSign;
points.push({n, g, z, sign, expectedSign, satisfiesLaw});
}
gramData.points = points;

// Find zeros in Gram intervals
const intervals = [];
let violations = 0;
for(let i = 0; i < points.length - 1; i++) {
const g1 = points[i].g, g2 = points[i+1].g;
const zerosInInterval = findZerosInRange(g1, g2, 200);
const count = zerosInInterval.length;
const isViolation = count !== 1;
if(isViolation) violations++;
intervals.push({n1: points[i].n, n2: points[i+1].n, g1, g2, zeros: zerosInInterval, count, isViolation});
}
gramData.intervals = intervals;

const pad = 60, w = c.width - 2*pad, h = c.height - 2*pad;

if(viz === 'grampoints' || viz === 'intervals') {
// Plot Gram points
const gMin = points[0].g, gMax = points[points.length-1].g;
const scX = w / (gMax - gMin);

// Draw intervals with zero counts
for(const iv of intervals) {
const x1 = pad + (iv.g1 - gMin) * scX;
const x2 = pad + (iv.g2 - gMin) * scX;
const clr = iv.count === 0 ? 'rgba(255,100,100,0.3)' : iv.count === 1 ? 'rgba(0,255,136,0.15)' : 'rgba(255,200,0,0.3)';
ctx.fillStyle = clr;
ctx.fillRect(x1, pad, x2 - x1, h);
}

// Draw Gram points
for(const pt of points) {
const px = pad + (pt.g - gMin) * scX;
const clr = pt.satisfiesLaw ? '#00ff88' : '#ff6496';
ctx.fillStyle = clr;
ctx.beginPath(); ctx.arc(px, c.height/2, 6, 0, 2*PI); ctx.fill();
// Label
if(maxN <= 50) {
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '9px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('g' + pt.n, px, c.height/2 + 20);
}
}

// Draw zeros
if(showZeros) {
ctx.fillStyle = '#ffd700';
for(const iv of intervals) {
for(const z of iv.zeros) {
const px = pad + (z - gMin) * scX;
ctx.beginPath(); ctx.arc(px, c.height/2 - 15, 4, 0, 2*PI); ctx.fill();
}
}
}

// Axis labels
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('t', c.width/2, c.height - 15);

} else if(viz === 'theta') {
// Plot Œ∏(t)
const gMin = points[0].g, gMax = points[points.length-1].g;
const scX = w / (gMax - gMin);
const yMin = startN * PI - PI, yMax = (startN + maxN) * PI + PI;
const scY = h / (yMax - yMin);

// Draw Œ∏(t)
ctx.strokeStyle = '#9664ff'; ctx.lineWidth = 2;
ctx.beginPath();
const steps = 500;
for(let i = 0; i <= steps; i++) {
const t = gMin + i * (gMax - gMin) / steps;
const th = thetaRS(t);
const px = pad + (t - gMin) * scX;
const py = c.height - pad - (th - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();

// Draw nœÄ lines
ctx.strokeStyle = 'rgba(255,215,0,0.4)'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
for(let n = startN; n <= startN + maxN; n++) {
const py = c.height - pad - (n * PI - yMin) * scY;
ctx.beginPath(); ctx.moveTo(pad, py); ctx.lineTo(c.width - pad, py); ctx.stroke();
}
ctx.setLineDash([]);

// Mark Gram points
ctx.fillStyle = '#ffd700';
for(const pt of points) {
const px = pad + (pt.g - gMin) * scX;
const py = c.height - pad - (pt.n * PI - yMin) * scY;
ctx.beginPath(); ctx.arc(px, py, 5, 0, 2*PI); ctx.fill();
}

ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('t', c.width/2, c.height - 15);
ctx.save(); ctx.translate(15, c.height/2); ctx.rotate(-PI/2); ctx.fillText('Œ∏(t)', 0, 0); ctx.restore();

} else if(viz === 'violations') {
// Bar chart of zeros per interval
const scX = w / intervals.length;
const maxCount = Math.max(...intervals.map(iv => iv.count), 3);
const scY = h / maxCount;

for(let i = 0; i < intervals.length; i++) {
const iv = intervals[i];
const px = pad + i * scX;
const barH = iv.count * scY;
const clr = iv.count === 0 ? '#ff6496' : iv.count === 1 ? '#00ff88' : '#ffd700';
ctx.fillStyle = clr;
ctx.fillRect(px + 2, c.height - pad - barH, scX - 4, barH);
}

// Reference line at 1
ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2; ctx.setLineDash([5,3]);
const y1 = c.height - pad - scY;
ctx.beginPath(); ctx.moveTo(pad, y1); ctx.lineTo(c.width - pad, y1); ctx.stroke();
ctx.setLineDash([]);

ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('Gram Interval', c.width/2, c.height - 15);
ctx.save(); ctx.translate(15, c.height/2); ctx.rotate(-PI/2); ctx.fillText('Zero Count', 0, 0); ctx.restore();
}

// Title
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800'; ctx.font = 'bold 14px Segoe UI'; ctx.textAlign = 'center';
ctx.fillText(`Gram Points g_${startN} to g_${startN + maxN - 1}`, c.width/2, 25);

// Stats
const lawSatisfied = points.filter(p => p.satisfiesLaw).length;
const lawPercent = lawSatisfied / points.length * 100;
const totalZeros = intervals.reduce((s, iv) => s + iv.count, 0);

legend('algram', 'Gram Points', [
['Gram Points', points.length, '#00d9ff'],
["Gram's Law %", fmt(lawPercent) + '%', '#00ff88'],
['Violations', violations, '#ff6496']
]);

document.getElementById('gramLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${points.length}</div><div style="font-size:.7rem;color:var(--txt2)">GRAM POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${fmt(lawPercent)}%</div><div style="font-size:.7rem;color:var(--txt2)">GRAM'S LAW</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${violations}</div><div style="font-size:.7rem;color:var(--txt2)">VIOLATIONS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Gram Point Values</strong>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;font-size:.75rem;font-family:monospace">
${points.slice(0, 8).map(p => `<span style="background:var(--bg1);padding:2px 6px;border-radius:3px;color:${p.satisfiesLaw ? '#00ff88' : '#ff6496'}">g${p.n}=${p.g.toFixed(3)}</span>`).join('')}
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Interval Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Total zeros:</span><span style="color:#ffd700">${totalZeros}</span>
<span>Intervals with 0:</span><span style="color:#ff6496">${intervals.filter(iv => iv.count === 0).length}</span>
<span>Intervals with 1:</span><span style="color:#00ff88">${intervals.filter(iv => iv.count === 1).length}</span>
<span>Intervals with 2+:</span><span style="color:#ffd700">${intervals.filter(iv => iv.count >= 2).length}</span>
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">Gram's Law</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">(-1)‚ÅøZ(g_n)>0 holds ${fmt(lawPercent)}% (asymptotic: ~73%)</div>
</div>`;

// Plotly charts
const spacings = [];
for(let i = 1; i < points.length; i++) spacings.push(points[i].g - points[i-1].g);
Plotly.newPlot('pgramSpace', [{x: points.slice(1).map(p => p.n), y: spacings, type: 'scatter', mode: 'lines+markers', name: 'Spacing', line: {color: '#00d9ff'}}], {...plo(), xaxis: {title: 'n'}, yaxis: {title: 'g_n - g_{n-1}'}});

const countDist = {};
intervals.forEach(iv => { countDist[iv.count] = (countDist[iv.count] || 0) + 1; });
Plotly.newPlot('pgramCount', [{x: Object.keys(countDist).map(Number), y: Object.values(countDist), type: 'bar', marker: {color: Object.keys(countDist).map(k => k === '1' ? '#00ff88' : k === '0' ? '#ff6496' : '#ffd700')}}], {...plo(), xaxis: {title: 'Zeros per Interval'}, yaxis: {title: 'Count'}});

// Click handler
c.onclick = e => {
const rect = c.getBoundingClientRect();
const mx = (e.clientX - rect.left) * (c.width / rect.width);
const gMin = points[0].g, gMax = points[points.length-1].g;
const t = gMin + (mx - pad) / (w / (gMax - gMin));
const closest = points.reduce((a, b) => Math.abs(b.g - t) < Math.abs(a.g - t) ? b : a);
modal(`Gram Point g_${closest.n}`, [
['n', closest.n],
['g_n', closest.g.toFixed(10)],
['Z(g_n)', closest.z.toFixed(10)],
['Expected sign', closest.expectedSign > 0 ? '+' : '-'],
['Actual sign', closest.sign > 0 ? '+' : '-'],
["Gram's Law", closest.satisfiesLaw ? 'SATISFIED' : 'VIOLATED']
]);
};
}

async function screenshotGram() {
const n = document.getElementById('gramNv').value;
await screenshotUnified('cgram', 'gramLiveStats', `Gram Points ‚Äî n ‚â§ ${n}`, 'gram_points.png', {dashH: 320});
}

function csvGram() {
let s = 'n,g_n,Z_g_n,satisfies_law\n';
for(const p of gramData.points) s += `${p.n},${p.g},${p.z},${p.satisfiesLaw ? 1 : 0}\n`;
dl(s, 'gram_points.csv');
}

// ==================== EXPLICIT FORMULA ====================
let explicitData = {xs: [], piActual: [], liApprox: [], zeroSum: [], numZeros: 0};
let explicitAnimId = null;

// Li(x^œÅ) for complex œÅ = 1/2 + iŒ≥ (simplified real part approximation)
function liXrho(x, gamma) {
if(x <= 1) return 0;
const logx = Math.log(x);
const sqrtx = Math.sqrt(x);
// Li(x^œÅ) ‚âà -2 * Re(x^œÅ / œÅ) for large x
// x^œÅ = x^{1/2} * e^{iŒ≥ log x}
// Re(x^œÅ/œÅ) ‚âà x^{1/2} * cos(Œ≥ log x) / |œÅ|
const rhoMag = Math.sqrt(0.25 + gamma * gamma);
const phase = gamma * logx;
return -sqrtx * Math.cos(phase) / (rhoMag * logx) * 2;
}

function drawExplicit() {
const c = document.getElementById('cexplicit'), ctx = c.getContext('2d');
const maxX = +document.getElementById('explicitXv').value || 1000;
const numZeros = +document.getElementById('explicitZerosv').value || 20;
const viz = document.getElementById('explicitViz').value;
const showPi = document.getElementById('explicitShowPi').checked;
const showLi = document.getElementById('explicitShowLi').checked;
const showSum = document.getElementById('explicitShowSum').checked;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Compute prime counting
const primes = sievePrimes(maxX);
const piVals = new Array(maxX + 1).fill(0);
let pCount = 0;
for(let n = 2; n <= maxX; n++) {
if(primes.includes(n)) pCount++;
piVals[n] = pCount;
}

// Sample points
const samplePts = Math.min(300, maxX);
const step = Math.max(1, Math.floor(maxX / samplePts));
const xs = [], piActual = [], liApprox = [], zeroContrib = [], zeroSum = [];

for(let x = 10; x <= maxX; x += step) {
xs.push(x);
piActual.push(piVals[x]);
liApprox.push(logIntegral(x));

// Sum contributions from zeros
let sum = 0;
for(let i = 0; i < Math.min(numZeros, ZETA_ZEROS.length); i++) {
sum += liXrho(x, ZETA_ZEROS[i]);
}
zeroContrib.push(sum);
zeroSum.push(logIntegral(x) + sum - Math.log(2));
}

explicitData = {xs, piActual, liApprox, zeroContrib, zeroSum, numZeros};

const pad = 60, w = c.width - 2*pad, h = c.height - 2*pad;

// Y range
let yMin = 0, yMax = Math.max(...piActual) * 1.1;
if(viz === 'error') {
const errors = piActual.map((p, i) => p - zeroSum[i]);
yMin = Math.min(...errors) - 5;
yMax = Math.max(...errors) + 5;
} else if(viz === 'oscillations') {
yMin = Math.min(...zeroContrib) * 1.2;
yMax = Math.max(...zeroContrib) * 1.2;
}

const scX = w / (maxX - 10), scY = h / (yMax - yMin);

// Grid
ctx.strokeStyle = gridC(); ctx.lineWidth = 0.5;
for(let i = 0; i <= 10; i++) {
const gx = pad + i * w / 10, gy = pad + i * h / 10;
ctx.beginPath(); ctx.moveTo(gx, pad); ctx.lineTo(gx, c.height - pad); ctx.stroke();
ctx.beginPath(); ctx.moveTo(pad, gy); ctx.lineTo(c.width - pad, gy); ctx.stroke();
}

// Zero line for oscillations/error
if(yMin < 0 && yMax > 0) {
const y0 = c.height - pad + yMin * scY;
ctx.strokeStyle = 'rgba(255,215,0,0.5)'; ctx.lineWidth = 1;
ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(c.width - pad, y0); ctx.stroke();
}

if(viz === 'buildup' || viz === 'cumulative') {
// Draw Li(x)
if(showLi) {
ctx.strokeStyle = '#ff6496'; ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = pad + (xs[i] - 10) * scX;
const py = c.height - pad - (liApprox[i] - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
}

// Draw approximation with zeros
if(showSum) {
ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = pad + (xs[i] - 10) * scX;
const py = c.height - pad - (zeroSum[i] - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
}

// Draw actual œÄ(x)
if(showPi) {
ctx.strokeStyle = '#00d9ff'; ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = pad + (xs[i] - 10) * scX;
const py = c.height - pad - (piActual[i] - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
}
} else if(viz === 'error') {
const errors = piActual.map((p, i) => p - zeroSum[i]);
ctx.strokeStyle = '#ff6496'; ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = pad + (xs[i] - 10) * scX;
const py = c.height - pad - (errors[i] - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
} else if(viz === 'oscillations') {
// Individual zero contributions
const colors = ['#ff6496', '#ffd700', '#00d9ff', '#9664ff', '#00ff88'];
for(let z = 0; z < Math.min(5, numZeros); z++) {
ctx.strokeStyle = colors[z % colors.length]; ctx.lineWidth = 1.5;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const contrib = liXrho(xs[i], ZETA_ZEROS[z]);
const px = pad + (xs[i] - 10) * scX;
const py = c.height - pad - (contrib - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
}
}

// Legend
const legendItems = [];
if(showPi) legendItems.push(['œÄ(x)', '#00d9ff']);
if(showLi) legendItems.push(['Li(x)', '#ff6496']);
if(showSum) legendItems.push([`Li-Œ£ (${numZeros} zeros)`, '#ffd700']);
ctx.font = '10px Segoe UI';
let lx = pad + 10;
for(const [txt, clr] of legendItems) {
ctx.fillStyle = clr; ctx.fillRect(lx, 35, 12, 12);
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.fillText(txt, lx + 16, 45);
lx += ctx.measureText(txt).width + 30;
}

// Title
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800'; ctx.font = 'bold 14px Segoe UI'; ctx.textAlign = 'center';
ctx.fillText(`Explicit Formula ‚Äî x ‚â§ ${maxX}, ${numZeros} zeros`, c.width/2, 25);

// Labels
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.textAlign = 'center'; ctx.fillText('x', c.width/2, c.height - 15);

// Stats
const finalPi = piActual[piActual.length - 1];
const finalLi = liApprox[liApprox.length - 1];
const finalSum = zeroSum[zeroSum.length - 1];
const errorLi = finalPi - finalLi;
const errorSum = finalPi - finalSum;

legend('alexplicit', 'Explicit Formula', [
['œÄ(x)', finalPi, '#00d9ff'],
['Li(x)', fmt(finalLi), '#ff6496'],
['With Zeros', fmt(finalSum), '#ffd700']
]);

document.getElementById('explicitLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${finalPi}</div><div style="font-size:.7rem;color:var(--txt2)">œÄ(${maxX})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${numZeros}</div><div style="font-size:.7rem;color:var(--txt2)">ZEROS USED</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${fmt(Math.abs(errorSum))}</div><div style="font-size:.7rem;color:var(--txt2)">ERROR</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Approximation Quality</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Li(x) error:</span><span style="color:#ff6496">${fmt(errorLi)}</span>
<span>With zeros error:</span><span style="color:#ffd700">${fmt(errorSum)}</span>
<span>Improvement:</span><span style="color:#00ff88">${fmt(Math.abs(errorLi) - Math.abs(errorSum))}</span>
<span>Rel error:</span><span style="color:#9664ff">${fmt(Math.abs(errorSum/finalPi)*100)}%</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Zeros Used</strong>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;font-size:.7rem;font-family:monospace">
${ZETA_ZEROS.slice(0, Math.min(10, numZeros)).map((z, i) => `<span style="background:var(--bg1);padding:2px 4px;border-radius:3px">Œ≥${i+1}=${z.toFixed(2)}</span>`).join('')}
</div>
</div>
<div style="background:rgba(0,255,136,.1);padding:8px;border-radius:6px">
<strong style="color:#00ff88">RH Implication</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">All zeros at Re=¬Ω ‚Üí oscillations decay like ‚àöx</div>
</div>`;

// Plotly charts
const contribs = ZETA_ZEROS.slice(0, Math.min(20, numZeros)).map((g, i) => ({
gamma: g,
contrib: liXrho(maxX, g)
}));
Plotly.newPlot('pexplicitContrib', [{x: contribs.map(c => c.gamma), y: contribs.map(c => c.contrib), type: 'bar', marker: {color: '#9664ff'}}], {...plo(), xaxis: {title: 'Œ≥ (zero imaginary part)'}, yaxis: {title: 'Contribution at x=' + maxX}});

const errors = xs.map((x, i) => piActual[i] - zeroSum[i]);
Plotly.newPlot('pexplicitError', [{x: xs, y: errors, type: 'scatter', mode: 'lines', line: {color: '#ff6496'}}], {...plo(), xaxis: {title: 'x'}, yaxis: {title: 'œÄ(x) - Approximation'}});

// Click handler
c.onclick = e => {
const rect = c.getBoundingClientRect();
const mx = (e.clientX - rect.left) * (c.width / rect.width);
const x = Math.round(10 + (mx - pad) / scX);
if(x >= 10 && x <= maxX) {
const pi = piVals[x];
const li = logIntegral(x);
let zSum = 0;
for(let i = 0; i < numZeros; i++) zSum += liXrho(x, ZETA_ZEROS[i]);
const approx = li + zSum - Math.log(2);
modal(`Explicit Formula at x = ${x}`, [
['x', x],
['œÄ(x)', pi],
['Li(x)', fmt(li)],
['Zero sum', fmt(zSum)],
['Approximation', fmt(approx)],
['Error', fmt(pi - approx)]
]);
}
};
}

function animateExplicit() {
stopExplicitAnim();
let n = 0;
const maxN = +document.getElementById('explicitZerosv').value || 20;
function step() {
document.getElementById('explicitZerosv').value = n;
drawExplicit();
n++;
if(n <= maxN) explicitAnimId = setTimeout(step, 300);
}
step();
}

function stopExplicitAnim() {
if(explicitAnimId) { clearTimeout(explicitAnimId); explicitAnimId = null; }
}

async function screenshotExplicit() {
const x = document.getElementById('explicitXv').value;
const n = document.getElementById('explicitZerosv').value;
await screenshotUnified('cexplicit', 'explicitLiveStats', `Explicit Formula ‚Äî x ‚â§ ${x}, ${n} zeros`, 'explicit_formula.png', {dashH: 320});
}

function csvExplicit() {
let s = 'x,pi_x,Li_x,zero_contrib,approximation,error\n';
for(let i = 0; i < explicitData.xs.length; i++) {
s += `${explicitData.xs[i]},${explicitData.piActual[i]},${explicitData.liApprox[i]},${explicitData.zeroContrib[i]},${explicitData.zeroSum[i]},${explicitData.piActual[i] - explicitData.zeroSum[i]}\n`;
}
dl(s, 'explicit_formula.csv');
}

// ==================== ZERO COUNTING N(T) ====================
let zcountData = {T: [], N: [], approx: [], S: []};

function riemannVonMangoldt(T) {
// N(T) ~ (T/2œÄ)log(T/2œÄe) + 7/8
if(T < 1) return 0;
return (T / (2*PI)) * Math.log(T / (2*PI*Math.E)) + 7/8;
}

function countZerosUpTo(T) {
let count = 0;
for(const gamma of ZETA_ZEROS) {
if(gamma <= T) count++;
else break;
}
return count;
}

function drawZeroCount() {
const c = document.getElementById('czerocount'), ctx = c.getContext('2d');
const maxT = +document.getElementById('zcountTv').value || 100;
const viz = document.getElementById('zcountViz').value;
const showApprox = document.getElementById('zcountShowApprox').checked;
const showZeros = document.getElementById('zcountShowZeros').checked;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Compute data
const Tvals = [], Nvals = [], approxVals = [], Svals = [];
const step = Math.max(0.5, maxT / 500);
for(let T = 1; T <= maxT; T += step) {
const N = countZerosUpTo(T);
const approx = riemannVonMangoldt(T);
Tvals.push(T); Nvals.push(N); approxVals.push(approx); Svals.push(N - approx);
}
zcountData = {T: Tvals, N: Nvals, approx: approxVals, S: Svals};

const zerosInRange = ZETA_ZEROS.filter(g => g <= maxT);
const finalN = countZerosUpTo(maxT);
const finalApprox = riemannVonMangoldt(maxT);

const pad = 60, w = c.width - 2*pad, h = c.height - 2*pad;

let yMin, yMax, yData;
if(viz === 'error') {
yData = Svals;
yMin = Math.min(...Svals) - 0.5; yMax = Math.max(...Svals) + 0.5;
} else if(viz === 'stairs') {
yData = Nvals;
yMin = 0; yMax = Math.max(...Nvals) * 1.1;
} else {
yData = Nvals;
yMin = 0; yMax = Math.max(...Nvals, ...approxVals) * 1.1;
}

const scX = w / maxT, scY = h / (yMax - yMin);

// Grid
ctx.strokeStyle = gridC(); ctx.lineWidth = 0.5;
for(let i = 0; i <= 10; i++) {
const gx = pad + i * w / 10, gy = pad + i * h / 10;
ctx.beginPath(); ctx.moveTo(gx, pad); ctx.lineTo(gx, c.height - pad); ctx.stroke();
ctx.beginPath(); ctx.moveTo(pad, gy); ctx.lineTo(c.width - pad, gy); ctx.stroke();
}

// Zero line for error plot
if(viz === 'error') {
const y0 = c.height - pad + yMin * scY;
ctx.strokeStyle = 'rgba(255,215,0,0.5)'; ctx.lineWidth = 1;
ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(c.width - pad, y0); ctx.stroke();
}

// Draw approximation
if(showApprox && viz !== 'error') {
ctx.strokeStyle = '#ff6496'; ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < Tvals.length; i++) {
const px = pad + Tvals[i] * scX;
const py = c.height - pad - (approxVals[i] - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
}

// Draw N(T) or S(T)
ctx.strokeStyle = viz === 'error' ? '#9664ff' : '#00d9ff'; ctx.lineWidth = 2;
if(viz === 'stairs') {
ctx.beginPath();
let prevY = c.height - pad;
for(let i = 0; i < zerosInRange.length; i++) {
const px = pad + zerosInRange[i] * scX;
const py = c.height - pad - ((i + 1) - yMin) * scY;
ctx.lineTo(px, prevY); ctx.lineTo(px, py);
prevY = py;
}
ctx.lineTo(c.width - pad, prevY);
ctx.stroke();
} else {
ctx.beginPath();
for(let i = 0; i < Tvals.length; i++) {
const px = pad + Tvals[i] * scX;
const py = c.height - pad - (yData[i] - yMin) * scY;
if(i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
}
ctx.stroke();
}

// Mark zeros
if(showZeros && viz !== 'error') {
ctx.fillStyle = '#ffd700';
for(let i = 0; i < zerosInRange.length; i++) {
const px = pad + zerosInRange[i] * scX;
const py = c.height - pad - ((i + 1) - yMin) * scY;
ctx.beginPath(); ctx.arc(px, py, 4, 0, 2*PI); ctx.fill();
}
}

// Title & labels
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800'; ctx.font = 'bold 14px Segoe UI'; ctx.textAlign = 'center';
ctx.fillText(`Zero Counting N(T) ‚Äî T ‚â§ ${maxT}`, c.width/2, 25);
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.fillText('T', c.width/2, c.height - 15);
ctx.save(); ctx.translate(15, c.height/2); ctx.rotate(-PI/2);
ctx.fillText(viz === 'error' ? 'S(T)' : 'N(T)', 0, 0); ctx.restore();

legend('alzerocount', 'N(T)', [['N(T)', finalN, '#00d9ff'], ['Approx', fmt(finalApprox), '#ff6496'], ['S(T)', fmt(finalN - finalApprox), '#9664ff']]);

document.getElementById('zcountLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${finalN}</div><div style="font-size:.7rem;color:var(--txt2)">N(${maxT})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${fmt(finalApprox)}</div><div style="font-size:.7rem;color:var(--txt2)">R-vM APPROX</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#9664ff">${fmt(finalN - finalApprox)}</div><div style="font-size:.7rem;color:var(--txt2)">S(T) ERROR</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Zeros in Range</strong>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;font-size:.7rem;font-family:monospace">
${zerosInRange.slice(0, 10).map((z, i) => `<span style="background:var(--bg1);padding:2px 4px;border-radius:3px">Œ≥${i+1}=${z.toFixed(2)}</span>`).join('')}
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">Riemann-von Mangoldt</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">N(T) = (T/2œÄ)log(T/2œÄe) + 7/8 + S(T)</div>
</div>`;

Plotly.newPlot('pzcountGrowth', [
{x: Tvals, y: Nvals, name: 'N(T)', type: 'scatter', mode: 'lines', line: {color: '#00d9ff'}},
{x: Tvals, y: approxVals, name: 'Approx', type: 'scatter', mode: 'lines', line: {color: '#ff6496', dash: 'dash'}}
], {...plo(), xaxis: {title: 'T'}, yaxis: {title: 'N(T)'}});

Plotly.newPlot('pzcountS', [{x: Tvals, y: Svals, type: 'scatter', mode: 'lines', line: {color: '#9664ff'}}], {...plo(), xaxis: {title: 'T'}, yaxis: {title: 'S(T)'}});

c.onclick = e => {
const rect = c.getBoundingClientRect();
const T = (e.clientX - rect.left - pad) / scX * (c.width / rect.width);
if(T > 0 && T <= maxT) {
const N = countZerosUpTo(T);
const approx = riemannVonMangoldt(T);
modal(`Zero Count at T = ${fmt(T)}`, [['T', fmt(T)], ['N(T)', N], ['Approx', fmt(approx)], ['S(T)', fmt(N - approx)]]);
}
};
}

async function screenshotZeroCount() {
await screenshotUnified('czerocount', 'zcountLiveStats', `Zero Counting N(T)`, 'zero_count.png', {dashH: 280});
}

function csvZeroCount() {
let s = 'T,N_T,approx,S_T\n';
for(let i = 0; i < zcountData.T.length; i++) s += `${zcountData.T[i]},${zcountData.N[i]},${zcountData.approx[i]},${zcountData.S[i]}\n`;
dl(s, 'zero_count.csv');
}

// ==================== ZETA ARGAND (DOMAIN COLORING) ====================
// Complex zeta approximation
function zetaComplex(sigma, t, terms = 50) {
// For sigma > 1, series converges well
if(sigma > 1) {
let re = 0, im = 0;
for(let n = 1; n <= terms; n++) {
const mag = Math.pow(n, -sigma);
const phase = -t * Math.log(n);
re += mag * Math.cos(phase);
im += mag * Math.sin(phase);
}
return {re, im};
}
// For critical strip and left half-plane, use Dirichlet eta with more terms
// Œ∑(s) = (1 - 2^{1-s}) Œ∂(s), so Œ∂(s) = Œ∑(s) / (1 - 2^{1-s})
let etaRe = 0, etaIm = 0;
const useTerms = Math.max(terms * 3, 150);
for(let n = 1; n <= useTerms; n++) {
const sign = (n % 2 === 1) ? 1 : -1;
const mag = Math.pow(n, -sigma);
const phase = -t * Math.log(n);
etaRe += sign * mag * Math.cos(phase);
etaIm += sign * mag * Math.sin(phase);
}
// Compute 1 - 2^{1-s} = 1 - 2^{1-sigma} * e^{-it*log(2)}
const pow2 = Math.pow(2, 1 - sigma);
const phase2 = -t * Math.log(2);
const denom_re = 1 - pow2 * Math.cos(phase2);
const denom_im = pow2 * Math.sin(phase2);
const denom_mag = denom_re * denom_re + denom_im * denom_im;
if(denom_mag < 1e-10) return {re: 1e10, im: 0}; // Near pole
// Œ∂ = Œ∑ / denom (complex division)
const re = (etaRe * denom_re + etaIm * denom_im) / denom_mag;
const im = (etaIm * denom_re - etaRe * denom_im) / denom_mag;
return {re, im};
}

function drawArgand() {
const c = document.getElementById('cargand'), ctx = c.getContext('2d');
const s1 = +document.getElementById('argandS1').value;
const s2 = +document.getElementById('argandS2').value;
const t1 = +document.getElementById('argandT1').value;
const t2 = +document.getElementById('argandT2').value;
const res = +document.getElementById('argandRes').value;
const colMode = document.getElementById('argandCol').value;
const showCrit = document.getElementById('argandShowCrit').checked;
const showZeros = document.getElementById('argandShowZeros').checked;
const showPole = document.getElementById('argandShowPole').checked;

const imgData = ctx.createImageData(c.width, c.height);
const dSigma = (s2 - s1) / c.width;
const dT = (t2 - t1) / c.height;

for(let py = 0; py < c.height; py++) {
const t = t2 - py * dT;
for(let px = 0; px < c.width; px++) {
const sigma = s1 + px * dSigma;
const z = zetaComplex(sigma, t, Math.min(res, 100));
const mag = Math.sqrt(z.re * z.re + z.im * z.im);
const phase = Math.atan2(z.im, z.re);

let r, g, b;
if(colMode === 'phase') {
const hue = (phase + PI) / (2 * PI);
const sat = 0.8;
const light = 0.5 + 0.3 * Math.tanh(Math.log(mag + 0.1));
[r, g, b] = hslToRgb(hue, sat, light);
} else if(colMode === 'modulus') {
const v = Math.tanh(mag / 3);
r = g = b = Math.floor(v * 255);
} else if(colMode === 'logmod') {
const v = (Math.log(mag + 1) / 5 + 0.5);
r = g = b = Math.floor(Math.min(1, Math.max(0, v)) * 255);
} else if(colMode === 'real') {
const v = Math.tanh(z.re / 2);
r = v > 0 ? Math.floor(v * 255) : 0;
b = v < 0 ? Math.floor(-v * 255) : 0;
g = 0;
} else {
const v = Math.tanh(z.im / 2);
r = v > 0 ? Math.floor(v * 255) : 0;
b = v < 0 ? Math.floor(-v * 255) : 0;
g = 0;
}

const idx = (py * c.width + px) * 4;
imgData.data[idx] = r;
imgData.data[idx + 1] = g;
imgData.data[idx + 2] = b;
imgData.data[idx + 3] = 255;
}
}
ctx.putImageData(imgData, 0, 0);

// Critical line
if(showCrit) {
const critX = (0.5 - s1) / (s2 - s1) * c.width;
ctx.strokeStyle = 'rgba(255,255,255,0.7)'; ctx.lineWidth = 2; ctx.setLineDash([5, 3]);
ctx.beginPath(); ctx.moveTo(critX, 0); ctx.lineTo(critX, c.height); ctx.stroke();
ctx.setLineDash([]);
}

// Zeros
if(showZeros) {
ctx.fillStyle = '#ffd700';
for(const gamma of ZETA_ZEROS) {
if(gamma >= t1 && gamma <= t2) {
const px = (0.5 - s1) / (s2 - s1) * c.width;
const py = (t2 - gamma) / (t2 - t1) * c.height;
ctx.beginPath(); ctx.arc(px, py, 4, 0, 2*PI); ctx.fill();
}
if(-gamma >= t1 && -gamma <= t2) {
const px = (0.5 - s1) / (s2 - s1) * c.width;
const py = (t2 - (-gamma)) / (t2 - t1) * c.height;
ctx.beginPath(); ctx.arc(px, py, 4, 0, 2*PI); ctx.fill();
}
}
}

// Pole at s=1
if(showPole && s1 < 1 && s2 > 1 && t1 < 0 && t2 > 0) {
const px = (1 - s1) / (s2 - s1) * c.width;
const py = (t2 - 0) / (t2 - t1) * c.height;
ctx.strokeStyle = '#ff0000'; ctx.lineWidth = 2;
ctx.beginPath(); ctx.arc(px, py, 8, 0, 2*PI); ctx.stroke();
ctx.fillStyle = '#ff0000'; ctx.font = '12px Segoe UI';
ctx.fillText('pole', px + 12, py);
}

// Axes labels
ctx.fillStyle = '#fff'; ctx.font = '11px Segoe UI';
ctx.fillText(`œÉ=${s1}`, 5, c.height - 5);
ctx.fillText(`œÉ=${s2}`, c.width - 40, c.height - 5);
ctx.fillText(`t=${t2}`, 5, 15);
ctx.fillText(`t=${t1}`, 5, c.height - 20);

legend('alargand', 'Œ∂(s) Domain', [['Re range', `[${s1},${s2}]`, '#00d9ff'], ['Im range', `[${t1},${t2}]`, '#ff6496']]);

const zerosVis = ZETA_ZEROS.filter(g => g >= t1 && g <= t2).length * 2;
document.getElementById('argandLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">[${s1}, ${s2}]</div><div style="font-size:.7rem;color:var(--txt2)">œÉ RANGE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">[${t1}, ${t2}]</div><div style="font-size:.7rem;color:var(--txt2)">t RANGE</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Visible Features</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Zeros visible:</span><span style="color:#ffd700">${zerosVis}</span>
<span>Critical line:</span><span style="color:#00ff88">${showCrit ? 'œÉ=¬Ω' : 'hidden'}</span>
<span>Pole:</span><span style="color:#ff6496">${s1 < 1 && s2 > 1 ? 's=1' : 'out of view'}</span>
<span>Color:</span><span style="color:#9664ff">${colMode}</span>
</div>
</div>
<div style="background:rgba(255,215,0,.1);padding:8px;border-radius:6px">
<strong style="color:#ffd700">Domain Coloring</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Hue = arg(Œ∂), brightness = |Œ∂|. Zeros show full color wheels.</div>
</div>`;
}

function hslToRgb(h, s, l) {
let r, g, b;
if(s === 0) { r = g = b = l; }
else {
const hue2rgb = (p, q, t) => {
if(t < 0) t += 1; if(t > 1) t -= 1;
if(t < 1/6) return p + (q - p) * 6 * t;
if(t < 1/2) return q;
if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
return p;
};
const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
const p = 2 * l - q;
r = hue2rgb(p, q, h + 1/3);
g = hue2rgb(p, q, h);
b = hue2rgb(p, q, h - 1/3);
}
return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

async function screenshotArgand() {
await screenshotUnified('cargand', 'argandLiveStats', `Œ∂(s) Domain Coloring`, 'zeta_argand.png', {dashH: 250});
}

// ==================== ZETA REAL AXIS ====================
let zetarealData = {s: [], zeta: []};

function zetaReal(s) {
if(s === 1) return Infinity;
if(s > 1) {
// Direct series
let sum = 0;
for(let n = 1; n <= 10000; n++) sum += Math.pow(n, -s);
return sum;
}
// Use stored values or functional equation approximation
if(s === 2) return ZETA2;
if(s === 3) return ZETA3;
if(s === 4) return ZETA4;
if(s === 0) return -0.5;
if(s === -1) return -1/12;
if(s < 0 && s === Math.floor(s) && s % 2 === 0) return 0; // Trivial zeros
// Approximation via reflection for other negative values
if(s < 0) {
const s1 = 1 - s;
const zeta1s = zetaReal(s1);
// Functional equation: Œ∂(s) = 2^s œÄ^{s-1} sin(œÄs/2) Œì(1-s) Œ∂(1-s)
const factor = Math.pow(2, s) * Math.pow(PI, s - 1) * Math.sin(PI * s / 2);
// Œì(1-s) approximation via Stirling for large 1-s
const gamma1s = gamma(1 - s);
return factor * gamma1s * zeta1s;
}
// 0 < s < 1: Dirichlet eta function
let sum = 0;
for(let n = 1; n <= 10000; n++) sum += Math.pow(-1, n + 1) * Math.pow(n, -s);
return sum / (1 - Math.pow(2, 1 - s));
}

function gamma(x) {
// Lanczos approximation
if(x < 0.5) return PI / (Math.sin(PI * x) * gamma(1 - x));
x -= 1;
const g = 7;
const c = [0.99999999999980993, 676.5203681218851, -1259.1392167224028, 771.32342877765313, -176.61502916214059, 12.507343278686905, -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
let sum = c[0];
for(let i = 1; i < g + 2; i++) sum += c[i] / (x + i);
const t = x + g + 0.5;
return Math.sqrt(2 * PI) * Math.pow(t, x + 0.5) * Math.exp(-t) * sum;
}

function drawZetaReal() {
const c = document.getElementById('czetareal'), ctx = c.getContext('2d');
const s1 = +document.getElementById('zetarealS1').value;
const s2 = +document.getElementById('zetarealS2').value;
const res = +document.getElementById('zetarealRes').value;
const yClamp = +document.getElementById('zetarealYclamp').value;
const showPole = document.getElementById('zetarealShowPole').checked;
const showTrivial = document.getElementById('zetarealShowTrivial').checked;
const showSpecial = document.getElementById('zetarealShowSpecial').checked;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const pad = 60, w = c.width - 2*pad, h = c.height - 2*pad;
const ds = (s2 - s1) / res;

const sVals = [], zVals = [];
for(let i = 0; i <= res; i++) {
const s = s1 + i * ds;
if(Math.abs(s - 1) < 0.01) continue; // Skip pole
const z = zetaReal(s);
if(isFinite(z) && Math.abs(z) < 1000) {
sVals.push(s); zVals.push(z);
}
}
zetarealData = {s: sVals, zeta: zVals};

const yMin = -yClamp, yMax = yClamp;
const scX = w / (s2 - s1), scY = h / (yMax - yMin);

// Grid
ctx.strokeStyle = gridC(); ctx.lineWidth = 0.5;
for(let i = 0; i <= 10; i++) {
const gx = pad + i * w / 10, gy = pad + i * h / 10;
ctx.beginPath(); ctx.moveTo(gx, pad); ctx.lineTo(gx, c.height - pad); ctx.stroke();
ctx.beginPath(); ctx.moveTo(pad, gy); ctx.lineTo(c.width - pad, gy); ctx.stroke();
}

// Zero line
const y0 = c.height - pad + yMin * scY;
ctx.strokeStyle = 'rgba(255,215,0,0.5)'; ctx.lineWidth = 1;
ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(c.width - pad, y0); ctx.stroke();

// Draw Œ∂(s)
ctx.strokeStyle = '#00d9ff'; ctx.lineWidth = 2;
ctx.beginPath();
let started = false;
for(let i = 0; i < sVals.length; i++) {
const px = pad + (sVals[i] - s1) * scX;
const clampedZ = Math.max(yMin, Math.min(yMax, zVals[i]));
const py = c.height - pad - (clampedZ - yMin) * scY;
if(!started) { ctx.moveTo(px, py); started = true; }
else if(Math.abs(zVals[i] - zVals[i-1]) < yClamp * 2) ctx.lineTo(px, py);
else { ctx.stroke(); ctx.beginPath(); ctx.moveTo(px, py); }
}
ctx.stroke();

// Pole indicator
if(showPole && s1 < 1 && s2 > 1) {
const poleX = pad + (1 - s1) * scX;
ctx.strokeStyle = '#ff6496'; ctx.lineWidth = 2; ctx.setLineDash([5, 3]);
ctx.beginPath(); ctx.moveTo(poleX, pad); ctx.lineTo(poleX, c.height - pad); ctx.stroke();
ctx.setLineDash([]);
ctx.fillStyle = '#ff6496'; ctx.font = '11px Segoe UI';
ctx.fillText('pole s=1', poleX + 5, pad + 15);
}

// Trivial zeros
if(showTrivial) {
ctx.fillStyle = '#9664ff';
for(let n = -2; n >= s1; n -= 2) {
const px = pad + (n - s1) * scX;
ctx.beginPath(); ctx.arc(px, y0, 6, 0, 2*PI); ctx.fill();
}
}

// Special values
if(showSpecial) {
const specials = [[2, ZETA2, 'Œ∂(2)=œÄ¬≤/6'], [3, ZETA3, 'Œ∂(3)‚âà1.202'], [4, ZETA4, 'Œ∂(4)'], [0, -0.5, 'Œ∂(0)=-¬Ω']];
ctx.fillStyle = '#ffd700';
for(const [s, z, label] of specials) {
if(s >= s1 && s <= s2) {
const px = pad + (s - s1) * scX;
const py = c.height - pad - (Math.max(yMin, Math.min(yMax, z)) - yMin) * scY;
ctx.beginPath(); ctx.arc(px, py, 5, 0, 2*PI); ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '10px Segoe UI';
ctx.fillText(label, px + 8, py - 5);
ctx.fillStyle = '#ffd700';
}
}
}

// Labels
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800'; ctx.font = 'bold 14px Segoe UI'; ctx.textAlign = 'center';
ctx.fillText(`Œ∂(s) on Real Axis ‚Äî s ‚àà [${s1}, ${s2}]`, c.width/2, 25);
ctx.fillStyle = isDark() ? '#fff' : '#000'; ctx.font = '12px Segoe UI';
ctx.fillText('s', c.width/2, c.height - 15);
ctx.save(); ctx.translate(15, c.height/2); ctx.rotate(-PI/2); ctx.fillText('Œ∂(s)', 0, 0); ctx.restore();

legend('alzetareal', 'Œ∂(s) Real', [['Œ∂(2)', fmt(ZETA2), '#ffd700'], ['Œ∂(3)', fmt(ZETA3), '#00d9ff'], ['Œ∂(0)', '-0.5', '#9664ff']]);

document.getElementById('zetarealLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ffd700">${ZETA2.toFixed(8)}</div><div style="font-size:.7rem;color:var(--txt2)">Œ∂(2) = œÄ¬≤/6</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#00d9ff">${ZETA3.toFixed(8)}</div><div style="font-size:.7rem;color:var(--txt2)">Œ∂(3) AP√âRY</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ff6496">-1/12</div><div style="font-size:.7rem;color:var(--txt2)">Œ∂(-1)</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Special Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Œ∂(2) = œÄ¬≤/6:</span><span style="color:#ffd700">${ZETA2.toFixed(10)}</span>
<span>Œ∂(4) = œÄ‚Å¥/90:</span><span style="color:#00d9ff">${ZETA4.toFixed(10)}</span>
<span>Œ∂(0):</span><span style="color:#9664ff">-0.5</span>
<span>Œ∂(-1):</span><span style="color:#ff6496">-1/12 ‚âà ${(-1/12).toFixed(10)}</span>
</div>
</div>
<div style="background:rgba(150,100,255,.1);padding:8px;border-radius:6px">
<strong style="color:#9664ff">Trivial Zeros</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Œ∂(-2)=Œ∂(-4)=Œ∂(-6)=...=0 from functional equation</div>
</div>`;

const specVals = [2, 3, 4, 5, 6, 7, 8].map(n => ({n, z: zeta(n)}));
Plotly.newPlot('pzetarealSpecial', [{x: specVals.map(v => v.n), y: specVals.map(v => v.z), type: 'bar', marker: {color: '#ffd700'}}], {...plo(), xaxis: {title: 'n'}, yaxis: {title: 'Œ∂(n)'}});

const nearPole = [];
for(let s = 1.01; s <= 2; s += 0.05) nearPole.push({s, z: zetaReal(s)});
Plotly.newPlot('pzetarealPole', [{x: nearPole.map(v => v.s), y: nearPole.map(v => v.z), type: 'scatter', mode: 'lines+markers', line: {color: '#ff6496'}}], {...plo(), xaxis: {title: 's'}, yaxis: {title: 'Œ∂(s)'}});

c.onclick = e => {
const rect = c.getBoundingClientRect();
const s = s1 + (e.clientX - rect.left - pad) / scX;
if(s >= s1 && s <= s2 && Math.abs(s - 1) > 0.05) {
const z = zetaReal(s);
modal(`Œ∂(${fmt(s)})`, [['s', fmt(s)], ['Œ∂(s)', fmt(z)], ['1/Œ∂(s)', fmt(1/z)]]);
}
};
}

async function screenshotZetaReal() {
await screenshotUnified('czetareal', 'zetarealLiveStats', `Œ∂(s) on Real Axis`, 'zeta_real.png', {dashH: 280});
}

function csvZetaReal() {
let s = 's,zeta_s\n';
for(let i = 0; i < zetarealData.s.length; i++) s += `${zetarealData.s[i]},${zetarealData.zeta[i]}\n`;
dl(s, 'zeta_real.csv');
}

// ==================== MONTGOMERY PAIR CORRELATION ====================
let montgomeryData = {gaps: [], normalized: []};

function drawMontgomery() {
const c = document.getElementById('cmontgomery'), ctx = c.getContext('2d');
const N = Math.min(+document.getElementById('montNv').value || 50, ZETA_ZEROS.length);
const binWidth = +document.getElementById('montBin').value || 0.1;
const mode = document.getElementById('montMode').value;
const showGUE = document.getElementById('montGUE').checked;

// Compute normalized gaps
const zeros = ZETA_ZEROS.slice(0, N);
const gaps = [];
for(let i = 1; i < zeros.length; i++) {
const gap = zeros[i] - zeros[i-1];
// Normalize by average spacing: 2œÄ/log(Œ≥_i)
const avgSpacing = 2 * PI / Math.log(zeros[i] / (2 * PI));
gaps.push(gap / avgSpacing);
}
montgomeryData = {gaps, normalized: gaps};

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const margin = {l: 60, r: 30, t: 40, b: 50};
const w = c.width - margin.l - margin.r;
const h = c.height - margin.t - margin.b;

if(mode === 'histogram') {
// Create histogram
const maxGap = Math.max(...gaps, 3);
const bins = Math.ceil(maxGap / binWidth);
const hist = Array(bins).fill(0);
gaps.forEach(g => {
const bin = Math.min(Math.floor(g / binWidth), bins - 1);
if(bin >= 0) hist[bin]++;
});
const maxCount = Math.max(...hist);

// Draw bars
ctx.fillStyle = '#00d9ff';
for(let i = 0; i < bins; i++) {
const x = margin.l + (i / bins) * w;
const barW = w / bins - 1;
const barH = (hist[i] / maxCount) * h;
ctx.fillRect(x, margin.t + h - barH, barW, barH);
}

// GUE pair correlation prediction: 1 - (sin(œÄx)/(œÄx))¬≤
if(showGUE) {
ctx.strokeStyle = '#ff6496';
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i <= 100; i++) {
const x = (i / 100) * maxGap;
const px = margin.l + (x / maxGap) * w;
// Pair correlation R2(x) = 1 - (sin(œÄx)/(œÄx))¬≤ for x > 0
const sinc = x < 0.01 ? 1 : Math.sin(PI * x) / (PI * x);
const r2 = 1 - sinc * sinc;
const py = margin.t + h - r2 * h;
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();
ctx.fillStyle = '#ff6496';
ctx.font = '11px Segoe UI';
ctx.fillText('GUE: 1-(sin œÄx/œÄx)¬≤', c.width - 130, margin.t + 20);
}

// Axes
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(margin.l, margin.t);
ctx.lineTo(margin.l, margin.t + h);
ctx.lineTo(margin.l + w, margin.t + h);
ctx.stroke();

ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '11px Segoe UI';
ctx.fillText('Normalized Gap', margin.l + w/2 - 40, c.height - 10);
ctx.save();
ctx.translate(15, margin.t + h/2);
ctx.rotate(-Math.PI/2);
ctx.fillText('Count', 0, 0);
ctx.restore();
} else if(mode === 'scatter') {
// Scatter plot of consecutive gaps
ctx.fillStyle = '#00d9ff';
for(let i = 0; i < gaps.length - 1; i++) {
const x = margin.l + (gaps[i] / 4) * w;
const y = margin.t + h - (gaps[i+1] / 4) * h;
ctx.beginPath();
ctx.arc(x, y, 3, 0, 2*PI);
ctx.fill();
}
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.beginPath();
ctx.moveTo(margin.l, margin.t);
ctx.lineTo(margin.l, margin.t + h);
ctx.lineTo(margin.l + w, margin.t + h);
ctx.stroke();
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '11px Segoe UI';
ctx.fillText('Gap n', margin.l + w/2, c.height - 10);
ctx.fillText('Gap n+1', 20, margin.t + h/2);
} else {
// Cumulative distribution
const sorted = [...gaps].sort((a,b) => a - b);
ctx.strokeStyle = '#00d9ff';
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < sorted.length; i++) {
const x = margin.l + (sorted[i] / 4) * w;
const y = margin.t + h - ((i + 1) / sorted.length) * h;
if(i === 0) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
}
ctx.stroke();

// GUE CDF
if(showGUE) {
ctx.strokeStyle = '#ff6496';
ctx.beginPath();
for(let i = 0; i <= 100; i++) {
const x = (i / 100) * 4;
const px = margin.l + (x / 4) * w;
// Approximate Wigner surmise CDF
const cdf = 1 - Math.exp(-PI * x * x / 4);
const py = margin.t + h - cdf * h;
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();
}
}

// Stats
const meanGap = gaps.reduce((a,b) => a+b, 0) / gaps.length;
const variance = gaps.reduce((a,g) => a + (g - meanGap)**2, 0) / gaps.length;

legend('almontgomery', 'Pair Correlation', [['Zeros', N, '#00d9ff'], ['Mean Gap', fmt(meanGap), '#ffd700'], ['Variance', fmt(variance), '#ff6496']]);

document.getElementById('montLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${N}</div><div style="font-size:.7rem;color:var(--txt2)">ZEROS ANALYZED</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${fmt(meanGap)}</div><div style="font-size:.7rem;color:var(--txt2)">MEAN NORMALIZED GAP</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${fmt(Math.sqrt(variance))}</div><div style="font-size:.7rem;color:var(--txt2)">STD DEVIATION</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Gap Statistics</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Min gap:</span><span style="color:#00d9ff">${fmt(Math.min(...gaps))}</span>
<span>Max gap:</span><span style="color:#ff6496">${fmt(Math.max(...gaps))}</span>
<span>GUE mean:</span><span style="color:#9664ff">1.0 (normalized)</span>
<span>Actual mean:</span><span style="color:#ffd700">${fmt(meanGap)}</span>
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">Montgomery's Discovery</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">The pair correlation follows R‚ÇÇ(x) = 1 - (sin œÄx / œÄx)¬≤, matching GUE random matrices!</div>
</div>`;
}

async function screenshotMontgomery() {
await screenshotUnified('cmontgomery', 'montLiveStats', 'Montgomery Pair Correlation', 'montgomery.png');
}

function csvMontgomery() {
let s = 'gap_index,normalized_gap\n';
montgomeryData.gaps.forEach((g, i) => s += `${i},${g}\n`);
dl(s, 'montgomery.csv');
}

// ==================== GUE STATISTICS ====================
let gueData = {spacings: []};

function drawGUE() {
const c = document.getElementById('cgue'), ctx = c.getContext('2d');
const N = Math.min(+document.getElementById('gueNv').value || 50, ZETA_ZEROS.length);
const mode = document.getElementById('gueMode').value;
const showWigner = document.getElementById('gueWigner').checked;
const showPoisson = document.getElementById('guePoisson').checked;

const zeros = ZETA_ZEROS.slice(0, N);

// Unfold zeros: transform to have unit mean spacing
const unfolded = zeros.map(gamma => {
// N(T) ~ T/(2œÄ) log(T/(2œÄe)) + 7/8
return (gamma / (2*PI)) * Math.log(gamma / (2*PI*Math.E)) + 7/8;
});

// Compute spacings
const spacings = [];
for(let i = 1; i < unfolded.length; i++) {
spacings.push(unfolded[i] - unfolded[i-1]);
}
gueData.spacings = spacings;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const margin = {l: 60, r: 30, t: 40, b: 50};
const w = c.width - margin.l - margin.r;
const h = c.height - margin.t - margin.b;

if(mode === 'spacing' || mode === 'wigner') {
// Histogram of spacings
const maxS = Math.min(Math.max(...spacings), 4);
const bins = 20;
const binWidth = maxS / bins;
const hist = Array(bins).fill(0);
spacings.forEach(s => {
const bin = Math.min(Math.floor(s / binWidth), bins - 1);
if(bin >= 0) hist[bin]++;
});
// Normalize to probability density
const total = spacings.length * binWidth;
const density = hist.map(h => h / total);
const maxDensity = Math.max(...density, 1);

// Draw histogram
ctx.fillStyle = '#00d9ff';
for(let i = 0; i < bins; i++) {
const x = margin.l + (i / bins) * w;
const barW = w / bins - 1;
const barH = (density[i] / maxDensity) * h;
ctx.fillRect(x, margin.t + h - barH, barW, barH);
}

// Wigner surmise: P(s) = (œÄ/2)s exp(-œÄs¬≤/4)
if(showWigner) {
ctx.strokeStyle = '#ff6496';
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i <= 100; i++) {
const s = (i / 100) * maxS;
const px = margin.l + (s / maxS) * w;
const wigner = (PI / 2) * s * Math.exp(-PI * s * s / 4);
const py = margin.t + h - (wigner / maxDensity) * h;
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();
ctx.fillStyle = '#ff6496';
ctx.font = '11px Segoe UI';
ctx.fillText('Wigner: (œÄ/2)s¬∑e^{-œÄs¬≤/4}', c.width - 150, margin.t + 20);
}

// Poisson: P(s) = exp(-s)
if(showPoisson) {
ctx.strokeStyle = '#9664ff';
ctx.lineWidth = 2;
ctx.setLineDash([5, 3]);
ctx.beginPath();
for(let i = 0; i <= 100; i++) {
const s = (i / 100) * maxS;
const px = margin.l + (s / maxS) * w;
const poisson = Math.exp(-s);
const py = margin.t + h - (poisson / maxDensity) * h;
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();
ctx.setLineDash([]);
ctx.fillStyle = '#9664ff';
ctx.fillText('Poisson: e^{-s}', c.width - 150, margin.t + 40);
}
} else {
// Unfolded zeros plot
ctx.fillStyle = '#00d9ff';
for(let i = 0; i < unfolded.length; i++) {
const x = margin.l + (i / unfolded.length) * w;
const y = margin.t + h - (unfolded[i] / unfolded[unfolded.length-1]) * h;
ctx.beginPath();
ctx.arc(x, y, 3, 0, 2*PI);
ctx.fill();
}
// Line y = x (expected for unit density)
ctx.strokeStyle = '#ff6496';
ctx.lineWidth = 1;
ctx.setLineDash([5, 3]);
ctx.beginPath();
ctx.moveTo(margin.l, margin.t + h);
ctx.lineTo(margin.l + w, margin.t);
ctx.stroke();
ctx.setLineDash([]);
}

// Axes
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(margin.l, margin.t);
ctx.lineTo(margin.l, margin.t + h);
ctx.lineTo(margin.l + w, margin.t + h);
ctx.stroke();

const meanSpacing = spacings.reduce((a,b) => a+b, 0) / spacings.length;
const varSpacing = spacings.reduce((a,s) => a + (s - meanSpacing)**2, 0) / spacings.length;

legend('algue', 'GUE Statistics', [['Zeros', N, '#00d9ff'], ['Mean Spacing', fmt(meanSpacing), '#ffd700'], ['Std Dev', fmt(Math.sqrt(varSpacing)), '#ff6496']]);

document.getElementById('gueLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${N}</div><div style="font-size:.7rem;color:var(--txt2)">ZEROS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${fmt(meanSpacing)}</div><div style="font-size:.7rem;color:var(--txt2)">MEAN SPACING</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${fmt(Math.sqrt(varSpacing))}</div><div style="font-size:.7rem;color:var(--txt2)">STD DEV</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Comparison</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>GUE mean:</span><span style="color:#00d9ff">1.0</span>
<span>GUE variance:</span><span style="color:#ff6496">${fmt(4/PI - 1)} ‚âà 0.273</span>
<span>Poisson mean:</span><span style="color:#9664ff">1.0</span>
<span>Poisson variance:</span><span style="color:#9664ff">1.0</span>
</div>
</div>
<div style="background:rgba(255,100,150,.1);padding:8px;border-radius:6px">
<strong style="color:#ff6496">Key Difference</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">GUE: P(0) = 0 (zeros repel). Poisson: P(0) = max (no correlation). Zeta zeros follow GUE!</div>
</div>`;
}

async function screenshotGUE() {
await screenshotUnified('cgue', 'gueLiveStats', 'GUE Random Matrix Statistics', 'gue_stats.png');
}

function csvGUE() {
let s = 'index,spacing\n';
gueData.spacings.forEach((sp, i) => s += `${i},${sp}\n`);
dl(s, 'gue_spacings.csv');
}

// ==================== PRIME RACES ====================
let primeRaceData = {x: [], counts: {}, diff: []};

function drawPrimeRace() {
const c = document.getElementById('cprimerace'), ctx = c.getContext('2d');
const maxX = +document.getElementById('raceXv').value || 10000;
const q = +document.getElementById('raceQ').value;
const mode = document.getElementById('raceMode').value;

// Get residue classes to compare
let classes = [];
if(q === 4) classes = [1, 3];
else if(q === 3) classes = [1, 2];
else if(q === 8) classes = [1, 3, 5, 7];
else if(q === 5) classes = [1, 2, 3, 4];
else if(q === 6) classes = [1, 5];

// Count primes in each class
const counts = {};
classes.forEach(a => counts[a] = []);

const sieve = Array(maxX + 1).fill(true);
sieve[0] = sieve[1] = false;
for(let i = 2; i * i <= maxX; i++) {
if(sieve[i]) for(let j = i*i; j <= maxX; j += i) sieve[j] = false;
}

const current = {};
classes.forEach(a => current[a] = 0);

const xs = [];
const step = Math.max(1, Math.floor(maxX / 500));

for(let x = 2; x <= maxX; x++) {
if(sieve[x]) {
const r = x % q;
if(current[r] !== undefined) current[r]++;
}
if(x % step === 0 || x === maxX) {
xs.push(x);
classes.forEach(a => counts[a].push(current[a]));
}
}

primeRaceData = {x: xs, counts, diff: []};

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const margin = {l: 60, r: 30, t: 40, b: 50};
const w = c.width - margin.l - margin.r;
const h = c.height - margin.t - margin.b;

const colors = ['#00d9ff', '#ff6496', '#ffd700', '#00ff88'];

if(mode === 'both') {
// Plot all counts
const maxCount = Math.max(...classes.flatMap(a => counts[a]));
classes.forEach((a, ci) => {
ctx.strokeStyle = colors[ci % colors.length];
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = margin.l + (xs[i] / maxX) * w;
const py = margin.t + h - (counts[a][i] / maxCount) * h;
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();
});
// Legend
classes.forEach((a, ci) => {
ctx.fillStyle = colors[ci % colors.length];
ctx.fillText(`‚â°${a} (mod ${q})`, c.width - 100, margin.t + 15 + ci * 15);
});
} else if(mode === 'difference' && classes.length >= 2) {
// Plot difference: first non-QR minus first QR
const diff = [];
for(let i = 0; i < xs.length; i++) {
diff.push(counts[classes[1]][i] - counts[classes[0]][i]);
}
primeRaceData.diff = diff;

const maxDiff = Math.max(...diff.map(Math.abs));
const zeroY = margin.t + h / 2;

// Fill regions
ctx.fillStyle = 'rgba(0,255,136,0.2)';
ctx.beginPath();
ctx.moveTo(margin.l, zeroY);
for(let i = 0; i < xs.length; i++) {
const px = margin.l + (xs[i] / maxX) * w;
const py = zeroY - (diff[i] / maxDiff) * (h / 2);
ctx.lineTo(px, Math.min(py, zeroY));
}
ctx.lineTo(margin.l + w, zeroY);
ctx.closePath();
ctx.fill();

ctx.fillStyle = 'rgba(255,100,150,0.2)';
ctx.beginPath();
ctx.moveTo(margin.l, zeroY);
for(let i = 0; i < xs.length; i++) {
const px = margin.l + (xs[i] / maxX) * w;
const py = zeroY - (diff[i] / maxDiff) * (h / 2);
ctx.lineTo(px, Math.max(py, zeroY));
}
ctx.lineTo(margin.l + w, zeroY);
ctx.closePath();
ctx.fill();

// Line
ctx.strokeStyle = '#00d9ff';
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = margin.l + (xs[i] / maxX) * w;
const py = zeroY - (diff[i] / maxDiff) * (h / 2);
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();

// Zero line
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 1;
ctx.setLineDash([5, 3]);
ctx.beginPath();
ctx.moveTo(margin.l, zeroY);
ctx.lineTo(margin.l + w, zeroY);
ctx.stroke();
ctx.setLineDash([]);

ctx.fillStyle = '#00ff88';
ctx.font = '11px Segoe UI';
ctx.fillText(`‚â°${classes[1]} leads`, c.width - 90, margin.t + 20);
ctx.fillStyle = '#ff6496';
ctx.fillText(`‚â°${classes[0]} leads`, c.width - 90, c.height - 60);
} else {
// Ratio
const ratios = [];
for(let i = 0; i < xs.length; i++) {
ratios.push(counts[classes[0]][i] > 0 ? counts[classes[1]][i] / counts[classes[0]][i] : 1);
}
const maxR = Math.max(...ratios);
const minR = Math.min(...ratios);

ctx.strokeStyle = '#00d9ff';
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < xs.length; i++) {
const px = margin.l + (xs[i] / maxX) * w;
const py = margin.t + h - ((ratios[i] - minR) / (maxR - minR)) * h;
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();

// Line at ratio = 1
const oneY = margin.t + h - ((1 - minR) / (maxR - minR)) * h;
ctx.strokeStyle = '#ffd700';
ctx.setLineDash([5, 3]);
ctx.beginPath();
ctx.moveTo(margin.l, oneY);
ctx.lineTo(margin.l + w, oneY);
ctx.stroke();
ctx.setLineDash([]);
}

// Axes
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(margin.l, margin.t);
ctx.lineTo(margin.l, margin.t + h);
ctx.lineTo(margin.l + w, margin.t + h);
ctx.stroke();

ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '11px Segoe UI';
ctx.fillText('x', margin.l + w/2, c.height - 10);

// Count lead changes
let leadChanges = 0;
if(classes.length >= 2) {
for(let i = 1; i < xs.length; i++) {
const prev = counts[classes[1]][i-1] - counts[classes[0]][i-1];
const curr = counts[classes[1]][i] - counts[classes[0]][i];
if((prev > 0 && curr <= 0) || (prev <= 0 && curr > 0)) leadChanges++;
}
}

const finalCounts = classes.map(a => counts[a][counts[a].length - 1]);

legend('alprimerace', 'Prime Race', classes.map((a, i) => [`‚â°${a} (mod ${q})`, finalCounts[i], colors[i % colors.length]]));

document.getElementById('raceLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Prime Races | FIELD: ‚Ñ§ (mod q) | TYPE: Chebyshev Bias Analysis</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max x: <strong style="color:#00d9ff">${maxX.toLocaleString()}</strong></span>
<span>mod q: <strong style="color:#ffd700">${q}</strong></span>
<span>Classes: <strong style="color:#00ff88">${classes.length}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${maxX.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">MAX X</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${leadChanges}</div><div style="font-size:.7rem;color:var(--txt2)">LEAD CHANGES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">mod ${q}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Final Counts at x = ${maxX.toLocaleString()}</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
${classes.map((a, i) => `<span>œÄ(x;${q},${a}):</span><span style="color:${colors[i % colors.length]};font-weight:bold">${finalCounts[i]}</span>`).join('')}
</div>
</div>
${q === 4 ? `<div style="background:rgba(0,255,136,.1);padding:8px;border-radius:6px">
<strong style="color:#00ff88">Chebyshev Bias (mod 4)</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Primes ‚â°3 (mod 4) lead ~99.59% of the time! First switch to ‚â°1 leading: x=26861.</div>
</div>` : ''}`;
}

async function screenshotPrimeRace() {
await screenshotUnified('cprimerace', 'raceLiveStats', 'Prime Races - Chebyshev Bias', 'prime_race.png');
}

function csvPrimeRace() {
const classes = Object.keys(primeRaceData.counts);
let s = 'x,' + classes.map(a => `count_${a}`).join(',') + '\n';
for(let i = 0; i < primeRaceData.x.length; i++) {
s += primeRaceData.x[i] + ',' + classes.map(a => primeRaceData.counts[a][i]).join(',') + '\n';
}
dl(s, 'prime_race.csv');
}

// ==================== DIRICHLET L-FUNCTIONS ====================
let lfuncData = {chars: [], values: []};

// Generate Dirichlet characters mod q
function dirichletChars(q) {
const chars = [];
// Find generators of (Z/qZ)*
const units = [];
for(let a = 1; a < q; a++) if(gcd(a, q) === 1) units.push(a);
const phi = units.length;

// Principal character
const chi0 = n => gcd(n, q) === 1 ? 1 : 0;
chars.push({label: 'œá‚ÇÄ', values: units.map(a => chi0(a)), fn: chi0, isPrincipal: true});

// For small q, enumerate all characters
if(q <= 12 && phi > 1) {
for(let j = 1; j < phi; j++) {
const chi = n => {
if(gcd(n, q) !== 1) return 0;
const idx = units.indexOf(n % q);
if(idx === -1) return 0;
// Return complex value as {re, im}
const angle = 2 * PI * j * idx / phi;
return {re: Math.cos(angle), im: Math.sin(angle)};
};
chars.push({label: `œá_${j}`, values: units.map(a => {
const v = chi(a);
return typeof v === 'object' ? v : {re: v, im: 0};
}), fn: chi});
}
}

return chars;
}

// Compute L(s, chi) for real s > 1
function Lfunc(s, chi, q, terms = 1000) {
let re = 0, im = 0;
for(let n = 1; n <= terms; n++) {
const chiN = chi(n);
if(typeof chiN === 'number') {
re += chiN / Math.pow(n, s);
} else if(chiN && chiN.re !== undefined) {
const ns = Math.pow(n, s);
re += chiN.re / ns;
im += chiN.im / ns;
}
}
return {re, im, mag: Math.sqrt(re*re + im*im)};
}

function drawLfunc() {
const c = document.getElementById('clfunc'), ctx = c.getContext('2d');
const q = +document.getElementById('lfuncQv').value || 5;
const s = +document.getElementById('lfuncSv').value || 2;
const mode = document.getElementById('lfuncMode').value;

const chars = dirichletChars(q);
const values = chars.map(chi => Lfunc(s, chi.fn, q));
lfuncData = {chars, values, q, s};

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const margin = {l: 60, r: 30, t: 40, b: 50};
const w = c.width - margin.l - margin.r;
const h = c.height - margin.t - margin.b;

if(mode === 'values') {
// Bar chart of L(s, chi) values
const maxMag = Math.max(...values.map(v => v.mag));
const barWidth = w / chars.length - 5;

chars.forEach((chi, i) => {
const x = margin.l + i * (barWidth + 5);
const barH = (values[i].mag / maxMag) * h * 0.8;

ctx.fillStyle = chi.isPrincipal ? '#ffd700' : `hsl(${i * 360 / chars.length}, 70%, 50%)`;
ctx.fillRect(x, margin.t + h - barH, barWidth, barH);

// Label
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '10px Segoe UI';
ctx.save();
ctx.translate(x + barWidth/2, margin.t + h + 15);
ctx.rotate(-Math.PI/4);
ctx.fillText(chi.label, 0, 0);
ctx.restore();

// Value on top
ctx.fillText(fmt(values[i].re), x + 2, margin.t + h - barH - 5);
});

ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '12px Segoe UI';
ctx.fillText(`L(${s}, œá) for œá mod ${q}`, margin.l, margin.t - 10);
} else if(mode === 'characters') {
// Character table
const units = [];
for(let a = 1; a < q; a++) if(gcd(a, q) === 1) units.push(a);

const cellW = w / (units.length + 1);
const cellH = h / (chars.length + 1);

// Header row
ctx.fillStyle = '#00d9ff';
ctx.font = '11px Segoe UI';
ctx.fillText('n ‚Üí', margin.l, margin.t + cellH/2);
units.forEach((a, i) => {
ctx.fillText(a.toString(), margin.l + (i+1) * cellW + 5, margin.t + cellH/2);
});

// Character rows
chars.forEach((chi, j) => {
ctx.fillStyle = '#ffd700';
ctx.fillText(chi.label, margin.l, margin.t + (j+1.5) * cellH);
units.forEach((a, i) => {
const v = chi.fn(a);
let text;
if(typeof v === 'number') text = v.toString();
else if(v && v.re !== undefined) {
if(Math.abs(v.im) < 0.01) text = v.re.toFixed(2);
else text = `${v.re.toFixed(1)}+${v.im.toFixed(1)}i`;
} else text = '0';
ctx.fillStyle = isDark() ? '#e0e0e0' : '#333';
ctx.fillText(text, margin.l + (i+1) * cellW + 5, margin.t + (j+1.5) * cellH);
});
});
} else {
// Euler product visualization
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '14px Segoe UI';
ctx.fillText(`Euler Product: L(s,œá) = ‚àè_p (1 - œá(p)/p^s)^{-1}`, margin.l, margin.t + 20);

// Show product terms for first few primes
const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29];
let y = margin.t + 60;
chars.slice(0, 4).forEach((chi, ci) => {
ctx.fillStyle = `hsl(${ci * 90}, 70%, 50%)`;
ctx.fillText(`${chi.label}:`, margin.l, y);
let product = {re: 1, im: 0};
primes.forEach((p, pi) => {
const chiP = chi.fn(p);
const factor = typeof chiP === 'number' ? chiP : (chiP ? chiP.re : 0);
const term = 1 / (1 - factor / Math.pow(p, s));
product.re *= term;
ctx.fillStyle = isDark() ? '#e0e0e0' : '#333';
ctx.font = '10px Segoe UI';
ctx.fillText(`(1-œá(${p})/${p}^${s})^{-1}`, margin.l + 50 + pi * 75, y);
});
ctx.fillStyle = '#00ff88';
ctx.fillText(`‚âà ${product.re.toFixed(4)}`, margin.l + 50 + primes.length * 75, y);
y += 40;
});
}

// Axes
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(margin.l, margin.t + h);
ctx.lineTo(margin.l + w, margin.t + h);
ctx.stroke();

legend('allfunc', 'L-functions', [['Modulus', q, '#00d9ff'], ['s', s, '#ffd700'], ['œÜ(q)', chars.length, '#ff6496']]);

document.getElementById('lfuncLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${q}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS q</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${chars.length}</div><div style="font-size:.7rem;color:var(--txt2)">CHARACTERS œÜ(q)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${s}</div><div style="font-size:.7rem;color:var(--txt2)">s VALUE</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">L(${s}, œá) Values</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
${chars.slice(0, 6).map((chi, i) => `<span>${chi.label}:</span><span style="color:#00d9ff">${fmt(values[i].re)}${Math.abs(values[i].im) > 0.01 ? ` + ${fmt(values[i].im)}i` : ''}</span>`).join('')}
</div>
</div>
<div style="background:rgba(255,215,0,.1);padding:8px;border-radius:6px">
<strong style="color:#ffd700">Principal Character</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">L(s,œá‚ÇÄ) = Œ∂(s) √ó ‚àè_{p|q}(1-p^{-s}). Other L-functions are entire (no pole at s=1).</div>
</div>`;
}

async function screenshotLfunc() {
await screenshotUnified('clfunc', 'lfuncLiveStats', 'Dirichlet L-Functions', 'lfunc.png');
}

function csvLfunc() {
let s = 'character,L_real,L_imag,L_mag\n';
lfuncData.chars.forEach((chi, i) => {
s += `${chi.label},${lfuncData.values[i].re},${lfuncData.values[i].im},${lfuncData.values[i].mag}\n`;
});
dl(s, 'lfunc.csv');
}

// ==================== L-FUNCTION ZEROS ====================
function drawLfuncZeros() {
const c = document.getElementById('clfunczeros'), ctx = c.getContext('2d');
const q = +document.getElementById('lzeroQv').value || 5;
const maxT = +document.getElementById('lzeroTv').value || 30;
const mode = document.getElementById('lzeroMode').value;
const showAll = document.getElementById('lzeroAll').checked;

ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const margin = {l: 60, r: 30, t: 40, b: 50};
const w = c.width - margin.l - margin.r;
const h = c.height - margin.t - margin.b;

const chars = dirichletChars(q);
let zerosFound = {};

if(mode === 'zeros' || mode === 'critical') {
// Plot critical line with zero locations found numerically
const critX = margin.l + w * 0.5; // œÉ = 0.5

// Draw critical strip
ctx.fillStyle = 'rgba(0,217,255,0.1)';
ctx.fillRect(margin.l + w * 0.25, margin.t, w * 0.5, h);

// Critical line
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 2;
ctx.setLineDash([5, 3]);
ctx.beginPath();
ctx.moveTo(critX, margin.t);
ctx.lineTo(critX, margin.t + h);
ctx.stroke();
ctx.setLineDash([]);

// For each character, find zeros by sign changes of real part
const colors = ['#00d9ff', '#ff6496', '#00ff88', '#9664ff', '#ffd700', '#ff8c00'];

chars.slice(0, showAll ? 6 : 1).forEach((chi, ci) => {
zerosFound[chi.label] = [];
ctx.fillStyle = colors[ci % colors.length];

// Search for zeros along critical line
for(let t = 1; t <= maxT; t += 0.5) {
const L1 = Lfunc(0.5, chi.fn, q, 500);
const L2 = LfuncComplex(0.5, t, chi.fn, q, 200);
const L3 = LfuncComplex(0.5, t + 0.5, chi.fn, q, 200);

// Check for sign change in real part (crude zero detection)
if(L2.re * L3.re < 0) {
const zeroT = t + 0.25; // Approximate
zerosFound[chi.label].push(zeroT);
const y = margin.t + h - (zeroT / maxT) * h;
ctx.beginPath();
ctx.arc(critX + (ci - 2) * 8, y, 5, 0, 2*PI);
ctx.fill();
}
}
});

// Axis labels
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '11px Segoe UI';
ctx.fillText('Re(s) = ¬Ω', critX - 30, c.height - 10);
ctx.fillText('t = 0', margin.l + 5, margin.t + h - 5);
ctx.fillText(`t = ${maxT}`, margin.l + 5, margin.t + 15);

// Legend
let legendY = margin.t + 20;
chars.slice(0, showAll ? 6 : 1).forEach((chi, ci) => {
ctx.fillStyle = colors[ci % colors.length];
ctx.fillRect(c.width - 100, legendY, 12, 12);
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.fillText(`${chi.label}: ${zerosFound[chi.label].length}`, c.width - 85, legendY + 10);
legendY += 18;
});
} else {
// Domain coloring for L-function
const chi = chars[1] || chars[0]; // Use first non-principal character
const s1 = 0, s2 = 1, t1 = 0, t2 = maxT;

for(let py = 0; py < c.height; py += 4) {
const t = t2 - (py / c.height) * (t2 - t1);
for(let px = 0; px < c.width; px += 4) {
const sigma = s1 + (px / c.width) * (s2 - s1);
const L = LfuncComplex(sigma, t, chi.fn, q, 100);
const phase = Math.atan2(L.im, L.re);
const mag = Math.sqrt(L.re * L.re + L.im * L.im);

const hue = (phase + PI) / (2 * PI);
const light = 0.5 + 0.3 * Math.tanh(Math.log(mag + 0.1));
const [r, g, b] = hslToRgb(hue, 0.8, light);

ctx.fillStyle = `rgb(${r},${g},${b})`;
ctx.fillRect(px, py, 4, 4);
}
}

// Critical line overlay
ctx.strokeStyle = 'rgba(255,255,255,0.7)';
ctx.lineWidth = 2;
ctx.setLineDash([5, 3]);
const critPx = (0.5 - s1) / (s2 - s1) * c.width;
ctx.beginPath();
ctx.moveTo(critPx, 0);
ctx.lineTo(critPx, c.height);
ctx.stroke();
ctx.setLineDash([]);
}

const totalZeros = Object.values(zerosFound).reduce((a, z) => a + z.length, 0);

legend('allfunczeros', 'L-function Zeros', [['Modulus', q, '#00d9ff'], ['t Range', `[0, ${maxT}]`, '#ffd700'], ['Zeros', totalZeros || '~', '#ff6496']]);

document.getElementById('lzeroLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${q}</div><div style="font-size:.7rem;color:var(--txt2)">MODULUS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${maxT}</div><div style="font-size:.7rem;color:var(--txt2)">MAX t</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${chars.length}</div><div style="font-size:.7rem;color:var(--txt2)">CHARACTERS</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">GRH Prediction</strong>
<div style="font-size:.8rem;color:var(--txt2);margin-top:6px">
All nontrivial zeros of all L(s,œá) should lie on Re(s) = ¬Ω. This is the Generalized Riemann Hypothesis.
</div>
</div>
<div style="background:rgba(255,100,150,.1);padding:8px;border-radius:6px">
<strong style="color:#ff6496">Connection to Primes</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">Zeros of L(s,œá) control error in œÄ(x;q,a). Low-lying zeros cause the Chebyshev bias!</div>
</div>`;
}

// L-function for complex s = sigma + it
function LfuncComplex(sigma, t, chi, q, terms = 200) {
let re = 0, im = 0;
for(let n = 1; n <= terms; n++) {
const chiN = chi(n);
const chiVal = typeof chiN === 'number' ? chiN : (chiN ? chiN.re : 0);
if(chiVal === 0) continue;

const mag = Math.pow(n, -sigma);
const phase = -t * Math.log(n);
re += chiVal * mag * Math.cos(phase);
im += chiVal * mag * Math.sin(phase);
}
return {re, im};
}

async function screenshotLfuncZeros() {
await screenshotUnified('clfunczeros', 'lzeroLiveStats', 'L-Function Zeros', 'lfunc_zeros.png');
}

// ==================== QUANTUM ORBITALS ====================
let quantumData = {n: 0, l: 0, m: 0, radial: [], angular: []};

// Associated Legendre polynomial P_l^m(x) - simplified for visualization
function assocLegendre(l, m, x) {
const absM = Math.abs(m);
if(l === 0) return 1;
if(l === 1) {
if(absM === 0) return x;
if(absM === 1) return -Math.sqrt(1 - x*x);
}
if(l === 2) {
if(absM === 0) return (3*x*x - 1) / 2;
if(absM === 1) return -3 * x * Math.sqrt(1 - x*x);
if(absM === 2) return 3 * (1 - x*x);
}
if(l === 3) {
if(absM === 0) return (5*x*x*x - 3*x) / 2;
if(absM === 1) return -1.5 * (5*x*x - 1) * Math.sqrt(1 - x*x);
if(absM === 2) return 15 * x * (1 - x*x);
if(absM === 3) return -15 * Math.pow(1 - x*x, 1.5);
}
// Higher l: use recurrence (simplified)
let P0 = 1, P1 = x;
for(let k = 2; k <= l; k++) {
const Pk = ((2*k-1)*x*P1 - (k-1)*P0) / k;
P0 = P1; P1 = Pk;
}
return P1;
}

// Spherical harmonic Y_l^m(theta, phi) - returns real part for visualization
function sphericalHarmonic(l, m, theta, phi) {
const cosTheta = Math.cos(theta);
const P = assocLegendre(l, Math.abs(m), cosTheta);
// Normalization factor (simplified)
const norm = Math.sqrt((2*l + 1) / (4 * PI));
if(m === 0) return norm * P;
if(m > 0) return norm * P * Math.cos(m * phi) * Math.sqrt(2);
return norm * P * Math.sin(Math.abs(m) * phi) * Math.sqrt(2);
}

// Radial wavefunction R_nl(r) for hydrogen (simplified, a0=1)
function radialWavefunction(n, l, r) {
const rho = 2 * r / n;
// Laguerre polynomial approximation
let L = 1;
if(n - l - 1 >= 1) L = 1 - rho/(n-l);
if(n - l - 1 >= 2) L = 1 - rho + rho*rho/(2*(n-l));
const norm = Math.sqrt(Math.pow(2/n, 3) / (2*n));
return norm * Math.exp(-rho/2) * Math.pow(rho, l) * L;
}

// Full wavefunction probability |œà|¬≤
function psiSquared(n, l, m, r, theta, phi) {
const R = radialWavefunction(n, l, r);
const Y = sphericalHarmonic(l, m, theta, phi);
return R * R * Y * Y;
}

function drawQuantum() {
const c = document.getElementById('cquantum'), ctx = c.getContext('2d');
const n = +document.getElementById('quantumNv').value || 3;
let l = +document.getElementById('quantumLv').value || 0;
let m = +document.getElementById('quantumMv').value || 0;
const mode = document.getElementById('quantumMode').value;
const res = +document.getElementById('quantumRes').value || 50;
const showNodes = document.getElementById('quantumNodes').checked;
const showAxes = document.getElementById('quantumAxes').checked;
const showLabels = document.getElementById('quantumLabels').checked;

// Enforce quantum number rules
if(l >= n) l = n - 1;
if(Math.abs(m) > l) m = m > 0 ? l : -l;
document.getElementById('quantumL').value = l;
document.getElementById('quantumLv').value = l;
document.getElementById('quantumM').value = m;
document.getElementById('quantumMv').value = m;

ctx.fillStyle = canvBg();
ctx.fillRect(0, 0, c.width, c.height);

const cx = c.width / 2, cy = c.height / 2;
const scale = c.width / (4 * n + 2);
const orbitalNames = ['s', 'p', 'd', 'f', 'g', 'h', 'i'];
const orbitalName = n + (orbitalNames[l] || 'l=' + l);

// Count radial and angular nodes
const radialNodes = n - l - 1;
const angularNodes = l;

if(mode === 'cloud' || mode === 'cross') {
// Probability cloud visualization
const maxR = n * n * 3;
const imgData = ctx.createImageData(c.width, c.height);

for(let py = 0; py < c.height; py++) {
for(let px = 0; px < c.width; px++) {
const x = (px - cx) / scale;
const y = (cy - py) / scale;
const r = Math.sqrt(x*x + y*y);
const theta = Math.atan2(Math.sqrt(x*x), y) || 0; // Angle from z-axis
const phi = Math.atan2(y, x);

const prob = psiSquared(n, l, m, r, theta, phi);
const intensity = Math.min(1, prob * 500 * n * n);

// Color based on sign of wavefunction (for cross section)
const R = radialWavefunction(n, l, r);
const Y = sphericalHarmonic(l, m, theta, phi);
const psi = R * Y;

let red, green, blue;
if(mode === 'cross') {
// Show sign with color
if(psi > 0) {
red = Math.floor(intensity * 0); green = Math.floor(intensity * 180); blue = Math.floor(intensity * 255);
} else {
red = Math.floor(intensity * 255); green = Math.floor(intensity * 100); blue = Math.floor(intensity * 150);
}
} else {
// Probability density only
red = Math.floor(intensity * 100);
green = Math.floor(intensity * 200);
blue = Math.floor(intensity * 255);
}

const idx = (py * c.width + px) * 4;
imgData.data[idx] = red;
imgData.data[idx + 1] = green;
imgData.data[idx + 2] = blue;
imgData.data[idx + 3] = 255;
}
}
ctx.putImageData(imgData, 0, 0);

// Draw axes
if(showAxes) {
ctx.strokeStyle = 'rgba(255,255,255,0.3)';
ctx.lineWidth = 1;
ctx.setLineDash([5, 5]);
ctx.beginPath();
ctx.moveTo(0, cy); ctx.lineTo(c.width, cy);
ctx.moveTo(cx, 0); ctx.lineTo(cx, c.height);
ctx.stroke();
ctx.setLineDash([]);
}

} else if(mode === 'radial') {
// Radial function R_nl(r)
const maxR = n * n * 4;
const points = [];
quantumData.radial = [];

ctx.strokeStyle = gridC();
ctx.lineWidth = 1;
// Draw grid
for(let i = 0; i <= 10; i++) {
const x = 50 + i * (c.width - 100) / 10;
ctx.beginPath(); ctx.moveTo(x, 50); ctx.lineTo(x, c.height - 50); ctx.stroke();
const y = 50 + i * (c.height - 100) / 10;
ctx.beginPath(); ctx.moveTo(50, y); ctx.lineTo(c.width - 50, y); ctx.stroke();
}

// Plot R_nl(r)
ctx.strokeStyle = '#00d9ff';
ctx.lineWidth = 3;
ctx.beginPath();
let maxVal = 0;
for(let i = 0; i <= res * 2; i++) {
const r = i * maxR / (res * 2);
const R = radialWavefunction(n, l, r);
points.push({r, R});
quantumData.radial.push({r, R});
maxVal = Math.max(maxVal, Math.abs(R));
}
for(let i = 0; i < points.length; i++) {
const px = 50 + points[i].r / maxR * (c.width - 100);
const py = cy - points[i].R / maxVal * (c.height / 2 - 60);
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();

// Plot r¬≤R¬≤ (probability)
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 2;
ctx.beginPath();
let maxProb = 0;
const probPoints = points.map(p => ({r: p.r, prob: p.r * p.r * p.R * p.R}));
probPoints.forEach(p => maxProb = Math.max(maxProb, p.prob));
for(let i = 0; i < probPoints.length; i++) {
const px = 50 + probPoints[i].r / maxR * (c.width - 100);
const py = c.height - 50 - probPoints[i].prob / maxProb * (c.height / 2 - 60);
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.stroke();

// Mark nodes
if(showNodes) {
ctx.fillStyle = '#ff6496';
for(let i = 1; i < points.length - 1; i++) {
if(points[i-1].R * points[i+1].R < 0) {
const px = 50 + points[i].r / maxR * (c.width - 100);
ctx.beginPath(); ctx.arc(px, cy, 6, 0, 2*PI); ctx.fill();
}
}
}

// Labels
if(showLabels) {
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '12px Segoe UI';
ctx.fillText('r (Bohr radii)', c.width / 2, c.height - 15);
ctx.fillText('R_{nl}(r)', 10, 30);
ctx.fillStyle = '#00d9ff';
ctx.fillText('Radial wavefunction', c.width - 150, 30);
ctx.fillStyle = '#ffd700';
ctx.fillText('Probability r¬≤R¬≤', c.width - 150, 50);
}

} else if(mode === 'angular') {
// Angular distribution Y_l^m(Œ∏,œÜ)
ctx.strokeStyle = gridC();
ctx.lineWidth = 1;
ctx.beginPath(); ctx.arc(cx, cy, c.width/3, 0, 2*PI); ctx.stroke();

// Plot |Y_l^m|¬≤ as polar plot
const maxY = 1;
const points = [];
quantumData.angular = [];

for(let i = 0; i <= res * 4; i++) {
const theta = i * PI / (res * 2);
const Y = sphericalHarmonic(l, m, theta, 0);
const val = Y * Y;
points.push({theta, val});
quantumData.angular.push({theta: theta * 180 / PI, Y: Y, Ysq: val});
}

const maxVal = Math.max(...points.map(p => p.val)) || 1;

ctx.fillStyle = 'rgba(0,217,255,0.3)';
ctx.strokeStyle = '#00d9ff';
ctx.lineWidth = 2;
ctx.beginPath();
for(let i = 0; i < points.length; i++) {
const r = points[i].val / maxVal * (c.width / 3);
const angle = points[i].theta - PI/2;
const px = cx + r * Math.cos(angle);
const py = cy + r * Math.sin(angle);
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.closePath();
ctx.fill();
ctx.stroke();

// Mirror for full view
ctx.beginPath();
for(let i = 0; i < points.length; i++) {
const r = points[i].val / maxVal * (c.width / 3);
const angle = PI + points[i].theta - PI/2;
const px = cx + r * Math.cos(angle);
const py = cy + r * Math.sin(angle);
if(i === 0) ctx.moveTo(px, py);
else ctx.lineTo(px, py);
}
ctx.closePath();
ctx.fill();
ctx.stroke();

if(showLabels) {
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '14px Segoe UI';
ctx.fillText('Œ∏ = 0 (z-axis)', cx - 40, 30);
ctx.fillText('Œ∏ = œÄ', cx - 20, c.height - 15);
}

} else if(mode === 'all') {
// Show all orbitals for given n
const cols = n;
const cellW = c.width / cols;
const cellH = c.height / n;

for(let ll = 0; ll < n; ll++) {
for(let mm = -ll; mm <= ll; mm++) {
const col = mm + ll;
const row = ll;
const x0 = col * cellW / (2*ll+1) * (2*ll+1) + (c.width - (2*ll+1)*cellW/(2*ll+1)*(2*ll+1>1?1:1))/2;
// Simplified: just show one per l
if(mm !== 0) continue;
const cellX = ll * (c.width / n);
const cellY = 0;
const cellSize = c.width / n;

// Mini probability cloud
for(let py = 0; py < cellSize; py += 4) {
for(let px = 0; px < cellSize; px += 4) {
const x = (px - cellSize/2) / (cellSize / (4*n));
const y = (cellSize/2 - py) / (cellSize / (4*n));
const r = Math.sqrt(x*x + y*y);
const theta = Math.atan2(Math.sqrt(x*x), y) || 0;
const phi = Math.atan2(y, x);

const prob = psiSquared(n, ll, 0, r, theta, phi);
const intensity = Math.min(1, prob * 500 * n * n);

ctx.fillStyle = `rgba(0,${Math.floor(intensity*200)},${Math.floor(intensity*255)},${intensity})`;
ctx.fillRect(cellX + px, cellY + py, 4, 4);
}
}

// Label
ctx.fillStyle = isDark() ? '#fff' : '#333';
ctx.font = '14px Segoe UI';
ctx.fillText(n + orbitalNames[ll], cellX + cellSize/2 - 10, cellY + cellSize - 10);
}
}
}

// Orbital label
if(showLabels && mode !== 'all') {
ctx.fillStyle = '#ffd700';
ctx.font = 'bold 24px Segoe UI';
ctx.fillText(`${orbitalName} orbital (n=${n}, l=${l}, m=${m})`, 20, 35);
}

legend('alquantum', 'Quantum Orbital', [['n', n, '#00d9ff'], ['l', l, '#ffd700'], ['m', m, '#ff6496']]);

// Live stats
document.getElementById('quantumLiveStats').innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#00d9ff">${n}</div><div style="font-size:.7rem;color:var(--txt2)">PRINCIPAL n</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#ffd700">${l}</div><div style="font-size:.7rem;color:var(--txt2)">ANGULAR l</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.5rem;font-weight:bold;color:#ff6496">${m}</div><div style="font-size:.7rem;color:var(--txt2)">MAGNETIC m</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${orbitalName}</div><div style="font-size:.7rem;color:var(--txt2)">ORBITAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#9664ff">${mode}</div><div style="font-size:.7rem;color:var(--txt2)">VIEW MODE</div></div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Node Analysis (‚Üî Zeta Zeros)</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>Radial nodes:</span><span style="color:#ff6496;font-weight:bold">${radialNodes}</span>
<span>Angular nodes:</span><span style="color:#ffd700;font-weight:bold">${angularNodes}</span>
<span>Total nodes:</span><span style="color:#00d9ff;font-weight:bold">${radialNodes + angularNodes}</span>
<span>Energy level:</span><span style="color:#00ff88">-13.6/${n}¬≤ = ${fmt(-13.6/(n*n))} eV</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Quantum Numbers</strong>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:.8rem">
<span>n range:</span><span style="color:var(--txt)">1, 2, 3, ... (‚àû)</span>
<span>l range:</span><span style="color:var(--txt)">0 to n-1 = 0 to ${n-1}</span>
<span>m range:</span><span style="color:var(--txt)">-l to +l = -${l} to +${l}</span>
<span>Orbitals in shell:</span><span style="color:#ffd700">${n*n}</span>
</div>
</div>
<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bord)">
<strong style="color:var(--acc)">Number Theory Connection</strong>
<div style="font-size:.8rem;color:var(--txt2);margin-top:6px;line-height:1.5">
‚Ä¢ Radial nodes (${radialNodes}) ‚Üî zeros of R_{nl}(r) like zeros of Œ∂(s)<br>
‚Ä¢ Angular momentum l¬≤ = ${l*(l+1)} (quantized like gcd constraint)<br>
‚Ä¢ Spherical harmonics Y_l^m ‚Üî volume of k-dimensional balls<br>
‚Ä¢ Energy degeneracy n¬≤ = ${n*n} (relates to lattice point counting)
</div>
</div>
<div style="background:rgba(0,217,255,.1);padding:8px;border-radius:6px">
<strong style="color:#00d9ff">Selection Rules</strong>
<div style="font-size:.75rem;color:var(--txt2);margin-top:4px">
Allowed transitions: Œîl = ¬±1, Œîm = 0, ¬±1. These discrete rules mirror the coprimality constraint gcd(a,b)=1 in number theory!
</div>
</div>`;

quantumData = {n, l, m, radialNodes, angularNodes, orbital: orbitalName};
}

function csvQuantum() {
let csv = 'r,R_nl,r2R2,theta_deg,Y_lm,Y2\n';
if(quantumData.radial) {
quantumData.radial.forEach(p => {
const ang = quantumData.angular ? quantumData.angular.find(a => Math.abs(a.theta) < 1) : null;
csv += `${p.r},${p.R},${p.r*p.r*p.R*p.R},${ang?ang.theta:''},${ang?ang.Y:''},${ang?ang.Ysq:''}\n`;
});
}
dl(csv, `quantum_${quantumData.orbital || 'orbital'}.csv`);
}

async function screenshotQuantum() {
await screenshotUnified('cquantum', 'quantumLiveStats', `Quantum Orbital ${quantumData.orbital || ''}`, 'quantum_orbital.png');
}

// ==================== PRIME K-TUPLES ====================
let ktuplesData = [];
const KTUPLE_PATTERNS = {
twin: [0, 2],
cousin: [0, 4],
sexy: [0, 6],
triplet: [0, 2, 6],
quadruplet: [0, 2, 6, 8],
quintuplet: [0, 2, 6, 8, 12],
sextuplet: [0, 4, 6, 10, 12, 16]
};

function drawKtuples() {
const maxN = +document.getElementById('ktupleNv').value || 10000;
const type = document.getElementById('ktupleType').value;
const pattern = KTUPLE_PATTERNS[type];
const c = document.getElementById('cktuples'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Find all primes
const sieve = new Array(maxN + 20).fill(true);
sieve[0] = sieve[1] = false;
for (let i = 2; i * i <= maxN + 20; i++) if (sieve[i]) for (let j = i * i; j <= maxN + 20; j += i) sieve[j] = false;

// Find k-tuples
ktuplesData = [];
for (let p = 2; p <= maxN; p++) {
if (!sieve[p]) continue;
let valid = true;
for (const offset of pattern) {
if (!sieve[p + offset]) { valid = false; break; }
}
if (valid) ktuplesData.push({ p, tuple: pattern.map(o => p + o) });
}

// Draw visualization
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const scale = w / maxN;

// Draw tuples as vertical lines
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 1;
ktuplesData.forEach(t => {
const x = pad + t.p * scale;
ctx.beginPath();
ctx.moveTo(x, pad);
ctx.lineTo(x, c.height - pad);
ctx.stroke();
});

// Draw dots for tuple elements
ktuplesData.slice(0, 200).forEach(t => {
t.tuple.forEach((p, i) => {
const x = pad + p * scale;
const y = pad + 30 + i * 40;
ctx.fillStyle = `hsl(${i * 60}, 80%, 60%)`;
ctx.beginPath();
ctx.arc(x, y, 4, 0, 2 * PI);
ctx.fill();
});
});

// Title
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Prime ${type} (k=${pattern.length}) up to N=${maxN}: Found ${ktuplesData.length}`, c.width / 2, 25);

// Stats
const density = ktuplesData.length / maxN * 1000;
document.getElementById('ktuplesLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Prime k-Tuples | FIELD: ‚Ñ§ (Primes) | TYPE: ${type} Pattern</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>Max N: <strong style="color:#00d9ff">${maxN}</strong></span>
<span>k: <strong style="color:#ffd700">${pattern.length}</strong></span>
<span>Found: <strong style="color:#00ff88">${ktuplesData.length}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${ktuplesData.length}</div><div style="font-size:.7rem;color:var(--txt2)">TUPLES FOUND</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${pattern.length}</div><div style="font-size:.7rem;color:var(--txt2)">TUPLE SIZE k</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${fmt(density)}</div><div style="font-size:.7rem;color:var(--txt2)">PER 1000</div></div>
</div>
<div style="margin-bottom:10px">
<strong style="color:var(--acc)">Pattern: [${pattern.join(', ')}]</strong>
<div style="font-size:.8rem;color:var(--txt2);margin-top:5px">
First ${Math.min(5, ktuplesData.length)}: ${ktuplesData.slice(0, 5).map(t => `(${t.tuple.join(',')})`).join(', ')}
</div>
</div>`;

// Chart
const cumulative = [];
let count = 0;
for (let x = 0; x <= maxN; x += Math.max(1, Math.floor(maxN / 100))) {
count = ktuplesData.filter(t => t.p <= x).length;
cumulative.push({ x, count });
}
Plotly.newPlot('pktuples1', [{ x: cumulative.map(c => c.x), y: cumulative.map(c => c.count), mode: 'lines', line: { color: '#ffd700' } }], { ...plo(), xaxis: { title: 'N' }, yaxis: { title: 'Count' } });
}

function csvKtuples() { let s = 'p,tuple\n'; ktuplesData.forEach(t => s += `${t.p},"${t.tuple.join(',')}"\n`); dl(s, 'ktuples.csv'); }
async function screenshotKtuples() { await screenshotUnified('cktuples', 'ktuplesLiveStats', 'Prime k-Tuples', 'ktuples.png'); }
function exportAllKtuples() { screenshotTabAll({ canvases: ['cktuples'], charts: ['pktuples1'], dashId: 'ktuplesLiveStats', title: 'Prime k-Tuples', filename: 'ktuples_all.png' }); }

// ==================== CARMICHAEL NUMBERS ====================
let carmichaelData = [];

function isCarmichael(n) {
if (n < 3 || isPrime(n)) return false;
// Korselt's criterion: n is Carmichael iff n is squarefree and (p-1)|(n-1) for all primes p|n
let temp = n, factors = [];
for (let p = 2; p * p <= temp; p++) {
if (temp % p === 0) {
factors.push(p);
temp /= p;
if (temp % p === 0) return false; // Not squarefree
}
}
if (temp > 1) factors.push(temp);
if (factors.length < 3) return false; // Must have at least 3 prime factors
for (const p of factors) {
if ((n - 1) % (p - 1) !== 0) return false;
}
return true;
}

function drawCarmichael() {
const maxN = +document.getElementById('carmNv').value || 100000;
const c = document.getElementById('ccarm'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

carmichaelData = [];
for (let n = 3; n <= maxN; n += 2) {
if (isCarmichael(n)) carmichaelData.push(n);
}

// Draw
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
ctx.fillStyle = '#ff6496';
carmichaelData.forEach((n, i) => {
const x = pad + (n / maxN) * w;
const y = pad + (i / Math.max(1, carmichaelData.length - 1)) * h;
ctx.beginPath();
ctx.arc(x, y, 5, 0, 2 * PI);
ctx.fill();
});

ctx.fillStyle = isDark() ? '#ff6496' : '#cc0044';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Carmichael Numbers ‚â§ ${maxN}: Found ${carmichaelData.length}`, c.width / 2, 25);

// Known Carmichaels
const known = [561, 1105, 1729, 2465, 2821, 6601, 8911, 10585, 15841, 29341];

document.getElementById('carmLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,100,150,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ff6496">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Carmichael Numbers | FIELD: ‚Ñ§ (Pseudoprimes) | TYPE: Fermat Liars</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${carmichaelData.length}</div><div style="font-size:.7rem;color:var(--txt2)">FOUND</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">561</div><div style="font-size:.7rem;color:var(--txt2)">SMALLEST</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${carmichaelData[carmichaelData.length - 1] || '‚Äî'}</div><div style="font-size:.7rem;color:var(--txt2)">LARGEST</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Definition:</strong> n is Carmichael if composite and a^(n-1) ‚â° 1 (mod n) for all gcd(a,n)=1<br>
<strong style="color:var(--acc)">First 10:</strong> ${known.join(', ')}<br>
<strong style="color:var(--acc)">1729</strong> = Hardy-Ramanujan number (also taxicab!)
</div>`;

Plotly.newPlot('pcarm1', [{ x: carmichaelData.map((_, i) => i + 1), y: carmichaelData, mode: 'lines+markers', marker: { size: 4, color: '#ff6496' } }], { ...plo(), xaxis: { title: 'Index' }, yaxis: { title: 'Carmichael Number', type: 'log' } });
}

function csvCarmichael() { dl('n\n' + carmichaelData.join('\n'), 'carmichael.csv'); }
async function screenshotCarmichael() { await screenshotUnified('ccarm', 'carmLiveStats', 'Carmichael Numbers', 'carmichael.png'); }
function exportAllCarmichael() { screenshotTabAll({ canvases: ['ccarm'], charts: ['pcarm1'], dashId: 'carmLiveStats', title: 'Carmichael Numbers', filename: 'carmichael_all.png' }); }

// ==================== MERSENNE NUMBERS ====================
let mersenneData = [];
const KNOWN_MERSENNE_PRIMES = [2, 3, 5, 7, 13, 17, 19, 31, 61, 89, 107, 127, 521, 607, 1279];

function drawMersenne() {
const maxP = +document.getElementById('mersPv').value || 100;
const mode = document.getElementById('mersMode').value;
const c = document.getElementById('cmers'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

mersenneData = [];
for (let p = 2; p <= maxP; p++) {
if (!isPrime(p)) continue;
const m = Math.pow(2, p) - 1;
const isMersennePrime = KNOWN_MERSENNE_PRIMES.includes(p);
mersenneData.push({ p, m, isPrime: isMersennePrime });
}

// Draw
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const maxIdx = mersenneData.length;

mersenneData.forEach((d, i) => {
const x = pad + (i / maxIdx) * w;
const y = c.height - pad - Math.min(h, Math.log10(d.m + 1) / Math.log10(mersenneData[maxIdx - 1]?.m || 10) * h);
ctx.fillStyle = d.isPrime ? '#00ff88' : '#ff6496';
ctx.beginPath();
ctx.arc(x, y, d.isPrime ? 8 : 4, 0, 2 * PI);
ctx.fill();
if (d.isPrime && d.p <= 31) {
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = '10px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`M${d.p}`, x, y - 12);
}
});

ctx.fillStyle = isDark() ? '#00ff88' : '#008844';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Mersenne Numbers 2^p - 1 for prime p ‚â§ ${maxP}`, c.width / 2, 25);

const mpCount = mersenneData.filter(d => d.isPrime).length;

document.getElementById('mersLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,255,136,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #00ff88">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Mersenne Numbers | FIELD: 2^p - 1 | TYPE: Prime Search</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${mersenneData.length}</div><div style="font-size:.7rem;color:var(--txt2)">TESTED</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${mpCount}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fmt(100 * mpCount / mersenneData.length)}%</div><div style="font-size:.7rem;color:var(--txt2)">PRIME RATE</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Mersenne Primes in range:</strong> ${mersenneData.filter(d => d.isPrime).map(d => `M${d.p}`).join(', ') || 'None'}<br>
<strong style="color:var(--acc)">Largest known:</strong> M82589933 (24,862,048 digits, Dec 2018)<br>
<strong style="color:var(--acc)">GIMPS Project:</strong> Great Internet Mersenne Prime Search
</div>`;

Plotly.newPlot('pmers1', [{ x: mersenneData.map(d => d.p), y: mersenneData.map(d => Math.log10(d.m)), mode: 'lines+markers', marker: { color: mersenneData.map(d => d.isPrime ? '#00ff88' : '#666'), size: mersenneData.map(d => d.isPrime ? 10 : 4) } }], { ...plo(), xaxis: { title: 'Exponent p' }, yaxis: { title: 'log‚ÇÅ‚ÇÄ(2^p - 1)' } });
}

function csvMersenne() { let s = 'p,mersenne,is_prime\n'; mersenneData.forEach(d => s += `${d.p},${d.m},${d.isPrime}\n`); dl(s, 'mersenne.csv'); }
async function screenshotMersenne() { await screenshotUnified('cmers', 'mersLiveStats', 'Mersenne Numbers', 'mersenne.png'); }
function exportAllMersenne() { screenshotTabAll({ canvases: ['cmers'], charts: ['pmers1'], dashId: 'mersLiveStats', title: 'Mersenne Numbers', filename: 'mersenne_all.png' }); }

// ==================== CONTINUED FRACTIONS ====================
let cfData = { coeffs: [], convergents: [] };

function continuedFraction(x, terms) {
const coeffs = [];
let a = Math.floor(x);
coeffs.push(a);
let rem = x - a;
for (let i = 1; i < terms && rem > 1e-10; i++) {
x = 1 / rem;
a = Math.floor(x);
coeffs.push(a);
rem = x - a;
}
return coeffs;
}

function convergents(coeffs) {
const conv = [];
let h0 = 1, h1 = coeffs[0], k0 = 0, k1 = 1;
conv.push({ p: h1, q: k1, val: h1 / k1 });
for (let i = 1; i < coeffs.length; i++) {
const h2 = coeffs[i] * h1 + h0;
const k2 = coeffs[i] * k1 + k0;
conv.push({ p: h2, q: k2, val: h2 / k2 });
h0 = h1; h1 = h2; k0 = k1; k1 = k2;
}
return conv;
}

function drawContinued() {
const numType = document.getElementById('cfNum').value;
const terms = +document.getElementById('cfTerms').value;
const c = document.getElementById('ccf'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

let x, name;
switch (numType) {
case 'pi': x = PI; name = 'œÄ'; break;
case 'e': x = Math.E; name = 'e'; break;
case 'phi': x = (1 + Math.sqrt(5)) / 2; name = 'œÜ'; break;
case 'sqrt2': x = Math.sqrt(2); name = '‚àö2'; break;
case 'sqrt3': x = Math.sqrt(3); name = '‚àö3'; break;
default: x = +document.getElementById('cfCustom').value; name = x.toString();
}

cfData.coeffs = continuedFraction(x, terms);
cfData.convergents = convergents(cfData.coeffs);
cfData.target = x;

// Draw coefficients
const pad = 50, w = c.width - 2 * pad;
ctx.fillStyle = isDark() ? '#00d9ff' : '#0066cc';
ctx.font = '14px Segoe UI';
ctx.textAlign = 'center';

// Display CF notation
let cfStr = `[${cfData.coeffs[0]}; ${cfData.coeffs.slice(1, 10).join(', ')}${cfData.coeffs.length > 10 ? ', ...' : ''}]`;
ctx.fillText(`${name} = ${cfStr}`, c.width / 2, 30);

// Draw convergent visualization
cfData.convergents.slice(0, 15).forEach((conv, i) => {
const y = 60 + i * 28;
ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.textAlign = 'left';
ctx.fillText(`p${i}/q${i} = ${conv.p}/${conv.q} = ${conv.val.toFixed(10)}`, pad, y);
const err = Math.abs(conv.val - x);
ctx.fillStyle = err < 1e-8 ? '#00ff88' : err < 1e-4 ? '#ffd700' : '#ff6496';
ctx.textAlign = 'right';
ctx.fillText(`error: ${err.toExponential(2)}`, c.width - pad, y);
});

document.getElementById('cfLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Continued Fractions | FIELD: ‚Ñù ‚Üí ‚Ñö Approx | TYPE: Best Rational Approximations</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${name}</div><div style="font-size:.7rem;color:var(--txt2)">NUMBER</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${cfData.coeffs.length}</div><div style="font-size:.7rem;color:var(--txt2)">TERMS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${Math.max(...cfData.coeffs.slice(0, 20))}</div><div style="font-size:.7rem;color:var(--txt2)">MAX COEFF</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Best approximation:</strong> ${cfData.convergents[cfData.convergents.length - 1]?.p}/${cfData.convergents[cfData.convergents.length - 1]?.q}<br>
<strong style="color:var(--acc)">œÜ special:</strong> All coefficients = 1 (slowest convergence)<br>
<strong style="color:var(--acc)">œÄ famous:</strong> 355/113 (6 correct decimals)
</div>`;

const errors = cfData.convergents.map((c, i) => ({ i, err: Math.abs(c.val - x) }));
Plotly.newPlot('pcf1', [{ x: errors.map(e => e.i), y: errors.map(e => e.err), mode: 'lines+markers', line: { color: '#ffd700' } }], { ...plo(), xaxis: { title: 'Convergent Index' }, yaxis: { title: 'Error', type: 'log' } });
}

function csvContinued() { let s = 'index,p,q,value,error\n'; cfData.convergents.forEach((c, i) => s += `${i},${c.p},${c.q},${c.val},${Math.abs(c.val - cfData.target)}\n`); dl(s, 'continued_fractions.csv'); }
async function screenshotContinued() { await screenshotUnified('ccf', 'cfLiveStats', 'Continued Fractions', 'continued_fractions.png'); }
function exportAllContinued() { screenshotTabAll({ canvases: ['ccf'], charts: ['pcf1'], dashId: 'cfLiveStats', title: 'Continued Fractions', filename: 'cf_all.png' }); }

// ==================== STERN-BROCOT TREE ====================
let sbData = [];

function drawSternBrocot() {
const depth = +document.getElementById('sbDepth').value;
const c = document.getElementById('csb'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Build tree level by level using mediant property
sbData = [];
const levels = [[{ p: 0, q: 1 }, { p: 1, q: 1 }, { p: 1, q: 0 }]];

for (let d = 0; d < depth; d++) {
const prev = levels[d];
const next = [prev[0]];
for (let i = 0; i < prev.length - 1; i++) {
const med = { p: prev[i].p + prev[i + 1].p, q: prev[i].q + prev[i + 1].q };
next.push(med);
next.push(prev[i + 1]);
}
levels.push(next);
}

// Draw tree
const pad = 30;
ctx.strokeStyle = gridC();
ctx.lineWidth = 1;

levels.forEach((level, d) => {
const y = pad + 40 + d * 70;
const validFracs = level.filter(f => f.q > 0 && f.q < 100);
validFracs.forEach((f, i) => {
const x = pad + (i + 0.5) / validFracs.length * (c.width - 2 * pad);
// Draw node
ctx.fillStyle = f.p === f.q ? '#ffd700' : gcd(f.p, f.q) === 1 ? '#00d9ff' : '#666';
ctx.beginPath();
ctx.arc(x, y, 12, 0, 2 * PI);
ctx.fill();
// Label
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = '9px Segoe UI';
ctx.textAlign = 'center';
if (f.q > 0 && f.q < 20) ctx.fillText(`${f.p}/${f.q}`, x, y + 4);
sbData.push({ p: f.p, q: f.q, depth: d });
});
});

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Stern-Brocot Tree ‚Äî Depth ${depth}`, c.width / 2, 25);

const fracCount = sbData.filter(f => f.q > 0 && f.q < 1000 && gcd(f.p, f.q) === 1).length;

document.getElementById('sbLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Stern-Brocot Tree | FIELD: ‚Ñö‚Å∫ | TYPE: Binary Tree of Rationals</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${depth}</div><div style="font-size:.7rem;color:var(--txt2)">DEPTH</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fracCount}</div><div style="font-size:.7rem;color:var(--txt2)">FRACTIONS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${Math.pow(2, depth)}</div><div style="font-size:.7rem;color:var(--txt2)">LEAVES</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Mediant rule:</strong> a/b ‚äï c/d = (a+c)/(b+d)<br>
<strong style="color:var(--acc)">Property:</strong> Every positive rational appears exactly once<br>
<strong style="color:var(--acc)">Connection:</strong> Equivalent to Farey sequence construction
</div>`;
}

async function screenshotSternBrocot() { await screenshotUnified('csb', 'sbLiveStats', 'Stern-Brocot Tree', 'sternbrocot.png'); }
function exportAllSternBrocot() { screenshotTabAll({ canvases: ['csb'], dashId: 'sbLiveStats', title: 'Stern-Brocot Tree', filename: 'sternbrocot_all.png' }); }

// ==================== PYTHAGOREAN TRIPLES ====================
let pythagData = [];

function drawPythag() {
const maxC = +document.getElementById('pythCv').value || 100;
const mode = document.getElementById('pythMode').value;
const c = document.getElementById('cpyth'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

pythagData = [];
// Generate using parametrization: a = m¬≤-n¬≤, b = 2mn, c = m¬≤+n¬≤ for m>n>0, gcd(m,n)=1, m-n odd
for (let m = 2; m * m < maxC; m++) {
for (let n = 1; n < m; n++) {
if ((m - n) % 2 === 0) continue; // m-n must be odd
if (gcd(m, n) !== 1) continue;
let a = m * m - n * n;
let b = 2 * m * n;
let c_val = m * m + n * n;
if (c_val > maxC) continue;
if (a > b) [a, b] = [b, a];
pythagData.push({ a, b, c: c_val, m, n, primitive: true });
// Add non-primitive if mode is 'all'
if (mode === 'all') {
for (let k = 2; k * c_val <= maxC; k++) {
pythagData.push({ a: k * a, b: k * b, c: k * c_val, m, n, primitive: false });
}
}
}
}

// Sort by hypotenuse
pythagData.sort((x, y) => x.c - y.c);

// Draw
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
pythagData.slice(0, 200).forEach((t, i) => {
const x = pad + (t.a / maxC) * w;
const y = c.height - pad - (t.b / maxC) * h;
ctx.fillStyle = t.primitive ? '#ffd700' : '#666';
ctx.beginPath();
ctx.arc(x, y, t.primitive ? 5 : 3, 0, 2 * PI);
ctx.fill();
});

// Draw a¬≤+b¬≤=c¬≤ curve
ctx.strokeStyle = '#ff6496';
ctx.lineWidth = 1;
ctx.setLineDash([5, 5]);
for (let cVal = 10; cVal <= maxC; cVal += 20) {
ctx.beginPath();
for (let a = 1; a < cVal; a++) {
const b = Math.sqrt(cVal * cVal - a * a);
if (b > 0 && b < maxC) {
const x = pad + (a / maxC) * w;
const y = c.height - pad - (b / maxC) * h;
if (a === 1) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
}
}
ctx.stroke();
}
ctx.setLineDash([]);

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Pythagorean Triples a¬≤ + b¬≤ = c¬≤, c ‚â§ ${maxC}`, c.width / 2, 25);

const primCount = pythagData.filter(t => t.primitive).length;

document.getElementById('pythLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Pythagorean Triples | FIELD: ‚Ñ§¬≥ | TYPE: a¬≤ + b¬≤ = c¬≤</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${primCount}</div><div style="font-size:.7rem;color:var(--txt2)">PRIMITIVE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${pythagData.length}</div><div style="font-size:.7rem;color:var(--txt2)">TOTAL</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${maxC}</div><div style="font-size:.7rem;color:var(--txt2)">MAX c</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">First triples:</strong> ${pythagData.slice(0, 5).map(t => `(${t.a},${t.b},${t.c})`).join(', ')}<br>
<strong style="color:var(--acc)">Parametrization:</strong> a=m¬≤-n¬≤, b=2mn, c=m¬≤+n¬≤<br>
<strong style="color:var(--acc)">Famous:</strong> (3,4,5), (5,12,13), (8,15,17)
</div>`;

Plotly.newPlot('ppyth1', [{ x: pythagData.filter(t => t.primitive).map(t => t.c), y: pythagData.filter(t => t.primitive).map((_, i) => i + 1), mode: 'lines+markers', marker: { size: 4, color: '#ffd700' } }], { ...plo(), xaxis: { title: 'Hypotenuse c' }, yaxis: { title: 'Cumulative Count' } });
}

function csvPythag() { let s = 'a,b,c,primitive\n'; pythagData.forEach(t => s += `${t.a},${t.b},${t.c},${t.primitive}\n`); dl(s, 'pythagorean.csv'); }
async function screenshotPythag() { await screenshotUnified('cpyth', 'pythLiveStats', 'Pythagorean Triples', 'pythagorean.png'); }
function exportAllPythag() { screenshotTabAll({ canvases: ['cpyth'], charts: ['ppyth1'], dashId: 'pythLiveStats', title: 'Pythagorean Triples', filename: 'pythagorean_all.png' }); }

// ==================== SUM OF SQUARES ====================
let ssqData = [];

function sumOfSquaresCount(n, k) {
if (k === 2) {
// r_2(n): count representations as sum of 2 squares
let count = 0;
for (let a = 0; a * a <= n; a++) {
const b2 = n - a * a;
const b = Math.sqrt(b2);
if (b === Math.floor(b)) count++;
}
return count * 4; // Account for signs and order
} else if (k === 4) {
// r_4(n) = 8 * sum of divisors not divisible by 4
let sum = 0;
for (let d = 1; d <= n; d++) {
if (n % d === 0 && d % 4 !== 0) sum += d;
}
return 8 * sum;
}
return 0;
}

function drawSumSquares() {
const maxN = +document.getElementById('ssqNv').value || 100;
const k = +document.getElementById('ssqK').value;
const c = document.getElementById('cssq'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

ssqData = [];
for (let n = 1; n <= maxN; n++) {
const r = sumOfSquaresCount(n, k);
ssqData.push({ n, r, representable: r > 0 });
}

// Draw grid
const pad = 50, size = Math.min((c.width - 2 * pad) / 20, (c.height - 2 * pad) / Math.ceil(maxN / 20));
ssqData.forEach((d, i) => {
const col = i % 20;
const row = Math.floor(i / 20);
const x = pad + col * size;
const y = pad + 30 + row * size;
const intensity = Math.min(1, d.r / 20);
ctx.fillStyle = d.r === 0 ? '#333' : `hsl(${120 - intensity * 120}, 80%, ${40 + intensity * 30}%)`;
ctx.fillRect(x, y, size - 1, size - 1);
});

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Sum of ${k} Squares: r_${k}(n) representations`, c.width / 2, 25);

const representable = ssqData.filter(d => d.r > 0).length;
const avgR = ssqData.reduce((a, d) => a + d.r, 0) / maxN;

document.getElementById('ssqLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Sum of Squares | FIELD: ‚Ñ§ | TYPE: r_${k}(n) Counting</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00d9ff">${representable}</div><div style="font-size:.7rem;color:var(--txt2)">REPRESENTABLE</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${fmt(avgR)}</div><div style="font-size:.7rem;color:var(--txt2)">AVG r_${k}(n)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${fmt(100 * representable / maxN)}%</div><div style="font-size:.7rem;color:var(--txt2)">DENSITY</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Fermat (k=2):</strong> n = a¬≤ + b¬≤ ‚ü∫ all primes ‚â° 3 (mod 4) appear even times<br>
<strong style="color:var(--acc)">Lagrange (k=4):</strong> Every n is sum of 4 squares<br>
<strong style="color:var(--acc)">Jacobi:</strong> r_4(n) = 8¬∑Œ£d|n,4‚à§d d
</div>`;

Plotly.newPlot('pssq1', [{ x: ssqData.map(d => d.n), y: ssqData.map(d => d.r), type: 'bar', marker: { color: ssqData.map(d => d.r > 0 ? '#ffd700' : '#333') } }], { ...plo(), xaxis: { title: 'n' }, yaxis: { title: `r_${k}(n)` } });
}

function csvSumSquares() { let s = 'n,r_k\n'; ssqData.forEach(d => s += `${d.n},${d.r}\n`); dl(s, 'sum_of_squares.csv'); }
async function screenshotSumSquares() { await screenshotUnified('cssq', 'ssqLiveStats', 'Sum of Squares', 'sum_of_squares.png'); }
function exportAllSumSquares() { screenshotTabAll({ canvases: ['cssq'], charts: ['pssq1'], dashId: 'ssqLiveStats', title: 'Sum of Squares', filename: 'sumsquares_all.png' }); }

// ==================== QUADRATIC RESIDUES ====================
let qrData = [];

function legendreSymbol(a, p) {
if (a % p === 0) return 0;
const exp = (p - 1) / 2;
let result = 1, base = ((a % p) + p) % p;
let e = exp;
while (e > 0) {
if (e % 2 === 1) result = (result * base) % p;
base = (base * base) % p;
e = Math.floor(e / 2);
}
return result === 1 ? 1 : -1;
}

function drawQuadRes() {
let p = +document.getElementById('qrPv').value || 23;
// Ensure p is prime
while (!isPrime(p) && p > 2) p--;
document.getElementById('qrPv').value = p;
document.getElementById('qrP').value = Math.min(p, 200);

const mode = document.getElementById('qrMode').value;
const c = document.getElementById('cqr'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Compute quadratic residues
qrData = [];
const residues = new Set();
for (let a = 1; a < p; a++) {
const sq = (a * a) % p;
residues.add(sq);
}
for (let a = 1; a < p; a++) {
qrData.push({ a, isResidue: residues.has(a), legendre: legendreSymbol(a, p) });
}

if (mode === 'grid') {
// Draw grid
const pad = 50, size = Math.min((c.width - 2 * pad) / Math.min(p, 30), 20);
const cols = Math.min(p - 1, 30);
qrData.slice(0, 100).forEach((d, i) => {
const col = i % cols;
const row = Math.floor(i / cols);
const x = pad + col * size;
const y = pad + 40 + row * size;
ctx.fillStyle = d.isResidue ? '#00ff88' : '#ff6496';
ctx.fillRect(x, y, size - 2, size - 2);
if (size > 15) {
ctx.fillStyle = '#000';
ctx.font = '10px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(d.a.toString(), x + size / 2, y + size / 2 + 3);
}
});
} else if (mode === 'paley') {
// Paley graph - vertices on circle, edges between QRs
const cx = c.width / 2, cy = c.height / 2, r = Math.min(cx, cy) - 60;
// Draw edges
ctx.strokeStyle = 'rgba(0,217,255,0.3)';
ctx.lineWidth = 1;
for (let i = 0; i < p; i++) {
for (let j = i + 1; j < p; j++) {
if (residues.has((j - i + p) % p) || residues.has((i - j + p) % p)) {
const a1 = 2 * PI * i / p - PI / 2;
const a2 = 2 * PI * j / p - PI / 2;
ctx.beginPath();
ctx.moveTo(cx + r * Math.cos(a1), cy + r * Math.sin(a1));
ctx.lineTo(cx + r * Math.cos(a2), cy + r * Math.sin(a2));
ctx.stroke();
}
}
}
// Draw vertices
for (let i = 0; i < p; i++) {
const angle = 2 * PI * i / p - PI / 2;
const x = cx + r * Math.cos(angle);
const y = cy + r * Math.sin(angle);
ctx.fillStyle = '#ffd700';
ctx.beginPath();
ctx.arc(x, y, 6, 0, 2 * PI);
ctx.fill();
}
}

ctx.fillStyle = isDark() ? '#00ff88' : '#008844';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Quadratic Residues mod ${p}`, c.width / 2, 25);

const qrCount = qrData.filter(d => d.isResidue).length;

document.getElementById('qrLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,255,136,.15),rgba(255,100,150,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #00ff88">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Quadratic Residues | FIELD: (‚Ñ§/p‚Ñ§)* | TYPE: Legendre Symbol</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#00ff88">${qrCount}</div><div style="font-size:.7rem;color:var(--txt2)">RESIDUES (QR)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ff6496">${p - 1 - qrCount}</div><div style="font-size:.7rem;color:var(--txt2)">NON-RESIDUES</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.3rem;font-weight:bold;color:#ffd700">${(p - 1) / 2}</div><div style="font-size:.7rem;color:var(--txt2)">THEORY (p-1)/2</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">QR mod ${p}:</strong> {${[...residues].sort((a, b) => a - b).slice(0, 10).join(', ')}${residues.size > 10 ? '...' : ''}}<br>
<strong style="color:var(--acc)">Euler criterion:</strong> a^((p-1)/2) ‚â° (a/p) (mod p)<br>
<strong style="color:var(--acc)">Quadratic reciprocity:</strong> (p/q)(q/p) = (-1)^((p-1)(q-1)/4)
</div>`;

Plotly.newPlot('pqr1', [{ x: qrData.map(d => d.a), y: qrData.map(d => d.legendre), type: 'bar', marker: { color: qrData.map(d => d.legendre === 1 ? '#00ff88' : '#ff6496') } }], { ...plo(), xaxis: { title: 'a' }, yaxis: { title: '(a/p)', range: [-1.5, 1.5] } });
}

function csvQuadRes() { let s = 'a,is_residue,legendre\n'; qrData.forEach(d => s += `${d.a},${d.isResidue},${d.legendre}\n`); dl(s, 'quadratic_residues.csv'); }
async function screenshotQuadRes() { await screenshotUnified('cqr', 'qrLiveStats', 'Quadratic Residues', 'quadres.png'); }
function exportAllQuadRes() { screenshotTabAll({ canvases: ['cqr'], charts: ['pqr1'], dashId: 'qrLiveStats', title: 'Quadratic Residues', filename: 'quadres_all.png' }); }

// ==================== PARTITION FUNCTION ====================
let partitionData = [];
const partitionCache = { 0: 1, 1: 1 };

function partition(n) {
if (n < 0) return 0;
if (partitionCache[n] !== undefined) return partitionCache[n];
let sum = 0;
for (let k = 1; k <= n; k++) {
const p1 = n - k * (3 * k - 1) / 2;
const p2 = n - k * (3 * k + 1) / 2;
const sign = k % 2 === 1 ? 1 : -1;
sum += sign * (partition(p1) + partition(p2));
}
partitionCache[n] = sum;
return sum;
}

function drawPartition() {
const maxN = +document.getElementById('partNv').value || 50;
const testN = +document.getElementById('partTest').value || 10;
const mode = document.getElementById('partMode').value;
const c = document.getElementById('cpart'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

partitionData = [];
for (let n = 0; n <= maxN; n++) {
partitionData.push({ n, p: partition(n) });
}

if (mode === 'ferrers') {
// Draw Ferrers diagrams for testN
const partitions = [];
function generatePartitions(n, max, current) {
if (n === 0) { partitions.push([...current]); return; }
for (let i = Math.min(n, max); i >= 1; i--) {
current.push(i);
generatePartitions(n - i, i, current);
current.pop();
}
}
generatePartitions(Math.min(testN, 12), Math.min(testN, 12), []);

const pad = 40, dotSize = 8;
const cols = Math.min(4, partitions.length);
const boxW = (c.width - 2 * pad) / cols;
const boxH = 60;

partitions.slice(0, 20).forEach((p, idx) => {
const col = idx % cols;
const row = Math.floor(idx / cols);
const bx = pad + col * boxW;
const by = pad + 40 + row * boxH;
p.forEach((count, i) => {
for (let j = 0; j < count; j++) {
ctx.fillStyle = `hsl(${i * 40}, 70%, 60%)`;
ctx.beginPath();
ctx.arc(bx + 10 + j * (dotSize + 2), by + i * (dotSize + 2), dotSize / 2, 0, 2 * PI);
ctx.fill();
}
});
});
} else {
// Growth chart
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const maxP = Math.max(...partitionData.map(d => d.p));
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 2;
ctx.beginPath();
partitionData.forEach((d, i) => {
const x = pad + (i / maxN) * w;
const y = c.height - pad - (Math.log(d.p + 1) / Math.log(maxP + 1)) * h;
if (i === 0) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
});
ctx.stroke();
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Partition Function p(n) ‚Äî n ‚â§ ${maxN}`, c.width / 2, 25);

const pTest = partition(testN);
const hrApprox = Math.exp(PI * Math.sqrt(2 * testN / 3)) / (4 * testN * Math.sqrt(3));

document.getElementById('partLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Partition Function | FIELD: ‚Ñ§‚Å∫ | TYPE: p(n) Integer Partitions</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${pTest.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">p(${testN})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${fmt(hrApprox)}</div><div style="font-size:.7rem;color:var(--txt2)">H-R APPROX</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${partition(maxN).toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">p(${maxN})</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Hardy-Ramanujan:</strong> p(n) ~ e^(œÄ‚àö(2n/3)) / (4n‚àö3)<br>
<strong style="color:var(--acc)">Ramanujan congruences:</strong><br>
‚Ä¢ p(5n+4) ‚â° 0 (mod 5)<br>
‚Ä¢ p(7n+5) ‚â° 0 (mod 7)<br>
‚Ä¢ p(11n+6) ‚â° 0 (mod 11)
</div>`;

Plotly.newPlot('ppart1', [{ x: partitionData.map(d => d.n), y: partitionData.map(d => d.p), mode: 'lines+markers', line: { color: '#ffd700' } }], { ...plo(), xaxis: { title: 'n' }, yaxis: { title: 'p(n)', type: 'log' } });
}

function csvPartition() { let s = 'n,p\n'; partitionData.forEach(d => s += `${d.n},${d.p}\n`); dl(s, 'partitions.csv'); }
async function screenshotPartition() { await screenshotUnified('cpart', 'partLiveStats', 'Partition Function', 'partition.png'); }
function exportAllPartition() { screenshotTabAll({ canvases: ['cpart'], charts: ['ppart1'], dashId: 'partLiveStats', title: 'Partition Function', filename: 'partition_all.png' }); }

// ==================== BERNOULLI NUMBERS ====================
let bernoulliData = [];

function bernoulli(n) {
if (n === 0) return 1;
if (n === 1) return -0.5;
if (n % 2 === 1) return 0;
const A = [1];
for (let m = 1; m <= n; m++) {
A[m] = 1 / (m + 1);
for (let j = m; j >= 1; j--) {
A[j - 1] = j * (A[j - 1] - A[j]);
}
}
return A[0];
}

function drawBernoulli() {
const maxN = +document.getElementById('bernNv').value || 20;
const mode = document.getElementById('bernMode').value;
const c = document.getElementById('cbern'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

bernoulliData = [];
for (let n = 0; n <= maxN; n++) {
const b = bernoulli(n);
const zetaNeg = n > 0 ? -b / n : null; // Œ∂(-n) = -B_{n+1}/(n+1) for n >= 0
bernoulliData.push({ n, b, zetaNeg });
}

// Display values
const pad = 50;
ctx.font = '12px monospace';
bernoulliData.filter(d => d.b !== 0).slice(0, 15).forEach((d, i) => {
const y = pad + 30 + i * 25;
ctx.fillStyle = d.b > 0 ? '#00ff88' : '#ff6496';
ctx.textAlign = 'left';
const bStr = Math.abs(d.b) < 0.001 || Math.abs(d.b) > 1000 ? d.b.toExponential(4) : d.b.toFixed(6);
ctx.fillText(`B${d.n} = ${bStr}`, pad, y);
if (d.n > 0 && d.n % 2 === 0) {
ctx.fillStyle = '#ffd700';
ctx.fillText(`‚Üí Œ∂(${d.n}) = ${fmt(Math.abs(d.b) * Math.pow(2 * PI, d.n) / (2 * factorial(d.n)))}`, pad + 200, y);
}
});

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Bernoulli Numbers B‚Çô ‚Äî n ‚â§ ${maxN}`, c.width / 2, 25);

const nonzero = bernoulliData.filter(d => d.b !== 0).length;

document.getElementById('bernLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Bernoulli Numbers | FIELD: ‚Ñö | TYPE: B‚Çô Sequence</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${nonzero}</div><div style="font-size:.7rem;color:var(--txt2)">NON-ZERO</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${fmt(bernoulli(2))}</div><div style="font-size:.7rem;color:var(--txt2)">B‚ÇÇ = 1/6</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${fmt(bernoulli(4))}</div><div style="font-size:.7rem;color:var(--txt2)">B‚ÇÑ = -1/30</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Zeta connection:</strong> Œ∂(2n) = (-1)^(n+1) B_{2n}(2œÄ)^{2n} / (2(2n)!)<br>
<strong style="color:var(--acc)">Property:</strong> B_{2n+1} = 0 for n ‚â• 1<br>
<strong style="color:var(--acc)">Power sums:</strong> 1^k + 2^k + ... + n^k involves B‚Çñ
</div>`;

const nonzeroData = bernoulliData.filter(d => d.b !== 0);
Plotly.newPlot('pbern1', [{ x: nonzeroData.map(d => d.n), y: nonzeroData.map(d => d.b), type: 'bar', marker: { color: nonzeroData.map(d => d.b > 0 ? '#00ff88' : '#ff6496') } }], { ...plo(), xaxis: { title: 'n' }, yaxis: { title: 'B‚Çô' } });
}

function factorial(n) { let r = 1; for (let i = 2; i <= n; i++) r *= i; return r; }
function csvBernoulli() { let s = 'n,B_n\n'; bernoulliData.forEach(d => s += `${d.n},${d.b}\n`); dl(s, 'bernoulli.csv'); }
async function screenshotBernoulli() { await screenshotUnified('cbern', 'bernLiveStats', 'Bernoulli Numbers', 'bernoulli.png'); }
function exportAllBernoulli() { screenshotTabAll({ canvases: ['cbern'], charts: ['pbern1'], dashId: 'bernLiveStats', title: 'Bernoulli Numbers', filename: 'bernoulli_all.png' }); }

// ==================== FIBONACCI ====================
let fibData = [];

function drawFibonacci() {
const maxN = +document.getElementById('fibNv').value || 30;
const mode = document.getElementById('fibMode').value;
const c = document.getElementById('cfib'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

fibData = [{ n: 0, f: 0 }, { n: 1, f: 1 }];
for (let n = 2; n <= maxN; n++) {
fibData.push({ n, f: fibData[n - 1].f + fibData[n - 2].f });
}

const phi = (1 + Math.sqrt(5)) / 2;

if (mode === 'spiral') {
// Draw golden spiral
const cx = c.width / 2, cy = c.height / 2;
const scale = Math.min(c.width, c.height) / 30;
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 2;
ctx.beginPath();
for (let t = 0; t < 6 * PI; t += 0.05) {
const r = Math.pow(phi, t * 2 / PI) * scale;
const x = cx + r * Math.cos(t);
const y = cy + r * Math.sin(t);
if (t === 0) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
}
ctx.stroke();

// Draw squares
let x = cx, y = cy, size = scale;
for (let i = 0; i < Math.min(10, fibData.length - 1); i++) {
ctx.strokeStyle = `hsl(${i * 36}, 70%, 50%)`;
ctx.strokeRect(x, y, size, size);
size *= phi;
}
} else if (mode === 'ratio') {
// Show convergence to phi
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 2;
ctx.beginPath();
for (let i = 2; i < fibData.length; i++) {
const ratio = fibData[i].f / fibData[i - 1].f;
const x = pad + ((i - 2) / (fibData.length - 3)) * w;
const y = c.height - pad - ((ratio - 1) / (phi - 1 + 0.5)) * h;
if (i === 2) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
}
ctx.stroke();
// Draw phi line
ctx.strokeStyle = '#ff6496';
ctx.setLineDash([5, 5]);
const phiY = c.height - pad - ((phi - 1) / (phi - 1 + 0.5)) * h;
ctx.beginPath();
ctx.moveTo(pad, phiY);
ctx.lineTo(c.width - pad, phiY);
ctx.stroke();
ctx.setLineDash([]);
} else if (mode === 'pisano') {
// Pisano periods
const periods = [];
for (let m = 2; m <= 20; m++) {
let f0 = 0, f1 = 1, period = 0;
do {
[f0, f1] = [f1, (f0 + f1) % m];
period++;
} while (!(f0 === 0 && f1 === 1) && period < 1000);
periods.push({ m, period });
}
const pad = 50;
periods.forEach((p, i) => {
ctx.fillStyle = '#ffd700';
ctx.fillRect(pad + i * 30, c.height - pad - p.period * 3, 25, p.period * 3);
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = '10px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(p.m.toString(), pad + i * 30 + 12, c.height - pad + 15);
});
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Fibonacci Sequence ‚Äî ${maxN} terms, œÜ = ${phi.toFixed(8)}`, c.width / 2, 25);

const lastRatio = fibData.length > 2 ? fibData[fibData.length - 1].f / fibData[fibData.length - 2].f : 1;

document.getElementById('fibLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Fibonacci | FIELD: ‚Ñ§ | TYPE: Golden Ratio œÜ</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#ffd700">${fibData[fibData.length - 1].f.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">F_${maxN}</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#00d9ff">${phi.toFixed(8)}</div><div style="font-size:.7rem;color:var(--txt2)">œÜ GOLDEN</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#00ff88">${(lastRatio - phi).toExponential(2)}</div><div style="font-size:.7rem;color:var(--txt2)">RATIO ERROR</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Binet:</strong> F‚Çô = (œÜ‚Åø - œà‚Åø)/‚àö5, œà = (1-‚àö5)/2<br>
<strong style="color:var(--acc)">Zeckendorf:</strong> Every n = unique sum of non-adjacent F·µ¢<br>
<strong style="color:var(--acc)">Pisano:</strong> F‚Çô mod m is periodic with period œÄ(m)
</div>`;

const ratios = fibData.slice(2).map((d, i) => ({ n: i + 2, ratio: d.f / fibData[i + 1].f }));
Plotly.newPlot('pfib1', [
{ x: ratios.map(r => r.n), y: ratios.map(r => r.ratio), mode: 'lines+markers', name: 'F‚Çô/F‚Çô‚Çã‚ÇÅ', line: { color: '#ffd700' } },
{ x: [ratios[0].n, ratios[ratios.length - 1].n], y: [phi, phi], mode: 'lines', name: 'œÜ', line: { color: '#ff6496', dash: 'dash' } }
], { ...plo(), xaxis: { title: 'n' }, yaxis: { title: 'Ratio', range: [1.5, 1.7] } });
}

function csvFibonacci() { let s = 'n,F_n\n'; fibData.forEach(d => s += `${d.n},${d.f}\n`); dl(s, 'fibonacci.csv'); }
async function screenshotFibonacci() { await screenshotUnified('cfib', 'fibLiveStats', 'Fibonacci Sequence', 'fibonacci.png'); }
function exportAllFibonacci() { screenshotTabAll({ canvases: ['cfib'], charts: ['pfib1'], dashId: 'fibLiveStats', title: 'Fibonacci', filename: 'fibonacci_all.png' }); }

// ==================== CATALAN NUMBERS ====================
let catalanData = [];

function catalan(n) {
if (n <= 1) return 1;
let c = 1;
for (let i = 0; i < n; i++) {
c = c * 2 * (2 * i + 1) / (i + 2);
}
return Math.round(c);
}

function drawCatalan() {
const maxN = +document.getElementById('catNv').value || 15;
const mode = document.getElementById('catMode').value;
const c = document.getElementById('ccat'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

catalanData = [];
for (let n = 0; n <= maxN; n++) {
catalanData.push({ n, c: catalan(n) });
}

if (mode === 'lattice' || mode === 'dyck') {
// Draw example Dyck paths for small n
const testN = Math.min(4, maxN);
const pad = 50, size = 40;
const paths = generateDyckPaths(testN);

paths.slice(0, 14).forEach((path, idx) => {
const col = idx % 7;
const row = Math.floor(idx / 7);
const bx = pad + col * 90;
const by = pad + 40 + row * 90;

ctx.strokeStyle = '#666';
ctx.lineWidth = 1;
// Draw grid
for (let i = 0; i <= testN; i++) {
ctx.beginPath();
ctx.moveTo(bx, by + i * 15);
ctx.lineTo(bx + testN * 15, by + i * 15);
ctx.moveTo(bx + i * 15, by);
ctx.lineTo(bx + i * 15, by + testN * 15);
ctx.stroke();
}

// Draw path
ctx.strokeStyle = '#ffd700';
ctx.lineWidth = 2;
ctx.beginPath();
let x = bx, y = by + testN * 15;
ctx.moveTo(x, y);
path.forEach(step => {
if (step === 1) { x += 15; } else { y -= 15; }
ctx.lineTo(x, y);
});
ctx.stroke();
});
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Catalan Numbers C‚Çô ‚Äî n ‚â§ ${maxN}`, c.width / 2, 25);

document.getElementById('catLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Catalan Numbers | FIELD: ‚Ñ§ | TYPE: C‚Çô Combinatorics</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#ffd700">${catalan(maxN).toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">C_${maxN}</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#00d9ff">C(2n,n)/(n+1)</div><div style="font-size:.7rem;color:var(--txt2)">FORMULA</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.1rem;font-weight:bold;color:#00ff88">4‚Åø/n^1.5</div><div style="font-size:.7rem;color:var(--txt2)">GROWTH</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Counts:</strong> Dyck paths, binary trees, triangulations, valid parentheses<br>
<strong style="color:var(--acc)">Recurrence:</strong> C‚Çô = Œ£ C·µ¢ C‚Çô‚Çã‚ÇÅ‚Çã·µ¢<br>
<strong style="color:var(--acc)">First values:</strong> 1, 1, 2, 5, 14, 42, 132, 429...
</div>`;

Plotly.newPlot('pcat1', [{ x: catalanData.map(d => d.n), y: catalanData.map(d => d.c), mode: 'lines+markers', line: { color: '#ffd700' } }], { ...plo(), xaxis: { title: 'n' }, yaxis: { title: 'C‚Çô', type: 'log' } });
}

function generateDyckPaths(n) {
const paths = [];
function generate(path, x, y) {
if (x === n && y === n) { paths.push([...path]); return; }
if (x < n) { path.push(1); generate(path, x + 1, y); path.pop(); }
if (y < x) { path.push(0); generate(path, x, y + 1); path.pop(); }
}
generate([], 0, 0);
return paths;
}

function csvCatalan() { let s = 'n,C_n\n'; catalanData.forEach(d => s += `${d.n},${d.c}\n`); dl(s, 'catalan.csv'); }
async function screenshotCatalan() { await screenshotUnified('ccat', 'catLiveStats', 'Catalan Numbers', 'catalan.png'); }
function exportAllCatalan() { screenshotTabAll({ canvases: ['ccat'], charts: ['pcat1'], dashId: 'catLiveStats', title: 'Catalan Numbers', filename: 'catalan_all.png' }); }

// ==================== ALIQUOT SEQUENCES ====================
let aliquotData = [];

function aliquotSum(n) {
let sum = 0;
for (let d = 1; d < n; d++) if (n % d === 0) sum += d;
return sum;
}

function drawAliquot() {
const startN = +document.getElementById('aliqNv').value || 276;
const maxSteps = +document.getElementById('aliqSteps').value || 100;
const mode = document.getElementById('aliqMode').value;
const c = document.getElementById('caliq'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

aliquotData = [];

if (mode === 'single') {
let n = startN;
const seen = new Set();
for (let step = 0; step < maxSteps && n > 0 && n < 1e9; step++) {
if (seen.has(n)) { aliquotData.push({ step, n, cycle: true }); break; }
seen.add(n);
aliquotData.push({ step, n, cycle: false });
n = aliquotSum(n);
}

// Draw trajectory
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const maxVal = Math.max(...aliquotData.map(d => d.n));
ctx.strokeStyle = '#00d9ff';
ctx.lineWidth = 2;
ctx.beginPath();
aliquotData.forEach((d, i) => {
const x = pad + (i / aliquotData.length) * w;
const y = c.height - pad - (Math.log(d.n + 1) / Math.log(maxVal + 1)) * h;
if (i === 0) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
});
ctx.stroke();
} else {
// Classify
const classifications = { perfect: [], amicable: [], sociable: [], terminating: [], unknown: [] };
for (let n = 2; n <= Math.min(startN, 1000); n++) {
let seq = [n], seen = new Set([n]);
for (let i = 0; i < 50 && seq[seq.length - 1] > 0 && seq[seq.length - 1] < 1e7; i++) {
const next = aliquotSum(seq[seq.length - 1]);
if (next === 0) { classifications.terminating.push(n); break; }
if (next === n && seq.length === 1) { classifications.perfect.push(n); break; }
if (seen.has(next)) {
if (next === n && seq.length === 2) classifications.amicable.push(n);
else classifications.sociable.push(n);
break;
}
seen.add(next);
seq.push(next);
}
}

const pad = 50;
let y = pad + 30;
Object.entries(classifications).forEach(([type, nums]) => {
if (nums.length > 0) {
ctx.fillStyle = type === 'perfect' ? '#ffd700' : type === 'amicable' ? '#00ff88' : '#00d9ff';
ctx.font = '12px Segoe UI';
ctx.fillText(`${type}: ${nums.slice(0, 10).join(', ')}${nums.length > 10 ? '...' : ''}`, pad, y);
y += 25;
}
});
}

ctx.fillStyle = isDark() ? '#00d9ff' : '#0066cc';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Aliquot Sequence from ${startN}`, c.width / 2, 25);

const finalN = aliquotData.length > 0 ? aliquotData[aliquotData.length - 1].n : startN;
const maxN = aliquotData.length > 0 ? Math.max(...aliquotData.map(d => d.n)) : startN;

document.getElementById('aliqLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(0,217,255,.15),rgba(255,215,0,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid var(--acc)">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Aliquot Sequences | FIELD: ‚Ñ§ | TYPE: s(n) = œÉ(n) - n Iteration</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${startN}</div><div style="font-size:.7rem;color:var(--txt2)">START</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${aliquotData.length}</div><div style="font-size:.7rem;color:var(--txt2)">STEPS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${maxN.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">MAX VALUE</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Types:</strong> Perfect (n‚Üín), Amicable (n‚Üím‚Üín), Sociable (cycles)<br>
<strong style="color:var(--acc)">Open problem:</strong> Does 276 sequence terminate?<br>
<strong style="color:var(--acc)">Perfect numbers:</strong> 6, 28, 496, 8128...
</div>`;

if (aliquotData.length > 0) {
Plotly.newPlot('paliq1', [{ x: aliquotData.map(d => d.step), y: aliquotData.map(d => d.n), mode: 'lines+markers', line: { color: '#00d9ff' } }], { ...plo(), xaxis: { title: 'Step' }, yaxis: { title: 'Value', type: 'log' } });
}
}

function csvAliquot() { let s = 'step,n\n'; aliquotData.forEach(d => s += `${d.step},${d.n}\n`); dl(s, 'aliquot.csv'); }
async function screenshotAliquot() { await screenshotUnified('caliq', 'aliqLiveStats', 'Aliquot Sequence', 'aliquot.png'); }
function exportAllAliquot() { screenshotTabAll({ canvases: ['caliq'], charts: ['paliq1'], dashId: 'aliqLiveStats', title: 'Aliquot Sequences', filename: 'aliquot_all.png' }); }

// ==================== CYCLOTOMIC POLYNOMIALS ====================
let cycData = [];

function drawCyclotomic() {
const maxN = +document.getElementById('cycNv').value || 20;
const mode = document.getElementById('cycMode').value;
const c = document.getElementById('ccyc'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

cycData = [];
for (let n = 1; n <= maxN; n++) {
const phi_n = totient(n);
cycData.push({ n, degree: phi_n });
}

if (mode === 'roots') {
// Draw roots of unity on unit circle
const cx = c.width / 2, cy = c.height / 2, r = Math.min(cx, cy) - 60;

// Unit circle
ctx.strokeStyle = gridC();
ctx.lineWidth = 1;
ctx.beginPath();
ctx.arc(cx, cy, r, 0, 2 * PI);
ctx.stroke();

// Draw primitive roots for each n
const testN = Math.min(maxN, 12);
for (let k = 0; k < testN; k++) {
if (gcd(k, testN) === 1) {
const angle = 2 * PI * k / testN;
const x = cx + r * Math.cos(angle);
const y = cy - r * Math.sin(angle);
ctx.fillStyle = '#ffd700';
ctx.beginPath();
ctx.arc(x, y, 6, 0, 2 * PI);
ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = '10px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Œ∂^${k}`, x, y - 10);
}
}
} else {
// Show degrees
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const maxDeg = Math.max(...cycData.map(d => d.degree));
cycData.forEach((d, i) => {
const x = pad + (i / cycData.length) * w;
const barH = (d.degree / maxDeg) * h;
ctx.fillStyle = isPrime(d.n) ? '#ffd700' : '#00d9ff';
ctx.fillRect(x, c.height - pad - barH, w / cycData.length - 2, barH);
});
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Cyclotomic Polynomials Œ¶‚Çô(x) ‚Äî n ‚â§ ${maxN}`, c.width / 2, 25);

document.getElementById('cycLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Cyclotomic Polynomials | FIELD: ‚ÑÇ | TYPE: Œ¶‚Çô(x) = ‚àè(x - Œ∂‚Åø)</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${maxN}</div><div style="font-size:.7rem;color:var(--txt2)">MAX n</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${totient(maxN)}</div><div style="font-size:.7rem;color:var(--txt2)">deg Œ¶_${maxN} = œÜ(${maxN})</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">Œ∂‚Çô = e^(2œÄi/n)</div><div style="font-size:.7rem;color:var(--txt2)">ROOT</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Definition:</strong> Œ¶‚Çô(x) = ‚àè_{gcd(k,n)=1} (x - e^(2œÄik/n))<br>
<strong style="color:var(--acc)">Property:</strong> x‚Åø - 1 = ‚àè_{d|n} Œ¶_d(x)<br>
<strong style="color:var(--acc)">Degree:</strong> deg Œ¶‚Çô = œÜ(n)
</div>`;

Plotly.newPlot('pcyc1', [{ x: cycData.map(d => d.n), y: cycData.map(d => d.degree), type: 'bar', marker: { color: cycData.map(d => isPrime(d.n) ? '#ffd700' : '#00d9ff') } }], { ...plo(), xaxis: { title: 'n' }, yaxis: { title: 'œÜ(n) = deg Œ¶‚Çô' } });
}

function csvCyclotomic() { let s = 'n,degree\n'; cycData.forEach(d => s += `${d.n},${d.degree}\n`); dl(s, 'cyclotomic.csv'); }
async function screenshotCyclotomic() { await screenshotUnified('ccyc', 'cycLiveStats', 'Cyclotomic Polynomials', 'cyclotomic.png'); }
function exportAllCyclotomic() { screenshotTabAll({ canvases: ['ccyc'], charts: ['pcyc1'], dashId: 'cycLiveStats', title: 'Cyclotomic Polynomials', filename: 'cyclotomic_all.png' }); }

// ==================== COLLATZ CONJECTURE ====================
let collatzData = [];

function collatzSequence(n, maxSteps = 1000) {
const seq = [n];
while (n !== 1 && seq.length < maxSteps) {
n = n % 2 === 0 ? n / 2 : 3 * n + 1;
seq.push(n);
}
return seq;
}

function drawCollatz() {
const startN = +document.getElementById('collNv').value || 27;
const mode = document.getElementById('collMode').value;
const c = document.getElementById('ccoll'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

if (mode === 'single') {
collatzData = collatzSequence(startN).map((n, i) => ({ step: i, n }));

const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const maxVal = Math.max(...collatzData.map(d => d.n));

ctx.strokeStyle = '#ff6496';
ctx.lineWidth = 2;
ctx.beginPath();
collatzData.forEach((d, i) => {
const x = pad + (i / collatzData.length) * w;
const y = c.height - pad - (d.n / maxVal) * h;
if (i === 0) ctx.moveTo(x, y);
else ctx.lineTo(x, y);
});
ctx.stroke();
} else if (mode === 'stopping') {
// Stopping times
collatzData = [];
for (let n = 1; n <= startN; n++) {
const seq = collatzSequence(n);
collatzData.push({ n, stopTime: seq.length - 1 });
}

const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
const maxStop = Math.max(...collatzData.map(d => d.stopTime));
collatzData.forEach(d => {
const x = pad + (d.n / startN) * w;
const y = c.height - pad - (d.stopTime / maxStop) * h;
ctx.fillStyle = `hsl(${d.stopTime / maxStop * 240}, 70%, 50%)`;
ctx.beginPath();
ctx.arc(x, y, 2, 0, 2 * PI);
ctx.fill();
});
} else {
// Inverse tree
const levels = [[1]];
const seen = new Set([1]);
for (let lvl = 0; lvl < 8; lvl++) {
const next = [];
for (const n of levels[lvl]) {
const parent1 = 2 * n;
if (!seen.has(parent1) && parent1 < 10000) { next.push(parent1); seen.add(parent1); }
if ((n - 1) % 3 === 0 && n > 1) {
const parent2 = (n - 1) / 3;
if (parent2 % 2 === 1 && !seen.has(parent2) && parent2 > 1) { next.push(parent2); seen.add(parent2); }
}
}
if (next.length === 0) break;
levels.push(next.sort((a, b) => a - b));
}

const pad = 40;
levels.forEach((level, d) => {
const y = pad + 40 + d * 50;
level.slice(0, 20).forEach((n, i) => {
const x = pad + (i + 0.5) / Math.min(level.length, 20) * (c.width - 2 * pad);
ctx.fillStyle = '#00d9ff';
ctx.beginPath();
ctx.arc(x, y, 8, 0, 2 * PI);
ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = '9px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(n.toString(), x, y + 3);
});
});
}

ctx.fillStyle = isDark() ? '#ff6496' : '#cc0044';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Collatz Conjecture (3n+1) ‚Äî Starting from ${startN}`, c.width / 2, 25);

const seq = collatzSequence(startN);
const maxVal = Math.max(...seq);

document.getElementById('collLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,100,150,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ff6496">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Collatz Conjecture | FIELD: ‚Ñ§‚Å∫ | TYPE: 3n+1 Problem</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${startN}</div><div style="font-size:.7rem;color:var(--txt2)">START</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${seq.length - 1}</div><div style="font-size:.7rem;color:var(--txt2)">STEPS TO 1</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${maxVal.toLocaleString()}</div><div style="font-size:.7rem;color:var(--txt2)">MAX VALUE</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Conjecture:</strong> Every positive integer eventually reaches 1<br>
<strong style="color:var(--acc)">Rule:</strong> If even: n/2, if odd: 3n+1<br>
<strong style="color:var(--acc)">Famous example:</strong> 27 takes 111 steps, reaches 9232
</div>`;

if (collatzData.length > 0) {
Plotly.newPlot('pcoll1', [{ x: collatzData.map(d => d.step !== undefined ? d.step : d.n), y: collatzData.map(d => d.n !== undefined ? d.n : d.stopTime), mode: 'lines+markers', line: { color: '#ff6496' } }], { ...plo(), xaxis: { title: mode === 'single' ? 'Step' : 'n' }, yaxis: { title: mode === 'single' ? 'Value' : 'Stopping Time' } });
}
}

function csvCollatz() { let s = 'step,n\n'; collatzData.forEach(d => s += `${d.step},${d.n}\n`); dl(s, 'collatz.csv'); }
async function screenshotCollatz() { await screenshotUnified('ccoll', 'collLiveStats', 'Collatz Conjecture', 'collatz.png'); }
function exportAllCollatz() { screenshotTabAll({ canvases: ['ccoll'], charts: ['pcoll1'], dashId: 'collLiveStats', title: 'Collatz Conjecture', filename: 'collatz_all.png' }); }

// ==================== HIGHLY COMPOSITE NUMBERS ====================
let hcData = [];

function countDivisors(n) {
let count = 0;
for (let d = 1; d * d <= n; d++) {
if (n % d === 0) count += (d * d === n) ? 1 : 2;
}
return count;
}

function drawHighComp() {
const maxN = +document.getElementById('hcNv').value || 10000;
const mode = document.getElementById('hcMode').value;
const c = document.getElementById('chc'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

hcData = [];
let maxDiv = 0;

for (let n = 1; n <= maxN; n++) {
const d = countDivisors(n);
if (mode === 'hc' && d > maxDiv) {
maxDiv = d;
hcData.push({ n, divisors: d });
} else if (mode === 'abundant') {
const sigma = aliquotSum(n) + n;
if (sigma > 2 * n) hcData.push({ n, divisors: d, sigma });
}
}

// Draw
const pad = 50, w = c.width - 2 * pad, h = c.height - 2 * pad;
if (mode === 'hc') {
hcData.forEach((d, i) => {
const x = pad + (Math.log(d.n) / Math.log(maxN)) * w;
const y = c.height - pad - (d.divisors / hcData[hcData.length - 1].divisors) * h;
ctx.fillStyle = '#ffd700';
ctx.beginPath();
ctx.arc(x, y, 6, 0, 2 * PI);
ctx.fill();
if (d.n < 1000) {
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = '10px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(d.n.toString(), x, y - 10);
}
});
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Highly Composite Numbers ‚â§ ${maxN}`, c.width / 2, 25);

document.getElementById('hcLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Highly Composite | FIELD: ‚Ñ§ | TYPE: d(n) Records</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${hcData.length}</div><div style="font-size:.7rem;color:var(--txt2)">HC NUMBERS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${hcData.length > 0 ? hcData[hcData.length - 1].n : 0}</div><div style="font-size:.7rem;color:var(--txt2)">LARGEST</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${hcData.length > 0 ? hcData[hcData.length - 1].divisors : 0}</div><div style="font-size:.7rem;color:var(--txt2)">MAX DIVISORS</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Definition:</strong> n is HC if d(n) > d(m) for all m < n<br>
<strong style="color:var(--acc)">First HC:</strong> ${hcData.slice(0, 8).map(d => d.n).join(', ')}...<br>
<strong style="color:var(--acc)">Ramanujan:</strong> First systematic study (1915)
</div>`;

Plotly.newPlot('phc1', [{ x: hcData.map(d => d.n), y: hcData.map(d => d.divisors), mode: 'lines+markers', line: { color: '#ffd700' } }], { ...plo(), xaxis: { title: 'n', type: 'log' }, yaxis: { title: 'd(n)' } });
}

function csvHighComp() { let s = 'n,divisors\n'; hcData.forEach(d => s += `${d.n},${d.divisors}\n`); dl(s, 'highly_composite.csv'); }
async function screenshotHighComp() { await screenshotUnified('chc', 'hcLiveStats', 'Highly Composite Numbers', 'highcomp.png'); }
function exportAllHighComp() { screenshotTabAll({ canvases: ['chc'], charts: ['phc1'], dashId: 'hcLiveStats', title: 'Highly Composite', filename: 'highcomp_all.png' }); }

// ==================== PERFECT NUMBERS ====================
let perfectData = [];

function drawPerfect() {
const maxN = +document.getElementById('perfNv').value || 10000;
const mode = document.getElementById('perfMode').value;
const c = document.getElementById('cperf'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

perfectData = [];
let perfect = 0, abundant = 0, deficient = 0;

for (let n = 2; n <= maxN; n++) {
const s = aliquotSum(n);
const type = s === n ? 'perfect' : s > n ? 'abundant' : 'deficient';
if (type === 'perfect') perfect++;
else if (type === 'abundant') abundant++;
else deficient++;
if (type === 'perfect' || (mode === 'sigma' && n <= 500)) {
perfectData.push({ n, sigma: s + n, type, ratio: (s + n) / n });
}
}

// Draw
const pad = 50;
if (mode === 'classify') {
// Pie-like visualization
const total = perfect + abundant + deficient;
const angles = [
{ type: 'deficient', count: deficient, color: '#00d9ff', start: 0 },
{ type: 'abundant', count: abundant, color: '#ff6496', start: deficient / total * 2 * PI },
{ type: 'perfect', count: perfect, color: '#ffd700', start: (deficient + abundant) / total * 2 * PI }
];
const cx = c.width / 2, cy = c.height / 2 + 20, r = 150;
angles.forEach(a => {
const end = a.start + a.count / total * 2 * PI;
ctx.fillStyle = a.color;
ctx.beginPath();
ctx.moveTo(cx, cy);
ctx.arc(cx, cy, r, a.start - PI / 2, end - PI / 2);
ctx.closePath();
ctx.fill();
});
} else {
// œÉ(n)/n ratio plot
const ratioData = [];
for (let n = 2; n <= Math.min(maxN, 500); n++) {
ratioData.push({ n, ratio: (aliquotSum(n) + n) / n });
}
const w = c.width - 2 * pad, h = c.height - 2 * pad;
ratioData.forEach(d => {
const x = pad + (d.n / 500) * w;
const y = c.height - pad - ((d.ratio - 1) / 2) * h;
ctx.fillStyle = d.ratio === 2 ? '#ffd700' : d.ratio > 2 ? '#ff6496' : '#00d9ff';
ctx.beginPath();
ctx.arc(x, y, 2, 0, 2 * PI);
ctx.fill();
});
// Line at ratio = 2
ctx.strokeStyle = '#ffd700';
ctx.setLineDash([5, 5]);
ctx.beginPath();
const y2 = c.height - pad - h / 2;
ctx.moveTo(pad, y2);
ctx.lineTo(c.width - pad, y2);
ctx.stroke();
ctx.setLineDash([]);
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Perfect, Abundant, Deficient ‚â§ ${maxN}`, c.width / 2, 25);

const perfectNums = [6, 28, 496, 8128].filter(p => p <= maxN);

document.getElementById('perfLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Perfect Numbers | FIELD: ‚Ñ§ | TYPE: œÉ(n) = 2n Classification</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${perfect}</div><div style="font-size:.7rem;color:var(--txt2)">PERFECT</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ff6496">${abundant}</div><div style="font-size:.7rem;color:var(--txt2)">ABUNDANT</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${deficient}</div><div style="font-size:.7rem;color:var(--txt2)">DEFICIENT</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Perfect in range:</strong> ${perfectNums.join(', ') || 'None'}<br>
<strong style="color:var(--acc)">Euclid-Euler:</strong> Even perfect ‚ü∫ 2^(p-1)(2^p - 1) with M_p prime<br>
<strong style="color:var(--acc)">Open:</strong> Are there odd perfect numbers?
</div>`;

Plotly.newPlot('pperf1', [{ x: ['Deficient', 'Abundant', 'Perfect'], y: [deficient, abundant, perfect], type: 'bar', marker: { color: ['#00d9ff', '#ff6496', '#ffd700'] } }], { ...plo(), xaxis: { title: 'Type' }, yaxis: { title: 'Count' } });
}

function csvPerfect() { let s = 'n,sigma,type\n'; perfectData.forEach(d => s += `${d.n},${d.sigma},${d.type}\n`); dl(s, 'perfect.csv'); }
async function screenshotPerfect() { await screenshotUnified('cperf', 'perfLiveStats', 'Perfect Numbers', 'perfect.png'); }
function exportAllPerfect() { screenshotTabAll({ canvases: ['cperf'], charts: ['pperf1'], dashId: 'perfLiveStats', title: 'Perfect Numbers', filename: 'perfect_all.png' }); }

// ==================== TAXICAB NUMBERS ====================
let taxicabData = [];

function drawTaxicab() {
const maxSum = +document.getElementById('taxiNv').value || 20000;
const minK = +document.getElementById('taxiK').value;
const c = document.getElementById('ctaxi'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

// Find numbers expressible as sum of two cubes in multiple ways
const cubeSums = new Map();
const maxCube = Math.ceil(Math.pow(maxSum, 1 / 3));

for (let a = 1; a <= maxCube; a++) {
for (let b = a; b <= maxCube; b++) {
const sum = a * a * a + b * b * b;
if (sum > maxSum) break;
if (!cubeSums.has(sum)) cubeSums.set(sum, []);
cubeSums.get(sum).push([a, b]);
}
}

taxicabData = [];
for (const [sum, ways] of cubeSums) {
if (ways.length >= minK) {
taxicabData.push({ n: sum, ways, k: ways.length });
}
}
taxicabData.sort((a, b) => a.n - b.n);

// Draw
const pad = 50;
ctx.font = '12px monospace';
taxicabData.slice(0, 15).forEach((t, i) => {
const y = pad + 40 + i * 28;
ctx.fillStyle = t.n === 1729 ? '#ffd700' : '#00d9ff';
ctx.textAlign = 'left';
ctx.fillText(`${t.n} = ${t.ways.map(w => `${w[0]}¬≥+${w[1]}¬≥`).join(' = ')}`, pad, y);
});

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Taxicab Numbers Ta(${minK}) ‚â§ ${maxSum}`, c.width / 2, 25);

document.getElementById('taxiLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Taxicab Numbers | FIELD: ‚Ñ§ | TYPE: a¬≥ + b¬≥ = c¬≥ + d¬≥</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${taxicabData.length}</div><div style="font-size:.7rem;color:var(--txt2)">FOUND</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">1729</div><div style="font-size:.7rem;color:var(--txt2)">FAMOUS Ta(2)</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00ff88">${minK}+ ways</div><div style="font-size:.7rem;color:var(--txt2)">MINIMUM</div></div>
</div>
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Hardy-Ramanujan:</strong> 1729 = 1¬≥+12¬≥ = 9¬≥+10¬≥<br>
<strong style="color:var(--acc)">Ta(2):</strong> ${taxicabData.length > 0 ? taxicabData[0].n : '1729'}<br>
<strong style="color:var(--acc)">Story:</strong> Hardy's taxi number, Ramanujan recognized instantly
</div>`;

if (taxicabData.length > 0) {
Plotly.newPlot('ptaxi1', [{ x: taxicabData.map((_, i) => i + 1), y: taxicabData.map(t => t.n), mode: 'lines+markers', line: { color: '#ffd700' } }], { ...plo(), xaxis: { title: 'Index' }, yaxis: { title: 'Taxicab Number' } });
}
}

function csvTaxicab() { let s = 'n,ways,representations\n'; taxicabData.forEach(t => s += `${t.n},${t.k},"${t.ways.map(w => w[0] + '^3+' + w[1] + '^3').join('; ')}"\n`); dl(s, 'taxicab.csv'); }
async function screenshotTaxicab() { await screenshotUnified('ctaxi', 'taxiLiveStats', 'Taxicab Numbers', 'taxicab.png'); }
function exportAllTaxicab() { screenshotTabAll({ canvases: ['ctaxi'], charts: ['ptaxi1'], dashId: 'taxiLiveStats', title: 'Taxicab Numbers', filename: 'taxicab_all.png' }); }

// ==================== ELLIPTIC CURVES ====================
let ellipticData = [];

function drawElliptic() {
const a = +document.getElementById('ellA').value;
const b = +document.getElementById('ellB').value;
const mode = document.getElementById('ellMode').value;
const p = +document.getElementById('ellP').value;
const c = document.getElementById('cell'), ctx = c.getContext('2d');
ctx.fillStyle = canvBg(); ctx.fillRect(0, 0, c.width, c.height);

const discriminant = -16 * (4 * a * a * a + 27 * b * b);

ellipticData = [];

if (mode === 'real') {
// Plot y¬≤ = x¬≥ + ax + b over reals
const cx = c.width / 2, cy = c.height / 2;
const scale = 30;

// Grid
ctx.strokeStyle = gridC();
ctx.lineWidth = 0.5;
for (let i = -10; i <= 10; i++) {
ctx.beginPath();
ctx.moveTo(cx + i * scale, 0);
ctx.lineTo(cx + i * scale, c.height);
ctx.stroke();
ctx.beginPath();
ctx.moveTo(0, cy + i * scale);
ctx.lineTo(c.width, cy + i * scale);
ctx.stroke();
}

// Axes
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(0, cy);
ctx.lineTo(c.width, cy);
ctx.moveTo(cx, 0);
ctx.lineTo(cx, c.height);
ctx.stroke();

// Axis labels
ctx.fillStyle = isDark() ? '#888' : '#666';
ctx.font = '10px Segoe UI';
ctx.textAlign = 'center';
for (let i = -8; i <= 8; i += 2) {
if (i !== 0) {
ctx.fillText(i.toString(), cx + i * scale, cy + 15);
ctx.fillText(i.toString(), cx - 15, cy - i * scale + 4);
}
}

// Plot curve - upper and lower branches
ctx.fillStyle = '#ffd700';
for (let px = 0; px < c.width; px++) {
const x = (px - cx) / scale;
const y2 = x * x * x + a * x + b;
if (y2 >= 0) {
const y = Math.sqrt(y2);
// Upper branch
ctx.beginPath();
ctx.arc(px, cy - y * scale, 1.5, 0, 2 * PI);
ctx.fill();
// Lower branch
ctx.beginPath();
ctx.arc(px, cy + y * scale, 1.5, 0, 2 * PI);
ctx.fill();
ellipticData.push({ x: +x.toFixed(2), y: +y.toFixed(2) });
}
}
} else if (mode === 'modp') {
// Points over F_p
const points = [];
for (let x = 0; x < p; x++) {
const rhs = (x * x * x + a * x + b) % p;
for (let y = 0; y < p; y++) {
if ((y * y) % p === (rhs + p) % p) {
points.push({ x, y });
ellipticData.push({ x, y });
}
}
}

// Grid
const pad = 50, size = Math.min((c.width - 2 * pad) / p, (c.height - 2 * pad) / p, 15);
ctx.strokeStyle = gridC();
ctx.lineWidth = 0.5;
for (let i = 0; i <= p; i++) {
ctx.beginPath();
ctx.moveTo(pad + i * size, pad);
ctx.lineTo(pad + i * size, c.height - pad);
ctx.stroke();
ctx.beginPath();
ctx.moveTo(pad, c.height - pad - i * size);
ctx.lineTo(pad + p * size, c.height - pad - i * size);
ctx.stroke();
}

// Axis labels
ctx.fillStyle = isDark() ? '#888' : '#666';
ctx.font = '9px Segoe UI';
ctx.textAlign = 'center';
for (let i = 0; i < p; i += Math.ceil(p / 10)) {
ctx.fillText(i.toString(), pad + i * size + size / 2, c.height - pad + 12);
ctx.fillText(i.toString(), pad - 12, c.height - pad - i * size - size / 2 + 3);
}

// Points
points.forEach(pt => {
const px = pad + pt.x * size + size / 2;
const py = c.height - pad - pt.y * size - size / 2;
ctx.fillStyle = '#ffd700';
ctx.beginPath();
ctx.arc(px, py, Math.max(size / 3, 3), 0, 2 * PI);
ctx.fill();
});

// Point at infinity indicator
ctx.fillStyle = '#ff6496';
ctx.font = 'bold 12px Segoe UI';
ctx.textAlign = 'right';
ctx.fillText('‚àû (identity)', c.width - 20, c.height - 20);
} else if (mode === 'group') {
// Group law visualization: P + Q = R
const cx = c.width / 2, cy = c.height / 2;
const scale = 40;

// Grid
ctx.strokeStyle = gridC();
ctx.lineWidth = 0.5;
for (let i = -8; i <= 8; i++) {
ctx.beginPath();
ctx.moveTo(cx + i * scale, 0);
ctx.lineTo(cx + i * scale, c.height);
ctx.stroke();
ctx.beginPath();
ctx.moveTo(0, cy + i * scale);
ctx.lineTo(c.width, cy + i * scale);
ctx.stroke();
}

// Axes
ctx.strokeStyle = isDark() ? '#fff' : '#333';
ctx.lineWidth = 1;
ctx.beginPath();
ctx.moveTo(0, cy);
ctx.lineTo(c.width, cy);
ctx.moveTo(cx, 0);
ctx.lineTo(cx, c.height);
ctx.stroke();

// Plot curve
ctx.fillStyle = '#ffd700';
for (let px = 0; px < c.width; px++) {
const x = (px - cx) / scale;
const y2 = x * x * x + a * x + b;
if (y2 >= 0) {
const y = Math.sqrt(y2);
ctx.beginPath();
ctx.arc(px, cy - y * scale, 1.5, 0, 2 * PI);
ctx.fill();
ctx.beginPath();
ctx.arc(px, cy + y * scale, 1.5, 0, 2 * PI);
ctx.fill();
}
}

// Find two points P and Q on the curve for demonstration
let P = null, Q = null;
for (let x = -3; x <= 3 && !P; x += 0.5) {
const y2 = x * x * x + a * x + b;
if (y2 > 0) P = { x, y: Math.sqrt(y2) };
}
for (let x = 0; x <= 5 && !Q; x += 0.5) {
const y2 = x * x * x + a * x + b;
if (y2 > 0 && (!P || Math.abs(x - P.x) > 0.5)) Q = { x, y: Math.sqrt(y2) };
}

if (P && Q) {
// Draw P
ctx.fillStyle = '#00ff88';
ctx.beginPath();
ctx.arc(cx + P.x * scale, cy - P.y * scale, 8, 0, 2 * PI);
ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = 'bold 12px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText('P', cx + P.x * scale, cy - P.y * scale - 15);

// Draw Q
ctx.fillStyle = '#00d9ff';
ctx.beginPath();
ctx.arc(cx + Q.x * scale, cy - Q.y * scale, 8, 0, 2 * PI);
ctx.fill();
ctx.fillText('Q', cx + Q.x * scale, cy - Q.y * scale - 15);

// Line through P and Q
const slope = (Q.y - P.y) / (Q.x - P.x);
const intercept = P.y - slope * P.x;
ctx.strokeStyle = '#ff6496';
ctx.lineWidth = 2;
ctx.setLineDash([5, 5]);
ctx.beginPath();
ctx.moveTo(cx - 6 * scale, cy - (-6 * slope + intercept) * scale);
ctx.lineTo(cx + 6 * scale, cy - (6 * slope + intercept) * scale);
ctx.stroke();
ctx.setLineDash([]);

// Find third intersection point R'
// x¬≥ + ax + b - (slope*x + intercept)¬≤ = 0
// Using Vieta: x_P + x_Q + x_R' = slope¬≤
const xR = slope * slope - P.x - Q.x;
const yR = slope * xR + intercept;
const xResult = xR;
const yResult = -yR; // Reflect over x-axis

// Draw R' (intersection)
ctx.fillStyle = '#9664ff';
ctx.beginPath();
ctx.arc(cx + xR * scale, cy - yR * scale, 6, 0, 2 * PI);
ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.fillText("R'", cx + xR * scale + 15, cy - yR * scale);

// Vertical line to P+Q
ctx.strokeStyle = '#9664ff';
ctx.setLineDash([3, 3]);
ctx.beginPath();
ctx.moveTo(cx + xR * scale, cy - yR * scale);
ctx.lineTo(cx + xResult * scale, cy - yResult * scale);
ctx.stroke();
ctx.setLineDash([]);

// Draw P+Q (result)
ctx.fillStyle = '#ff6496';
ctx.beginPath();
ctx.arc(cx + xResult * scale, cy - yResult * scale, 8, 0, 2 * PI);
ctx.fill();
ctx.fillStyle = isDark() ? '#fff' : '#000';
ctx.font = 'bold 12px Segoe UI';
ctx.fillText('P+Q', cx + xResult * scale, cy - yResult * scale + 20);

ellipticData = [
{ x: +P.x.toFixed(2), y: +P.y.toFixed(2), label: 'P' },
{ x: +Q.x.toFixed(2), y: +Q.y.toFixed(2), label: 'Q' },
{ x: +xResult.toFixed(2), y: +yResult.toFixed(2), label: 'P+Q' }
];
}

// Legend
ctx.fillStyle = isDark() ? '#00d9ff' : '#0066cc';
ctx.font = '11px Segoe UI';
ctx.textAlign = 'left';
ctx.fillText('Group Law: Draw line through P,Q ‚Üí intersects at R\' ‚Üí reflect to get P+Q', 20, c.height - 15);
}

ctx.fillStyle = isDark() ? '#ffd700' : '#cc8800';
ctx.font = 'bold 14px Segoe UI';
ctx.textAlign = 'center';
ctx.fillText(`Elliptic Curve y¬≤ = x¬≥ ${a >= 0 ? '+' : ''}${a}x ${b >= 0 ? '+' : ''}${b}${mode === 'modp' ? ' over ùîΩ_' + p : ' over ‚Ñù'}`, c.width / 2, 25);

const pointCount = ellipticData.length + 1; // +1 for point at infinity
const hasseError = mode === 'modp' ? Math.abs(pointCount - p - 1) : 0;
const hasseBound = mode === 'modp' ? 2 * Math.sqrt(p) : 0;

document.getElementById('ellLiveStats').innerHTML = `
<div style="background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(0,217,255,.1));padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #ffd700">
<div style="font-size:.7rem;color:var(--txt2);margin-bottom:4px">TAB: Elliptic Curves | FIELD: ${mode === 'modp' ? 'E(ùîΩ_' + p + ')' : 'E(‚Ñù)'} | TYPE: y¬≤ = x¬≥ + ax + b</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:.75rem">
<span>a: <strong style="color:#00d9ff">${a}</strong></span>
<span>b: <strong style="color:#ffd700">${b}</strong></span>
<span>Mode: <strong style="color:#00ff88">${mode === 'modp' ? 'ùîΩ_' + p : '‚Ñù'}</strong></span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#ffd700">${mode === 'modp' ? pointCount : '‚àû'}</div><div style="font-size:.7rem;color:var(--txt2)">#E POINTS</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:#00d9ff">${discriminant}</div><div style="font-size:.7rem;color:var(--txt2)">Œî DISCRIM</div></div>
<div style="background:var(--bg1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:1.2rem;font-weight:bold;color:${discriminant !== 0 ? '#00ff88' : '#ff6496'}">${discriminant !== 0 ? 'Smooth' : 'Singular'}</div><div style="font-size:.7rem;color:var(--txt2)">TYPE</div></div>
</div>
${mode === 'modp' ? `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:#9664ff">${fmt(hasseBound)}</div><div style="font-size:.6rem;color:var(--txt2)">HASSE BOUND 2‚àöp</div></div>
<div style="background:var(--bg1);padding:8px;border-radius:6px;text-align:center"><div style="font-size:1rem;font-weight:bold;color:${hasseError <= hasseBound ? '#00ff88' : '#ff6496'}">${hasseError}</div><div style="font-size:.6rem;color:var(--txt2)">|#E - p - 1|</div></div>
</div>` : ''}
<div style="font-size:.8rem;color:var(--txt2)">
<strong style="color:var(--acc)">Discriminant:</strong> Œî = -16(4a¬≥ + 27b¬≤)<br>
<strong style="color:var(--acc)">Hasse's Theorem:</strong> |#E(ùîΩ_p) - p - 1| ‚â§ 2‚àöp<br>
<strong style="color:var(--acc)">BSD Conjecture:</strong> rank(E) = ord_{s=1} L(E,s)
</div>`;

if (ellipticData.length > 0 && mode === 'modp') {
Plotly.newPlot('pell1', [{ x: ellipticData.map(pt => pt.x), y: ellipticData.map(pt => pt.y), mode: 'markers', marker: { color: '#ffd700', size: 8 }, name: 'E(ùîΩ_p)' }], { ...plo(), xaxis: { title: 'x mod ' + p }, yaxis: { title: 'y mod ' + p } });
} else if (mode === 'real') {
// Show curve shape as scatter
const plotData = ellipticData.filter((_, i) => i % 3 === 0);
Plotly.newPlot('pell1', [
{ x: plotData.map(pt => pt.x), y: plotData.map(pt => pt.y), mode: 'markers', marker: { color: '#ffd700', size: 3 }, name: 'y > 0' },
{ x: plotData.map(pt => pt.x), y: plotData.map(pt => -pt.y), mode: 'markers', marker: { color: '#00d9ff', size: 3 }, name: 'y < 0' }
], { ...plo(), xaxis: { title: 'x' }, yaxis: { title: 'y' } });
}
}

function csvElliptic() { let s = 'x,y\n'; ellipticData.forEach(pt => s += `${pt.x},${pt.y}\n`); dl(s, 'elliptic.csv'); }
async function screenshotElliptic() { await screenshotUnified('cell', 'ellLiveStats', 'Elliptic Curve', 'elliptic.png'); }
function exportAllElliptic() { screenshotTabAll({ canvases: ['cell'], charts: ['pell1'], dashId: 'ellLiveStats', title: 'Elliptic Curves', filename: 'elliptic_all.png' }); }

draw2D();
</script>
</body>
</html>
